<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>AOP切面</title>
    <url>/2021/11/30/AOP%E5%88%87%E9%9D%A2/</url>
    <content><![CDATA[<h1 id="pom"><a href="#pom" class="headerlink" title="pom"></a>pom</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h1 id="SysLog自定义注解"><a href="#SysLog自定义注解" class="headerlink" title="SysLog自定义注解"></a>SysLog自定义注解</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.websocket.annotation;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 定义系统日志注解</span><br><span class="line"> * @author zhuzhe</span><br><span class="line"> * @date 2018/6/4 9:24</span><br><span class="line"> * @email 1529949535@qq.com</span><br><span class="line"> */</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">public @interface SysLog &#123;</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SysLogBO自定义日志实体"><a href="#SysLogBO自定义日志实体" class="headerlink" title="SysLogBO自定义日志实体"></a>SysLogBO自定义日志实体</h1><p>可以不创建这个实体</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.websocket.entity.bo;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 系统日志bo</span><br><span class="line"> * @author jiangjaixu</span><br><span class="line"> * @date 2018/6/4 9:36</span><br><span class="line"> * @email 1529949535@qq.com</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class SysLogBO &#123;</span><br><span class="line"></span><br><span class="line">    private String className;</span><br><span class="line"></span><br><span class="line">    private String methodName;</span><br><span class="line"></span><br><span class="line">    private String params;</span><br><span class="line"></span><br><span class="line">    private Long exeuTime;</span><br><span class="line"></span><br><span class="line">    private String remark;</span><br><span class="line"></span><br><span class="line">    private String createDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SysLogService"><a href="#SysLogService" class="headerlink" title="SysLogService"></a>SysLogService</h1><p>可以不用到上一步的实体</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.websocket.service;</span><br><span class="line"></span><br><span class="line">import com.jiang.websocket.entity.bo.SysLogBO;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class SysLogService &#123;</span><br><span class="line"></span><br><span class="line">    public boolean save(SysLogBO sysLogBO)&#123;</span><br><span class="line">        System.out.println(sysLogBO);</span><br><span class="line">        log.info(sysLogBO.getParams());</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SysLogAspect切面类"><a href="#SysLogAspect切面类" class="headerlink" title="SysLogAspect切面类"></a>SysLogAspect切面类</h1><p>这里指定拦截注解类SysLog，controller上加了这个注解就会调用切面类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.websocket.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"><span class="keyword">import</span> com.jiang.websocket.annotation.SysLog;</span><br><span class="line"><span class="keyword">import</span> com.jiang.websocket.entity.bo.SysLogBO;</span><br><span class="line"><span class="keyword">import</span> com.jiang.websocket.service.SysLogService;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span>  <span class="comment">// 使用@Aspect注解声明一个切面</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysLogAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysLogService sysLogService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里我们使用注解的形式</span></span><br><span class="line"><span class="comment">     * 当然，我们也可以通过切点表达式直接指定需要拦截的package,需要拦截的class 以及 method</span></span><br><span class="line"><span class="comment">     * 切点表达式:   execution(...)</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.jiang.websocket.annotation.SysLog)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logPointCut</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 环绕通知 <span class="doctag">@Around</span>  ， 当然也可以使用 <span class="doctag">@Before</span> (前置通知)  <span class="doctag">@After</span> (后置通知)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> point</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around(&quot;logPointCut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> beginTime = System.currentTimeMillis();</span><br><span class="line">        Object result = point.proceed();</span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis() - beginTime;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            saveLog(point, time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存日志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveLog</span><span class="params">(ProceedingJoinPoint joinPoint, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        MethodSignature signature = (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        Method method = signature.getMethod();</span><br><span class="line">        SysLogBO sysLogBO = <span class="keyword">new</span> SysLogBO();</span><br><span class="line">        sysLogBO.setExeuTime(time);</span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>);</span><br><span class="line">        sysLogBO.setCreateDate(dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        SysLog sysLog = method.getAnnotation(SysLog.class);</span><br><span class="line">        <span class="keyword">if</span>(sysLog != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//注解上的描述</span></span><br><span class="line">            sysLogBO.setRemark(sysLog.value());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//请求的 类名、方法名</span></span><br><span class="line">        String className = joinPoint.getTarget().getClass().getName();</span><br><span class="line">        String methodName = signature.getName();</span><br><span class="line">        sysLogBO.setClassName(className);</span><br><span class="line">        sysLogBO.setMethodName(methodName);</span><br><span class="line">        <span class="comment">//请求的参数</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Object o : args) &#123;</span><br><span class="line">                list.add(<span class="keyword">new</span> Gson().toJson(o));</span><br><span class="line">            &#125;</span><br><span class="line">            sysLogBO.setParams(list.toString());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123; &#125;</span><br><span class="line">        sysLogService.save(sysLogBO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="可以通过切面类获取controller方法上的一些参数"><a href="#可以通过切面类获取controller方法上的一些参数" class="headerlink" title="可以通过切面类获取controller方法上的一些参数"></a>可以通过切面类获取controller方法上的一些参数</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">MethodSignature signature = (MethodSignature) joinPoint.getSignature();</span><br><span class="line"><span class="comment">//获取方法</span></span><br><span class="line">Method method = signature.getMethod();</span><br><span class="line"><span class="comment">//类名</span></span><br><span class="line">String className = joinPoint.getTarget().getClass().getName();</span><br><span class="line"><span class="comment">//方法名</span></span><br><span class="line">String methodName = signature.getName();</span><br><span class="line">String methodName1=method.getName();</span><br><span class="line"><span class="comment">//请求的参数</span></span><br><span class="line">Object[] args = joinPoint.getArgs();</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取自定义注解的value属性</span></span><br><span class="line">SysLog sysLog = method.getAnnotation(SysLog.class);</span><br><span class="line"><span class="keyword">if</span>(sysLog != <span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="comment">//注解上的描述</span></span><br><span class="line">    sysLogBO.setRemark(sysLog.value());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="TestController"><a href="#TestController" class="headerlink" title="TestController"></a>TestController</h1><p>加上自定义SysLog类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.websocket.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jiang.websocket.annotation.SysLog;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SysLog(&quot;测试&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>AOP切面</tag>
      </tags>
  </entry>
  <entry>
    <title>CAS单点登录</title>
    <url>/2021/11/30/CAS%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/</url>
    <content><![CDATA[<p><img src="/../img/image-20220210141403511.png" alt="image-20220210141403511"></p>
<h1 id="1-搭建tomcat的HTTPS支持"><a href="#1-搭建tomcat的HTTPS支持" class="headerlink" title="1.搭建tomcat的HTTPS支持"></a>1.搭建tomcat的HTTPS支持</h1><h2 id="1-下载安装tomcat9"><a href="#1-下载安装tomcat9" class="headerlink" title="1.下载安装tomcat9"></a>1.下载安装tomcat9</h2><p><a href="https://blog.csdn.net/ELaXiaoSi/article/details/84190648?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164445787016780265450662%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164445787016780265450662&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-84190648.first_rank_v2_pc_rank_v29&amp;utm_term=tomcat9%E4%B8%8B%E8%BD%BD&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/ELaXiaoSi/article/details/84190648?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164445787016780265450662%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164445787016780265450662&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-84190648.first_rank_v2_pc_rank_v29&amp;utm_term=tomcat9%E4%B8%8B%E8%BD%BD&amp;spm=1018.2226.3001.4187</a></p>
<h2 id="2-生成秘钥库，注意，证书不是给tomcat用的，而是给自己的网站域名用的"><a href="#2-生成秘钥库，注意，证书不是给tomcat用的，而是给自己的网站域名用的" class="headerlink" title="2.生成秘钥库，注意，证书不是给tomcat用的，而是给自己的网站域名用的"></a>2.生成秘钥库，注意，证书不是给tomcat用的，而是给自己的网站域名用的</h2><h3 id="1-使用https需要ssl文件可以去阿里或腾讯服务器哪里去申请免费的，拿到ssl文件"><a href="#1-使用https需要ssl文件可以去阿里或腾讯服务器哪里去申请免费的，拿到ssl文件" class="headerlink" title="1.使用https需要ssl文件可以去阿里或腾讯服务器哪里去申请免费的，拿到ssl文件"></a>1.使用https需要ssl文件可以去阿里或腾讯服务器哪里去申请免费的，拿到ssl文件</h3><h2 id="2-自己生成，使用这个"><a href="#2-自己生成，使用这个" class="headerlink" title="2.自己生成，使用这个"></a>2.自己生成，使用这个</h2><p>采用java自带的keytool工具</p>
<p>别名jiang 存储路径D:\CAS\keystore</p>
<p>keytool -genkey -v -alias jiangcas -keyalg RSA  -keystore D:\CAS\keystore\jiangcas.keystore</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-genkey 生成密钥</span><br><span class="line">-keyalg 指定密钥算法，这时指定RSA,</span><br><span class="line">-keysize 指定密钥长度，默认是1024位,这里指定2048，长一点，比较难破解,</span><br><span class="line">-validity 指定证书有效期，这里指定36500天.</span><br><span class="line">-alias 指定别名，这里是wolfcode</span><br><span class="line">-keystore 指定密钥库存储位置，这里存在 D:\CAS\keystore目录下</span><br><span class="line">注意：您的名字与姓氏www.sso.com是CAS服务器使用的域名,不是随便乱定的，其他的随意.</span><br></pre></td></tr></table></figure>

<p>密钥库口令：jiangcas</p>
<p><img src="/../img/image-20220210100933281.png" alt="image-20220210100933281"></p>
<h2 id="3-导出证书"><a href="#3-导出证书" class="headerlink" title="3.导出证书"></a>3.导出证书</h2><p>keytool -export -trustcacerts -alias jiangcas -storepass jiangcas -file D:/CAS/keystore/jiangcas.cer -keystore D:/CAS/keystore/jiangcas.keystore</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-alias指定别名为wolfcode ;</span><br><span class="line">-storepass指定私钥为123456;</span><br><span class="line">-file指定导出证书的文件名为wolfcode.cer;</span><br><span class="line">-keystore指定之前生成的密钥文件的文件名。</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220210101357591.png" alt="image-20220210101357591"></p>
<h2 id="3-导入证书导入到jdk信任库"><a href="#3-导入证书导入到jdk信任库" class="headerlink" title="3.导入证书导入到jdk信任库"></a>3.导入证书导入到jdk信任库</h2><p>keytool -import -trustcacerts -alias jiangcas -keystore “D:/javajdk/jdk1.8.0_131/jre/lib/security/cacerts” -file D:/CAS/keystore/jiangcas.cer</p>
<p>jdk证书库密码： changeit</p>
<p><img src="/../img/image-20220210101845118.png" alt="image-20220210101845118"></p>
<h2 id="4-配置https支持，只有这步是开始tomcat的https"><a href="#4-配置https支持，只有这步是开始tomcat的https" class="headerlink" title="4.配置https支持，只有这步是开始tomcat的https"></a>4.配置https支持，只有这步是开始tomcat的https</h2><p>修改<img src="/../img/image-20220210102011138.png" alt="image-20220210102011138"></p>
<p>添加</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</span><br><span class="line">               maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot; scheme=&quot;https&quot; secure=&quot;true&quot; </span><br><span class="line">clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot; keystoreFile=&quot;D:\CAS\keystore\jiangcas.keystore&quot; keystorePass=&quot;jiangcas&quot;			   </span><br><span class="line">               /&gt;</span><br></pre></td></tr></table></figure>

<p>启动tomcat乱码</p>
<p><img src="/../img/image-20220210102613324.png" alt="image-20220210102613324"></p>
<p>找到第51行把UTF-8改为GBK</p>
<p>java.util.logging.ConsoleHandler.encoding = GBK</p>
<p>启动start.bat</p>
<p>访问http的<a href="http://localhost:8080/">http://localhost:8080</a></p>
<p>https的<a href="https://localhost:8443/">https://localhost:8443/</a></p>
<h1 id="2-下载cas服务端包"><a href="#2-下载cas服务端包" class="headerlink" title="2.下载cas服务端包"></a>2.下载cas服务端包</h1><p><a href="https://repo1.maven.org/maven2/org/apereo/cas/cas-server-webapp-tomcat/5.3.14/">https://repo1.maven.org/maven2/org/apereo/cas/cas-server-webapp-tomcat/5.3.14/</a></p>
<p>下载这个包cas-server-webapp-tomcat-5.3.14.war </p>
<h1 id="3-cas的war包发布到tomcat下"><a href="#3-cas的war包发布到tomcat下" class="headerlink" title="3.cas的war包发布到tomcat下"></a>3.cas的war包发布到tomcat下</h1><p><img src="/../img/image-20220210103038596.png" alt="image-20220210103038596"></p>
<p>启动tomcat自动解压</p>
<p>删除war包，修改名称为cas</p>
<p>再次启动tomcat访问<a href="https://localhost:8443/cas">https://localhost:8443/cas</a></p>
<p><img src="/../img/image-20220210103423069.png" alt="image-20220210103423069"></p>
<p>默认用户名密码</p>
<p><img src="/../img/image-20220210103633290.png" alt="image-20220210103633290"></p>
<p><img src="/../img/image-20220210103624560.png" alt="image-20220210103624560"></p>
<p>修改日志位置</p>
<p><img src="/../img/image-20220210103759606.png" alt="image-20220210103759606"></p>
<p><img src="/../img/image-20220210103807366.png" alt="image-20220210103807366"></p>
<p>改为D:\CAS\log</p>
<h1 id="4-修改域名方便访问"><a href="#4-修改域名方便访问" class="headerlink" title="4.修改域名方便访问"></a>4.修改域名方便访问</h1><p>C:\Windows\System32\drivers\etc下的hosts文件</p>
<p>添加127.0.0.1 <a href="http://www.jiangcas.com/">www.jiangcas.com</a></p>
<p>就可以通过域名访问，首先找本地hosts然后才是dns解析</p>
<h1 id="5-配置数据源"><a href="#5-配置数据源" class="headerlink" title="5.配置数据源"></a>5.配置数据源</h1><p><strong>第一步：新建数据和表：</strong></p>
<p>CREATE DATABASE /<em>!32312 IF NOT EXISTS</em>/<code>db_sso</code> /*!40100 DEFAULT CHARACTER SET utf8 */;</p>
<p>USE <code>db_sso</code>;</p>
<p>/*Table structure for table <code>t_cas</code> */</p>
<p>DROP TABLE IF EXISTS <code>t_cas</code>;</p>
<p>CREATE TABLE <code>t_cas</code> (</p>
<p> <code>id</code> int(11) NOT NULL AUTO_INCREMENT,</p>
<p> <code>username</code> varchar(30) DEFAULT NULL,</p>
<p> <code>password</code> varchar(100) DEFAULT NULL,</p>
<p> PRIMARY KEY (<code>id</code>)</p>
<p>) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</p>
<p>/*Data for the table <code>t_cas</code> */</p>
<p>insert into <code>t_cas</code>(<code>id</code>,<code>username</code>,<code>password</code>) values (1,’java1234’,’123456’);</p>
<p><strong>第二步：修改application.properties配置文件</strong> </p>
<p>注释掉写死的认证用户</p>
<p>加上jdbc数据源配置</p>
<p># cas.authn.accept.users=casuser::Mellon</p>
<p># cas.authn.jdbc.query[0].dialect=org.hibernate.dialect.MySQL5Dialect</p>
<p>cas.authn.jdbc.query[0].url=jdbc:mysql://localhost:3306/school?serverTimezone=GMT</p>
<p>cas.authn.jdbc.query[0].user=root</p>
<p>cas.authn.jdbc.query[0].password=root</p>
<p>cas.authn.jdbc.query[0].sql=select * from t_cas where username=?</p>
<p>cas.authn.jdbc.query[0].fieldPassword=password</p>
<p>cas.authn.jdbc.query[0].driverClass=com.mysql.jdbc.Driver</p>
<p><strong>第三步：加上jdbc驱动包以及支持jar</strong></p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAW4AAACyCAYAAABiKSVvAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABNRSURBVHhe7d3PiybHfcfxOer/yWnBh0Cuvirgi60E5ubFEHIyLBgC2hyUAV0iFB9EfLH2YIO82FkMgkA8JHiXCIsQ9hJieSUvsaVgZK+1q5Vo97e6q7u+1d/60f08z85T87wHXuw83dVV1dVdn+l5dp7usy+++KIDroM//+u/NZcDrfjf33xmLo8R3LgWvvL1v+n+8rv/2n397//ZXA+0gODGyfjK177Z/dU//qR79T9+271+/+Pun35yaZYDjh3BjZPwF9/4Vnf7ncvup7/6Q/fj//m0+9mjP3Q///WT7t8+fGKWB44ZwQ0AjSG4AaAxBDcANOZAwf1+99orr3d3HlnrIo/e7W6+8u3uq6+83V32ry/f+Hb32n2jHADAKQf34+7OrdfXBLeEtgSx7eY7j125D955fVw2BLbb1oV48BoAsPDBbwvBLVl669264PZhbF4xjxV9oJbLTwUf1PL9MuiFD3sAQDm4JYslN4vB7UJ7DObLN6K3Se6/Pa0blqVCenm1zVsnAKDlg3t416MquLVhQwlcCd6vvvG+UcaX82H9fncneBvFXWWbV+kAcNpywe3y81blFXcs+7aJJ1fi7kpbX6FPwR2WBQA4jz5+ai4Xl++821sZ3O4K24WxbQ7kx92dN97uXnPvcfdX3nJlLUHeX50Pwd1fgd/ibRIAiH34yZ7e4/aB7S/RrTJyhe3XzeE8v1Xi3zaZr7hlWeWfFQLAifj1/6evuEV1cHtz6Brrg+C+7K+2L6e/Khn+s9JfXas6xv/YnOoAgBP3f797Zi73NgV3/PZISIe6D+5lHcnwB4AT9/GnBwjuZOgGV9yDKLjl6noMeN7bBgDbJ7/fc3ADAA7rd08+N5fHCG4AOBK//yPBDQBNefL0ubk8RnADwJH47BnBDQBNefY5wQ0ATXn+3F4eI7gBoDEENwA0huAGgMYQ3ADQGIIbABpDcANAYwhuAGgMwQ0AjSG4AaAxBDcANKY6uF999dUqb775prk9AGA/VgX348f/XSTB/fLLL5t1AAB2tyq4a74kuOWL8AaAwzhIcEtoe1ZduGYeXnQ3zm50Fw+NdeLueXd246J76F4/7C5unHXnd6My10VpLIA9WB3c8m/JSy+91N2/f5/gPhVXGNx3z8+6s7PA1E7sbnc+lTvv7pplRtLfvlyyj25/z7obFw8T6whuHMhH97rbN29uC+6zsze77sGfuX8tEtzyRXBfB3sI2gMHtxmgirQ5h7UL+/O7URlfTsL/vDtP9lHK3Ohu9OvL7QL79F731u173Uf995uDO4fgvk6uQ3BHVH8s6T4+vOhDu29vU7vAnmwK7tyX/GVJXXCHv7oGk2D8NdQvDyePTBq/vPTrbrpsot1pso7rx6uucHK6OqcJX1tPOiDMPrr9D/qrXkd1j+YxKq0Xep0em7jvfUiFZVP7Evd50Ua47fo+5gJSv1US9iGtHLq+j9Fy2c9xP5J1mMdv7mPyWGXOEyC2Q3Cfdd/pTzj/5b+tC+7hZF2e+P3JfB6cwO69xnESLMIhI1lW2g3ffwwn6PC9mvzJK8WV9VhSfTQnvn+d6GP1emPcS9urfUtQfRzaCMu7cI3GcVUfK+kfrBHXR2m3sC+Otc96WV1w99ukzmdrHIBKm4Pbhbbov9y3479VwS0ncOYKw75aHib02eI/fvzycF2irJs4vuxsmIDWZJV6xjrCCbmpHl+u0Ec18ePXVt3hssJ6c9xXbO9eG/sSj03chlq2pY/CGkOrTGrdTP8gsSz76M7J4H3x6ivunn0+W+MA1NnprRJ1xf2d/qTs7RTc7qQPJoQxCfwJn568oahsMhSEPZH8BJXJN/VrQz1pUR/jfVavrbrDZYX1Zr9lvR/LUv0JYR+tNtSyLX2sVRfc5XJxH4fXc/gG4v/kDMfCfZ86nyvGFTC899bGvyqRcM6pfatkPmnvdhdyckeTdrhSmSfBRTSRkid9smzcrgRzYSLJZHPvd4cTfUM9sVQf3eSe21JjMJYLw2Ld+qHf6kpxTahOyyKuz7qNufzYp6iNUh/n7cdzYyyr9WWjq+CpnXAc5fu4PavcuL5mn9UVd9yW35fc+VwzroDyUXfv9s3u9r2P1ge3hHIN+cr+56Q7wfuJ5uiT2V/N3OjDcA6EcWL6bYKJaEmWVe0uA2Y5kZZB46yuZynVx2GCD8v1GIx198um7YLxKa8XQzBmt4/6PvUnCCElDCshgTXV3wfahfHDIddH89xICNsK++fqiH8AGnWqckPf5nID61hWBXdUn3ksK84TwHnvre7mzZvO6uBe85UNbmxQmuxXFAYqrE4cY4EXYFVwP3jwYBWCe9+OM7jVWw8njrHAi1Ad3BLCW1h1YasjC+7pbQquMBkLvEjVwQ0AOA4ENwA0huAGgMYQ3ADQGIIbABpTHdzy54A1eFgwABzWquC2Pt4e42HBAHBYq4K75ouHBQPAYR0kuPkAzolR9/swqJstXdHH8rPk/i2Z/u9DaYzW2nd9x+7U9rdgdXDLvyVykykeFnxCCO6yxoJb3QBNJD/GH960rPCp0fHTpclj7/YpuHnXYh3BzcOCUWkPQXt0wR334RDBve/9fLHjpu5+mCR9msPahb15186h7zyEeVc8LBjV9hAYBPcevNhxqwvuiDrOlvQ+yM25pL1N7Z6gTcGd+5K/LKkL7vBXrOBgjb8u+eXhQU7eU9mQLptodzqpxvU8LLjv+/E/LDh5viTHMeqb65cs64Nb7hvul6srx1R/ltsN64w2CmM01Wnuz/r6lue81U+/fkm/VRLWlVYOXX/so+WyL+P5kawj3l9znER8Dvvz7nrZIbh5WHB1PZZUH80T1L9O9LF6vTHupe3VviWoPg5thOVdCETjuKqPSX1dteeLMY5zH4c2p7B2Zf3xzR3r3HZRG8YYrTr/19ZnjKndzzJ9wRJxdcnx1MfcFo/7clldcJfHaX59PW0Obh4WvLYeX67QR3WCxq+tusNlhfXmuK/Y3r029iUem7gNtWxLH4U1hoPtv7mM68LjPK0fX2ePdWa7uI3SGAXs839tfWH5XD/T4zqLt7fpH9CWaB96bl+D326qr7h7VeN0Te30VgkPC9ZlB2tPnKiP8T6r11bd4bLC+uQE92NZqj8h7KPVhlq2pY8JufNl1TgWgjvZnz0Hd25/VtcX9iXXzxp1wV0uF+3D+HoO34B6q6oX7u+acbqGeFhwj4cFh2Nu9b1if1yfdRtz+bFPURulPs7bZx4WXDhfSuMYtpEOttyxzm0XtZEdo4rzv6K+9HHN9dPSl4+ugqe6wnGV7+PjaJUb1y/2waCuuOO2/P6uGadrhYcFT+vmA5w64GOf4vZW17OU6uNwIg7LeVhw3P/QUJevJz5f0uMY71Mh2JLHOr+daiMeI3MfK/fHqi97XAv7ZwmPYXjcXbvGPsZtqnJ6vzxrjlQFd3achnU18685PCy4VaWT8opO2kWIAHvGOaasCm7rgcA5BPe+HWdwu6uu8KoM2DPOMa06uCWEt7DqwlZHFtzTr9NcCeFAOMdM1cENADgOBDcANIbgBoDGmMH97PPn3b/cf9T9ww/+q7v1vf8EABwRM7h/ePnL7sc//1X3yadPuy+//BIAcETM4P677/+i++zpc7VM/hywBg8LBoDDMoNbLsUl1cNlEsrWx9tjPCwYAA5rVXDXfPGwYAA4rIMENx/AOTHqvhQGdVOgA39ISLVlKPX1FDEmzVkd3PJvidxkiocFnxCCexV1czGR7G9446jCJwfHTxgmx9Xtd3ADp8U6grsJuYcFl4JbnivJw4JPxR6C9piC+wioO+AlyTjNYe3C3rwj5jCePIj3FBQeFlwT3DkE93VCcO9bXXBHivuVHle5QZO0t6ldHKVNwZ37kr8sqQtuff/g6YQaf6Xzy8MTMXnvX0O6bKLd6cQf1/Ow4L7vDTwseE1bsnzq67BuX8d3zbmp3yrJl/XKoev7FS2X/R37mKzDPOfmPibPr2ms8KLtENw8LLi6Hkuqj+Yk8q8Tfaxeb4x7aXu1bwmqj0MbYXkXVNE4rupj0oa2wr7u6/imjmUF/cMi4uqVtgrj74R9tJfVBXe/zYk/iLcFm4ObhwWvrceXK/QxDoF4UmUnZ2G9Oe4rtnevjX2JxyZuQy3b0kdhtLulLTWe+z6+0bG0+jytC8uk1s30DyTLsl9uHgXvi1dfcffsOWjtO67CTm+V8LBgXXaw9uSO+hjvs3pt1R0uK6w3+y3r/ViW6k8I+2i1oZZt6WPClrai8d3v8R3W1Z2bXl1wl8vF/fJ9MZiP4RvHxH2fmoO5fceLknxYcCm4JZxzat8qmU8AHhY8beMmytyWGoOx3PL5lLXrh35Pk1KUgq5mf1yfdRtz+bFPURulPs7bZx4WXNmW6rvq6/h61+ObOpZ+vdLXHV0FT/0Nj718H4+RVW5cX253/iHlXsdt+THJzcGKNnBIhYcF54JbQrmGfGX/c9KdLP1J6+gTw18ZxA9LdSe53yY4qS3Jsqrd8CRMnZRjn+L2VtezlOrjMFmG5eaDUPtl03bB+JTXiyGUsttHfZ/6E0xoJZz4Qib/VH8fDgd7WHCvpq1wf+K+jmV2Pb5rzk3V53BMXZtzIIfngRoHVW7s/1RuYJ1/VcEd1XcyD+JtQelhwbngXvOVDW5sUJo4VzSx1MRHczh+zVkV3NYDgXMI7n07zuBWv8ajORy/9lQHt4TwFmEd2NWRBff0Kz9Xa03i+DWrOrgBAMfBDO7bd37Rffrk2WI5AODqmcH9o3//oLv34EP3FBy58gYAHA8zuP/49PPuBz/7pXuEmbxtAgA4HmZwAwCOV3Vwy58D1uBhwQBwWKuC2/p4e4yHBQPAYa0K7povHhYMAId1kOA+7g/gyL06+MCBSd0D49QVPsy0ZawYX+zJ6uCWf0vkJlPH+7BggjvpCoJF3ZxJ5D56PX7SL/vJULcPc32qbG7dAsGNI5R7WLBFAtkHtzxXst2HBV+H4L6ae5IcgrpjXdKwv/kH4or+2C7utueP9XBXxGnbYohenzHGdVF4WLAlDu4cgvvQTi24vbX7LeV9OMtxD4M6fh0juHG8NgV37kv+sqQc3OOkuTv/6uomSHCf4mEyD5NHTWwpM15VJe9XPF5dzet605VYTXDr7ef243rjNvt9kvtBm9ul1i3rza+70H1Q+xUsV33zITSWSb0doa5Q/eu5ziHElsdE3V3O3CZNv1VSOi5rw1T2d65z7qdxXi1EYxbvz+JqPnd8rW38a6Pu2uOFk7VDcO/+sODphPSB7W9AH57gQVDLOpno7gSPJ8FkqDuc3C4cpjpkvbWdN2y/nHjGctfvcPLG++Cv6Err/PciDKdUX+IAK/VtKF8MRjWm/Taph8aqYxL2JbNNhfLtReP9zltezftxqBiLqWxQLtwfNVa54xuoHV+rbSCwObh3eljwIqxyr+Pvo8kSTxAVKtYyq46gHmt7YS4PgyTsp19n7UO0zk1Y34eZC5xUX1S7vWLfovKOse8qWAb2bzXB/qzaxi8LxyIUj1PM2g+b+2GtnkQT1a3C1eqb1VawTO133G8pZ+xH9VjV7ydO005vlWx+WPDiRM+/lpNbgsyd5GoyiuEkzwavWiZ168mjpMIyGY6+n7nJm1mXak8k10UTu9i3qHxKGCzu++CKNQodfzXrj81cJr1NWTxOsbr9WIZ2zxij5RV5yGorWKb2LXfsA+E22bGqPF44ScmHBVvC4JZwztl3cLuTOn6ga7+s7oHAw7p50sr6XJjE2/uH1Q7L1URXYRD1WU3e0jo9SecH06b6Ek/sUt/i8glheERBN1wZBuNmHZPSNgt9v4OAdYHrt3d9CcdMGPuhyg3rzTBe1Lccd22oK/wBoPYnHCtXV1i3bDu+DtsNt8mOVeXxwokpPCzY4oNbQrmGfO0tuHtqUofL+snnhFdYMin8cqlHPUBW6s6FSc9NML99WFa29cutdWGfg8mbXddT7VnBtGxvmOj9MrVfcx26b5VBEAbLuI2vL35w87ReXdmWtjGExyo8vq4vfox0vZ7bn7CcOu7ePM7TmI3y4zGOWeqhxmqsMsc37F/1+I5tE9wIlR4WbAnfIqn9Sgf3evlfawuiqxskqGDB3jG+2JNVwW09EDhnb8G96wlPcFdxV6SM08EwvtiX6uCWEN7CqmsN/3bITr82Etx501sMXA0eBOOLPasObgDAcSC4AaAxBDcANIbgBoDGENwA0BiCGwAaQ3ADQGMIbgBoDMENAI0huAGgMQQ3ADSG4AaAxhDcANAYghsAGkNwA0BjCG4AaAzBDQCNIbgBoDEENwA0huAGgMYQ3ADQGIIbABpDcANAYwhuAGgMwQ0AjSG4AaAxBDcANIbgBoDGENwA0BiCGwAaQ3ADQGMIbgBoDMENAI0huAGgMQQ3ADSG4AaAxhDcANAYghsAGkNwA0BjCG4AaAzBDQCNIbgBoDEENwA0huAGgMYQ3ADQGIIbABpDcANAYwhuAGgMwQ0AjSG4AaAxBDcANIbgBoDGENwA0BiCGwAaQ3ADQGMIbgBoDMENAI0huAGgMQQ3ADSG4AaAxhDcANAYghsAGkNwA0BjCG4AaAzBDQBN+aL7E2KwvAG3LK5yAAAAAElFTkSuQmCC" alt="graphic"></p>
<p>从网盘下载jar包</p>
<p>移动到这个lib下</p>
<p><img src="/../img/image-20220210115615285.png" alt="image-20220210115615285"></p>
<p><strong>第四步：测试OK</strong></p>
<h1 id="6-md5加密"><a href="#6-md5加密" class="headerlink" title="6.md5加密"></a>6.md5加密</h1><p><strong>第一步：数据库生成下md5密码</strong></p>
<p>SELECT MD5(‘jiang’);</p>
<p><strong>第二步：修改application.properties配置文件</strong></p>
<p>cas.authn.jdbc.query[0].passwordEncoder.type=DEFAULT</p>
<p>cas.authn.jdbc.query[0].passwordEncoder.characterEncoding=UTF-8</p>
<p>#MD5加密策略</p>
<p>cas.authn.jdbc.query[0].passwordEncoder.encodingAlgorithm=MD5</p>
<p><strong>第三步：测试OK</strong></p>
<h1 id="7-客户端-springboot整合"><a href="#7-客户端-springboot整合" class="headerlink" title="7.客户端+springboot整合"></a>7.客户端+springboot整合</h1><p>pom</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.jasig.cas.client/cas-client-core --&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;groupId&gt;org.jasig.cas.client&lt;/groupId&gt;</span><br><span class="line"></span><br><span class="line">  &lt;artifactId&gt;cas-client-core&lt;/artifactId&gt;</span><br><span class="line"></span><br><span class="line">  &lt;version&gt;3.6.1&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>去webapps\cas\WEB-INF\classes\services\HTTPSandIMAPS-10000001</p>
<p>添加http</p>
<p><img src="/../img/image-20220210140934201.png" alt="image-20220210140934201"></p>
<p>在application中添加下两行</p>
<p>cas.tgc.secure=false</p>
<p>cas.serviceRegistry.initFromJson=true</p>
<p><img src="/../img/image-20220210141010649.png" alt="image-20220210141010649"></p>
<h1 id="8-获取用户名"><a href="#8-获取用户名" class="headerlink" title="8.获取用户名"></a>8.获取用户名</h1><p>源码里，session.<em>const_cas_assertion</em>.principal.name</p>
<p><img src="/../img/image-20220210141527789.png" alt="image-20220210141527789"></p>
<h1 id="9-cas服务端初始化页面修改"><a href="#9-cas服务端初始化页面修改" class="headerlink" title="9.cas服务端初始化页面修改"></a>9.cas服务端初始化页面修改</h1><p>前端知识，不看了</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>CAS单点登录</tag>
      </tags>
  </entry>
  <entry>
    <title>file</title>
    <url>/2021/11/30/File/</url>
    <content><![CDATA[<h1 id="1-3-常用方法"><a href="#1-3-常用方法" class="headerlink" title="1.3 常用方法"></a>1.3 常用方法</h1><p>File的常用方法主要分为获取功能、获取绝对路径和相对路径、判断功能、创建删除功能的方法</p>
<h2 id="1-3-1-获取功能的方法"><a href="#1-3-1-获取功能的方法" class="headerlink" title="1.3.1 获取功能的方法"></a>1.3.1 获取功能的方法</h2><p>1、public String getAbsolutePath() ：返回此File的绝对路径名字符串。</p>
<p>2、public String getPath() ：将此File转换为路径名字符串。</p>
<p>3、public String getName() ：返回由此File表示的文件或目录的名称。</p>
<p>4、public long length() ：返回由此File表示的文件的长度。</p>
<p>以上方法测试，代码如下【注意测试以自己的电脑文件夹为准】：</p>
<pre><code>    public class FileGet &#123;
    public static void main(String[] args) &#123;
        File f = new File(&quot;d:/aaa/bbb.java&quot;);     
        System.out.println(&quot;文件绝对路径:&quot;+f.getAbsolutePath());
        System.out.println(&quot;文件构造路径:&quot;+f.getPath());
        System.out.println(&quot;文件名称:&quot;+f.getName());
        System.out.println(&quot;文件长度:&quot;+f.length()+&quot;字节&quot;);
    File f2 = new File(&quot;d:/aaa&quot;);     
    System.out.println(&quot;目录绝对路径:&quot;+f2.getAbsolutePath());
    System.out.println(&quot;目录构造路径:&quot;+f2.getPath());
    System.out.println(&quot;目录名称:&quot;+f2.getName());
    System.out.println(&quot;目录长度:&quot;+f2.length());
&#125;
&#125;
</code></pre>
<p>输出结果：<br>文件绝对路径:d:\aaa\bbb.java<br>文件构造路径:d:\aaa\bbb.java<br>文件名称:bbb.java<br>文件长度:2116字节</p>
<p>目录绝对路径:d:\aaa<br>目录构造路径:d:\aaa<br>目录名称:aaa<br>目录长度:3236</p>
<p>注意：length()，表示文件的长度。但是File对象表示目录，则返回值未指定。</p>
<h2 id="1-3-2-绝对路径和相对路径"><a href="#1-3-2-绝对路径和相对路径" class="headerlink" title="1.3.2 绝对路径和相对路径"></a>1.3.2 绝对路径和相对路径</h2><p>绝对路径：一个完整的路径，以盘符开头，例如F://aaa.txt。<br>相对路径：一个简化的路径，不以盘符开头,例如//aaa.txt//b.txt。</p>
<p>1、路径是不区分大小写<br>2、路径中的文件名称分隔符windows使用反斜杠,反斜杠是转义字符,两个反斜杠代表一个普通的反斜杠</p>
<p>​<br>​        //绝对路径<br>​    public class FilePath {<br>​        public static void main(String[] args) {<br>​              // D盘下的bbb.java文件<br>​            File f = new File(“D:\bbb.java”);<br>​            System.out.println(f.getAbsolutePath());<br>​        // 项目下的bbb.java文件<br>​        File f2 = new File(“bbb.java”);<br>​        System.out.println(f2.getAbsolutePath());<br>​    }<br>​    }</p>
<p>输出结果：<br>D:\bbb.java<br>D:\java\bbb.java</p>
<h2 id="1-3-3判断功能的方法"><a href="#1-3-3判断功能的方法" class="headerlink" title="1.3.3判断功能的方法"></a>1.3.3判断功能的方法</h2><p>1、 public boolean exists() ：此File表示的文件或目录是否实际存在。<br>2、 public boolean isDirectory() ：此File表示的是否为目录。<br>3、public boolean isFile() ：此File表示的是否为文件。</p>
<p>方法演示，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class FileIs &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        File f = new File(&quot;d:\\aaa\\bbb.java&quot;);</span><br><span class="line">        File f2 = new File(&quot;d:\\aaa&quot;);</span><br><span class="line">      	// 判断是否存在</span><br><span class="line">        System.out.println(&quot;d:\\aaa\\bbb.java 是否存在:&quot;+f.exists());</span><br><span class="line">        System.out.println(&quot;d:\\aaa 是否存在:&quot;+f2.exists());</span><br><span class="line">      	// 判断是文件还是目录</span><br><span class="line">        System.out.println(&quot;d:\\aaa 文件?:&quot;+f2.isFile());</span><br><span class="line">        System.out.println(&quot;d:\\aaa 目录?:&quot;+f2.isDirectory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">d:\aaa\bbb.java 是否存在:true</span><br><span class="line">d:\aaa 是否存在:true</span><br><span class="line">d:\aaa 文件?:false</span><br><span class="line">d:\aaa 目录?:true</span><br></pre></td></tr></table></figure>

<h2 id="1-3-4-创建删除功能的方法"><a href="#1-3-4-创建删除功能的方法" class="headerlink" title="1.3.4 创建删除功能的方法"></a>1.3.4 创建删除功能的方法</h2><p>public boolean createNewFile() ：文件不存在，创建一个新的空文件并返回true，文件存在，不创建文件并返回false。<br>public boolean delete() ：删除由此File表示的文件或目录。<br>public boolean mkdir() ：创建由此File表示的目录。<br>public boolean mkdirs() ：创建由此File表示的目录，包括任何必需但不存在的父目录。<br>其中，mkdirs()和mkdir()方法类似，但mkdir()，只能创建一级目录，mkdirs()可以创建多级目录比如//a//b//c，所以开发中一般用mkdirs();</p>
<p>这些方法中值得注意的是createNewFile方法以及mkdir与mkdirs的区别</p>
<p>方法测试，代码如下：</p>
<pre><code>     public class FileCreateDelete &#123;
    public static void main(String[] args) throws IOException &#123;
        // 文件的创建
        File f = new File(&quot;aaa.txt&quot;);
        System.out.println(&quot;是否存在:&quot;+f.exists()); // false
        System.out.println(&quot;是否创建:&quot;+f.createNewFile()); // true
        System.out.println(&quot;是否创建:&quot;+f.createNewFile()); // 以及创建过了所以再使用createNewFile返回false
        System.out.println(&quot;是否存在:&quot;+f.exists()); // true
     // 目录的创建
      File f2= new File(&quot;newDir&quot;);    
    System.out.println(&quot;是否存在:&quot;+f2.exists());// false
    System.out.println(&quot;是否创建:&quot;+f2.mkdir());    // true
    System.out.println(&quot;是否存在:&quot;+f2.exists());// true

    // 创建多级目录
      File f3= new File(&quot;newDira\\newDirb&quot;);
    System.out.println(f3.mkdir());// false
    File f4= new File(&quot;newDira\\newDirb&quot;);
    System.out.println(f4.mkdirs());// true
  
      // 文件的删除
       System.out.println(f.delete());// true
  
      // 目录的删除
    System.out.println(f2.delete());// true
    System.out.println(f4.delete());// false
&#125;
&#125;
</code></pre>
<p>注意：delete方法，如果此File表示目录，则目录必须为空才能删除。</p>
<h2 id="1-4-目录的遍历"><a href="#1-4-目录的遍历" class="headerlink" title="1.4 目录的遍历"></a>1.4 目录的遍历</h2><p>public String[] list() ：返回一个String数组，表示该File目录中的所有子文件或目录。</p>
<p>public File[] listFiles() ：返回一个File数组，表示该File目录中的所有的子文件或目录。</p>
<p>​<br>​          public class FileFor {<br>​        public static void main(String[] args) {<br>​            File dir = new File(“G:\光标”);<br>​          //获取当前目录下的文件以及文件夹的名称。<br>​        String[] names = dir.list();<br>​        for(String name : names){<br>​            System.out.println(name);<br>​        }<br>​        //获取当前目录下的文件以及文件夹对象，只要拿到了文件对象，那么就可以获取更多信息<br>​        File[] files = dir.listFiles();<br>​        for (File file : files) {<br>​            System.out.println(file);<br>​        }<br>​    }<br>​    }</p>
<p>listFiles在获取指定目录下的文件或者文件夹时必须满足下面两个条件</p>
<p>1，指定的目录必须存在</p>
<p>2，指定的必须是目录。否则容易引发返回数组为null，出现NullPointerException异常</p>
<p>1.5 递归遍历文件夹下所有文件以及子文件<br>不说啥了，直接上代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package File;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line"></span><br><span class="line">//递归遍历文件夹下所有的文件</span><br><span class="line">public class RecursionDirectory &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">      File file=new File(&quot;D:\\java专属IO测试&quot;);</span><br><span class="line">        Recursion(file);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void Recursion(File file)&#123;</span><br><span class="line">        //1、判断传入的是否是目录</span><br><span class="line">        if(!file.isDirectory())&#123;</span><br><span class="line">            //不是目录直接退出</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //已经确保了传入的file是目录</span><br><span class="line">        File[] files = file.listFiles();</span><br><span class="line">        //遍历files</span><br><span class="line">        for (File f: files) &#123;</span><br><span class="line">            //如果该目录下文件还是个文件夹就再进行递归遍历其子目录</span><br><span class="line">            if(f.isDirectory())&#123;</span><br><span class="line">                //递归</span><br><span class="line">                Recursion(f);</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                //如果该目录下文件是个文件，则打印对应的名字</span><br><span class="line">                System.out.println(f.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-5父级路径是否存在，不存在创建"><a href="#1-5父级路径是否存在，不存在创建" class="headerlink" title="1.5父级路径是否存在，不存在创建"></a>1.5父级路径是否存在，不存在创建</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">File file = new File(pdfPath);</span><br><span class="line">if (!file.getParentFile().exists()) &#123;</span><br><span class="line">                file.getParentFile().mkdirs();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h1 id="直接复制file"><a href="#直接复制file" class="headerlink" title="直接复制file"></a>直接复制file</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;声音文件上传&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseMessage2 <span class="title">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(<span class="string">&quot;上传失败，请选择文件&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String fileName = file.getOriginalFilename();</span><br><span class="line">        File dir = <span class="keyword">new</span> File(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!dir.isDirectory()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        File dest = <span class="keyword">new</span> File(filePath + fileName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//直接复制文件</span></span><br><span class="line">            file.transferTo(dest);</span><br><span class="line">            map.put(<span class="string">&quot;key&quot;</span>, fileName);</span><br><span class="line">            log.info(<span class="string">&quot;声音文件上传成功!文件名称:&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseMessage2.Success(<span class="string">&quot;文件上传成功!&quot;</span>, map);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>file</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins自动化部署</title>
    <url>/2021/11/30/Jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h1><p>版本2.334</p>
<p>将下载的jenkins.war放在服务器的/opt/jenkins</p>
<p>vim /etc/profile</p>
<p>export JENKINS_HOME=/opt/jenkins</p>
<p>source /etc/profile</p>
<h2 id="后台挂载使用这个命令："><a href="#后台挂载使用这个命令：" class="headerlink" title="后台挂载使用这个命令："></a>后台挂载使用这个命令：</h2><p>nohup java -jar /opt/jenkins/jenkins.war –httpPort=8081 -Dfile.encoding=UTF-8  &gt; jenkins.out 2&gt;&amp;1 &amp;</p>
<h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><p>tail -200f /opt/jenkins/jenkins.out</p>
<p>访问39.105.28.228:8081/jenkins，等待一段时间即可</p>
<p><img src="/../img/image-20220216152526307.png" alt="image-20220216152526307"></p>
<p>然后到提示的文件中把里面的文本复制出来填到管理员密码中。</p>
<pre><code>接下来选择安装推荐的插件
</code></pre>
<p>HTML Publisher</p>
<p>git</p>
<p>gitlab</p>
<p>gitbub</p>
<p>subversion</p>
<p>ssh slaves</p>
<p>publish over ssh</p>
<p>Role-based Authorization Strategy</p>
<p><img src="/../img/image-20220225173004525.png" alt="image-20220225173004525"></p>
<p>jiang</p>
<p>jiang</p>
<p>jiang</p>
<p><a href="mailto:&#106;&#105;&#x61;&#x6e;&#x67;&#106;&#105;&#x61;&#x78;&#x75;&#53;&#x32;&#49;&#64;&#49;&#x36;&#x33;&#x2e;&#99;&#111;&#x6d;">&#106;&#105;&#x61;&#x6e;&#x67;&#106;&#105;&#x61;&#x78;&#x75;&#53;&#x32;&#49;&#64;&#49;&#x36;&#x33;&#x2e;&#99;&#111;&#x6d;</a></p>
<p><strong>如果用tomcat启动报错了的话</strong></p>
<p><img src="/../img/image-20220225153623701.png" alt="image-20220225153623701"></p>
<h1 id="2-前提"><a href="#2-前提" class="headerlink" title="2.前提"></a>2.前提</h1><h2 id="1-git"><a href="#1-git" class="headerlink" title="1.git"></a>1.git</h2><p>1.安装依赖的包</p>
<p>yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel<br>yum install  gcc perl-ExtUtils-MakeMaker<br>2.下载git源码并解压</p>
<p>mkdir /usr/local/git</p>
<p>cd /usr/local/git</p>
<p>wget <a href="https://github.com/git/git/archive/v2.3.0.zip">https://github.com/git/git/archive/v2.3.0.zip</a><br>unzip v2.3.0.zip（或：unzip v2.3.0）<br>进入解压的目录</p>
<p>cd git-2.3.0<br>3.编译安装</p>
<p>安装在/usr/local/下</p>
<p>make prefix=/usr/local/git all<br>make prefix=/usr/local/git install</p>
<p>git –version</p>
<p>如果仍然提示command not found</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4.配置环境变量</span><br><span class="line"></span><br><span class="line">vim /etc/profile</span><br><span class="line">在文件最后一行添加：export PATH=/usr/local/git/bin:$PATH，保存退出</span><br><span class="line"></span><br><span class="line">发现仍然不行，这是因为配置还未生效，不重启系统，使用source命令立即生效</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br><span class="line">然后git --version，提示 git version 2.3.0，已安装成功。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-maven"><a href="#2-maven" class="headerlink" title="2.maven"></a>2.maven</h2><p><a href="http://maven.apache.org/download.cgi">http://maven.apache.org/download.cgi</a></p>
<p>找到下载好的maven</p>
<p>mkdir /usr/local/maven</p>
<p>cd /usr/local/maven</p>
<p>tar -zxvf apache-maven-3.8.4-bin.tar.gz</p>
<p>vi /etc/profile</p>
<p>export MAVEN_HOME=/usr/local/maven/apache-maven-3.8.4<br>export PATH=$MAVEN_HOME/bin:$PATH </p>
<p>source /etc/profiles</p>
<p>mvn -v 查看是否成功</p>
<h1 id="3-配置jenkins"><a href="#3-配置jenkins" class="headerlink" title="3.配置jenkins"></a>3.配置jenkins</h1><p><img src="/../img/image-20220225163053423.png" alt="image-20220225163053423"></p>
<h2 id="jdk"><a href="#jdk" class="headerlink" title="jdk"></a>jdk</h2><p><img src="/../img/image-20220225163059305.png" alt="image-20220225163059305"></p>
<h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><p><img src="/../img/image-20220225163106457.png" alt="image-20220225163106457"></p>
<h2 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h2><p><img src="/../img/image-20220225163133729.png" alt="image-20220225163133729"></p>
<p>注意开启maven配置文件里的仓库</p>
<p>这里是</p>
<p><img src="/../img/image-20220228091509933.png" alt="image-20220228091509933"></p>
<h1 id="4-配置gitbub以及gitbub的webhook"><a href="#4-配置gitbub以及gitbub的webhook" class="headerlink" title="4.配置gitbub以及gitbub的webhook"></a>4.配置gitbub以及gitbub的webhook</h1><p><img src="/../img/image-20220225165638836.png" alt="image-20220225165638836"></p>
<p>名称自定义，apiURL不变</p>
<p>添加页面</p>
<p>gitbub私人秘钥位置</p>
<p><img src="/../img/image-20220225165927116.png" alt="image-20220225165927116"></p>
<p><img src="/../img/image-20220225165824697.png" alt="image-20220225165824697"></p>
<p><img src="/../img/image-20220225170017830.png" alt="image-20220225170017830"></p>
<p><img src="/../img/image-20220225170235447.png" alt="image-20220225170235447"></p>
<p>复制url</p>
<p><img src="/../img/image-20220225171728610.png" alt="image-20220225171728610"></p>
<p>进入github找到自己的项目配置</p>
<p><img src="/../img/image-20220225171404914.png" alt="image-20220225171404914"></p>
<p><img src="/../img/image-20220228112344609.png" alt="image-20220228112344609"></p>
<p><img src="/../img/image-20220225171322864.png" alt="image-20220225171322864"></p>
<h1 id="4-5配置gitlab"><a href="#4-5配置gitlab" class="headerlink" title="4.5配置gitlab"></a>4.5配置gitlab</h1><p>看jenkins文件夹下的Jenkins-gitlab.pdf</p>
<h1 id="5-配置publish-over-SSH"><a href="#5-配置publish-over-SSH" class="headerlink" title="5.配置publish over SSH"></a>5.配置publish over SSH</h1><p><img src="/../img/image-20220225172205966.png" alt="image-20220225172205966"></p>
<p>点击新增</p>
<p><img src="/../img/image-20220225172242456.png" alt="image-20220225172242456"></p>
<p><img src="/../img/image-20220225172643503.png" alt="image-20220225172643503"></p>
<p>注意定要先创建/home/jenkins文件夹</p>
<h1 id="6-配置项目"><a href="#6-配置项目" class="headerlink" title="6.配置项目"></a>6.配置项目</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /home/websocket</span><br><span class="line">sh backup.sh websocket-0.0.1-SNAPSHOT.jar</span><br><span class="line">sh start.sh</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220228084132608.png" alt="image-20220228084132608"></p>
<p><img src="/../img/image-20220228084144150.png" alt="image-20220228084144150"></p>
<p><img src="/../img/image-20220228084154561.png" alt="image-20220228084154561"></p>
<p><img src="/../img/image-20220228084235211.png" alt="image-20220228084235211"></p>
<p><img src="/../img/image-20220228103651186.png" alt="image-20220228103651186"></p>
<p><img src="/../img/image-20220228084351062.png" alt="image-20220228084351062"></p>
<p>这个位置直接就是你自己项目的相对路径，比如下图就是直接pom.xml</p>
<p><img src="/../img/image-20220228084330137.png" alt="image-20220228084330137"></p>
<p><img src="/../img/image-20220228084403335.png" alt="image-20220228084403335"></p>
<p><img src="/../img/image-20220228084411646.png" alt="image-20220228084411646"></p>
<p><img src="/../img/image-20220228084423080.png" alt="image-20220228084423080"></p>
<p><img src="/../img/image-20220228104103924.png" alt="image-20220228104103924"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /home/jenkins/websocket</span><br><span class="line">sh backup.sh websocket-0.0.1-SNAPSHOT.jar</span><br><span class="line">mv ./remote/websocket-0.0.1-SNAPSHOT.jar ./</span><br><span class="line">sh start.sh</span><br></pre></td></tr></table></figure>

<h1 id="7-脚本"><a href="#7-脚本" class="headerlink" title="7.脚本"></a>7.脚本</h1><p>构建后的操作脚本</p>
<p>因为他会默认打包在jenkins的主目录下的workspace</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /home/jenkins/websocket</span><br><span class="line">sh backup.sh websocket-0.0.1-SNAPSHOT.jar</span><br><span class="line">mv ./remote/websocket-0.0.1-SNAPSHOT.jar ./</span><br><span class="line">sh start.sh</span><br></pre></td></tr></table></figure>

<p>chmod 777 start.sh</p>
<p>start.sh</p>
<p>这个启动脚本跟一般的不一样，需要添加dontkillme，因为jenkins会默认关闭由它启动的进程</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">source /etc/profile</span><br><span class="line">jar_pid=`ps -ef|grep -v grep | grep &#x27;websocket-0.0.1-SNAPSHOT.jar&#x27;|awk</span><br><span class="line">&#x27;&#123; print $2 &#125;&#x27;`</span><br><span class="line">echo $jar_pid</span><br><span class="line">if [ ! -n &quot;$jar_pid&quot; ]; then</span><br><span class="line">echo &#x27;will redploy.&#x27;</span><br><span class="line">rm -rf nohup.out</span><br><span class="line">BUILD_ID=dontKillMe nohup java -Xms512m -Xmx2048m -</span><br><span class="line">Dspring.profiles.active=dev -jar websocket-0.0.1-SNAPSHOT.jar &gt;nohup.out 2&gt;&amp;1 &amp;</span><br><span class="line">echo &#x27;redploy success0.&#x27;</span><br><span class="line">else</span><br><span class="line">kill -9 $jar_pid</span><br><span class="line">echo &#x27;kill&#x27; $jar_pid</span><br><span class="line">rm -rf nohup.out</span><br><span class="line">BUILD_ID=dontKillMe nohup java -Xms512m -Xmx2048m -</span><br><span class="line">Dspring.profiles.active=dev -jar websocket-0.0.1-SNAPSHOT.jar &gt;nohup.out 2&gt;&amp;1 &amp;</span><br><span class="line">echo &#x27;redploy success1.&#x27;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>chmod 777 backup.sh</p>
<p>backup.sh</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">jarName=$&#123;1&#125;</span><br><span class="line">path=`pwd`</span><br><span class="line">time=`date &#x27;+%Y%m%d%H%M%S&#x27;`</span><br><span class="line">date=$(date &quot;+%Y-%m-%d %H:%M:%S&quot;)</span><br><span class="line">reservedNum=5</span><br><span class="line">if [ ! -d &quot;$path/backup&quot; ]; then</span><br><span class="line">mkdir $path/backup</span><br><span class="line">echo &quot;Folder created successfully!&quot;</span><br><span class="line">else</span><br><span class="line">echo &quot;The folder already exists!&quot;</span><br><span class="line">fi</span><br><span class="line">sleep 0.5</span><br><span class="line">if [ -f &quot;$path/$jarName&quot; ];then</span><br><span class="line">echo &quot;$jarName File exists!&quot;</span><br><span class="line">cp -f $jarName $path/backup/$jarName$time.bak</span><br><span class="line">if [ -f &quot;$path/backup/$jarName$time.bak&quot; ];then</span><br><span class="line">rm -rf $jarName</span><br><span class="line">fileNum=$(ls -l $path/backup|grep ^- |wc -l)</span><br><span class="line">while(( $fileNum &gt; $reservedNum))</span><br><span class="line">do</span><br><span class="line">oldFile=$(ls -rt $path/backup| head -1)</span><br><span class="line">echo $date &quot;Delete File:&quot;$oldFile</span><br><span class="line">rm -rf $path/backup/$oldFile</span><br><span class="line">let &quot;fileNum--&quot;</span><br><span class="line">done</span><br><span class="line">echo &quot;File backup succeeded!&quot;</span><br><span class="line">else</span><br><span class="line">echo &quot;File backup failed!&quot;</span><br><span class="line">fi</span><br><span class="line">else</span><br><span class="line">echo &quot;The file does not exist!&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h1 id="8-jar包的最终位置"><a href="#8-jar包的最终位置" class="headerlink" title="8.jar包的最终位置"></a>8.jar包的最终位置</h1><p><img src="/../img/image-20220228091257515.png" alt="image-20220228091257515"></p>
<p><img src="/../img/image-20220228101359711.png" alt="image-20220228101359711"></p>
<p>最终生成在/home/jenkins/websocket/remote下</p>
<h1 id="9-启动"><a href="#9-启动" class="headerlink" title="9.启动"></a>9.启动</h1><p>可以手动构建</p>
<p>也可以push以后自动构建</p>
<h1 id="10-创建角色以及分配权限"><a href="#10-创建角色以及分配权限" class="headerlink" title="10.创建角色以及分配权限"></a>10.创建角色以及分配权限</h1><p><a href="http://www.itwps.com/d072/9da7">http://www.itwps.com/d072/9da7</a></p>
<p>看jenkins文件夹下的Jenkins-gitlab.pdf4.1.4.2 角色权限配置</p>
<h1 id="11-拉取指定分支"><a href="#11-拉取指定分支" class="headerlink" title="11.拉取指定分支"></a>11.拉取指定分支</h1><p><img src="/../img/image-20220302112652714.png" alt="image-20220302112652714"></p>
<p><img src="/../img/image-20220302112711739.png" alt="image-20220302112711739"></p>
<p><img src="/../img/image-20220302111835448.png" alt="image-20220302111835448"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>Jenkins自动化部署</tag>
      </tags>
  </entry>
  <entry>
    <title>captcha图片验证码工具</title>
    <url>/2021/11/30/captcha%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<h1 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h1><h2 id="1-controller"><a href="#1-controller" class="headerlink" title="1.controller"></a>1.controller</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 返回的是base64的img字符串</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@GetMapping(&quot;/get-image&quot;)</span><br><span class="line">	@ApiOperation(&quot;生成图片验证码&quot;)</span><br><span class="line">	public ResponseMessage2&lt;String&gt; getCaptchaImage() &#123;</span><br><span class="line">		return ResponseMessage2.Success2(CaptchaImgUtil.getInstance().getCaptchaImage());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">	 * 验证输入的图片验证码与生成的是否一致</span><br><span class="line">	 * @param val</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@GetMapping(&quot;/get-image2&quot;)</span><br><span class="line">	@ApiOperation(&quot;图片验证码验证&quot;)</span><br><span class="line">	public String getCaptchaImage2(String val)&#123;</span><br><span class="line">		return Convert.toStr(CaptchaImgUtil.getInstance().isSame(val));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-CaptchaImgUtil"><a href="#2-CaptchaImgUtil" class="headerlink" title="2.CaptchaImgUtil"></a>2.CaptchaImgUtil</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.test.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.captcha.CaptchaUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.captcha.CircleCaptcha;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/04/11  16:06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptchaImgUtil</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> String CODE=<span class="string">&quot;&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> CaptchaImgUtil captchaImgUtil;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CaptchaImgUtil <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(captchaImgUtil==<span class="keyword">null</span>)&#123;</span><br><span class="line">         captchaImgUtil=<span class="keyword">new</span> CaptchaImgUtil();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> captchaImgUtil;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span>  String <span class="title">getCaptchaImage</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="comment">// 生成验证码</span></span><br><span class="line">      CircleCaptcha captcha = CaptchaUtil.createCircleCaptcha(<span class="number">160</span>,<span class="number">60</span>);</span><br><span class="line">      CODE=captcha.getCode();</span><br><span class="line">      <span class="keyword">return</span> captcha.getImageBase64();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span>  <span class="keyword">boolean</span> <span class="title">isSame</span><span class="params">(String code)</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> code.equalsIgnoreCase(CODE);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h1><h2 id="1-定义方法"><a href="#1-定义方法" class="headerlink" title="1.定义方法"></a>1.定义方法</h2><p><img src="/../img/image-20220411161948146.png" alt="image-20220411161948146"></p>
<h2 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h2><p><img src="/../img/image-20220411162200341.png" alt="image-20220411162200341"></p>
<p><img src="/../img/image-20220411162217796.png" alt="image-20220411162217796"></p>
<p><img src="/../img/image-20220411162241658.png" alt="image-20220411162241658"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>captcha图片验证码工具</tag>
      </tags>
  </entry>
  <entry>
    <title>cookie-session-token</title>
    <url>/2021/11/30/cookie%EF%BC%8Csession%EF%BC%8Ctoken/</url>
    <content><![CDATA[<h1 id="1-cookie"><a href="#1-cookie" class="headerlink" title="1.cookie"></a>1.cookie</h1><p>​        在浏览器发展初期，为了适应用户的需求技术上推出了各种保持 Web 浏览状态的手段，其中就包括了 Cookie 技术。Cookie 在计算机中是个存储在浏览器目录中的文本文件，当浏览器运行时，存储在 RAM 中发挥作用 （此种 Cookies 称作 Session Cookies），一旦用户从该网站或服务器退出，Cookie 可存储在用户本地的硬盘上 （此种 Cookies 称作 Persistent Cookies）。</p>
<h2 id="Cookie时效性："><a href="#Cookie时效性：" class="headerlink" title="Cookie时效性："></a><strong>Cookie时效性：</strong></h2><p>目前有些 Cookie 是临时的，有些则是持续的。临时的 Cookie 只在浏览器上保存一段规定的时间，一旦超过规定的时间，该 Cookie 就会被系统清除。</p>
<h2 id="Cookie使用限制："><a href="#Cookie使用限制：" class="headerlink" title="Cookie使用限制："></a><strong>Cookie使用限制：</strong></h2><p>Cookie 必须在 HTML 文件的内容输出之前设置；不同的浏览器 (Netscape Navigator、Internet Explorer) 对 Cookie 的处理不一致，使用时一定要考虑；客户端用户如果设置禁止 Cookie，则 Cookie 不能建立。 并且在客户端，一个浏览器能创建的 Cookie 数量最多为 300 个，并且每个不能超过 4KB，每个 Web 站点能设置的 Cookie 总数不能超过 20 个。</p>
<h2 id="执行流程："><a href="#执行流程：" class="headerlink" title="执行流程："></a><strong>执行流程：</strong></h2><p>A：首先，客户端会发送一个http请求到服务器端；</p>
<p>B： 服务器端接受客户端请求后，发送一个http响应到客户端，这个响应头，其中就包含Set-Cookie头部；</p>
<p>C：在客户端发起的第二次请求（注意：如果服务器需要我们带上Cookie，我们就需要在B步骤上面拿到这个Cookie然后作为请求头一起发起第二次请求），提供给了服务器端可以用来唯一标识客户端身份的信息。这时，服务器端也就可以判断客户端是否启用了cookies。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cookie常用于存储用户的登录信息。</span></span><br><span class="line">Cookie c = <span class="keyword">new</span> Cookie(“username”,“john”);</span><br><span class="line"><span class="comment">//设置有效期：设置时间为0，则销毁cookie</span></span><br><span class="line">c.setMaxAge(<span class="number">3600</span>);</span><br><span class="line">response.addCookie；</span><br><span class="line"></span><br><span class="line">Cookie[] c = request.getCookies();</span><br><span class="line"><span class="keyword">if</span>(c != <span class="keyword">null</span>)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; c.length;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(“username”.equals(c.getName()))</span><br><span class="line">out.println(c.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取cookie的代码：</span></span><br><span class="line"></span><br><span class="line">Cookie[] cookies = request.getCookies();</span><br></pre></td></tr></table></figure>



<h1 id="2-session"><a href="#2-session" class="headerlink" title="2.session"></a>2.session</h1><p>​        Cookie 虽然很方便，但是使用 Cookie 有一个很大的弊端，Cookie 中的所有数据在客户端就可以被修改，数据非常容易被伪造，那么一些重要的数据就不能存放在 Cookie 中了，而且如果 Cookie 中数据字段太多会影响传输效率。为了解决这些问题，就产生了 Session，<strong>Session 中的数据是保留在服务器端的</strong>。</p>
<p>​        Session是服务器在和客户端建立连接时添加客户端连接标志，最终会在服务器软件（Apache、Tomcat、JBoss）转化为一个临时Cookie发送给给客户端，当客户端第一请求时服务器会检查是否携带了这个Session（临时Cookie），如果没有则会添加Session，如果有就拿出这个Session来做相关操作。</p>
<p>Session 的运作通过一个session_id来进行。session_id通常是存放在客户端的 Cookie 中</p>
<h2 id="Session-可以存放在："><a href="#Session-可以存放在：" class="headerlink" title="Session 可以存放在："></a><strong>Session 可以存放在：</strong></h2><blockquote>
<p>1）内存；</p>
<p>2）Cookie本身；</p>
<p>3）redis 或 memcached 等缓存中；</p>
<p>4）数据库中</p>
</blockquote>
<h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(&quot;/sessiondemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionDemo</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF=8&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        session.setAttribute(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;孤傲苍狼&quot;</span>);</span><br><span class="line">        String sessionId = session.getId();</span><br><span class="line">        <span class="keyword">if</span> (session.isNew()) &#123;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;session创建成功，session的id是：&quot;</span>+sessionId);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;服务器已经存在session，session的id是：&quot;</span>+sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doGet(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="3-Token"><a href="#3-Token" class="headerlink" title="3.Token"></a>3.Token</h1><p>​        token是用户身份的验证方式，我们通常叫它：令牌。最简单的token组成:uid(用户唯一的身份标识)、time(当前时间的时间戳)、sign(签名，由token的前几位+盐以哈希算法压缩成一定长的十六进制字符串，可以防止恶意第三方拼接token请求服务器)。还可以把不变的参数也放进token，避免多次查库。</p>
<h2 id="Token的使用流程："><a href="#Token的使用流程：" class="headerlink" title="Token的使用流程："></a><strong>Token的使用流程：</strong></h2><p><strong>A：</strong>当用户首次登录成功（注册也是一种可以适用的场景）之后, 服务器端就会生成一个 token 值，这个值，会在服务器保存token值(保存在数据库中)，再将这个token值返回给客户端；</p>
<p><strong>B：</strong>客户端拿到 token 值之后,进行本地保存。（SP存储是大家能够比较支持和易于理解操作的存储）；</p>
<p><strong>C：</strong>当客户端再次发送网络请求(一般不是登录请求)的时候,就会将这个 token 值附带到参数中发送给服务器；</p>
<p><strong>D：</strong>服务器接收到客户端的请求之后,会取出token值与保存在本地(数据库)中的token值做对比。</p>
<h2 id="Token的身份认证逻辑："><a href="#Token的身份认证逻辑：" class="headerlink" title="Token的身份认证逻辑："></a><strong>Token的身份认证逻辑：</strong></h2><p>对比一：如果两个 token 值相同， 说明用户登录成功过!当前用户处于登录状态！</p>
<p>对比二：如果没有这个 token 值, 则说明没有登录成功；</p>
<p>对比三：如果 token 值不同: 说明原来的登录信息已经失效,让用户重新登录。</p>
<h2 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h2><h3 id="1-生成token"><a href="#1-生成token" class="headerlink" title="1.生成token"></a>1.生成token</h3><p><img src="/../img/image-20210820085115539.png" alt="image-20210820085115539"></p>
<h2 id="2-从request-headers取出token"><a href="#2-从request-headers取出token" class="headerlink" title="2.从request headers取出token"></a>2.从request headers取出token</h2><p><img src="/../img/image-20210820085347348.png" alt="image-20210820085347348"></p>
<h2 id="3-swagger从headers中取出测试token"><a href="#3-swagger从headers中取出测试token" class="headerlink" title="3.swagger从headers中取出测试token"></a>3.swagger从headers中取出测试token</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParameterBuilder tokenPar = <span class="keyword">new</span> ParameterBuilder();</span><br><span class="line">List&lt;Parameter&gt; pars = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">tokenPar.name(<span class="string">&quot;Authorization&quot;</span>).description(<span class="string">&quot;令牌&quot;</span>).modelRef(<span class="keyword">new</span> ModelRef(<span class="string">&quot;string&quot;</span>)).parameterType(<span class="string">&quot;header&quot;</span>).required(<span class="keyword">false</span>).build();</span><br><span class="line">pars.add(tokenPar.build());</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210820091403595.png" alt="image-20210820091403595"></p>
<h2 id="4-设置过滤器，保证每个请求都会判断token"><a href="#4-设置过滤器，保证每个请求都会判断token" class="headerlink" title="4.设置过滤器，保证每个请求都会判断token"></a>4.设置过滤器，保证每个请求都会判断token</h2><p><img src="/../img/image-20210820094546315.png" alt="image-20210820094546315"></p>
<p>这里把token存在header中了，而秒杀商城是存在cookie中</p>
<h2 id="5-前端里请求头中携带token"><a href="#5-前端里请求头中携带token" class="headerlink" title="5.前端里请求头中携带token"></a>5.前端里请求头中携带token</h2><p>前端接受后端传过来的token，设置进localStorage中</p>
<p>方法：localStorage.token=”data.token”</p>
<p><img src="/../img/image-20210820140949682.png" alt="image-20210820140949682"></p>
<h2 id="6-跨越问题"><a href="#6-跨越问题" class="headerlink" title="6.跨越问题"></a>6.跨越问题</h2><p><img src="/../img/image-20210820141216272.png" alt="image-20210820141216272"></p>
<h2 id="7-清楚token"><a href="#7-清楚token" class="headerlink" title="7.清楚token"></a>7.清楚token</h2><p>后端redis清楚</p>
<p>前端</p>
<p><img src="/../img/image-20210820141606908.png" alt="image-20210820141606908"></p>
<h1 id="4-Cookie和Session的区别小结"><a href="#4-Cookie和Session的区别小结" class="headerlink" title="4.Cookie和Session的区别小结"></a>4.Cookie和Session的区别小结</h1><p>1）cookie数据存放在客户的浏览器上，session数据放在服务器上；</p>
<p>2）cookie不是很安全，别人可以分析存放在本地的cookie并进行cookie欺骗,考虑到安全应当使用session；</p>
<p>3）session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能,考虑到减轻服务器性能方面，应当使用cookie；</p>
<p>4）单个cookie保存的数据不能超过4K，很多浏览器都限制一个站点最多保存20个cookie。</p>
<p><strong>所以个人建议：</strong></p>
<p>将登陆信息等重要信息存放为session；</p>
<p>其他信息如果需要保留，可以放在cookie中。</p>
<h1 id="5-Token-和-Session-的区别小结"><a href="#5-Token-和-Session-的区别小结" class="headerlink" title="5.Token 和 Session 的区别小结"></a>5.Token 和 Session 的区别小结</h1><p>​        Session和 token并不矛盾，作为身份认证token安全性比Session好，因为每个请求都有签名还能防止监听以及重放攻击，而Session就必须靠链路层来保障通讯安全了。如上所说，如果你需要实现有状态的会话，仍然可以增加session来在服务器端保存一些状态</p>
<p>​        Token就是令牌，比如你授权（登录）一个程序时，他就是个依据，判断你是否已经授权该软件；cookie就是写在客户端的一个txt文件，里面包括你登录信息之类的，这样你下次在登录某个网站，就会自动调用cookie自动登录用户名；session和cookie差不多，只是Session是写在服务器端的文件，也需要在客户端写入cookie文件，但是文件里是你的浏览器编号。Session的状态是存储在服务器端，客户端只有Session id；而Token的状态是存储在客户端。</p>
<h2 id><a href="#" class="headerlink" title></a></h2><h1 id="6-自己的秒杀项目"><a href="#6-自己的秒杀项目" class="headerlink" title="6.自己的秒杀项目"></a>6.自己的秒杀项目</h1><p><img src="/../img/image-20210824102942986.png" alt="image-20210824102942986"></p>
<p>首先通过uuid生成一个随机sessionid，存到redis和cookie中</p>
<p><img src="/../img/image-20210824103051506.png" alt="image-20210824103051506"></p>
<p>以后的请求，会得到cookie中名字为token的sessionid，在通过方法getUserForToken判断redis中是否有次数据</p>
<p><img src="/../img/image-20210824103150109.png" alt="image-20210824103150109"></p>
<p>redis中存的key为token，value为user对象，不为空重置时间</p>
<h1 id="token项目中"><a href="#token项目中" class="headerlink" title="token项目中"></a>token项目中</h1><p>1.登录方法uuid生成唯一token保存在redis，并普通json发送给客户端</p>
<p>2.客户端接受保存到浏览器本地，可能是localStorage，每次请求前端设置请求头里</p>
<p>3.后端接受请求，通过过滤器判断请求头中的token与本地redis中token是否一致，一致放行，不一致返回错误信息，比如404,</p>
<p>4.前端接受，如果是404，跳转到登录页面，重新发送登录方法</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>cookie-session-token</tag>
      </tags>
  </entry>
  <entry>
    <title>FTP搭建</title>
    <url>/2021/11/30/FTP,SFTP%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h1 id="一-基本配置"><a href="#一-基本配置" class="headerlink" title="一.基本配置"></a>一.基本配置</h1><p>当yum不好使时候使用离线包：<a href="http://rpmfind.net/linux/rpm2html/search.php?query=vsftpd(x86-64)&amp;submit=Search+...&amp;system=&amp;arch=">http://rpmfind.net/linux/rpm2html/search.php?query=vsftpd%28x86-64%29&amp;submit=Search+...&amp;system=&amp;arch=</a></p>
<p>rpm -ivh vsftpd-3.0.2-28.el7.x86_64.rpm</p>
<h2 id="1-卸载"><a href="#1-卸载" class="headerlink" title="1.卸载"></a>1.卸载</h2><p>rpm -aq vsftpd</p>
<p>rpm –e 第一个命令的结果</p>
<p>rm -rf /etc/vsftpd/</p>
<h2 id="2-运行以下命令安装-vsftpd。"><a href="#2-运行以下命令安装-vsftpd。" class="headerlink" title="2.运行以下命令安装 vsftpd。"></a>2.运行以下命令安装 vsftpd。</h2><p>yum -y install ftp</p>
<p>yum install -y vsftpd</p>
<p>cd /etc/vsftpd<br>ls<br>说明：<br>/etc/vsftpd/vsftpd.conf 是核心配置文件。<br>/etc/vsftpd/ftpusers 是黑名单文件，此文件里的用户不允许访问 FTP 服务器。<br>/etc/vsftpd/user_list  是白名单文件，是允许访问 FTP 服务器的用户列表。<br>/etc/vsftpd/vsftpd_conf_migrate.sh  是vsftpd操作的一些变量和设置<br>备注：使用命令 rpm -ql vsftpd  可列出vsftpd中包含的文件</p>
<h2 id="3-运行以下命令设置开机自启动。"><a href="#3-运行以下命令设置开机自启动。" class="headerlink" title="3.运行以下命令设置开机自启动。"></a>3.运行以下命令设置开机自启动。</h2><p>systemctl enable vsftpd</p>
<h2 id="4-运行以下命令启动-FTP-服务。"><a href="#4-运行以下命令启动-FTP-服务。" class="headerlink" title="4.运行以下命令启动 FTP 服务。"></a>4.运行以下命令启动 FTP 服务。</h2><p>systemctl start vsftpd</p>
<h2 id="5-运行以下命令查看-FTP-服务端口。"><a href="#5-运行以下命令查看-FTP-服务端口。" class="headerlink" title="5.运行以下命令查看 FTP 服务端口。"></a>5.运行以下命令查看 FTP 服务端口。</h2><p>netstat -antup | grep ftp</p>
<h2 id="6-重启服务器"><a href="#6-重启服务器" class="headerlink" title="6.重启服务器"></a>6.重启服务器</h2><p>systemctl restart vsftpd</p>
<h1 id="二-FTP"><a href="#二-FTP" class="headerlink" title="二.FTP"></a>二.FTP</h1><p>完成vsftpd安装后发现无法远程连接，仍需要完成以下配置。</p>
<p>原因分析：</p>
<p>FTP连接方式分为：主动模式和被动模式。默认为被动模式。</p>
<p>如果为被动模式，服务器端必须监听至少一个额外的被动模式端口。所以，若只开通20和21端口是不够的，需要另外配置入站端口。</p>
<p>FTP的连接一般是有两个连接的，一个是客户程和服务器传输命令的，另一个是数据传送的连接。FTP服务程序一般会支持两种不同的模式，一种是Port模式，一种是Passive模式(Pasv Mode),我先说说这两种不同模式连接方式的分别。<br>先假设客户端为C,服务端为S.<br>Port模式:<br>当客户端C向服务端S连接后，使用的是Port模式,那么客户端C会发送一条命令告诉服务端S(客户端C在本地打开了一个端口N在等着你进行数据连接),当服务端S收到这个Port命令后 就会向客户端打开的那个端口N进行连接，这种数据连接就生成了。<br>Pasv模式:</p>
<p>当客户端C向服务端S连接后，服务端S会发信息给客户端C,这个信息是(服务端S在本地打开了一个端口M,你现在去连接我吧),当客户端C收到这个信息后，就可以向服务端S的M端口进行连接,连接成功后，数据连接也建立了。</p>
<p>一个是数据端口，一个是控制端口，控制端口一般为21，而数据端口不一定是20，这和FTP的应用模式有关，如果是主动模式，应该为20，如果为被动模式，由服务器端和客户端协商而定</p>
<h2 id="当为被动模式时"><a href="#当为被动模式时" class="headerlink" title="当为被动模式时"></a>当为被动模式时</h2><p><em><strong>*修改配置文件 vim /etc/vsftpd/vsftpd.conf*</strong></em></p>
<p>在文件末尾添加：<br>pasv_enable=YES<br>pasv_min_port=8800<br>pasv_max_port=8899</p>
<p>解释：<br>8800/8899 为上面安全组添加的端口号<br>pasv_enable=YES|NO<br>YES，允许数据传输时使用PASV模式。NO，不允许使用PASV模式。默认值为YES。<br>pasv_min_port=port number<br>pasv_max_port=port number</p>
<p>设定在PASV模式下，建立数据传输所可以使用port范围的下界和上界，0 表示任意。默认值为0。把端口范围设在比较高的一段范围内，比如50000-60000，将有助于安全性的提高</p>
<p>重启服务器systemctl restart vsftpd</p>
<h2 id="如果报错"><a href="#如果报错" class="headerlink" title="如果报错"></a>如果报错</h2><p>500 OOPS: bad bool value in config file for: pasv_enable</p>
<p>说明配置文件有空格</p>
<h1 id="三-和SFTP区别"><a href="#三-和SFTP区别" class="headerlink" title="三.和SFTP区别"></a>三.和SFTP区别</h1><p>SFTP和FTP非常相似，都支持批量传输（一次传输多个文件），文件夹/目录导航，文件移动，文件夹/目录创建，文件删除等。但还是存在着差异，下面我们来看看SFTP和FTP之间的区别。</p>
<h2 id="1、安全通道"><a href="#1、安全通道" class="headerlink" title="1、安全通道"></a>1、安全通道</h2><p>FTP 不提供任何安全通道来在主机之间传输文件；而SFTP协议提供了一个安全通道，用于在网络上的主机之间传输文件。</p>
<h2 id="2、使用的协议"><a href="#2、使用的协议" class="headerlink" title="2、使用的协议"></a>2、使用的协议</h2><p>FTP使用TCP / IP协议。而，SFTP是SSH协议的一部分，它是一种远程登录信息。</p>
<h2 id="3、链接方式"><a href="#3、链接方式" class="headerlink" title="3、链接方式"></a>3、链接方式</h2><p>FTP使用TCP端口21上的控制连接建立连接。而，SFTP是在客户端和服务器之间通过SSH协议（TCP端口22）建立的安全连接来传输文件。</p>
<h2 id="4、安全性"><a href="#4、安全性" class="headerlink" title="4、安全性"></a>4、安全性</h2><p>FTP密码和数据以纯文本格式发送，大多数情况下是不加密的，安全性不高。而，SFTP会在发送之前加密数据，二进制的形式传递，是无法“按原样”阅读的，安全性较高。</p>
<h1 id="四-vsftpd修改默认端口"><a href="#四-vsftpd修改默认端口" class="headerlink" title="四.vsftpd修改默认端口"></a>四.vsftpd修改默认端口</h1><p>1、编辑/etc/vsftpd/vsftpd.conf 文件，在该配置文件末尾添加此行：listen_port=6709</p>
<p>2、编辑/etc/services 文件，将其中的<br>ftp 21/tcp  改为 ftp 6709/tcp ,<br>ftp 21/udp  改为 ftp 6709/udp</p>
<p>3、重新启动vsftpd 服务。<br>4、运行命令 netstat -tnulp | grep vsftpd<br>可以查看到现在系统现监听的vsftpd 的端口为6709</p>
<p>5、最后不要忘记到阿里云安全组添加6709端口号</p>
<h1 id="五-步骤"><a href="#五-步骤" class="headerlink" title="五.步骤"></a>五.步骤</h1><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="##创建用户"></a>##创建用户</h2><p>使用useradd命令:<br>useradd username ,默认在/home文件夹下创建一个和username一样名称的文件作为该用户所拥有的文件</p>
<p>useradd ftpuser<br>passwd ftpuser  #(回车)给用户ftpuser  设置登录密码</p>
<p>(删除用户命令 userdel -r ftptest)</p>
<p>**tail:**默认显示指定文件的末尾10行</p>
<p>tail /etc/passwd<br><img src="/../img/image-20220218141405444.png" alt="image-20220218141405444"></p>
<h1 id="六-vim-etc-vsftpd-vsftpd-conf"><a href="#六-vim-etc-vsftpd-vsftpd-conf" class="headerlink" title="六.vim /etc/vsftpd/vsftpd.conf"></a>六.vim /etc/vsftpd/vsftpd.conf</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 如不允许匿名访问则设置为NO</span><br><span class="line">anonymous_enable=NO</span><br><span class="line"># 是否允许匿名用户上传文件，须将全局的write_enable=YES。默认为YES</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line"># 是否允许匿名用户创建新文件夹</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">#控制匿名用户对文件和文件夹的删除和创建</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line">#是否允许本地用户登录，比如root等，yes允许，no不允许</span><br><span class="line">local_enable=YES</span><br><span class="line">#当用本地用户登录时，会默认转到目录root用户到/root目录</span><br><span class="line">local_root=/home/ftpuser</span><br><span class="line">#本地用户上传文件权限</span><br><span class="line">local_umask=022</span><br><span class="line">#匿名用户上传文件权限</span><br><span class="line">anon_umask=022</span><br><span class="line">#允许写入操作，否则不能上传文件</span><br><span class="line">write_enable=YES</span><br><span class="line"></span><br><span class="line">#ftp工具连接成功提示</span><br><span class="line">ftpd_banner=Welcome to blah FTP service</span><br><span class="line">#所有用户均不能切换到上级目录，只能在自己的主目录</span><br><span class="line">chroot_local_user=Yes</span><br><span class="line">#是否启用限制用户的名单</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">#此列表内的用户可以访问所有路径，上一步需要为YES，配合使用</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list  </span><br><span class="line">#/etc/vsftpd/user_list不生效</span><br><span class="line">userlist_enable=NO</span><br><span class="line">#当上一步为YES，下面为YES，user_list用户不能登录，下面为NO，只有下面用户可以登录</span><br><span class="line">userlist_deny=NO</span><br><span class="line">#白名单，允许访问FTP的用户</span><br><span class="line">userlist_file=/etc/vsftpd/user_list</span><br><span class="line">#坑，添加了配置才能上传文件</span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line">#匿名用户的家目录,注意不要设置为/home/ftpuser</span><br><span class="line">anon_root=/usr/local/ftpdir</span><br><span class="line">#匿名用户不需要密码</span><br><span class="line">no_anon_password=YES</span><br><span class="line">#匿名登录后的使用者</span><br><span class="line">ftp_username=ftpuser</span><br><span class="line"></span><br><span class="line">#如果有以下一行，需要注释掉ip postgresql，没有不用管</span><br><span class="line">#公网ip postgresql</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220218154256536.png" alt="image-20220218154256536"></p>
<p><img src="/../img/image-20220309110528138.png" alt="image-20220309110528138"></p>
<h1 id="七"><a href="#七" class="headerlink" title="七."></a>七.</h1><p>有的服务器默认安装了pure-ftpd</p>
<p>先netstat -anp | grep 22看看是否被占用</p>
<h1 id="八-用户登录"><a href="#八-用户登录" class="headerlink" title="八.用户登录"></a>八.用户登录</h1><h2 id="如果提示500-OOPS-cannot-change-directory-home-ftpuser"><a href="#如果提示500-OOPS-cannot-change-directory-home-ftpuser" class="headerlink" title="如果提示500 OOPS: cannot change directory:/home/ftpuser"></a>如果提示500 OOPS: cannot change directory:/home/ftpuser</h2><p>getsebool -a|grep ftp</p>
<p>setsebool allow_ftpd_full_access  1<br>setsebool allow_ftpd_use_cifs 1<br>setsebool allow_ftpd_use_nfs 1<br>setsebool tftp_home_dir  1<br>setsebool httpd_enable_ftp_server 1<br>setsebool tftp_anon_write 1</p>
<p>systemctl restart vsftpd</p>
<h2 id="SELinux-is-disabled"><a href="#SELinux-is-disabled" class="headerlink" title="SELinux is disabled"></a>SELinux is disabled</h2><p>vi /etc/selinux/config</p>
<p>SELINUX=enabled</p>
<p><img src="/../img/image-20220309111722025.png" alt="image-20220309111722025"></p>
<p>解决办法：<br>修改config文件后，需要重启实例，但直接重启实例将会出现系统无法启动的错误。因此在重启之前需要在根目录下新建autorelabel文件。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">touch /.autorelabel</span><br><span class="line"></span><br><span class="line">shutdown <span class="literal">-r</span> now</span><br></pre></td></tr></table></figure>

<p>getsebool -a|grep ftp</p>
<p>setsebool allow_ftpd_full_access  1<br>setsebool allow_ftpd_use_cifs 1<br>setsebool allow_ftpd_use_nfs 1<br>setsebool tftp_home_dir  1<br>setsebool httpd_enable_ftp_server 1<br>setsebool tftp_anon_write 1</p>
<p>systemctl restart vsftpd</p>
<p><img src="/../img/image-20220309135813871.png" alt="image-20220309135813871"></p>
<p><img src="/../img/image-20220309135830288.png" alt="image-20220309135830288"></p>
<h1 id="九-权限问题"><a href="#九-权限问题" class="headerlink" title="九.权限问题"></a>九.权限问题</h1><p>给家目录下的文件夹chmod 777 ？就可以创建文件夹了</p>
<p>chmod -R 777 /自己的目录</p>
<h1 id="十-ftp-nginx配置"><a href="#十-ftp-nginx配置" class="headerlink" title="十.ftp-nginx配置"></a>十.ftp-nginx配置</h1><p>当想要上传图片以后，前端项目直接就可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">            listen       32013;</span><br><span class="line">            location / &#123;</span><br><span class="line">            #告警图片存放路径</span><br><span class="line">            root  /home/ftp/edgecomp/alarm/;</span><br><span class="line">            index index.html;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h1 id="十一-FTPwindos"><a href="#十一-FTPwindos" class="headerlink" title="十一.FTPwindos"></a>十一.FTPwindos</h1><p>程序，搜索启用或关闭windows功能</p>
<p><img src="/../img/wps3-1648197042914.jpg" alt="img"> </p>
<p>新建D://ftpuser文件夹</p>
<p>查看中转机器IP地址</p>
<p>开始菜单搜索“IIS”并点击进入IIS管理器</p>
<p><img src="/../img/wps4-1648197042914.jpg" alt="img"> </p>
<p><img src="/../img/wps5-1648197042914.jpg" alt="img"> </p>
<p>右键，添加FTP站点，站点名称ftpuser，物理路径D://ftpuser</p>
<p>ip地址本机</p>
<p><img src="/../img/wps6-1648197042913.jpg" alt="img"> </p>
<p><img src="/../img/wps7-1648197042914.jpg" alt="img"></p>
<p>新建ftpsuer用户</p>
<p><img src="/../img/wps8-1648197042914.jpg" alt="img"> </p>
<p><img src="/../img/wps9.jpg" alt="img"></p>
<h1 id="12-SFTP-linux"><a href="#12-SFTP-linux" class="headerlink" title="12. *SFTP-linux*"></a><strong>12.</strong> <em><strong>*SFTP-linux*</strong></em></h1><p>/etc/init.d/sshd start 开启</p>
<p>/etc/init.d/sshd stop  停止</p>
<p>groupadd sftpgroup // 创建sftp组</p>
<p>useradd -g sftpgroup -M -s /sbin/nologin sftpuser </p>
<p>//-M 表示创建用户时不生成对应home目录，-s /sbin/nologin 表示sftp用户不能登录系统</p>
<p>passwd sftpuser // 修改sftp用户密码，也为sftpuser</p>
<p>修改配置文件sshd_config</p>
<p>vi /etc/ssh/sshd_config</p>
<p>修改如下：</p>
<p>将下面这行注释掉</p>
<p>#Subsystem sftp /usr/libexec/openssh/sftp-server</p>
<p>## 在文件末尾添加如下几行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Subsystem sftp internal-sftp</span><br><span class="line"></span><br><span class="line">Match Group sftpgroup</span><br><span class="line"></span><br><span class="line">X11Forwarding no</span><br><span class="line"></span><br><span class="line">AllowTcpForwarding no</span><br><span class="line"></span><br><span class="line">ChrootDirectory %h</span><br><span class="line"></span><br><span class="line">ForceCommand internal-sftp</span><br></pre></td></tr></table></figure>

<p>创建用户目录</p>
<p>mkdir -p /sftp/sftpuser //-p 表示parents，即递归创建目录</p>
<p>usermod -d /sftp/sftpuser sftpuser // -d 表示修改用户home目录</p>
<p>// 设置Chroot目录权限</p>
<p>chown root:sftpgroup /sftp/sftpuser</p>
<p>chmod 755 /sftp/sftpuser</p>
<p>// 设置sftp用户可以操作的目录</p>
<p>mkdir /sftp/sftpuser/upload</p>
<p>chown sftpuser:sftpgroup /sftp/sftpuser/upload</p>
<p>chmod 755 /sftp/sftpuser/upload</p>
<p> //sftpuser可操作的目录为</p>
<p>重启服务</p>
<p>systemctl restart sshd.service</p>
<p>//测试</p>
<p> sftp <a href="mailto:&#x73;&#x66;&#x74;&#112;&#x75;&#x73;&#x65;&#114;&#x40;&#x31;&#x32;&#55;&#46;&#x30;&#46;&#48;&#x2e;&#49;">&#x73;&#x66;&#x74;&#112;&#x75;&#x73;&#x65;&#114;&#x40;&#x31;&#x32;&#55;&#46;&#x30;&#46;&#48;&#x2e;&#49;</a></p>
<h1 id="13-SFTP-windows-，用户名密码sftpuser"><a href="#13-SFTP-windows-，用户名密码sftpuser" class="headerlink" title="13. ****SFTP-windows****，用户名密码sftpuser"></a><strong>13.</strong> ****SFTP-windows****，用户名密码sftpuser</h1><p><img src="/../img/wps10.jpg" alt="img"> </p>
<p><img src="/../img/wps11.jpg" alt="img"> </p>
<p>安装freeSSHd.exe</p>
<p>安装以后，先结束进程</p>
<p><img src="/../img/wps12.jpg" alt="img"> </p>
<p>配置</p>
<p>3.1 配置sftp用户和密码</p>
<p>点击Users选项卡，设置sftp用户名和密码，Authorization选项选择Passwordstored as SHA1 hash，User can use选择SFTP。</p>
<p><img src="/../img/wps13.jpg" alt="img"> </p>
<p>3.2 设置SSH监听地址</p>
<p>点击SSH选项卡，在ListenAddress处选择监听地址，作为外部通过sftp用户连接使用的IP地址。</p>
<p><img src="/../img/wps14.jpg" alt="img"> </p>
<p>3.3 设置Password authentication</p>
<p>点击Authentication选项卡，设置Password authentication为Required。</p>
<p><img src="/../img/wps15.jpg" alt="img"> </p>
<p>3.4 设置SFTP主目录</p>
<p>选择SFTP选项卡，自选sftp目录，以E:\sftp为例。</p>
<p><img src="/../img/wps16.jpg" alt="img"> </p>
<p>我们新建D://ftpuser</p>
<p>右键D://ftpuser属性，取消只读</p>
<p><img src="/../img/wps17.jpg" alt="img"> </p>
<p><img src="/../img/wps18.jpg" alt="img"> </p>
<p><img src="/../img/wps19.jpg" alt="img"></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>FTP搭建</tag>
      </tags>
  </entry>
  <entry>
    <title>docker</title>
    <url>/2021/11/30/docker/</url>
    <content><![CDATA[<p> <a href="........%5CDocker%5C40%E3%80%81%E7%8B%82%E7%A5%9E%E8%AF%B4Docker.pdf">40、狂神说Docker.pdf</a> </p>
<h2 id="4-安装docker"><a href="#4-安装docker" class="headerlink" title="4.安装docker"></a>4.安装docker</h2><p><a href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p>
<h3 id="1-卸载原来的版本"><a href="#1-卸载原来的版本" class="headerlink" title="1.卸载原来的版本"></a>1.卸载原来的版本</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>

<p>设置开机自启</p>
<p>sudo systemctl enable docker</p>
<p>配置阿里云镜像加速</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211018175932703.png" alt="image-20211018175932703"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">依次粘贴运行</span><br><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://llk223hu.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="2-docker安装mysql"><a href="#2-docker安装mysql" class="headerlink" title="2.docker安装mysql"></a>2.docker安装mysql</h3><p>sudo docker pull mysql:5.7</p>
<p>切换root用户</p>
<p>注意\前有空格，-d后台运行</p>
<p>run是启动一个容器，容器与容器互相隔离</p>
<p>-v 前面是虚拟机地址，：后面是容器地址  地址映射</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run -p 3306:3306 --name mysql \</span><br><span class="line">-v /mydata/mysql/log:/var/log/mysql \</span><br><span class="line">-v /mydata/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /mydata/mysql/conf:/etc/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-d mysql:5.7</span><br></pre></td></tr></table></figure>

<p>docker ps 查看运行的容器</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211018190050273.png" alt="image-20211018190050273"></p>
<p>进入容器命令</p>
<p>docker exec -it mysql /bin/bash</p>
<p>查看目录结构</p>
<p>ls -a</p>
<p>查看跟mysql相关的文件在哪</p>
<p>whereis mysql</p>
<p>exit退出容器</p>
<h4 id="mysql配置"><a href="#mysql配置" class="headerlink" title="mysql配置"></a>mysql配置</h4><p>退出容器</p>
<p>cd /mydata/mysql/conf</p>
<p>vi my.cnf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[client]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">init_connect=&#x27;SET collation_connection=utf8_unicode_ci&#x27;</span><br><span class="line">init_connect=&#x27;SET NAMES utf8&#x27;</span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211018191351060.png" alt="image-20211018191351060"></p>
<p>重启mysql</p>
<p>docker restart mysql</p>
<h3 id="3-docker安装redis"><a href="#3-docker安装redis" class="headerlink" title="3.docker安装redis"></a>3.docker安装redis</h3><h4 id="1-下载"><a href="#1-下载" class="headerlink" title="1.下载"></a>1.下载</h4><p>最新redis</p>
<p>docker pull redis</p>
<h4 id="2-创建实例并启动"><a href="#2-创建实例并启动" class="headerlink" title="2.创建实例并启动"></a>2.创建实例并启动</h4><p>mkdir -p /mydata/redis/conf</p>
<p>touch /mydata/redis/conf/redis.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run -p 6379:6379 --name redis \</span><br><span class="line">-v /mydata/redis/data:/data \</span><br><span class="line">-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d redis redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">redis-server /etc/redis/redis.conf意思是，redis启动以容器内的/etc/redis/redis.conf这个配置文件启动</span><br></pre></td></tr></table></figure>

<h4 id="3-使用redis镜像执行redis-cli命令连接"><a href="#3-使用redis镜像执行redis-cli命令连接" class="headerlink" title="3.使用redis镜像执行redis-cli命令连接"></a>3.使用redis镜像执行redis-cli命令连接</h4><p>docker exec -it redis redis-cli</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211018192313612.png" alt="image-20211018192313612"></p>
<p>默认redis是在内存中，无法持久化的,需要配置</p>
<p>exit退出redis</p>
<p>cd /mydata/redis/conf</p>
<p>vi redis.conf</p>
<p>i</p>
<p>appendonly yes</p>
<p>esc</p>
<p>:wq</p>
<p>docker restart redis</p>
<h4 id="4-redis-conf可以配置的地方"><a href="#4-redis-conf可以配置的地方" class="headerlink" title="4.redis.conf可以配置的地方"></a>4.redis.conf可以配置的地方</h4><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211018193024647.png" alt="image-20211018193024647"></p>
<h4 id="5-docker里的容器自启动"><a href="#5-docker里的容器自启动" class="headerlink" title="5.docker里的容器自启动"></a>5.docker里的容器自启动</h4><p>docker update redis –restart=always</p>
<p>docker update mysql –restart=always</p>
<h4 id="6-相关"><a href="#6-相关" class="headerlink" title="6.相关"></a>6.相关</h4><p>linux环境部署的pdf下，使用命令之前都可以</p>
<p>mkdir -p /root/docker/redis/data</p>
<p> mkdir -p /root/docker/redis/conf</p>
<p><img src="/../hexo%E5%8D%9A%E5%AE%A2/blog/source/img/image-20210825180148791.png" alt="image-20210825180148791"></p>
<p>touch redis.conf</p>
<p><em>#bind 127.0.0.1 //允许远程连接</em> </p>
<p>protected-mode no</p>
<p>appendonly yes</p>
<p>docker run -p 6379:6379 –name redis -v /root/docker/redis/data:/data -v /root/docker/redis/conf/redis.conf:/etc/redis/redis.conf -d redis:5 redis-server /etc/redis/redis.conf</p>
<p>docker exec -it redis redis-cli  进入容器</p>
<p><img src="/../hexo%E5%8D%9A%E5%AE%A2/blog/source/img/image-20210825160522906.png" alt="image-20210825160522906"></p>
<p>容器内查看ip</p>
<p>cat /etc/hosts</p>
<p>设置密码</p>
<p><img src="/../hexo%E5%8D%9A%E5%AE%A2/blog/source/img/image-20210825175943607.png" alt="image-20210825175943607"></p>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>excel操作</title>
    <url>/2021/11/30/excel%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<h1 id="1-根据一定规则，截取前一列，生成新列"><a href="#1-根据一定规则，截取前一列，生成新列" class="headerlink" title="1.根据一定规则，截取前一列，生成新列"></a>1.根据一定规则，截取前一列，生成新列</h1><p>比如I列如下，J列想要I列额汉字，ctrl+c复制杭宁到J2列，在ctrl+E即可</p>
<p><img src="/../img/image-20211130212335916.png" alt="image-20211130212335916"></p>
<h1 id="2-筛选"><a href="#2-筛选" class="headerlink" title="2.筛选"></a>2.筛选</h1><p><img src="/../img/image-20211130212345388.png" alt="image-20211130212345388"></p>
<h1 id="3-去重复"><a href="#3-去重复" class="headerlink" title="3.去重复"></a>3.去重复</h1><p>把要去重的列单独复制到新sheet，点击第一行，然后去重</p>
<p><img src="/../img/image-20211130212354849.png" alt="image-20211130212354849"></p>
<h1 id="4-快速复制"><a href="#4-快速复制" class="headerlink" title="4.快速复制"></a>4.快速复制</h1><p><img src="/../img/image-20211130212400995.png" alt="image-20211130212400995"></p>
<p>复制两个竖格一样的，选中两格在下面格子双击右下角</p>
<h1 id="5-复制or序列递增"><a href="#5-复制or序列递增" class="headerlink" title="5.复制or序列递增"></a>5.复制or序列递增</h1><p>序列方式（0,1,2,3这样自动增加），也可以直接复制</p>
<p>双击右下角</p>
<p><img src="/../img/image-20211130212407585.png" alt="image-20211130212407585"></p>
<p>选择填充方式</p>
<p><img src="/../img/image-20211130212416233.png" alt="image-20211130212416233"></p>
<h1 id="6-粘贴内容转置"><a href="#6-粘贴内容转置" class="headerlink" title="6.粘贴内容转置"></a>6.粘贴内容转置</h1><p>先复制，右键选择性粘贴，粘贴内容转置</p>
<p><img src="/../img/image-20211130212420340.png" alt="image-20211130212420340"></p>
<p><img src="/../img/image-20211130212426558.png" alt="image-20211130212426558"></p>
<h1 id="7-清空内容"><a href="#7-清空内容" class="headerlink" title="7.清空内容"></a>7.清空内容</h1><p>右键清除内容</p>
<p><img src="/../img/image-20211130212439038.png" alt="image-20211130212439038"></p>
<h1 id="8-删除指定空行"><a href="#8-删除指定空行" class="headerlink" title="8.删除指定空行"></a>8.删除指定空行</h1><p>选中区域，ctrl+g，选择空值-定位，右键删除即可</p>
<h1 id="9-级联设置"><a href="#9-级联设置" class="headerlink" title="9.级联设置"></a>9.级联设置</h1><p>首行字段，手动添加</p>
<p><img src="/../img/image-20220307140153585.png" alt="image-20220307140153585"></p>
<h2 id="1-设置市的下拉（来源，非手动）"><a href="#1-设置市的下拉（来源，非手动）" class="headerlink" title="1.设置市的下拉（来源，非手动）"></a>1.设置市的下拉（来源，非手动）</h2><p>新建sheet页，以竖行的形式写市</p>
<p><img src="/../img/image-20220307140231146.png" alt="image-20220307140231146"></p>
<p>点击A列，在ctrl一下A1，即可取消第一行的选中</p>
<p><img src="/../img/image-20220307140344688.png" alt="image-20220307140344688"></p>
<p><img src="/../img/image-20220307140413390.png" alt="image-20220307140413390"></p>
<p>再次状态下，数据，有效性，选择序列，点击来源右侧</p>
<p><img src="/../img/image-20220307140437060.png" alt="image-20220307140437060"></p>
<p>再点击sheet2页，选中确定即可</p>
<p><img src="/../img/image-20220307140543169.png" alt="image-20220307140543169"></p>
<p>返回sheet1看效果，成功</p>
<p><img src="/../img/image-20220307140611596.png" alt="image-20220307140611596"></p>
<h2 id="2-设置市的下拉（手动）"><a href="#2-设置市的下拉（手动）" class="headerlink" title="2.设置市的下拉（手动）"></a>2.设置市的下拉（手动）</h2><p><img src="/../img/image-20220307140812670.png" alt="image-20220307140812670"></p>
<p><img src="/../img/image-20220307140819349.png" alt="image-20220307140819349"></p>
<p>也可以，以逗号的形式写入，注意最后没有逗号</p>
<p><img src="/../img/image-20220307140913802.png" alt="image-20220307140913802"></p>
<h2 id="3-设置二级级联"><a href="#3-设置二级级联" class="headerlink" title="3.设置二级级联"></a>3.设置二级级联</h2><p>在sheet2中，随意位置的第一行是第一列的下拉数据，往下的级联数据</p>
<p><img src="/../img/image-20220307141007644.png" alt="image-20220307141007644"></p>
<p>选中区域，公式，指定，首行，确定</p>
<p><img src="/../img/image-20220307141101693.png" alt="image-20220307141101693"></p>
<p>一直确定，查看名称管理器就有了3个</p>
<p><img src="/../img/image-20220307141138097.png" alt="image-20220307141138097"></p>
<p>选中B列去除第一行，来源写=INDIRECT($A2)，确定即可</p>
<p><img src="/../img/image-20220307141254661.png" alt="image-20220307141254661"></p>
<p>看效果</p>
<p><img src="/../img/image-20220307141408123.png" alt="image-20220307141408123"></p>
<p><img src="/../img/image-20220307141417300.png" alt="image-20220307141417300"></p>
<h2 id="4-三级级联"><a href="#4-三级级联" class="headerlink" title="4.三级级联"></a>4.三级级联</h2><p>=INDIRECT($B2)</p>
<p><img src="/../img/image-20220307141538434.png" alt="image-20220307141538434"></p>
<p><img src="/../img/image-20220307141547813.png" alt="image-20220307141547813"></p>
<p><img src="/../img/image-20220307141619468.png" alt="image-20220307141619468"></p>
<p>效果</p>
<p><img src="/../img/image-20220307142950134.png" alt="image-20220307142950134"></p>
<p><img src="/../img/image-20220307142958990.png" alt="image-20220307142958990"></p>
<h2 id="5-错误注意"><a href="#5-错误注意" class="headerlink" title="5.错误注意"></a>5.错误注意</h2><p>演示的时候，b1，b2等自动创建名称时默认加上_了，所以实际情况不要以数字结尾</p>
<p>修改</p>
<p><img src="/../img/image-20220307142853163.png" alt="image-20220307142853163"></p>
]]></content>
      <categories>
        <category>excel</category>
      </categories>
      <tags>
        <tag>excel</tag>
      </tags>
  </entry>
  <entry>
    <title>git</title>
    <url>/2021/11/30/git/</url>
    <content><![CDATA[<h1 id="GIT"><a href="#GIT" class="headerlink" title="GIT"></a>GIT</h1><p><img src="/../img/image-20211126144703898.png" alt="image-20211126144703898"></p>
<h2 id="版本控制工具"><a href="#版本控制工具" class="headerlink" title="版本控制工具"></a>版本控制工具</h2><h3 id="集中式版本控制"><a href="#集中式版本控制" class="headerlink" title="集中式版本控制"></a>集中式版本控制</h3><p>SVN（subversion）</p>
<img src="https://img2018.cnblogs.com/blog/1460324/201902/1460324-20190218103211790-549550561.png" alt="img" style="zoom:50%;">

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">集中式代码管理的核心是服务器，所有开发者在开始新一天的工作之前必须从服务器获取代码，然后开发，最后解决冲突，提交。所有的版本信息都放在服务器上。如果脱离了服务器，开发者基本上可以说是无法工作的。下面举例说明：</span><br><span class="line">开始新一天的工作：</span><br><span class="line">1、从服务器下载项目组最新代码。</span><br><span class="line">2、进入自己的分支，进行工作，每隔一个小时向服务器自己的分支提交一次代码（很多人都有这个习惯。因为有时候自己对代码改来改去，最后又想还原到前一个小时的版本，或者看看前一个小时自己修改了哪些代码，就需要这样做了）。</span><br><span class="line">3、下班时间快到了，把自己的分支合并到服务器主分支上，一天的工作完成，并反映给服务器。</span><br><span class="line"></span><br><span class="line">缺点:如果中央服务器故障一小时，那么所有人都无法提交了</span><br></pre></td></tr></table></figure>

<h3 id="分布式版本控制"><a href="#分布式版本控制" class="headerlink" title="分布式版本控制"></a>分布式版本控制</h3><p>git</p>
<p><img src="/../img/image-20211201092810923.png" alt="image-20211201092810923"></p>
<p>每台个人电脑就是一个本地库，在自己电脑做版本控制</p>
<h3 id="就是说svb不能在本地进行版本控制，而git可以"><a href="#就是说svb不能在本地进行版本控制，而git可以" class="headerlink" title="就是说svb不能在本地进行版本控制，而git可以"></a>就是说svb不能在本地进行版本控制，而git可以</h3><h2 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h2><p><img src="/../img/image-20211201111651132.png" alt="image-20211201111651132"> </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">工作区：代码存放的磁盘的目录的位置</span><br><span class="line">暂存区：需要让git追踪（知道）有这样一个代码需要进行版本控制，把工作区的代码添加到暂存区</span><br><span class="line">	   临时存储，是可以删掉的（一个命令），还没有生成历史版本</span><br><span class="line">本地库：暂存区，提交本地库，一旦提交了，就会生成对应的历史版本，一旦生成历史版本，代码就删不掉了</span><br><span class="line">	   除非删除代码，重新拉取</span><br></pre></td></tr></table></figure>

<h2 id="托管中心"><a href="#托管中心" class="headerlink" title="托管中心"></a>托管中心</h2><h3 id="局域网"><a href="#局域网" class="headerlink" title="局域网"></a>局域网</h3><p>gitlab</p>
<h3 id="互联网"><a href="#互联网" class="headerlink" title="互联网"></a>互联网</h3><p>github</p>
<p>gitee</p>
<h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><p>file:///D:/git/%E5%B0%9A%E7%A1%85%E8%B0%B7%E6%8A%80%E6%9C%AF%E8%AF%BE%E7%A8%8B%E7%B3%BB%E5%88%97%E4%B9%8BGit%20V2.0.pdf</p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global user.name 用户名 设置用户签名</span><br><span class="line">git config --global user.email 邮箱 设置用户签名</span><br><span class="line">git init 初始化本地库</span><br><span class="line">git status 查看本地库状态</span><br><span class="line">git add 文件名 添加到暂存区</span><br><span class="line">git commit -m &quot;日志信息&quot; 文件名 提交到本地库</span><br><span class="line">git reflog 查看历史记录</span><br><span class="line">git reset --hard 版本号 版本穿梭</span><br></pre></td></tr></table></figure>

<h3 id="设置全局用户签名"><a href="#设置全局用户签名" class="headerlink" title="设置全局用户签名"></a>设置全局用户签名</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;用户名&quot;</span><br><span class="line">git config --global user.email &quot;邮箱&quot;</span><br></pre></td></tr></table></figure>

<p><strong>注意：这里设置用户签名和将来登录 GitHub（或其他代码托管中心）的账号没有任 何关系。仅代表是本地客户端的用户签名</strong></p>
<p>在路径C:\Users\Administrator.gitconfig文件内</p>
<p><img src="/../img/image-20211201133237841.png" alt="image-20211201133237841"></p>
<h3 id="查看全局用户签名"><a href="#查看全局用户签名" class="headerlink" title="查看全局用户签名"></a>查看全局用户签名</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config user.name</span><br><span class="line">git config user.email</span><br></pre></td></tr></table></figure>

<h3 id="这只局部用户签名，局部签名用来与平台公钥签名用的邮箱相匹配"><a href="#这只局部用户签名，局部签名用来与平台公钥签名用的邮箱相匹配" class="headerlink" title="这只局部用户签名，局部签名用来与平台公钥签名用的邮箱相匹配"></a>这只局部用户签名，局部签名用来与平台公钥签名用的邮箱相匹配</h3><p>如果你的公司邮箱，github，gitee邮箱都不一致，需要拉取项目后，使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config  user.name &quot;用户名&quot;</span><br><span class="line">git config  user.email &quot;邮箱&quot;</span><br></pre></td></tr></table></figure>

<p>设置成注册github或者gitee时的邮箱</p>
<h2 id="初始化本地库"><a href="#初始化本地库" class="headerlink" title="初始化本地库"></a>初始化本地库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure>

<p>告诉git，获取这个目录的管理权</p>
<h2 id="查看本地库状态"><a href="#查看本地库状态" class="headerlink" title="查看本地库状态"></a>查看本地库状态</h2><p>git status</p>
<p><img src="/../img/image-20211201134228268.png" alt="image-20211201134228268"></p>
<p>第一行：在master分支</p>
<p>第二行：没有提交过任何</p>
<p>第三行：没有任何可以提交，暂存区为空</p>
<h4 id="新建hello-txt文件再次"><a href="#新建hello-txt文件再次" class="headerlink" title="新建hello.txt文件再次"></a>新建hello.txt文件再次</h4><p>gitstatus</p>
<p><img src="/../img/image-20211201134906698.png" alt="image-20211201134906698"></p>
<p>第三行：发现一个未被追踪（add）的文件，存在于工作区，使用git add追踪</p>
<h2 id="添加暂存区"><a href="#添加暂存区" class="headerlink" title="添加暂存区"></a>添加暂存区</h2><p>git add 文件名</p>
<p><img src="/../img/image-20211201135957361.png" alt="image-20211201135957361"></p>
<p>这个警告是转换了行末换行符</p>
<p>用LF（linux） 替换 CRLF（windows）</p>
<h3 id="再一次git-status"><a href="#再一次git-status" class="headerlink" title="再一次git status"></a>再一次git status</h3><p><img src="/../img/image-20211201140152942.png" alt="image-20211201140152942"></p>
<p>git追踪到了这个hello.txt文件，目前在暂存区里</p>
<h3 id="如果想删除暂存区里的hello-txt文件"><a href="#如果想删除暂存区里的hello-txt文件" class="headerlink" title="如果想删除暂存区里的hello.txt文件"></a>如果想删除暂存区里的hello.txt文件</h3><p>git rm –cached hello.txt</p>
<p><img src="/../img/image-20211201140332382.png" alt="image-20211201140332382"></p>
<p>仅删除暂存区，工作区（磁盘上的没有删除）</p>
<h2 id="提交本地库"><a href="#提交本地库" class="headerlink" title="提交本地库"></a>提交本地库</h2><p>git commit -m “日志信息” 文件名</p>
<p><img src="/../img/image-20211201140632161.png" alt="image-20211201140632161"></p>
<h3 id="再一次查看状态"><a href="#再一次查看状态" class="headerlink" title="再一次查看状态"></a>再一次查看状态</h3><p>git status</p>
<p><img src="/../img/image-20211201140644875.png" alt="image-20211201140644875"></p>
<h2 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h2><p>git reflog</p>
<p><img src="/../img/image-20211201140813139.png" alt="image-20211201140813139"></p>
<p>git log更详细</p>
<p><img src="/../img/image-20211201140834667.png" alt="image-20211201140834667"></p>
<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><p>修改了hello.txt</p>
<p>再次git status</p>
<p><img src="/../img/image-20211201141219010.png" alt="image-20211201141219010"></p>
<p>这时需要再次追踪一下</p>
<p>git add hello.txt</p>
<p>在提交</p>
<p>git commit -m “second commit” hello.txt</p>
<h3 id="再次查看版本信息"><a href="#再次查看版本信息" class="headerlink" title="再次查看版本信息"></a>再次查看版本信息</h3><p>git reflog </p>
<p><img src="/../img/image-20211201141611951.png" alt="image-20211201141611951"></p>
<p>发现有两个版本，并且head指针指向第二个版本</p>
<h2 id="版本穿梭"><a href="#版本穿梭" class="headerlink" title="版本穿梭"></a>版本穿梭</h2><p>git reset –hard 版本号   不保存工作区内容</p>
<p><img src="/../img/image-20211201144449686.png" alt="image-20211201144449686"></p>
<p>穿越回第一次提交的版本</p>
<p>查看hello.txt发现第一行没有1234</p>
<h3 id="再次git-reflog"><a href="#再次git-reflog" class="headerlink" title="再次git reflog"></a>再次git reflog</h3><p><img src="/../img/image-20211201144538596.png" alt="image-20211201144538596"></p>
<p>发现指针指向了第一次提交的版本（第三行）</p>
<p>而第一行是日志，意思是指针指向了哪个版本号</p>
<h3 id="版本穿梭其他命令"><a href="#版本穿梭其他命令" class="headerlink" title="版本穿梭其他命令"></a>版本穿梭其他命令</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//仅仅只是撤销已提交的版本库和暂存区，不会修改工作区</span><br><span class="line">git reset --mixed 版本库ID</span><br><span class="line">//彻底将工作区、暂存区和版本库记录恢复到指定的版本库</span><br><span class="line">git reset --hard 版本库ID</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">（1）如果你是在提交了后，对工作区的代码做了修改，并且想保留这些修改，那么可以使用git reset --mixed 版本库ID，注意这个版本库ID应该不是你刚刚提交的版本库ID，而是刚刚提交版本库的上一个版本库。</span><br><span class="line"></span><br><span class="line">（2）如果不想保留这些修改，可以直接使用彻底的恢复命令，git reset --hard 版本库ID</span><br></pre></td></tr></table></figure>

<h1 id="首次推送"><a href="#首次推送" class="headerlink" title="首次推送"></a>首次推送</h1><h2 id="情况1：已经有仓库，还没开始写代码，这样直接从idea，clone仓库，然后开始写代码"><a href="#情况1：已经有仓库，还没开始写代码，这样直接从idea，clone仓库，然后开始写代码" class="headerlink" title="情况1：已经有仓库，还没开始写代码，这样直接从idea，clone仓库，然后开始写代码"></a>情况1：已经有仓库，还没开始写代码，这样直接从idea，clone仓库，然后开始写代码</h2><h2 id="情况2：已经写了代码了，仓库才创建（空仓库什么都没有）"><a href="#情况2：已经写了代码了，仓库才创建（空仓库什么都没有）" class="headerlink" title="情况2：已经写了代码了，仓库才创建（空仓库什么都没有）"></a>情况2：已经写了代码了，仓库才创建（空仓库什么都没有）</h2><p>在项目的根目录下打开gitbush</p>
<p>git局部配置<br>git config  use.name “git账号”<br>git config  user.email “email”</p>
<p>初始化仓库<br>git init</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">touch README.md</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line">git remote add origin https://gitee.com/jiang-jiaxu/websocket.git</span><br><span class="line">git push -u origin &quot;master&quot;</span><br></pre></td></tr></table></figure>

<p>然后正常写代码即可</p>
<p>#与远程仓库建立连接<br>git remote add origin “远程仓库地址”</p>
<p>#将本地仓库的文件推送到远程仓库<br>git push -u origin master</p>
<h1 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git branch 分支名 创建分支</span><br><span class="line">git branch -v 查看分支</span><br><span class="line">git checkout 分支名 切换分支</span><br><span class="line">git merge 分支名 把指定的分支合并到当前分支上</span><br></pre></td></tr></table></figure>

<h2 id="查看分支"><a href="#查看分支" class="headerlink" title="查看分支"></a>查看分支</h2><p>git branch -v</p>
<h2 id="创建分支"><a href="#创建分支" class="headerlink" title="创建分支"></a>创建分支</h2><p>git branch 分支名</p>
<h2 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h2><p>git checkout 分支名</p>
<h2 id="合并分支"><a href="#合并分支" class="headerlink" title="合并分支"></a>合并分支</h2><p>git merge 分支名</p>
<p>把指定分支合并到当前分支</p>
<h3 id="正常合并"><a href="#正常合并" class="headerlink" title="正常合并"></a>正常合并</h3><p>master分支</p>
<p><img src="/../img/image-20211201151626602.png" alt="image-20211201151626602"></p>
<p>新建了一个a分支，内容没变之前也为</p>
<p><img src="/../img/image-20211201151644224.png" alt="image-20211201151644224"></p>
<p>现在a分支改变内容为</p>
<p><img src="/../img/image-20211201151739563.png" alt="image-20211201151739563"></p>
<p>add，commit以后</p>
<p><img src="/../img/image-20211201151852805.png" alt="image-20211201151852805"></p>
<p>合并，注意要站在master合并a，就要先去master，发现可以合并</p>
<p>因为master分支没有改动，只改动了a分支是没问题的</p>
<p><img src="/../img/image-20211201151944461.png" alt="image-20211201151944461"></p>
<h3 id="异常合并"><a href="#异常合并" class="headerlink" title="异常合并"></a>异常合并</h3><p>两个分支在同一个文件的同一个位置有两套完全不同的修改</p>
<p>就需要a改动，master分支也改动了，此时有异常</p>
<p>现在改动master内容</p>
<p><img src="/../img/image-20211201152218626.png" alt="image-20211201152218626"></p>
<p>add，commit以后，切换a分支</p>
<p><img src="/../img/image-20211201152549163.png" alt="image-20211201152549163"></p>
<p>add，commit以后，切换master分支</p>
<p>自动合并失败了，在hello.txt里有冲突</p>
<p><img src="/../img/image-20211201152710721.png" alt="image-20211201152710721"></p>
<p><img src="/../img/image-20211201152925624.png" alt="image-20211201152925624"></p>
<p>&lt;&lt;&lt;和==之间是当前分支的代码</p>
<p>&gt;&gt;&gt;和==之前是要合并的代码</p>
<p>就要手动删除不要的代码和符号</p>
<p><img src="/../img/image-20211201153303861.png" alt="image-20211201153303861"></p>
<p>删除以后，还要add，commit（不能带文件名了）</p>
<p><img src="/../img/image-20211201153243165.png" alt="image-20211201153243165"></p>
<p>在查看文件，发现合并成功了</p>
<p><img src="/../img/image-20211201153317524.png" alt="image-20211201153317524"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.开发代码时，先pull拉取，开发完代码，commit了以后，在拉取一次，看有无冲突，没有冲突在push提交</span><br><span class="line">2.push页面的就是最后版本的版本代码，以及之前的版本日志信息</span><br></pre></td></tr></table></figure>

<h1 id="Idea"><a href="#Idea" class="headerlink" title="Idea"></a>Idea</h1><h2 id="撤销指定commit"><a href="#撤销指定commit" class="headerlink" title="撤销指定commit"></a>撤销指定commit</h2><p><img src="/../img/image-20211015110906139.png" alt="image-20211015110906139"></p>
<p><img src="/../img/image-20211015110919733.png" alt="image-20211015110919733"></p>
<p>可以看到本地commit里有一个a</p>
<p>在version control里找到log，找到刚才提交的a的上一个</p>
<p><img src="/../img/image-20211015111009766.png" alt="image-20211015111009766"></p>
<p><img src="/../img/image-20211015111700760.png" alt="image-20211015111700760"></p>
<p>右键a下一个11111可以看到版本号，第一个copy版本号</p>
<p><img src="/../img/image-20211015111801700.png" alt="image-20211015111801700"></p>
<p><img src="/../img/image-20211015111040231.png" alt="image-20211015111040231"></p>
<p>找到terminal控制台</p>
<p>输入git reset 版本号</p>
<p><img src="/../img/image-20211015111814112.png" alt="image-20211015111814112"></p>
<p>出现表示成功撤销commit</p>
<p><img src="/../img/image-20211015111912140.png" alt="image-20211015111912140"></p>
<p>此时push里发现commit为空</p>
<p><img src="/../img/image-20211015111931107.png" alt="image-20211015111931107"></p>
<h2 id="git回滚版本（使用第二个）"><a href="#git回滚版本（使用第二个）" class="headerlink" title="git回滚版本（使用第二个）"></a>git回滚版本（使用第二个）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">第一步：点击项目右键git-&gt;Show Histroy -&gt;选择需要回滚的版本，右键Copy Revision Number</span><br><span class="line">第二步：方法一：</span><br><span class="line">之后在TerMinal上输入命令git reset --hard XXXXX</span><br><span class="line">git push -f -u origin master.</span><br><span class="line">方法二：a.右击项目依次选中：git-&gt;Repository-&gt;Reset HEAD</span><br><span class="line">b. 选中Reset Type:Mixed, To Commit:08d537b4fdc74f880f572e948df9a1e87e2ea41f；然后点击Reset按钮</span><br><span class="line"></span><br><span class="line">方法一是会把回滚版本之后的全部抹杀掉，而方法二会重新设置一个版本号，不会把回滚版本之后的版本删除掉。</span><br><span class="line">团队合作的回滚版本最好是使用第二种方法</span><br></pre></td></tr></table></figure>



<p>回滚以后消失的commit版本，在回滚之前复制版本号，可以用同样方法回滚回来</p>
<h2 id="回滚版本与版本穿梭的区别"><a href="#回滚版本与版本穿梭的区别" class="headerlink" title="回滚版本与版本穿梭的区别"></a>回滚版本与版本穿梭的区别</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">版本穿梭，你没有commit的代码都会消失</span><br><span class="line"></span><br><span class="line">回滚版本，代码不会消失，可以重新commit</span><br></pre></td></tr></table></figure>



<h2 id="添加忽略自动add的文件"><a href="#添加忽略自动add的文件" class="headerlink" title="添加忽略自动add的文件"></a>添加忽略自动add的文件</h2><h3 id="第一种方法"><a href="#第一种方法" class="headerlink" title="第一种方法"></a>第一种方法</h3><p>setting==》editor==》file types</p>
<p><img src="/../img/image-20211201162537280.png" alt="image-20211201162537280"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.hprof;*.iml;*.pyc;*.pyo;*.rbc;*.yarb;*~;.DS_Store;.git;.hg;.idea;.svn;CVS;__pycache__;_svn;data;logs;transaction-logs;vssver.scc;vssver2.scc;</span><br></pre></td></tr></table></figure>

<p>这里idea会不显示这些文件，并且git不会自动add</p>
<h3 id="第二种（第一种第二种可以一起来）"><a href="#第二种（第一种第二种可以一起来）" class="headerlink" title="第二种（第一种第二种可以一起来）"></a>第二种（第一种第二种可以一起来）</h3><p>new 一个忽略文件</p>
<p><img src="/../img/image-20211201163051769.png" alt="image-20211201163051769"></p>
<p>选择java模板</p>
<p><img src="/../img/image-20211201163152562.png" alt="image-20211201163152562"></p>
<p>点击add</p>
<p><img src="/../img/image-20211201163209937.png" alt="image-20211201163209937"></p>
<p>取消忽略文件的add</p>
<p><img src="/../img/image-20211201162851800.png" alt="image-20211201162851800"></p>
<p>想忽略什么可以自己添加</p>
<p><img src="/../img/image-20211201163442740.png" alt="image-20211201163442740"></p>
<h2 id="取消其他文件的add"><a href="#取消其他文件的add" class="headerlink" title="取消其他文件的add"></a>取消其他文件的add</h2><p>同取消忽略文件的add</p>
<h1 id="gitlab"><a href="#gitlab" class="headerlink" title="gitlab"></a>gitlab</h1><p>私有github</p>
<p>yum -y install policycoreutils openssh-server openssh-clients postfix</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#防火墙关了就不用做</span><br><span class="line">systemctl enable sshd &amp;&amp; sudo systemctl start sshd</span><br><span class="line">systemctl enable postfix &amp;&amp; systemctl start postfix</span><br><span class="line">firewall-cmd --add-service=ssh --permanent</span><br></pre></td></tr></table></figure>

<h2 id="添加-GitLab-镜像源并安装"><a href="#添加-GitLab-镜像源并安装" class="headerlink" title="添加 GitLab 镜像源并安装"></a>添加 GitLab 镜像源并安装</h2><p>curl -sS <a href="https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh">https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh</a> | bash</p>
<p>yum install -y gitlab-ce</p>
<p>修改地址</p>
<p>vim /etc/gitlab/gitlab.rb<br>将external_url改为对应的地址和端口</p>
<p><img src="/../img/image-20220221164429188.png" alt="image-20220221164429188"></p>
<p>重载并启动</p>
<p>gitlab-ctl reconfigure</p>
<p>gitlab-ctl restart</p>
<h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h2><p>卸载<br>重新安装清理<br>1，卸载<br>[root@git Gitlab-cn]# gitlab-ctl uninstall<br>2，删除文件<br>[root@git Gitlab-cn]#rm -rf /etc/gitlab/* /var/log/gitlab/ /var/opt/gitlab/ /opt/gitlab/ </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">启动：gitlab-ctl start </span><br><span class="line"></span><br><span class="line">停止：gitlab-ctl stop </span><br><span class="line"></span><br><span class="line">重启：gitlab-ctl restart</span><br></pre></td></tr></table></figure>

<p>由于服务器只有2G，故没有安装</p>
<p><a href="https://blog.csdn.net/h8178/article/details/78501841?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164543182016780271513744%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164543182016780271513744&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-11-78501841.first_rank_v2_pc_rank_v29&amp;utm_term=gitlab+%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/h8178/article/details/78501841?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164543182016780271513744%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164543182016780271513744&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-11-78501841.first_rank_v2_pc_rank_v29&amp;utm_term=gitlab+%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98&amp;spm=1018.2226.3001.4187</a></p>
]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop</title>
    <url>/2021/11/30/hadoop/</url>
    <content><![CDATA[<h1 id="1-hadoop集群的概念"><a href="#1-hadoop集群的概念" class="headerlink" title="1.hadoop集群的概念"></a>1.hadoop集群的概念</h1><p><img src="/../img/image-20220228134945409.png" alt="image-20220228134945409"></p>
<p><img src="/../img/image-20220228135617209.png" alt="image-20220228135617209"></p>
<p><img src="/../img/image-20220228135711553.png" alt="image-20220228135711553"></p>
<h1 id="2-集群模式安装"><a href="#2-集群模式安装" class="headerlink" title="2.集群模式安装"></a>2.集群模式安装</h1><p>使用编译好的</p>
<p><img src="/../img/image-20220228140349160.png" alt="image-20220228140349160"></p>
<p>hadoop-3.3.0-Centos7-64-with-snappy.tar.gz</p>
<p><img src="/../img/image-20220228140333568.png" alt="image-20220228140333568"></p>
<h2 id="1-修改主机名（3台）"><a href="#1-修改主机名（3台）" class="headerlink" title="1.修改主机名（3台）"></a>1.修改主机名（3台）</h2><p>hostnamectl set-hostname node1.itcast.cn</p>
<p>hostnamectl set-hostname node2.itcast.cn</p>
<p>hostnamectl set-hostname node3.itcast.cn</p>
<h2 id="2-修改hos映射（3台）"><a href="#2-修改hos映射（3台）" class="headerlink" title="2.修改hos映射（3台）"></a>2.修改hos映射（3台）</h2><p>vim /etc/hosts</p>
<p>192.168.214.131 node1 node1.itcast.cn</p>
<p>192.168.214.132 node2 node2.itcast.cn</p>
<p>192.168.214.133 node3 node3.itcast.cn</p>
<h2 id="3-ssh免密登录"><a href="#3-ssh免密登录" class="headerlink" title="3.ssh免密登录"></a>3.ssh免密登录</h2><p>#node1生成公钥私钥 (一路回车)<br>    ssh-keygen  </p>
<pre><code>#在node1服务器上配置免密登录到node1 node2 node3
#输入yes，和root密码
ssh-copy-id node1
ssh-copy-id node2
ssh-copy-id node3
</code></pre>
<h2 id="4-时间同步（3台）"><a href="#4-时间同步（3台）" class="headerlink" title="4.时间同步（3台）"></a>4.时间同步（3台）</h2><p>yum -y install ntpdate</p>
<p>ntpdate ntp5.aliyun.com</p>
<h2 id="5-创建统一工作目录（3台机器）"><a href="#5-创建统一工作目录（3台机器）" class="headerlink" title="5.创建统一工作目录（3台机器）"></a>5.创建统一工作目录（3台机器）</h2><p>mkdir -p /export/server/ #软件安装路径 </p>
<p>mkdir -p /export/data/ #数据存储路径 </p>
<p>mkdir -p /export/software/ #安装包存放路径</p>
<h2 id="6-安装jdk（略过）"><a href="#6-安装jdk（略过）" class="headerlink" title="6.安装jdk（略过）"></a>6.安装jdk（略过）</h2><h2 id="7-上传Hadoop"><a href="#7-上传Hadoop" class="headerlink" title="7.上传Hadoop"></a>7.上传Hadoop</h2><p>安装包到node1 /export/server</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop-3.3.0-Centos7-64-with-snappy.tar.gz</span><br></pre></td></tr></table></figure>

<p>tar -zxvf hadoop-3.3.0-Centos7-64-with-snappy.tar.gz</p>
<p>rm -rf hadoop-3.3.0-Centos7-64-with-snappy.tar.gz</p>
<p><img src="/../img/image-20220228143244180.png" alt="image-20220228143244180"></p>
<h2 id="8-修改配置文件"><a href="#8-修改配置文件" class="headerlink" title="8.修改配置文件"></a>8.修改配置文件</h2><p><img src="/../img/image-20220228143355643.png" alt="image-20220228143355643"></p>
<h3 id="hadoop-env-sh"><a href="#hadoop-env-sh" class="headerlink" title="hadoop-env.sh"></a>hadoop-env.sh</h3><p>vim /export/server/hadoop-3.3.0/etc/hadoop/hadoop-env.sh</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#文件最后添加</span><br><span class="line">export JAVA_HOME=/usr/local/java/jdk1.8.0_131</span><br><span class="line"></span><br><span class="line">export HDFS_NAMENODE_USER=root</span><br><span class="line">export HDFS_DATANODE_USER=root</span><br><span class="line">export HDFS_SECONDARYNAMENODE_USER=root</span><br><span class="line">export YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">export YARN_NODEMANAGER_USER=root </span><br></pre></td></tr></table></figure>

<h3 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 设置默认使用的文件系统 Hadoop支持file、HDFS、GFS、ali|Amazon云等文件系统 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;hdfs://node1:8020&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 设置Hadoop本地保存数据路径 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/export/data/hadoop-3.3.0&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 设置HDFS web UI用户身份 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hadoop.http.staticuser.user&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;root&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 整合hive 用户代理设置 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hadoop.proxyuser.root.hosts&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hadoop.proxyuser.root.groups&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 文件系统垃圾桶保存时间 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.trash.interval&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;1440&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<h3 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 设置SNN进程运行机器位置信息 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;dfs.namenode.secondary.http-address&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;node2:9868&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<h3 id="mapred-site-xml"><a href="#mapred-site-xml" class="headerlink" title="mapred-site.xml"></a>mapred-site.xml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 设置MR程序默认运行模式： yarn集群模式 local本地模式 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- MR程序历史服务地址 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;node1:10020&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"> </span><br><span class="line">&lt;!-- MR程序历史服务器web端地址 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;node1:19888&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;yarn.app.mapreduce.am.env&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;HADOOP_MAPRED_HOME=$&#123;HADOOP_HOME&#125;&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.map.env&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;HADOOP_MAPRED_HOME=$&#123;HADOOP_HOME&#125;&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.reduce.env&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;HADOOP_MAPRED_HOME=$&#123;HADOOP_HOME&#125;&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<h3 id="yarn-site-xml"><a href="#yarn-site-xml" class="headerlink" title="yarn-site.xml"></a>yarn-site.xml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 设置YARN集群主角色运行机器位置 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">	&lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;</span><br><span class="line">	&lt;value&gt;node1&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;mapreduce_shuffle&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 是否将对容器实施物理内存限制 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;yarn.nodemanager.pmem-check-enabled&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;false&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 是否将对容器实施虚拟内存限制。 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;yarn.nodemanager.vmem-check-enabled&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;false&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 开启日志聚集 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;yarn.log-aggregation-enable&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 设置yarn历史服务器地址 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;yarn.log.server.url&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;http://node1:19888/jobhistory/logs&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 历史日志保存的时间 7天 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;yarn.log-aggregation.retain-seconds&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;604800&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<h3 id="workers"><a href="#workers" class="headerlink" title="workers"></a>workers</h3><p>删除localhost,添加</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node1.itcast.cn</span><br><span class="line">node2.itcast.cn</span><br><span class="line">node3.itcast.cn</span><br></pre></td></tr></table></figure>

<h2 id="9-分发同步hadoop安装包"><a href="#9-分发同步hadoop安装包" class="headerlink" title="9.分发同步hadoop安装包"></a>9.分发同步hadoop安装包</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /export/server</span><br><span class="line"></span><br><span class="line">scp -r hadoop-3.3.0 root@node2:$PWD</span><br><span class="line">scp -r hadoop-3.3.0 root@node3:$PWD</span><br></pre></td></tr></table></figure>

<h2 id="10-将hadoop添加到环境变量（3台机器）"><a href="#10-将hadoop添加到环境变量（3台机器）" class="headerlink" title="10.将hadoop添加到环境变量（3台机器）"></a>10.将hadoop添加到环境变量（3台机器）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">export HADOOP_HOME=/export/server/hadoop-3.3.0</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br><span class="line">source /etc/profile</span><br><span class="line">#别忘了scp给其他两台机器哦</span><br></pre></td></tr></table></figure>

<h2 id="11-格式化（初始化）nodename"><a href="#11-格式化（初始化）nodename" class="headerlink" title="11.格式化（初始化）nodename"></a>11.格式化（初始化）nodename</h2><p>只能执行1次，在首次启动集群之前，并且只能在一个机器上执行1次</p>
<p>hdfs namenode -format</p>
<p><img src="/../img/image-20220228145244297.png" alt="image-20220228145244297"></p>
<p>表示成功</p>
<h1 id="3-远程拷贝命令"><a href="#3-远程拷贝命令" class="headerlink" title="3.远程拷贝命令"></a>3.远程拷贝命令</h1><p>把export下的所有都拷贝到node2和node3的export下</p>
<p>scp -r /export/* root@node2:/export/</p>
<p>scp -r /export/* root@node3:/export/</p>
<h1 id="4-集群启动与关闭"><a href="#4-集群启动与关闭" class="headerlink" title="4.集群启动与关闭"></a>4.集群启动与关闭</h1><h2 id="1-手动逐个进程启停"><a href="#1-手动逐个进程启停" class="headerlink" title="1.手动逐个进程启停"></a>1.手动逐个进程启停</h2><p><img src="/../img/image-20220228145630915.png" alt="image-20220228145630915"></p>
<h2 id="2-脚本"><a href="#2-脚本" class="headerlink" title="2.脚本"></a>2.脚本</h2><p><img src="/../img/image-20220228145658134.png" alt="image-20220228145658134"></p>
<h2 id="3-验证是否正常"><a href="#3-验证是否正常" class="headerlink" title="3.验证是否正常"></a>3.验证是否正常<img src="/../img/image-20220228145933501.png" alt="image-20220228145933501"></h2><p>jps以后，每个机器应该显示如上图所示</p>
<h2 id="4-web-ui页面"><a href="#4-web-ui页面" class="headerlink" title="4.web-ui页面"></a>4.web-ui页面</h2><ul>
<li><h2 id="HDFS集群：http-node1-9870"><a href="#HDFS集群：http-node1-9870" class="headerlink" title="HDFS集群：http://node1:9870/"></a>HDFS集群：<a href="http://node1:9870/">http://node1:9870/</a></h2><p>主要浏览文件系统</p>
<p><img src="/../img/image-20220228150424399.png" alt="image-20220228150424399"></p>
</li>
<li><h2 id="YARN集群：http-node1-8088"><a href="#YARN集群：http-node1-8088" class="headerlink" title="YARN集群：http://node1:8088/"></a>YARN集群：<a href="http://node1:8088/">http://node1:8088/</a></h2></li>
</ul>
<h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><p>运行hadoop3官方自带mr示例出错。</p>
<ul>
<li><p>错误信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Error: Could not find or load main class org.apache.hadoop.mapreduce.v2.app.MRAppMaster</span><br><span class="line"></span><br><span class="line">Please check whether your etc/hadoop/mapred-site.xml contains the below configuration:</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;yarn.app.mapreduce.am.env&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;HADOOP_MAPRED_HOME=$&#123;full path of your hadoop distribution directory&#125;&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.map.env&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;HADOOP_MAPRED_HOME=$&#123;full path of your hadoop distribution directory&#125;&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.reduce.env&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;HADOOP_MAPRED_HOME=$&#123;full path of your hadoop distribution directory&#125;&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>解决  mapred-site.xml,增加以下配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.app.mapreduce.am.env<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>HADOOP_MAPRED_HOME=$&#123;HADOOP_HOME&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.env<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>HADOOP_MAPRED_HOME=$&#123;HADOOP_HOME&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.reduce.env<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>HADOOP_MAPRED_HOME=$&#123;HADOOP_HOME&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="5-集群初体验"><a href="#5-集群初体验" class="headerlink" title="5.集群初体验"></a>5.集群初体验</h1><p><img src="/../img/image-20220228150805289.png" alt="image-20220228150805289"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">执行Hadoop官方自带的MapReduce案例，评估圆周率π的值。</span><br><span class="line">MapReduce+YARN 初体验</span><br><span class="line">cd /export/server/hadoop-3.3.0/share/hadoop/mapreduce/</span><br><span class="line">hadoop jar hadoop-mapreduce-examples-3.3.0.jar pi 2 4</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220228152001628.png" alt="image-20220228152001628"></p>
<h1 id="6-分布式存储系统的核心属性及功能含义"><a href="#6-分布式存储系统的核心属性及功能含义" class="headerlink" title="6.分布式存储系统的核心属性及功能含义"></a>6.分布式存储系统的核心属性及功能含义</h1><p><img src="/../img/image-20220228154200343.png" alt="image-20220228154200343"></p>
<p><img src="/../img/image-20220228154211744.png" alt="image-20220228154211744"></p>
<p><img src="/../img/image-20220228154219217.png" alt="image-20220228154219217"></p>
<p><img src="/../img/image-20220228154231086.png" alt="image-20220228154231086"></p>
<p><img src="/../img/image-20220228154237846.png" alt="image-20220228154237846"></p>
<p><img src="/../img/image-20220228154321346.png" alt="image-20220228154321346"></p>
<h1 id="7-HDFS简介"><a href="#7-HDFS简介" class="headerlink" title="7.HDFS简介"></a>7.HDFS简介</h1><p>HDFS（Hadoop Distributed File System ），意为：Hadoop分布式文件系统。</p>
<p>是Apache Hadoop核心组件之一，作为大数据生态圈最底层的分布式存储服务而存在。也可以说大数据首先要解 决的问题就是海量数据的存储问题。</p>
<h1 id="8-HDFS重要特性"><a href="#8-HDFS重要特性" class="headerlink" title="8.HDFS重要特性"></a>8.HDFS重要特性</h1><h2 id="1-主从架构"><a href="#1-主从架构" class="headerlink" title="1.主从架构"></a>1.主从架构</h2><h2 id="2-分块存储"><a href="#2-分块存储" class="headerlink" title="2.分块存储"></a>2.分块存储</h2><p>是真的物理上切开了</p>
<p><img src="/../img/image-20220228155239057.png" alt="image-20220228155239057"></p>
<p><img src="/../img/image-20220228155318331.png" alt="image-20220228155318331"></p>
<h2 id="3-副本机制"><a href="#3-副本机制" class="headerlink" title="3.副本机制"></a>3.副本机制</h2><p><img src="/../img/image-20220228155352376.png" alt="image-20220228155352376"></p>
<h2 id="4-元数据管理"><a href="#4-元数据管理" class="headerlink" title="4.元数据管理"></a>4.元数据管理</h2><p>由主角色管理</p>
<p><img src="/../img/image-20220228155511856.png" alt="image-20220228155511856"></p>
<h2 id="5-namespace"><a href="#5-namespace" class="headerlink" title="5.namespace"></a>5.namespace</h2><p><img src="/../img/image-20220228155629170.png" alt="image-20220228155629170"></p>
<h2 id="6-数据块存储"><a href="#6-数据块存储" class="headerlink" title="6.数据块存储"></a>6.数据块存储</h2><p><img src="/../img/image-20220228155704261.png" alt="image-20220228155704261"></p>
<h1 id="9-HDFS-shell操作"><a href="#9-HDFS-shell操作" class="headerlink" title="9.HDFS shell操作"></a>9.HDFS shell操作</h1><p>Hadoop提供了文件系统的shell命令行客户端: </p>
<p>hadoop fs [generic options]</p>
<p>HDFS Shell CLI支持操作多种文件系统，包括本地文件系统（file:///）、分布式文件系统（hdfs://nn:8020）等</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -ls file:/// #操作本地文件系统</span><br><span class="line">hadoop fs -ls hdfs://node1:8020/ #操作HDFS分布式文件系统</span><br><span class="line">hadoop fs -ls / #直接根目录，没有指定协议 将加载读取fs.defaultFS值</span><br><span class="line">hadoop fs -ls gfs://node1:8020/ #谷歌</span><br><span class="line">hadoop fs -ls tfs://node1:8020/ #淘宝</span><br></pre></td></tr></table></figure>

<p>hadoop fs -ls file:///目录树就是本地文件系统</p>
<p><img src="/../img/image-20220228160100185.png" alt="image-20220228160100185"></p>
<p>hadoop fs -ls / #直接根目录，没有指定协议 将加载读取fs.defaultFS值</p>
<p>看下配置文件怎么配置的core-site.xml</p>
<p><img src="/../img/image-20220228160337409.png" alt="image-20220228160337409"></p>
<h2 id="1-创建文件夹"><a href="#1-创建文件夹" class="headerlink" title="1.创建文件夹"></a>1.创建文件夹</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -mkdir [-p] &lt;path&gt; ...</span><br><span class="line">path 为待创建的目录</span><br><span class="line">-p选项的行为与Unix mkdir -p非常相似，它会沿着路径创建父目录。</span><br><span class="line">eg:hadoop fs -mkdir /itcast</span><br></pre></td></tr></table></figure>

<h2 id="2-查看指定目录下内容"><a href="#2-查看指定目录下内容" class="headerlink" title="2.查看指定目录下内容"></a>2.查看指定目录下内容</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -ls [-h] [-R] [&lt;path&gt; ...]</span><br><span class="line">path 指定目录路径</span><br><span class="line">-h 人性化显示文件size</span><br><span class="line">-R 递归查看指定目录及其子目录</span><br></pre></td></tr></table></figure>

<h2 id="3、上传文件到HDFS指定目录下"><a href="#3、上传文件到HDFS指定目录下" class="headerlink" title="3、上传文件到HDFS指定目录下"></a>3、上传文件到HDFS指定目录下</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -put [-f] [-p] &lt;localsrc&gt; ... &lt;dst&gt;</span><br><span class="line">-f 覆盖目标文件（已存在下）</span><br><span class="line">-p 保留访问和修改时间，所有权和权限。</span><br><span class="line">localsrc 本地文件系统（客户端所在机器）</span><br><span class="line">dst 目标文件系统（HDFS）</span><br><span class="line">3、上传文件到HDFS指定目录下</span><br><span class="line">hadoop fs -put zookeeper.out /itcast</span><br><span class="line">hadoop fs -put file:///etc/profile hdfs://node1:8020/itcast</span><br></pre></td></tr></table></figure>

<h2 id="4、查看HDFS文件内容"><a href="#4、查看HDFS文件内容" class="headerlink" title="4、查看HDFS文件内容"></a>4、查看HDFS文件内容</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -cat &lt;src&gt; ...</span><br><span class="line">读取指定文件全部内容，显示在标准输出控制台。</span><br><span class="line">注意：对于大文件内容读取，慎重。</span><br><span class="line">hadoop fs -cat /itcast/zookeeper.out</span><br></pre></td></tr></table></figure>

<h2 id="5、下载HDFS文件"><a href="#5、下载HDFS文件" class="headerlink" title="5、下载HDFS文件"></a>5、下载HDFS文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -get [-f] [-p] &lt;src&gt; ... &lt;localdst&gt;</span><br><span class="line">下载文件到本地文件系统指定目录，localdst必须是目录</span><br><span class="line">-f 覆盖目标文件（已存在下）</span><br><span class="line">-p 保留访问和修改时间，所有权和权限。</span><br><span class="line">5、下载HDFS文件</span><br><span class="line">[root@node2 ~]# mkdir test</span><br><span class="line">[root@node2 ~]# cd test/</span><br><span class="line">[root@node2 test]# ll</span><br><span class="line">total 0</span><br><span class="line">[root@node2 test]# hadoop fs -get /itcast/zookeeper.out ./</span><br><span class="line">[root@node2 test]# ll</span><br><span class="line">total 20</span><br><span class="line">-rw-r--r-- 1 root root 18213 Aug 18 17:54 zookeeper.out</span><br></pre></td></tr></table></figure>

<h2 id="6、拷贝HDFS文件"><a href="#6、拷贝HDFS文件" class="headerlink" title="6、拷贝HDFS文件"></a>6、拷贝HDFS文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -cp [-f] &lt;src&gt; ... &lt;dst&gt;</span><br><span class="line">-f 覆盖目标文件（已存在下）</span><br><span class="line">6、拷贝HDFS文件</span><br><span class="line">[root@node3 ~]# hadoop fs -cp /small/1.txt /itcast</span><br><span class="line">[root@node3 ~]# hadoop fs -cp /small/1.txt /itcast/666.txt #重命名</span><br><span class="line">[root@node3 ~]# hadoop fs -ls /itcast</span><br><span class="line">Found 4 items</span><br><span class="line">-rw-r--r-- 3 root supergroup 2 2021-08-18 17:58 /itcast/1.txt</span><br><span class="line">-rw-r--r-- 3 root supergroup 2 2021-08-18 17:59 /itcast/666.txt</span><br></pre></td></tr></table></figure>

<h2 id="7、追加数据到HDFS文件中"><a href="#7、追加数据到HDFS文件中" class="headerlink" title="7、追加数据到HDFS文件中"></a>7、追加数据到HDFS文件中</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -appendToFile &lt;localsrc&gt; ... &lt;dst&gt;</span><br><span class="line">将所有给定本地文件的内容追加到给定dst文件。</span><br><span class="line">dst如果文件不存在，将创建该文件。</span><br><span class="line">如果&lt;localSrc&gt;为-，则输入为从标准输入中读取。</span><br><span class="line">7、追加数据到HDFS文件中</span><br><span class="line">#追加内容到文件尾部 appendToFile</span><br><span class="line">[root@node3 ~]# echo 1 &gt;&gt; 1.txt</span><br><span class="line">[root@node3 ~]# echo 2 &gt;&gt; 2.txt</span><br><span class="line">[root@node3 ~]# echo 3 &gt;&gt; 3.txt</span><br><span class="line">[root@node3 ~]# hadoop fs -put 1.txt /</span><br><span class="line">[root@node3 ~]# hadoop fs -cat /1.txt</span><br><span class="line">1</span><br><span class="line">[root@node3 ~]# hadoop fs -appendToFile 2.txt 3.txt /1.txt</span><br><span class="line">[root@node3 ~]# hadoop fs -cat /1.txt</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h2 id="8、HDFS数据移动操作"><a href="#8、HDFS数据移动操作" class="headerlink" title="8、HDFS数据移动操作"></a>8、HDFS数据移动操作</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hadoop fs -mv &lt;src&gt; ... &lt;dst&gt;</span><br><span class="line">移动文件到指定文件夹下</span><br><span class="line">可以使用该命令移动数据，重命名文件的名称</span><br></pre></td></tr></table></figure>

<h1 id="9-hdfs上传文件"><a href="#9-hdfs上传文件" class="headerlink" title="9.hdfs上传文件"></a>9.hdfs上传文件</h1><p><img src="/../img/image-20220228165246068.png" alt="image-20220228165246068"></p>
<p><img src="/../img/image-20220228165256625.png" alt="image-20220228165256625"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、HDFS客户端创建对象实例DistributedFileSystem， 该对象中封装了与HDFS文件系统操作的相关方法。</span><br><span class="line">2、调用DistributedFileSystem对象的create()方法，通过RPC请求NameNode创建文件。NameNode执行各种检查判断：目标文件是否存在、父目录是否存在、客户端是否具有创建该文件的权限。检查通过，NameNode就会为本次请求记下一条记录，返回FSDataOutputStream输出流对象给客户端用于写数据。</span><br><span class="line">3、客户端通过FSDataOutputStream输出流开始写入数据。</span><br><span class="line">4、客户端写入数据时，将数据分成一个个数据包（packet 默认64k）, 内部组件DataStreamer请求NameNode挑选出适合存储数据副本的一组DataNode地址，默认是3副本存储。</span><br><span class="line">DataStreamer将数据包流式传输到pipeline的第一个DataNode,该DataNode存储数据包并将它发送到pipeline的第二个DataNode。同样，第二个DataNode存储数据包并且发送给第三个（也是最后一个DataNode。循环操作。</span><br><span class="line">5、传输的反方向上，会通过ACK机制校验数据包传输是否成功；</span><br><span class="line">6、客户端完成数据写入后，在FSDataOutputStream输出流上调用close()方法关闭。</span><br><span class="line">7、DistributedFileSystem联系NameNode告知其文件写入完成，等待NameNode确认。因为namenode已经知道文件由哪些块组成（DataStream请求分配数据块），因此仅需等待最小副本数即可成功返回。</span><br><span class="line">最小副本数是由参数dfs.namenode.replication.min指定，默认是1.</span><br></pre></td></tr></table></figure>

<h1 id="10-hdfs下载文件"><a href="#10-hdfs下载文件" class="headerlink" title="10.hdfs下载文件"></a>10.hdfs下载文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、HDFS客户端创建对象实例DistributedFileSystem， 调用该对象的open()方法来打开希望读取的文件。</span><br><span class="line">2、DistributedFileSystem使用RPC调用namenode来确定文件中前几个块的块位置（分批次读取）信息。对于每个块，namenode返回具有该块所有副本的datanode位置地址列表，并且该地址列表是排序好的，与客户端的网络拓扑距离近的排序靠前。</span><br><span class="line">3、DistributedFileSystem将FSDataInputStream输入流返回到客户端以供其读取数据。</span><br><span class="line">4、客户端在FSDataInputStream输入流上调用read()方法。然后，已存储DataNode地址的InputStream连接到文件中第一个块的最近的DataNode。数据从DataNode流回客户端，结果客户端可以在流上重复调用read（）。</span><br><span class="line">5、当该块结束时，FSDataInputStream将关闭与DataNode的连接，然后寻找下一个block块的最佳datanode位置。</span><br><span class="line">这些操作对用户来说是透明的。所以用户感觉起来它一直在读取一个连续的流。</span><br><span class="line">客户端从流中读取数据时，也会根据需要询问NameNode来检索下一批数据块的DataNode位置信息。</span><br><span class="line">6、一旦客户端完成读取，就对FSDataInputStream调用close()方法。</span><br></pre></td></tr></table></figure>





























]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
      </tags>
  </entry>
  <entry>
    <title>https</title>
    <url>/2021/11/30/https%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>机器需要①有域名②有证书</p>
<h1 id="1-windows"><a href="#1-windows" class="headerlink" title="1.windows"></a>1.windows</h1><p><a href="https://blog.csdn.net/qq_33183456/article/details/103560395?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164499103416780261964436%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164499103416780261964436&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-103560395.first_rank_v2_pc_rank_v29&amp;utm_term=windows%E9%85%8D%E7%BD%AEhttps+%E6%9C%8D%E5%8A%A1nginx&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/qq_33183456/article/details/103560395?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164499103416780261964436%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164499103416780261964436&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-103560395.first_rank_v2_pc_rank_v29&amp;utm_term=windows%E9%85%8D%E7%BD%AEhttps+%E6%9C%8D%E5%8A%A1nginx&amp;spm=1018.2226.3001.4187</a></p>
<p>windows如果本地测试可以看CAS单点登录中，用jdk自带的工具生成</p>
<h1 id="2-linux"><a href="#2-linux" class="headerlink" title="2.linux"></a>2.linux</h1><p><a href="https://blog.csdn.net/weixin_42579642/article/details/84793132?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=linux%E9%85%8D%E7%BD%AEhttps%20%E6%9C%8D%E5%8A%A1nginx&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-84793132.first_rank_v2_pc_rank_v29&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/weixin_42579642/article/details/84793132?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=linux%E9%85%8D%E7%BD%AEhttps%20%E6%9C%8D%E5%8A%A1nginx&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-84793132.first_rank_v2_pc_rank_v29&amp;spm=1018.2226.3001.4187</a></p>
<p>linux如果本地测试可以用openssl生成</p>
<p>使用https需要ssl文件可以去阿里或腾讯服务器哪里去申请免费的，拿到ssl文件，有了证书下载下来，一般长这个样子</p>
<p>使用宝塔</p>
<p><img src="/../img/image-20220216104115651.png" alt="image-20220216104115651"></p>
<p>这样访问本机器的域名，比如https:<a href="http://www.jiang.com:端口">www.jiang.com:端口</a> ，就可以</p>
<h1 id="3-注意，一般都是开启nginx或者tomcat的https支持"><a href="#3-注意，一般都是开启nginx或者tomcat的https支持" class="headerlink" title="3.注意，一般都是开启nginx或者tomcat的https支持"></a>3.注意，一般都是开启nginx或者tomcat的https支持</h1><p>然后访问nginx的代理端口或者tomcat的webapp下的项目端口</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title></title>
    <url>/2021/11/30/dubbo/</url>
    <content><![CDATA[<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h1><p>是一个RPC框架，zookeeper是注册中心</p>
<p><img src="/../img/image-20211022105939305.png" alt="image-20211022105939305"></p>
<p><img src="/../img/image-20220223084616376.png" alt="image-20220223084616376"></p>
<h1 id="2-关系"><a href="#2-关系" class="headerlink" title="2.关系"></a>2.关系</h1><h2 id="1-公共接口，提供方和消费方的pom都需要依赖"><a href="#1-公共接口，提供方和消费方的pom都需要依赖" class="headerlink" title="1.公共接口，提供方和消费方的pom都需要依赖"></a>1.公共接口，提供方和消费方的pom都需要依赖</h2><p><img src="/../img/image-20220223093255506.png" alt="image-20220223093255506"></p>
<h2 id="2-提供方"><a href="#2-提供方" class="headerlink" title="2.提供方"></a>2.提供方</h2><p><img src="/../img/image-20220223093433100.png" alt="image-20220223093433100"></p>
<h2 id="3-消费方"><a href="#3-消费方" class="headerlink" title="3.消费方"></a>3.消费方</h2><p><img src="/../img/image-20220223093458891.png" alt="image-20220223093458891"></p>
<h1 id="3-高级特性"><a href="#3-高级特性" class="headerlink" title="3.高级特性"></a>3.高级特性</h1><p><img src="/../img/image-20220223093841824.png" alt="image-20220223093841824"></p>
<h2 id="dubbo-admin"><a href="#dubbo-admin" class="headerlink" title="dubbo-admin"></a>dubbo-admin</h2><h2 id="一、dubbo-admin安装"><a href="#一、dubbo-admin安装" class="headerlink" title="一、dubbo-admin安装"></a>一、dubbo-admin安装</h2><p><strong>1、环境准备</strong></p>
<p>dubbo-admin 是一个前后端分离的项目。前端使用vue，后端使用springboot，安装 dubbo-admin 其实就是部署该项目。我们将dubbo-admin安装到开发环境上。要保证开发环境有jdk，maven，nodejs</p>
<p>安装node**(如果当前机器已经安装请忽略)**</p>
<p>因为前端工程是用vue开发的，所以需要安装node.js，node.js中自带了npm，后面我们会通过npm启动</p>
<p>下载地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://nodejs.org/en/</span><br></pre></td></tr></table></figure>

<p><img src="/../img/1578298201398.png" alt="1578298201398"></p>
<p><strong>2、下载 Dubbo-Admin</strong></p>
<p>进入github，搜索dubbo-admin</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/apache/dubbo-admin</span><br></pre></td></tr></table></figure>

<p>下载：</p>
<p><img src="/../img/1578297063167.png" alt="1578297063167"></p>
<p><strong>3、把下载的zip包解压到指定文件夹(解压到那个文件夹随意)</strong></p>
<p><img src="/../img/1578297477356.png" alt="1578297477356"></p>
<p><strong>4、修改配置文件</strong></p>
<p>解压后我们进入…\dubbo-admin-develop\dubbo-admin-server\src\main\resources目录，找到 <strong>application.properties</strong> 配置文件 进行配置修改</p>
<p><img src="/../img/1578297603008.png" alt="1578297603008"></p>
<p>修改zookeeper地址</p>
<p><img src="/../img/1578297758655.png" alt="1578297758655"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> centers <span class="keyword">in</span> dubbo2.7</span></span><br><span class="line">admin.registry.address=zookeeper://192.168.149.135:2181</span><br><span class="line">admin.config-center=zookeeper://192.168.149.135:2181</span><br><span class="line">admin.metadata-report.address=zookeeper://192.168.149.135:2181</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>admin.registry.address注册中心<br>admin.config-center 配置中心<br>admin.metadata-report.address元数据中心</p>
<p><strong>5、打包项目</strong></p>
<p>在 dubbo-admin-develop 目录执行打包命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn  clean package</span><br></pre></td></tr></table></figure>

<p><img src="/../img/1578300464726.png" alt="1578300464726"></p>
<p><strong>6、启动后端</strong></p>
<p>切换到目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">dubbo-Admin-develop\dubbo-admin-distribution\target&gt;</span><br></pre></td></tr></table></figure>

<p>执行下面的命令启动 dubbo-admin，dubbo-admin后台由SpringBoot构建。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar .\dubbo-admin-0.1.jar</span><br></pre></td></tr></table></figure>

<p><img src="/../img/1578300551892.png" alt="1578300551892"></p>
<p><strong>7、前台后端</strong></p>
<p>dubbo-admin-ui 目录下执行命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p><img src="/../img/1578300677041.png" alt="1578300677041"></p>
<p><strong>8、访问</strong></p>
<p>浏览器输入。用户名密码都是root</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:8081/</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220223094441474.png" alt="image-20220223094441474"></p>
<h2 id="二、dubbo-admin简单使用"><a href="#二、dubbo-admin简单使用" class="headerlink" title="二、dubbo-admin简单使用"></a>二、dubbo-admin简单使用</h2><p>注意:Dubbo Admin【服务Mock】【服务统计】将在后续版本发布….</p>
<p>在上面的步骤中，我们已经进入了Dubbo-Admin的主界面，在【快速入门】章节中，我们定义了服务生产者、和服务消费者，下面我们从Dubbo-Admin管理界面找到这个两个服务</p>
<p><strong>1、点击服务查询</strong></p>
<p><img src="/../img/image-20220223094412478.png" alt="image-20220223094412478"></p>
<p><strong>2、查询结果</strong></p>
<p><img src="/../img/1578301528363.png" alt="1578301528363"></p>
<p>A:输入的查询条件com.itheima.service.UserService</p>
<p>B:搜索类型，主要分为【按服务名】【按IP地址】【按应用】三种类型查询</p>
<p>C:搜索结果</p>
<p><strong>3.1.4 dubo-admin查看详情</strong></p>
<p>我们查看com.itheima.service.UserService （服务提供者）的具体详细信息，包含【元数据信息】</p>
<p><strong>1）点击详情</strong></p>
<p><img src="/../img/image-20220223094503838.png" alt="image-20220223094503838"></p>
<p>从【详情】界面查看，主要分为3个区域</p>
<p>A区域：主要包含服务端 基础信息比如服务名称、应用名称等</p>
<p>B区域：主要包含了生产者、消费者一些基本信息</p>
<p><strong>C区域：是元数据信息，注意看上面的图,元数据信息是空的</strong></p>
<p>我们需要打开我们的生产者配置文件加入下面配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 元数据配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:metadata-report</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://192.168.149.135:2181&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>重新启动生产者，再次打开Dubbo-Admin</p>
<p>这样我们的元数据信息就出来了</p>
<p><img src="/../img/1578301892712.png" alt="1578301892712"></p>
<h1 id="4-高级配置"><a href="#4-高级配置" class="headerlink" title="4.高级配置"></a>4.高级配置</h1><h2 id="1-序列化"><a href="#1-序列化" class="headerlink" title="1.序列化"></a>1.序列化</h2><p><img src="/../img/image-20220223094945052.png" alt="image-20220223094945052"></p>
<h2 id="2-地址缓存"><a href="#2-地址缓存" class="headerlink" title="2.地址缓存"></a>2.地址缓存</h2><p><img src="/../img/image-20220223094958931.png" alt="image-20220223094958931"></p>
<h2 id="3-超时重试"><a href="#3-超时重试" class="headerlink" title="3.超时重试"></a>3.超时重试</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">服务消费者在调用服务提供者的时候发生了阻塞、等待的情形，这个时候，服务消费者会一直等待下去。</span><br><span class="line">在某个峰值时刻，大量的请求都在同时请求服务消费者，会造成线程的大量堆积，势必会造成雪崩。</span><br><span class="line">服务消费者在调用服务提供者的时候发生了阻塞、等待的情形，这个时候，服务消费者会一直等待下去。</span><br><span class="line">在某个峰值时刻，大量的请求都在同时请求服务消费者，会造成线程的大量堆积，势必会造成雪崩。</span><br><span class="line">dubbo 利用超时机制来解决这个问题，设置一个超时时间，在这个时间段内，无法完成服务访问，则自动断开连接。</span><br><span class="line">使用timeout属性配置超时时间，默认值1000，单位毫秒。</span><br><span class="line">设置了超时时间，在这个时间段内，无法完成服务访问，则自动断开连接。</span><br><span class="line">如果出现网络抖动，则这一次请求就会失败。</span><br><span class="line">Dubbo 提供重试机制来避免类似问题的发生。</span><br><span class="line">通过 retries  属性来设置重试次数。默认为 2 次。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>timeout在消费者方会覆盖提供者方，建议在提供者方配置</p>
<p>消费者方</p>
<p><img src="/../img/image-20220223101121886.png" alt="image-20220223101121886"></p>
<p>提供者方</p>
<p><img src="/../img/image-20220223101134707.png" alt="image-20220223101134707"></p>
<p>超时以后才会重试</p>
<p><img src="/../img/image-20220223101216794.png" alt="image-20220223101216794"></p>
<h2 id="4-多版本"><a href="#4-多版本" class="headerlink" title="4.多版本"></a>4.多版本</h2><p>注意在服务提供方</p>
<p><img src="/../img/image-20220223101454222.png" alt="image-20220223101454222"></p>
<h3 id="1版本"><a href="#1版本" class="headerlink" title="1版本"></a>1版本</h3><p><img src="/../img/image-20220223101555353.png" alt="image-20220223101555353"></p>
<h3 id="2版本"><a href="#2版本" class="headerlink" title="2版本"></a>2版本</h3><p><img src="/../img/image-20220223101616800.png" alt="image-20220223101616800"></p>
<p>消费者，+version字段</p>
<p><img src="/../img/image-20220223101659135.png" alt="image-20220223101659135"></p>
<h2 id="5-负载均衡"><a href="#5-负载均衡" class="headerlink" title="5.负载均衡"></a>5.负载均衡</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">负载均衡策略（4种）：</span><br><span class="line">Random ：按权重随机，默认值。按权重设置随机概率。</span><br><span class="line">RoundRobin ：按权重轮询。</span><br><span class="line">LeastActive：最少活跃调用数，相同活跃数的随机。</span><br><span class="line">ConsistentHash：一致性 Hash，相同参数的请求总是发到同一提供者。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/../img/image-20220223101918043.png" alt="image-20220223101918043"></p>
<p>在服务提供方+weight</p>
<p><img src="/../img/image-20220223101905780.png" alt="image-20220223101905780"></p>
<p>服务调用方，loadbance指定负载均衡策略</p>
<p><img src="/../img/image-20220223102045752.png" alt="image-20220223102045752"></p>
<h2 id="6-集群容错"><a href="#6-集群容错" class="headerlink" title="6.集群容错"></a>6.集群容错</h2><p><img src="/../img/image-20220223102207129.png" alt="image-20220223102207129"></p>
<p>服务调用方 cluster</p>
<p><img src="/../img/image-20220223102417892.png" alt="image-20220223102417892"></p>
<h2 id="7-服务降级"><a href="#7-服务降级" class="headerlink" title="7.服务降级"></a>7.服务降级</h2><p><img src="/../img/image-20220223102628377.png" alt="image-20220223102628377"></p>
<p>消费方 mock</p>
<p><img src="/../img/image-20220223102746921.png" alt="image-20220223102746921"></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>jfm</title>
    <url>/2021/11/30/jfm/</url>
    <content><![CDATA[<h1 id="ProjectNacosConfig"><a href="#ProjectNacosConfig" class="headerlink" title="ProjectNacosConfig"></a>ProjectNacosConfig</h1><p><img src="/D:/hexo博客/blog/source/img/image-20220401141154047.png" alt="image-20220401141154047"></p>
<p>这个类启动后会自动读取配置文件前缀名nbd.jfmhandler.nacos的配置</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401141249288.png" alt="image-20220401141249288"></p>
<p>我们发现bootstrap没有以nbd.jfmhandler.nacos开头的。但是有上图红框中，是共享配置的意思，进入10.12.1.45的ac267fe0-3a79-4b1f-a211-bdd2f1b53787命名空间中发现，确实有NBD-JFMHANDLER-CONFIG.yml这么一个配置文件</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401141449832.png" alt="image-20220401141449832"></p>
<p>进入这个配置文件看</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401141558768.png" alt="image-20220401141558768"></p>
<p>那么这个ProjectNacosConfig类就读取到了nbd.jfmhandler.nacos开头的配置</p>
<p>是一个list数组</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401141854212.png" alt="image-20220401141854212"></p>
<p>数组里的每个对象就是configs下的三个属性</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401141925886.png" alt="image-20220401141925886"></p>
<h1 id="CacheJob定时任务类"><a href="#CacheJob定时任务类" class="headerlink" title="CacheJob定时任务类"></a>CacheJob定时任务类</h1><p><img src="/D:/hexo博客/blog/source/img/image-20220401142041240.png" alt="image-20220401142041240"></p>
<p>在NacosUtil</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401142119199.png" alt="image-20220401142119199"></p>
<p>就会找到configs下的三个属性中的第一个，因为第一的group是cache_group</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401142229446.png" alt="image-20220401142229446"></p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401142547008.png" alt="image-20220401142547008"></p>
<p>往后读取到了configs下的命名空间，以及根据dataId找到了local-cache.xml</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401142621346.png" alt="image-20220401142621346"></p>
<h1 id="local-cache-xml缓存任务类"><a href="#local-cache-xml缓存任务类" class="headerlink" title="local-cache.xml缓存任务类"></a>local-cache.xml缓存任务类</h1><p><img src="/D:/hexo博客/blog/source/img/image-20220401135720985.png" alt="image-20220401135720985"></p>
<p>最终存到redis里</p>
<p>key：vendorCache  </p>
<p>value：map==》</p>
<p>​                    key：是<key>标签在数据库中的值，多个用@分隔符</key></p>
<p>​                    value：是这个key值所在的sql里的所有字段，这样就可以</p>
<p>​                                <img src="/D:/hexo博客/blog/source/img/image-20220401135945254.png" alt="image-20220401135945254"></p>
<p>测试key为单个：</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401141051484.png" alt="image-20220401141051484"></p>
<p>测试key为多个：注意cacheType指定了list</p>
<p>相当于制定了条件，并且顺序不能变，为空字段直接@@</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401144748656.png" alt="image-20220401144748656"></p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401144825560.png" alt="image-20220401144825560"></p>
<p>因为指定了cacheType指定了list，所以用listRedisClient</p>
<p>并且返回的list只有一个map对象</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401150451788.png" alt="image-20220401150451788"></p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p><img src="/D:/hexo博客/blog/source/img/image-20220401152117045.png" alt="image-20220401152117045"></p>
<p>发送到继承这个接口的方法中</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20220401152211012.png" alt="image-20220401152211012"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>jfm</tag>
      </tags>
  </entry>
  <entry>
    <title>jmeter压力测试</title>
    <url>/2021/11/30/jmeter%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<p><a href="https://blog.csdn.net/lovesoo/article/details/78579547?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164151729616780274166864%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164151729616780274166864&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-78579547.first_rank_v2_pc_rank_v29&amp;utm_term=jmeter%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E6%AD%A5%E9%AA%A4&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/lovesoo/article/details/78579547?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164151729616780274166864%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164151729616780274166864&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-78579547.first_rank_v2_pc_rank_v29&amp;utm_term=jmeter%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E6%AD%A5%E9%AA%A4&amp;spm=1018.2226.3001.4187</a></p>
<h1 id="文件上传压力测试"><a href="#文件上传压力测试" class="headerlink" title="文件上传压力测试"></a>文件上传压力测试</h1><h2 id="常用的列表"><a href="#常用的列表" class="headerlink" title="常用的列表"></a>常用的列表</h2><p><img src="/../img/image-20220107143209751.png" alt="image-20220107143209751"></p>
<h3 id="1-线程组"><a href="#1-线程组" class="headerlink" title="1.线程组"></a>1.线程组</h3><p><img src="/../img/image-20220107143334909.png" alt="image-20220107143334909"></p>
<h3 id="2-http请求"><a href="#2-http请求" class="headerlink" title="2.http请求"></a>2.http请求</h3><p><img src="/../img/image-20220107143426613.png" alt="image-20220107143426613"></p>
<h3 id="3-请求头"><a href="#3-请求头" class="headerlink" title="3.请求头"></a>3.请求头</h3><p>正常来说还有一个Content-Type：multipart/form-data</p>
<p><img src="/../img/image-20220107143502682.png" alt="image-20220107143502682"></p>
<p>但是这里不能添加，添加了以后解析错误</p>
<h3 id="4-结果数和聚合报告"><a href="#4-结果数和聚合报告" class="headerlink" title="4.结果数和聚合报告"></a>4.结果数和聚合报告</h3><p><img src="/../img/image-20220107143608991.png" alt="image-20220107143608991"></p>
<h3 id="5-CSV文件"><a href="#5-CSV文件" class="headerlink" title="5.CSV文件"></a>5.CSV文件</h3><p><img src="/../img/image-20220107143657501.png" alt="image-20220107143657501"></p>
<p><img src="/../img/image-20220107143720365.png" alt="image-20220107143720365"></p>
<p><img src="/../img/image-20220107143747750.png" alt="image-20220107143747750"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>jmeter压力测试</tag>
      </tags>
  </entry>
  <entry>
    <title>jvm</title>
    <url>/2021/11/30/jvm/</url>
    <content><![CDATA[<h1 id="1-JVM的整个构造"><a href="#1-JVM的整个构造" class="headerlink" title="1.JVM的整个构造"></a>1.JVM的整个构造</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210803171002492.png" alt="image-20210803171002492"></p>
<p>jvm调优就是在画红圈的这里</p>
<h1 id="2-存放位置"><a href="#2-存放位置" class="headerlink" title="2.存放位置"></a>2.存放位置</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210803170729464.png" alt="image-20210803170729464"></p>
<p>![3716034d13b769152bd1a4f21dc139d](C:\Users\ADMINI~1\AppData\Local\Temp\WeChat Files\3716034d13b769152bd1a4f21dc139d.png)</p>
<p>栈：引用变量，方法引用，8大基本类型，本地栈（所有对象的引用用）</p>
<p>堆：具体实例（地址），常亮，变量，（所有引用类型的真实对象）</p>
<p>方法区（也是一个堆，但是为了区分，叫做非堆）：静态变量static，final，类信息：class类，类的属性。常量池</p>
<h1 id="3-类加载器"><a href="#3-类加载器" class="headerlink" title="3.类加载器"></a>3.类加载器</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210803171136784.png" alt="image-20210803171136784"></p>
<h2 id="1、Java虚拟机自带的加载器"><a href="#1、Java虚拟机自带的加载器" class="headerlink" title="1、Java虚拟机自带的加载器"></a>1、Java虚拟机自带的加载器</h2><p> 根类加载器（BootStrap）(BootClassLoader) sun.boot.class.path （加载系统的包，包含jdk核 心库里的类）</p>
<p> 扩展类加载器（Extension）（ExtClassLoader） java.ext.dirs（加载扩展jar包中的类）</p>
<p> 系统（应用）类加载器（System）(AppClassLoader) java.class.path（加载你编写的类，编译后 的类）</p>
<h2 id="1-1双亲委派机制"><a href="#1-1双亲委派机制" class="headerlink" title="1.1双亲委派机制"></a>1.1双亲委派机制</h2><ol>
<li><p>类加载器收到类加载的请求；</p>
</li>
<li><p>把这个请求委托给父加载器去完成，一直向上委托，直到启动类加载器</p>
</li>
<li><p>启动器加载器检查能不能加载（使用findClass()方法），能就加载（结束）；否则，抛出异常，通 知子加载器进行加载。</p>
</li>
<li><p>重复步骤三；</p>
</li>
<li><p>如果一直到系统类加载器都无法加载，就会抛出类找不到异常</p>
</li>
</ol>
<h2 id="2、用户自定义的类加载器"><a href="#2、用户自定义的类加载器" class="headerlink" title="2、用户自定义的类加载器"></a>2、用户自定义的类加载器</h2><p> Java.long.ClassLoader的子类（继承），用户可以定制类的加载方式</p>
<h1 id="4-Native方法"><a href="#4-Native方法" class="headerlink" title="4.Native方法"></a>4.Native方法</h1><p>编写一个多线程类启动</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">&#125;,<span class="string">&quot;your thread name&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点进去看start方法的源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">group.add(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	start0(); <span class="comment">//调用了一个start0方法</span></span><br><span class="line">	started = <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!started) &#123;</span><br><span class="line">group.threadStartFailed(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这个Thread是一个类，这个方法定义在这里是不是很诡异！看这个关键字native；</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>凡是带了native关键字的，说明 java的作用范围达不到，去调用底层C语言的库！</p>
<p>JNI：Java Native Interface （Java本地方法接口）</p>
<p>凡是带了native关键字的方法就会进入本地方法栈；</p>
<p>Native Method Stack 本地方法栈 </p>
<p>本地接口的作用是融合不同的编程语言为Java所用，它的初衷是融合C/C++程序，Java在诞生的时候是 C/C++横行的时候，想要立足，必须有调用C、C++的程序，于是就在内存中专门开辟了一块区域处理标 记为native的代码，它的具体做法是 在 Native Method Stack 中登记native方法，在 ( Execution Engine ) 执行引擎执行的时候加载Native Libraies。</p>
<p>目前该方法使用的越来越少了，除非是与硬件有关的应用，比如通过Java程序驱动打印机或者Java系统 管理生产设备，在企业级应用中已经比较少见。因为现在的异构领域间通信很发达，比如可以使用 Socket通信，也可以使用Web Service等等，不多做介绍！</p>
<h1 id="5-程序计数器"><a href="#5-程序计数器" class="headerlink" title="5.程序计数器"></a>5.程序计数器</h1><p>线程私有，内存可以忽略不计，可以让线程有序，带编号</p>
<h1 id="6-栈"><a href="#6-栈" class="headerlink" title="6.栈"></a>6.栈</h1><p>public void test（）{}</p>
<p>test方法存放到栈</p>
<p>1、栈也叫栈内存，主管Java程序的运行，是在线程创建时创建，它的生命期是跟随线程的生命期，线程</p>
<p>结束栈内存也就释放。</p>
<p>2、<strong>对于栈来说不存在垃圾回收问题</strong>，只要线程一旦结束，该栈就Over，生命周期和线程一致，是线程私有的。</p>
<h1 id="7-堆（垃圾回收主要场所）"><a href="#7-堆（垃圾回收主要场所）" class="headerlink" title="7.堆（垃圾回收主要场所）"></a>7.堆（垃圾回收主要场所）</h1><p><strong>了解三种<strong><strong>JVM</strong></strong>：</strong></p>
<p>Sun公司的 HotSpot</p>
<p>BEA公司的 JRockit</p>
<p>IBM公司的 J9VM</p>
<p>Heap 堆，一个JVM实例只存在一个堆内存，堆内存的大小是可以调节的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">堆内存分为</span><br><span class="line"></span><br><span class="line">三部分：</span><br><span class="line"></span><br><span class="line">新生区（伊甸区） Young Generation Space Young/New</span><br><span class="line"></span><br><span class="line">养老区 Tenure generation space Old/Tenure</span><br><span class="line"></span><br><span class="line">永久区 Permanent Space Perm</span><br><span class="line"></span><br><span class="line">堆内存逻辑上分为三部分：新生，养老，永久区（元空间 : JDK8 以后名称）</span><br></pre></td></tr></table></figure>





<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210806163128495.png" alt="image-20210806163128495"></p>
<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">新生区是类诞生，成长，消亡的区域，一个类在这里产生，应用，最后被垃圾回收器收集，结束生命。</span><br><span class="line"></span><br><span class="line">新生区又分为两部分：伊甸区（Eden Space）和幸存者区（Survivor Space），所有的类都是在伊甸区</span><br><span class="line"></span><br><span class="line">被new出来的，幸存区有两个：0区 和 1区，当伊甸园的空间用完时，程序又需要创建对象，JVM的垃圾</span><br><span class="line"></span><br><span class="line">回收器将对伊甸园区进行垃圾回收（Minor GC）。将伊甸园中的剩余对象移动到幸存0区，若幸存0区也</span><br><span class="line"></span><br><span class="line">满了，再对该区进行垃圾回收，然后移动到1区，那如果1区也满了呢？（这里幸存0区和1区是一个互相</span><br><span class="line"></span><br><span class="line">交替的过程）再移动到养老区，若养老区也满了，那么这个时候将产生MajorGC（Full GC），进行养老</span><br><span class="line"></span><br><span class="line">区的内存清理，若养老区执行了Full GC后发现依然无法进行对象的保存，就会产生OOM异常 </span><br><span class="line"></span><br><span class="line">“OutOfMemoryError ”。</span><br><span class="line"></span><br><span class="line">如果出现 java.lang.OutOfMemoryError：java heap space异常，说明Java虚拟机的堆内存不够，原因</span><br><span class="line"></span><br><span class="line">如下：</span><br><span class="line"></span><br><span class="line">1、Java虚拟机的堆内存设置不够，可以通过参数 -Xms（初始值大小），-Xmx（最大大小）来调整。</span><br><span class="line"></span><br><span class="line">2、代码中创建了大量大对象，并且长时间不能被垃圾收集器收集（存在被引用）或者死循环</span><br></pre></td></tr></table></figure>

<h2 id="永久区"><a href="#永久区" class="headerlink" title="永久区"></a>永久区</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809101603160.png" alt="image-20210809101603160"></p>
<h2 id="堆内存调优"><a href="#堆内存调优" class="headerlink" title="堆内存调优"></a>堆内存调优</h2><p><strong>堆内存调优</strong></p>
<p>-Xms ：设置初始分配大小，默认为物理内存的 “1/64”</p>
<p>-Xmx ：最大分配内存，默认为物理内存的 “1/4”</p>
<p>-XX:+PrintGCDetails ：输出详细的GC处理日志</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo01</span> </span>&#123; <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line">    <span class="comment">//返回Java虚拟机试图使用的最大内存量 </span></span><br><span class="line">    <span class="keyword">long</span> maxMemory = Runtime.getRuntime().maxMemory(); </span><br><span class="line">    <span class="comment">//返回Java虚拟机中的内存总量 </span></span><br><span class="line">    <span class="keyword">long</span> totalMemory = Runtime.getRuntime().totalMemory(); System.out.println(<span class="string">&quot;MAX_MEMORY=&quot;</span>+maxMemory+<span class="string">&quot;(字节)、&quot;</span> +(maxMemory/(<span class="keyword">double</span>)<span class="number">1024</span>/<span class="number">1024</span>)+<span class="string">&quot;MB&quot;</span>); System.out.println(<span class="string">&quot;TOTAL_MEMORY=&quot;</span>+totalMemory+<span class="string">&quot;(字节)、&quot;</span> +(totalMemory/(<span class="keyword">double</span>)<span class="number">1024</span>/<span class="number">1024</span>)+<span class="string">&quot;MB&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809103318242.png" alt="image-20210809103318242"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809103452719.png" alt="image-20210809103452719"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809104216991.png" alt="image-20210809104216991"></p>
<h2 id="分析内存错误JProfifiler"><a href="#分析内存错误JProfifiler" class="headerlink" title="分析内存错误JProfifiler"></a>分析内存错误JProfifiler</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809104742094.png" alt="image-20210809104742094"></p>
<p>1、IDEA插件安装</p>
<p>2、安装JProfifiler监控软件</p>
<p>下载地址：<a href="https://www.ej-technologies.com/download/jprofifiler/version_92">https://www.ej-technologies.com/download/jprofifiler/version_92</a></p>
<p>安装路径，<strong>建议选择一个文件名中没有中文，没有空格的路径</strong></p>
<p>3.注册码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 注册码仅供大家参考 </span><br><span class="line">L-Larry_Lau@163.com#23874-hrwpdp1sh1wrn#0620 </span><br><span class="line">L-Larry_Lau@163.com#36573-fdkscp15axjj6#25257 </span><br><span class="line">L-Larry_Lau@163.com#5481-ucjn4a16rvd98#6038 </span><br><span class="line">L-Larry_Lau@163.com#99016-hli5ay1ylizjj#27215 </span><br><span class="line">L-Larry_Lau@163.com#40775-3wle0g1uin5c1#0674</span><br></pre></td></tr></table></figure>

<p>4、配置IDEA运行环境</p>
<p>Settings–Tools–JProflflier–JProflflier executable*选择JProfifile安装可执行文件</p>
<p>5、选择你要分析的项目，点击JProfifiler图标启动， 启动完成会自动弹出JProfifiler窗口，在里面就可以监控自己的代码性能了。</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809112301244.png" alt="image-20210809112301244"></p>
<h2 id="dump转存"><a href="#dump转存" class="headerlink" title="dump转存"></a>dump转存</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809113015109.png" alt="image-20210809113015109"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1m</span></span><br><span class="line">    <span class="keyword">byte</span>[] array=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1</span>*<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;A&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                list.add(<span class="keyword">new</span> A());</span><br><span class="line">                count+=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Error e)&#123;</span><br><span class="line">            System.out.println(count);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>-Xms1m -Xmx8m -XX:+HeapDumpOnOutOfMemoryError</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809113025502.png" alt="image-20210809113025502"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809113040483.png" alt="image-20210809113040483"></p>
<h1 id="GC：垃圾回收"><a href="#GC：垃圾回收" class="headerlink" title="GC：垃圾回收"></a>GC：垃圾回收</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809114132702.png" alt="image-20210809114132702"></p>
<h3 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h3><h3 id="1-引用计数法"><a href="#1-引用计数法" class="headerlink" title="1.引用计数法"></a>1.引用计数法</h3><h3 id="2-复制算法-minor-gc采用，年轻代"><a href="#2-复制算法-minor-gc采用，年轻代" class="headerlink" title="2.复制算法 minor gc采用，年轻代"></a>2.复制算法 minor gc采用，年轻代</h3><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809153846980.png" alt="image-20210809153846980"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809154244846.png" alt="image-20210809154244846"></p>
<h3 id="3-标记清除"><a href="#3-标记清除" class="headerlink" title="3.标记清除"></a>3.标记清除</h3><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809154819580.png" alt="image-20210809154819580"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809154830909.png" alt="image-20210809154830909"></p>
<h3 id="4-标记压缩"><a href="#4-标记压缩" class="headerlink" title="4.标记压缩"></a>4.标记压缩</h3><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809154811309.png" alt="image-20210809154811309"></p>
<p>好处：没有内存碎片</p>
<p>坏处：三次扫描</p>
<h3 id="5-标记清除压缩"><a href="#5-标记清除压缩" class="headerlink" title="5.标记清除压缩"></a>5.标记清除压缩</h3><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809155610617.png" alt="image-20210809155610617"></p>
<p>难道就没有一种最优算法吗？猜猜看，下面还有</p>
<p>答案 ： 无，没有最好的算法，只有最合适的算法 。 —————–&gt; </p>
<h3 id="6-分代收集算法"><a href="#6-分代收集算法" class="headerlink" title="6.分代收集算法"></a>6.分代收集算法</h3><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809155940937.png" alt="image-20210809155940937"></p>
<h2 id="对象什么时候可以回收？"><a href="#对象什么时候可以回收？" class="headerlink" title="对象什么时候可以回收？"></a>对象什么时候可以回收？</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809151955911.png" alt="image-20210809151955911"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809160132326.png" alt="image-20210809160132326"></p>
<h1 id="JMM"><a href="#JMM" class="headerlink" title="JMM"></a>JMM</h1><h2 id="1-什么是JMM？"><a href="#1-什么是JMM？" class="headerlink" title="1.什么是JMM？"></a>1.什么是JMM？</h2><p>Java Memory Model(java内存模型)</p>
<h2 id="2-他是干嘛的？"><a href="#2-他是干嘛的？" class="headerlink" title="2.他是干嘛的？"></a>2.他是干嘛的？</h2><p>缓存一致性协议，用于定义数据读写的规则。</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809160916734.png" alt="image-20210809160916734"></p>
<p>解决共享对象可见性：volilate，一个对象改变可以马上更新到共享内存中</p>
<h2 id="3-他该如何学习？"><a href="#3-他该如何学习？" class="headerlink" title="3.他该如何学习？"></a>3.他该如何学习？</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210809161734118.png" alt="image-20210809161734118"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>kafka</title>
    <url>/2021/11/30/kafka/</url>
    <content><![CDATA[<h1 id="尚硅谷大数据技术之Kafka-pdf"><a href="#尚硅谷大数据技术之Kafka-pdf" class="headerlink" title="尚硅谷大数据技术之Kafka.pdf"></a>尚硅谷大数据技术之Kafka.pdf</h1><h1 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022091301329.png" alt="image-20211022091301329"></p>
<h2 id="3）Consumer-Group-（CG）："><a href="#3）Consumer-Group-（CG）：" class="headerlink" title="3）Consumer Group （CG）："></a>3）Consumer Group （CG）：</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022102208946.png" alt="image-20211022102208946"></p>
<p>提高了消费能力，一个消费者组时，如果有ab两个人，消费100条消息，那么每个人消费50条，并且不重复</p>
<p>如果有两个分区，三个人abc，那么a消费分区0，b消费分区1，c只能浪费了，最好组内个数和分区数相等</p>
<h2 id="6）Partition："><a href="#6）Partition：" class="headerlink" title="6）Partition："></a>6）Partition：</h2><p>为了实现扩展性，一个非常大的 topic 可以分布到多个 broker（即服务器）上， 一个 topic 可以分为多个 partition，每个 partition 是一个有序的队列； </p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022101402666.png" alt="image-20211022101402666"></p>
<p>集群两个服务器，如果轮训的方式，第一次发送服务器1的分区0，第二次发送服务器2分区1</p>
<p>，每个分区内容是不一样的，加强负载能力，负载均衡</p>
<h2 id="8）leader："><a href="#8）leader：" class="headerlink" title="8）leader："></a>8）leader：</h2><p>每个分区多个副本的“主”，生产者发送数据的对象，以及消费者消费数据的对 象都是 leader。</p>
<h2 id="9）follower："><a href="#9）follower：" class="headerlink" title="9）follower："></a>9）follower：</h2><p>每个分区多个副本中的“从”，实时从 leader 中同步数据，保持和 leader 数据 的同步。leader 发生故障时，某个 follower 会成为新的 follower。</p>
<p><strong>leader和follower一定不再同一个机器上</strong></p>
<p>生产者消费者只找leader，follower只是负责一个备份的目的</p>
<h2 id="10）offset："><a href="#10）offset：" class="headerlink" title="10）offset："></a>10）offset：</h2><p>偏移量：记录消费位置，防止挂掉从头消费</p>
<p>消费者消费消息中断时，下次会继续从中断的位置继续，因为消费者消费消息时，会保存消费到的数据位置（offset）</p>
<p><strong>新版本offset存在本地不是指在磁盘，而是在kafka里</strong></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022103454202.png" alt="image-20211022103454202"></p>
<h2 id="kafka消息存在磁盘上，默认7天"><a href="#kafka消息存在磁盘上，默认7天" class="headerlink" title="kafka消息存在磁盘上，默认7天"></a>kafka消息存在磁盘上，默认7天</h2><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>kafka是依赖于zk的，要先安装zookeeper</p>
<p>kafka和zookeeper的包都在 /opt/software包</p>
<p>解压到 /opt/module</p>
<p>改红色的内容</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022175625401.png" alt="image-20211022175625401"></p>
<p>常用命令</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022190926654.png" alt="image-20211022190926654"></p>
<p>-daemon守护进程</p>
<p>bin目录下</p>
<p>touch kk.sh</p>
<p>chmod 777 kk.sh</p>
<p>群起脚本kk.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">	for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">    do</span><br><span class="line">    echo &quot;========== $i ==========&quot;</span><br><span class="line">    ssh $i &#x27;/opt/module/kafka/bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties&#x27;</span><br><span class="line">    done</span><br><span class="line">&#125;;;</span><br><span class="line"></span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">	for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">    do</span><br><span class="line">    echo &quot;========== $i ==========&quot;</span><br><span class="line">    ssh $i &#x27;/opt/module/kafka/bin/kafka-server-stop.sh&#x27;</span><br><span class="line">    done</span><br><span class="line">&#125;;;</span><br><span class="line"></span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>启动 kk.sh start</p>
<p>关闭 kk.sh stop</p>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><p>自己创建的logs启动以后主要看这个server.log</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022194053190.png" alt="image-20211022194053190"></p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><p>启动bin/kafka-server-start.sh -daemon config/server.properties</p>
<p>停止bin/kafka-server-stop.sh stop</p>
<h2 id="topic相关"><a href="#topic相关" class="headerlink" title="topic相关"></a>topic相关</h2><p>2181是zookeeper的端口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.查看主题列表</span><br><span class="line">bin/kafka-topics.sh --zookeeper localhost:2181 --list</span><br><span class="line">2、创建主题  </span><br><span class="line">--topic first 主题名字 first</span><br><span class="line">--replication-factor 1   副本数1  必须大于0，因为本身就算1份了</span><br><span class="line">--partitions 2  分区数2</span><br><span class="line">bin/kafka-topics.sh --zookeeper jiang:2181 --create --topic first --replication-factor 1 --partitions 1</span><br><span class="line"></span><br><span class="line">./kafka-topics.sh --zookeeper 192.168.214.130:2181 --create --topic test02 --replication-factor 1 --partitions 1</span><br><span class="line"></span><br><span class="line">./bin/kafka-console-consumer.sh --zookeeper 192.168.214.130:2181 -topic test02 --from-beginning</span><br><span class="line"></span><br><span class="line">在单个kafka里，把副本数变为2就会报错了，因为单个kafka只能保存一份数据，如下图的报错，副本数大于服务器的数了，错误</span><br><span class="line">bin/kafka-topics.sh --zookeeper jiang:2181 --create --topic second --replication-factor 2 --partitions 3</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022194002166.png" alt="image-20211022194002166"></p>
<p>创建以后再查询，发现有了first这个主题</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022193551506.png" alt="image-20211022193551506"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3.删除主题</span><br><span class="line">--topic first 删除得告诉是哪个主题</span><br><span class="line">bin/kafka-topics.sh --zookeeper jiang:2181 --delete --topic first</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022194404938.png" alt="image-20211022194404938"></p>
<p>划线意思是，只有当配置文件里,设置为true才可以删除主题</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022194442334.png" alt="image-20211022194442334"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4.查看指定主题属性</span><br><span class="line">bin/kafka-topics.sh --zookeeper jiang:2181 --describe --topic first</span><br></pre></td></tr></table></figure>

<p>几个分区就有几行，副本数为几，replicas就有几列，</p>
<p>无论几个副本几个分区，leader只有1列</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022195053271.png" alt="image-20211022195053271"></p>
<h2 id="副本，分区"><a href="#副本，分区" class="headerlink" title="副本，分区"></a>副本，分区</h2><p>副本数不能大于服务器数，几台机器存几份</p>
<p>分区主要是做负载均衡的</p>
<p>当分区数》=机器数时，每个机器上至少有一个分区</p>
<h3 id="三个机器a，b，c，主题名d"><a href="#三个机器a，b，c，主题名d" class="headerlink" title="三个机器a，b，c，主题名d"></a>三个机器a，b，c，主题名d</h3><p>3个分区，3个副本</p>
<table>
<thead>
<tr>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody><tr>
<td>d0</td>
<td>d0</td>
<td>d0</td>
</tr>
<tr>
<td>d1</td>
<td>d1</td>
<td>d1</td>
</tr>
<tr>
<td>d2</td>
<td>d2</td>
<td>d2</td>
</tr>
</tbody></table>
<p>3个分区，2个副本</p>
<table>
<thead>
<tr>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody><tr>
<td>d0</td>
<td>d0</td>
<td></td>
</tr>
<tr>
<td>d1</td>
<td></td>
<td>d1</td>
</tr>
<tr>
<td></td>
<td>d2</td>
<td>d2</td>
</tr>
</tbody></table>
<p>4个分区，3个副本</p>
<table>
<thead>
<tr>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody><tr>
<td>d0</td>
<td>d0</td>
<td>d0</td>
</tr>
<tr>
<td>d</td>
<td>d</td>
<td>d1</td>
</tr>
<tr>
<td>d2</td>
<td>d2</td>
<td>d2</td>
</tr>
<tr>
<td>d3</td>
<td>d3</td>
<td>d3</td>
</tr>
</tbody></table>
<p>4个分区，1个副本，d3可能在任意一个机器上</p>
<table>
<thead>
<tr>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody><tr>
<td>d0</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>d1</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>d2</td>
</tr>
<tr>
<td>d3</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>2个分区，1个副本</p>
<table>
<thead>
<tr>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody><tr>
<td>d0</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>d1</td>
<td></td>
</tr>
</tbody></table>
<p>2个分区，2个副本,有一个机器有两个分区</p>
<table>
<thead>
<tr>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody><tr>
<td>d0</td>
<td></td>
<td>d0</td>
</tr>
<tr>
<td>d1</td>
<td>d1</td>
<td></td>
</tr>
</tbody></table>
<p>几个分区有几行</p>
<p>几个副本：dx就有几个</p>
<p>由此可见，多一个机器为了什么?为了备份，可以从另一个机器读，所以，一般几个机器就几个副本</p>
<h2 id="控制台命令"><a href="#控制台命令" class="headerlink" title="控制台命令"></a>控制台命令</h2><p>9092是kafka(broker)端口</p>
<p>开启控制台生产者</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list jiang:9092 --topic first</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>开启控制台消费者</p>
<p>(老)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --zookeeper jiang:2181 --topic first</span><br></pre></td></tr></table></figure>

<p>(新)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --bootstrap-server jiang:9092 --topic first</span><br></pre></td></tr></table></figure>

<p>–from-beginning：会把主题中以往所有的数据都读取出来。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --bootstrap-server jiang:9092 --topic first --from-beginning</span><br></pre></td></tr></table></figure>

<p>不加–from-beginning，只能读到消费者启动时，生产者发送的消息</p>
<p>加了可以从头读</p>
<h1 id="数据过期时间"><a href="#数据过期时间" class="headerlink" title="数据过期时间"></a>数据过期时间</h1><h4 id="kafka默认数据过期时间是7天"><a href="#kafka默认数据过期时间是7天" class="headerlink" title="kafka默认数据过期时间是7天"></a>kafka默认数据过期时间是7天</h4><h4 id="可以通过设置全局变量来设置-但是要针对每一台kafka去设置-并且修改完需要重启kafka"><a href="#可以通过设置全局变量来设置-但是要针对每一台kafka去设置-并且修改完需要重启kafka" class="headerlink" title="可以通过设置全局变量来设置,但是要针对每一台kafka去设置,并且修改完需要重启kafka"></a>可以通过设置全局变量来设置,但是要针对每一台kafka去设置,并且修改完需要重启kafka</h4><p>log.retention.hours=72 (配置该参数即可)<br>log.cleanup.policy=delete</p>
<p>  bin/kafka-server-stop.sh<br> bin/kafka-server-start.sh -daemon config/server.properties &amp;</p>
<h4 id="也可以针对某一个topic设置数据的过期时间-可以不需要重启kafka"><a href="#也可以针对某一个topic设置数据的过期时间-可以不需要重启kafka" class="headerlink" title="也可以针对某一个topic设置数据的过期时间,可以不需要重启kafka"></a>也可以针对某一个topic设置数据的过期时间,可以不需要重启kafka</h4><p>./kafka-configs.sh –zookeeper localhost:2181 –alter –entity-name testtopic –entity-type topics –add-config retention.ms=86400000</p>
<p>retention.ms=86400000 为一天，单位是毫秒。</p>
<h4 id="查看设置"><a href="#查看设置" class="headerlink" title="查看设置"></a>查看设置</h4><p>./kafka-configs.sh –zookeeper localhost:2181 –describe –entity-name testtopic –entity-type topics</p>
<p>Configs for topics:wordcounttopic are retention.ms=86400000</p>
<h4 id="如果数据没有立即删除-执行下面"><a href="#如果数据没有立即删除-执行下面" class="headerlink" title="如果数据没有立即删除,执行下面"></a>如果数据没有立即删除,执行下面</h4><p>./kafka-topics.sh –zookeeper localhost:2181 –alter –topic testtopic –config cleanup.policy</p>
<h1 id="数据日志分离"><a href="#数据日志分离" class="headerlink" title="数据日志分离"></a>数据日志分离</h1><p>先清零重置kafka</p>
<p>cd /opt/module/kakfa</p>
<p>rm -rf logs</p>
<p>停止zookeeper</p>
<p>cd /opt/module/zookeeper-3.5.7</p>
<p>bin/zkCli.sh </p>
<p>bin/zkServer.sh stop</p>
<p>清空zookeeper</p>
<p>cd zkData</p>
<p>rm -rf version-2</p>
<p>启动zk</p>
<p>bin/zkServer.sh start</p>
<p>bin/zkCli.sh </p>
<p>ls /</p>
<p>发现zookeeper上只有一个zookeeper节点</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025091726289.png" alt="image-20211025091726289"></p>
<p>可见，version-2存储zookeeper数据的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">修改kafka  config 里的server.properties</span><br><span class="line">把log.dirs结尾logs换成data</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025091940085.png" alt="image-20211025091940085"></p>
<p>启动kafka</p>
<p>bin/kafka-server-start.sh -daemon config/server.properties</p>
<p>创建主题以后才会自动生成data文件夹</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025092255758.png" alt="image-20211025092255758"></p>
<p>数据在data里，日志在logs里</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025092450881.png" alt="image-20211025092450881"></p>
<p>开启控制台生产者</p>
<p>bin/kafka-console-producer.sh –broker-list jiang:9092 –topic first</p>
<p>发送hello 和 jiang</p>
<p>分别cat data里first-0和first-1的00000000000000000000.log</p>
<p>发现序列化之后的消息</p>
<h1 id="offset"><a href="#offset" class="headerlink" title="offset"></a>offset</h1><p>只有以–bootstrap-server不以–zookeeper启动，才会在logs里生成_consumer_offsets</p>
<p>存在本地不是指在磁盘，而是在kafka里</p>
<p>分区主要是做负载均衡的</p>
<p>offect默认50个分区</p>
<p>每一个机器上的_consumer_offsets数目≈50/partitions数*该机器上的分区个数</p>
<p>并且是轮训的</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025100536691.png" alt="image-20211025100536691"></p>
<p>生产者消费者只找leader</p>
<p>只能保证区内有序，不能保证全局有序</p>
<p>以消费者组+主题+分区来确定唯一offect</p>
<h2 id="了解即可"><a href="#了解即可" class="headerlink" title="了解即可"></a>了解即可</h2><p>一个partition分为多个segment，每个分区维护自己的offect从0开始，而分区内连续的，如下图最右侧，0-11连续的，想找offect=3的消息，通过2分法找到segement-0，然后找到index为3的对应的偏移量756和保存的对应的数据大小比如1000，那么就会去log文件中找到756-1756的数据就是想要查找的数据</p>
<p>想找offect=7的消息，通过2分法找到segement-1（根据文件名，比如一个文件名6.log一个文件名15.log，肯定在6.log内），然后找到index为（7-6=1）的对应的偏移量198和保存的对应的数据大小比如1000，那么就会去log文件中找到198-1198的数据就是想要查找的数据</p>
<p>index第二列指的是物理偏移量，而log指的是逻辑偏移量</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025103446625.png" alt="image-20211025103446625"></p>
<h1 id="acks"><a href="#acks" class="headerlink" title="acks"></a>acks</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025110107203.png" alt="image-20211025110107203"></p>
<p>leader和follower同步完成，但是发送ack之前，leader挂了，那么就需要重新选取leader并重新发送消息，重复了</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025110752930.png" alt="image-20211025110752930"></p>
<h1 id="Exactly-Once精准一次性"><a href="#Exactly-Once精准一次性" class="headerlink" title="Exactly Once精准一次性"></a>Exactly Once精准一次性</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025112138969.png" alt="image-20211025112138969"></p>
<h1 id="分区分配策略"><a href="#分区分配策略" class="headerlink" title="分区分配策略"></a>分区分配策略</h1><p>前提是消费者必须在一个组里</p>
<p>range默认，是以主题分的</p>
<p>而RoundRobin是以组分的</p>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><p>zookeeper</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025133413174.png" alt="image-20211025133413174"></p>
<h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><p>kafka集群的老大（不关心）</p>
<p>谁先注册到节点谁就是controller老大</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025133452082.png" alt="image-20211025133452082"></p>
<h2 id="brokers"><a href="#brokers" class="headerlink" title="brokers"></a>brokers</h2><p>id</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025133600367.png" alt="image-20211025133600367"></p>
<p>topics主题</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025133617158.png" alt="image-20211025133617158"></p>
<h2 id="consumers"><a href="#consumers" class="headerlink" title="consumers"></a>consumers</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025133719706.png" alt="image-20211025133719706"></p>
<p>console-consumer-88502随机生成的消费者组</p>
<h1 id="API（重点！！！！）"><a href="#API（重点！！！！）" class="headerlink" title="API（重点！！！！）"></a>API（重点！！！！）</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025140542860.png" alt="image-20211025140542860"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025140828284.png" alt="image-20211025140828284"></p>
<p>main主线程，发送-拦截器-序列化器-分区器，最终消息到RecordAccumlator中，Sebder线程从总取出数据发送到kafka</p>
<p>发送不指定分区，有key按照key的哈希值发送分区</p>
<p>没有key轮训发送到不同的分区，比如10个数字，3个分区，那么1-4就是1个分区，5-7,8-10就是另外两个分区</p>
<p>注意1234发送到一个分区，而不是1,4,7,10一个分区</p>
<p>消费默认消费所有分区</p>
<p>消费指定分区</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">consumer.assign(Collections.singletonList(new TopicPartition(&quot;first&quot;,0)));</span><br></pre></td></tr></table></figure>

<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211109115038021.png" alt="image-20211109115038021"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>linux命令</title>
    <url>/2021/11/30/linux%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<p>Linux相关命令的总结，包括网络、操作系统、文件、脚本、环境配置</p>
<p><a href="https://blog.csdn.net/weixin_44895651/article/details/105289038?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163832130116780264075127%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163832130116780264075127&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-105289038.first_rank_v2_pc_rank_v29&amp;utm_term=linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%A4%A7%E5%85%A8&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/weixin_44895651/article/details/105289038?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163832130116780264075127%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163832130116780264075127&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-105289038.first_rank_v2_pc_rank_v29&amp;utm_term=linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%A4%A7%E5%85%A8&amp;spm=1018.2226.3001.4187</a></p>
<h1 id="网络相关"><a href="#网络相关" class="headerlink" title="网络相关"></a>网络相关</h1><ul>
<li>虚拟机网络配置模板</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 编辑正在使用的网卡，可以先进入到network-scripts目录下查看，ifconfig先看正在使用哪个网卡</span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line"># 文件模板</span><br><span class="line">TYPE=&quot;Ethernet&quot; # 不变</span><br><span class="line">BOOTPROTO=&quot;static&quot; # 静态的不用改</span><br><span class="line">NAME=&quot;ens33&quot; # 和文件名严格一致</span><br><span class="line">DEVICE=&quot;ens33&quot; # 和文件名严格一致</span><br><span class="line">ONBOOT=&quot;yes&quot; # 不用动</span><br><span class="line">IPADDR=&quot;192.168.25.160&quot; # 改成需要的ip，注意网段</span><br><span class="line">GATEWAY=&quot;192.168.25.2&quot; # 网关，可以先查下网关</span><br><span class="line">NETMASK=&quot;255.255.255.0&quot; # 不用动</span><br><span class="line">DNS1=&quot;114.114.114.114&quot; # dns自己配置能用的</span><br></pre></td></tr></table></figure>

<ul>
<li>查询正在使用的网关</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ip route show</span><br><span class="line">default via 192.168.25.2 dev ens33 proto static metric 100</span><br><span class="line">192.168.25.0/24 dev ens33 proto kernel scope link src 192.168.25.160 metric 100</span><br><span class="line"></span><br><span class="line"># 很明确的可以看到网关用的是192.168.25.2</span><br></pre></td></tr></table></figure>

<ul>
<li>重启网络</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service network restart</span><br></pre></td></tr></table></figure>

<ul>
<li>如果遇到主机无法解析问题，直接重启网络，因为可能是dns解析出问题了，重启刷新下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 一定要先重启NetworkManager，再重启network</span><br><span class="line"># NetworkManager服务是一个网络管理的守护线程</span><br><span class="line">systemctl restart  NetworkManager</span><br><span class="line">or</span><br><span class="line">解决方式：禁用NetworkManager</span><br><span class="line"></span><br><span class="line">1. systemctl stop NetworkManager</span><br><span class="line"></span><br><span class="line">2. systemctl disable NetworkManager</span><br><span class="line"></span><br><span class="line">最终</span><br><span class="line">systemctl restart  network</span><br></pre></td></tr></table></figure>

<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">如果没有防火墙命令</span><br><span class="line">yum install firewalld</span><br><span class="line"># 开启防火墙</span><br><span class="line">systemctl start firewalld.service</span><br><span class="line"># 防火墙开机启动</span><br><span class="line">systemctl enable firewalld.service</span><br><span class="line">查看防火墙状态：systemctl status firewalld.service </span><br><span class="line">关闭防火墙：systemctl stop firewalld.service </span><br><span class="line">永久关闭：systemctl disable firewalld.service</span><br><span class="line">查看开启的端口</span><br><span class="line">firewall-cmd --list-ports</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开启指定端口"><a href="#开启指定端口" class="headerlink" title="开启指定端口"></a>开启指定端口</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">先开启防火墙：systemctl start firewalld.service</span><br><span class="line"></span><br><span class="line">再开放8080端口：firewall-cmd --zone=public --add-port=8080/tcp --permanent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">再开放22端口：firewall-cmd --zone=public --add-port=22/tcp --permanent</span><br><span class="line">			</span><br><span class="line">最后刷新配置：systemctl reload firewalld</span><br></pre></td></tr></table></figure>

<h4 id="添加单个单端口"><a href="#添加单个单端口" class="headerlink" title="添加单个单端口"></a>添加单个单端口</h4><p>firewall-cmd –permanent –zone=public –add-port=81/tcp</p>
<h4 id="添加多个端口"><a href="#添加多个端口" class="headerlink" title="添加多个端口"></a>添加多个端口</h4><p>firewall-cmd –permanent –zone=public –add-port=8080-8083/tcp</p>
<h4 id="删除某个端口"><a href="#删除某个端口" class="headerlink" title="删除某个端口"></a>删除某个端口</h4><p>firewall-cmd –permanent –zone=public –remove-port=81/tcp</p>
<h3 id="关闭指定进程号"><a href="#关闭指定进程号" class="headerlink" title="关闭指定进程号"></a>关闭指定进程号</h3><p>kill -9 进程号PID</p>
<h3 id="查看端口有没有被占用"><a href="#查看端口有没有被占用" class="headerlink" title="查看端口有没有被占用"></a>查看端口有没有被占用</h3><p>netstat -tunlp|grep 端口号，有的话kill掉，或者改用其他端口</p>
<p>netstat -lnp | grep 端口号</p>
<p>netstat -anp | grep :端口号   也可以，注意有冒号</p>
<h3 id="执行jar包，通用脚本文件"><a href="#执行jar包，通用脚本文件" class="headerlink" title="执行jar包，通用脚本文件"></a>执行jar包，通用脚本文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">jar_pid=`ps -ef|grep -v grep | grep &#x27;example.jar&#x27;|awk &#x27;&#123; print $2 &#125;&#x27;`</span><br><span class="line">echo $jar_pid</span><br><span class="line">if [ ! -n &quot;$jar_pid&quot; ]; then</span><br><span class="line">echo &#x27;will redploy.&#x27;</span><br><span class="line"></span><br><span class="line">rm -rf nohup.out</span><br><span class="line">nohup java -Xms512m -Xmx2048m -Dspring.profiles.active=pro -jar example.jar &amp;</span><br><span class="line">echo &#x27;redploy success0.&#x27;</span><br><span class="line">else</span><br><span class="line">kill -9 $jar_pid</span><br><span class="line">echo &#x27;kill&#x27; $jar_pid</span><br><span class="line"></span><br><span class="line">rm -rf nohup.out</span><br><span class="line">nohup java -Xms512m -Xmx2048m -Dspring.profiles.active=pro -jar example.jar &amp;</span><br><span class="line">echo &#x27;redploy success1.&#x27;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h1 id="vim中命令"><a href="#vim中命令" class="headerlink" title="vim中命令"></a>vim中命令</h1><h2 id="复制粘贴"><a href="#复制粘贴" class="headerlink" title="复制粘贴"></a>复制粘贴</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">esc之后</span><br><span class="line">光标到要复制的行</span><br><span class="line">yy复制一行</span><br><span class="line">p粘贴1行</span><br><span class="line">5p粘贴5行</span><br></pre></td></tr></table></figure>

<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>dd删除一行</p>
<h2 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h2><p>/super  或者  ？super，  两者的区别是前者是从上往下搜索，后者是从下往上搜索。</p>
<p>通过 n  或  N 进行上一个或下一个的匹配</p>
<p>:nohl  取消高亮</p>
<h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><p>:%s/a/b/g 对所有行的内容进行替换,a替换为b。</p>
<h2 id="放弃修改"><a href="#放弃修改" class="headerlink" title="放弃修改"></a>放弃修改</h2><p>:e! -放弃所有修改，从上次保存文件开始再编辑</p>
<h2 id="回退"><a href="#回退" class="headerlink" title="回退"></a>回退</h2><p>u  撤销上一步的操作<br>Ctrl+r 恢复上一步被撤销的操作</p>
<h2 id="跳转到最后一行"><a href="#跳转到最后一行" class="headerlink" title="跳转到最后一行"></a>跳转到最后一行</h2><p>shift+g</p>
<h3 id="跳到行首"><a href="#跳到行首" class="headerlink" title="跳到行首"></a>跳到行首</h3><p>home</p>
<h3 id="跳到行尾"><a href="#跳到行尾" class="headerlink" title="跳到行尾"></a>跳到行尾</h3><p>end</p>
<h2 id="跳到下一行并插入"><a href="#跳到下一行并插入" class="headerlink" title="跳到下一行并插入"></a>跳到下一行并插入</h2><p>o</p>
<h1 id="重命名"><a href="#重命名" class="headerlink" title="重命名"></a>重命名</h1><p>把a移动到/home下并重名为b</p>
<p>mv a  /home/b </p>
<h1 id="创建和删除操作"><a href="#创建和删除操作" class="headerlink" title="创建和删除操作"></a>创建和删除操作</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">touch</span><br><span class="line">创建文件</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir</span><br><span class="line">创建一个新的目录</span><br><span class="line">-p	可以递归创建目录</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rm</span><br><span class="line">删除文件或目录</span><br><span class="line">使用 rm 命令要小心，因为文件删除后不能恢复</span><br><span class="line">-f	强制删除，忽略不存在的文件，无需提示</span><br><span class="line">-r	递归地删除目录下的内容，删除文件夹 时必须加此参数</span><br><span class="line"></span><br><span class="line">删除以a开头的所有文件</span><br><span class="line">rm -rf a*</span><br><span class="line"></span><br><span class="line">如果报错</span><br><span class="line">-bash: /usr/bin/rm: 参数列表过长</span><br><span class="line"></span><br><span class="line">1、rm * -rf 改为:</span><br><span class="line">find . -name &quot;*&quot; | xargs rm -rf &#x27;*&#x27; 就行了。</span><br><span class="line"></span><br><span class="line">2、rm test* -rf 改为:</span><br><span class="line">find . -name &quot;test*&quot; | xargs rm -rf &quot;test*&quot;</span><br></pre></td></tr></table></figure>

<h1 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h1><p>cp </p>
<p>-r  若给出的源文件是目录文件，则 cp 将递归复制该目录下的所有子目录和文件</p>
<h1 id="从u盘复制文件到linux中"><a href="#从u盘复制文件到linux中" class="headerlink" title="从u盘复制文件到linux中"></a>从u盘复制文件到linux中</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.插入U盘到计算机USB接口，这时候U盘的硬件名称为：sda1(不一定)</span><br><span class="line">2.在mnt目录下先建立一个usb的目录</span><br><span class="line">mkdir /mnt/usb</span><br><span class="line">3.挂载U盘，其中sda1是硬件名称</span><br><span class="line">mount -t vfat /dev/sda1 /mnt/usb</span><br><span class="line">4.复制文件到指定文件下</span><br><span class="line">cp -r ?? /opt/</span><br></pre></td></tr></table></figure>



<h1 id="查看服务对应的进程号"><a href="#查看服务对应的进程号" class="headerlink" title="查看服务对应的进程号"></a>查看服务对应的进程号</h1><p> ps -ef|grep redis</p>
<p>得到了进程号 xxxx</p>
<h2 id="查看文件位置"><a href="#查看文件位置" class="headerlink" title="查看文件位置"></a>查看文件位置</h2><p> 然后 ls -l /proc/xxxx/cwd</p>
<h1 id="修改主机名称"><a href="#修改主机名称" class="headerlink" title="修改主机名称"></a>修改主机名称</h1><p>hostnamectl set-hostname xxx</p>
<h1 id="为sh文件增加可执行权限"><a href="#为sh文件增加可执行权限" class="headerlink" title="为sh文件增加可执行权限"></a>为sh文件增加可执行权限</h1><p>到sh所在的目录</p>
<p>chmod +x *.sh </p>
<p>chmod +x ./你的程序</p>
<p>或把所有权限都加上：<br>chmod +777 ./你的程序</p>
<h1 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h1><p>-C 解压到指定目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xvfz nacos-server-2.0.1.tar.gz  -C  /opt/</span><br></pre></td></tr></table></figure>

<h1 id="查找文件命令"><a href="#查找文件命令" class="headerlink" title="查找文件命令"></a>查找文件命令</h1><p>find / -name “redis-trib.rb”</p>
<h1 id="配置任何环境变量"><a href="#配置任何环境变量" class="headerlink" title="配置任何环境变量"></a>配置任何环境变量</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">#KAFKA_HOME</span><br><span class="line">export KAFKA_HOME=/opt/kafka/kafka_2.12-0.10.2.1</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br><span class="line"></span><br><span class="line">#JAVA_HOME</span><br><span class="line">export JAVA_HOME=/usr/local/java/jdk1.8.0_131</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">#配置ZOOKEEPER环境变量</span><br><span class="line">export ZOOKEEPER_HOME=/opt/zookeeper/zookeeper-3.4.9</span><br><span class="line">export PATH=$PATH:$ZOOKEEPER_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h1 id="查看分区"><a href="#查看分区" class="headerlink" title="查看分区"></a>查看分区</h1><p>fdisk -l</p>
<h2 id="查看分区使用情况"><a href="#查看分区使用情况" class="headerlink" title="查看分区使用情况"></a>查看分区使用情况</h2><p>df -lh</p>
<h1 id="yum指定安装位置"><a href="#yum指定安装位置" class="headerlink" title="yum指定安装位置"></a>yum指定安装位置</h1><p>yum -c /etc/yum.conf –installroot=/usr/local –releasever=/  install love<br>该命令简单解释如下：</p>
<p>-c /etc/yum.conf                  表示指定yum配置文件地址</p>
<p>–installroot=/usr/local        表示指定自定义的安装目录</p>
<h2 id="需要签名"><a href="#需要签名" class="headerlink" title="需要签名"></a>需要签名</h2><p>后面加上  –nogpgcheck</p>
<p>查看纽扣</p>
<h1 id="运行jar包sh文件"><a href="#运行jar包sh文件" class="headerlink" title="运行jar包sh文件"></a>运行jar包sh文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">jar_pid=`ps -ef|grep -v grep | grep &#x27;你的jar包.jar&#x27;|awk &#x27;&#123; print $2 &#125;&#x27;`</span><br><span class="line">echo $jar_pid</span><br><span class="line">if [ ! -n &quot;$jar_pid&quot; ]; then</span><br><span class="line">echo &#x27;will redploy.&#x27;</span><br><span class="line"></span><br><span class="line">rm -rf nohup.out</span><br><span class="line">nohup java -Xms512m -Xmx2048m -Dspring.profiles.active=dev -jar 你的jar包.jar &amp;</span><br><span class="line">echo &#x27;redploy success0.&#x27;</span><br><span class="line">else</span><br><span class="line">kill -9 $jar_pid</span><br><span class="line">echo &#x27;kill&#x27; $jar_pid</span><br><span class="line"></span><br><span class="line">rm -rf nohup.out</span><br><span class="line">nohup java -Xms512m -Xmx2048m -Dspring.profiles.active=dev -jar 你的jar包.jar &amp;</span><br><span class="line">echo &#x27;redploy success1.&#x27;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出500行</p>
<p>tail -f 500 nohup.out</p>
<h1 id="Linux-下通过-java-命令启动-jar-包的几种常见方式"><a href="#Linux-下通过-java-命令启动-jar-包的几种常见方式" class="headerlink" title="Linux 下通过 java 命令启动 jar 包的几种常见方式"></a><a href="https://so.csdn.net/so/search?from=pc_blog_highlight&q=Linux">Linux</a> 下通过 java 命令启动 jar 包的几种常见方式</h1><h2 id="方法一：直接启动-jar-包"><a href="#方法一：直接启动-jar-包" class="headerlink" title="方法一：直接启动 jar 包"></a><strong>方法一：直接启动 jar 包</strong></h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar XXX.jar</span><br><span class="line">当前ssh窗口会被锁定，不能再操作其他命令，如果需要执行其他命令，则需要打断进程，可按CTRL + C打断程序运行，或直接关闭窗口，程序也会退出。</span><br></pre></td></tr></table></figure>

<h2 id="方法二：后台启动-jar-包"><a href="#方法二：后台启动-jar-包" class="headerlink" title="方法二：后台启动 jar 包"></a><strong>方法二：后台启动 jar 包</strong></h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar XXX.jar &amp;</span><br><span class="line">当前ssh窗口不被锁定，但是当窗口关闭时，程序中止运行。</span><br></pre></td></tr></table></figure>

<h2 id="方法三：后台不挂断启动"><a href="#方法三：后台不挂断启动" class="headerlink" title="方法三：后台不挂断启动"></a>方法三：后台不挂断启动</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nohup java -jar XXX.jar &amp;</span><br></pre></td></tr></table></figure>

<p>用 nohub 命令启动 jar 包，是在后台不挂断运行，关闭终端窗口或者 CTRL + C 命令也不会终止程序。<br>当用 nohub命令启动 jar 包的时候，如果不指定日志输出文件，则所有的输出都会被重定向到 nohup.out 的文件中。</p>
<h2 id="方式四：指定日志输出的启动"><a href="#方式四：指定日志输出的启动" class="headerlink" title="方式四：指定日志输出的启动"></a>方式四：指定日志输出的启动</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nohup java -jar XXX.jar &gt;log.out &amp;</span><br></pre></td></tr></table></figure>


<p>通过 &gt;log.out 命令，将程序的日志输出重定向到 log.out 文件中。如果不指定日志输出文件，则会输出到 nohup 命令默认的输出文件，nohup.out 文件中。</p>
<h2 id="方式五：指定配置文件启动"><a href="#方式五：指定配置文件启动" class="headerlink" title="方式五：指定配置文件启动"></a><strong>方式五：指定配置文件启动</strong></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup java -jar XXX.jar --spring.profiles.active=pro &gt;log.out &amp;</span><br></pre></td></tr></table></figure>

<p>通过 –spring profiles.active=pro 来指定，启动的的是application-pro.yml 或者 application-pro.properties 配置文件。</p>
<h2 id="方式六：指定配置文件，使用系统默认的log配置，不另行指定日志输入"><a href="#方式六：指定配置文件，使用系统默认的log配置，不另行指定日志输入" class="headerlink" title="方式六：指定配置文件，使用系统默认的log配置，不另行指定日志输入"></a>方式六：指定配置文件，使用系统默认的log配置，不另行指定日志输入</h2><p>启动/opt/a/目录下的 test.jar ,配置文件使用 pro，日志使用配置文件默认配置，不单独指定。</p>
<p>nohup java -jar /opt/a/a.jar –spring.profiles.active=pro &gt;/dev/null 2&gt;&amp;1 &amp;</p>
<p>常见的文件描述符有如下：</p>
<p>0 ：stdin（标准输入）<br>1 ：stdout（标准输出）<br>2 ：stderr（标准错误）<br>2&gt; /dev/null</p>
<blockquote>
<p>代表重定向操作。将标准错误重定向到/dev/null ，即不输出错误信息。<br>/dev/null 2&gt;&amp;1 &amp; : 等同于 1&gt;/dev/null 2&gt;&amp;1 &amp;， 即把标准输出重定向到/dev/null，并且把标准错误2重定向标准输出1，即标准输出和标准错误都输出到 /dev/null。</p>
</blockquote>
<h2 id="方式七：指定分配系统资源大小"><a href="#方式七：指定分配系统资源大小" class="headerlink" title="方式七：指定分配系统资源大小"></a>方式七：指定分配系统资源大小</h2><p>nohup java -Xms500m -Xmx500m -jar XXX.jar –spring.profiles.active=dev &gt;log.out &amp;</p>
<h1 id="解决window与linux换行符不一致的问题"><a href="#解决window与linux换行符不一致的问题" class="headerlink" title="解决window与linux换行符不一致的问题"></a>解决window与linux换行符不一致的问题</h1><p>sed -i ‘s/\r$//‘ *.sh</p>
<h1 id="定时任务添加"><a href="#定时任务添加" class="headerlink" title="定时任务添加"></a>定时任务添加</h1><p>1.准备执行脚本<br>2.编辑定时任务文件<br>crontab -e<br>先定一小时执行一次<br>*/60 * * * * cd /home/boco/nantong/TrafficCollector &amp;&amp; sh gantry_start.sh</p>
<p>3.到 cat  /var/spool/mail/root可以查看定时任务执行情况</p>
<p>4.如果报错java not found，在每一个.sh，如ping_start.sh上加上以下两行<br>#!/bin/bash<br>source /etc/profile</p>
<h1 id="rz-command-not-found"><a href="#rz-command-not-found" class="headerlink" title="rz: command not found"></a>rz: command not found</h1><p>yum install lrzsz -y</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux命令</tag>
      </tags>
  </entry>
  <entry>
    <title>map-bean</title>
    <url>/2021/11/30/map-bean/</url>
    <content><![CDATA[<p>hutools工具<br>BeanUtil<br>BeanUtil.mapToBean();<br>BeanUtil.toBean();<br>BeanUtil.beanToMap()</p>
<h1 id="遍历map"><a href="#遍历map" class="headerlink" title="遍历map"></a>遍历map</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for(Map.Entry&lt;String,Object&gt; entry:map.entrySet())&#123;</span><br><span class="line">    String key=entry.getKey();</span><br><span class="line">    System.out.println(key+&quot;:&quot;+map.get(key));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>map-bean</tag>
      </tags>
  </entry>
  <entry>
    <title>maven</title>
    <url>/2021/11/30/maven/</url>
    <content><![CDATA[<h1 id="1-坐标属性"><a href="#1-坐标属性" class="headerlink" title="1.坐标属性"></a>1.坐标属性</h1><p><img src="/../img/image-20211229202337423.png" alt="image-20211229202337423"></p>
<h1 id="2-安装配置"><a href="#2-安装配置" class="headerlink" title="2.安装配置"></a>2.安装配置</h1><p>配置环境变量</p>
<p><img src="/../img/image-20211230193549500.png" alt="image-20211230193549500"></p>
<p>新建，值为maven的bin目录</p>
<p><img src="/../img/image-20211230193827252.png" alt="image-20211230193827252"></p>
<p>编辑PATH</p>
<p><img src="/../img/image-20211230193809757.png" alt="image-20211230193809757"></p>
<p>验证</p>
<p>mvn -v</p>
<p><img src="/../img/image-20211230193902894.png" alt="image-20211230193902894"></p>
<h1 id="3-maven的目录结构"><a href="#3-maven的目录结构" class="headerlink" title="3.maven的目录结构"></a>3.maven的目录结构</h1><p><img src="/../img/image-20211230194114945.png" alt="image-20211230194114945"></p>
<p><img src="/../img/image-20211230194459365.png" alt="image-20211230194459365"></p>
<h1 id="4-Setting-xml"><a href="#4-Setting-xml" class="headerlink" title="4.Setting.xml"></a>4.Setting.xml</h1><p>我们在编译项目时，会从maven仓库下载jar包</p>
<p>需要将中央仓库地址换位国内albaba镜像</p>
<p>会下载到本地仓库</p>
<p>所以要修改setting.xml配置文件</p>
<h1 id="5-maven命令执行main方法"><a href="#5-maven命令执行main方法" class="headerlink" title="5.maven命令执行main方法"></a>5.maven命令执行main方法</h1><p><img src="/../img/image-20211230195316345.png" alt="image-20211230195316345"></p>
<h1 id="6-maven命令"><a href="#6-maven命令" class="headerlink" title="6.maven命令"></a>6.maven命令</h1><p><img src="/../img/image-20211230195527505.png" alt="image-20211230195527505"></p>
<p><img src="/../img/image-20211230195755313.png" alt="image-20211230195755313"></p>
<p><img src="/../img/image-20211230195940846.png" alt="image-20211230195940846"></p>
<p><img src="/../img/image-20211230195946176.png" alt="image-20211230195946176"></p>
<h1 id="7-idea集成maven"><a href="#7-idea集成maven" class="headerlink" title="7.idea集成maven"></a>7.idea集成maven</h1><p><img src="/../img/image-20211230200242329.png" alt="image-20211230200242329"></p>
<p>settings：只在本项目中有效</p>
<p>Other Settings：idea全有效</p>
<p><img src="/../img/image-20211230200347538.png" alt="image-20211230200347538"></p>
<h1 id="8-创建maven项目"><a href="#8-创建maven项目" class="headerlink" title="8.创建maven项目"></a>8.创建maven项目</h1><p>如果没有生成resources目录，自己手动创建</p>
<p>src下的选Resources Root</p>
<p>test下的选Test Resources Root</p>
<p><img src="/../img/image-20211230200756011.png" alt="image-20211230200756011"></p>
<h1 id="9-maven仓库"><a href="#9-maven仓库" class="headerlink" title="9.maven仓库"></a>9.maven仓库</h1><p><img src="/../img/image-20211230201215493.png" alt="image-20211230201215493"></p>
<h2 id="中央仓库"><a href="#中央仓库" class="headerlink" title="中央仓库"></a>中央仓库</h2><p><img src="/../img/image-20211230201256147.png" alt="image-20211230201256147"></p>
<h2 id="私服"><a href="#私服" class="headerlink" title="私服"></a>私服</h2><p><img src="/../img/image-20211230201918689.png" alt="image-20211230201918689"></p>
<p><img src="/../img/image-20211230201924937.png" alt="image-20211230201924937"></p>
<h1 id="10-maven依赖"><a href="#10-maven依赖" class="headerlink" title="10.maven依赖"></a>10.maven依赖</h1><h2 id="1-控制台报错"><a href="#1-控制台报错" class="headerlink" title="1.控制台报错"></a>1.控制台报错</h2><p><img src="/../img/image-20211016102902390.png" alt="image-20211016102902390"></p>
<p>注释掉jdbc和mybatis</p>
<p><img src="/../img/image-20211016102924624.png" alt="image-20211016102924624"></p>
<h2 id="2-如果本项目，和父项目引用了同一个包不同版本，会报错？"><a href="#2-如果本项目，和父项目引用了同一个包不同版本，会报错？" class="headerlink" title="2.如果本项目，和父项目引用了同一个包不同版本，会报错？"></a>2.如果本项目，和父项目引用了同一个包不同版本，会报错？</h2><p>不会报错，本项目会使用本项目的版本</p>
<h2 id="3-同一个pom内引用了同一个包不同版本会报错？"><a href="#3-同一个pom内引用了同一个包不同版本会报错？" class="headerlink" title="3.同一个pom内引用了同一个包不同版本会报错？"></a>3.同一个pom内引用了同一个包不同版本会报错？</h2><p><img src="/../img/image-20211016103242673.png" alt="image-20211016103242673"></p>
<p>不会报错，会使用下面的版本</p>
<h2 id="4-当本项目依赖a和b项目，a项目web版-2-5-5-b项目web版本2-4-10，会报错？"><a href="#4-当本项目依赖a和b项目，a项目web版-2-5-5-b项目web版本2-4-10，会报错？" class="headerlink" title="4.当本项目依赖a和b项目，a项目web版 2.5.5,b项目web版本2.4.10，会报错？"></a>4.当本项目依赖a和b项目，a项目web版 2.5.5,b项目web版本2.4.10，会报错？</h2><p>不一定，看a的web与b的web如果版本不一致但是无冲突，就没事，有冲突那就出现冲突</p>
<p><img src="/../img/image-20211016164017206.png" alt="image-20211016164017206"></p>
<p><img src="/../img/image-20211016164040095.png" alt="image-20211016164040095"></p>
<h2 id="5-排除父工程的某个依赖"><a href="#5-排除父工程的某个依赖" class="headerlink" title="5.排除父工程的某个依赖"></a>5.排除父工程的某个依赖</h2><p>父项目有a，b，子项目默认会全部依赖</p>
<p>如果只想依赖a，并且父项目不可以改的话</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zyt<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>..<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>父项目可以改的话，加optional即可</p>
<p><img src="/../img/image-20211016110507992.png" alt="image-20211016110507992"></p>
<p><img src="/../img/image-20211016110537664.png" alt="image-20211016110537664"></p>
<p><img src="/../img/image-20211016110558557.png" alt="image-20211016110558557"></p>
<h2 id="6-scope"><a href="#6-scope" class="headerlink" title="6.scope"></a>6.scope</h2><h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><p><img src="/../img/image-20211016104222968.png" alt="image-20211016104222968"></p>
<p><strong>注意scope为test时，默认不自动依赖</strong></p>
<p><img src="/../img/image-20211016110744221.png" alt="image-20211016110744221"></p>
<h3 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h3><p><img src="/../img/image-20211016110209237.png" alt="image-20211016110209237"></p>
<h3 id="provided"><a href="#provided" class="headerlink" title="provided"></a>provided</h3><p>打包不会打这个依赖</p>
<h2 id="7-dependencies变灰色"><a href="#7-dependencies变灰色" class="headerlink" title="7.dependencies变灰色"></a>7.dependencies变灰色</h2><p><img src="/../img/image-20211016104537375.png" alt="image-20211016104537375"></p>
<p>灰色应该是父工程里的包scope是test</p>
<h2 id="8-依赖冲突愿意以及解决"><a href="#8-依赖冲突愿意以及解决" class="headerlink" title="8.依赖冲突愿意以及解决"></a>8.依赖冲突愿意以及解决</h2><p>原因：比如A依赖B，而B依赖一个名叫C版本1.0的包，并且C有一个get方法（）</p>
<p>A又导入了一个C版本2.0的包，并且2.0里没有get方法了，根据最短路径原则，会使用C2.0版本，</p>
<p>所以启动A的时候就会报错，因为A依赖B的里面不能在使用get方法了，此时就需降低到有get方法的版本</p>
<p><a href="https://blog.csdn.net/noaman_wgs/article/details/81137893?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=maven%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-81137893.first_rank_v2_pc_rank_v29&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/noaman_wgs/article/details/81137893?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=maven%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-81137893.first_rank_v2_pc_rank_v29&amp;spm=1018.2226.3001.4187</a></p>
<p><img src="/../img/image-20211016165350494.png" alt="image-20211016165350494"></p>
<p><img src="/../img/image-20211016165403502.png" alt="image-20211016165403502"></p>
<h3 id="优先例子"><a href="#优先例子" class="headerlink" title="优先例子"></a>优先例子</h3><p>在第4个问题里，路径是一样的，都是两层，而上面优先声明，所以使用上方的！！</p>
<h2 id="9-idea解决"><a href="#9-idea解决" class="headerlink" title="9.idea解决"></a>9.idea解决</h2><p>maven helper</p>
<p><a href="https://blog.csdn.net/fnwibwj/article/details/81709733?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163461551716780269819798%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163461551716780269819798&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-81709733.first_rank_v2_pc_rank_v29&amp;utm_term=idea+Maven%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81%E7%9A%84%E4%B8%A4%E7%A7%8D%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/fnwibwj/article/details/81709733?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163461551716780269819798%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163461551716780269819798&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-81709733.first_rank_v2_pc_rank_v29&amp;utm_term=idea+Maven%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81%E7%9A%84%E4%B8%A4%E7%A7%8D%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F&amp;spm=1018.2226.3001.4187</a></p>
<h1 id="11-optional"><a href="#11-optional" class="headerlink" title="11.optional"></a>11.optional</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">当project-A 依赖project-B,  project-B 依赖project-D时</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;sample.ProjectD&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;ProjectD&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">  &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">所以当project-B的&lt;optional&gt;true&lt;/optional&gt;时, project-A中如果没有显式的引入project-D, 则project-A不依赖project-D, 即project-A可以自己选择是否依赖project-D</span><br><span class="line">默认&lt;optional&gt;的值为false, 及子项目必须依赖</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="12-lib包的使用"><a href="#12-lib包的使用" class="headerlink" title="12.lib包的使用"></a>12.lib包的使用</h1><p>在项目根目录下创建lib包</p>
<p>把要使用的jar包移动进去</p>
<p>pom里，${basedir}/lib/你的.jar,默认打包时不会打这个jar包</p>
<p><img src="/../img/image-20220101172241427.png" alt="image-20220101172241427"></p>
<p>想打system的包添加插件</p>
<p><img src="/../img/image-20220101172711293.png" alt="image-20220101172711293"></p>
<h1 id="13-dependencyManagement"><a href="#13-dependencyManagement" class="headerlink" title="13.dependencyManagement"></a>13.dependencyManagement</h1><p>只有子类显示的引入了，才会引入，并且子类不用写版本号，由父工程统一管理</p>
<h1 id="14-插件maven-dependency-plugin"><a href="#14-插件maven-dependency-plugin" class="headerlink" title="14.插件maven-dependency-plugin"></a>14.插件maven-dependency-plugin</h1><p><a href="https://blog.csdn.net/u011781521/article/details/79055605?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164103054216780357287989%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164103054216780357287989&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-79055605.pc_search_result_cache&amp;utm_term=maven-dependency-plugin&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/u011781521/article/details/79055605?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164103054216780357287989%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164103054216780357287989&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-79055605.pc_search_result_cache&amp;utm_term=maven-dependency-plugin&amp;spm=1018.2226.3001.4187</a></p>
<h1 id="15-搭建私服"><a href="#15-搭建私服" class="headerlink" title="15.搭建私服"></a>15.搭建私服</h1><p><img src="/../img/image-20220101205619353.png" alt="image-20220101205619353"></p>
<p>Public Repositories不是一个仓库，但是访问此对应的路径可以访问到</p>
<p>画框左侧所有的仓库，可配置</p>
<p><a href="http://192.168.214.130:8081/nexus/content/groups/public/">http://192.168.214.130:8081/nexus/content/groups/public/</a></p>
<p><img src="/../img/image-20220101211833137.png" alt="image-20220101211833137"></p>
<h2 id="默认账号："><a href="#默认账号：" class="headerlink" title="默认账号："></a>默认账号：</h2><p>admin/admin123</p>
<p>deployment/deployment123</p>
<h2 id="nexus-仓库介绍"><a href="#nexus-仓库介绍" class="headerlink" title="nexus 仓库介绍"></a>nexus 仓库介绍</h2><h3 id="3rd-party：第三方仓库"><a href="#3rd-party：第三方仓库" class="headerlink" title="3rd party：第三方仓库"></a>3rd party：第三方仓库</h3><p>第三方包，既不是本地的，也不是maven官方的，比如另一个公司的包，可以放在这里</p>
<h3 id="Apache-Snapshots：apache-快照仓库"><a href="#Apache-Snapshots：apache-快照仓库" class="headerlink" title="Apache Snapshots：apache 快照仓库"></a>Apache Snapshots：apache 快照仓库</h3><h3 id="Central-maven-中央仓库"><a href="#Central-maven-中央仓库" class="headerlink" title="Central: maven 中央仓库"></a>Central: maven 中央仓库</h3><p>maven官方有的放在此项目下</p>
<h3 id="Releases：私有发布版本仓库"><a href="#Releases：私有发布版本仓库" class="headerlink" title="Releases：私有发布版本仓库"></a>Releases：私有发布版本仓库</h3><p>公司的框架包</p>
<h3 id="Snapshots：私有-快照版本仓库"><a href="#Snapshots：私有-快照版本仓库" class="headerlink" title="Snapshots：私有 快照版本仓库"></a>Snapshots：私有 快照版本仓库</h3><h2 id="settings"><a href="#settings" class="headerlink" title="settings"></a>settings</h2><p><a href="https://blog.csdn.net/weixin_43740223/article/details/114253461?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;utm_relevant_index=2">https://blog.csdn.net/weixin_43740223/article/details/114253461?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&amp;utm_relevant_index=2</a></p>
<h3 id="servers"><a href="#servers" class="headerlink" title="servers"></a>servers</h3><p>deploy时，上传jar包需要权限</p>
<p><img src="/../img/image-20220101223057142.png" alt="image-20220101223057142"></p>
<p>版本为release结尾的，上传到releases库</p>
<p>版本为snapshot结尾的，上传到snapshots库</p>
<h1 id="16、通过私服，获取依赖包，共三步"><a href="#16、通过私服，获取依赖包，共三步" class="headerlink" title="16、通过私服，获取依赖包，共三步"></a>16、通过私服，获取依赖包，共三步</h1><h2 id="第1步：编辑maven安装目录settings-xml文件"><a href="#第1步：编辑maven安装目录settings-xml文件" class="headerlink" title="第1步：编辑maven安装目录settings.xml文件"></a>第1步：编辑maven安装目录settings.xml文件</h2><p><em><mirror></mirror></em></p>
<p>​    <em><id>nexus</id></em></p>
<p>​    <em><mirrorOf>*</mirrorOf></em>            <em><url><a href="http://10.10.2.192:8081/nexus/content/groups/public/">http://10.10.2.192:8081/nexus/content/groups/public/</a></url></em></p>
<p><em></em></p>
<p><img src="/../img/wps1-1646705531933.jpg" alt="img"> </p>
<h2 id="第2步：在eclipse中配置-settings-xml-文件"><a href="#第2步：在eclipse中配置-settings-xml-文件" class="headerlink" title="*第2步：在eclipse中配置**settings.xml**文件*"></a><em><strong>*第2步：在eclipse中配置*</strong></em><em><strong>*settings.xml*</strong></em><em><strong>*文件*</strong></em></h2><p>打开WindowàPreferencesàMavenàUser Setting与 Global Settings中，选择第1步编辑的settings.xml文件</p>
<p><img src="/../img/wps2-1646705531934.jpg" alt="img"> </p>
<h2 id="第3步：Eclipse中执行Maven-Update"><a href="#第3步：Eclipse中执行Maven-Update" class="headerlink" title="*第3步：Eclipse中执行Maven Update*"></a><em><strong>*第3步：Eclipse中执行Maven Update*</strong></em></h2><h2 id="2、更新私服中Jar包的方法（指定人员维护），两种方式"><a href="#2、更新私服中Jar包的方法（指定人员维护），两种方式" class="headerlink" title="*2、更新私服中Jar包的方法（指定人员维护），两种方式*"></a><em><strong>*2、更新私服中Jar包的方法（指定人员维护），两种方式*</strong></em></h2><p>说明：大家共用私服中的jar包，所以只能更新发布的版本，不可以私自上传临时Jar，会对别人造成影响！</p>
<h2 id="1、Maven指令方式"><a href="#1、Maven指令方式" class="headerlink" title="*1、Maven指令方式*"></a><em><strong>*1、Maven指令方式*</strong></em></h2><p>配置settings.xml，通过Maven的deploy指令方式：</p>
<p>配置settings.xml</p>
<p><em><server></server></em></p>
<p>​    <em><id>releases</id></em></p>
<p>​    <em><username>deployment</username></em></p>
<p>​    <em><password>deployment123</password></em></p>
<p><em></em></p>
<p><em><server></server></em></p>
<p>​    <em><id>snapshots</id></em></p>
<p>​    <em><username>deployment</username></em></p>
<p>​    <em><password>deployment123</password></em></p>
<p><em></em></p>
<p><img src="/../img/wps3-1646705531935.jpg" alt="img"> </p>
<p>执行maven deploy指令（有维护指令脚本）。</p>
<h2 id="2、登陆私服系统方式："><a href="#2、登陆私服系统方式：" class="headerlink" title="*2、登陆私服系统方式：*"></a><em><strong>*2、登陆私服系统方式：*</strong></em></h2><p>访问：<a href="http://10.10.2.192:8081/nexus/#welcome">http://10.10.2.192:8081/nexus/#welcome</a></p>
<p>账号：admin</p>
<p>密码：admin123</p>
<h3 id="2-1查看已经上传的Jar包"><a href="#2-1查看已经上传的Jar包" class="headerlink" title="*2.1查看已经上传的Jar包*"></a><em><strong>*2.1查看已经上传的Jar包*</strong></em></h3><p><img src="/../img/wps4-1646705531936.jpg" alt="img"> </p>
<p>release：正式发布的版本仓库</p>
<p>Public：是maven主库</p>
<p>3rd party：第三方仓库</p>
<h3 id="2-2上传jar包到私服（以添加第三方jar为例）"><a href="#2-2上传jar包到私服（以添加第三方jar为例）" class="headerlink" title="*2.2上传jar包到私服（以添加第三方jar为例）*"></a><em><strong>*2.2上传jar包到私服（以添加第三方jar为例）*</strong></em></h3><p>两种添加方式：From POM和GAV Parameters</p>
<p><img src="/../img/wps5-1646705531935.jpg" alt="img"> </p>
<h4 id="2-2-1-From-Pom方式上传："><a href="#2-2-1-From-Pom方式上传：" class="headerlink" title="2.2.1 From Pom方式上传："></a><strong>2.2.1 From Pom方式上传：</strong></h4><p><img src="/../img/wps6.jpg" alt="img"> </p>
<h4 id="2-2-2-GAV-Parameters上传方式："><a href="#2-2-2-GAV-Parameters上传方式：" class="headerlink" title="2.2.2 GAV Parameters上传方式："></a><strong>2.2.2 GAV Parameters上传方式：</strong></h4><p><img src="/../img/wps7.jpg" alt="img"> </p>
<p><img src="/../img/wps8.jpg" alt="img"> </p>
<p>注意：此方法需要单独在pom文件中添加此包的依赖，推荐第一种。</p>
]]></content>
      <categories>
        <category>maven</category>
      </categories>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>分页</title>
    <url>/2021/11/30/mybatis-mybatisplus%E5%88%86%E9%A1%B5/</url>
    <content><![CDATA[<h1 id="mybatis分页"><a href="#mybatis分页" class="headerlink" title="mybatis分页"></a>mybatis分页</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;pagehelper&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.10&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        或者，应该用下面的</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;!-- 特别注意版本问题, 看到评论以后得以纠正 --&gt;</span><br><span class="line">            &lt;version&gt;1.2.3&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">application.yml文件:</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">pagehelper:</span></span><br><span class="line">	<span class="attr">helper-dialect:</span> <span class="string">mysql</span></span><br><span class="line">	<span class="attr">params:</span> <span class="string">count=istotal</span></span><br><span class="line">	<span class="attr">reasonable:</span> <span class="literal">true</span></span><br><span class="line">	<span class="attr">support-methods-arguments:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>helper-dialect:</p>
<p>配置使用哪种数据库语言，不配置的话pageHelper也会自动检测</p>
<p>·reasonable:</p>
<p>配置分页参数合理化功能，默认是false。 #启用合理化时，如果pageNum&lt;1会查询第一页，如果pageNum&gt;总页数会查询最后一页； #禁用合理化时，如果pageNum&lt;1或pageNum&gt;总页数会返回空数据。</p>
<p>·params:</p>
<p>为了支持startPage(Object params)方法，增加了该参数来配置参数映射，用于从对象中根据属性名取值; 可以配置 pageNum,pageSize,count,pageSizeZero,reasonable，不配置映射的用默认值， 默认值为pageNum=pageNum;pageSize=pageSize;count=countSql;reasonable=reasonable;pageSizeZero=pageSizeZero。</p>
<p>·support-methods-arguments:</p>
<p>支持通过Mapper接口参数来传递分页参数，默认值false，分页插件会从查询方法的参数值中，自动根据上面 params 配置的字段中取值，查找到合适的值时就会自动分页。</p>
<p>写一个pageQO</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private int pageSize = 0;//每页数量</span><br><span class="line">private int pageIndex = 0;//第几页</span><br><span class="line">private boolean isTotal = false;//是否分页返回数量</span><br></pre></td></tr></table></figure>

<p>查询参数类都继承pageQO</p>
<p>Serviceimpl</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public Page&lt;User&gt; getUserList()&#123;</span><br><span class="line">// 分页设置</span><br><span class="line">Page&lt;User&gt; page = PageHelper.startPage(param.getPageIndex(),</span><br><span class="line">        param.getPageSize(), param.getIsTotal());</span><br><span class="line">// 数据查询</span><br><span class="line">//ArrayList&lt;User&gt; list =mapper.getData(param);</span><br><span class="line">mapper.getData(param);</span><br><span class="line">return page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">这里不用ArrayList&lt;User&gt; list，因为page对象在mapper后就会查询出数据，用getResult()，</span><br></pre></td></tr></table></figure>

<p>Controller</p>
<p>Page<User> page=service.getUserList();</User></p>
<p>return page;</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210827152834807.png" alt="image-20210827152834807"></p>
<h2 id="1-直接返回page"><a href="#1-直接返回page" class="headerlink" title="1.直接返回page"></a>1.直接返回page</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211019135336499.png" alt="image-20211019135336499"></p>
<h2 id="2-在封装一次返回"><a href="#2-在封装一次返回" class="headerlink" title="2.在封装一次返回"></a>2.在封装一次返回</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211019135420844.png" alt="image-20211019135420844"></p>
<h1 id="mybatis-plus分页"><a href="#mybatis-plus分页" class="headerlink" title="mybatis-plus分页"></a>mybatis-plus分页</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mybatis-plus:</span><br><span class="line">  configuration:</span><br><span class="line">    map-underscore-to-camel-case: false #开启驼峰功能</span><br><span class="line">  mapper-locations: classpath:/mapper/*.xml #mapper.xml文件默认位置</span><br></pre></td></tr></table></figure>

<h2 id="写一个配置类config"><a href="#写一个配置类config" class="headerlink" title="写一个配置类config"></a>写一个配置类config</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.mybatisplus.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Spring boot方式</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.jiang.mybatisplus&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最新版</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> PaginationInnerInterceptor(DbType.H2));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="EmployeeMapper"><a href="#EmployeeMapper" class="headerlink" title="EmployeeMapper"></a>EmployeeMapper</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.mybatisplus.mapper;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line">import com.jiang.mybatisplus.pojo.Employee;</span><br><span class="line">import org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/08/24  16:44</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@Mapper</span><br><span class="line">public interface EmployeeMapper extends BaseMapper&lt;Employee&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IEmployeeService"><a href="#IEmployeeService" class="headerlink" title="IEmployeeService"></a>IEmployeeService</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.mybatisplus.service;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line">import com.jiang.mybatisplus.pojo.Employee;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/08/27  14:28</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:继承mybatisplus的接口IService&lt;T&gt;,T是要操作的pojo类</span><br><span class="line"> */</span><br><span class="line">public interface IEmployeeService extends IService&lt;Employee&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="EmployeeServiceImpl"><a href="#EmployeeServiceImpl" class="headerlink" title="EmployeeServiceImpl"></a>EmployeeServiceImpl</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.mybatisplus.service.impl;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line">import com.jiang.mybatisplus.mapper.EmployeeMapper;</span><br><span class="line">import com.jiang.mybatisplus.pojo.Employee;</span><br><span class="line">import com.jiang.mybatisplus.service.IEmployeeService;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/08/27  14:29</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:实现自己的Service，并继承mybatisPlus的类ServiceImpl&lt;a,b&gt;，a是要操作的mapper，b是pojo类</span><br><span class="line"> */</span><br><span class="line">@Service</span><br><span class="line">public class EmployeeServiceImpl extends ServiceImpl&lt;EmployeeMapper, Employee&gt; implements IEmployeeService &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.mybatisplus;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">import com.baomidou.mybatisplus.core.metadata.IPage;</span><br><span class="line">import com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line">import com.jiang.mybatisplus.mapper.EmployeeMapper;</span><br><span class="line">import com.jiang.mybatisplus.pojo.Employee;</span><br><span class="line"></span><br><span class="line">import com.jiang.mybatisplus.service.IEmployeeService;</span><br><span class="line">import com.jiang.mybatisplus.service.impl.EmployeeServiceImpl;</span><br><span class="line">import org.junit.jupiter.api.Test;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@SpringBootTest</span><br><span class="line">class MybatisPlusApplicationTests &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private EmployeeServiceImpl service;</span><br><span class="line">    @Test</span><br><span class="line">    void contextLoads() &#123;</span><br><span class="line">        IPage&lt;Employee&gt; ipage=new Page&lt;&gt;(1,2);</span><br><span class="line">        IPage&lt;Employee&gt; page = service.page(ipage);</span><br><span class="line">        page.getRecords();</span><br><span class="line">        System.out.println(page.getRecords());</span><br><span class="line">        System.out.println(page.getPages());//当前页</span><br><span class="line">        System.out.println(page.getTotal());//总数</span><br><span class="line">        System.out.println(page.getSize());//当前页有几条</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210827153919489.png" alt="image-20210827153919489"></p>
<h2 id="如果想在xml的mapper时使用mybatisplus的分页"><a href="#如果想在xml的mapper时使用mybatisplus的分页" class="headerlink" title="如果想在xml的mapper时使用mybatisplus的分页"></a>如果想在xml的mapper时使用mybatisplus的分页</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210827155236210.png" alt="image-20210827155236210"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210827155243537.png" alt="image-20210827155243537"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210827155254843.png" alt="image-20210827155254843"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>分页</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx与gateway</title>
    <url>/2021/11/30/nginx%E4%B8%8Egateway/</url>
    <content><![CDATA[<p>前端页面都放在nginx的html下，并且每一个前端项目都需要配置nginx</p>
<p><img src="/D:/hexo博客/blog/source/img/image-20211217175446376.png" alt="image-20211217175446376"></p>
<p>但是不一定每个项目都会配置网关</p>
<p>如果配置了</p>
<p>那么就不用改前端项目的environment.json，或者config.json</p>
<p>前端发的请求都是带上api的，走nacos的网关服务，从nacos找其他服务</p>
<p>如果没配置</p>
<p>需要改前端项目的environment.json，或者config.json</p>
<p>说明前端访问路径是不带api的</p>
<p>gateway具体操作请看alibaba-springcloud博客</p>
<h1 id="公司"><a href="#公司" class="headerlink" title="公司"></a>公司</h1><p>以宁杭portal和上海protal举例</p>
<h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><h4 id="宁杭portal"><a href="#宁杭portal" class="headerlink" title="宁杭portal"></a>宁杭portal</h4><p><img src="/../img/image-20220331171807782.png" alt="image-20220331171807782"></p>
<h4 id="上海portal"><a href="#上海portal" class="headerlink" title="上海portal"></a>上海portal</h4><p><img src="/../img/image-20220331171559160.png" alt="image-20220331171559160"></p>
<p>前端根据所在端口找到nginx，比如前端40105，就会找上图</p>
<p>此时前端请求应以/api开始</p>
<p>经过 proxy_pass 代理</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">宁杭的前端请求/api/portal</span><br><span class="line">经过nginx变成</span><br><span class="line">http://10.12.1.50:30004/api/portal</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">上海的前端请求/api/shanghai/portal</span><br><span class="line">经过nginx变成</span><br><span class="line">http://10.12.1.50:30004/api/shanghai/portal</span><br></pre></td></tr></table></figure>

<p>就是把</p>
<p>/api</p>
<p>换成了对应端口号的nginx代理路径proxy_pass</p>
<h2 id="gateway"><a href="#gateway" class="headerlink" title="gateway"></a>gateway</h2><p><img src="/../img/image-20220331171351441.png" alt="image-20220331171351441"></p>
<p>宁杭的</p>
<p><a href="http://10.12.1.50:30004/api/portal">http://10.12.1.50:30004/api/portal</a></p>
<p>会匹配第一个#portal</p>
<p>filters去掉2个前缀变成</p>
<p><a href="http://framework-portal-microservice/">http://FRAMEWORK-PORTAL-MICROSERVICE</a></p>
<p>因为注册到nacos上了，可以通过访问服务名，代替后端地址+端口</p>
<p>上海的</p>
<p><a href="http://10.12.1.50:30004/api/shanghai/portal">http://10.12.1.50:30004/api/shanghai/portal</a></p>
<p>会匹配第二个#shanghai-portal</p>
<p>filters去掉3个前缀变成</p>
<p><a href="http://framework-portal-microservice-shanghai/">http://FRAMEWORK-PORTAL-MICROSERVICE-SHANGHAI</a></p>
<p>因为注册到nacos上了，可以通过访问服务名，代替后端地址+端口</p>
<p>也反映了同一个nacos上不能有同名的服务</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>nginx与gateway</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle</title>
    <url>/2021/11/30/oracle/</url>
    <content><![CDATA[<h1 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h1><h2 id="生成一个伪列从1到查出的数据总数"><a href="#生成一个伪列从1到查出的数据总数" class="headerlink" title="生成一个伪列从1到查出的数据总数"></a>生成一个伪列从1到查出的数据总数</h2><p>SELECT rownum intId,’No.’||rownum rank</p>
<h2 id="拼接"><a href="#拼接" class="headerlink" title="拼接"></a>拼接</h2><p>||</p>
<h2 id="NVL空值转换"><a href="#NVL空值转换" class="headerlink" title="NVL空值转换"></a>NVL空值转换</h2><p>NVL(a,b),a不为空为a，a为空为b，a和b需要是同一种类型</p>
<h1 id="navicat连接oracle"><a href="#navicat连接oracle" class="headerlink" title="navicat连接oracle"></a>navicat连接oracle</h1><p>需要有连接信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ORCL_207</span><br><span class="line">niosdb_ah</span><br><span class="line">niosdb_ah</span><br><span class="line"></span><br><span class="line">ORCL_207 =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.10.2.31)(PORT = 1521))</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">      (SERVICE_NAME = orcl)</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220331162855473.png" alt="image-20220331162855473"></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>protobuf整理</title>
    <url>/2021/11/30/protobuf/</url>
    <content><![CDATA[<h1 id="1-定义一个简单的-proto文件"><a href="#1-定义一个简单的-proto文件" class="headerlink" title="1.定义一个简单的.proto文件"></a>1.定义一个简单的.proto文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">message SearchRequest &#123;</span><br><span class="line">  string query = 1;</span><br><span class="line">  int32 page_number = 2;</span><br><span class="line">  int32 result_per_page = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>文件的第一行指定了你正在使用proto3语法：如果你没有指定这个，编译器会使用proto2。这个指定语法行必须是文件的非空非注释的第一个行。</li>
<li>SearchRequest消息格式有3个字段，在消息中承载的数据分别对应于每一个字段。其中每个字段都有一个名字和一种类型。</li>
</ul>
<p>SearchRequest:自定义，跟一个对象名一样</p>
<h1 id="2-关键字"><a href="#2-关键字" class="headerlink" title="2.关键字"></a>2.关键字</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">required关键字</span><br><span class="line">顾名思义，就是必须的意思，数据发送方和接收方都必须处理这个字段，不然还怎么通讯呢</span><br><span class="line"></span><br><span class="line">optional关键字</span><br><span class="line">字面意思是可选的意思，具体protobuf里面怎么处理这个字段呢，就是protobuf处理的时候另外加了一个bool的变量，用来标记这个optional字段是否有值，发送方在发送的时候，如果这个字段有值，那么就给bool变量标记为true，否则就标记为false，接收方在收到这个字段的同时，也会收到发送方同时发送的bool变量，拿着bool变量就知道这个字段是否有值了，这就是option的意思。</span><br><span class="line"></span><br><span class="line">repeated关键字</span><br><span class="line">是集合的意思。</span><br></pre></td></tr></table></figure>

<h1 id="3-关系对应"><a href="#3-关系对应" class="headerlink" title="3.关系对应"></a>3.关系对应</h1><table>
<thead>
<tr>
<th>.proto Type</th>
<th>Notes</th>
<th>Java Type</th>
</tr>
</thead>
<tbody><tr>
<td>double</td>
<td></td>
<td>double</td>
</tr>
<tr>
<td>float</td>
<td></td>
<td>float</td>
</tr>
<tr>
<td>int32</td>
<td>使用可变长度编码。编码负数的效率低 - 如果你的字段可能有负值，请改用 sint32</td>
<td>int</td>
</tr>
<tr>
<td>int64</td>
<td>使用可变长度编码。编码负数的效率低 - 如果你的字段可能有负值，请改用 sint64</td>
<td>long</td>
</tr>
<tr>
<td>sint32</td>
<td>使用可变长度编码。有符号的 int 值。这些比常规 int32 对负数能更有效地编码</td>
<td>int</td>
</tr>
<tr>
<td>sint64</td>
<td>使用可变长度编码。有符号的 int 值。这些比常规 int64 对负数能更有效地编码</td>
<td>long</td>
</tr>
<tr>
<td>bool</td>
<td></td>
<td>boolean</td>
</tr>
<tr>
<td>string</td>
<td>字符串必须始终包含 UTF-8 编码或 7 位 ASCII 文本</td>
<td>String</td>
</tr>
<tr>
<td>bytes</td>
<td>可以包含任意字节序列</td>
<td>ByteString</td>
</tr>
</tbody></table>
<h1 id="4-maven生成java文件"><a href="#4-maven生成java文件" class="headerlink" title="4.maven生成java文件"></a>4.maven生成java文件</h1><p>新建src/main/proto目录</p>
<p>创建.proto对象</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 显示声明使用proto3, 否则使用默认的proto2</span><br><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"> </span><br><span class="line">// 生成类的包名,注意一定要指定包名</span><br><span class="line">option java_package = &quot;com.jiang.demo2&quot;;</span><br><span class="line">//或者直接写</span><br><span class="line">package com.jiang.demo2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 生成类的文件名，否则默认生成的类名为proto文件名的驼峰命名,首字母大写</span><br><span class="line">//option java_outer_classname = &quot;HelloWorldProto&quot;;</span><br><span class="line">// 定义的所有消息、枚举和服务生成对应的多个类文件，而不是以内部类的形式出现</span><br><span class="line">//option java_multiple_files = false;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message gps_data &#123;</span><br><span class="line">  int64 id = 1;</span><br><span class="line">  string terminalId = 2;</span><br><span class="line">  string dataTime = 3;</span><br><span class="line">  double lon = 4;</span><br><span class="line">  double lat = 5;</span><br><span class="line">  float speed = 6;</span><br><span class="line">  int32 altitude = 7;</span><br><span class="line">  int32 locType = 8;</span><br><span class="line">  int32 gpsStatus = 9;</span><br><span class="line">  float direction = 10;</span><br><span class="line">  int32 satellite = 11;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220301091034807.png" alt="image-20220301091034807"></p>
<p>pom插件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.5.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;extensions&gt;</span><br><span class="line">            &lt;extension&gt;</span><br><span class="line">                &lt;groupId&gt;kr.motd.maven&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;os-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;1.6.2&lt;/version&gt;</span><br><span class="line">            &lt;/extension&gt;</span><br><span class="line">        &lt;/extensions&gt;</span><br><span class="line"></span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;excludes&gt;</span><br><span class="line">                        &lt;exclude&gt;</span><br><span class="line">                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                        &lt;/exclude&gt;</span><br><span class="line">                    &lt;/excludes&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.xolstice.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;protobuf-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;0.5.0&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;protocArtifact&gt;com.google.protobuf:protoc:3.0.0:exe:$&#123;os.detected.classifier&#125;&lt;/protocArtifact&gt;</span><br><span class="line">                    &lt;pluginId&gt;grpc-java&lt;/pluginId&gt;</span><br><span class="line">                    &lt;pluginArtifact&gt;io.grpc:protoc-gen-grpc-java:1.0.0:exe:$&#123;os.detected.classifier&#125;&lt;/pluginArtifact&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;/goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile-custom&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">        &lt;finalName&gt;demo&lt;/finalName&gt;</span><br><span class="line">    &lt;/build&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220228180153300.png" alt="image-20220228180153300"></p>
<p>生成到路径</p>
<p><img src="/../img/image-20220301093412045.png" alt="image-20220301093412045"></p>
<p>最终java文件，把文件移动到想要的包下</p>
<p><img src="/../img/image-20220301093420585.png" alt="image-20220301093420585"></p>
<h1 id="5-使用方法"><a href="#5-使用方法" class="headerlink" title="5.使用方法"></a>5.使用方法</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#文件名.定义的对象.newBuilder()，创建一个文件名.定义的对象的builder对象</span><br><span class="line">GpsData.gps_data.Builder gps_builder = GpsData.gps_data.newBuilder();</span><br><span class="line"></span><br><span class="line">#通过这个builder可以set进去属性</span><br><span class="line">gps_builder.setAltitude(1);</span><br><span class="line">gps_builder.setDataTime(&quot;2017-12-17 16:21:44&quot;);</span><br><span class="line">gps_builder.setGpsStatus(1);</span><br><span class="line">gps_builder.setLat(39.123);</span><br><span class="line">gps_builder.setLon(120.112);</span><br><span class="line">gps_builder.setDirection(30.2F);</span><br><span class="line">gps_builder.setId(100L);</span><br><span class="line"></span><br><span class="line">#builder对象.build变成java对象，但是这个java对象只有get方法，没有set方法，想set只能是builder对象</span><br><span class="line">GpsData.gps_data gps_data = gps_builder.build();</span><br><span class="line"></span><br><span class="line">#toBuilder()方法转成builder对象</span><br><span class="line">GpsData.gps_data.Builder builder = gps_data.toBuilder();</span><br><span class="line"></span><br><span class="line">#通过parseFrom方法，把二进制数据反序列化成java对象</span><br><span class="line">System.out.println(&quot;===== 使用gps 反序列化生成对象开始 =====&quot;);</span><br><span class="line">GpsData.gps_data gd = null;</span><br><span class="line">try &#123;</span><br><span class="line">gd = GpsData.gps_data.parseFrom(gps_data.toByteArray());</span><br><span class="line">&#125; catch (InvalidProtocolBufferException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">System.out.print(gd.toString());</span><br><span class="line">System.out.println(&quot;===== 使用gps 反序列化生成对象结束 =====&quot;);</span><br><span class="line"></span><br><span class="line">#把builder对象直接转成json，也可以放入protobuf转成的java对象</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">//    &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;</span><br><span class="line">//    &lt;artifactId&gt;protobuf-java-util&lt;/artifactId&gt;</span><br><span class="line">//    &lt;version&gt;3.5.0&lt;/version&gt;</span><br><span class="line">//&lt;/dependency&gt;</span><br><span class="line">String jsonFormatM = &quot;&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            jsonFormatM = JsonFormat.printer().print(gps_builder);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(jsonFormatM.toString());</span><br><span class="line">        System.out.println(&quot;json数据大小：&quot; + jsonFormatM.getBytes().length);</span><br></pre></td></tr></table></figure>

<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>假如我们需要一个”路径”的模型，路径由很多个”点”组成，同时在路径中还有一些其它的属性信息，其中类型为定义好的几个值。<br>1.定义all.proto，一个path对象，一个point对象，其中path包含</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package com.jiang.demo2;</span><br><span class="line">message path</span><br><span class="line">&#123;</span><br><span class="line">  enum typeEnum &#123;</span><br><span class="line">    COMMUTE = 0;  //通勤</span><br><span class="line">    DUTY = 1;     //工作</span><br><span class="line">  &#125;</span><br><span class="line">  string id = 1;</span><br><span class="line">  string name = 2; //名称</span><br><span class="line">  typeEnum type = 3; //类型</span><br><span class="line">  repeated point geometry = 4; //点集合</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message point&#123;</span><br><span class="line">  double lon = 1; //经度</span><br><span class="line">  double lat = 2; //纬度</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>test</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        //ponit的builder对象</span><br><span class="line">        All.point.Builder point_builder1 = All.point.newBuilder();</span><br><span class="line">        //设置经纬度</span><br><span class="line">        point_builder1.setLat(101.11);</span><br><span class="line">        point_builder1.setLon(39.11);</span><br><span class="line">        //java对象</span><br><span class="line">        All.point point1 = point_builder1.build();</span><br><span class="line">        System.out.println(point1.toString());</span><br><span class="line">        System.out.println(&quot;===== 构建point1模型结束 =====&quot;);</span><br><span class="line"></span><br><span class="line">        //point的builder对象</span><br><span class="line">        All.point.Builder point_builder2 = All.point.newBuilder();</span><br><span class="line">        point_builder2.setLat(101.11);</span><br><span class="line">        point_builder2.setLon(39.11);</span><br><span class="line">        All.point point2 = point_builder2.build();</span><br><span class="line">        System.out.println(point1.toString());</span><br><span class="line">        System.out.println(&quot;===== 构建point2模型结束 =====&quot;);</span><br><span class="line">        //现在有两个点point对象</span><br><span class="line"></span><br><span class="line">        //创建path的builder对象</span><br><span class="line">        All.path.Builder pathBuilder = All.path.newBuilder();</span><br><span class="line">        pathBuilder.setId(&quot;1&quot;);</span><br><span class="line">        pathBuilder.setName(&quot;路径&quot;);</span><br><span class="line">        pathBuilder.setType(All.path.typeEnum.DUTY);</span><br><span class="line"></span><br><span class="line">        //相当于一个point集合，往里面add一个个的point对象</span><br><span class="line">        pathBuilder.addGeometry(0, point1);</span><br><span class="line">        pathBuilder.addGeometry(1, point2);</span><br><span class="line">        All.path path = pathBuilder.build();</span><br><span class="line">        System.out.println(path.toString());</span><br><span class="line">        System.out.println(&quot;===== 构建path模型结束 =====&quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;===== 转成json对象开始 =====&quot;);</span><br><span class="line">        String jsonFormatM = &quot;&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            jsonFormatM = JsonFormat.printer().print(path);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(jsonFormatM.toString());</span><br><span class="line">        System.out.println(&quot;json数据大小：&quot; + jsonFormatM.getBytes().length);</span><br><span class="line">        System.out.println(&quot;===== 转成json对象结束 =====&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="实战中使用"><a href="#实战中使用" class="headerlink" title="实战中使用"></a>实战中使用</h2><p>阈值项目中，给ProtoAlarmObject又包装了一层ZipPbAlarm，有版本号，数据，以及pbAlarm，其中descData没啥用</p>
<p><img src="/../img/image-20220301105806320.png" alt="image-20220301105806320"></p>
<p>通常在做实际项目的时候，消息是需要用信封做一下封装便于业务的处理和一些业务无关的信息（例如：ID，加密信息等）存放。消息体根据消息类型是不同的数据类型。<br>实现这个的方式其实很简单，protobuf对象可以序列化成byte数组，然后，在信封的模型里定义一个 bytes 类型的字段用于存放消息体即可。</p>
<p>1，如添加消息信封msg实体：</p>
<p><img src="/../img/image-20220301110103200.png" alt="image-20220301110103200"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package com.jiang.demo2;</span><br><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package com.jiang.demo2;</span><br><span class="line"></span><br><span class="line">message msg</span><br><span class="line">&#123;</span><br><span class="line">  string mid = 1;//id唯一标识</span><br><span class="line">  string description = 2;//描述内容</span><br><span class="line">  bytes data = 3; //数据内容</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message path</span><br><span class="line">&#123;</span><br><span class="line">  enum typeEnum &#123;</span><br><span class="line">    COMMUTE = 0;  //通勤</span><br><span class="line">    DUTY = 1;     //工作</span><br><span class="line">  &#125;</span><br><span class="line">  string id = 1;</span><br><span class="line">  string name = 2; //名称</span><br><span class="line">  typeEnum type = 3; //类型</span><br><span class="line">  repeated point geometry = 4; //点集合</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message point&#123;</span><br><span class="line">  double lon = 1; //经度</span><br><span class="line">  double lat = 2; //纬度</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>test</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">            // point  builder</span><br><span class="line">            All.point.Builder point_builder1 = All.point.newBuilder();</span><br><span class="line">            point_builder1.setLat(101.11);</span><br><span class="line">            point_builder1.setLon(39.11);</span><br><span class="line">            //point1对象</span><br><span class="line">            All.point point1 = point_builder1.build();</span><br><span class="line">            System.out.println(point1.toString());</span><br><span class="line">            System.out.println(&quot;===== 构建point1模型结束 =====&quot;);</span><br><span class="line"></span><br><span class="line">            // 构建消息,msg builder</span><br><span class="line">            All.msg.Builder msgBuilder = All.msg.newBuilder();</span><br><span class="line">            msgBuilder.setMid(&quot;1&quot;);</span><br><span class="line">            msgBuilder.setDescription(&quot;PATH&quot;);</span><br><span class="line">            msgBuilder.setData(point1.toByteString());</span><br><span class="line"></span><br><span class="line">            All.msg msg = msgBuilder.build();</span><br><span class="line">            System.out.println(msg.toString());</span><br><span class="line">            //msg模式带有point1的数据</span><br><span class="line">            System.out.println(&quot;===== 构建msg模型结束 =====&quot;);</span><br><span class="line"></span><br><span class="line">            //这是一个msg的二进制</span><br><span class="line">            byte[] msgBytes = msg.toByteArray();</span><br><span class="line"></span><br><span class="line">            // 解析消息</span><br><span class="line">            try &#123;</span><br><span class="line">                All.msg msgParse = All.msg.parseFrom(msgBytes);</span><br><span class="line">                System.out.println(msgParse.toString());</span><br><span class="line">                System.out.println(&quot;===== 反序列化msg模型结束 =====&quot;);</span><br><span class="line"></span><br><span class="line">                System.out.println(&quot;主键：&quot;+msgParse.getMid());</span><br><span class="line">                System.out.println(&quot;描述：&quot;+msgParse.getDescription());</span><br><span class="line"></span><br><span class="line">                switch (msgParse.getDescription()) &#123;</span><br><span class="line">                    case &quot;PATH&quot;:</span><br><span class="line">                        System.out.println(&quot;PATH消息&quot;);</span><br><span class="line">                        All.point pointParse = All.point.parseFrom(msgParse.getData());</span><br><span class="line">                        System.out.println(pointParse.toString());</span><br><span class="line">                        System.out.println(&quot;===== 反序列化point模型结束 =====&quot;);</span><br><span class="line">                        System.out.println(&quot;point取值&quot;);</span><br><span class="line">                        System.out.println(&quot;纬度:&quot; + pointParse.getLat());</span><br><span class="line">                        System.out.println(&quot;经度:&quot; + pointParse.getLon());</span><br><span class="line">                        break;</span><br><span class="line">                    case &quot;&quot;:</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; catch (InvalidProtocolBufferException ex) &#123;</span><br><span class="line">                System.out.println(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>protobuf</tag>
      </tags>
  </entry>
  <entry>
    <title>servlet</title>
    <url>/2021/11/30/servlet/</url>
    <content><![CDATA[<p>我小姜一定要弄懂servlet！！（过去式了，已经过时了，顶多用到过滤器拦截器）</p>
<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1.概念"></a>1.概念</h1><h2 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Servlet简介</span><br><span class="line">1： 根据自己的理解，Servlet是什么？作用？</span><br><span class="line"></span><br><span class="line">     （是什么?）Servlet是实现了Servlet接口，并通过“请求-响应”模式来访问的服务端Java程序；</span><br><span class="line"></span><br><span class="line">     （干什么的）主要用于开发动态Web资源；交互式的浏览和修改数据，动态的扩展Server的能力。</span><br><span class="line"></span><br><span class="line">（1）接受请求，并与服务器资源进行通信；</span><br><span class="line"></span><br><span class="line">（2）创建并返回一个基于客户端请求性质的动态内容HTML页面给客户端。</span><br></pre></td></tr></table></figure>



<h2 id="servlet容器"><a href="#servlet容器" class="headerlink" title="servlet容器"></a>servlet容器</h2><p>Jetty</p>
<p>Tomcat </p>
<p><img src="/../img/image-20220210162841961.png" alt="image-20220210162841961"></p>
<pre><code>（1）Servlet容器并不直接管理Servlet，而是通过中间层来实现（Context容器）。一个Servlet容器可以包含多个Context容器，每个Context容器对应管理了一个Web工程，分为多个Servlet，且被包装成Wrapper被管理。

（2）为什么适用中间层（即出现了Context容器和Wrapper包装层）这种管理手段？

     第一：一个Servlet容器可以放多个Web工程，但是每个工程要被单独管理，所以就要借助Context容器单独管理Web工程。

     第二：Servlet是独立开发的Web标准，不应该和容器产生强关联性耦合，所以要借助具有容器特征的StandWapper包装成子容器（Wapper，也就是Servlet实例）添加到Context中管理。（所以，可以得出另一个结论:Context容器才是真正运行Servlet的Servlet容器）
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">一个Context上下文对应一个Web应用程序，即一个Web project，而一个Web工程包含多一个Wrapper（Servlet应用程序的包装类）。也就是说，在tomcat容器等级中，Context容器直接管理Servlet在容器中的包装类Wrapper，所以Context容器如何运行将直接影响servlet的工作方式。</span><br></pre></td></tr></table></figure>

<h1 id="2-Tomcat启动过程"><a href="#2-Tomcat启动过程" class="headerlink" title="2.Tomcat启动过程"></a>2.<strong>Tomcat启动过程</strong></h1><p>Tomcat启动时通过org.apache.catalina.startup.Tomcat这个启动类完成的，启动步骤如下：</p>
<pre><code>（1）创建实例

（2）添加Web应用

（3）启动Tomcat

（4）调用Servlet

Tomcat tomcat = getTomcatInstance();  //1:创建实例
File appDir = new File(getBuildDirectory(), &quot;webapps/examples&quot;);  
tomcat.addWebapp(null, &quot;/examples&quot;, appDir.getAbsolutePath());  //2:添加Web应用
tomcat.start();                       //3:启动实例
ByteChunk res = getUrl(&quot;http://localhost:&quot; + getPort() +  
                      &quot;/examples/servlets/servlet/HelloWorldExample&quot;);  
assertTrue(res.toString().indexOf(&quot;&lt;h1&gt;Hello World!&lt;/h1&gt;&quot;) &gt; 0);   //4:调用servlet
</code></pre>
<h1 id="3-Servlet生命周期"><a href="#3-Servlet生命周期" class="headerlink" title="3.Servlet生命周期"></a>3.Servlet生命周期</h1><pre><code>  servlet始于装入web服务器内存，并在web服务器终止或重装servlet时结束。servlet一旦被装入web服务器，一般不会从web服务器内存中删除，直至web服务器关闭或重装才会结束。
  (1)初始化：web服务器启动时或web服务器接收到请求时加载Servlet。执行init（）;

  (2)调用：运行service()方法，service()自动派遣运行与请求相对应的doGet()或doPost()方法;

  (3)销毁：停止服务器时调用destroy()方法，销毁实例。 
</code></pre>
<h1 id="4-手写Servlet类"><a href="#4-手写Servlet类" class="headerlink" title="4.手写Servlet类"></a>4.手写Servlet类</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</span><br><span class="line">    <span class="comment">//处理HTTP GET请求</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, </span></span><br><span class="line"><span class="function">IOException </span>&#123;</span><br><span class="line">       doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理HTTP POST请求</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, </span></span><br><span class="line"><span class="function">IOException </span>&#123;</span><br><span class="line"><span class="comment">//第一种:返回渲染结果</span></span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;head&gt;&lt;title&gt;Servlet06&lt;/head&gt;&lt;/title&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.print(<span class="string">&quot;我是返回值&quot;</span>);</span><br><span class="line">        out.print(req.getParameter(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/html&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二种：重新定向到servlet02</span></span><br><span class="line">        resp.sendRedirect(<span class="string">&quot;s02&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//第三种：请求分派</span></span><br><span class="line">        <span class="comment">//获取请求分派器</span></span><br><span class="line">        RequestDispatcher dispatcher = req.getRequestDispatcher(<span class="string">&quot;servlet04&quot;</span>);</span><br><span class="line">        <span class="comment">//将请求转发至指定路径的资源</span></span><br><span class="line">        dispatcher.forward(req,resp);</span><br><span class="line"></span><br><span class="line"><span class="comment">//第四种:添加传递参数</span></span><br><span class="line">        String str = <span class="string">&quot;在Servlet05中存放请求域属性&quot;</span>;</span><br><span class="line">        req.setAttribute(<span class="string">&quot;content&quot;</span>,str);</span><br><span class="line">        <span class="comment">//获取请求分派器</span></span><br><span class="line">        RequestDispatcher dispatcher = req.getRequestDispatcher(<span class="string">&quot;servlet06&quot;</span>);</span><br><span class="line">        <span class="comment">//将请求转发至指定路径的资源</span></span><br><span class="line">        dispatcher.forward(req,resp);</span><br><span class="line"><span class="comment">//第五种：获取初始化参数信息</span></span><br><span class="line">        <span class="comment">//获取ServletContext实例</span></span><br><span class="line">        ServletContext context = <span class="keyword">this</span>.getServletContext();</span><br><span class="line">        <span class="comment">//获取指定名称的web应用上下文初始参数的字符串值</span></span><br><span class="line">        String str = context.getInitParameter(<span class="string">&quot;appName&quot;</span>);</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        out.print(<span class="string">&quot;获取ServletContext的初始化参数\&quot;appName\&quot;的字符串值为：&quot;</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;     &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>servlet</tag>
      </tags>
  </entry>
  <entry>
    <title>showDoc</title>
    <url>/2021/11/30/showDoc/</url>
    <content><![CDATA[<h1 id="docker安装showDoc"><a href="#docker安装showDoc" class="headerlink" title="docker安装showDoc"></a>docker安装showDoc</h1><h2 id="1-安装docker步骤略过"><a href="#1-安装docker步骤略过" class="headerlink" title="1.安装docker步骤略过"></a>1.安装docker步骤略过</h2><h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2.安装"></a>2.安装</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 中国大陆镜像安装命令（安装后记得执行docker tag命令以进行重命名）</span></span><br><span class="line">docker pull registry.cn-shenzhen.aliyuncs.com/star7th/showdoc</span><br><span class="line">docker tag registry.cn-shenzhen.aliyuncs.com/star7th/showdoc:latest star7th/showdoc:latest </span><br><span class="line"></span><br><span class="line"><span class="comment">##后续命令无论使用官方镜像还是加速镜像都需要执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#新建存放showdoc数据的目录</span></span><br><span class="line">mkdir -p /showdoc_data/html</span><br><span class="line">chmod  -R 777 /showdoc_data</span><br><span class="line"><span class="comment"># 如果你是想把数据挂载到其他目录，比如说/data1，那么，可以在/data1目录下新建一个showdoc_data/目录，</span></span><br><span class="line"><span class="comment"># 然后在根目录的新建一个软链接/showdoc_data到/data1/showdoc_data</span></span><br><span class="line"><span class="comment"># 这样既能保持跟官方教程推荐的路径一致，又能达到自定义存储的目的.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动showdoc容器</span></span><br><span class="line">docker run -d --name showdoc --user=root --privileged=<span class="literal">true</span> -p 4999:80 \</span><br><span class="line">-v /showdoc_data/html:/var/www/html/ star7th/showdoc</span><br></pre></td></tr></table></figure>

<p>根据以上命令操作的话，往后showdoc的数据都会存放在 /showdoc_data/html 目录下。<br>你可以打开 <a href="http://localhost:4999/">http://localhost:4999</a> 来访问showdoc (localhost可改为你的服务器域名或者IP)。账户密码是showdoc/123456，登录后你便可以看到右上方的管理后台入口。建议登录后修改密码。</p>
<p>如果报错</p>
<p><img src="/../img/image-20220118154934633.png" alt="image-20220118154934633"></p>
<p>重启docker</p>
<p>systemctl restart docker</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>showDoc</tag>
      </tags>
  </entry>
  <entry>
    <title>swagger</title>
    <url>/2021/11/30/swagger/</url>
    <content><![CDATA[<h1 id="1-config"><a href="#1-config" class="headerlink" title="1.config"></a>1.config</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.swagger.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.*;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line">import springfox.documentation.service.ApiInfo;</span><br><span class="line">import springfox.documentation.service.Contact;</span><br><span class="line">import springfox.documentation.spi.DocumentationType;</span><br><span class="line">import springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line">import springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableSwagger2//开启swagger2 /swagger-ui.html</span><br><span class="line">public class SwaggerConfig &#123;</span><br><span class="line">    //配置多个组</span><br><span class="line">    @org.springframework.context.annotation.Bean</span><br><span class="line">    public Docket docket2()&#123;</span><br><span class="line">        return new Docket(DocumentationType.SWAGGER_2).groupName(&quot;A&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    @org.springframework.context.annotation.Bean</span><br><span class="line">    public Docket docket3()&#123;</span><br><span class="line">        return new Docket(DocumentationType.SWAGGER_2).groupName(&quot;B&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //配置了swagger的Docket的bean实例</span><br><span class="line">    @Bean</span><br><span class="line">    public Docket docket()&#123;</span><br><span class="line">        return new Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .groupName(&quot;小旭&quot;)</span><br><span class="line">                //是否自动打开</span><br><span class="line">                //.enable(false);</span><br><span class="line">                .select()</span><br><span class="line">                //配置要扫描接口的方式,指定要扫描的包</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(&quot;com&quot;自己包路径&quot;controller&quot;))</span><br><span class="line">                //扫描指定包下的指定路径的方法</span><br><span class="line">                //.paths(PathSelectors.ant(&quot;/jiang/**&quot;))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    Contact contact=new Contact(&quot;xiaoxu&quot;,&quot;http://www.baidu.com&quot;,&quot;0&quot;);</span><br><span class="line">    private ApiInfo apiInfo()&#123;</span><br><span class="line"></span><br><span class="line">        //作者信息</span><br><span class="line">        return new ApiInfo(&quot;小旭学Swagger&quot;,</span><br><span class="line">                &quot;小旭学Swagger&quot;,</span><br><span class="line">                &quot;1.0&quot;,</span><br><span class="line">                &quot;http://www.baidu.com&quot;,</span><br><span class="line">                contact,</span><br><span class="line">                &quot;Apache 2.0&quot;,</span><br><span class="line">                &quot;http://www.apache.org/licenses/LICENSE-2.0&quot;,</span><br><span class="line">                new ArrayList&lt;springfox.documentation.service.VendorExtension&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-controller"><a href="#2-controller" class="headerlink" title="2.controller"></a>2.controller</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.swagger.controller;</span><br><span class="line"></span><br><span class="line">import com.jiang.swagger.pojo.User;</span><br><span class="line"></span><br><span class="line">import io.swagger.annotations.Api;</span><br><span class="line"></span><br><span class="line">import io.swagger.annotations.ApiOperation;</span><br><span class="line">import io.swagger.annotations.ApiParam;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">@Api(tags = &quot;hello控制类&quot;)</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    @ApiOperation(&quot;在方法上加注释&quot;)</span><br><span class="line">    @PostMapping(&quot;/user&quot;)</span><br><span class="line">    public User user()&#123;</span><br><span class="line">        return new User();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-pom"><a href="#3-pom" class="headerlink" title="3.pom"></a>3.pom</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger2 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.9.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger-ui --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.9.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>swagger</tag>
      </tags>
  </entry>
  <entry>
    <title>tomcat</title>
    <url>/2021/11/30/tomcat%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h1 id="1-windows下载安装tomcat9"><a href="#1-windows下载安装tomcat9" class="headerlink" title="1.windows下载安装tomcat9"></a>1.windows下载安装tomcat9</h1><p><a href="https://blog.csdn.net/ELaXiaoSi/article/details/84190648?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164445787016780265450662%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164445787016780265450662&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-84190648.first_rank_v2_pc_rank_v29&amp;utm_term=tomcat9%E4%B8%8B%E8%BD%BD&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/ELaXiaoSi/article/details/84190648?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164445787016780265450662%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164445787016780265450662&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-84190648.first_rank_v2_pc_rank_v29&amp;utm_term=tomcat9%E4%B8%8B%E8%BD%BD&amp;spm=1018.2226.3001.4187</a></p>
<h1 id="2-linux安装tomcat9"><a href="#2-linux安装tomcat9" class="headerlink" title="2.linux安装tomcat9"></a>2.linux安装tomcat9</h1><p>cd /home</p>
<p>mkdir tomcat9</p>
<p>cd tomcat9</p>
<p>tar -zxvf apache-tomcat-9.0.58.tar.gz</p>
<p>cd /home/tomcat9/apache-tomcat-9.0.58/bin</p>
<p>./startup.sh</p>
<p>查看是否启动成功-查看tomcat/logs/catalina.out文件</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>zookeeper</title>
    <url>/2021/11/30/zookeeper/</url>
    <content><![CDATA[<h1 id="看08-尚硅谷技术之ZookeeperV3-3-pdf"><a href="#看08-尚硅谷技术之ZookeeperV3-3-pdf" class="headerlink" title="看08_尚硅谷技术之ZookeeperV3.3.pdf"></a>看08_尚硅谷技术之ZookeeperV3.3.pdf</h1><h1 id="5-下载安装"><a href="#5-下载安装" class="headerlink" title="5.下载安装"></a>5.下载安装</h1><h2 id="1-本地安装（不是集群）"><a href="#1-本地安装（不是集群）" class="headerlink" title="1.本地安装（不是集群）"></a>1.本地安装（不是集群）</h2><h3 id="1-安装JDK"><a href="#1-安装JDK" class="headerlink" title="1.安装JDK"></a>1.安装JDK</h3><p>把移动硬盘中linux找到linux版本的jdk</p>
<p>新建文件夹 mkdir -p /usr/local/java   -p中间路径没有的话也创建出来</p>
<p>如果提示-bash: rz: 未找到命令  yum -y install lrzsz</p>
<p>把jdk-8u131-linux-x64.tar.gz移动到/usr/local/java路径下</p>
<p>解压 tar -zxvf jdk-8u131-linux-x64.tar.gz </p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022154410109.png" alt="image-20211022154410109"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java/jdk1.8.0_131</span><br><span class="line"></span><br><span class="line">export JRE_HOME=/$JAVA_HOME/jre</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin</span><br></pre></td></tr></table></figure>

<p>source /etc/profile</p>
<p>java -version</p>
<h3 id="2-安装zk（pdf里都有）"><a href="#2-安装zk（pdf里都有）" class="headerlink" title="2.安装zk（pdf里都有）"></a>2.安装zk（pdf里都有）</h3><p>mkdir /opt/software</p>
<p>mkdir /opt/module</p>
<p>拷贝apache-zookeeper-3.5.7-bin.tar.gz到/opt/software</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf apache-zookeeper-3.5.7-bin.tar.gz -C /opt/module/</span><br><span class="line">指定把zk安装到module下</span><br></pre></td></tr></table></figure>

<p>cd /opt/moudle</p>
<p><strong>改个名</strong></p>
<p>mv apache-zookeeper-3.5.7-bin/ zookeeper-3.5.7</p>
<p><strong>进行配置</strong></p>
<p>进入 cd zookeeper-3.5.7/conf/</p>
<p>mv zoo_sample.cfg zoo.cfg </p>
<p>mkdir /opt/module/zookeeper-3.5.7/zkData</p>
<p>vim zoo.cfg</p>
<p>修改</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022163427738.png" alt="image-20211022163427738"></p>
<h3 id="启动服务端"><a href="#启动服务端" class="headerlink" title="启动服务端"></a>启动服务端</h3><p>zookeeper-3.5.7目录下</p>
<p>bin/zkServer.sh start</p>
<p>jps -l</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022163721064.png" alt="image-20211022163721064"></p>
<p>查看本地状态</p>
<p>bin/zkServer.sh status</p>
<p>单机standalone</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022164028933.png" alt="image-20211022164028933"></p>
<p>停止</p>
<p>bin/zkServer.sh stop</p>
<h3 id="启动客户端访问"><a href="#启动客户端访问" class="headerlink" title="启动客户端访问"></a>启动客户端访问</h3><p>bin/zkCli.sh </p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022163901512.png" alt="image-20211022163901512"></p>
<p>退出quit</p>
<h3 id="zoo-cfg参数解读"><a href="#zoo-cfg参数解读" class="headerlink" title="zoo.cfg参数解读"></a>zoo.cfg参数解读</h3><h1 id="zkData"><a href="#zkData" class="headerlink" title="zkData"></a>zkData</h1><p>在zookeeper目录下的zkData</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025085510471.png" alt="image-20211025085510471"></p>
<p>myid服务id</p>
<p>.pid进程号，如果进程停止了，这个文件还存在，那么zookeeper启动不起来，需要手动删除</p>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>全局异常处理</title>
    <url>/2021/11/30/%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h1 id="1-简单"><a href="#1-简单" class="headerlink" title="1.简单"></a>1.简单</h1><p>全局配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jiang.demo.Result;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GlobalExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;String&gt; <span class="title">exceptionHandler</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.error(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义异常类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/09/28  8:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">myException</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message=message;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试Controller层抛出的异常</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210928143457707.png" alt="image-20210928143457707"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210928143510993.png" alt="image-20210928143510993"></p>
<p>测试Service层抛出的异常</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210928143531205.png" alt="image-20210928143531205"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210928143547254.png" alt="image-20210928143547254"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210928143556091.png" alt="image-20210928143556091"></p>
<h1 id="2-复杂全"><a href="#2-复杂全" class="headerlink" title="2.复杂全"></a>2.复杂全</h1><h2 id="1-定义一个自定义异常类"><a href="#1-定义一个自定义异常类" class="headerlink" title="1.定义一个自定义异常类"></a>1.定义一个自定义异常类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用法，throw出来即可</p>
<p><img src="/../img/image-20220324094347518.png" alt="image-20220324094347518"></p>
<h2 id="2-定义全局配置类"><a href="#2-定义全局配置类" class="headerlink" title="2.定义全局配置类"></a>2.定义全局配置类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DataIntegrityViolationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.BadSqlGrammarException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.BindException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.MethodArgumentNotValidException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolation;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolationException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(MyException.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyException</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseMessage2&lt;String&gt; <span class="title">exceptionHandler</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BindException) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(((BindException) e).getFieldError().getDefaultMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IllegalStateException) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(<span class="string">&quot;参数传递错误&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ConstraintViolationException) &#123;</span><br><span class="line">            ResponseMessage2 responseMessage2 = <span class="keyword">null</span>;</span><br><span class="line">            Set&lt;ConstraintViolation&lt;?&gt;&gt; violations = ((ConstraintViolationException) e).getConstraintViolations();</span><br><span class="line">            Iterator&lt;ConstraintViolation&lt;?&gt;&gt; iterator = violations.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                ConstraintViolation&lt;?&gt; cvl = iterator.next();</span><br><span class="line">                responseMessage2 = ResponseMessage2.Failed(cvl.getMessageTemplate());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> responseMessage2;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MethodArgumentNotValidException) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(((MethodArgumentNotValidException) e).getBindingResult().getFieldError().getDefaultMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SQLException || e <span class="keyword">instanceof</span> BadSqlGrammarException) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(<span class="string">&quot;数据库SQL执行异常,请检查语句编写是否正确！&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> DataIntegrityViolationException)&#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(<span class="string">&quot;数据库SQL违反完整性规则，请检查语句编写是否正确！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这步是返回自定义异常信息</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseMessage2.Failed(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>throw new MyException(“aaaa”);</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>全局异常处理</tag>
      </tags>
  </entry>
  <entry>
    <title>反射</title>
    <url>/2021/11/30/%E5%8F%8D%E5%B0%84/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>通过包.类路径获取类对象</span><br><span class="line">       Class c1 <span class="operator">=</span> Class.forName(&quot;com.example.demo.demo.A&quot;);</span><br><span class="line">       Class c2 <span class="operator">=</span> Class.forName(&quot;com.example.demo.demo.A&quot;);</span><br><span class="line">       <span class="operator">/</span><span class="operator">/</span>一个类在内存中只有一个class对象</span><br><span class="line">       System.out.println(c1<span class="operator">=</span><span class="operator">=</span>c2);<span class="operator">/</span><span class="operator">/</span><span class="literal">true</span></span><br><span class="line">       <span class="operator">/</span><span class="operator">/</span>一个类被加载后，类的整个结构都会被封装在class对象中</span><br></pre></td></tr></table></figure>

<h1 id="1-获取Class类的方法"><a href="#1-获取Class类的方法" class="headerlink" title="1.获取Class类的方法"></a>1.获取Class类的方法</h1><p>Class clazz=Person.class;</p>
<p>Class clazz=person.getClass();</p>
<p>Class clazz=Class.forName(“包.类路径&quot;);</p>
<h1 id="2-类的加载过程"><a href="#2-类的加载过程" class="headerlink" title="2.类的加载过程"></a>2.类的加载过程</h1><p>类的加载：把class文件读入内存,并创建一个java.lang.class对象。此过程由类加载器完成</p>
<p>类的链接：将类的二进制数据合并jvm的运行状态</p>
<p>初始化：对类进行初始化</p>
<h1 id="3-反射调用方法"><a href="#3-反射调用方法" class="headerlink" title="3.反射调用方法"></a>3.反射调用方法</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//调用无参函数</span><br><span class="line">Object c  调用方法在哪个类的对象   User user那么c=user</span><br><span class="line">methodName要调用的方法名</span><br><span class="line">c.getClass().getMethod(methodName, null).invoke(c, null);</span><br><span class="line"></span><br><span class="line">Object obj 参数和参数类型</span><br><span class="line"></span><br><span class="line">c.getClass().getMethod(methodName, obj.getClass()).invoke(c, obj);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Service(&quot;jiang&quot;)</span><br><span class="line">public class testService &#123;</span><br><span class="line">    public String haha(int age,String name)&#123;</span><br><span class="line">        String a=age+&quot;&quot;;</span><br><span class="line">        return name+a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;/aaa&quot;)</span><br><span class="line">public String aaa() throws Exception&#123;</span><br><span class="line">    ApplicationContext appCtx = SpringContextUtil.getApplicationContext();</span><br><span class="line">    Object c = (testService)SpringContextUtil.getBean(&quot;jiang&quot;);</span><br><span class="line">    //Object str = c.getClass().getMethod(&quot;haha&quot;, String.class).invoke(c, &quot;nihaoa&quot;);</span><br><span class="line">    Object str = c.getClass().getMethod(&quot;haha&quot;, new Class[]&#123;int.class,String.class&#125;).invoke(c, 16,&quot;nihaoa&quot;);</span><br><span class="line">    return (String)str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-根据属性获取属性值"><a href="#4-根据属性获取属性值" class="headerlink" title="4.根据属性获取属性值"></a>4.根据属性获取属性值</h1><p>更简单方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ReflectUtil.getFieldValue(Object obj, String fieldName)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line">         * 根据属性获取属性值</span><br><span class="line">         * @param fieldName</span><br><span class="line">         * @param object</span><br><span class="line">         * @return</span><br><span class="line">         */</span><br><span class="line">        public static Double getFieldValueByFieldName(String fieldName,Object object) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Field field = object.getClass().getDeclaredField(fieldName);</span><br><span class="line">                if(field!=null)&#123;</span><br><span class="line">                    //对private的属性的访问</span><br><span class="line">                    field.setAccessible(true);</span><br><span class="line">                    return (Double) field.get(object);</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-反射通过-service注解的值获取类bean"><a href="#5-反射通过-service注解的值获取类bean" class="headerlink" title="5.反射通过@service注解的值获取类bean"></a>5.反射通过@service注解的值获取类bean</h1><p>自己写一个类SpringContextUtil</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.io;</span><br><span class="line">import org.springframework.beans.BeansException;</span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.context.ApplicationContextAware;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Frank Yuan</span><br><span class="line"> * @create 2017-05-02-下午 10:32</span><br><span class="line"> **/</span><br><span class="line">@Component</span><br><span class="line">public class SpringContextUtil implements ApplicationContextAware &#123;</span><br><span class="line">    private static ApplicationContext applicationContext = null;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123;</span><br><span class="line">         this.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static ApplicationContext  getApplicationContext()&#123;</span><br><span class="line">        return applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object getBean(String beanName)&#123;</span><br><span class="line">        return applicationContext.getBean(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object getBean(Class c)&#123;</span><br><span class="line">        return applicationContext.getBean(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>testService中service注解的值为jiang</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.io;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/17  11:14</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@Service(&quot;jiang&quot;)</span><br><span class="line">public class testService &#123;</span><br><span class="line">    public String haha()&#123;</span><br><span class="line">        return &quot;hahahaha&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;/aaa&quot;)</span><br><span class="line">public String aaa()&#123;</span><br><span class="line">    ApplicationContext appCtx = SpringContextUtil.getApplicationContext();</span><br><span class="line">    testService bean = (testService)SpringContextUtil.getBean(&quot;jiang&quot;);</span><br><span class="line">    return bean.haha();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20210917112207601.png" alt="image-20210917112207601"></p>
<p>发现可以通过service的值获取到service层bean了</p>
<p>在通过bean，反射动态调用方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Service(&quot;jiang&quot;)</span><br><span class="line">public class testService &#123;</span><br><span class="line">    public String haha(int age,String name)&#123;</span><br><span class="line">        String a=age+&quot;&quot;;</span><br><span class="line">        return name+a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;/aaa&quot;)</span><br><span class="line">public String aaa() throws Exception&#123;</span><br><span class="line">    ApplicationContext appCtx = SpringContextUtil.getApplicationContext();</span><br><span class="line">    Object c = (testService)SpringContextUtil.getBean(&quot;jiang&quot;);</span><br><span class="line">    //Object str = c.getClass().getMethod(&quot;haha&quot;, String.class).invoke(c, &quot;nihaoa&quot;);</span><br><span class="line">    Object str = c.getClass().getMethod(&quot;haha&quot;, new Class[]&#123;int.class,String.class&#125;).invoke(c, 16,&quot;nihaoa&quot;);</span><br><span class="line">    return (String)str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-自定义注解"><a href="#6-自定义注解" class="headerlink" title="6.自定义注解"></a>6.自定义注解</h1><p><a href="https://blog.csdn.net/xsp_happyboy/article/details/80987484?spm=1001.2101.3001.6650.9&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-9.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-9.no_search_link">https://blog.csdn.net/xsp_happyboy/article/details/80987484?spm=1001.2101.3001.6650.9&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-9.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-9.no_search_link</a></p>
<p><img src="/../img/image-20211123174753114.png" alt="image-20211123174753114"></p>
<h1 id="7-在运行时修改制定注解的内容excel"><a href="#7-在运行时修改制定注解的内容excel" class="headerlink" title="7.在运行时修改制定注解的内容excel"></a>7.在运行时修改制定注解的内容excel</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">		Field f = AlarmActBo.class.getDeclaredField(<span class="string">&quot;cityName&quot;</span>);</span><br><span class="line">		f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">		Excel excelAn = f.getAnnotation(Excel.class);<span class="comment">//Excel是注解类型</span></span><br><span class="line">		System.out.println(excelAn.name());</span><br><span class="line">		ExcelUtil.modifyExcel(<span class="string">&quot;cityName&quot;</span>,<span class="string">&quot;所属区域&quot;</span>,AlarmActBo.class);</span><br><span class="line">		System.out.println(excelAn.name());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在运行时修改制定注解的内容excel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchFieldException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">modifyExcel</span><span class="params">(String name,String value,Class c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field f = c.getDeclaredField(name);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Excel excelAn = f.getAnnotation(Excel.class);<span class="comment">//Excel是注解类型</span></span><br><span class="line">        InvocationHandler h = Proxy.getInvocationHandler(excelAn);</span><br><span class="line">        Field hField = h.getClass().getDeclaredField(<span class="string">&quot;memberValues&quot;</span>);</span><br><span class="line">        hField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Map map = (Map) hField.get(h);</span><br><span class="line">        <span class="comment">// 修改 value 属性值 这里修改的是@Excel(name = &quot;姓名&quot;)</span></span><br><span class="line">        <span class="comment">//name是key</span></span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, value);</span><br><span class="line">        <span class="comment">//去掉@Excel，动态隐藏列</span></span><br><span class="line">        <span class="comment">//map.put(&quot;isColumnHidden&quot;, true);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>拦截器与过滤器</title>
    <url>/2021/11/30/%E6%8B%A6%E6%88%AA%E5%99%A8%E4%B8%8E%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
    <content><![CDATA[<h1 id="1-拦截器Interceptor"><a href="#1-拦截器Interceptor" class="headerlink" title="1.拦截器Interceptor"></a>1.拦截器Interceptor</h1><h2 id="1-1新建config包"><a href="#1-1新建config包" class="headerlink" title="1.1新建config包"></a>1.1新建config包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class SpringConfiguration implements WebMvcConfigurer &#123;</span><br><span class="line">	//自定义拦截器</span><br><span class="line">    @Autowired</span><br><span class="line">    LoginInterceptor  loginInterceptor ;</span><br><span class="line">    @Override</span><br><span class="line">    public void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="line">        //注册拦截器，除了登陆与注册之外，因为登陆注册不需要登陆也可以访问</span><br><span class="line">        registry.addInterceptor(loginInterceptor ).addPathPatterns(&quot;/**&quot;).excludePathPatterns(&quot;/login&quot;, &quot;/register&quot;);;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-自定义拦截器"><a href="#1-2-自定义拦截器" class="headerlink" title="1.2.自定义拦截器"></a>1.2.自定义拦截器</h2><p>@Component<br>public class LoginInterceptor implements HandlerInterceptor {</p>
<pre><code>/**
     * @Description 在业务处理器处理请求之前被调用。预处理，可以进行编码、安全控制等处理；
     * @Date 2019/5/14 16:04
     * @Version  1.0
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        System.out.println(request.getRequestURL()+&quot;===========preHandle===========&quot;);
        String token = request.getParameter(&quot;token&quot;);
        if(StringUtils.isNotEmpty(token))&#123;
            Subject subject = ShiroUtil.getSubject(token);
            if(subject != null &amp;&amp; subject.isAuthenticated())&#123;
                return true;
            &#125; else&#123;
                //返回校验token结果
                returnJson(response);
               // return false; 
            &#125;
        &#125;

        return true;
    &#125;
</code></pre>
<p>​<br>        @Override<br>        public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception {<br>            System.out.println(request.getContextPath()+”============postHandle==========”);<br>        }<br>        /**<br>         * @Description 在DispatcherServlet完全处理完请求后被调用，也就是说视图渲染已经完毕或者调用者已经拿到结果<br>         * @Date 2019/5/14 16:05<br>         * @Version  1.0<br>         */<br>        @Override<br>        public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex) throws Exception {<br>            System.out.println(request.getContextPath()+”============afterCompletion==========”);<br>        }</p>
<pre><code>    private void returnJson(HttpServletResponse response)&#123;
        PrintWriter writer = null;
        response.setCharacterEncoding(&quot;UTF-8&quot;);
        response.setContentType(&quot;application/json; charset=utf-8&quot;);
        try &#123;
            writer = response.getWriter();
            Map&lt;String, Object&gt; result = PackageReturnResult.returnJson(400, &quot;用户令牌token无效&quot;);
            result.put(&quot;data&quot;, null);
            writer.print(result);
        &#125; catch (IOException e)&#123;
            LoggerUtil.logError(ECInterceptor.class, &quot;拦截器输出流异常&quot;+e);
        &#125; finally &#123;
            if(writer != null)&#123;
                writer.close();
            &#125;
        &#125;
    &#125;
</code></pre>
<h3 id="这个感觉挺好"><a href="#这个感觉挺好" class="headerlink" title="这个感觉挺好"></a>这个感觉挺好</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class LoginInterceptor implements HandlerInterceptor &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line">    @Value(&quot;$&#123;SSO_LOGIN_URL&#125;&quot;)</span><br><span class="line">    private String SSO_LOGIN_URL;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">            Object object) throws Exception &#123;</span><br><span class="line">        // 1、拦截请求url</span><br><span class="line">        // 2、从cookie中取token</span><br><span class="line">        // 3、如果没有toke跳转到登录页面。</span><br><span class="line">        // 4、取到token，需要调用sso系统的服务查询用户信息。</span><br><span class="line">        TbUser user = userService.getUserByToken(request, response);</span><br><span class="line">        // 5、如果用户session已经过期，跳转到登录页面</span><br><span class="line">        if (user == null) &#123;</span><br><span class="line">            response.sendRedirect(SSO_LOGIN_URL+&quot;?redirectURL=&quot;+request.getRequestURI());</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        //把用户对象放入request中</span><br><span class="line">        request.setAttribute(&quot;user&quot;, user);</span><br><span class="line">        // 6、如果没有过期，放行。</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void afterCompletion(HttpServletRequest arg0,</span><br><span class="line">            HttpServletResponse response, Object object, Exception exception)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void postHandle(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">            Object object, ModelAndView modelAndView) throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="2-过滤器filter"><a href="#2-过滤器filter" class="headerlink" title="2.过滤器filter"></a>2.过滤器filter</h1><h3 id="过滤器实现方式"><a href="#过滤器实现方式" class="headerlink" title="过滤器实现方式"></a>过滤器实现方式</h3><p>自定义的过滤器都必须实现javax.Servlet.Filter接口，并重写接口中定义的三个方法：</p>
<p><strong>1.void init(FilterConfig config)</strong></p>
<p>用于完成Filter的初始化。</p>
<p><strong>2.void destory()</strong></p>
<p>用于Filter销毁前，完成某些资源的回收。</p>
<p><strong>3.void doFilter(ServletRequest request,ServletResponse response,FilterChain chain)</strong></p>
<p>实现过滤功能，即对每个请求及响应增加的额外的预处理和后处理。,执行该方法之前，即对用户请求进行预处理；执行该方法之后，即对服务器响应进行后处理。</p>
<p>值得注意的是，chain.doFilter()方法执行之前为预处理阶段，该方法执行结束即代表用户的请求已经得到控制器处理。因此，如果在doFilter中忘记调用chain.doFilter()方法，则用户的请求将得不到处理。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot.filter.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @desc 自定义过滤器，可以在这里处理中文乱码等问题</span></span><br><span class="line"><span class="comment"> * @Author wangsh</span></span><br><span class="line"><span class="comment"> * @date 2018/5/6 15:44</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public class CharacterFilter implements Filter &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 服务启动,调用初始化方法</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param filterConfig</span></span><br><span class="line"><span class="comment">    * @throws ServletException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   @Override</span><br><span class="line">   public void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line"></span><br><span class="line">      System.out.<span class="built_in">println</span>(<span class="string">&quot;服务启动,调用过滤器Filter初始化方法init()..........&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 请求时调用</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param servletRequest</span></span><br><span class="line"><span class="comment">    * @param servletResponse</span></span><br><span class="line"><span class="comment">    * @param filterChain</span></span><br><span class="line"><span class="comment">    * @throws IOException</span></span><br><span class="line"><span class="comment">    * @throws ServletException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   @Override</span><br><span class="line">   public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">      System.out.<span class="built_in">println</span>(<span class="string">&quot;发送请求时,调用过滤器Filter的doFilter()方法..........&quot;</span>);</span><br><span class="line">      <span class="comment">//放行通过</span></span><br><span class="line">      filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 销毁调用</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   @Override</span><br><span class="line">   public void destroy() &#123;</span><br><span class="line"></span><br><span class="line">      System.out.<span class="built_in">println</span>(<span class="string">&quot;服务关闭，调用过滤器Filter的销毁方法destroy()..........&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.springboot.filter.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.springboot.filter.filter.CharacterFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> 注册bean, 将自定义过滤器添加到过滤器链中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wangsh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/5/6 15:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注册过滤器,有两种方式：</span></span><br><span class="line"><span class="comment">    * 1) 使用 <span class="doctag">@Component</span> 注解&lt;br&gt;</span></span><br><span class="line"><span class="comment">    * 2) 添加到过滤器链中，此方式适用于使用第三方的过滤器。将过滤器写到 WebConfig 类中，如下：</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">filterRegistrationBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      FilterRegistrationBean registrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line"></span><br><span class="line">      CharacterFilter filter = <span class="keyword">new</span> CharacterFilter();</span><br><span class="line">      registrationBean.setFilter(filter);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//设置过滤器拦截请求</span></span><br><span class="line">      List&lt;String&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      urls.add(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">      registrationBean.setUrlPatterns(urls);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> registrationBean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>拦截器与过滤器</tag>
      </tags>
  </entry>
  <entry>
    <title>架构</title>
    <url>/2021/11/30/%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E6%97%85/</url>
    <content><![CDATA[<p><img src="/../img/image-20220210164706535.png" alt="image-20220210164706535"></p>
<p>java是跨平台的</p>
<p>运行在java虚拟机上的语言都可以跨平台，生成对应系统的2进制代码</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>架构</tag>
      </tags>
  </entry>
  <entry>
    <title>芋道项目</title>
    <url>/2021/11/30/%E8%8A%8B%E9%81%93%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<h1 id="1-验证码"><a href="#1-验证码" class="headerlink" title="1.验证码"></a>1.验证码</h1><p><img src="/../img/image-20220411203756156.png" alt="image-20220411203756156"></p>
<p><img src="/../img/image-20220411203947202.png" alt="image-20220411203947202"></p>
<p><img src="/../img/image-20220411204043068.png" alt="image-20220411204043068"></p>
<h1 id="2-判断是否有角色权限"><a href="#2-判断是否有角色权限" class="headerlink" title="2.判断是否有角色权限"></a>2.判断是否有角色权限</h1><h2 id="2-1"><a href="#2-1" class="headerlink" title="2.1"></a>2.1</h2><p><img src="/../img/image-20220411204647241.png" alt="image-20220411204647241"></p>
<p><img src="/../img/image-20220411204708463.png" alt="image-20220411204708463"></p>
<h2 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h2><p>以下几个图说明，这个mapper与RoleDO这个实体对应，发现实体有表，点击他的父类的父类，发现有个用逻辑删除注解修饰的字段，回到本段文字上图的方法，crtl+alt+b进入发现是个查询语句，没有条件，又因为有了逻辑删除，所以就是查询全部，逻辑删除不等于1（默认未删除为0）的。</p>
<p><img src="/../img/image-20220411204722416.png" alt="image-20220411204722416"></p>
<p><img src="/../img/image-20220411204734558.png" alt="image-20220411204734558"></p>
<p><img src="/../img/image-20220411204751594.png" alt="image-20220411204751594"></p>
<p><img src="/../img/image-20220411204820420.png" alt="image-20220411204820420"></p>
<h2 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h2><p><img src="/../img/image-20220411205137872.png" alt="image-20220411205137872"></p>
<h2 id="2-4"><a href="#2-4" class="headerlink" title="2.4"></a>2.4</h2><p>随意进入一个controller，发现基本每个controller都有一个注解@PreAuthorize</p>
<p><img src="/../img/image-20220411205257197.png" alt="image-20220411205257197"></p>
<p>发现是security的一个注解</p>
<p><img src="/../img/image-20220412091532600.png" alt="image-20220412091532600"></p>
<p>当@EnableGlobalMethodSecurity(prePostEnabled=true)的时候，@PreAuthorize可以使用<br> @PreAuthorize可以用来控制一个方法是否能够被调用。<br> @在controller层方法中添加权限配置(符合条件得才可以调用这个方法)</p>
<p><img src="/../img/image-20220412112846177.png" alt="image-20220412112846177"></p>
<p>在走这个类的hasPermission这个方法</p>
<h1 id="3-登录方法"><a href="#3-登录方法" class="headerlink" title="3.登录方法"></a>3.登录方法</h1><p><img src="/../img/image-20220412135750908.png" alt="image-20220412135750908"></p>
<p><img src="/../img/image-20220412135817548.png" alt="image-20220412135817548"></p>
<p>在Spring Security中，提交的用户名和密码，被封装成UsernamePasswordAuthenticationToken</p>
<p><img src="/../img/image-20220412140952265.png" alt="image-20220412140952265"></p>
<p><img src="/../img/image-20220412141000515.png" alt="image-20220412141000515"></p>
<p>UsernamePasswordAuthenticationToken 实现了 Authentication 主要是将用户输入的用户名和密 码进行封装，并供给 AuthenticationManager 进行验证；验证完成以后将返回一个认证成功的 Authentication 对象</p>
<h2 id="如何验证？"><a href="#如何验证？" class="headerlink" title="如何验证？"></a>如何验证？</h2><p>继承一个 UserDetailSevice 接口并且加入到容器中，他就是连接我们数据库和 Spring Security 的桥梁。</p>
<p>UserDetailService 的要求也很简单，只需要重写 loadUserByUsername(String username) 方法，里面的逻辑通常是从数据库查找出对应用户名的密码然后构造一个org.springframework.security.core.userdetails.UserDetails对象，Spring Security 会根据返回的这个带有正确用户信息的对象和前台传过来的用户名密码（根据bean指定的加密类型加密后）进行比对来判断是否认证通过。<br><img src="/../img/image-20220412142030777.png" alt="image-20220412142030777"></p>
]]></content>
      <categories>
        <category>芋道项目</category>
      </categories>
      <tags>
        <tag>芋道项目</tag>
      </tags>
  </entry>
  <entry>
    <title>获取自定义配置文件内容</title>
    <url>/2021/11/30/%E8%8E%B7%E5%8F%96%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9/</url>
    <content><![CDATA[<p>用maven构建项目时候resources目录就是默认的classpath<br>classPath即为java文件编译之后的class文件的编译目录一般为web-inf/classes，src下的xml在编译时也会复制到classPath下</p>
<h1 id="jar包内：没有打成jar包"><a href="#jar包内：没有打成jar包" class="headerlink" title="jar包内：没有打成jar包"></a>jar包内：没有打成jar包</h1><h1 id="jar包外：打成了jar包"><a href="#jar包外：打成了jar包" class="headerlink" title="jar包外：打成了jar包"></a>jar包外：打成了jar包</h1><h1 id="1-resources下的文件"><a href="#1-resources下的文件" class="headerlink" title="1.resources下的文件"></a>1.resources下的文件</h1><p><img src="/../hexo%E5%8D%9A%E5%AE%A2/blog/source/img/image-20220225093607849.png" alt="image-20220225093607849"></p>
<h2 id="1-jar包内外，以下方式mian和springboot都可以"><a href="#1-jar包内外，以下方式mian和springboot都可以" class="headerlink" title="1.jar包内外，以下方式mian和springboot都可以"></a>1.jar包内外，以下方式mian和springboot都可以</h2><h3 id="1-ResourceUtils-CLASSPATH-URL-PREFIX-”a-txt”"><a href="#1-ResourceUtils-CLASSPATH-URL-PREFIX-”a-txt”" class="headerlink" title="1.ResourceUtils.CLASSPATH_URL_PREFIX+”a.txt”"></a>1.ResourceUtils.CLASSPATH_URL_PREFIX+”a.txt”</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">File file= null;</span><br><span class="line">try &#123;</span><br><span class="line">   file = ResourceUtils.getFile(ResourceUtils.CLASSPATH_URL_PREFIX+&quot;a.txt&quot;);</span><br><span class="line">&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">FileReader fileReader = FileReader.create(file);</span><br><span class="line">System.out.println(fileReader.readString());</span><br></pre></td></tr></table></figure>

<h3 id="2-GetPath-class-getClassLoader-getResource-“a-txt”"><a href="#2-GetPath-class-getClassLoader-getResource-“a-txt”" class="headerlink" title="2.GetPath.class.getClassLoader().getResource(“a.txt”))))"></a>2.GetPath.class.getClassLoader().getResource(“a.txt”))))</h3><p>注意这种方法需要在test下建立resources以及a.txt</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">File file1= ResourceUtils.getFile(String.valueOf(new File(String.valueOf(GetPath.class.getClassLoader().getResource(&quot;a.txt&quot;)))));</span><br><span class="line">FileReader fileReader1 = FileReader.create(file1);</span><br><span class="line">System.out.println(fileReader1.readString());</span><br></pre></td></tr></table></figure>

<h3 id="3-GetPath-class-getResource-“-“-”a-txt”"><a href="#3-GetPath-class-getResource-“-“-”a-txt”" class="headerlink" title="3.GetPath.class.getResource(“/“)+”a.txt”"></a>3.GetPath.class.getResource(“/“)+”a.txt”</h3><p>注意这种方法需要在test下建立resources以及a.txt</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">File file= ResourceUtils.getFile(GetPath.class.getResource(&quot;/&quot;)+&quot;a.txt&quot;);</span><br><span class="line">FileReader fileReader = FileReader.create(file);</span><br><span class="line">System.out.println(fileReader.readString());</span><br></pre></td></tr></table></figure>

<h2 id="2-ResourceUtil-readUtf8Str-“b-txt”"><a href="#2-ResourceUtil-readUtf8Str-“b-txt”" class="headerlink" title="2.ResourceUtil.readUtf8Str(“b.txt”);"></a>2.ResourceUtil.readUtf8Str(“b.txt”);</h2><p>读取resources下的文件</p>
<p><img src="/../img/image-20220304094904984.png" alt="image-20220304094904984"></p>
<h1 id="2-与src同级的文件"><a href="#2-与src同级的文件" class="headerlink" title="2.与src同级的文件"></a>2.与src同级的文件</h1><p><img src="/../hexo%E5%8D%9A%E5%AE%A2/blog/source/img/image-20220225093647631.png" alt="image-20220225093647631"></p>
<h2 id="jar包内外main和springboot都可以获取"><a href="#jar包内外main和springboot都可以获取" class="headerlink" title="jar包内外main和springboot都可以获取"></a>jar包内外main和springboot都可以获取</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">System.out.println(System.getProperty(&quot;user.dir&quot;));</span><br><span class="line">File file= ResourceUtils.getFile(System.getProperty(&quot;user.dir&quot;)+&quot;\\config\\b.txt&quot;);</span><br><span class="line">FileReader fileReader = FileReader.create(file);</span><br><span class="line">System.out.println(fileReader.readString());</span><br></pre></td></tr></table></figure>

<h2 id="jar包内外springboot获取"><a href="#jar包内外springboot获取" class="headerlink" title="jar包内外springboot获取"></a>jar包内外springboot获取</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jiang.websocket.entity.ProjectConstant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/01/04  16:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:路径工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathUtil</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> PathUtil pathUtil = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 实例化</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> PathUtil <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == pathUtil) &#123;</span><br><span class="line">         pathUtil = <span class="keyword">new</span> PathUtil();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> pathUtil;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span>  String <span class="title">getFileContent</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">      String path = <span class="keyword">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">      <span class="keyword">boolean</span> areJar = path.contains(ProjectConstant.JAR_SUFFIX);</span><br><span class="line">      System.out.println(areJar);</span><br><span class="line">      String resourcePath = areJar ? getDefaultPathToJar(path) : getDefaultPath(path);</span><br><span class="line">      System.out.println(resourcePath);</span><br><span class="line">      resourcePath = resourcePath.concat(fileName);</span><br><span class="line">      System.out.println(resourcePath);</span><br><span class="line">      String str = readFile(resourcePath, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">return</span> str;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取jar方式的默认路径，，默认加了config</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> String <span class="title">getDefaultPathToJar</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">      path = path.substring(<span class="number">0</span>, path.toLowerCase().indexOf(ProjectConstant.JAR_SUFFIX));</span><br><span class="line">      path = path.substring(path.indexOf(ProjectConstant.SPLIT_CHAR) + <span class="number">1</span>, path.lastIndexOf(ProjectConstant.SPLIT_CHAR) + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (!path.contains(ProjectConstant.COLON_CHAR)) &#123;</span><br><span class="line">         path = ProjectConstant.SPLIT_CHAR + path;</span><br><span class="line">      &#125;</span><br><span class="line">      path = path.concat(ProjectConstant.CONFIG_FILE_PATH);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> path;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取默认路径-非jar方式本地测试，，默认加了config</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> String <span class="title">getDefaultPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">      path = path.substring(path.indexOf(ProjectConstant.SPLIT_CHAR) + <span class="number">1</span>, path.indexOf(ProjectConstant.TARGET_SUFFIX) + <span class="number">1</span>);</span><br><span class="line">      path = path.concat(ProjectConstant.CONFIG_FILE_PATH);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> path;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 读取文件内容</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> filePath</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> areJar:是否jar内文件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> String <span class="title">readFile</span><span class="params">(String filePath, <span class="keyword">boolean</span> areJar)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         InputStream input = areJar ? getInstance().getClass().getResourceAsStream(ProjectConstant.SPLIT_CHAR.concat(filePath))</span><br><span class="line">               : <span class="keyword">new</span> FileInputStream(filePath);</span><br><span class="line">         <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[input.available()];</span><br><span class="line">         input.read(bytes);</span><br><span class="line">         String str = <span class="keyword">new</span> String(bytes, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> str;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         ex.printStackTrace();</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class ProjectConstant &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * .jar-后缀</span><br><span class="line">     */</span><br><span class="line">    public static String JAR_SUFFIX = &quot;.jar&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * target-后缀</span><br><span class="line">     */</span><br><span class="line">    public static String TARGET_SUFFIX = &quot;/target&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 分割</span><br><span class="line">     */</span><br><span class="line">    public static String SPLIT_CHAR = &quot;/&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置文件路径</span><br><span class="line">     */</span><br><span class="line">    public static String CONFIG_FILE_PATH = &quot;config/&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 冒号</span><br><span class="line">     */</span><br><span class="line">    public static String COLON_CHAR = &quot;:&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 接口配置文件</span><br><span class="line">     */</span><br><span class="line">    public static String VIEW_MANAGE = &quot;view-manage.xml&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 字段配置文件</span><br><span class="line">     */</span><br><span class="line">    public static String FIELD_MANAGE = &quot;field-manage.xml&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 基本数据类型标识</span><br><span class="line">     */</span><br><span class="line">    public static String BASE_PREFIX_CHAR = &quot;java.lang.&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 下划线</span><br><span class="line">     */</span><br><span class="line">    public static Pattern LINE_PATTERN = Pattern.compile(&quot;_(\\w)&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/getPath2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getPath2</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">   String fileContext = PathUtil.getInstance().getFileContent(<span class="string">&quot;a.txt&quot;</span>);</span><br><span class="line">   System.out.println(fileContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注意需要jar包同级目录config下，config路径是可配置的，可以改名"><a href="#注意需要jar包同级目录config下，config路径是可配置的，可以改名" class="headerlink" title="注意需要jar包同级目录config下，config路径是可配置的，可以改名"></a>注意需要jar包同级目录config下，config路径是可配置的，可以改名</h3><p><img src="/../hexo%E5%8D%9A%E5%AE%A2/blog/source/img/image-20220104171638460.png" alt="image-20220104171638460"></p>
<h3 id="如果jar内的，跟src同级的config下，config路径是可配置的，可以改名"><a href="#如果jar内的，跟src同级的config下，config路径是可配置的，可以改名" class="headerlink" title="如果jar内的，跟src同级的config下，config路径是可配置的，可以改名"></a>如果jar内的，跟src同级的config下，config路径是可配置的，可以改名</h3><p><img src="/../hexo%E5%8D%9A%E5%AE%A2/blog/source/img/image-20220104171700722.png" alt="image-20220104171700722"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>获取自定义配置文件内容</tag>
      </tags>
  </entry>
  <entry>
    <title>实体封装</title>
    <url>/2021/11/30/%E8%BF%94%E5%9B%9E%E5%AE%9E%E4%BD%93%E5%B0%81%E8%A3%85/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/28  8:53</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">public class Result&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private Integer code;</span><br><span class="line">    private String message;</span><br><span class="line">    private T data;</span><br><span class="line"></span><br><span class="line">    protected Result() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected Result(Integer code, String message, T data) &#123;</span><br><span class="line">        this.code = code;</span><br><span class="line">        this.message = message;</span><br><span class="line">        this.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 成功返回结果</span><br><span class="line">     *</span><br><span class="line">     * @param data 获取的数据</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; success(T data) &#123;</span><br><span class="line">        return new Result&lt;T&gt;(ResultCode.SUCCESS.getCode(), ResultCode.SUCCESS.getMessage(), data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 成功返回结果</span><br><span class="line">     *</span><br><span class="line">     * @param data 获取的数据</span><br><span class="line">     * @param  message 提示信息</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; success(T data, String message) &#123;</span><br><span class="line">        return new Result&lt;T&gt;(ResultCode.SUCCESS.getCode(), message, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 失败返回结果</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; fail() &#123;</span><br><span class="line">        return new Result&lt;T&gt;(ResultCode.FAIL.getCode(), ResultCode.FAIL.getMessage(), null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 自定义失败返回结果</span><br><span class="line">     * @param message 提示信息</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; error(String message) &#123;</span><br><span class="line">        return new Result&lt;T&gt;(ResultCode.ERROR.getCode(), message, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 失败返回结果</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; Result&lt;T&gt; error() &#123;</span><br><span class="line">        return new Result&lt;T&gt;(ResultCode.ERROR.getCode(), ResultCode.ERROR.getMessage(), null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public Integer getCode() &#123;</span><br><span class="line">        return code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCode(Integer code) &#123;</span><br><span class="line">        this.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getMessage() &#123;</span><br><span class="line">        return message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMessage(String message) &#123;</span><br><span class="line">        this.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public T getData() &#123;</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setData(T data) &#123;</span><br><span class="line">        this.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/28  8:55</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">public enum  ResultCode &#123;</span><br><span class="line">    SUCCESS(0,&quot;OK&quot;),</span><br><span class="line">    FAIL(-1,&quot;fail&quot;),</span><br><span class="line">    //自定义error-code</span><br><span class="line">    ERROR(999,&quot;发生了错误&quot;);</span><br><span class="line">    /** code */</span><br><span class="line">    private Integer code;</span><br><span class="line">    /** 枚举值 */</span><br><span class="line">    private String message;</span><br><span class="line"></span><br><span class="line">    private ResultCode(Integer code, String message) &#123;</span><br><span class="line"></span><br><span class="line">        this.message = message;</span><br><span class="line">        this.code = code;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getCode() &#123;</span><br><span class="line">        return code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCode(Integer desc) &#123;</span><br><span class="line">        this.code = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMessage(String message) &#123;</span><br><span class="line">        this.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getMessage() &#123;</span><br><span class="line">        return message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Contorller</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;/test&quot;)</span><br><span class="line">public Result&lt;User&gt; demo1(User user)&#123;</span><br><span class="line">    if(user.getName()==null||user.getName().equals(&quot;&quot;))&#123;</span><br><span class="line">        //throw new myException(&quot;aaaaaa&quot;);</span><br><span class="line">        return Result.error(&quot;姓名为空&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    return Result.success(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210928090954296.png" alt="image-20210928090954296"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>实体封装</tag>
      </tags>
  </entry>
  <entry>
    <title>遇到的注解</title>
    <url>/2021/11/30/%E9%81%87%E5%88%B0%E7%9A%84%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="1-Slf4j"><a href="#1-Slf4j" class="headerlink" title="1.@Slf4j"></a>1.@Slf4j</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210913084251122.png" alt="image-20210913084251122"></p>
<h1 id="2-EnableScheduling和-Scheduled"><a href="#2-EnableScheduling和-Scheduled" class="headerlink" title="2.@EnableScheduling和@Scheduled"></a>2.@EnableScheduling和@Scheduled</h1><p><a href="https://blog.csdn.net/rocling/article/details/81490411?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163126564516780357294448%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163126564516780357294448&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-81490411.first_rank_v2_pc_rank_v29&amp;utm_term=EnableScheduling&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/rocling/article/details/81490411?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163126564516780357294448%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163126564516780357294448&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-81490411.first_rank_v2_pc_rank_v29&amp;utm_term=EnableScheduling&amp;spm=1018.2226.3001.4187</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始延迟1秒，每隔2秒</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRateString = &quot;2000&quot;,initialDelay = 1000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFixedRate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;fixedRateString,当前时间：&quot;</span> +format.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每次执行完延迟2秒</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelayString= &quot;2000&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFixedDelay</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;fixedDelayString,当前时间：&quot;</span> +format.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每隔3秒执行一次</span></span><br><span class="line">    <span class="meta">@Scheduled(cron=&quot;0/3 * * * * ?&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCron</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;cron,当前时间：&quot;</span> +format.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>发现启动web都是自动重复执行任务</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210913085837595.png" alt="image-20210913085837595"></p>
<h1 id="3-PostConstruct"><a href="#3-PostConstruct" class="headerlink" title="3.@PostConstruct"></a>3.@PostConstruct</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@PostConstruct</span><br><span class="line">public void init() &#123;</span><br><span class="line">    resStandardDicMapper = this.mapper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://so.csdn.net/so/search?q=Java&spm=1001.2101.3001.7020">Java</a>中该注解的说明：@PostConstruct该注解被用来修饰一个非静态的void（）方法。被@PostConstruct修饰的方法会在服务器加载<a href="https://so.csdn.net/so/search?q=Servlet&spm=1001.2101.3001.7020">Servlet</a>的时候运行，并且只会被服务器执行一次。PostConstruct在构造函数之后执行，init（）方法之前执行。</p>
<h1 id="4-Transient"><a href="#4-Transient" class="headerlink" title="4.@Transient"></a>4.@Transient</h1><p>mybaits忽略不是数据库的属性</p>
<p>如果字段在实体类中需要，但在数据库中不存在，需要加上@Transient这个注解</p>
<h1 id="5-JsonIgnore"><a href="#5-JsonIgnore" class="headerlink" title="5.@JsonIgnore"></a>5.@JsonIgnore</h1><p>name属性上@JsonIgnore</p>
<p><img src="/../img/image-20220304103234347.png" alt="image-20220304103234347"></p>
<p><img src="/../img/image-20220304103301142.png" alt="image-20220304103301142"></p>
<p>前端接受不到name属性</p>
<p><img src="/../img/image-20220304103319124.png" alt="image-20220304103319124"></p>
<h1 id="6-MapperScan扫描mapper"><a href="#6-MapperScan扫描mapper" class="headerlink" title="6.@MapperScan扫描mapper"></a>6.@MapperScan扫描mapper</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@MapperScan(&#123;&quot;com.jiang.websocket.mapper&quot;&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="7-mybaitsplus-Options"><a href="#7-mybaitsplus-Options" class="headerlink" title="7.mybaitsplus@Options"></a>7.mybaitsplus@Options</h1><p>新增以后返回主键</p>
<p><img src="/../img/image-20220310163940781.png" alt="image-20220310163940781"></p>
<h1 id="8-Transactional（rollbackFor-Exception-class）"><a href="#8-Transactional（rollbackFor-Exception-class）" class="headerlink" title="8.@Transactional（rollbackFor = Exception.class）"></a>8.@Transactional（rollbackFor = Exception.class）</h1><p>放在service实现类层</p>
<h1 id="9-builder"><a href="#9-builder" class="headerlink" title="9.@builder"></a>9.@builder</h1><p>快速建立一个对象</p>
<p><img src="/../img/image-20220411112100594.png" alt="image-20220411112100594"></p>
<h1 id="10-ConfigurationProperties"><a href="#10-ConfigurationProperties" class="headerlink" title="10.@ConfigurationProperties"></a>10.@ConfigurationProperties</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">把springboot配置文件中的值与我们的xxxProperties.java的属性进行绑定</span><br></pre></td></tr></table></figure>

<p>配合容器注解@Compent一起使用</p>
<p><img src="/../img/image-20220411172510694.png" alt="image-20220411172510694"></p>
<h1 id="11-EnableConfigurationProperties"><a href="#11-EnableConfigurationProperties" class="headerlink" title="11.@EnableConfigurationProperties"></a>11.@EnableConfigurationProperties</h1><p>平常我们使用@component+@ConfigurationProperties就可以获取到配置文件里的内容</p>
<p>但是如果是第三方jar包，里面没有@component注解，就可以使用</p>
<p>@EnableConfigurationProperties（ConfigurationProperties的特定类.class）即可</p>
<h1 id="12-Configuration"><a href="#12-Configuration" class="headerlink" title="12.@Configuration"></a>12.@Configuration</h1><p>用于定义配置类，可替换xml配置文件，被注解的类内部包含有一个或多个被@Bean注解的方法</p>
<p><img src="/../img/image-20220411172634676.png" alt="image-20220411172634676"></p>
<h1 id="13-Bean-基础概念"><a href="#13-Bean-基础概念" class="headerlink" title="13.@Bean 基础概念"></a>13.@Bean 基础概念</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Bean：Spring的@Bean注解用于告诉方法，产生一个Bean对象，然后这个Bean对象交给Spring管理。产生这个Bean对象的方法Spring只会调用一次，随后这个Spring将会将这个Bean对象放在自己的IOC容器中；SpringIOC 容器管理一个或者多个bean，这些bean都需要在@Configuration注解下进行创建，在一个方法上使用@Bean注解就表明这个方法需要交给Spring进行管理；</span><br><span class="line"></span><br><span class="line">@Configuration与@Bean结合使用：@Configuration可理解为用spring的时候xml里面的标签，@Bean可理解为用spring的时候xml里面的标签；</span><br><span class="line"></span><br><span class="line">可以理解，注册一个bean对象，然后对这个bean进行处理，返回给spring容器，我们在其他类中使用@Autowired , @Resource就可以获取到了，比如service层以及dao层也都需要使用注解注册到容器中，@bean的作用一致</span><br></pre></td></tr></table></figure>

<h1 id="14-EnableGlobalMethodSecurity以及-preauthorize"><a href="#14-EnableGlobalMethodSecurity以及-preauthorize" class="headerlink" title="14.@EnableGlobalMethodSecurity以及@preauthorize"></a>14.@EnableGlobalMethodSecurity以及@preauthorize</h1><p><strong>Spring Security</strong> 配置类开启权限控制注解，即 **@EnableGlobalMethodSecurity(prePostEnabled = true)**。</p>
<h1 id="15-TableLogic"><a href="#15-TableLogic" class="headerlink" title="15.@TableLogic"></a>15.@TableLogic</h1><p>注解表示逻辑删除</p>
<p><img src="/../img/image-20220411202653609.png" alt="image-20220411202653609"></p>
<h1 id="16-SpringBoot不返回-Null-字段，设置某些字段不返回前端"><a href="#16-SpringBoot不返回-Null-字段，设置某些字段不返回前端" class="headerlink" title="16.SpringBoot不返回 Null 字段，设置某些字段不返回前端"></a>16.SpringBoot不返回 Null 字段，设置某些字段不返回前端</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//可以放类上也可以放属性上</span><br><span class="line">@JsonInclude(JsonInclude.Include.NON_NULL)</span><br><span class="line">public class User&#123;&#125;</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">@JsonInclude(JsonInclude.Include.NON_NULL)</span><br><span class="line">private String name;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>遇到的注解</tag>
      </tags>
  </entry>
  <entry>
    <title>阿里巴巴开发手册</title>
    <url>/2021/11/30/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1 id="命名风格"><a href="#命名风格" class="headerlink" title="命名风格"></a>命名风格</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3. 【参考】分层领域模型规约：</span><br><span class="line"> DO（Data Object）：与数据库表结构一一对应，通过 DAO 层向上传输数据源对象。</span><br><span class="line"> DTO（Data Transfer Object）：数据传输对象，Service 或 Manager 向外传输的对象。</span><br><span class="line"> BO（Business Object）：业务对象。由 Service 层输出的封装业务逻辑的对象。</span><br><span class="line"> AO（Application Object）：应用对象。在 Web 层与 Service 层之间抽象的复用对象模型，</span><br><span class="line">极为贴近展示层，复用度不高。</span><br><span class="line"> VO（View Object）：显示层对象，通常是 Web 向模板渲染引擎层传输的对象。</span><br><span class="line"> Query：数据查询对象，各层接收上层的查询请求。注意超过 2 个参数的查询封装，禁止</span><br><span class="line">使用 Map 类来传输。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】类名使用 UpperCamelCase 风格，必须遵从驼峰形式，但以下情形例外：DO / BO /</span><br><span class="line">   DTO / VO / AO</span><br><span class="line">   正例：MarcoPolo / UserDO / XmlService / TcpUdpDeal / TaPromotion</span><br><span class="line">   反例：macroPolo / UserDo / XMLService / TCPUDPDeal / TAPromotion</span><br><span class="line">2. 【强制】POJO 类中布尔类型的变量，都不要加 is，否则部分框架解析会引起序列化错误。</span><br><span class="line">   反例：定义为基本数据类型 Boolean isDeleted；的属性，它的方法也是 isDeleted()，RPC</span><br><span class="line">   阿里巴巴 Java 开发手册</span><br><span class="line">    ——禁止用于商业用途，违者必究—— 2 /35</span><br><span class="line">   框架在反向解析的时候，“以为”对应的属性名称是 deleted，导致属性获取不到，进而抛出异</span><br><span class="line">   常。</span><br><span class="line">3. 【推荐】接口类中的方法和属性不要加任何修饰符号（public 也不要加），保持代码的简洁</span><br><span class="line">   性，并加上有效的 Javadoc 注释。尽量不要在接口里定义变量，如果一定要定义变量，肯定是</span><br><span class="line">   与接口方法相关，并且是整个应用的基础常量。</span><br><span class="line">   正例：接口方法签名：void f();</span><br><span class="line">    接口基础常量表示：String COMPANY = &quot;alibaba&quot;;</span><br><span class="line">   反例：接口方法定义：public abstract void f();</span><br><span class="line">   说明：JDK8 中接口允许有默认实现，那么这个 default 方法，是对所有实现类都有价值的默</span><br><span class="line">   认实现。</span><br><span class="line">4. 【参考】枚举类名建议带上 Enum 后缀，枚举成员名称需要全大写，单词间用下划线隔开。</span><br><span class="line">   说明：枚举其实就是特殊的常量类，且构造方法被默认强制是私有。</span><br><span class="line">   正例：枚举名字为 ProcessStatusEnum 的成员名称：SUCCESS / UNKOWN_REASON。</span><br><span class="line">5. 【参考】各层命名规约：</span><br><span class="line">   A) Service/DAO 层方法命名规约</span><br><span class="line">   1） 获取单个对象的方法用 get 做前缀。</span><br><span class="line">   2） 获取多个对象的方法用 list 做前缀。</span><br><span class="line">   3） 获取统计值的方法用 count 做前缀。</span><br><span class="line">   4） 插入的方法用 save/insert 做前缀。</span><br><span class="line">   5） 删除的方法用 remove/delete 做前缀。</span><br><span class="line">   6） 修改的方法用 update 做前缀。</span><br><span class="line">   B) 领域模型命名规约</span><br><span class="line">   1） 数据对象：xxxDO，xxx 即为数据表名。</span><br><span class="line">   2） 数据传输对象：xxxDTO，xxx 为业务领域相关的名称。</span><br><span class="line">   3） 展示对象：xxxVO，xxx 一般为网页名称。</span><br><span class="line">   4） POJO 是 DO/DTO/BO/VO 的统称，禁止命名成 xxxPOJO。</span><br></pre></td></tr></table></figure>

<h1 id="常量定义"><a href="#常量定义" class="headerlink" title="常量定义"></a>常量定义</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】不允许任何魔法值（即未经定义的常量）直接出现在代码中。</span><br><span class="line">反例：String key = &quot;Id#taobao_&quot; + tradeId;</span><br><span class="line"> cache.put(key, value);</span><br><span class="line"> </span><br><span class="line">2. 【强制】long 或者 Long 初始赋值时，使用大写的 L，不能是小写的 l，小写容易跟数字 1 混</span><br><span class="line">淆，造成误解。</span><br><span class="line">说明：Long a = 2l; 写的是数字的 21，还是 Long 型的 2?</span><br></pre></td></tr></table></figure>

<h1 id="代码格式"><a href="#代码格式" class="headerlink" title="代码格式"></a>代码格式</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 缩进 4 个空格</span></span><br><span class="line">    String say = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="comment">// 运算符的左右必须有一个空格</span></span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关键词 if 与括号之间必须有一个空格，括号内的 f 与左括号，0 与右括号不需要空格</span></span><br><span class="line">    <span class="keyword">if</span> (flag == <span class="number">0</span>) &#123;</span><br><span class="line">    	System.out.println(say);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 左大括号前加空格且不换行；左大括号后换行</span></span><br><span class="line">    <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">    	System.out.println(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">    <span class="comment">// 右大括号前换行，右大括号后有 else，不用换行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    <span class="comment">// 在右大括号后直接结束，则必须换行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 【强制】注释的双斜线与注释内容之间有且仅有一个空格。</span><br><span class="line">正例：<span class="comment">// 注释内容，注意在//和注释内容之间有一个空格。</span></span><br><span class="line">    </span><br><span class="line"><span class="number">7.</span> 【强制】单行字符数限制不超过 <span class="number">120</span> 个，超出需要换行，换行时遵循如下原则：</span><br><span class="line"><span class="number">1</span>） 第二行相对第一行缩进 <span class="number">4</span> 个空格，从第三行开始，不再继续缩进，参考示例。</span><br><span class="line"><span class="number">2</span>） 运算符与下文一起换行。</span><br><span class="line"><span class="number">3</span>） 方法调用的点符号与下文一起换行。</span><br><span class="line"><span class="number">4</span>） 方法调用时，多个参数，需要换行时，在逗号后进行。</span><br><span class="line"><span class="number">5</span>） 在括号前不要换行，见反例。</span><br><span class="line">正例：</span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"><span class="comment">// 超过 120 个字符的情况下，换行缩进 4 个空格，点号和方法名称一起换行</span></span><br><span class="line">sb.append(<span class="string">&quot;zi&quot;</span>).append(<span class="string">&quot;xin&quot;</span>)...</span><br><span class="line">.append(<span class="string">&quot;huang&quot;</span>)...</span><br><span class="line">.append(<span class="string">&quot;huang&quot;</span>)...</span><br><span class="line">.append(<span class="string">&quot;huang&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8.</span> 【强制】方法参数在定义和传入时，多个参数逗号后边必须加空格。</span><br><span class="line">正例：下例中实参的<span class="string">&quot;a&quot;</span>,后边必须要有一个空格。</span><br><span class="line">method(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="number">9.</span> 【强制】IDE 的 text file encoding 设置为 UTF-<span class="number">8</span>; IDE 中文件的换行符使用 Unix 格式，不要使用 Windows 格式。</span><br></pre></td></tr></table></figure>

<h1 id="OOP-规约"><a href="#OOP-规约" class="headerlink" title="OOP 规约"></a>OOP 规约</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】避免通过一个类的对象引用访问此类的静态变量或静态方法，无谓增加编译器解析成</span><br><span class="line">本，直接用类名来访问即可。</span><br><span class="line"></span><br><span class="line">2. 【强制】所有的覆写方法，必须加@Override 注解。</span><br><span class="line">说明：getObject()与 get0bject()的问题。一个是字母的 O，一个是数字的 0，加@Override</span><br><span class="line">可以准确判断是否覆盖成功。另外，如果在抽象类中对方法签名进行修改，其实现类会马上编译报错。</span><br><span class="line"></span><br><span class="line">6. 【强制】Object 的 equals 方法容易抛空指针异常，应使用常量或确定有值的对象来调用</span><br><span class="line">equals。</span><br><span class="line">正例：&quot;test&quot;.equals(object);</span><br><span class="line">反例：object.equals(&quot;test&quot;);</span><br><span class="line"></span><br><span class="line">7. 【强制】所有的相同类型的包装类对象之间值的比较，全部使用 equals 方法比较。</span><br><span class="line"></span><br><span class="line">8. 关于基本数据类型与包装数据类型的使用标准如下：</span><br><span class="line">1） 【强制】所有的 POJO 类属性必须使用包装数据类型。</span><br><span class="line">2） 【强制】RPC 方法的返回值和参数必须使用包装数据类型。</span><br><span class="line">3） 【推荐】所有的局部变量使用基本数据类型。</span><br><span class="line"></span><br><span class="line">9. 【强制】定义 DO/DTO/VO 等 POJO 类时，不要设定任何属性默认值。</span><br><span class="line"></span><br><span class="line">10. 【强制】序列化类新增属性时，请不要修改 serialVersionUID 字段，避免反序列失败；如</span><br><span class="line">果完全不兼容升级，避免反序列化混乱，那么请修改 serialVersionUID 值。</span><br><span class="line">说明：注意 serialVersionUID 不一致会抛出序列化运行时异常。</span><br><span class="line"></span><br><span class="line">17. 【推荐】循环体内，字符串的连接方式，使用 StringBuilder 的 append 方法进行扩展。</span><br><span class="line">说明：反编译出的字节码文件显示每次循环都会 new 出一个 StringBuilder 对象，然后进行</span><br><span class="line">append 操作，最后通过 toString 方法返回 String 对象，造成内存资源浪费。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="集合处理"><a href="#集合处理" class="headerlink" title="集合处理"></a>集合处理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】关于 hashCode 和 equals 的处理，遵循如下规则：</span><br><span class="line">1） 只要重写 equals，就必须重写 hashCode。</span><br><span class="line">2） 因为 Set 存储的是不重复的对象，依据 hashCode 和 equals 进行判断，所以 Set 存储的</span><br><span class="line">对象必须重写这两个方法。</span><br><span class="line">3） 如果自定义对象做为 Map 的键，那么必须重写 hashCode 和 equals。</span><br><span class="line">说明：String 重写了 hashCode 和 equals 方法，所以我们可以非常愉快地使用 String 对象</span><br><span class="line">作为 key 来使用。</span><br><span class="line"></span><br><span class="line">4. 【强制】使用集合转数组的方法，必须使用集合的 toArray(T[] array)，传入的是类型完全</span><br><span class="line">一样的数组，大小就是 list.size()。</span><br><span class="line">正例：</span><br><span class="line">List&lt;String&gt; list = new ArrayList&lt;String&gt;(2);</span><br><span class="line">list.add(&quot;guan&quot;);</span><br><span class="line">list.add(&quot;bao&quot;);</span><br><span class="line">String[] array = new String[list.size()];</span><br><span class="line">array = list.toArray(array); </span><br><span class="line"></span><br><span class="line">5. 【强制】使用工具类 Arrays.asList()把数组转换成集合时，不能使用其修改集合相关的方</span><br><span class="line">法，它的 add/remove/clear 方法会抛出 UnsupportedOperationException 异常。</span><br><span class="line">说明：asList 的返回对象是一个 Arrays 内部类，并没有实现集合的修改方法。Arrays.asList</span><br><span class="line">体现的是适配器模式，只是转换接口，后台的数据仍是数组。</span><br><span class="line"> String[] str = new String[] &#123; &quot;you&quot;, &quot;wu&quot; &#125;;</span><br><span class="line"> List list = Arrays.asList(str);</span><br><span class="line">第一种情况：list.add(&quot;yangguanbao&quot;); 运行时异常。</span><br><span class="line">第二种情况：str[0] = &quot;gujin&quot;; 那么 list.get(0)也会随之修改。</span><br><span class="line"></span><br><span class="line">7. 【强制】不要在 foreach 循环里进行元素的 remove/add 操作。remove 元素请使用 Iterator</span><br><span class="line">方式，如果并发操作，需要对 Iterator 对象加锁。</span><br><span class="line">正例：</span><br><span class="line">Iterator&lt;String&gt; iterator = list.iterator();</span><br><span class="line">while (iterator.hasNext()) &#123;</span><br><span class="line">String item = iterator.next();</span><br><span class="line">if (删除元素的条件) &#123;</span><br><span class="line">iterator.remove();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">9. 【推荐】集合初始化时，指定集合初始值大小。</span><br><span class="line"></span><br><span class="line">10. 【推荐】使用 entrySet 遍历 Map 类集合 KV，而不是 keySet 方式进行遍历。</span><br></pre></td></tr></table></figure>

<h1 id="并发处理"><a href="#并发处理" class="headerlink" title="并发处理"></a>并发处理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3. 【强制】线程资源必须通过线程池提供，不允许在应用中自行显式创建线程。</span><br><span class="line"></span><br><span class="line">4. 【强制】线程池不允许使用 Executors 去创建，而是通过 ThreadPoolExecutor 的方式，这样</span><br><span class="line">的处理方式让写的同学更加明确线程池的运行规则，规避资源耗尽的风险。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 【强制】在一个 <span class="keyword">switch</span> 块内，每个 <span class="keyword">case</span> 要么通过 <span class="keyword">break</span>/<span class="keyword">return</span> 等来终止，要么注释说明程</span><br><span class="line">序将继续执行到哪一个 <span class="keyword">case</span> 为止；在一个 <span class="keyword">switch</span> 块内，都必须包含一个 <span class="keyword">default</span> 语句并且</span><br><span class="line">放在最后，即使它什么代码也没有。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 【强制】在 <span class="keyword">if</span>/<span class="keyword">else</span>/<span class="keyword">for</span>/<span class="keyword">while</span>/<span class="keyword">do</span> 语句中必须使用大括号。即使只有一行代码</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 【推荐】表达异常的分支时，少用 <span class="keyword">if</span>-<span class="keyword">else</span> 方式，这种方式可以改写成：</span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line"> ...</span><br><span class="line"> <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 接着写 else 的业务逻辑代码;</span></span><br><span class="line">说明：如果非得使用 <span class="keyword">if</span>()...<span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">()</span>...<span class="keyword">else</span>...方式表达逻辑，【强制】避免后续代码维</span></span><br><span class="line"><span class="function">护困难，请勿超过 3 层。</span></span><br><span class="line"><span class="function">正例：超过 3 层的 <span class="keyword">if</span>-<span class="keyword">else</span> 的逻辑判断代码可以使用卫语句、策略模式、状态模式等来实现，</span></span><br><span class="line"><span class="function">其中卫语句示例如下：</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">today</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (isBusy()) &#123;</span><br><span class="line">System.out.println(“change time.”);</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (isFree()) &#123;</span><br><span class="line">System.out.println(“go to travel.”);</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line">System.out.println(“stay at home to learn Alibaba Java Coding Guidelines.”);</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 【推荐】除常用方法（如 getXxx/isXxx）等外，不要在条件判断中执行其它复杂的语句，将复</span><br><span class="line">杂逻辑判断的结果赋值给一个有意义的布尔变量名，以提高可读性。</span><br><span class="line">说明：很多 <span class="keyword">if</span> 语句内的逻辑相当复杂，阅读者需要分析条件表达式的最终结果，才能明确什么</span><br><span class="line">样的条件执行什么样的语句，那么，如果阅读者分析逻辑表达式错误呢？</span><br><span class="line">正例：</span><br><span class="line"><span class="comment">// 伪代码如下</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> existed = (file.open(fileName, <span class="string">&quot;w&quot;</span>) != <span class="keyword">null</span>) &amp;&amp; (...) || (...);</span><br><span class="line"><span class="keyword">if</span> (existed) &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line">反例：</span><br><span class="line"><span class="keyword">if</span> ((file.open(fileName, <span class="string">&quot;w&quot;</span>) != <span class="keyword">null</span>) &amp;&amp; (...) || (...)) &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 【推荐】循环体中的语句要考量性能，以下操作尽量移至循环体外处理，如定义对象、变量</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h1 id="注释规约"><a href="#注释规约" class="headerlink" title="注释规约"></a>注释规约</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】类、类属性、类方法的注释必须使用 Javadoc 规范，使用/**内容*/格式，不得使用</span><br><span class="line">// xxx 方式。</span><br><span class="line">说明：在 IDE 编辑窗口中，Javadoc 方式会提示相关注释，生成 Javadoc 可以正确输出相应注</span><br><span class="line">释；在 IDE 中，工程调用方法时，不进入方法即可悬浮提示方法、参数、返回值的意义，提高</span><br><span class="line">阅读效率。</span><br><span class="line"></span><br><span class="line">2. 【强制】所有的抽象方法（包括接口中的方法）必须要用 Javadoc 注释、除了返回值、参数、</span><br><span class="line">异常说明外，还必须指出该方法做什么事情，实现什么功能。</span><br><span class="line">说明：对子类的实现要求，或者调用注意事项，请一并说明。</span><br><span class="line"></span><br><span class="line">3. 【强制】所有的类都必须添加创建者和创建日期。</span><br><span class="line"></span><br><span class="line">4. 【强制】方法内部单行注释，在被注释语句上方另起一行，使用//注释。方法内部多行注释</span><br><span class="line">使用/* */注释，注意与代码对齐。</span><br></pre></td></tr></table></figure>

<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">5. 【强制】获取当前毫秒数 System.currentTimeMillis(); 而不是 new Date().getTime();</span><br></pre></td></tr></table></figure>

<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】Java 类库中定义的一类 RuntimeException 可以通过预先检查进行规避，而不应该</span><br><span class="line">通过 catch 来处理，比如：IndexOutOfBoundsException，NullPointerException 等等。</span><br><span class="line">说明：无法通过预检查的异常除外，如在解析一个外部传来的字符串形式数字时，通过 catch</span><br><span class="line">NumberFormatException 来实现。</span><br><span class="line">正例：if (obj != null) &#123;...&#125;</span><br><span class="line">反例：try &#123; obj.method() &#125; catch (NullPointerException e) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">7. 【强制】不能在 finally 块中使用 return，finally 块中的 return 返回后方法结束执行，不</span><br><span class="line">会再执行 try 块中的 return 语句。</span><br></pre></td></tr></table></figure>

<h1 id="安全规约-！"><a href="#安全规约-！" class="headerlink" title="安全规约 ！"></a>安全规约 ！</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2. 【强制】用户敏感数据禁止直接展示，必须对展示数据进行脱敏。</span><br><span class="line">说明：查看个人手机号码会显示成:158****9119，隐藏中间 4 位，防止隐私泄露。</span><br><span class="line">3. 【强制】用户输入的 SQL 参数严格使用参数绑定或者 METADATA 字段值限定，防止 SQL 注入，</span><br><span class="line">禁止字符串拼接 SQL 访问数据库。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="MySQL-数据库"><a href="#MySQL-数据库" class="headerlink" title="MySQL 数据库"></a>MySQL 数据库</h1><h2 id="一-建表规约"><a href="#一-建表规约" class="headerlink" title="(一)建表规约"></a>(一)建表规约</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】表达是与否概念的字段，必须使用 is_xxx 的方式命名，数据类型是 unsigned tinyint</span><br><span class="line">（ 1 表示是，0 表示否）。</span><br><span class="line">说明：任何字段如果为非负数，必须是 unsigned。</span><br><span class="line">正例：表达逻辑删除的字段名 is_deleted，1 表示删除，0 表示未删除。</span><br></pre></td></tr></table></figure>

<h2 id="SQL-语句"><a href="#SQL-语句" class="headerlink" title="SQL 语句"></a>SQL 语句</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 【强制】不要使用 count(列名)或 count(常量)来替代 count(*)，count(*)是 SQL92 定义的</span><br><span class="line">标准统计行数的语法，跟数据库无关，跟 NULL 和非 NULL 无关。</span><br><span class="line">说明：count(*)会统计值为 NULL 的行，而 count(列名)不会统计此列为 NULL 值的行。</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>阿里巴巴开发手册</tag>
      </tags>
  </entry>
  <entry>
    <title>跨域问题</title>
    <url>/2021/11/30/%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">第一种方法</span><br><span class="line"><span class="keyword">package</span> com.jiang.websocket.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ORIGINS[]=<span class="keyword">new</span> String[] &#123;<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>,<span class="string">&quot;PUT&quot;</span>,<span class="string">&quot;DELETE&quot;</span>&#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span></span>&#123;</span><br><span class="line">            registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                    .allowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                    .allowCredentials(<span class="keyword">true</span>)</span><br><span class="line">                    .allowedMethods(ORIGINS)</span><br><span class="line">                    .maxAge(<span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="第一种好用"><a href="#第一种好用" class="headerlink" title="第一种好用"></a>第一种好用</h1><p>nginx配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add_header Access-Control-Allow-Origin &#x27;*&#x27;;</span><br><span class="line">            add_header Access-Control-Allow-Methods &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line">            add_header Access-Control-Allow-Headers &#x27;Authorization,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;;</span><br><span class="line"></span><br><span class="line">            if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">                return 204;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line">           add_header Access-Control-Allow-Credentials false;</span><br><span class="line">           add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220402134201157.png" alt="image-20220402134201157"></p>
<h1 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h1><p>在controller的方法上+@CrossOrigin</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210830173643434.png" alt="image-20210830173643434"></p>
<h1 id="第三种，好用"><a href="#第三种，好用" class="headerlink" title="第三种，好用"></a>第三种，好用</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tulingxueyuan.mall.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局跨域配置</span></span><br><span class="line"><span class="comment"> * Created by macro on 2019/7/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalCorsConfig</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 允许跨域调用的过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsFilter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CorsConfiguration config = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        <span class="comment">//允许所有域名进行跨域调用</span></span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//允许跨越发送cookie</span></span><br><span class="line">        config.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//放行全部原始头信息</span></span><br><span class="line">        config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//允许所有请求方法跨域调用</span></span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="谷粒商城项目"><a href="#谷粒商城项目" class="headerlink" title="谷粒商城项目"></a>谷粒商城项目</h1><h3 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h3><p>域名，端口，ip，有一个不一样即为跨域</p>
<p><strong>简单请求</strong>（get，post，head）</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211027095032025.png" alt="image-20211027095032025"></p>
<p><strong>非简单请求</strong></p>
<p>put，delete等</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211027095233337.png" alt="image-20211027095233337"></p>
<p>如果是非简单请求，会先发送一个options请求,如果允许跨域，才会发送真正的请求</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211027095611534.png" alt="image-20211027095611534"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211027095636395.png" alt="image-20211027095636395"></p>
<p>用第二种，在网关里配置，统一解决跨域问题</p>
<p>创建config文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class GulimallCorsConfiguration &#123;</span><br><span class="line">	@Bean</span><br><span class="line">    public CorsWebFilter corsWebFilter()&#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        CorsConfiguration config=new CorsConfiguration();</span><br><span class="line">        //配置跨域</span><br><span class="line">        //允许所有域名进行跨域调用</span><br><span class="line">        config.addAllowedOrigin(&quot;*&quot;);</span><br><span class="line">        //允许跨越发送cookie</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        //放行全部原始头信息</span><br><span class="line">        config.addAllowedHeader(&quot;*&quot;);</span><br><span class="line">        //允许所有请求方法跨域调用</span><br><span class="line">        config.addAllowedMethod(&quot;*&quot;);</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;,config);</span><br><span class="line">        return new CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>跨域问题</tag>
      </tags>
  </entry>
  <entry>
    <title>问题整理</title>
    <url>/2021/11/30/%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86/</url>
    <content><![CDATA[<h1 id="1-gitgnore忽略文件导致maven引入的包中的类无法使用"><a href="#1-gitgnore忽略文件导致maven引入的包中的类无法使用" class="headerlink" title="1..gitgnore忽略文件导致maven引入的包中的类无法使用"></a>1..gitgnore忽略文件导致maven引入的包中的类无法使用</h1><p>导入maven包，发现打不开data目录了</p>
<p><img src="/../img/image-20220217151750389.png" alt="image-20220217151750389"></p>
<p>最终发现是.gitgnore中添加了data</p>
<p><img src="/../img/image-20220217151813581.png" alt="image-20220217151813581"></p>
<h1 id="2-springbootTest测试时，报错Invocation-of-init-method-failed"><a href="#2-springbootTest测试时，报错Invocation-of-init-method-failed" class="headerlink" title="2.springbootTest测试时，报错Invocation of init method failed"></a>2.springbootTest测试时，报错Invocation of init method failed</h1><p>1.看下controller里是否有其他main方法</p>
<p>2.测试类不对</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootTest(classes = 你的启动类.class, webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span><br><span class="line">@RunWith(SpringRunner.class)</span><br></pre></td></tr></table></figure>

<h1 id="3-springboot扫描不到-service包"><a href="#3-springboot扫描不到-service包" class="headerlink" title="3.springboot扫描不到@service包"></a>3.springboot扫描不到@service包</h1><p>原因</p>
<p>springboot 默认扫描的路径，是该工程application启动类所在包以及所有子包下的所有文件，需要把启动类放在外面，不能跟其他包同级</p>
<p><img src="/../img/image-20220326100843443.png" alt="image-20220326100843443"></p>
<p>公司可以同级应该是哪块配置了扫描包</p>
<p>比如</p>
<p><img src="/../img/image-20220326100917622.png" alt="image-20220326100917622"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>问题整理</tag>
      </tags>
  </entry>
  <entry>
    <title>23中设计模式</title>
    <url>/2021/11/30/23%E4%B8%AD%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h1 id="1-单例模式（重点）"><a href="#1-单例模式（重点）" class="headerlink" title="1.单例模式（重点）"></a>1.单例模式（重点）</h1><p>工具类都可以</p>
<h2 id="1-饿汉式"><a href="#1-饿汉式" class="headerlink" title="1.饿汉式"></a>1.饿汉式</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.test;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 优点：从它的实现中我们可以看到，这种方式的实现比较简单，在类加载的时候就完成了实例化，避免了线程的同步问题。</span><br><span class="line"> * 缺点：由于在类加载的时候就实例化了，所以没有达到Lazy Loading(懒加载)的效果，也就是说可能我没有用到这个实例，但是它</span><br><span class="line"> * 也会加载，会造成内存的浪费(但是这个浪费可以忽略，所以这种方式也是推荐使用的)。</span><br><span class="line"> */</span><br><span class="line">public class SingletonEHan &#123;</span><br><span class="line">    private SingletonEHan() &#123;&#125;</span><br><span class="line">    /**</span><br><span class="line">     * 1.单例模式的饿汉式[可用]</span><br><span class="line">     */</span><br><span class="line">    private static SingletonEHan singletonEHan = new SingletonEHan();</span><br><span class="line">    public static SingletonEHan getInstance() &#123;</span><br><span class="line">        return singletonEHan;</span><br><span class="line">    &#125;</span><br><span class="line">    //使用  SingletonEHan instance= SingletonEHan.getInstance();</span><br><span class="line">    /**</span><br><span class="line">     * 2. 单例模式的饿汉式变换写法[可用]</span><br><span class="line">     * 基本没区别</span><br><span class="line">     */</span><br><span class="line">    private static SingletonEHan singletonEHanTwo = null;</span><br><span class="line">    static &#123;</span><br><span class="line">        singletonEHanTwo = new SingletonEHan();</span><br><span class="line">    &#125;</span><br><span class="line">    public static SingletonEHan getSingletonEHan() &#123;</span><br><span class="line">        if (singletonEHanTwo == null) &#123;</span><br><span class="line">            singletonEHanTwo = new SingletonEHan();</span><br><span class="line">        &#125;</span><br><span class="line">        return singletonEHanTwo;</span><br><span class="line">    &#125;</span><br><span class="line">    //使用     SingletonEHan instance= SingletonEHan.getSingletonEHan();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-懒汉式-最好"><a href="#2-懒汉式-最好" class="headerlink" title="2.懒汉式(最好)"></a>2.懒汉式(最好)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 1.单例模式懒汉式双重校验锁[推荐用]</span><br><span class="line">     * 懒汉式变种,属于懒汉式的最好写法,保证了:延迟加载和线程安全</span><br><span class="line">     */</span><br><span class="line">    private static SingletonLanHan singletonLanHanFour;</span><br><span class="line"></span><br><span class="line">    public static SingletonLanHan getSingletonLanHanFour() &#123;</span><br><span class="line">        if (singletonLanHanFour == null) &#123;</span><br><span class="line">            synchronized (SingletonLanHan.class) &#123;</span><br><span class="line">                if (singletonLanHanFour == null) &#123;</span><br><span class="line">                    singletonLanHanFour = new SingletonLanHan();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return singletonLanHanFour;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-观察者模式（重点）"><a href="#2-观察者模式（重点）" class="headerlink" title="2.观察者模式（重点）"></a>2.观察者模式（重点）</h1><p>一对多，一改变时，多个也要改变（或者接收到通知）</p>
<h2 id="1-subject"><a href="#1-subject" class="headerlink" title="1.subject"></a>1.subject</h2><p>这是总的接口，来一个主题就继承这个接口</p>
<p>主题：比如A事是1对多，那么这个A事就要实现</p>
<p>​                   B事是1对多，那么这个B事就要实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.test.demo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by jingbin on 2016/10/21.</span></span><br><span class="line"><span class="comment"> * 专题接口,所有的主题必须实现此接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册一个观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除一个观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知所有观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-ObjectFor3D"><a href="#2-ObjectFor3D" class="headerlink" title="2.ObjectFor3D"></a>2.ObjectFor3D</h2><p>就是主题，也就是A事或者B事</p>
<p>主题要实现subject</p>
<p>除了主题更新信息方法，其他的方法基本不用多，大同小异</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.test.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by jingbin on 2016/10/21.</span></span><br><span class="line"><span class="comment"> * 接下来3D服务号的实现类：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectFor3D</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;Observer&gt; observers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3D 彩票的号码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        observers.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = observers.indexOf(observer);</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            observers.remove(index);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Observer observer : observers) &#123;</span><br><span class="line">            observer.update(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主题更新信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        notifyObservers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Observer"><a href="#3-Observer" class="headerlink" title="3.Observer"></a>3.Observer</h2><p>所有观察者需要实现此接口</p>
<p>其中观察者的方法对应主题的notifyObservers方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.test.demo;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by jingbin on 2016/10/21.</span><br><span class="line"> * 所有观察者需要实现此接口</span><br><span class="line"> */</span><br><span class="line">public interface Observer &#123;</span><br><span class="line"></span><br><span class="line">    public void update(String msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-ObserverUser1-ObserverUser2"><a href="#4-ObserverUser1-ObserverUser2" class="headerlink" title="4.ObserverUser1 ObserverUser2"></a>4.ObserverUser1 ObserverUser2</h2><p>真实观察者，要实现方法</p>
<p>并且构造方法要传总接口对象，这样任何主题都可以实现！！</p>
<p>this指的本类对象</p>
<p><img src="/../img/image-20220412145913609.png" alt="image-20220412145913609"></p>
<h2 id="5-Test测试"><a href="#5-Test测试" class="headerlink" title="5.Test测试"></a>5.Test测试</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//1.新建主题对象</span><br><span class="line">ObjectFor3D objectFor3D = new ObjectFor3D();</span><br><span class="line">// 创建两个订阅者</span><br><span class="line">new ObserverUser1(objectFor3D);</span><br><span class="line">new ObserverUser2(objectFor3D);</span><br><span class="line">// 主题对象发送两条信息</span><br><span class="line">objectFor3D.setMsg(&quot;201610121 的3D号为:127&quot;);</span><br><span class="line">objectFor3D.setMsg(&quot;201610222 的3D号为:128&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220412150017361.png" alt="image-20220412150017361"></p>
<p>发现每个观察者都接收到了信息</p>
<h1 id="3-工厂模式（重点）"><a href="#3-工厂模式（重点）" class="headerlink" title="3.工厂模式（重点）"></a>3.工厂模式（重点）</h1><h2 id="1-静态工厂模式"><a href="#1-静态工厂模式" class="headerlink" title="1.静态工厂模式"></a>1.静态工厂模式</h2><p>这个最常见了，项目中的辅助类，TextUtil.isEmpty等，类+静态方法</p>
<h2 id="2-简单工厂模式"><a href="#2-简单工厂模式" class="headerlink" title="2.简单工厂模式"></a>2.简单工厂模式</h2><p>通过专门定义一个类来负责创建其他类的实例，被创建的实例必须具有共同的父类。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class SimpleRoujiaMoFactory &#123;</span><br><span class="line">    public RoujiaMo creatRoujiaMo(String type) &#123;</span><br><span class="line">        //创建父类对象</span><br><span class="line">         RoujiaMo roujiaMo = null;</span><br><span class="line">         switch (type) &#123;</span><br><span class="line">             case &quot;Suan&quot;:</span><br><span class="line">                 roujiaMo = new ZSuanRoujiaMo();</span><br><span class="line">                 break;</span><br><span class="line">             case &quot;La&quot;:</span><br><span class="line">                 roujiaMo = new ZLaRoujiaMo();</span><br><span class="line">                 break;</span><br><span class="line">             case &quot;Tian&quot;:</span><br><span class="line">                 roujiaMo = new ZTianRoujiaMo();</span><br><span class="line">                 break;</span><br><span class="line">             default:// 默认为酸肉夹馍</span><br><span class="line">                 roujiaMo = new ZSuanRoujiaMo();</span><br><span class="line">                 break;</span><br><span class="line">         &#125;</span><br><span class="line">         return roujiaMo;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-普通工厂"><a href="#3-普通工厂" class="headerlink" title="3.普通工厂"></a>3.普通工厂</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//定义一个总工厂</span><br><span class="line">public Interface  RoujiaMoYLFactory &#123;</span><br><span class="line">    public Meet creatMeet();</span><br><span class="line">    public YuanLiao creatYuanLiao();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class XianRoujiaMoYLFoctory implements RoujiaMoYLFactory &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Meet creatMeet() &#123;</span><br><span class="line">    	//其中XianFreshMeet要继承Meet，Meet也是一个接口</span><br><span class="line">        return new XianFreshMeet();</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public YuanLiao creatYuanLiao() &#123;</span><br><span class="line">  	  //其中XianTeSeYuanLiao要继承YuanLiao，YuanLiao也是一个接口</span><br><span class="line">        return new XianTeSeYuanLiao();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用,参数传RoujiaMoYLFactory的某一个接口实现类即可，此方法放在哪里都行，没有依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public void prepare(RoujiaMoYLFactory roujiaMoYLFactory) &#123;</span><br><span class="line">    	Meet meet = roujiaMoYLFactory.creatMeet();</span><br><span class="line">    	YuanLiao yuanLiao = roujiaMoYLFactory.creatYuanLiao();</span><br><span class="line">    	Log.e(&quot;揉面-剁肉-完成准备工作 yuanLiao:&quot;+meet+&quot;yuanLiao:&quot;+yuanLiao);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-策略模式"><a href="#4-策略模式" class="headerlink" title="4. 策略模式"></a>4. 策略模式</h1><p>不同角色有四个不同的属性</p>
<h2 id="1-不是策略模式代码"><a href="#1-不是策略模式代码" class="headerlink" title="1.不是策略模式代码"></a>1.不是策略模式代码</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public abstract class Role &#123;</span><br><span class="line">    protected String name;</span><br><span class="line">    // 着装</span><br><span class="line">    protected abstract void display();</span><br><span class="line">    // 逃跑</span><br><span class="line">    protected abstract void run();</span><br><span class="line">    // 攻击</span><br><span class="line">    protected abstract void attack();</span><br><span class="line">    // 防御</span><br><span class="line">    protected abstract void defend();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样每一个new Role都需要重写这四个方法</p>
<h2 id="2-使用策略"><a href="#2-使用策略" class="headerlink" title="2.使用策略"></a>2.使用策略</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public abstract class Role1 &#123;</span><br><span class="line"></span><br><span class="line">    protected String name;</span><br><span class="line"></span><br><span class="line">    private IDisplayBehavior iDisplayBehavior;</span><br><span class="line">    private IDefendBehavior iDefendBehavior;</span><br><span class="line">    private IRunBehavior iRunBehavior;</span><br><span class="line">    private IAttackBehavior iAttackBehavior;</span><br><span class="line"></span><br><span class="line">    public Role1 setiDisplayBehavior(IDisplayBehavior iDisplayBehavior) &#123;</span><br><span class="line">        this.iDisplayBehavior = iDisplayBehavior;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Role1 setiDefendBehavior(IDefendBehavior iDefendBehavior) &#123;</span><br><span class="line">        this.iDefendBehavior = iDefendBehavior;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Role1 setiRunBehavior(IRunBehavior iRunBehavior) &#123;</span><br><span class="line">        this.iRunBehavior = iRunBehavior;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Role1 setiAttackBehavior(IAttackBehavior iAttackBehavior) &#123;</span><br><span class="line">        this.iAttackBehavior = iAttackBehavior;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void display() &#123;</span><br><span class="line">        iDisplayBehavior.display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void defend() &#123;</span><br><span class="line">        iDefendBehavior.defend();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void attack() &#123;</span><br><span class="line">        iAttackBehavior.attack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void run() &#123;</span><br><span class="line">        iRunBehavior.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-test"><a href="#3-test" class="headerlink" title="3.test"></a>3.test</h2><p>//这个new 一个roleA都可以给他不用的动作，并且每一个new都不许重写方法，方法在设置里就进行了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RoleA roleA = <span class="keyword">new</span> RoleA(<span class="string">&quot;---A&quot;</span>);</span><br><span class="line">roleA.setiDisplayBehavior(<span class="keyword">new</span> DisplayYZ())</span><br><span class="line">      .setiAttackBehavior(<span class="keyword">new</span> AttackXL())</span><br><span class="line">      .setiDefendBehavior(<span class="keyword">new</span> DefendTMS())</span><br><span class="line">      .setiRunBehavior(<span class="keyword">new</span> RunJCTQ());</span><br><span class="line">roleA.display();<span class="comment">// 样子</span></span><br><span class="line">roleA.attack();<span class="comment">// 攻击</span></span><br><span class="line">roleA.run();<span class="comment">// 逃跑</span></span><br><span class="line">roleA.defend();<span class="comment">// 防御</span></span><br></pre></td></tr></table></figure>

<h1 id="5-适配器模式（重点）"><a href="#5-适配器模式（重点）" class="headerlink" title="5.适配器模式（重点）"></a>5.适配器模式（重点）</h1><p><strong>把一个类，传入一个（继承某个接口的）适配器，最终变成可以使用的这个某个接口</strong></p>
<ul>
<li><p>以充电器为实例: 手机充电器一般都是5V左右吧，咱天朝的家用交流电压220V，所以手机充电需要一个适配器（降压器）</p>
</li>
<li><p>一部手机: [Mobile.java]</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class Mobile &#123;</span><br><span class="line"></span><br><span class="line">    // 这里传入的是 v5接口,实现了这个接口的类也可以传入</span><br><span class="line">    public void inputPower(V5Power v5Power) &#123;</span><br><span class="line">        int provideV5Power = v5Power.provideV5Power();</span><br><span class="line">        Log.e(&quot;---&quot;, &quot;手机(客户端): 我需要的是5V电压充电,现在是&quot; + provideV5Power + &quot;V&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>手机依赖一个提供5V电压的接口: [V5Power.java],注意这里是接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public interface V5Power &#123;</span><br><span class="line"></span><br><span class="line">    public int provideV5Power();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>我们拥有的是220V家用交流电: [V220Power.java]，注意这里是类不是接口了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class V220Power &#123;</span><br><span class="line"></span><br><span class="line">    public int provideV220Power() &#123;</span><br><span class="line">        Log.e(&quot;---&quot;, &quot;现有类: 我们提供的是220v的家用电&quot;);</span><br><span class="line">        return 220;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>适配器，完成220V转5V的作用</strong>：[V5PowerAdapter.java]，要实现最终要的接口，并且实现接口的方法</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by jingbin on 2016/10/30.</span><br><span class="line"> * 将200v家用电转换为5v手机用电的适配器</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class V5PowerAdapter implements V5Power &#123;</span><br><span class="line"></span><br><span class="line">    private int v220power;</span><br><span class="line"></span><br><span class="line">    public V5PowerAdapter(V220Power v220Power) &#123;</span><br><span class="line">        v220power = v220Power.provideV220Power();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int provideV5Power() &#123;</span><br><span class="line">		//操作v220power这个类</span><br><span class="line">        Log.e(&quot;---&quot;, &quot;适配器: 经过复杂的操作,将&quot; + v220power + &quot;v电压转为5v&quot;);</span><br><span class="line">        return 5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Mobile mobile = new Mobile();</span><br><span class="line">//经过实现接口的适配器把类转为最终要的接口</span><br><span class="line">V5Power v5Power = new V5PowerAdapter(new V200Power());</span><br><span class="line">mobile.inputPower(v5Power);</span><br></pre></td></tr></table></figure>

<h1 id="6-命令模式"><a href="#6-命令模式" class="headerlink" title="6.命令模式"></a>6.命令模式</h1><h1 id="7-装饰者模式（重点）"><a href="#7-装饰者模式（重点）" class="headerlink" title="7.装饰者模式（重点）"></a>7.装饰者模式（重点）</h1><p>装饰者模式：若要扩展功能，装饰者提供了比集成更有弹性的替代方案，动态地将责任附加到对象上。</p>
<p>我们设计好了一个类，我们需要给这个类添加一些辅助的功能，并且不希望改变这个类的代码，这时候就是装饰者模式大展雄威的时候了。这里还体现了一个<strong>原则：类应该对扩展开放，对修改关闭。</strong></p>
<p>背景：游戏装备系统，每种装备（比如地下城，武器，上衣等）都有自己的攻击力。现在要求可以给装备系统添加装饰品接口（宝石等），增加攻击力</p>
<h2 id="1-装备接口"><a href="#1-装备接口" class="headerlink" title="1.装备接口"></a>1.装备接口</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by jingbin on 2016/11/1.</span></span><br><span class="line"><span class="comment"> * 装备的接口</span></span><br><span class="line"><span class="comment"> * 下面有:武器,护腕,鞋子,戒指、、、、还有装饰品接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IEquip</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算攻击力</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">caculateAttack</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 装备的描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">description</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-武器宝刀"><a href="#2-武器宝刀" class="headerlink" title="2.武器宝刀"></a>2.武器宝刀</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by jingbin on 2016/11/1.</span><br><span class="line"> * 武器</span><br><span class="line"> * 攻击力 20</span><br><span class="line"> */</span><br><span class="line">public class ArmEquip implements IEquip &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public int caculateAttack() &#123;</span><br><span class="line">        return 20;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String description() &#123;</span><br><span class="line">        return &quot;屠龙宝刀&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-装饰品的接口（需求，要求给装备加上宝石等）"><a href="#3-装饰品的接口（需求，要求给装备加上宝石等）" class="headerlink" title="3.装饰品的接口（需求，要求给装备加上宝石等）"></a>3.装饰品的接口（需求，要求给装备加上宝石等）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by jingbin on 2016/11/1.</span><br><span class="line"> * 装饰品的接口</span><br><span class="line"> */</span><br><span class="line">public interface IEuipDecorator extends IEquip &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-装饰品（需求，要求给装备加上宝石等）"><a href="#4-装饰品（需求，要求给装备加上宝石等）" class="headerlink" title="4.装饰品（需求，要求给装备加上宝石等）"></a>4.装饰品（需求，要求给装备加上宝石等）</h2><h3 id="蓝宝石装饰品"><a href="#蓝宝石装饰品" class="headerlink" title="蓝宝石装饰品"></a>蓝宝石装饰品</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by jingbin on 2016/11/1.</span><br><span class="line"> * 蓝宝石装饰品</span><br><span class="line"> * 每颗攻击力: +5</span><br><span class="line"> * 这与武器等不同,它是可以累加的,而武器不能</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class BlueGemDecorator implements IEuipDecorator &#123;</span><br><span class="line"></span><br><span class="line">    private IEquip iEquip;</span><br><span class="line"></span><br><span class="line">    public BlueGemDecorator(IEquip iEquip) &#123;</span><br><span class="line">        this.iEquip = iEquip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 累加攻击力</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public int caculateAttack() &#123;</span><br><span class="line">        return 5 + iEquip.caculateAttack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String description() &#123;</span><br><span class="line">        return iEquip.description() + &quot;+ 蓝宝石&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="红宝石装饰品"><a href="#红宝石装饰品" class="headerlink" title="红宝石装饰品"></a>红宝石装饰品</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.test.demo;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by jingbin on 2016/11/1.</span><br><span class="line"> * 蓝宝石装饰品</span><br><span class="line"> * 每颗攻击力: +5</span><br><span class="line"> * 这与武器等不同,它是可以累加的,而武器不能</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class RedGemDecorator implements IEuipDecorator &#123;</span><br><span class="line"></span><br><span class="line">    private IEquip iEquip;</span><br><span class="line"></span><br><span class="line">    public RedGemDecorator(IEquip iEquip) &#123;</span><br><span class="line">        this.iEquip = iEquip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 累加攻击力</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public int caculateAttack() &#123;</span><br><span class="line">        return 10 + iEquip.caculateAttack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String description() &#123;</span><br><span class="line">        return iEquip.description() + &quot;+ 红宝石&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-test"><a href="#5-test" class="headerlink" title="5.test"></a>5.test</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">System.out.println(&quot;---一个镶嵌2颗红宝石,1颗蓝宝石的靴子: &quot;);</span><br><span class="line">		IEquip iEquip = new RedGemDecorator(new RedGemDecorator(new BlueGemDecorator(new ArmEquip())));</span><br><span class="line">		System.out.println(&quot;---攻击力:&quot; + iEquip.caculateAttack());</span><br><span class="line">		System.out.println(&quot;---描述语:&quot; + iEquip.description());</span><br></pre></td></tr></table></figure>

<p><strong>宝石装在装备上，而且可以有多个宝石</strong></p>
<p><img src="/../img/image-20220412160116859.png" alt="image-20220412160116859"></p>
<h1 id="8-外观模式"><a href="#8-外观模式" class="headerlink" title="8.外观模式"></a>8.外观模式</h1><p>供一个统一的接口，用来访问子系统中的一群接口，外观定义了一个高层的接口，让子系统更容易使用。<strong>其实就是为了方便客户的使用，把一群操作，封装成一个方法。</strong></p>
<p><img src="/../img/image-20220412160511171.png" alt="image-20220412160511171"></p>
<h1 id="9-模板方法模式（重点）"><a href="#9-模板方法模式（重点）" class="headerlink" title="9. 模板方法模式（重点）"></a>9. 模板方法模式（重点）</h1><p>定义了一个算法的骨架，而将一些步骤延迟到子类中，模版方法使得子类可以在不改变算法结构的情况下，重新定义算法的步骤。</p>
<p>本公司有程序猿、测试、HR、项目经理等人，下面使用模版方法模式，记录下所有人员的上班情况</p>
<p>进公司，开电脑，离开等都是一样的，但是怎么工作不一致，这时可以用模板方法</p>
<h2 id="work"><a href="#work" class="headerlink" title="work"></a>work</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public abstract class Worker &#123;</span><br><span class="line"></span><br><span class="line">    protected String name;</span><br><span class="line"></span><br><span class="line">    public Worker(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 具体方法，看到定义了顺序的方法</span><br><span class="line">     */</span><br><span class="line">    public final void workOneDay() &#123;</span><br><span class="line">        Log.e(&quot;workOneDay&quot;, &quot;-----------------work start----------------&quot;);</span><br><span class="line"></span><br><span class="line">        enterCompany();</span><br><span class="line">        computerOn();</span><br><span class="line">        work();</span><br><span class="line">        computerOff();</span><br><span class="line">        exitCompany();</span><br><span class="line"></span><br><span class="line">        Log.e(&quot;workOneDay&quot;, &quot;-----------------work end----------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 工作  抽象方法</span><br><span class="line">     */</span><br><span class="line">    public abstract void work();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 钩子方法,如果想看到离开的时间，那么子类就重新为true即可，这个就叫钩子方法</span><br><span class="line">     */</span><br><span class="line">    public boolean isNeedPrintDate() &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void exitCompany() &#123;</span><br><span class="line">        if (isNeedPrintDate()) &#123;</span><br><span class="line">            Log.e(&quot;exitCompany&quot;, &quot;---&quot; + new Date().toLocaleString() + &quot;---&gt;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.e(&quot;exitCompany&quot;, name + &quot;---离开公司&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//    -----------------------------------</span><br><span class="line"></span><br><span class="line">    private void computerOn() &#123;</span><br><span class="line">        Log.e(&quot;computerOn&quot;, &quot;---打开电脑&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void computerOff() &#123;</span><br><span class="line">        Log.e(&quot;computerOff&quot;, &quot;---关闭电脑&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void enterCompany() &#123;</span><br><span class="line">        Log.e(&quot;enterCompany&quot;, &quot;---进入公司&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ITWorker"><a href="#ITWorker" class="headerlink" title="ITWorker"></a>ITWorker</h2><p>程序员需要重写work方法，并且向看到离开时间</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by jingbin on 2016/11/2.</span><br><span class="line"> * 程序员</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class ITWorker extends Worker &#123;</span><br><span class="line"></span><br><span class="line">    public ITWorker(String name) &#123;</span><br><span class="line">        super(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 重写父类的此方法,使可以查看离开公司时间</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public boolean isNeedPrintDate() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void work() &#123;</span><br><span class="line">        Log.e(&quot;--work&quot;, &quot;---&quot; + name + &quot;, 写程序 - 测bug - 修复bug&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="test-1"><a href="#test-1" class="headerlink" title="test"></a>test</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> ITWorker itWorker = new ITWorker(&quot;name&quot;);</span><br><span class="line">itWorker.workOneDay();</span><br></pre></td></tr></table></figure>

<h1 id="10-状态模式"><a href="#10-状态模式" class="headerlink" title="10. 状态模式"></a>10. 状态模式</h1><h1 id="11-建造者模式"><a href="#11-建造者模式" class="headerlink" title="11. 建造者模式"></a>11. 建造者模式</h1><h1 id="12-原型模式（重点）"><a href="#12-原型模式（重点）" class="headerlink" title="12. 原型模式（重点）"></a>12. 原型模式（重点）</h1><p>原型模式是用于创建重复的对象，同时又能保证性能。</p>
<p>一个对象是查询数据库以后才会有，每次需要操作这个对象</p>
<p>那么可以查询第一次以后存入一个hashMap里，key为对象的id，value为对象</p>
<p>然后clone这个对象进行操作</p>
<p>主要是用于对象的clone，类需要继承Cloneable接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.test.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.convert.Convert;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/04/12  16:37</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> A <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      A object = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         object = Convert.convert(A.class,<span class="keyword">super</span>.clone());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> object;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="test-2"><a href="#test-2" class="headerlink" title="test"></a>test</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">   A a = new A(&quot;A&quot;).clone();</span><br><span class="line">   System.out.println(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220412164118097.png" alt="image-20220412164118097"></p>
<h1 id="13-享元模式"><a href="#13-享元模式" class="headerlink" title="13. 享元模式"></a>13. 享元模式</h1><h1 id="14-代理模式-重点"><a href="#14-代理模式-重点" class="headerlink" title="14.代理模式(重点)"></a>14.代理模式(重点)</h1><p>一个类代表另一个类的功能。在代理模式中，我们创建具有现有对象的对象，以便向外界提供功能接口。可以理解为内存中没有这个对象就创建，有就直接返回这个对象。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>不论是否是代理，都要实现这个接口，最终调用接口的方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public interface Image &#123;</span><br><span class="line">   void display();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RealImage真正的加载"><a href="#RealImage真正的加载" class="headerlink" title="RealImage真正的加载"></a>RealImage真正的加载</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class RealImage implements Image &#123;</span><br><span class="line"></span><br><span class="line">    private String fileName;</span><br><span class="line"></span><br><span class="line">    public RealImage(String fileName) &#123;</span><br><span class="line">        this.fileName = fileName;</span><br><span class="line">        loadFromDisk(fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void loadFromDisk(String fileName) &#123;</span><br><span class="line">        Log.e(&quot;RealImage&quot;, &quot;loading &quot; + fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void display() &#123;</span><br><span class="line">        Log.e(&quot;RealImage&quot;, &quot;Displaying &quot; + fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ProxyImage代理"><a href="#ProxyImage代理" class="headerlink" title="ProxyImage代理"></a>ProxyImage代理</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class ProxyImage implements Image &#123;</span><br><span class="line"></span><br><span class="line">    private String fileName;</span><br><span class="line">    private RealImage realImage;</span><br><span class="line"></span><br><span class="line">    public ProxyImage(String fileName) &#123;</span><br><span class="line">        this.fileName = fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void display() &#123;</span><br><span class="line">        if (realImage == null) &#123;</span><br><span class="line">            realImage = new RealImage(fileName);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        realImage.display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="test-3"><a href="#test-3" class="headerlink" title="test"></a>test</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Image image = new ProxyImage(&quot;test_10mb.png&quot;);</span><br><span class="line">// 第一次是new的，图像从磁盘加载</span><br><span class="line">image.display();</span><br><span class="line">// 第二次取缓存，图像不需要从磁盘加载</span><br><span class="line">image.display();</span><br></pre></td></tr></table></figure>

<h1 id="15-桥接模式"><a href="#15-桥接模式" class="headerlink" title="15. 桥接模式"></a>15. 桥接模式</h1><h1 id="16-组合模式"><a href="#16-组合模式" class="headerlink" title="16. 组合模式"></a>16. 组合模式</h1><h1 id="17-迭代器模式（重点）"><a href="#17-迭代器模式（重点）" class="headerlink" title="17. 迭代器模式（重点）"></a>17. 迭代器模式（重点）</h1><p>就是Iterator</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ArrayList&lt;Integer&gt; list = ListUtil.toList(1, 2, 3, 4);</span><br><span class="line">Iterator&lt;Integer&gt; it = list.iterator();</span><br><span class="line">if(it.hasNext())&#123;</span><br><span class="line">   Integer next = it.next();</span><br><span class="line">   //操作</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="18-中介者模式"><a href="#18-中介者模式" class="headerlink" title="18. 中介者模式"></a>18. 中介者模式</h1><h1 id="19-备忘录模式"><a href="#19-备忘录模式" class="headerlink" title="19. 备忘录模式"></a>19. 备忘录模式</h1><h1 id="20-解释器模式"><a href="#20-解释器模式" class="headerlink" title="20. 解释器模式"></a>20. 解释器模式</h1><h1 id="21-责任链模式（重点）"><a href="#21-责任链模式（重点）" class="headerlink" title="21. 责任链模式（重点）"></a>21. 责任链模式（重点）</h1><p>把请求从链中的一个对象传到下一个对象，直到请求被响应为止。通过这种方式去除对象之间的耦合。</p>
<h1 id="22-访问者模式"><a href="#22-访问者模式" class="headerlink" title="22. 访问者模式"></a>22. 访问者模式</h1>]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>23中设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>spring-cloud</title>
    <url>/2021/11/30/alibaba%E5%92%8Cnetflix%E4%B8%8D%E5%90%8C/</url>
    <content><![CDATA[<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022105939305.png" alt="image-20211022105939305"></p>
<p><a href="https://blog.csdn.net/zhongzk69/article/details/105095834/">https://blog.csdn.net/zhongzk69/article/details/105095834/</a></p>
<h1 id="springcloud-alibaba"><a href="#springcloud-alibaba" class="headerlink" title="springcloud-alibaba"></a>springcloud-alibaba</h1><p>在公共依赖common里引入依赖</p>
<p>注意版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">            &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>



<p>中文文档</p>
<p><a href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p><a href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025191043897.png" alt="image-20211025191043897"></p>
<h1 id="1-nacos注册中心"><a href="#1-nacos注册中心" class="headerlink" title="1.nacos注册中心"></a>1.nacos注册中心</h1><h2 id="1-pom"><a href="#1-pom" class="headerlink" title="1.pom"></a>1.pom</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h2><p>在应用的 /src/main/resources/application.properties 配置文件中配置 Nacos Server 地址，以及spring名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025195219412.png" alt="image-20211025195219412"></p>
<h2 id="3-下载nacos-server"><a href="#3-下载nacos-server" class="headerlink" title="3.下载nacos server"></a>3.下载nacos server</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025193113285.png" alt="image-20211025193113285"></p>
<h3 id="windos下zip"><a href="#windos下zip" class="headerlink" title="windos下zip"></a>windos下zip</h3><p>下载解压，bin双击startup.cmd</p>
<p>如果报错</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025195934257.png" alt="image-20211025195934257"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025195550728.png" alt="image-20211025195550728"></p>
<h3 id="Linux下tar-gz"><a href="#Linux下tar-gz" class="headerlink" title="Linux下tar.gz"></a>Linux下tar.gz</h3><h2 id="4-使用-EnableDiscoveryClient"><a href="#4-使用-EnableDiscoveryClient" class="headerlink" title="4.使用 @EnableDiscoveryClient"></a>4.使用 @EnableDiscoveryClient</h2><p>注解开启服务注册与发现功能</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class ProviderApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ProviderApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-访问http-localhost-8848-nacos"><a href="#5-访问http-localhost-8848-nacos" class="headerlink" title="5.访问http://localhost:8848/nacos"></a>5.访问<a href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></h2><p>账号密码</p>
<p>nacos/nacos</p>
<h1 id="2-openFegin远程调用"><a href="#2-openFegin远程调用" class="headerlink" title="2.openFegin远程调用"></a>2.openFegin远程调用</h1><h2 id="1-pom-1"><a href="#1-pom-1" class="headerlink" title="1.pom"></a>1.pom</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-远程调用步骤"><a href="#2-远程调用步骤" class="headerlink" title="2.远程调用步骤"></a>2.远程调用步骤</h2><p>编写一个接口，告诉springcloud这个接口需要调用远程服务，把这种接口都放在fegin包下</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201021518.png" alt="image-20211025201021518"></p>
<p>member想要远程调用coupon服务</p>
<p>coupon在controller里有这样一个方法</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201053269.png" alt="image-20211025201053269"></p>
<p>而member想要调用，首先在fegin包下创建service</p>
<p>加上@FeignClient()注解</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201515603.png" alt="image-20211025201515603"></p>
<p>方法mapping要是coupon在controller里全路径，返回值和方法名不变，</p>
<p>注释是interface</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201411302.png" alt="image-20211025201411302"></p>
<h2 id="3-开启远程调用功能"><a href="#3-开启远程调用功能" class="headerlink" title="3.开启远程调用功能"></a>3.开启远程调用功能</h2><p>在member</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201816108.png" alt="image-20211025201621844"></p>
<h2 id="4-错误"><a href="#4-错误" class="headerlink" title="4.错误"></a>4.错误</h2><h3 id="No-Feign-Client-for-loadBalancing-defined-错误"><a href="#No-Feign-Client-for-loadBalancing-defined-错误" class="headerlink" title="No Feign Client for loadBalancing defined.错误"></a>No Feign Client for loadBalancing defined.错误</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">解决方法：</span><br><span class="line">加入spring-cloud-loadbalancer依赖 并且在nacos中排除ribbon依赖，不然loadbalancer无效</span><br><span class="line"></span><br><span class="line">排除ribbon依赖</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;com.netflix.ribbon&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;ribbon&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">添加依赖</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-loadbalancer&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为版本，可以</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">项目springboot 2.1.8.RELEASE</span><br><span class="line"></span><br><span class="line">springcloud  2.1.0.RELEASE</span><br></pre></td></tr></table></figure>

<h1 id="3-nacos配置中心"><a href="#3-nacos配置中心" class="headerlink" title="3.nacos配置中心"></a>3.nacos配置中心</h1><h2 id="1-pom-2"><a href="#1-pom-2" class="headerlink" title="1.pom"></a>1.pom</h2><p>首先，修改 pom.xml 文件，引入 Nacos Config Starter。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-bootstrap-yml"><a href="#2-bootstrap-yml" class="headerlink" title="2.bootstrap.yml"></a>2.bootstrap.yml</h2><p>优先于application.yml加载</p>
<p>在应用的 /src/main/resources/bootstrap.properties 配置文件中配置 Nacos Config 元数据</p>
<p><strong>需要配置spring.application.name=服务名，所以当有cloud的config配置时， spring.application.name配置在bootstrap中</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring.application.name=服务名</span><br><span class="line">spring.cloud.nacos.config.server-addr=127.0.0.1:8848</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025205034397.png" alt="image-20211025205034397"></p>
<p>现在自定义了两个属性</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084030493.png" alt="image-20211026084030493"></p>
<p>controller里获取</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084153941.png" alt="image-20211026084153941"></p>
<p>如果想更改值，只能修改yml，然后重新打包部署</p>
<h3 id="but有了nacos！"><a href="#but有了nacos！" class="headerlink" title="but有了nacos！"></a>but有了nacos！</h3><p>可以修改配置中心动态修改，添加dataid，默认为应用名.properties</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084437847.png" alt="image-20211026084437847"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084535844.png" alt="image-20211026084535844"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026085753939.png" alt="image-20211026085753939"></p>
<p>在属性的类上添加注解@RefreshScope</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090142252.png" alt="image-20211026090142252"></p>
<p>原来是zhangsan18</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026085900976.png" alt="image-20211026085900976"></p>
<p>现在修改一下</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026085933419.png" alt="image-20211026085933419"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090001730.png" alt="image-20211026090001730"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090322799.png" alt="image-20211026090322799"></p>
<h3 id="注意！！！"><a href="#注意！！！" class="headerlink" title="注意！！！"></a>注意！！！</h3><p>想要动态更改的属性需要现在application或者bootstrap里定义才能更改，否则报错找不到</p>
<h3 id="修改properties为yml"><a href="#修改properties为yml" class="headerlink" title="修改properties为yml"></a>修改properties为yml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config:</span><br><span class="line">        file-extension: yml  #指定配置文件为服务名.yml格式</span><br></pre></td></tr></table></figure>

<h2 id="3-细节都在bootstrap-yml里配置"><a href="#3-细节都在bootstrap-yml里配置" class="headerlink" title="3.细节都在bootstrap.yml里配置"></a>3.细节都在bootstrap.yml里配置</h2><h3 id="1-命名空间"><a href="#1-命名空间" class="headerlink" title="1.命名空间"></a>1.命名空间</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认空间public，默认新增的所有配置都在public空间</span><br><span class="line">开发，测试，生产，不同环境需要不同配置，就可以创建多个空间</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090946436.png" alt="image-20211026090946436"></p>
<p>现在在public和prop里都创建dataid为gulimall.properties</p>
<p>name：zhangsan</p>
<p>public   age：22    prop  age：24</p>
<p>发现最终获取为22，说明默认使用public空间</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091233561.png" alt="image-20211026091233561"></p>
<p>想要使用其他命名空间</p>
<p>spring.cloud.nacos.config.namespace</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091518002.png" alt="image-20211026091518002"></p>
<p>值为prop下的类似uuid的字符串</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091559011.png" alt="image-20211026091559011"></p>
<p>每一个微服务之前互相隔离，都创建自己的命名空间，只加载自己的命名空间</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091943440.png" alt="image-20211026091943440"></p>
<p>可以克隆配置到别的命名空间</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026092052521.png" alt="image-20211026092052521"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026092113919.png" alt="image-20211026092113919"></p>
<h3 id="2-配置集"><a href="#2-配置集" class="headerlink" title="2.配置集"></a>2.配置集</h3><p>所有的配置集合</p>
<h3 id="3-配置集id"><a href="#3-配置集id" class="headerlink" title="3.配置集id"></a>3.配置集id</h3><p>Data ID：默认服务名.properties</p>
<h3 id="4-配置分组"><a href="#4-配置分组" class="headerlink" title="4.配置分组"></a>4.配置分组</h3><p>默认所有配置集都属于DEFULT_GROUP：</p>
<p>使用别的组</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026092640401.png" alt="image-20211026092640401"></p>
<p>每个微服务创建自己的命名空间，使用配置分组区别环境，dev，test，prod</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026093234345.png" alt="image-20211026093234345"></p>
<p>想切换环境，更改bootstrap.yml里的group属性即可</p>
<h2 id="4-同时加载多个配置集"><a href="#4-同时加载多个配置集" class="headerlink" title="4.同时加载多个配置集"></a>4.同时加载多个配置集</h2><p>现在application.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">ROOT</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.10:3306/gulimall_sms?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gulimall-coupon</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br></pre></td></tr></table></figure>

<p>拆分成三个</p>
<p>datasource.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">ROOT</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.10:3306/gulimall_sms?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br></pre></td></tr></table></figure>

<p>mybatis.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>

<p>other.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gulimall-coupon</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br></pre></td></tr></table></figure>

<p>bootstrap不变</p>
<p>再次注意</p>
<p>application里的是服务注册与发现</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 127.0.0.1:8848</span><br></pre></td></tr></table></figure>

<p>bootstrap里的是配置中心</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config:</span><br><span class="line">        server-addr: 127.0.0.1:8848</span><br><span class="line">        namespace: 5c2579c3-b6ad-406c-81b7-dbef6ee5142c</span><br><span class="line">        group:</span><br><span class="line">  application:</span><br><span class="line">    name: gulimall-coupon</span><br></pre></td></tr></table></figure>

<p>回归</p>
<p>现在拆分了三个到配置中心</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026094345791.png" alt="image-20211026094345791"></p>
<p>修改bootstrap.yml</p>
<p>添加数据集，refresh自动刷新true</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026094619239.png" alt="image-20211026094619239"></p>
<h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><p>以前springboot从配置文件获取使用</p>
<p>@value @configurationproperties</p>
<p>现在都可以配置到配置中心，在bootstrap中指定id，group即可</p>
<h1 id="4-gateway网关"><a href="#4-gateway网关" class="headerlink" title="4.gateway网关"></a>4.gateway网关</h1><p><a href="https://spring.io/projects/spring-cloud-gateway">https://spring.io/projects/spring-cloud-gateway</a></p>
<p>请求到网关，网关先断言，是否符合某个路由规则，经过一系列的filter进行过滤，最终到达目标服务器，并且<strong>最终到达的地址一定是要可以访问的</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-开启服务注册发现并排除数据源自动配置"><a href="#1-开启服务注册发现并排除数据源自动配置" class="headerlink" title="1.开启服务注册发现并排除数据源自动配置"></a>1.开启服务注册发现并排除数据源自动配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.gulimall.gateway;</span><br><span class="line"></span><br><span class="line">        import org.springframework.boot.SpringApplication;</span><br><span class="line">        import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">        import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line">        import org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span><br><span class="line">public class GulimallGatewayApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GulimallGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-添加配置"><a href="#2-添加配置" class="headerlink" title="2.添加配置"></a>2.添加配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 127.0.0.1:8848</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true  # 让gateway可以发现nacos中的微服务</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: baidu_rout</span><br><span class="line">          uri: https://www.baidu.com</span><br><span class="line">          predicates:</span><br><span class="line">            - Query=url,baidu</span><br><span class="line">        - id: qq_route</span><br><span class="line">          uri: https://www.qq.com</span><br><span class="line">          predicates:</span><br><span class="line">            - Query=url,qq</span><br><span class="line">            #也可以写成path，只要以/brand开头都会跳转到这里</span><br><span class="line">            - Path=/brand**</span><br><span class="line">          filters:</span><br><span class="line">  			 - StripPrefix=2 </span><br><span class="line">server:</span><br><span class="line">  port: 88</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>断言</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Query=url  表示请求中待url参数即可，才会转到url</span><br><span class="line">Query=url,qq   请求中待url参数并必须等于qq才会转到url</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">配置转发路径：Path= /anji-open/user/**，但是controller中并没有以/anji-open/user/**开头，这样能找到具体接口吗，是可以的，原理是通过这个配置实现：</span><br><span class="line">filters:</span><br><span class="line">   - StripPrefix=2，</span><br><span class="line">转发到具体服务，自动去掉/anji-open/user，如下</span><br><span class="line">原始访问路径:</span><br><span class="line">http://www.aa.com/anji-open/user/jobuser/pageList?sort=id&amp;order=DESC&amp;pageNumber=1&amp;pageSize=10</span><br><span class="line"> </span><br><span class="line">处理后路径：</span><br><span class="line">http://www.aa.com/jobuser/pageList?sort=id&amp;order=DESC&amp;pageNumber=1&amp;pageSize=10</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>#webconfig<br>        - id: FRAMEWORK-WEBCONFIG-SERVER<br>          uri: lb://FRAMEWORK-WEBCONFIG-SERVER<br>          predicates:<br>            - Path=/api/webconfig/**<br>          filters:<br>            - StripPrefix=2</p>
<pre><code>    #flow
    - id: FRAMEWORK-FLOW-MICROSERVICE
      uri: lb://FRAMEWORK-FLOW-MICROSERVICE
      predicates:
        - Path=/api/flow/**
      filters: 
        - StripPrefix=2

    #component
    - id: FRAMEWORK-COMPONENT-MICROSERVICE
      uri: lb://FRAMEWORK-COMPONENT-MICROSERVICE
      predicates:
        - Path=/api/component/**
      filters: 
        - StripPrefix=2

    #test
    - id: SERVER-CONSUMER
      uri: lb://SERVER-CONSUMER
      predicates:
        - Path=/cusumer/**
      filters: 
        - StripPrefix=1

如果请求路径是/cusumer开头，就会找uri里SERVER-CONSUMER服务路径，并且- StripPrefix=1，去掉一层，也就是去掉/cusumer这一层
比如，SERVER-CONSUMER的路径是1.1.1.1:3001,当请求/cusumer/a/b,路径不是1.1.1.1:3001/cusumer/a/b
而是1.1.1.1:3001/a/b
</code></pre>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>访问<a href="http://localhost:88/hello?url=qq">http://localhost:88/hello?url=qq</a></p>
<p>参数中待url并且等于qq，就会转到<a href="https://www.qq.com/hello%EF%BC%8C%E6%B3%A8%E6%84%8F%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%8B%BC%E6%8E%A5%E4%B8%8Alocalhost:88/%E5%90%8E%E9%9D%A2%E7%9A%84%E8%B7%AF%E5%BE%84">https://www.qq.com/hello，注意会自动拼接上localhost:88/后面的路径</a></p>
<p>访问<a href="http://localhost:88/?url=baidu">http://localhost:88/?url=baidu</a></p>
<p>就不会待hello路径</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026111146862.png" alt="image-20211026111146862"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026203254610.png" alt="image-20211026203254610"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- Path=/foo/&#123;segment&#125;,/bar/&#123;segment&#125;</span><br><span class="line">路径是/foo/1 or /foo/bar/ or /bar/22都会转到uri中</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026203427498.png" alt="image-20211026203427498"></p>
<p>lb负载均衡策略</p>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: qq1_route</span><br><span class="line">  uri: https://www.baidu.com</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/more</span><br></pre></td></tr></table></figure>

<p>访问localhost:88/more会转到<a href="http://www.baidu.com/more">www.baidu.com/more</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: qq2_route</span><br><span class="line">  uri: https://blog.csdn.net</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/jiang458572759/&#123;segment&#125;</span><br></pre></td></tr></table></figure>

<p>访问localhost:88/jiang458572759/article</p>
<p>转到<a href="https://blog.csdn.net/jiang458572759/article">https://blog.csdn.net/jiang458572759/article</a></p>
<p>注意只能在jiang458572759/后添加一个/，不能有多级目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: qq2_route</span><br><span class="line">  uri: https://blog.csdn.net</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/jiang458572759/**</span><br></pre></td></tr></table></figure>

<p>这样就可以有多级目录了</p>
<p>例子：访问<a href="http://localhost:88/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502">http://localhost:88/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502</a></p>
<p>转到<a href="https://blog.csdn.net/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502">https://blog.csdn.net/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502</a></p>
<h2 id="3-前端项目发送axios"><a href="#3-前端项目发送axios" class="headerlink" title="3.前端项目发送axios"></a>3.前端项目发送axios</h2><p>向网关发送的都带上api</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026204659897.png" alt="image-20211026204659897"></p>
<p>后端，lb负载均衡到renren-fast</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026204730089.png" alt="image-20211026204730089"></p>
<h2 id="4-路径重写"><a href="#4-路径重写" class="headerlink" title="4.路径重写"></a>4.路径重写</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id: qq2_route</span><br><span class="line"> uri: https://blog.csdn.net</span><br><span class="line"> predicates:</span><br><span class="line">   - Path=/jiang458572759/**</span><br><span class="line"> filters:</span><br><span class="line">   - RewritePath=/jiang458572759/(?&lt;segment&gt;.*),/$\&#123;segment&#125;</span><br></pre></td></tr></table></figure>

<p>当访问<a href="http://localhost:88/jiang458572759/hh%E6%97%B6">http://localhost:88/jiang458572759/hh时</a></p>
<p>会转到<a href="https://blog.csdn.net/hh,%E8%87%AA%E5%8A%A8%E5%8E%BB%E6%8E%89/jiang458572759">https://blog.csdn.net/hh,自动去掉/jiang458572759</a></p>
<h2 id="5-在网关里统一配置跨域问题"><a href="#5-在网关里统一配置跨域问题" class="headerlink" title="5.在网关里统一配置跨域问题"></a>5.在网关里统一配置跨域问题</h2><p>创建config文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class GulimallCorsConfiguration &#123;</span><br><span class="line">	@Bean</span><br><span class="line">    public CorsWebFilter corsWebFilter()&#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        CorsConfiguration config=new CorsConfiguration();</span><br><span class="line">        //配置跨域</span><br><span class="line">        //允许所有域名进行跨域调用</span><br><span class="line">        config.addAllowedOrigin(&quot;*&quot;);</span><br><span class="line">        //允许跨越发送cookie</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        //放行全部原始头信息</span><br><span class="line">        config.addAllowedHeader(&quot;*&quot;);</span><br><span class="line">        //允许所有请求方法跨域调用</span><br><span class="line">        config.addAllowedMethod(&quot;*&quot;);</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;,config);</span><br><span class="line">        return new CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-精确的网关应该放在模糊的网关上面"><a href="#6-精确的网关应该放在模糊的网关上面" class="headerlink" title="6.精确的网关应该放在模糊的网关上面"></a>6.精确的网关应该放在模糊的网关上面</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: admin_route</span><br><span class="line">  uri: lb://gulimall-product</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/api/product/**</span><br><span class="line">  filters:</span><br><span class="line">    - RewritePath=/api/(?&lt;segment&gt;.*),/$\&#123;segment&#125;</span><br><span class="line"></span><br><span class="line">- id: admin_route</span><br><span class="line">  uri: lb://renren-fast</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/api/**</span><br><span class="line">  filters:</span><br><span class="line">    - RewritePath=/api/(?&lt;segment&gt;.*),/renren-fast/$\&#123;segment&#125;</span><br></pre></td></tr></table></figure>





<h1 id="5-springcloud-alibaba-oss"><a href="#5-springcloud-alibaba-oss" class="headerlink" title="5.springcloud-alibaba-oss"></a>5.springcloud-alibaba-oss</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alicloud-oss&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">    alicloud:</span><br><span class="line">      access-key: LTAI5t6Tc8civonnHH6QpHQh</span><br><span class="line">      secret-key: 3iIUKRaiwYyx51p0BfmvBCBMpJDb1y</span><br><span class="line">      oss:</span><br><span class="line">        endpoint: oss-cn-beijing.aliyuncs.com</span><br></pre></td></tr></table></figure>

<h2 id="测试简单上传"><a href="#测试简单上传" class="headerlink" title="测试简单上传"></a>测试简单上传</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class GulimallThirdPartyApplicationTests &#123;</span><br><span class="line">    public GulimallThirdPartyApplicationTests()&#123;&#125;</span><br><span class="line">    @Autowired</span><br><span class="line">    OSSClient ossClient;</span><br><span class="line">    @Test</span><br><span class="line">    public void contextLoads() throws FileNotFoundException &#123;</span><br><span class="line">        InputStream inputStream = new FileInputStream(&quot;D:/a.jpg&quot;);</span><br><span class="line">        SimpleDateFormat sdf=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">        String date = sdf.format(new Date());</span><br><span class="line">        // 依次填写Bucket名称（例如examplebucket）和Object完整路径（例如exampledir/exampleobject.txt）。Object完整路径中不能包含Bucket名称。</span><br><span class="line">        ossClient.putObject(&quot;jiang-oss&quot;, date+&quot;/a.jpg&quot;, inputStream);</span><br><span class="line"></span><br><span class="line">        // 关闭OSSClient。</span><br><span class="line">        ossClient.shutdown();</span><br><span class="line">        System.out.println(&quot;上传成功&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="整合controller"><a href="#整合controller" class="headerlink" title="整合controller"></a>整合controller</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    alicloud:</span><br><span class="line">      access-key: LTAI5t6Tc8civonnHH6QpHQh</span><br><span class="line">      secret-key: 3iIUKRaiwYyx51p0BfmvBCBMpJDb1y</span><br><span class="line">      oss:</span><br><span class="line">        endpoint: oss-cn-beijing.aliyuncs.com</span><br><span class="line">        bucket: jiang-oss</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.gulimall.thirdparty.controller;</span><br><span class="line"></span><br><span class="line">import com.aliyun.oss.OSS;</span><br><span class="line">import com.aliyun.oss.OSSClient;</span><br><span class="line">import com.aliyun.oss.OSSClientBuilder;</span><br><span class="line">import com.aliyun.oss.common.utils.BinaryUtil;</span><br><span class="line">import com.aliyun.oss.model.MatchMode;</span><br><span class="line">import com.aliyun.oss.model.PolicyConditions;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.LinkedHashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/10/28  20:09</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class OssController &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.cloud.alicloud.oss.endpoint&#125;&quot;)</span><br><span class="line">    private String endpoint;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.cloud.alicloud.oss.bucket&#125;&quot;)</span><br><span class="line">    private String bucket;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.cloud.alicloud.access-key&#125;&quot;)</span><br><span class="line">    private String accessId;</span><br><span class="line"></span><br><span class="line">    //@Autowired</span><br><span class="line">    //OSSClient ossClient;</span><br><span class="line">    @Autowired</span><br><span class="line">    OSS ossClient;</span><br><span class="line">    @RequestMapping(&quot;/oss/policy&quot;)</span><br><span class="line">    public Map&lt;String, String&gt; policy()&#123;</span><br><span class="line">        String host = &quot;https://&quot; + bucket + &quot;.&quot; + endpoint; // host的格式为 bucketname.endpoint</span><br><span class="line">        SimpleDateFormat sdf=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">        String date = sdf.format(new Date());</span><br><span class="line">        //上传服务器回调的URL</span><br><span class="line">        //String callbackUrl=&quot;http://&quot;;</span><br><span class="line">        String dir = date+&quot;/&quot;; // 用户上传文件时指定的前缀。</span><br><span class="line">        Map&lt;String, String&gt; respMap =null;</span><br><span class="line">        // 创建OSSClient实例。</span><br><span class="line">        try &#123;</span><br><span class="line">            long expireTime = 30;</span><br><span class="line">            long expireEndTime = System.currentTimeMillis() + expireTime * 1000;</span><br><span class="line">            Date expiration = new Date(expireEndTime);</span><br><span class="line">            // PostObject请求最大可支持的文件大小为5 GB，即CONTENT_LENGTH_RANGE为5*1024*1024*1024。</span><br><span class="line">            PolicyConditions policyConds = new PolicyConditions();</span><br><span class="line">            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 1048576000);</span><br><span class="line">            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);</span><br><span class="line"></span><br><span class="line">            String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);</span><br><span class="line">            byte[] binaryData = postPolicy.getBytes(&quot;utf-8&quot;);</span><br><span class="line">            String encodedPolicy = BinaryUtil.toBase64String(binaryData);</span><br><span class="line">            String postSignature = ossClient.calculatePostSignature(postPolicy);</span><br><span class="line"></span><br><span class="line">             respMap = new LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">            respMap.put(&quot;accessid&quot;, accessId);</span><br><span class="line">            respMap.put(&quot;policy&quot;, encodedPolicy);</span><br><span class="line">            respMap.put(&quot;signature&quot;, postSignature);</span><br><span class="line">            respMap.put(&quot;dir&quot;, dir);</span><br><span class="line">            respMap.put(&quot;host&quot;, host);</span><br><span class="line">            respMap.put(&quot;expire&quot;, String.valueOf(expireEndTime / 1000));</span><br><span class="line">            // respMap.put(&quot;expire&quot;, formatISO8601Date(expiration));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // Assert.fail(e.getMessage());</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            ossClient.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        return respMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211028202853057.png" alt="image-20211028202853057"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211028203706082.png" alt="image-20211028203706082"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>spring-cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>java</title>
    <url>/2021/11/30/java/</url>
    <content><![CDATA[<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="三元运算符"><a href="#三元运算符" class="headerlink" title="三元运算符"></a>三元运算符</h2><p>a &gt; b ? x : y</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int a=1&gt;2?3:4;</span><br><span class="line">System.out.println(a);</span><br><span class="line">System.out.println(1&gt;2?3:4);</span><br></pre></td></tr></table></figure>

<h2 id="下划线转驼峰"><a href="#下划线转驼峰" class="headerlink" title="下划线转驼峰"></a>下划线转驼峰</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boco.nbd.threshold.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/11/25  16:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringUtil</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Pattern linePattern = Pattern.compile(<span class="string">&quot;_(\\w)&quot;</span>);</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Pattern humpPattern = Pattern.compile(<span class="string">&quot;[A-Z]&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 驼峰转下划线,最后转为大写</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">humpToLine</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">      Matcher matcher = humpPattern.matcher(str);</span><br><span class="line">      StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">      <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">         matcher.appendReplacement(sb, <span class="string">&quot;_&quot;</span> + matcher.group(<span class="number">0</span>).toUpperCase());</span><br><span class="line">      &#125;</span><br><span class="line">      matcher.appendTail(sb);</span><br><span class="line">      <span class="keyword">return</span> sb.toString().toUpperCase();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 下划线转驼峰,正常输出</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">lineToHump</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">      Matcher matcher = linePattern.matcher(str);</span><br><span class="line">      StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">      <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">         matcher.appendReplacement(sb, matcher.group(<span class="number">1</span>).toUpperCase());</span><br><span class="line">      &#125;</span><br><span class="line">      matcher.appendTail(sb);</span><br><span class="line">      <span class="keyword">return</span> sb.toString();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="jar包配置文件管理"><a href="#jar包配置文件管理" class="headerlink" title="jar包配置文件管理"></a>jar包配置文件管理</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">配置文件统一管理</span><br><span class="line"></span><br><span class="line">springboot核心配置文件</span><br><span class="line"></span><br><span class="line">Springboot读取核心配置文件（application.properties）的优先级为</span><br><span class="line"></span><br><span class="line">Jar包同级目录的config目录</span><br><span class="line"></span><br><span class="line">Jar包同级目录</span><br><span class="line"></span><br><span class="line">classPath(即resources目录)的config目录</span><br><span class="line"></span><br><span class="line">classpath目录</span><br><span class="line"></span><br><span class="line">上面是springboot默认去拿自己的核心配置文件的优先级，还有一种最高优先级的方式是项目启动时通过命令的方式指定项目加载核心配置文件，命令如下</span><br><span class="line"></span><br><span class="line">java –jar -Dspring.config.location=xxx/xxx/xxxx.properties xxxx.jar</span><br><span class="line"></span><br><span class="line">如果Spring Boot在优先级更高的位置找到了配置，那么它会无视优先级更低的配置</span><br></pre></td></tr></table></figure>

<h2 id="oss"><a href="#oss" class="headerlink" title="oss"></a>oss</h2><p>通过网络随时存储和调用包括文本、图片、音频和视频等在内的各种结构化或非结构化数据文件</p>
<p>阿里云 OSS 将数据文件以对象（object）的形式上传到存储空间（bucket）中</p>
<h2 id="ctrl-alt-L"><a href="#ctrl-alt-L" class="headerlink" title="ctrl+alt+L"></a>ctrl+alt+L</h2><p>idea  格式化java代码</p>
<h2 id="加密算法"><a href="#加密算法" class="headerlink" title="加密算法"></a>加密算法</h2><h3 id="crc64"><a href="#crc64" class="headerlink" title="crc64"></a>crc64</h3><p><img src="/../img/image-20211106175402945.png" alt="image-20211106175402945"></p>
<p>64位/8=8个字节，8字节长度为</p>
<p>（-9223372036854775808，9223372036854775807）</p>
<p>所以最终的值肯定在这个区间，永远都是a</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class CRC64 &#123;</span><br><span class="line">    static int crc_HashLimit = 64;</span><br><span class="line"></span><br><span class="line">    private CRC64() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void getCrc64id() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static CRC64.crcHash crcCalculate(String pStr, int len, CRC64.crcHash hv, CRC64.crcHash[] CrcXor) &#123;</span><br><span class="line">        int e = len;</span><br><span class="line">        int p = 0;</span><br><span class="line">        int s2;</span><br><span class="line">        int m;</span><br><span class="line">        int i;</span><br><span class="line">        if (crc_HashLimit &lt;= 32) &#123;</span><br><span class="line">            s2 = crc_HashLimit - 8;</span><br><span class="line">            m = -1 &gt;&gt;&gt; 32 - crc_HashLimit;</span><br><span class="line">            hv.h1 = 0;</span><br><span class="line"></span><br><span class="line">            for(hv.h2 &amp;= m; p &lt; e; ++p) &#123;</span><br><span class="line">                i = hv.h2 &gt;&gt;&gt; s2 &amp; 255;</span><br><span class="line">                hv.h2 = hv.h2 &lt;&lt; 8 &amp; m ^ pStr.charAt(p) ^ CrcXor[i].h2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (crc_HashLimit &lt; 40) &#123;</span><br><span class="line">            s2 = 40 - crc_HashLimit;</span><br><span class="line">            m = -1 &gt;&gt;&gt; 64 - crc_HashLimit;</span><br><span class="line"></span><br><span class="line">            for(hv.h1 &amp;= m; p &lt; e; ++p) &#123;</span><br><span class="line">                i = (hv.h1 &lt;&lt; s2 | hv.h2 &gt;&gt;&gt; 32 - s2) &amp; 255;</span><br><span class="line">                hv.h1 = (hv.h1 &lt;&lt; 8 ^ hv.h2 &gt;&gt;&gt; 24) &amp; m ^ CrcXor[i].h1;</span><br><span class="line">                hv.h2 = hv.h2 &lt;&lt; 8 ^ pStr.charAt(p) ^ CrcXor[i].h2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            s2 = crc_HashLimit - 40;</span><br><span class="line">            m = -1 &gt;&gt;&gt; 64 - crc_HashLimit;</span><br><span class="line"></span><br><span class="line">            for(hv.h1 &amp;= m; p &lt; e; ++p) &#123;</span><br><span class="line">                i = hv.h1;</span><br><span class="line">                int h2 = hv.h2;</span><br><span class="line">                int i = i &gt;&gt;&gt; s2 &amp; 255;</span><br><span class="line">                hv.h1 = i &lt;&lt; 8 &amp; m ^ h2 &gt;&gt;&gt; 24 &amp; 255 ^ CrcXor[i].h1;</span><br><span class="line">                hv.h2 = h2 &lt;&lt; 8 ^ pStr.charAt(p) ^ CrcXor[i].h2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return hv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getcrc64id(String source) &#123;</span><br><span class="line">        int h1 = false;</span><br><span class="line">        int h2 = false;</span><br><span class="line">        int high = false;</span><br><span class="line">        int low = false;</span><br><span class="line">        long a1 = 4294967296L;</span><br><span class="line">        int HINIT1 = -87805263;</span><br><span class="line">        int HINIT2 = 215344202;</span><br><span class="line">        int POLY1 = 6292288;</span><br><span class="line">        int POLY2 = 15783179;</span><br><span class="line">        CRC64.crcHash[] CrcXor = new CRC64.crcHash[256];</span><br><span class="line"></span><br><span class="line">        int i;</span><br><span class="line">        for(i = 0; i &lt; 256; ++i) &#123;</span><br><span class="line">            CrcXor[i] = new CRC64.crcHash();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CRC64.crcHash[] Poly = new CRC64.crcHash[65];</span><br><span class="line"></span><br><span class="line">        for(i = 0; i &lt; 65; ++i) &#123;</span><br><span class="line">            Poly[i] = new CRC64.crcHash();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Poly[64].h1 = POLY1;</span><br><span class="line">        Poly[64].h2 = POLY2;</span><br><span class="line"></span><br><span class="line">        for(i = 63; i &gt;= 16; --i) &#123;</span><br><span class="line">            Poly[i].h1 = Poly[i + 1].h1 &gt;&gt;&gt; 1;</span><br><span class="line">            Poly[i].h2 = Poly[i + 1].h2 &gt;&gt;&gt; 1 | (Poly[i + 1].h1 &amp; 1) &lt;&lt; 31 | 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for(i = 0; i &lt; 256; ++i) &#123;</span><br><span class="line">            int v = i;</span><br><span class="line">            CRC64.crcHash hv = new CRC64.crcHash(0, 0);</span><br><span class="line"></span><br><span class="line">            for(int j = 0; j &lt; 8; v &lt;&lt;= 1) &#123;</span><br><span class="line">                hv.h1 &lt;&lt;= 1;</span><br><span class="line">                if (((long)hv.h2 &amp; 2147483648L) != 0L) &#123;</span><br><span class="line">                    hv.h1 |= 1;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hv.h2 &lt;&lt;= 1;</span><br><span class="line">                if ((v &amp; 128) != 0) &#123;</span><br><span class="line">                    hv.h1 ^= Poly[crc_HashLimit].h1;</span><br><span class="line">                    hv.h2 ^= Poly[crc_HashLimit].h2;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ++j;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CrcXor[i] = hv;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CRC64.crcHash hv = new CRC64.crcHash(HINIT1, HINIT2);</span><br><span class="line">        CRC64.crcHash result_hash = crcCalculate(source, source.length(), hv, CrcXor);</span><br><span class="line">        int h1 = result_hash.h1;</span><br><span class="line">        int h2 = result_hash.h2;</span><br><span class="line">        int low;</span><br><span class="line">        if (h1 &gt; 2147483647) &#123;</span><br><span class="line">            low = -1 * (-1 - h1) - 1;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            low = h1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int high;</span><br><span class="line">        if (h2 &gt; 2147483647) &#123;</span><br><span class="line">            high = -1 * (-1 - h2) - 1;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            high = h2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long result = (long)high * a1 + (long)low;</span><br><span class="line">        return String.valueOf(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Long getCrc64id(String source) &#123;</span><br><span class="line">        return Long.valueOf(getcrc64id(source));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class crcHash &#123;</span><br><span class="line">        public int h1;</span><br><span class="line">        public int h2;</span><br><span class="line"></span><br><span class="line">        public crcHash() &#123;</span><br><span class="line">            this.h1 = 0;</span><br><span class="line">            this.h2 = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public crcHash(int theH1, int theH2) &#123;</span><br><span class="line">            this.h1 = theH1;</span><br><span class="line">            this.h2 = theH2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="json集合和数组的区别"><a href="#json集合和数组的区别" class="headerlink" title="json集合和数组的区别"></a>json集合和数组的区别</h2><p><img src="/../img/image-20211112141659773.png" alt="image-20211112141659773"></p>
<h2 id="生成json文件，自定义内容"><a href="#生成json文件，自定义内容" class="headerlink" title="生成json文件，自定义内容"></a>生成json文件，自定义内容</h2><pre><code>package com.boco.nbd.upload.station.util;

import lombok.extern.slf4j.Slf4j;
    import org.springframework.util.ResourceUtils;
import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.util.*;

/**
 *  生成json文件工具类     by   xwd
 */

@Slf4j
public class JSONUtils &#123;

    //封装创建json文件的方法
    public static boolean createJSONFile(Object obj, String fileName)&#123;
        boolean flag = true;

        try &#123;
            //获取文件的绝对路径        根路径
            //String filePath = ResourceUtils.getURL(&quot;classpath:&quot;).getPath();
            String filePath = &quot;D:&quot;;
            String jsonString = com.alibaba.druid.support.json.JSONUtils.toJSONString(obj);
            // 拼接文件完整路径// 生成json格式文件
            String fullPath = filePath + File.separator + fileName + &quot;.json&quot;;
            // 保证创建一个新文件
            File file = new File(fullPath);
            if (!file.getParentFile().exists()) &#123; // 如果父目录不存在，创建父目录
                file.getParentFile().mkdirs();
            &#125;
            if (file.exists()) &#123; // 如果已存在,删除旧文件
                file.delete();
            &#125;
            file.createNewFile();//创建新文件

            if(jsonString.indexOf(&quot;&#39;&quot;)!=-1)&#123;
                //将单引号转义一下，因为JSON串中的字符串类型可以单引号引起来的
                jsonString = jsonString.replaceAll(&quot;&#39;&quot;, &quot;\\&#39;&quot;);
            &#125;
            if(jsonString.indexOf(&quot;\&quot;&quot;)!=-1)&#123;
                //将双引号转义一下，因为JSON串中的字符串类型可以单引号引起来的
                jsonString = jsonString.replaceAll(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;);
            &#125;

            if(jsonString.indexOf(&quot;\r\n&quot;)!=-1)&#123;
                //将回车换行转换一下，因为JSON串中字符串不能出现显式的回车换行
                jsonString = jsonString.replaceAll(&quot;\r\n&quot;, &quot;\\u000d\\u000a&quot;);
            &#125;
            if(jsonString.indexOf(&quot;\n&quot;)!=-1)&#123;
                //将换行转换一下，因为JSON串中字符串不能出现显式的换行
                jsonString = jsonString.replaceAll(&quot;\n&quot;, &quot;\\u000a&quot;);
            &#125;
            // 将格式化后的字符串写入文件
            Writer write = new OutputStreamWriter(new FileOutputStream(file), &quot;UTF-8&quot;);
            log.info(&quot;json文件内容：&quot; + jsonString);
            write.write(jsonString);
            log.info(&quot;文件创建成功！&quot;);
            write.flush();
            write.close();
        &#125; catch (Exception e) &#123;
            flag = false;
            e.printStackTrace();
        &#125;
        return flag;
    &#125;
</code></pre>
<h2 id="枚举类用法"><a href="#枚举类用法" class="headerlink" title="枚举类用法"></a>枚举类用法</h2><p>初始化对象结构</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.threshold.enums;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/10/20  11:49</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:**枚举类</span><br><span class="line"> */</span><br><span class="line">public enum DeviceMonitorEnum &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 动环</span><br><span class="line">     */</span><br><span class="line">    TEMP(&quot;动环&quot;, &quot;1&quot;, &quot;10&quot;),</span><br><span class="line">    /**</span><br><span class="line">     * 门架</span><br><span class="line">     */</span><br><span class="line">    GANTRY(&quot;门架&quot;, &quot;2&quot;, &quot;11&quot;),</span><br><span class="line">    /**</span><br><span class="line">     * 收费系统</span><br><span class="line">     */</span><br><span class="line">    LANE(&quot;收费系统&quot;, &quot;3&quot;, &quot;12&quot;),</span><br><span class="line">    /**</span><br><span class="line">     * 外场设备</span><br><span class="line">     */</span><br><span class="line">    MONITOR(&quot;外场设备&quot;, &quot;4&quot;, &quot;13&quot;);</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line">    private String id;</span><br><span class="line">    private String proId;</span><br><span class="line"></span><br><span class="line">    DeviceMonitorEnum(String name, String proId, String id) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.id = id;</span><br><span class="line">        this.proId = proId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(String id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getProId() &#123;</span><br><span class="line">        return proId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setProId(String proId) &#123;</span><br><span class="line">        this.proId = proId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始化创建</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static List&lt;ResourceBO&gt; create() &#123;</span><br><span class="line">        DeviceMonitorEnum[] enums = DeviceMonitorEnum.values();</span><br><span class="line">        List&lt;ResourceBO&gt; list = new ArrayList&lt;&gt;(10);</span><br><span class="line">        for (int i = 0; i &lt; enums.length; i++) &#123;</span><br><span class="line">            ResourceBO bo = new ResourceBO();</span><br><span class="line">            bo.setNo(i + 1);</span><br><span class="line">            bo.setId(enums[i].getId());</span><br><span class="line">            bo.setProId(enums[i].getProId());</span><br><span class="line">            bo.setName(enums[i].getName());</span><br><span class="line">            bo.setCount(0);</span><br><span class="line">            bo.setProCount(0);</span><br><span class="line">            if (&quot;1&quot;.equals(bo.getId())) &#123;</span><br><span class="line">                bo.setProCount(-1);</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(bo);</span><br><span class="line">        &#125;</span><br><span class="line">        return list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.threshold.enums;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.annotation.JsonIgnore;</span><br><span class="line">import io.swagger.annotations.ApiModelProperty;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.ToString;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/10/20  11:49</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:**枚举类</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">@ToString</span><br><span class="line">public class ResourceBO &#123;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;序号&quot;)</span><br><span class="line">    private Integer no;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;标识&quot;)</span><br><span class="line">    private String id;</span><br><span class="line"></span><br><span class="line">    @JsonIgnore</span><br><span class="line">    @ApiModelProperty(&quot;故障标识&quot;)</span><br><span class="line">    private String proId;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;标签名称&quot;)</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;总数&quot;)</span><br><span class="line">    private Integer count;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;故障总数&quot;)</span><br><span class="line">    private Integer proCount;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="判断是否在cron表达式中"><a href="#判断是否在cron表达式中" class="headerlink" title="判断是否在cron表达式中"></a>判断是否在cron表达式中</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.threshold.util;</span><br><span class="line"></span><br><span class="line">import net.logstash.logback.encoder.org.apache.commons.lang.ArrayUtils;</span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/10/29  16:33</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">public class Cron &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 判断date是否在cron表达式中,没有秒，周，年的粒度</span><br><span class="line">     * @param cron</span><br><span class="line">     * @param date1</span><br><span class="line">     */</span><br><span class="line">    public static boolean isInclude(String cron,Date date1)&#123;</span><br><span class="line">        String[] s = cron.split(&quot; &quot;);</span><br><span class="line">        String[] s1=new String[4];</span><br><span class="line">        s1[0]=s[1];</span><br><span class="line">        s1[1]=s[2];</span><br><span class="line">        s1[2]=s[3];</span><br><span class="line">        s1[3]=s[4];</span><br><span class="line">        SimpleDateFormat sdf=new SimpleDateFormat(&quot;mm-HH-dd-MM&quot;);</span><br><span class="line">        String date = sdf.format(date1);</span><br><span class="line">        String[] s2 = date.split(&quot;-&quot;);</span><br><span class="line">        boolean flag=true;</span><br><span class="line">        for(int i=0;i&lt;4;i++)&#123;</span><br><span class="line">            if(!isTrue(s1[i],s2[i]))&#123;</span><br><span class="line">                flag=false;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static boolean isTrue(String s1,String s2)&#123;</span><br><span class="line">        if(s1.contains(&quot;*&quot;))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        else if(s1.contains(&quot;,&quot;))&#123;</span><br><span class="line">            String[] split = s1.split(&quot;,&quot;);</span><br><span class="line">            return ArrayUtils.contains(split,s2);</span><br><span class="line">        &#125;</span><br><span class="line">        else if(s1.contains(&quot;-&quot;))&#123;</span><br><span class="line">            String[] split = s1.split(&quot;-&quot;);</span><br><span class="line">            int a = Integer.parseInt(split[0]);</span><br><span class="line">            int b = Integer.parseInt(split[1]);</span><br><span class="line">            int c = Integer.parseInt(s2);</span><br><span class="line">            if(c&gt;=a&amp;&amp;c&lt;=b)&#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //只有一个数字,需要相等</span><br><span class="line">        else&#123;</span><br><span class="line">            if(s1.equals(s2))&#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Map遍历"><a href="#Map遍历" class="headerlink" title="Map遍历"></a>Map遍历</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map&lt;String,String&gt; map = new HashMap&lt;String,String&gt;();</span><br><span class="line">        map.put(&quot;1&quot;,&quot;a&quot;);</span><br><span class="line">        map.put(&quot;2&quot;,&quot;b&quot;);</span><br><span class="line">        map.put(&quot;3&quot;,&quot;c&quot;);</span><br><span class="line">		System.out.println(map.keySet());</span><br><span class="line">//map.keySet()--&gt;[1,2,3],可以理解为map.keySet()遍历map里的key，然后通过map.get(key)取值，完成遍历</span><br><span class="line">        for(String key: map.keySet())&#123;</span><br><span class="line">            System.out.println(&quot;key=&quot;+key+&quot; and value = &quot;+map.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        Set&lt;Map.Entry&lt;Integer,String&gt;&gt; entries=map.entrySet();</span><br><span class="line">    	System.out.println(entries);//[1=a, 2=b, 3=c]</span><br><span class="line">    </span><br><span class="line">        for (Map.Entry entry:entries)&#123;</span><br><span class="line">            System.out.println(&quot;key:&quot;+entry.getKey()+&quot; &quot;</span><br><span class="line">                    +&quot;value:&quot;+entry.getValue());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h1 id="打印日志输出到本地文件"><a href="#打印日志输出到本地文件" class="headerlink" title="打印日志输出到本地文件"></a>打印日志输出到本地文件</h1><p><a href="https://blog.csdn.net/MengDiL_yl/article/details/86648197?spm=1001.2101.3001.6650.7&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-7.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-7.no_search_link">https://blog.csdn.net/MengDiL_yl/article/details/86648197?spm=1001.2101.3001.6650.7&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-7.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-7.no_search_link</a></p>
<h1 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h1><p><a href="https://blog.csdn.net/xsp_happyboy/article/details/80987484?spm=1001.2101.3001.6650.9&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-9.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-9.no_search_link">https://blog.csdn.net/xsp_happyboy/article/details/80987484?spm=1001.2101.3001.6650.9&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-9.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-9.no_search_link</a></p>
<p><img src="/../img/image-20211123174753114.png" alt="image-20211123174753114"></p>
<h1 id="springboot自启动方法"><a href="#springboot自启动方法" class="headerlink" title="springboot自启动方法"></a>springboot自启动方法</h1><p><img src="/../img/image-20211022085446005.png" alt="image-20211022085446005"></p>
<p>controller+ implements ApplicationRunner</p>
<p>这样启动后此方法就自动执行了</p>
<p>或者直接放在spring启动类里</p>
<p><img src="/../img/image-20211212140002107.png" alt="image-20211212140002107"></p>
<h1 id="自定义application-yml属性并获取"><a href="#自定义application-yml属性并获取" class="headerlink" title="自定义application.yml属性并获取"></a>自定义application.yml属性并获取</h1><h2 id="第一种，指定前缀，并使用-value注解，可以自定义属性名"><a href="#第一种，指定前缀，并使用-value注解，可以自定义属性名" class="headerlink" title="第一种，指定前缀，并使用@value注解，可以自定义属性名"></a>第一种，指定前缀，并使用@value注解，可以自定义属性名</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kafka:</span></span><br><span class="line">  <span class="attr">zookeeper-url:</span> <span class="number">10.12</span><span class="number">.1</span><span class="number">.50</span><span class="string">:9092</span></span><br><span class="line">  <span class="attr">topic-name:</span> <span class="string">test1</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">NBD_NT</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;kafka&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaBO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;kafka.zookeeper-url&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String kafkaServer;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;kafka.topic-name&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;kafka.group&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String group;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">KafkaBO kafkaBO;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(kafkaBO.getxxxx());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20210726093024506.png" alt="image-20210726093024506"></p>
<h2 id="第二种方法，直接在类中使用"><a href="#第二种方法，直接在类中使用" class="headerlink" title="第二种方法，直接在类中使用"></a>第二种方法，直接在类中使用</h2><p><img src="/../img/image-20210822131414193.png" alt="image-20210822131414193"></p>
<h2 id="想要在获取类中直接使用"><a href="#想要在获取类中直接使用" class="headerlink" title="想要在获取类中直接使用"></a>想要在获取类中直接使用</h2><p><img src="/../img/image-20211021125957183.png" alt="image-20211021125957183"></p>
<p>比如下方，在controller里注入，就可以使用了</p>
<p><img src="/../img/image-20211021130029410.png" alt="image-20211021130029410"></p>
<h1 id="读取json字符串中的某一个属性"><a href="#读取json字符串中的某一个属性" class="headerlink" title="读取json字符串中的某一个属性"></a>读取json字符串中的某一个属性</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		String result=<span class="string">&quot;&#123;\&quot;payOrderId\&quot;:\&quot;EPP10320190820709190\&quot;,\&quot;subOrderId\&quot;:null,\&quot;resultCode\&quot;:\&quot;0000\&quot;,\&quot;sign\&quot;:\&quot;bwVmGWv0q_7HRtbE\&quot;,\&quot;merchantOrderId\&quot;:\&quot;7000001393\&quot;,\&quot;resultMsg\&quot;:\&quot;受理成功\&quot;&#125;&quot;</span>;	</span><br><span class="line">	<span class="comment">// 字符串转换为JSON</span></span><br><span class="line">	JSONObject jsonObject = JSON.parseObject(result);	<span class="comment">// result数据源：JSON格式字符串</span></span><br><span class="line">	<span class="comment">// 获取值</span></span><br><span class="line">	String s = jsonObject.getString(<span class="string">&quot;resultMsg&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	System.out.println(s);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="拼接字符串Joiner-on-File-separator-join-list"><a href="#拼接字符串Joiner-on-File-separator-join-list" class="headerlink" title="拼接字符串Joiner.on(File.separator).join(list);"></a>拼接字符串Joiner.on(File.separator).join(list);</h1><p><img src="/../img/image-20220105101428068.png" alt="image-20220105101428068"></p>
<h1 id="集合框架"><a href="#集合框架" class="headerlink" title="集合框架"></a>集合框架</h1><p><a href="https://blog.csdn.net/jiang458572759/article/details/115006327?spm=1001.2014.3001.5501">https://blog.csdn.net/jiang458572759/article/details/115006327?spm=1001.2014.3001.5501</a></p>
<h1 id="try-catch-finally"><a href="#try-catch-finally" class="headerlink" title="try-catch-finally"></a>try-catch-finally</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(a());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(e.getMessage());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>finally里最终都会执行，但是最终return不是finally里的</p>
<p><img src="/../img/image-20220105104720705.png" alt="image-20220105104720705"></p>
<p>并且，如果finally有return了，那么就不能在往下写代码了，并且最终返回值为4</p>
<p><img src="/../img/image-20220105104752162.png" alt="image-20220105104752162"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(a());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">如果需要往下走，那么finally里不能有return，并且走到fianlly之前都不能走return</span></span><br><span class="line"><span class="comment">的分支</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                System.out.println(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(e.getMessage());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="application-bootstrap"><a href="#application-bootstrap" class="headerlink" title="application-bootstrap"></a>application-bootstrap</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">加载顺序</span><br><span class="line">若application.yml 和bootstrap.yml 在同一目录下：</span><br><span class="line"></span><br><span class="line">bootstrap.yml 先加载 application.yml后加载</span><br><span class="line"></span><br><span class="line">bootstrap.yml 用于应用程序上下文的引导阶段。bootstrap.yml 由父Spring ApplicationContext加载。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">配置区别</span><br><span class="line">bootstrap.yml 和 application.yml 都可以用来配置参数。</span><br><span class="line"></span><br><span class="line">bootstrap.yml 用来程序引导时执行，应用于更加早期配置信息读取。可以理解成系统级别的一些参数配置，这些参数一般是不会变动的。一旦bootStrap.yml 被加载，则内容不会被覆盖。</span><br><span class="line"></span><br><span class="line">application.yml 可以用来定义应用级别的， 应用程序特有配置信息，可以用来配置后续各个模块中需使用的公共参数等。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">属性覆盖问题</span><br><span class="line">启动上下文时，Spring Cloud 会创建一个 Bootstrap Context，作为 Spring 应用的 Application Context 的父上下文。</span><br><span class="line"></span><br><span class="line">application.yml 的内容标签与 bootstrap 的标签一致，application 会覆盖 bootstrap，而 application.yml 里面的内容可以动态替换。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bootstrap.yml典型的应用场景</span><br><span class="line">当使用 Spring Cloud Config Server 配置中心时，这时需要在 bootstrap.yml 配置文件中指定 spring.application.name 和 spring.cloud.config.server.git.uri，添加连接到配置中心的配置属性来加载外部配置中心的配置信息</span><br><span class="line">一些固定的不能被覆盖的属性</span><br><span class="line">一些加密/解密的场景</span><br></pre></td></tr></table></figure>

<h1 id="AtomicInteger"><a href="#AtomicInteger" class="headerlink" title="AtomicInteger"></a>AtomicInteger</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、基本使用</span><br><span class="line">public class TestAtomic &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        AtomicInteger i = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">        System.out.println(i.incrementAndGet());    //++i;</span><br><span class="line">        System.out.println(i.getAndIncrement());    //i++;</span><br><span class="line"></span><br><span class="line">        System.out.println(i.getAndAdd(5));  //先获取i，再加5</span><br><span class="line">        System.out.println(i.addAndGet(5));  //先加5，在获取i</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果展示：</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">12</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="获取一个文件下所有的文件夹与文件"><a href="#获取一个文件下所有的文件夹与文件" class="headerlink" title="获取一个文件下所有的文件夹与文件"></a>获取一个文件下所有的文件夹与文件</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 使用递归的方法调用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path 文件夹路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileList  集合列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> java.util.List&lt;java.io.File&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> https://blog.csdn.net/chen_2890</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/6/14 17:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;File&gt; <span class="title">traverseFolder2</span><span class="params">(String path,List&lt;File&gt; fileList)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   File file = <span class="keyword">new</span> File(path);</span><br><span class="line">   <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">      File[] files = file.listFiles();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == files || files.length == <span class="number">0</span>) &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;文件夹是空的!&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">for</span> (File file2 : files) &#123;</span><br><span class="line">            <span class="keyword">if</span> (file2.isDirectory()) &#123;</span><br><span class="line">               System.out.println(<span class="string">&quot;文件夹:&quot;</span> + file2.getAbsolutePath());</span><br><span class="line">               traverseFolder2(file2.getAbsolutePath(),fileList);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               fileList.add(file2);</span><br><span class="line">               System.out.println(<span class="string">&quot;文件:&quot;</span> + file2.getAbsolutePath());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;文件不存在!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> fileList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="判断系统是windo还是linux"><a href="#判断系统是windo还是linux" class="headerlink" title="判断系统是windo还是linux"></a>判断系统是windo还是linux</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">String os = System.getProperty(&quot;os.name&quot;);</span><br><span class="line">       //Windows操作系统</span><br><span class="line">       if (os != null &amp;&amp; os.toLowerCase().startsWith(&quot;windows&quot;)) &#123;</span><br><span class="line">           System.out.println(String.format(&quot;当前系统版本是:%s&quot;, os));</span><br><span class="line">       &#125; else if (os != null &amp;&amp; os.toLowerCase().startsWith(&quot;linux&quot;)) &#123;//Linux操作系统</span><br><span class="line">           System.out.println(String.format(&quot;当前系统版本是:%s&quot;, os));</span><br><span class="line">       &#125; else &#123; //其它操作系统</span><br><span class="line">           System.out.println(String.format(&quot;当前系统版本是:%s&quot;, os));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h1 id="mybaits输出sql到控制台"><a href="#mybaits输出sql到控制台" class="headerlink" title="mybaits输出sql到控制台"></a>mybaits输出sql到控制台</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">application.yml</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    root: info</span><br><span class="line">    com.jiang.mybatisplus.mapper: debug</span><br></pre></td></tr></table></figure>

<h1 id="Springboot测试类如何写"><a href="#Springboot测试类如何写" class="headerlink" title="Springboot测试类如何写"></a>Springboot测试类如何写</h1><p>pom</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--test--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>test</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootTest(classes = 你的启动类.class, webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span><br><span class="line">@RunWith(SpringRunner.class)</span><br></pre></td></tr></table></figure>

<h1 id="获取工具类但不是static方法"><a href="#获取工具类但不是static方法" class="headerlink" title="获取工具类但不是static方法"></a>获取工具类但不是static方法</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private static PathUtil pathUtil = null;</span><br><span class="line">/**</span><br><span class="line">    * 实例化</span><br><span class="line">    *</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">   public synchronized static PathUtil getInstance() &#123;</span><br><span class="line">      if (null == pathUtil) &#123;</span><br><span class="line">         pathUtil = new PathUtil();</span><br><span class="line">      &#125;</span><br><span class="line">      return pathUtil;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h1 id="生成秘钥"><a href="#生成秘钥" class="headerlink" title="生成秘钥"></a>生成秘钥</h1><p>生成一个秘钥，利用秘钥免密登录，随便一个目录就行</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C jiangjiaxu521<span class="variable">@163</span>.com</span><br></pre></td></tr></table></figure>

<p>linux秘钥生成在/root/.ssh/下，一个私钥id_rsa，一个公钥id_rsa.pub</p>
<p>windows生成在C:\Users\Administrator.ssh</p>
<p>使用cat id_rsa.pub命令查看公钥</p>
<h1 id="ImmutableMap-of"><a href="#ImmutableMap-of" class="headerlink" title="ImmutableMap.of"></a>ImmutableMap.of</h1><p>常规的map一个一个put</p>
<p>可以以key,value,key1,value1这样直接添加进去</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map&lt;String, Integer&gt; typeMap = ImmutableMap.of(</span><br><span class="line">        &quot;1&quot;, 1,</span><br><span class="line">        &quot;2&quot;, 2,</span><br><span class="line">        &quot;3&quot;, 3</span><br><span class="line">        );</span><br><span class="line">System.out.println(typeMap);</span><br></pre></td></tr></table></figure>

<p>of方法入参最多只能有5对,如果添加的数据超过5对,需要改用builder方法.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map&lt;Integer, String&gt; INTEGER_STRING_MAP = new ImmutableMap.Builder&lt;Integer, String&gt;().</span><br><span class="line">                    put(30, &quot;IP地址或地址段&quot;).</span><br><span class="line">                    put(31, &quot;端口号或范围&quot;).</span><br><span class="line">                    put(32, &quot;IP地址或地址段&quot;).</span><br><span class="line">                    put(33, &quot;端口号或范围&quot;).</span><br><span class="line">                    .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Arrays-asList-str-split-“-”"><a href="#Arrays-asList-str-split-“-”" class="headerlink" title="Arrays.asList(str.split(“\,”))"></a>Arrays.asList(str.split(“\,”))</h1><p>把以逗号分隔的字符串变成list数组</p>
<h1 id="sout和log打印"><a href="#sout和log打印" class="headerlink" title="sout和log打印"></a>sout和log打印</h1><h2 id="1"><a href="#1" class="headerlink" title="1.{}"></a>1.{}</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">log.info(&quot;声音文件上传成功!文件名称:&#123;&#125;&quot;, fileName);</span><br></pre></td></tr></table></figure>

<h2 id="2"><a href="#2" class="headerlink" title="2.+"></a>2.+</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">System.out.println(&quot;声音文件上传成功!文件名称:&quot;+fileName);</span><br></pre></td></tr></table></figure>

<h1 id="Iterator获取遍历"><a href="#Iterator获取遍历" class="headerlink" title="Iterator获取遍历"></a>Iterator获取遍历</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ArrayList&lt;Integer&gt; list = ListUtil.toList(1, 2, 3, 4);</span><br><span class="line">		Iterator&lt;Integer&gt; it = list.iterator();</span><br><span class="line">		if(it.hasNext())&#123;</span><br><span class="line">			Integer next = it.next();</span><br><span class="line">			//操作</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<h1 id="心跳思路"><a href="#心跳思路" class="headerlink" title="心跳思路"></a>心跳思路</h1><p>xxl-job定时执行任务，A发送http请求到B，B接受到，就是A一直在发送心跳</p>
<h1 id="OSS系统简介"><a href="#OSS系统简介" class="headerlink" title="OSS系统简介"></a>OSS系统简介</h1><p><em>OSS系统</em>由资源管理<em>系统</em>、网管<em>系统</em>（包括综合网管<em>系统</em>和专业网管<em>系统</em>——EMS/NMS）和运维管理<em>系统</em>三部分构成，是一个统一的业务支撑 和业务保障<em>系统</em>。</p>
<h1 id="枚举匹配返回"><a href="#枚举匹配返回" class="headerlink" title="枚举匹配返回"></a>枚举匹配返回</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">EnumUtil.likeValueOf(InterfaceType.class, config.getType().toUpperCase(Locale.ROOT));</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220401151820417.png" alt="image-20220401151820417"></p>
<p>config.getType()是小写的post或者get，Eunm类型，.toUpperCase(Locale.ROOT)大写，要变成InterfaceType.class</p>
<p><img src="/../img/image-20220401151903334.png" alt="image-20220401151903334"></p>
<h1 id="String转大小写，以及忽略大小写比较"><a href="#String转大小写，以及忽略大小写比较" class="headerlink" title="String转大小写，以及忽略大小写比较"></a>String转大小写，以及忽略大小写比较</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.toUpperCase(Locale.ROOT)</span><br><span class="line">.toLowerCase(Locale.ROOT);</span><br><span class="line">s1.equalsIgnoreCase(s2)</span><br></pre></td></tr></table></figure>

<h1 id="常用的时间格式-yyyy-MM-dd-HH-mm-ss"><a href="#常用的时间格式-yyyy-MM-dd-HH-mm-ss" class="headerlink" title="常用的时间格式 yyyy-MM-dd HH:mm:ss"></a>常用的时间格式 yyyy-MM-dd HH:mm:ss</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DateUtil.formatDateTime(new Date())</span><br></pre></td></tr></table></figure>

<h1 id="获取访问服务器的IP，电脑系统，版本，浏览器"><a href="#获取访问服务器的IP，电脑系统，版本，浏览器" class="headerlink" title="获取访问服务器的IP，电脑系统，版本，浏览器"></a>获取访问服务器的IP，电脑系统，版本，浏览器</h1><p>hutool的包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static String getClientIP() &#123;</span><br><span class="line">    HttpServletRequest request = getRequest();</span><br><span class="line">    if (request == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    return ServletUtil.getClientIP(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static String getUserAgent() &#123;</span><br><span class="line">    HttpServletRequest request = getRequest();</span><br><span class="line">    if (request == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">     String ua = request.getHeader(&quot;User-Agent&quot;);</span><br><span class="line">    return ua != null ? ua : &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220411174800885.png" alt="image-20220411174800885"></p>
<h1 id="把list集合转为map"><a href="#把list集合转为map" class="headerlink" title="把list集合转为map"></a>把list集合转为map</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map roleCache = CollectionUtils.convertMap(roleList, RoleDO::getId);</span><br></pre></td></tr></table></figure>

<p>key：每个RoleDO的Id</p>
<p>value： RoleDO</p>
<h1 id="一种好的习惯"><a href="#一种好的习惯" class="headerlink" title="一种好的习惯"></a>一种好的习惯</h1><p>如果在一个controller里多个方法都查询了同一个sql</p>
<p>那么可以创建一个hashMap，key为对象的id，value为对象</p>
<p>使用注解</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private static HashMap&lt;String, Object&gt; cache = new HashMap&lt;String, Object&gt;();</span><br><span class="line">@PostConstruct</span><br><span class="line">public void init() &#123;</span><br><span class="line">    loadCache();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//如果查出的是对象集合，那么可以使用上方的CollectionUtils.convertMap(roleList, RoleDO::getId);</span><br><span class="line">//如果是map，那么遍历这个list&lt;map&gt;，cache.put(map.getId,map)</span><br><span class="line">public void loadCache()&#123;</span><br><span class="line">	cache=sql语句查出</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>stream流</title>
    <url>/2021/11/30/java8%E4%BB%A5%E5%8F%8Astream%E6%B5%81/</url>
    <content><![CDATA[<h1 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<h1 id="通用的业务流程，设备展示"><a href="#通用的业务流程，设备展示" class="headerlink" title="通用的业务流程，设备展示"></a>通用的业务流程，设备展示</h1><h2 id="创建一个ResourceBo"><a href="#创建一个ResourceBo" class="headerlink" title="创建一个ResourceBo"></a>创建一个ResourceBo</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceBO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;序号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer no;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;标识&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;故障标识&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String proId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;标签名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;故障总数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer proCount;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="一个Enum枚举类，注意create类"><a href="#一个Enum枚举类，注意create类" class="headerlink" title="一个Enum枚举类，注意create类"></a>一个Enum枚举类，注意create类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boco.nbd.nantong.traffic.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.boco.nbd.nantong.traffic.entity.bo.ResourceBO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> GantryEquipmentEnum</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 门架设备弹窗统计 枚举类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Email</span> jiangjiaxu@boco.com.cn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2022/1/12 14:20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> V1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">GantryEquipmentEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 门架总数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    COUNT(<span class="string">&quot;门架总数&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;1&quot;</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 门架设备总数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DEVICE_COUNT(<span class="string">&quot;门架设备总数&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String proId;</span><br><span class="line"></span><br><span class="line">    GantryEquipmentEnum(String name, String proId, String id) &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.proId = proId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> proId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProId</span><span class="params">(String proId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.proId = proId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ResourceBO&gt; <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        GantryEquipmentEnum[] enums = GantryEquipmentEnum.values();</span><br><span class="line">        List&lt;ResourceBO&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; enums.length; i++) &#123;</span><br><span class="line">            ResourceBO bo = <span class="keyword">new</span> ResourceBO();</span><br><span class="line">            bo.setNo(i + <span class="number">1</span>);</span><br><span class="line">            bo.setId(enums[i].getId());</span><br><span class="line">            bo.setProId(enums[i].getProId());</span><br><span class="line">            bo.setName(enums[i].getName());</span><br><span class="line">            bo.setCount(<span class="number">0</span>);</span><br><span class="line">            bo.setProCount(<span class="number">0</span>);</span><br><span class="line">            list.add(bo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置Resource的字段"><a href="#设置Resource的字段" class="headerlink" title="设置Resource的字段"></a>设置Resource的字段</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;ResourceBO&gt; <span class="title">getResourceList</span><span class="params">(<span class="keyword">int</span> initNum, String roadId, String roadSectionId)</span> </span>&#123;</span><br><span class="line">    List&lt;ResourceBO&gt; resource = initEnum(initNum);</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; list = initMapper(initNum, roadId, roadSectionId);</span><br><span class="line">    <span class="keyword">if</span> (!list.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (ResourceBO item : resource) &#123;</span><br><span class="line">            Optional&lt;Map&lt;String, Object&gt;&gt; optional = list.stream().filter(s -&gt; s.get(<span class="string">&quot;flag&quot;</span>).equals(item.getId())).findFirst();</span><br><span class="line">            <span class="keyword">if</span> (optional.isPresent()) &#123;</span><br><span class="line">                item.setCount(Convert.toInt(optional.get().get(<span class="string">&quot;totalNumber&quot;</span>), <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            Optional&lt;Map&lt;String, Object&gt;&gt; optional1 = list.stream().filter(s -&gt; s.get(<span class="string">&quot;flag&quot;</span>).equals(item.getProId())).findFirst();</span><br><span class="line">            <span class="keyword">if</span> (optional1.isPresent()) &#123;</span><br><span class="line">                item.setProCount(Convert.toInt(optional1.get().get(<span class="string">&quot;totalNumber&quot;</span>), <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">基础语法：</span><br><span class="line"></span><br><span class="line">- 操作符：-&gt;</span><br><span class="line">- 左侧：参数列表</span><br><span class="line">- 右侧：执行代码块 / Lambda 体</span><br></pre></td></tr></table></figure>

<h2 id="1-无参数无返回值"><a href="#1-无参数无返回值" class="headerlink" title="1.无参数无返回值"></a>1.无参数无返回值</h2><h3 id="1-只有一段代码-gt-b"><a href="#1-只有一段代码-gt-b" class="headerlink" title="1.只有一段代码() -&gt;  b;"></a>1.只有一段代码() -&gt;  b;</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="comment">//语法糖</span></span><br><span class="line">   Runnable runnable = () -&gt; System.out.println(<span class="string">&quot;Hello Lambda&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-多段代码-gt"><a href="#2-多段代码-gt" class="headerlink" title="2.多段代码 () -&gt; {};"></a>2.多段代码 () -&gt; {};</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//语法糖</span></span><br><span class="line">		Runnable runnable = () -&gt; &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line">			System.out.println(<span class="string">&quot;Hello Lambda&quot;</span>);</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-有一个参数无返回值-a-gt-b"><a href="#2-有一个参数无返回值-a-gt-b" class="headerlink" title="2.有一个参数无返回值 a -&gt; b;"></a>2.有一个参数无返回值 a -&gt; b;</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test03</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Consumer&lt;String&gt; consumer = (a) -&gt; System.out.println(a);</span><br><span class="line">    consumer.accept(<span class="string">&quot;我觉得还行！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//(小括号可以省略不写）</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test03</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Consumer&lt;String&gt; consumer = a -&gt; System.out.println(a);</span><br><span class="line">    consumer.accept(<span class="string">&quot;我觉得还行！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-两个及以上的参数，有返回值，并且-Lambda-体中有多条语句"><a href="#3-两个及以上的参数，有返回值，并且-Lambda-体中有多条语句" class="headerlink" title="3.两个及以上的参数，有返回值，并且 Lambda 体中有多条语句"></a>3.两个及以上的参数，有返回值，并且 Lambda 体中有多条语句</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test04</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Comparator&lt;Integer&gt; comparator = (a, b) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;比较接口&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Integer.compare(a, b);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//（大括号 与 return 都可以省略不写）</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Comparator&lt;Integer&gt; comparator = (a, b) -&gt; Integer.compare(b, a);</span><br><span class="line">		<span class="keyword">int</span> compare = comparator.compare(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">		System.out.println(compare);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="Lambda-表达式-参数的数据类型可以省略不写-Jvm可以自动进行-“类型推断”"><a href="#Lambda-表达式-参数的数据类型可以省略不写-Jvm可以自动进行-“类型推断”" class="headerlink" title="Lambda 表达式 参数的数据类型可以省略不写 Jvm可以自动进行 “类型推断”"></a>Lambda 表达式 参数的数据类型可以省略不写 Jvm可以自动进行 “类型推断”</h2></li>
</ul>
<h1 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h1><p>接口中只有一个抽象方法的接口 @FunctionalIterface<br>测试：</p>
<p>定义一个函数式接口：</p>
<pre><code>@FunctionalInterface
public interface MyFun &#123;
Integer count(Integer a, Integer b);
&#125;
</code></pre>
<p>用一下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test05()&#123;</span><br><span class="line">    MyFun myFun1 = (a, b) -&gt; a + b;</span><br><span class="line">    System.out.println(myFun1.count(1,1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再用一下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public Integer operation(Integer a, Integer b, MyFun myFun)&#123;</span><br><span class="line">    return myFun.count(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test06()&#123;</span><br><span class="line">    Integer result = operation(1, 2, (x, y) -&gt; x + y);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="案例一："><a href="#案例一：" class="headerlink" title="案例一："></a><strong>案例一：</strong></h3><p>调用 Collections.sort() 方法，通过定制排序 比较两个 Employee (先按照年龄比，年龄相同按照姓名比)，使用 Lambda 表达式作为参数传递</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义实体类</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Double salary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">   List&lt;Employee&gt; emps = Arrays.asList(</span><br><span class="line">         <span class="keyword">new</span> Employee(<span class="number">101</span>, <span class="string">&quot;Z3&quot;</span>, <span class="number">19</span>, <span class="number">9999.99</span>),</span><br><span class="line">         <span class="keyword">new</span> Employee(<span class="number">102</span>, <span class="string">&quot;L4&quot;</span>, <span class="number">20</span>, <span class="number">7777.77</span>),</span><br><span class="line">         <span class="keyword">new</span> Employee(<span class="number">103</span>, <span class="string">&quot;W5&quot;</span>, <span class="number">35</span>, <span class="number">6666.66</span>),</span><br><span class="line">         <span class="keyword">new</span> Employee(<span class="number">104</span>, <span class="string">&quot;Tom&quot;</span>, <span class="number">44</span>, <span class="number">1111.11</span>),</span><br><span class="line">         <span class="keyword">new</span> Employee(<span class="number">105</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="number">60</span>, <span class="number">4444.44</span>)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">   Collections.sort(emps, (e1, e2) -&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (e1.getAge() == e2.getAge())&#123;</span><br><span class="line">         <span class="keyword">return</span> e2.getName().compareTo(e1.getName());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> Integer.compare(e2.getAge(), e1.getAge());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (Employee emp : emps) &#123;</span><br><span class="line">      System.out.println(emp);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Java内置四大核心函数式接口："><a href="#Java内置四大核心函数式接口：" class="headerlink" title="Java内置四大核心函数式接口："></a>Java内置四大核心函数式接口：</h2><p><img src="/../img/image-20220119090538225.png" alt="image-20220119090538225"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3.1 消费型接口</span><br><span class="line">@Test</span><br><span class="line">public void test01()&#123;</span><br><span class="line">    //Consumer</span><br><span class="line">    Consumer&lt;Integer&gt; consumer = (x) -&gt; System.out.println(&quot;消费型接口&quot; + x);</span><br><span class="line">    //test</span><br><span class="line">    consumer.accept(100);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3.2 提供型接口</span><br><span class="line">@Test</span><br><span class="line">public void test02()&#123;</span><br><span class="line">    List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">		List&lt;Integer&gt; integers = Arrays.asList(1,2,3);</span><br><span class="line">		//list  --》 1,2,3</span><br><span class="line">		list.addAll(integers);</span><br><span class="line">		//Supplier&lt;T&gt;</span><br><span class="line">		Supplier&lt;Integer&gt; supplier = () -&gt; (int)(Math.random() * 10);</span><br><span class="line">		//list--》1,2,3,+一个随机数</span><br><span class="line">		list.add(supplier.get());</span><br><span class="line">		for (Integer integer : list) &#123;</span><br><span class="line">			System.out.println(integer);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3.3 函数型接口</span><br><span class="line">@Test</span><br><span class="line">public void test03()&#123;</span><br><span class="line">    //Function&lt;T, R&gt;</span><br><span class="line">		String oldStr = &quot;abc123456xyz&quot;;</span><br><span class="line">		Function&lt;String, String&gt; function = (s) -&gt; s.substring(1, s.length()-1);</span><br><span class="line">		//test</span><br><span class="line">		System.out.println(function.apply(oldStr));</span><br><span class="line">		//Function&lt;T, R&gt;,参数类型为第一个，返回值类型为第2个</span><br><span class="line">		Function&lt;String, Integer&gt; function1 = (s) -&gt; s.indexOf(&quot;x&quot;);</span><br><span class="line">		System.out.println(function1.apply(oldStr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3.4 断言型接口</span><br><span class="line">@Test</span><br><span class="line">public void test04()&#123;</span><br><span class="line">    //Predicate&lt;T&gt;</span><br><span class="line">    Integer age = 35;</span><br><span class="line">    Predicate&lt;Integer&gt; predicate = (i) -&gt; i &gt;= 35;</span><br><span class="line">    if (predicate.test(age))&#123;</span><br><span class="line">        System.out.println(&quot;你该退休了&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        System.out.println(&quot;我觉得还OK啦&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">4.1</span> 方法引用</span><br><span class="line">**定义：**若 Lambda 表达式体中的内容已有方法实现，则我们可以使用“方法引用”</span><br><span class="line"></span><br><span class="line">语法格式：</span><br><span class="line"></span><br><span class="line">对象 :: 实例方法</span><br><span class="line">类 :: 静态方法</span><br><span class="line">类 :: 实例方法</span><br><span class="line">对象::实例方法</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span></span>&#123;</span><br><span class="line">    PrintStream ps = System.out;</span><br><span class="line">    Consumer&lt;String&gt; con1 = (s) -&gt; ps.println(s);</span><br><span class="line">    con1.accept(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Consumer&lt;String&gt; con2 = ps::println;</span><br><span class="line">    con2.accept(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">**注意：**Lambda 表达实体中调用方法的参数列表、返回类型必须和函数式接口中抽象方法保持一致</span><br><span class="line"></span><br><span class="line">类::静态方法</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Comparator&lt;Integer&gt; com1 = (x, y) -&gt; Integer.compare(x, y);</span><br><span class="line">    System.out.println(com1.compare(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    Comparator&lt;Integer&gt; com2 = Integer::compare;</span><br><span class="line">    System.out.println(com2.compare(<span class="number">2</span>, <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">类::实例方法</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test03</span><span class="params">()</span></span>&#123;</span><br><span class="line">    BiPredicate&lt;String, String&gt; bp1 = (x, y) -&gt; x.equals(y);</span><br><span class="line">    System.out.println(bp1.test(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>));</span><br><span class="line"></span><br><span class="line">    BiPredicate&lt;String, String&gt; bp2 = String::equals;</span><br><span class="line">    System.out.println(bp2.test(<span class="string">&quot;c&quot;</span>,<span class="string">&quot;c&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="number">8</span></span><br><span class="line">**条件：**Lambda 参数列表中的第一个参数是方法的调用者，第二个参数是方法的参数时，才能使用 ClassName :: Method</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="StreamAPI"><a href="#StreamAPI" class="headerlink" title="StreamAPI"></a>StreamAPI</h1><p><img src="/../img/image-20220119144127483.png" alt="image-20220119144127483"></p>
<h2 id="stream流应用"><a href="#stream流应用" class="headerlink" title="stream流应用"></a>stream流应用</h2><p>请看以下博客</p>
<p><a href="https://blog.csdn.net/mu_wind/article/details/109516995">https://blog.csdn.net/mu_wind/article/details/109516995</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">list.forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<h2 id="广铁大屏获取数据时"><a href="#广铁大屏获取数据时" class="headerlink" title="广铁大屏获取数据时"></a>广铁大屏获取数据时</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">public List&lt;ResourceBO&gt; getCountLoadCabinet() &#123;</span><br><span class="line">    List&lt;ResourceBO&gt; result = LoadCabinetEnum.create();</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; list = cabinetMonitorMapper.selectCountLoadCabinet();</span><br><span class="line">    if (list.isEmpty()) &#123;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    for (ResourceBO item : result) &#123;</span><br><span class="line">        Optional&lt;Map&lt;String, Object&gt;&gt; optional = list.stream().filter(s -&gt; Convert.toInt(s.get(&quot;type&quot;)) == 1).filter(s -&gt; s.get(&quot;objectId&quot;).toString().equals(item.getId())).findFirst();</span><br><span class="line">        optional.ifPresent(stringObjectMap -&gt; item.setCount(Convert.toInt(stringObjectMap.get(&quot;totalNumber&quot;), 0)));</span><br><span class="line"></span><br><span class="line">        Optional&lt;Map&lt;String, Object&gt;&gt; optional1 = list.stream().filter(s -&gt; Convert.toInt(s.get(&quot;type&quot;)) == 0).filter(s -&gt; s.get(&quot;objectId&quot;).toString().equals(item.getId())).findFirst();</span><br><span class="line">        optional1.ifPresent(stringObjectMap -&gt; item.setProCount(Convert.toInt(stringObjectMap.get(&quot;totalNumber&quot;), 0)));</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="比较经典的例子，递归获取菜单树"><a href="#比较经典的例子，递归获取菜单树" class="headerlink" title="比较经典的例子，递归获取菜单树"></a>比较经典的例子，递归获取菜单树</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public List&lt;CategoryEntity&gt; listWithTree() &#123;</span><br><span class="line">        //1.查出所有分类</span><br><span class="line">        List&lt;CategoryEntity&gt; entities = baseMapper.selectList(null);</span><br><span class="line"></span><br><span class="line">        //2.组装成父子树形结构</span><br><span class="line">            //找到所有的1级分类，父id是0</span><br><span class="line"></span><br><span class="line">//        List&lt;CategoryEntity&gt; level1Menus = entities.stream().filter((categoryEntity) -&gt; &#123;</span><br><span class="line">//            return categoryEntity.getParentCid() == 0;</span><br><span class="line">//        &#125;).collect(Collectors.toList());</span><br><span class="line">        //只有一个参数，只有一个语句优化，参数外的括号去掉，return和分号，大括号，都去掉</span><br><span class="line">        List&lt;CategoryEntity&gt; levelMenus = entities.stream().filter( categoryEntity -&gt;</span><br><span class="line">             categoryEntity.getParentCid() == 0</span><br><span class="line">        ).map((menu)-&gt;&#123;</span><br><span class="line">            menu.setChildren(getChildrens(menu,entities));</span><br><span class="line">            return menu;</span><br><span class="line">        &#125;).sorted((menu1,menu2)-&gt;&#123;</span><br><span class="line">            return (menu1.getSort()==null?0:menu1.getSort())-(menu2.getSort()==null?0:menu2.getSort());</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        return levelMenus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> private List&lt;CategoryEntity&gt; getChildrens(CategoryEntity root,List&lt;CategoryEntity&gt; all)&#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; children = all.stream().filter(categoryEntity -&gt; &#123;</span><br><span class="line">        return categoryEntity.getParentCid() == root.getCatId();</span><br><span class="line">    &#125;).map(categoryEntity-&gt;&#123;</span><br><span class="line">        //1.找到子菜单</span><br><span class="line">        categoryEntity.setChildren(getChildrens(categoryEntity,all));</span><br><span class="line">        return categoryEntity;</span><br><span class="line">    &#125;).sorted((menu1,menu2)-&gt;&#123;</span><br><span class="line">        //2.菜单的排序</span><br><span class="line">        return (menu1.getSort()==null?0:menu1.getSort())-(menu2.getSort()==null?0:menu2.getSort());</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    return children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="流排序-由小到大"><a href="#流排序-由小到大" class="headerlink" title="流排序,由小到大"></a>流排序,由小到大</h2><p>需要有一个int排序字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">list.stream().sorted(Comparator.comparing(s-&gt;s.getOrderBy())).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">list.stream().sorted((a,b)-&gt;Integer.compare(b.getAge(),a.getAge())).collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<h2 id="流遍历list，设置字段"><a href="#流遍历list，设置字段" class="headerlink" title="流遍历list，设置字段"></a>流遍历list，设置字段</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AtomicInteger i = new AtomicInteger(0);</span><br><span class="line">list.forEach(a -&gt; a.setOrder(i.getAndIncrement()));</span><br><span class="line"></span><br><span class="line">forEach中使用的Consumer函数</span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="1-创建流"><a href="#1-创建流" class="headerlink" title="1.创建流"></a>1.创建流</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line">   * 集合流</span><br><span class="line">   *  - Collection.stream() 穿行流</span><br><span class="line">   *  - Collection.parallelStream() 并行流</span><br><span class="line">   */</span><br><span class="line">   List&lt;String&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">   Stream&lt;String&gt; stream1 = list.stream();</span><br></pre></td></tr></table></figure>

<h3 id="2-筛选-切片"><a href="#2-筛选-切片" class="headerlink" title="2.筛选 / 切片"></a>2.筛选 / 切片</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">中间操作：</span><br><span class="line"></span><br><span class="line">filter：接收 Lambda ，从流中排除某些元素</span><br><span class="line">limit：截断流，使其元素不超过给定数量</span><br><span class="line">skip(n)：跳过元素，返回一个舍弃了前n个元素的流；若流中元素不足n个，则返回一个空流；与 limit(n) 互补</span><br><span class="line">distinct：筛选，通过流所生成的 hashCode() 与 equals() 取除重复元素</span><br><span class="line"></span><br><span class="line">List&lt;Employee&gt; emps = Arrays.asList(</span><br><span class="line">				new Employee(101, &quot;Z3&quot;, 19, 9999.99),</span><br><span class="line">				new Employee(102, &quot;L4&quot;, 20, 7777.77),</span><br><span class="line">				new Employee(103, &quot;W5&quot;, 44, 6666.66),</span><br><span class="line">				new Employee(104, &quot;Tom&quot;, 44, 1111.11),</span><br><span class="line">				new Employee(105, &quot;Jerry&quot;, 60, 4444.44)</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			emps.stream()</span><br><span class="line">					.filter((x) -&gt; x.getAge() &gt; 35)</span><br><span class="line">					.limit(3) //只要前三个</span><br><span class="line">					.distinct()//删除所有属性都一样的数据</span><br><span class="line">					.skip(1)//删除第一个数据</span><br><span class="line">					.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-映射"><a href="#3-映射" class="headerlink" title="3.映射"></a>3.映射</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">map：接收 Lambda ，将元素转换为其他形式或提取信息；接受一个函数作为参数，该函数会被应用到每个元素上，并将其映射成一个新的元素</span><br><span class="line">flatMap：接收一个函数作为参数，将流中每一个值都换成另一个流，然后把所有流重新连接成一个流</span><br><span class="line">map：</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test02()&#123;</span><br><span class="line">    List&lt;String&gt; list = Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;);</span><br><span class="line">    list.stream()</span><br><span class="line">        .map((str) -&gt; str.toUpperCase())</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-排序"><a href="#4-排序" class="headerlink" title="4.排序"></a>4.排序</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sorted()：自然排序</span><br><span class="line">sorted(Comparator c)：定制排序</span><br><span class="line">Comparable：自然排序</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test04()&#123;</span><br><span class="line">    List&lt;Integer&gt; list = Arrays.asList(1,2,3,4,5);</span><br><span class="line">    list.stream()</span><br><span class="line">        .sorted() //comparaTo()</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Comparator：定制排序</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test05()&#123;</span><br><span class="line">    emps.stream()</span><br><span class="line">        .sorted((e1, e2) -&gt; &#123; //compara()</span><br><span class="line">            if (e1.getAge().equals(e2.getAge()))&#123;</span><br><span class="line">                return e1.getName().compareTo(e2.getName());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return e1.getAge().compareTo(e2.getAge());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-查找-匹配"><a href="#5-查找-匹配" class="headerlink" title="5.查找 / 匹配"></a>5.查找 / 匹配</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">终止操作：</span><br><span class="line">allMatch：检查是否匹配所有元素</span><br><span class="line">anyMatch：检查是否至少匹配一个元素</span><br><span class="line">noneMatch：检查是否没有匹配所有元素</span><br><span class="line">findFirst：返回第一个元素</span><br><span class="line">findAny：返回当前流中的任意元素</span><br><span class="line">count：返回流中元素的总个数</span><br><span class="line">max：返回流中最大值</span><br><span class="line">min：返回流中最小值</span><br><span class="line">public enum Status &#123;</span><br><span class="line">    FREE, BUSY, VOCATION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test01()&#123;</span><br><span class="line">    List&lt;Status&gt; list = Arrays.asList(Status.FREE, Status.BUSY, Status.VOCATION);</span><br><span class="line"></span><br><span class="line">    boolean flag1 = list.stream()</span><br><span class="line">        .allMatch((s) -&gt; s.equals(Status.BUSY));</span><br><span class="line">    System.out.println(flag1);</span><br><span class="line"></span><br><span class="line">    boolean flag2 = list.stream()</span><br><span class="line">        .anyMatch((s) -&gt; s.equals(Status.BUSY));</span><br><span class="line">    System.out.println(flag2);</span><br><span class="line"></span><br><span class="line">    boolean flag3 = list.stream()</span><br><span class="line">        .noneMatch((s) -&gt; s.equals(Status.BUSY));</span><br><span class="line">    System.out.println(flag3);</span><br><span class="line"></span><br><span class="line">    // 避免空指针异常</span><br><span class="line">    Optional&lt;Status&gt; op1 = list.stream()</span><br><span class="line">        .findFirst();</span><br><span class="line">    // 如果Optional为空 找一个替代的对象</span><br><span class="line">    Status s1 = op1.orElse(Status.BUSY);</span><br><span class="line">    System.out.println(s1);</span><br><span class="line"></span><br><span class="line">    Optional&lt;Status&gt; op2 = list.stream()</span><br><span class="line">        .findAny();</span><br><span class="line">    System.out.println(op2);</span><br><span class="line"></span><br><span class="line">    long count = list.stream()</span><br><span class="line">        .count();</span><br><span class="line">    System.out.println(count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-归约-收集"><a href="#6-归约-收集" class="headerlink" title="6.归约 / 收集"></a>6.归约 / 收集</h3><p>归约：reduce(T identity, BinaryOperator) / reduce(BinaryOperator) 可以将流中的数据反复结合起来，得到一个值<br>收集：collect 将流转换成其他形式；接收一个 Collector 接口的实现，用于给流中元素做汇总的方法</p>
<h4 id="reduce："><a href="#reduce：" class="headerlink" title="reduce："></a>reduce：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Java：</span></span><br><span class="line"><span class="comment">*  - reduce：需提供默认值（初始值）</span></span><br><span class="line"><span class="comment">* Kotlin：</span></span><br><span class="line"><span class="comment">*  - fold：不需要默认值（初始值）</span></span><br><span class="line"><span class="comment">*  - reduce：需提供默认值（初始值）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//把这10个数加起来加上默认值</span></span><br><span class="line">    List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>);</span><br><span class="line">    Integer integer = list.stream()</span><br><span class="line">        .reduce(<span class="number">0</span>, (x, y) -&gt; x + y);</span><br><span class="line">        <span class="comment">//.reduce(Integer::sum);Optional&lt;Integer&gt;</span></span><br><span class="line">    System.out.println(integer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="collect："><a href="#collect：" class="headerlink" title="collect："></a>collect：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;Employee&gt; emps = Arrays.asList(</span><br><span class="line">				new Employee(101, &quot;Z3&quot;, 24, 9999.99),</span><br><span class="line">				new Employee(102, &quot;L4&quot;, 20, 7777.77),</span><br><span class="line">				new Employee(103, &quot;W5&quot;, 35, 6666.66),</span><br><span class="line">				new Employee(104, &quot;Tom&quot;, 44, 1111.11),</span><br><span class="line">				new Employee(105, &quot;Jerry&quot;, 60, 4444.44)</span><br><span class="line">		);</span><br><span class="line">		</span><br><span class="line">		//放入List</span><br><span class="line">		List&lt;String&gt; list = emps.stream()</span><br><span class="line">				.map(Employee::getName)</span><br><span class="line">				.collect(Collectors.toList());</span><br><span class="line">		list.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">		//放入Set</span><br><span class="line">		Set&lt;String&gt; set = emps.stream()</span><br><span class="line">				.map(Employee::getName)</span><br><span class="line">				.collect(Collectors.toSet());</span><br><span class="line">		set.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">		//放入LinkedHashSet</span><br><span class="line">		LinkedHashSet&lt;String&gt; linkedHashSet = emps.stream()</span><br><span class="line">				.map(Employee::getName)</span><br><span class="line">				.collect(Collectors.toCollection(LinkedHashSet::new));</span><br><span class="line">		linkedHashSet.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		//总数</span><br><span class="line">		Long count = emps.stream()</span><br><span class="line">				.collect(Collectors.counting());</span><br><span class="line">		System.out.println(count);</span><br><span class="line"></span><br><span class="line">		//平均值</span><br><span class="line">		Double avg = emps.stream()</span><br><span class="line">				.collect(Collectors.averagingDouble(Employee::getSalary));</span><br><span class="line">		System.out.println(avg);</span><br><span class="line"></span><br><span class="line">		//总和</span><br><span class="line">		Double sum = emps.stream()</span><br><span class="line">				.collect(Collectors.summingDouble(Employee::getSalary));</span><br><span class="line">		System.out.println(sum);</span><br><span class="line"></span><br><span class="line">		//最大值</span><br><span class="line">		Optional&lt;Employee&gt; max = emps.stream()</span><br><span class="line">				.collect(Collectors.maxBy((e1, e2) -&gt; Double.compare(e1.getSalary(), e2.getSalary())));</span><br><span class="line">		System.out.println(max.get());</span><br><span class="line"></span><br><span class="line">		//最小值</span><br><span class="line">		Optional&lt;Double&gt; min = emps.stream()</span><br><span class="line">				.map(Employee::getSalary)</span><br><span class="line">				.collect(Collectors.minBy(Double::compare));</span><br><span class="line">		System.out.println(min.get());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">**定义：**Optional 类 (java.util.Optional) 是一个容器类，代表一个值存在或不存在，原来用 null 表示一个值不存在，现在用 Optional 可以更好的表达这个概念；并且可以避免空指针异常</span><br><span class="line"></span><br><span class="line">常用方法：</span><br><span class="line"></span><br><span class="line">Optional.of(T t)：创建一个 Optional 实例</span><br><span class="line">Optional.empty(T t)：创建一个空的 Optional 实例</span><br><span class="line">Optional.ofNullable(T t)：若 t 不为 null，创建 Optional 实例，否则空实例</span><br><span class="line">isPresent()：判断是否包含某值</span><br><span class="line">orElse(T t)：如果调用对象包含值，返回该值，否则返回 t</span><br><span class="line">orElseGet(Supplier s)：如果调用对象包含值，返回该值，否则返回 s 获取的值</span><br><span class="line">map(Function f)：如果有值对其处理，并返回处理后的 Optional，否则返回 Optional.empty()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Optional.of(T t)：</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test01()&#123;</span><br><span class="line">    Optional&lt;Employee&gt; op = Optional.of(new Employee());</span><br><span class="line">    Employee employee = op.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Optional.empty(T t)：</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test02()&#123;</span><br><span class="line">    Optional&lt;Employee&gt; op = Optional.empty();</span><br><span class="line">    Employee employee = op.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Optional.ofNullable(T t)：</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test03()&#123;</span><br><span class="line">    Optional&lt;Employee&gt; op = Optional.ofNullable(new Employee());</span><br><span class="line">    Employee employee = op.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">isPresent()：</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test03()&#123;</span><br><span class="line">    Optional&lt;Employee&gt; op = Optional.ofNullable(new Employee());</span><br><span class="line">    if (op.isPresent()) &#123;</span><br><span class="line">        Employee employee = op.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="把list每个元素以逗号拼接为String"><a href="#把list每个元素以逗号拼接为String" class="headerlink" title="把list每个元素以逗号拼接为String"></a>把list每个元素以逗号拼接为String</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    List&lt;String&gt; list = Arrays.asList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;);</span><br><span class="line">    String result=  list.stream().collect(Collectors.joining(&quot;,&quot;));</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    //结果A，B，C，D</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>stream流</tag>
      </tags>
  </entry>
  <entry>
    <title>linux单机与集群</title>
    <url>/2021/11/30/linux%E5%8D%95%E6%9C%BA%E4%B8%8E%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>1.宁杭出差，发现同事安装软件比较顺利，自己也没有完整的搭建过一套，所以决心安装单机和集群</p>
<p>2.用的虚拟机，centos7，最小安装，所以需要一些前置安装</p>
<h1 id="前置安装"><a href="#前置安装" class="headerlink" title="前置安装"></a>前置安装</h1><h2 id="1-ifconfig命令"><a href="#1-ifconfig命令" class="headerlink" title="1.ifconfig命令"></a>1.ifconfig命令</h2><p>yum install net-tools.x86_64</p>
<h2 id="2-vim"><a href="#2-vim" class="headerlink" title="2.vim"></a>2.vim</h2><p>yum -y install vim*</p>
<h2 id="3-修改静态IP"><a href="#3-修改静态IP" class="headerlink" title="3.修改静态IP"></a>3.修改静态IP</h2><p>cd /etc/sysconfig/network-scripts</p>
<p>找ifcfg-ens？？</p>
<p>vim ifcfg-ens??</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IPADDR=&quot;192.168.25.160&quot; # 改成需要的ip，注意网段</span><br><span class="line">GATEWAY=&quot;192.168.25.2&quot; # 网关，可以先查下网关</span><br><span class="line">NETMASK=&quot;255.255.255.0&quot; # 不用动</span><br><span class="line">DNS1=&quot;114.114.114.114&quot; # dns自己配置能用的</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211209204032394.png" alt="image-20211209204032394"></p>
<p>重启网络</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service network restart</span><br></pre></td></tr></table></figure>

<p>如果报错Failed to start LSB: Bring up/down networking RTNETLINK answers: File exists</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">关闭 NetworkManger 服务， systemct stop NetworkManager，并且禁止开机启动 systemctl disable NetworkManager</span><br><span class="line">systemctl stop NetworkManager &amp;&amp; systemctl restart network.service</span><br></pre></td></tr></table></figure>

<h2 id="4-安装gcc与g"><a href="#4-安装gcc与g" class="headerlink" title="4.安装gcc与g++"></a>4.安装gcc与g++</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ autoconf pcre pcre-devel make automake</span><br><span class="line">yum -y install wget httpd-tools vim</span><br></pre></td></tr></table></figure>

<p>验证</p>
<p>gcc -v</p>
<p>g++ -v </p>
<p>如果yum不下来，找到依赖包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">移动整个文件夹1，装gcc，gcc -v 如果有 跳过</span><br><span class="line">rpm -Uvh *.rpm --nodeps --force</span><br><span class="line">移动整个文件夹2，装gcc-c++ g++ -v 如果有 跳过</span><br><span class="line">rpm -Uvh *.rpm --nodeps --force</span><br></pre></td></tr></table></figure>

<h1 id="单机"><a href="#单机" class="headerlink" title="单机"></a>单机</h1><h2 id="1-JDK"><a href="#1-JDK" class="headerlink" title="1.JDK"></a>1.JDK</h2><p>1.卸载CentOS自带的openJDK（自己配置不生效的话再卸载）</p>
<p>查看是否已安装<br>rpm -qa|grep java<br>卸载<br>rpm -e –nodeps   jdk-xxx</p>
<p>2.把jdk的包移动到/usr/local/java</p>
<p>cd /usr/local</p>
<p>mkdir java</p>
<p>cd java</p>
<p>tar  -zxvf jdk-8u131-linux-x64.tar.gz</p>
<p>3.环境变量<br>vim /etc/profile<br>在后面追加</p>
<p>export JAVA_HOME=/usr/local/java/jdk1.8.0_131<br>export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar<br>export PATH=$PATH:$JAVA_HOME/bin</p>
<p>4.使配置文件生效<br>source /etc/profile</p>
<p>5.验证是否安装完成<br>java -version</p>
<h2 id="2-redis"><a href="#2-redis" class="headerlink" title="2.redis"></a>2.redis</h2><p>cd /opt</p>
<p>mkdir redis</p>
<p>cd redis</p>
<p>把redis-4.0.10.tar.gz移动到当前目录解压</p>
<p>tar -zvxf redis-4.0.10.tar.gz</p>
<p>cd redis-4.0.10</p>
<p>make install PREFIX=/opt/redis/redis-4.0.10</p>
<p>4.开启6379tcp端口<br>firewall-cmd –zone=public –add-port=6379/tcp –permanent</p>
<p>5.重启防火墙验证<br>systemctl reload firewalld<br>firewall-cmd –list-ports</p>
<p>3.启动<br>cd src ./redis-server</p>
<p>下图成功</p>
<p><img src="/../img/image-20211210153157348.png" alt="image-20211210153157348"></p>
<h3 id="修改redis配置文件"><a href="#修改redis配置文件" class="headerlink" title="修改redis配置文件"></a>修改redis配置文件</h3><p>在这个路径下 /opt/redis/redis-4.0.10</p>
<p>vim redis.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#bind 127.0.0.1 //允许远程连接</span><br><span class="line">远程连接，不用绑定ip</span><br><span class="line">protected-mode no</span><br><span class="line">持久化</span><br><span class="line">appendonly yes</span><br><span class="line">后台启动</span><br><span class="line">daemonize yes</span><br></pre></td></tr></table></figure>

<p>cd src</p>
<p>./redis-server ../redis.conf</p>
<p>ps -ef|grep redis查看是否启动</p>
<p>7.redis命令行带密码</p>
<p>./redis-cli -p 6379</p>
<p><img src="/../img/image-20211210154959902.png" alt="image-20211210154959902"></p>
<p>这个图是没有密码，设置密码123456</p>
<p>config set requirepass 12345</p>
<p>exit退出</p>
<p>./redis-cli -p 6379 -a 123456<br>也可以进去后输入auth 123456完成认证</p>
<h2 id="3-nacos"><a href="#3-nacos" class="headerlink" title="3.nacos"></a>3.nacos</h2><p>cd /opt</p>
<p>mkdir nacos</p>
<p>cd nacos</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">把下载好的nacos安装包解压放到该目录</span><br><span class="line">tar xvfz nacos-server-2.0.1.tar.gz</span><br></pre></td></tr></table></figure>



<h3 id="配置MySQL-数据库"><a href="#配置MySQL-数据库" class="headerlink" title="配置MySQL 数据库"></a>配置MySQL 数据库</h3><h4 id="3-1-初始化数据库"><a href="#3-1-初始化数据库" class="headerlink" title="3.1 初始化数据库"></a><strong>3.1 初始化数据库</strong></h4><p>初始化数据库，导入nacos解压目录下conf/nacos-mysql.sql 文件</p>
<p><img src="/../img/wps1.jpg" alt="img"> </p>
<p>cd nacos/conf/</p>
<h4 id="3-2-配置数据库"><a href="#3-2-配置数据库" class="headerlink" title="3.2 配置数据库"></a><strong>3.2</strong> 配置数据库</h4><p>新建nacos_config</p>
<p><img src="/../img/image-20211212144106526.png" alt="image-20211212144106526"></p>
<p><img src="/../img/wps2.jpg" alt="img"></p>
<p>执行sql脚本</p>
<p><img src="/../img/image-20211212144134857.png" alt="image-20211212144134857"></p>
<h5 id="修改conf-application-properties-增加-mysql-数据源配置"><a href="#修改conf-application-properties-增加-mysql-数据源配置" class="headerlink" title="修改conf/application.properties,增加 mysql 数据源配置"></a>修改conf/application.properties,增加 mysql 数据源配置</h5><p>输入指令：vim /opt/nacos/nacos/conf/application.properties</p>
<p>按住shift+g, 在文件末尾添加： 注意自己的ip地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring.datasource.platform=mysql</span><br><span class="line"></span><br><span class="line">db.num=1</span><br><span class="line"></span><br><span class="line">db.url.0=jdbc:mysql://自己ip:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=10000&amp;socketTimeout=30000&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br><span class="line"></span><br><span class="line">db.user=root</span><br><span class="line"></span><br><span class="line">db.password=Boco.123</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动**"></a>启动**</h3><ol>
<li>进入nacos目录bin下：cd /opt/nacos/nacos/bin/</li>
</ol>
<p>启动命令：sh startup.sh -m standalone</p>
<p>查看运行日志： tail -500f /opt/nacos/nacos/logs/start.out</p>
<p><img src="/../img/image-20211212145000748.png" alt="image-20211212145000748"></p>
<p>2．界面控制台</p>
<p>注意打开8848端口</p>
<p>firewall-cmd –zone=public –add-port=8848/tcp –permanent</p>
<p>systemctl reload firewalld</p>
<p>启动完毕后。登录到界面控制台（用户名密码默认都是nacos）<a href="http://ip:8848/nacos">http://ip:8848/nacos</a></p>
<h3 id="Nacos关闭"><a href="#Nacos关闭" class="headerlink" title="Nacos关闭"></a>Nacos关闭</h3><p>进入 nacos/bin/目录下运行:  ./shutdown.sh </p>
<h2 id="4-mysql"><a href="#4-mysql" class="headerlink" title="4.mysql"></a>4.mysql</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.先查看是否已安装</span><br><span class="line">yum list installed | grep mysql</span><br><span class="line">有的话就卸载：yum remove mysql mysql-*</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/mysql/server </span><br><span class="line">mkdir -p /opt/mysql/client</span><br><span class="line">cd /opt/mysql/server </span><br><span class="line">cd /opt/mysql/client</span><br><span class="line">server.rpm文件移动到server</span><br><span class="line">client.rpm文件移动到client</span><br><span class="line"></span><br><span class="line">2.安装server</span><br><span class="line">rpm -ivh mysql-community-server-5.7.29-1.el6.x86_64.rpm --force --nodeps</span><br><span class="line">3.安装client</span><br><span class="line">rpm -ivh mysql-community-client-5.7.29-1.el6.x86_64.rpm --force --nodeps</span><br><span class="line"></span><br><span class="line">### errmsg.sys此步一定要在第4步之前做</span><br><span class="line"></span><br><span class="line">把errmsg.sys移动到 cd /usr/share/mysql/目录下</span><br><span class="line"></span><br><span class="line">修改配置文件my.cnf,根据情况定</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">如果想忽略表名大小写</span><br><span class="line">在[mysqld]节点下添加</span><br><span class="line">lower_case_table_names=1</span><br><span class="line">重启mysql</span><br><span class="line"></span><br><span class="line">4.启动mysql</span><br><span class="line">service mysqld start</span><br><span class="line">5.查看默认密码</span><br><span class="line">grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br><span class="line"></span><br><span class="line">6.复制默认密码，进入mysql</span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">7.修改密码</span><br><span class="line">set global validate_password_policy=LOW;</span><br><span class="line">set global validate_password_length=8; #8为密码的长度</span><br><span class="line">alter user root@localhost identified by &#x27;Boco.123&#x27;;</span><br><span class="line"></span><br><span class="line">8.使用新密码进入</span><br><span class="line">quit</span><br><span class="line">mysql -uroot -pBoco.123</span><br><span class="line"></span><br><span class="line">9.开启允许远程访问</span><br><span class="line">9.1 使用mysql库</span><br><span class="line">use mysql;</span><br><span class="line">9.2 查看默认情况，通常应该都是只允许localhost访问</span><br><span class="line">select User,authentication_string,Host from user;</span><br><span class="line">9.3 允许远程访问</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;Boco.123&#x27;;</span><br><span class="line">9.4 刷新权限</span><br><span class="line">flush privileges;</span><br><span class="line">9.5 检测是否成功，这步报错也没关系，没啥用</span><br><span class="line">select User,authentication_string,Host from user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10 开放3306端口</span><br><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">11 重启防火墙</span><br><span class="line">systemctl reload firewalld</span><br><span class="line">12 验证</span><br><span class="line">firewall-cmd --list-ports</span><br></pre></td></tr></table></figure>

<p>9.5 检测是否成功</p>
<p><img src="/../img/image-20211211210627808.png" alt="image-20211211210627808"></p>
<p>第6步：这个是默认密码</p>
<p><img src="/../img/image-20211210171746098.png" alt="image-20211210171746098"></p>
<h3 id="查看mysql服务启没启动"><a href="#查看mysql服务启没启动" class="headerlink" title="查看mysql服务启没启动"></a>查看mysql服务启没启动</h3><p>systemctl status mysqld.service</p>
<h3 id="启动mysql"><a href="#启动mysql" class="headerlink" title="启动mysql"></a>启动mysql</h3><p>service mysqld start</p>
<p>如果报错</p>
<p><img src="/../img/image-20211211181158347.png" alt="image-20211211181158347"></p>
<p>vim /var/log/mysqld.log 查看具体信息</p>
<p>rm -rf /var/log/mysqld.log</p>
<h3 id="停止mysql"><a href="#停止mysql" class="headerlink" title="停止mysql"></a>停止mysql</h3><p>service mysqld stop</p>
<p><img src="/../img/image-20211212145805338.png" alt="image-20211212145805338"></p>
<h3 id="重启mysql"><a href="#重启mysql" class="headerlink" title="重启mysql"></a>重启mysql</h3><p>service mysqld start</p>
<h3 id="没有解决就卸载重装"><a href="#没有解决就卸载重装" class="headerlink" title="没有解决就卸载重装"></a>没有解决就卸载重装</h3><h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">卸载旧版本的mysql：yum remove mysql mysql-*</span><br><span class="line"></span><br><span class="line">检查有没有卸载干净：yum list installed | grep mysql</span><br></pre></td></tr></table></figure>

<h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><p><strong>一、使用以下命令查看当前安装mysql情况，查找以前是否装有mysql</strong></p>
<p>rpm -qa|grep -i mysql </p>
<p><strong>二、停止mysql服务、删除之前安装的mysql</strong></p>
<p>　　删除命令：**<code>rpm -e –nodeps 包名</code>**</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">　　rpm -ev MySQL-client-5.5.25a-1.rhel5</span><br><span class="line">　　rpm -ev MySQL-server-5.5.25a-1.rhel5</span><br></pre></td></tr></table></figure>

<p>　　如果提示依赖包错误，则使用以下命令尝试：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -ev MySQL-client-5.5.25a-1.rhel5 --nodeps</span><br></pre></td></tr></table></figure>

<p>　　如果提示错误：<code>error: %preun(xxxxxx) scriptlet failed, exit status 1</code></p>
<p>　　则用以下命令尝试：</p>
<p><code>rpm -e --noscripts MySQL-client-``5.5``.25a-``1``.rhel5</code></p>
<p><strong>三、查找之前老版本mysql的目录、并且删除老版本mysql的文件和库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find / -name mysql</span><br></pre></td></tr></table></figure>

<p> 查找结果如下：  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/var/lib/mysql</span><br><span class="line">/var/lib/mysql/mysql</span><br><span class="line">/usr/lib64/mysql</span><br><span class="line">/usr/share/mysql</span><br></pre></td></tr></table></figure>

<p>删除对应的mysql目录</p>
<p>rm -rf /var/lib/mysql<br>rm -rf /var/lib/mysql/mysql<br>rm -rf /usr/lib64/mysql<br>rm -rf /usr/share/mysql</p>
<p>具体的步骤如图：查找目录并删除</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWFnZXMyMDE4LmNuYmxvZ3MuY29tL2Jsb2cvMTIxMTM1NS8yMDE4MDYvMTIxMTM1NS0yMDE4MDYyOTIxMDU1OTMyMy0xMTM1MjA4MDI1LnBuZw?x-oss-process=image/format,png" alt="img"></p>
<p><strong>注意：</strong>卸载后/etc/my.cnf不会删除，需要进行手工删除</p>
<p>rm -rf /etc/my.cnf </p>
<p><strong>四、再次查找机器是否安装mysql</strong></p>
<p>rpm -qa|grep -i mysql</p>
<p> 无结果，说明已经卸载彻底，接下来直接安装mysql即可。</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p><img src="/../img/image-20211212143624575.png" alt="image-20211212143624575"></p>
<p>vim /var/log/mysqld.log 查看具体信息以后发现</p>
<p><img src="/../img/image-20211212143639947.png" alt="image-20211212143639947"></p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>mkdir -p /var/run/mysqld</p>
<p>chown mysql.mysql /var/run/mysqld/ </p>
<p>systemctl start mysqld</p>
<h2 id="5-zk-2181"><a href="#5-zk-2181" class="headerlink" title="5.zk-2181"></a>5.zk-2181</h2><p>cd /opt</p>
<p>mkdir zookeeper</p>
<p>cd zookeeper</p>
<p>tar  -zxvf zookeeper-3.4.9.tar.gz</p>
<p>cd zookeeper-3.4.9</p>
<p>cd conf/</p>
<p>入conf目录下，将zoo_sample.cfg，名字为zoo.cfg</p>
<p>mv zoo_sample.cfg zoo.cfg</p>
<h3 id="vim-zoo-cfg"><a href="#vim-zoo-cfg" class="headerlink" title="vim zoo.cfg"></a>vim zoo.cfg</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/opt/zookeeper/zookeeper-3.4.9/data</span><br><span class="line">datalogDir=/opt/zookeeper/zookeeper-3.4.9/logs</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<p>mkdir /opt/zookeeper/zookeeper-3.4.9/data<br>mkdir /opt/zookeeper/zookeeper-3.4.9/logs</p>
<h3 id="启动bin目录下"><a href="#启动bin目录下" class="headerlink" title="启动bin目录下"></a>启动bin目录下</h3><p>cd /opt/zookeeper/zookeeper-3.4.9/bin/</p>
<p>./zkServer.sh start<br>./zkServer.sh stop<br>./zkServer.sh restart<br>./zkServer.sh status</p>
<p>可以看到status是standlone单机</p>
<p><img src="/../img/image-20211210162347839.png" alt="image-20211210162347839"></p>
<h2 id="6-kafka-9092-D-kafka-kafka-txt"><a href="#6-kafka-9092-D-kafka-kafka-txt" class="headerlink" title="6.kafka-9092(D:\kafka\kafka.txt)"></a>6.kafka-9092(D:\kafka\kafka.txt)</h2><p>cd /opt</p>
<p>mkdir kafka</p>
<p>cd kafka</p>
<p>1.解压到/opt/kafka使用kafka_2.12-0.10.2.1.tgz这个包</p>
<p>tar -vxzf kafka_2.12-0.10.2.1.tgz</p>
<p>2.开启9092tcp端口<br>firewall-cmd –zone=public –add-port=9092/tcp –permanent</p>
<p>systemctl reload firewalld</p>
<p>cd /opt/kafka/kafka_2.12-0.10.2.1/config</p>
<h3 id="vim-server-properties"><a href="#vim-server-properties" class="headerlink" title="vim server.properties"></a>vim server.properties</h3><p><img src="/../img/image-20211022175625401-1639125434743.png" alt="image-20211022175625401"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#broler全局唯一编号，不能重复</span><br><span class="line">broker.id=0</span><br><span class="line">#打开删除topic功能</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">#访问kafka的地址</span><br><span class="line">listeners=PLAINTEXT://ip:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://ip:9092</span><br><span class="line">#kafka运行日志存放的路径</span><br><span class="line">log.dirs=/opt/kafka/logs</span><br><span class="line">#配置连接Zookeeper</span><br><span class="line">zookeeper.connect=192.168.214.130:2181</span><br><span class="line">#更改默认过期时间，可以不设置，默认7天168h</span><br><span class="line">log.retention.hours=24</span><br></pre></td></tr></table></figure>

<p>如果想修改kafka端口号</p>
<p>添加port即可，默认是没有的</p>
<p><img src="/../img/image-20211215194509842.png" alt="image-20211215194509842"></p>
<p>mkdir /opt/kafka/logs</p>
<p>启动kafka bin目录下</p>
<p>cd /opt/kafka/kafka_2.12-0.10.2.1/bin</p>
<p>sh kafka-server-start.sh -daemon ../config/server.properties</p>
<p>停止</p>
<p>kafka-server-stop.sh stop 或者</p>
<p>sh kafka-server-stop.sh</p>
<p>#查看zookeeper<br>ps -ef|grep zookeeper</p>
<p>验证Kafka是否启动成功：</p>
<p>输入jps命令回车查看，有Kafka进程，说明启动成功</p>
<p><img src="/../img/image-20211210164417297.png" alt="image-20211210164417297"></p>
<p>注意kafka是在bin目录的外层，不是内层</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.查看主题列表</span><br><span class="line">bin/kafka-topics.sh --zookeeper localhost:2181 --list</span><br><span class="line"></span><br><span class="line">2.创建topic  test</span><br><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test</span><br><span class="line"></span><br><span class="line">5.启动生产者</span><br><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test</span><br><span class="line"></span><br><span class="line">6.启动消费者，新窗口</span><br><span class="line">./bin/kafka-console-consumer.sh --zookeeper localhost:2181 -topic test --from-beginning</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发送</p>
<p><img src="/../img/image-20211210165030872.png" alt="image-20211210165030872"></p>
<p>新窗口接受</p>
<p><img src="/../img/image-20211210165045375.png" alt="image-20211210165045375"></p>
<p>QuorumPeerMain-zookeeper</p>
<p>Kafka-kafka</p>
<p><img src="/../img/image-20211210165135500.png" alt="image-20211210165135500"></p>
<h2 id="7-nginx"><a href="#7-nginx" class="headerlink" title="7.nginx"></a>7.nginx</h2><p>mkdir -p /usr/local/nginx</p>
<p>cd /usr/local/nginx</p>
<p>把3下面的所有文件移动到/usr/local/nginx下</p>
<p>把nginx的tar.gz包也移动到/usr/local/nginx下</p>
<p>解压并安装pcre<br>cd /usr/local/nginx<br>tar -zxvf pcre-8.37.tar.gz<br>cd /usr/local/nginx/pcre-8.37<br>./configure<br>make<br>make install</p>
<p>解压并安装zlib<br>cd /usr/local/nginx<br>tar -zxvf zlib-1.2.11.tar.gz<br>cd /usr/local/nginx/zlib-1.2.11<br>./configure<br>make<br>make install</p>
<p>解压并安装openssl（需要perl5依赖）<br>cd /usr/local/nginx<br>tar -zxvf openssl-1.1.0i.tar.gz<br>cd /usr/local/nginx/openssl-1.1.0i<br>./config<br>make<br>make install</p>
<p>编译完成后，使用 openssl version 来查看一下当前 openssl 版本号时<br>echo “/usr/local/lib64/“ &gt;&gt; /etc/ld.so.conf<br>ldconfig<br>再次使用 openssl version 验证版本就可以了</p>
<p>解压并安装nginx<br>cd /usr/local/nginx<br>tar -zxvf nginx-1.18.0.tar.gz<br>cd /usr/local/nginx/nginx-1.18.0<br>./configure –prefix=/usr/local/nginx –with-http_ssl_module –with-pcre=/usr/local/nginx/pcre-8.37 –with-zlib=/usr/local/nginx/zlib-1.2.11 –with-openssl=/usr/local/nginx/openssl-1.1.0i</p>
<p>make<br>make install</p>
<p>最后开放指定端口</p>
<p>开放指定端口<br>查看80端口是否开启<br>firewall-cmd –query-port=80/tcp</p>
<p>如果没开启，开启80端口<br>firewall-cmd –zone=public –add-port=80/tcp –permanent</p>
<p>最后刷新配置：systemctl reload firewalld</p>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><p>cd /usr/local/nginx/sbin</p>
<p>./nginx</p>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p><strong>ps -ef | grep nginx</strong></p>
<p><img src="/../img/image-20211212152819121.png" alt="image-20211212152819121"></p>
<p>或者</p>
<p><strong>netstat -anp | grep :80</strong>命令来通过占用端口判断Nginx是否启动</p>
<h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><p>./nginx -s reload</p>
<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><p>./nginx -s stop</p>
<h3 id="后端收不到token"><a href="#后端收不到token" class="headerlink" title="后端收不到token"></a>后端收不到token</h3><p>原因：前端header中加token的时候字段为<code>sso_token</code>，但是nginx默认带下划线的字段他不转发，所以要手动开启<code>underscores_in_headers on;</code></p>
<p><code>nginx.conf</code>添加<code>underscores_in_headers on;</code>即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    # 加上这个，nginx代理的时候就会带token了</span><br><span class="line">    underscores_in_headers on;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-nexus私服"><a href="#8-nexus私服" class="headerlink" title="8.nexus私服"></a>8.nexus私服</h2><h3 id="3版本，可能有问题，未解决"><a href="#3版本，可能有问题，未解决" class="headerlink" title="3版本，可能有问题，未解决"></a>3版本，可能有问题，未解决</h3><p>上传包到</p>
<p>mkdir /opt/nexus</p>
<p>cd /opt/nexus</p>
<p>tar -zxvf nexus-3.19.1-01-unix.tar.gz</p>
<h4 id="配置环境变量和端口号"><a href="#配置环境变量和端口号" class="headerlink" title="配置环境变量和端口号"></a>配置环境变量和端口号</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export MAVEN_HOME=/opt/nexus/nexus<span class="literal">-3</span>.<span class="number">19.1</span><span class="literal">-01</span>/</span><br><span class="line">export PATH=<span class="variable">$PATH:</span><span class="variable">$MAVEN_HOME</span>/bin</span><br><span class="line">export RUN_AS_USER=root</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h4 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h4><p>进到bin目录下 执行命令</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/nexus/nexus<span class="literal">-3</span>.<span class="number">19.1</span><span class="literal">-01</span>/bin</span><br><span class="line"></span><br><span class="line">./nexus run &amp;</span><br><span class="line">./nexus <span class="built_in">start</span></span><br><span class="line">./nexus restart</span><br><span class="line">./nexus stop</span><br></pre></td></tr></table></figure>

<p>成功截图</p>
<p><img src="/../img/image-20220101195653841.png" alt="image-20220101195653841"></p>
<h4 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h4><p>cd /opt/nexus/sonatype-work/nexus3</p>
<p>下有个admin.password</p>
<p>vim 看一下，这就是初始密码</p>
<p>然后输入会让你重置密码</p>
<p>最终为admin/admin123</p>
<h4 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h4><p>cd /opt/nexus/sonatype-work/nexus3/log/</p>
<p>tail -2000f nexus.log</p>
<h3 id="2版本"><a href="#2版本" class="headerlink" title="2版本"></a>2版本</h3><p>mkdir -p /usr/local/nexus</p>
<p>cd /usr/local/nexus</p>
<p>tar -zxvf nexus-2.14.5-02-bundle.tar.gz</p>
<h4 id="配置文件nexus-properties"><a href="#配置文件nexus-properties" class="headerlink" title="配置文件nexus.properties"></a>配置文件nexus.properties</h4><p>修改端口在这里改</p>
<p>vim /usr/local/nexus/nexus-2.14.5-02/conf/nexus.properties</p>
<h4 id="修改使用用户账号"><a href="#修改使用用户账号" class="headerlink" title="修改使用用户账号"></a>修改使用用户账号</h4><p>vim bin/nexus</p>
<p>#将RUN_AS_USER= 注解放开，并改成”root”</p>
<p><img src="/../img/image-20220101210353171.png" alt="image-20220101210353171"></p>
<h4 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h4><p>进到bin目录下 执行命令</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/nexus/nexus<span class="literal">-2</span>.<span class="number">14.5</span><span class="literal">-02</span>/bin</span><br><span class="line"></span><br><span class="line">./nexus <span class="built_in">start</span></span><br><span class="line">./nexus restart</span><br><span class="line">./nexus stop</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认账号：</span><br><span class="line">admin/admin123</span><br><span class="line">deployment/deployment123</span><br></pre></td></tr></table></figure>

<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><p>tail -2000f /usr/local/nexus/nexus-2.14.5-02/logs/wrapper.log</p>
<h4 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h4><p><a href="http://192.168.214.130:8081/nexus/#welcome">http://192.168.214.130:8081/nexus/#welcome</a></p>
<h4 id="修改中央仓库镜像为阿里云"><a href="#修改中央仓库镜像为阿里云" class="headerlink" title="修改中央仓库镜像为阿里云"></a>修改中央仓库镜像为阿里云</h4><p><img src="/../img/image-20220101212006777.png" alt="image-20220101212006777"></p>
<p><img src="/../img/image-20220101212111179.png" alt="image-20220101212111179"></p>
<p>阿里云镜像：<a href="http://maven.aliyun.com/nexus/content/groups/public/">http://maven.aliyun.com/nexus/content/groups/public/</a></p>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><h2 id="1-redis集群必须6个节点"><a href="#1-redis集群必须6个节点" class="headerlink" title="1.redis集群必须6个节点"></a>1.redis集群必须6个节点</h2><p>注意redis与nginx都需要openssl，安装一个即可</p>
<h3 id="Redis集群依赖安装"><a href="#Redis集群依赖安装" class="headerlink" title="Redis集群依赖安装"></a>Redis集群依赖安装</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">安装Ruby和gem安装和修改</span><br><span class="line">1、Ruby安装</span><br><span class="line">检查ruby的版本</span><br><span class="line">ruby -v </span><br><span class="line">本次安装ruby-2.4.2版本,将下载好的软件上传到服务器上/usr/local</span><br><span class="line">执行指令：</span><br><span class="line">cd /usr/local</span><br><span class="line">tar -zxvf ruby-2.4.2.tar.gz</span><br><span class="line">cd ruby-2.4.2</span><br><span class="line">./configure</span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">如果报错-bash: /usr/bin/ruby: 没有那个文件或目录</span><br><span class="line">ln -s /usr/local/ruby-2.4.2/ruby /usr/bin/ruby</span><br><span class="line">如果报错</span><br><span class="line">/usr/local/ruby-2.4.2/lib/rubygems/core_ext/kernel_require.rb:55:in `require&#x27;: libssl.so.1.1: cannot open shared object file: No such file or directory - /usr/local/ruby-2.4.2/.ext/x86_64-linux/openssl.so (LoadError)</span><br><span class="line">验证  输入 openssl version</span><br><span class="line">发现是openssl报错了</span><br><span class="line">openssl: error while loading shared libraries: libssl.so.1.1: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line">解决办法：</span><br><span class="line">ln -s /usr/local/lib64/libssl.so.1.1 /usr/lib64/libssl.so.1.1</span><br><span class="line">ln -s /usr/local/lib64/libcrypto.so.1.1 /usr/lib64/libcrypto.so.1.1</span><br><span class="line"></span><br><span class="line">再次openssl version发现好了</span><br><span class="line"></span><br><span class="line">检查ruby的版本</span><br><span class="line">ruby -v </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2、安装redis的redis-3.3.5.gem</span><br><span class="line">cd /usr/local</span><br><span class="line">gem install -l redis-3.3.5.gem</span><br></pre></td></tr></table></figure>

<p>如果报错</p>
<p><img src="/../img/image-20211215200212651.png" alt="image-20211215200212651"></p>
<p>yum -y install zlib zlib-devel</p>
<p>cd /usr/local/ruby-2.4.2/ext/zlib/<br>ruby extconf.rb<br>sed -i s#$(top_srcdir)#../..# Makefile<br>make<br>make install</p>
<p>再次 gem install -l redis-3.3.5.gem即可</p>
<p>3)安装完毕，提示”1 gem installed”，并且输入：gem list，有红框提示，截图如下</p>
<p><img src="/../img/image-20211212212510719.png" alt="image-20211212212510719"></p>
<h3 id="开始安装伪集群"><a href="#开始安装伪集群" class="headerlink" title="开始安装伪集群"></a>开始安装伪集群</h3><p>上面的安装2个别忘了！！！！</p>
<p>cd /usr/local</p>
<p>mkdir redis</p>
<p>cd redis</p>
<p>把redis-4.0.10.tar.gz移动到当前目录解压</p>
<p>tar -zvxf redis-4.0.10.tar.gz</p>
<p>cd redis-4.0.10</p>
<p>make install PREFIX=/usr/local/redis/redis-4.0.10</p>
<p>cd /usr/local/redis</p>
<p>mkdir cluster-config</p>
<p>cd cluster-config</p>
<p>mkdir 7001</p>
<p>mkdir 7002</p>
<p>mkdir 7003</p>
<p>mkdir 7004</p>
<p>mkdir 7005</p>
<p>mkdir 7006</p>
<p>复制bin文件到700*中</p>
<p>cp -r /usr/local/redis/redis-4.0.10/bin /usr/local/redis/cluster-config/7001</p>
<p>cp -r /usr/local/redis/redis-4.0.10/bin /usr/local/redis/cluster-config/7002</p>
<p>cp -r /usr/local/redis/redis-4.0.10/bin /usr/local/redis/cluster-config/7003</p>
<p>cp -r /usr/local/redis/redis-4.0.10/bin /usr/local/redis/cluster-config/7004</p>
<p>cp -r /usr/local/redis/redis-4.0.10/bin /usr/local/redis/cluster-config/7005</p>
<p>cp -r /usr/local/redis/redis-4.0.10/bin /usr/local/redis/cluster-config/7006</p>
<p>redis.conf文件先不全部复制过去，先只复制到7001，等改完7001在复制</p>
<p>cp -r /usr/local/redis/redis-4.0.10/redis.conf  /usr/local/redis/cluster-config/7001/</p>
<h4 id="修改7001文件夹的配置信息，redis-conf"><a href="#修改7001文件夹的配置信息，redis-conf" class="headerlink" title="修改7001文件夹的配置信息，redis.conf"></a>修改7001文件夹的配置信息，redis.conf</h4><p>文件如下内容：</p>
<p>vim /usr/local/redis/cluster-config/7001/redis.conf</p>
<p>7001：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">port 7001</span><br><span class="line">protected-mode no</span><br><span class="line">daemonize yes</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-7001.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">appendonly yes</span><br><span class="line">masterauth Boco123 这个找到以后在下面自己写</span><br><span class="line">requirepass Boco123</span><br><span class="line">bind 10.12.1.33</span><br><span class="line">logfile &quot;/usr/local/redis/cluster-config/7001/redis.log&quot;</span><br><span class="line">dir /usr/local/redis/cluster-config/7001/</span><br><span class="line">pidfile cluster-config/7001.pid/</span><br></pre></td></tr></table></figure>

<p>把reds.conf复制 到另外5个文件夹</p>
<p>cp -r /usr/local/redis/cluster-config/7001/redis.conf /usr/local/redis/cluster-config/7002</p>
<p>cp -r /usr/local/redis/cluster-config/7001/redis.conf /usr/local/redis/cluster-config/7003</p>
<p>cp -r /usr/local/redis/cluster-config/7001/redis.conf /usr/local/redis/cluster-config/7004</p>
<p>cp -r /usr/local/redis/cluster-config/7001/redis.conf /usr/local/redis/cluster-config/7005</p>
<p>cp -r /usr/local/redis/cluster-config/7001/redis.conf /usr/local/redis/cluster-config/7006</p>
<p>vim /usr/local/redis/cluster-config/7002/redis.conf</p>
<p>vim /usr/local/redis/cluster-config/7003/redis.conf</p>
<p>vim /usr/local/redis/cluster-config/7004/redis.conf</p>
<p>vim /usr/local/redis/cluster-config/7005/redis.conf</p>
<p>vim /usr/local/redis/cluster-config/7006/redis.conf</p>
<p>替换每一个端口</p>
<p>:%s/7001/7002/g</p>
<p>:%s/7001/7003/g</p>
<p>:%s/7001/7004/g</p>
<p>:%s/7001/7005/g</p>
<p>:%s/7001/7006/g</p>
<h4 id="防火墙，每台机器都要改"><a href="#防火墙，每台机器都要改" class="headerlink" title="防火墙，每台机器都要改"></a>防火墙，每台机器都要改</h4><p>firewall-cmd –zone=public –add-port=700*/tcp –permanent</p>
<p>命令出错就复制下方</p>
<p>firewall-cmd –zone=public –add-port=7001/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=7002/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=7003/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=7004/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=7005/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=7006/tcp –permanent</p>
<p>注意也要开始1700*，这是一个问题因为集群端口时10000+</p>
<p><img src="/../img/image-20211214104015438.png" alt="image-20211214104015438"></p>
<p>firewall-cmd –zone=public –add-port=1700*/tcp –permanent</p>
<p>or</p>
<p>firewall-cmd –zone=public –add-port=17001/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=17002/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=17003/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=17004/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=17005/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=17006/tcp –permanent</p>
<p>systemctl reload firewalld</p>
<p>把下图的三个文件粘到/usr/local/redis/cluster-config/下</p>
<p><img src="/../img/image-20211213085657656.png" alt="image-20211213085657656"></p>
<p>chmod +x start-all.sh<br>chmod +x stop-all.sh</p>
<h4 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h4><p>find / -name “redis-trib.rb”</p>
<p>vim /usr/local/redis/redis-4.0.10/src/redis-trib.rb</p>
<p>第99行添加密码</p>
<p>, :password =&gt; “Boco123”</p>
<p><img src="/../img/image-20211213090142016.png" alt="image-20211213090142016"></p>
<h4 id="集群启动和停止，"><a href="#集群启动和停止，" class="headerlink" title="集群启动和停止，"></a>集群启动和停止，</h4><p>cd /usr/local/redis/cluster-config</p>
<p>sh start-all.sh</p>
<p>ps -ef|grep redis     验证一下</p>
<h4 id="stop-all-sh文件里有需要的话更改密码，并且更换ip地址"><a href="#stop-all-sh文件里有需要的话更改密码，并且更换ip地址" class="headerlink" title="stop-all.sh文件里有需要的话更改密码，并且更换ip地址"></a>stop-all.sh文件里有需要的话更改密码，并且更换ip地址</h4><p>sh stop-all.sh</p>
<h4 id="创造节点（群起状态下）"><a href="#创造节点（群起状态下）" class="headerlink" title="创造节点（群起状态下）"></a>创造节点（群起状态下）</h4><p>cd /usr/local/redis/redis-4.0.10/src/</p>
<p>./redis-trib.rb create –replicas 1 10.12.1.45:7001 10.12.1.45:7002 10.12.1.45:7003 10.12.1.45:7004 10.12.1.45:7005 10.12.1.45:7006 </p>
<p><img src="/../img/image-20211213090519363.png" alt="image-20211213090519363"></p>
<h4 id="测试redis"><a href="#测试redis" class="headerlink" title="测试redis"></a><strong>测试redis</strong></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">需要输入认证密码（Boco123），如下所示：</span><br><span class="line"></span><br><span class="line">cd /usr/local/redis/cluster-config/7001/bin</span><br><span class="line"></span><br><span class="line">./redis-cli -c -h 192.168.214.132 -p 7001 -a Boco123</span><br><span class="line"></span><br><span class="line">192.168.214.132:7001&gt; set a 1</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">另开一个session</span><br><span class="line">cd /usr/local/redis/cluster-config/7002/bin</span><br><span class="line"></span><br><span class="line">./redis-cli -c -h 192.168.214.132 -p 7002 -a Boco123</span><br><span class="line"></span><br><span class="line">192.168.214.132:7001&gt; get a 1</span><br><span class="line">&quot;1&quot;</span><br><span class="line"></span><br><span class="line">到这里，只要看到set进去的值能够get出来，这就说明redis已经安装成功了，测试结束。</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211213095757637.png" alt="image-20211213095757637"></p>
<p><img src="/../img/image-20211213095803837.png" alt="image-20211213095803837"></p>
<h3 id="真集群"><a href="#真集群" class="headerlink" title="真集群"></a>真集群</h3><p>每个机器都一样，只是没有7003~7006</p>
<p>将文件复制到其他机器上，如果2个机器，那么每个机器3个，如果3个机器，那么每个机器2个</p>
<p>cd /usr/local/redis</p>
<p>scp -r cluster-config root@另一个服务器ip:/usr/local/redis/cluster-config</p>
<p>scp -r cluster-config root@另一个服务器ip:/usr/local/redis/cluster-config</p>
<p><img src="/../img/image-20211212185231903.png" alt="image-20211212185231903"></p>
<h4 id="在第一个有redis-4-0-10的机器上，其余机器可能没有redis-4-0-10"><a href="#在第一个有redis-4-0-10的机器上，其余机器可能没有redis-4-0-10" class="headerlink" title="在第一个有redis-4.0.10的机器上，其余机器可能没有redis-4.0.10"></a>在第一个有redis-4.0.10的机器上，其余机器可能没有redis-4.0.10</h4><h5 id="设置密码-1"><a href="#设置密码-1" class="headerlink" title="设置密码"></a>设置密码</h5><p>find / -name “redis-trib.rb”</p>
<p>vim /usr/local/redis/redis-4.0.10/src/redis-trib.rb</p>
<p>第99行添加密码</p>
<p><img src="/../img/image-20211213090142016.png" alt="image-20211213090142016"></p>
<h5 id="集群启动和停止，在每一个机器上都复制start-all-sh和stop-all-sh分别启动"><a href="#集群启动和停止，在每一个机器上都复制start-all-sh和stop-all-sh分别启动" class="headerlink" title="集群启动和停止，在每一个机器上都复制start-all.sh和stop-all.sh分别启动"></a>集群启动和停止，在每一个机器上都复制start-all.sh和stop-all.sh分别启动</h5><p>sh start-all.sh</p>
<p>停止</p>
<p>sh stop-all.sh</p>
<p>其中sh文件应该比伪集群的sh少了4行，只有7001,7002</p>
<h5 id="创造节点"><a href="#创造节点" class="headerlink" title="创造节点"></a>创造节点</h5><p>cd /usr/local/redis/redis-4.0.10/src/</p>
<p>./redis-trib.rb create –replicas 1 192.168.214.132:7001 192.168.214.132:7002 服务器1:7001 服务器1:7002 服务器2:7001 服务器2:7002</p>
<p>选项–replicas 1 表示我们希望为集群中的每个主节点创建一个从节点。</p>
<p>看到如下界面就证明启动成功了，看到I set the above configuration?时，输入yes即可</p>
<p><img src="/../img/image-20211212215816226.png" alt="image-20211212215816226"></p>
<h2 id="2-zk（最少需要三台服务器）"><a href="#2-zk（最少需要三台服务器）" class="headerlink" title="2.zk（最少需要三台服务器）"></a>2.zk（最少需要三台服务器）</h2><p>与单机其余都一样</p>
<h3 id="vim-zoo-cfg-1"><a href="#vim-zoo-cfg-1" class="headerlink" title="vim zoo.cfg"></a>vim zoo.cfg</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/opt/zookeeper/zookeeper-3.4.9/data</span><br><span class="line">datalogDir=/opt/zookeeper/zookeeper-3.4.9/logs</span><br><span class="line">clientPort=2181</span><br><span class="line">#以下配置与单机不一致，注意ip，本机的ip用0.0.0.0</span><br><span class="line">server.1=10.12.1.50:2888:3888</span><br><span class="line">server.2=10.12.1.34:2888:3888</span><br><span class="line">server.3=10.12.1.33:2888:3888</span><br></pre></td></tr></table></figure>

<p>mkdir /opt/zookeeper/zookeeper-3.4.9/data<br>mkdir /opt/zookeeper/zookeeper-3.4.9/logs</p>
<p>firewall-cmd –zone=public –add-port=3888/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=2888/tcp –permanent</p>
<p>firewall-cmd –zone=public –add-port=2181/tcp –permanent</p>
<p>systemctl reload firewalld</p>
<p>cd /opt/zookeeper/zookeeper-3.4.9/data</p>
<p>vim myid     第一1，第二2，第三3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>

<p>退出</p>
<h3 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h3><p>cd /opt/zookeeper/zookeeper-3.4.9/bin</p>
<p>./zkServer.sh start<br>./zkServer.sh stop<br>./zkServer.sh restart<br>./zkServer.sh status</p>
<p>第一个服务器</p>
<p><img src="/../img/image-20211214205318046.png" alt="image-20211214205318046"></p>
<p>第二个服务器</p>
<p><img src="/../img/image-20211214205342980.png" alt="image-20211214205342980"></p>
<p>第三个服务器</p>
<p><img src="/../img/image-20211214205349339.png" alt="image-20211214205349339"></p>
<h2 id="3-kafka"><a href="#3-kafka" class="headerlink" title="3.kafka"></a>3.kafka</h2><p>如果集群报错，看下是不是端口写错了，2181,9092</p>
<p>cd /opt/kafka/kafka_2.12-0.10.2.1/config/</p>
<p>vim server.properties</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#broler全局唯一编号，不能重复,1,2,3</span><br><span class="line">broker.id=1</span><br><span class="line">#打开删除topic功能</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">#内网访问kafka的地址</span><br><span class="line">listeners=PLAINTEXT://ip:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://ip:9092</span><br><span class="line">#kafka运行日志存放的路径</span><br><span class="line">log.dirs=/opt/kafka/logs</span><br><span class="line">#配置连接Zookeeper</span><br><span class="line">zookeeper.connect=10.12.1.50:2181,10.12.1.34:2181,10.12.1.33:2181</span><br><span class="line">#更改默认过期时间，可以不设置，默认7天168h</span><br><span class="line">log.retention.hours=24</span><br></pre></td></tr></table></figure>

<p>mkdir /opt/kafka/logs</p>
<h3 id="启动kafka-bin目录下"><a href="#启动kafka-bin目录下" class="headerlink" title="启动kafka bin目录下"></a>启动kafka bin目录下</h3><p>cd /opt/kafka/kafka_2.12-0.10.2.1/bin</p>
<p>sh kafka-server-start.sh -daemon ../config/server.properties</p>
<p>停止</p>
<p>kafka-server-stop.sh stop 或者</p>
<p>sh kafka-server-stop.sh</p>
<p>#查看zookeeper<br>ps -ef|grep zookeeper</p>
<p>验证Kafka是否启动成功：</p>
<p>输入jps命令回车查看，有Kafka进程，说明启动成功</p>
<p><img src="/../img/image-20211210164417297.png" alt="image-20211210164417297"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.查看主题列表</span><br><span class="line">bin/kafka-topics.sh --zookeeper localhost:2181 --list</span><br><span class="line"></span><br><span class="line">2.创建topic  test</span><br><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test</span><br><span class="line"></span><br><span class="line">5.启动生产者</span><br><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test</span><br><span class="line"></span><br><span class="line">6.启动消费者，新窗口</span><br><span class="line">./bin/kafka-console-consumer.sh --zookeeper localhost:2181 -topic test --from-beginning</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在131上创建了test</p>
<p><img src="/../img/image-20211215094559262.png" alt="image-20211215094559262"></p>
<p>在132上查，发现有test</p>
<p><img src="/../img/image-20211215094627263.png" alt="image-20211215094627263"></p>
<h2 id="4-nacos"><a href="#4-nacos" class="headerlink" title="4.nacos"></a>4.nacos</h2><p>进入nacos目录下conf目录，有配置文件cluster.conf.example，复制成cluster.conf</p>
<p>mv cluster.conf.example cluster.conf</p>
<p>vim cluster.conf</p>
<p>设置三个端口ip</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.168.214.131:8848</span><br><span class="line">192.168.214.132:8848</span><br><span class="line">192.168.214.133:8848</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置-MySQL-数据库-与单机一致"><a href="#配置-MySQL-数据库-与单机一致" class="headerlink" title="配置 MySQL 数据库(与单机一致)"></a>配置 MySQL 数据库(与单机一致)</h3><h5 id="修改conf-application-properties-增加-mysql-数据源配置-1"><a href="#修改conf-application-properties-增加-mysql-数据源配置-1" class="headerlink" title="修改conf/application.properties,增加 mysql 数据源配置"></a>修改conf/application.properties,增加 mysql 数据源配置</h5><p>输入指令：vim /opt/nacos/nacos/conf/application.properties</p>
<p>按住shift+g, 在文件末尾添加： 注意自己的ip地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring.datasource.platform=mysql</span><br><span class="line">db.num=1</span><br><span class="line">db.url.0=jdbc:mysql://自己ip:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=10000&amp;socketTimeout=30000&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">db.user=root</span><br><span class="line">db.password=Boco.123</span><br></pre></td></tr></table></figure>

<h3 id="三台都启动"><a href="#三台都启动" class="headerlink" title="三台都启动"></a>三台都<strong>启动</strong></h3><ol>
<li>进入nacos目录bin下：cd /opt/nacos/nacos/bin/</li>
</ol>
<p>启动命令：sh startup.sh</p>
<p>查看运行日志： tail -500f /opt/nacos/nacos/logs/start.out</p>
<p><img src="/../img/image-20211212145000748.png" alt="image-20211212145000748"></p>
<p>2．界面控制台</p>
<p>注意打开8848端口</p>
<p>firewall-cmd –zone=public –add-port=8848/tcp –permanent</p>
<p>systemctl reload firewalld</p>
<p>启动完毕后。登录到界面控制台（用户名密码默认都是nacos）<a href="http://ip:8848/nacos">http://ip:8848/nacos</a></p>
<p>查看集群管理，发现成功了</p>
<p><img src="/../img/image-20211215103115196.png" alt="image-20211215103115196"></p>
<h3 id="三台都关闭"><a href="#三台都关闭" class="headerlink" title="三台都关闭"></a>三台都关闭</h3><p>进入 nacos/bin/目录下运行:  ./shutdown.sh</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux单机与集群</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodb</title>
    <url>/2021/11/30/mongodb/</url>
    <content><![CDATA[<h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">（1）数据量大</span><br><span class="line">（2）写入操作频繁（读写都很频繁）</span><br><span class="line">（3）价值较低的数据，对事务性要求不高</span><br><span class="line">对于这样的数据，我们更适合使用MongoDB来实现数据的存储。</span><br></pre></td></tr></table></figure>

<p>它支持的数据结构非常松散，是一种类似于 JSON 的 格式叫BSON，所以它既可以存储比较复杂的数据类型，又相当的灵活。</p>
<h1 id="2-BSON"><a href="#2-BSON" class="headerlink" title="2.BSON"></a>2.BSON</h1><p>BSON（Binary Serialized Document Format）是一种类json的一种二进制形式的存储格式，简称Binary JSON。BSON和JSON一样，支持 内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p>
<p>Bson中，除了基本的JSON类型：string,integer,boolean,double,null,array和object，mongo还使用了特殊的数据类型。这些类型包括 date,object id,binary data,regular expression 和code。</p>
<p><img src="/../img/image-20220223105622830.png" alt="image-20220223105622830"></p>
<p>shell默认使用64位浮点型数值。{“x”：3.14}或{“x”：3}。对于整型值，可以使用NumberInt（4字节符号整数）或NumberLong（8字节符 号整数），{“x”:NumberInt(“3”)}{“x”:NumberLong(“3”)}</p>
<h1 id="3-与mysql对比"><a href="#3-与mysql对比" class="headerlink" title="3.与mysql对比"></a>3.与mysql对比</h1><p><img src="/../img/image-20220223105059330.png" alt="image-20220223105059330"></p>
<p><img src="/../img/image-20220223105121350.png" alt="image-20220223105121350"></p>
<h1 id="4-单机部署安装"><a href="#4-单机部署安装" class="headerlink" title="4.单机部署安装"></a>4.单机部署安装</h1><h2 id="1-windows安装"><a href="#1-windows安装" class="headerlink" title="1.windows安装"></a>1.windows安装</h2><p>解压</p>
<p><img src="/../img/image-20220223110941174.png" alt="image-20220223110941174"></p>
<p>手动建立一个目录用于存放数据文件</p>
<p>在bin的同级目录下  创建data/db</p>
<p><img src="/../img/image-20220223111025410.png" alt="image-20220223111025410"></p>
<h3 id="启动命令方式一"><a href="#启动命令方式一" class="headerlink" title="启动命令方式一"></a>启动命令方式一</h3><p>在 bin 目录中打开命令行提示符cmd</p>
<p>mongod –dbpath=..\data\db</p>
<p>mongoDB的默认端口是27017，如果我们想改变默认的启动端口，可以通过–port来指定端口</p>
<p><img src="/../img/image-20220223111156658.png" alt="image-20220223111156658"></p>
<p>也可以将安装目录的bin目录设置到环境变量的path中（未做）</p>
<h3 id="启动命令方式二"><a href="#启动命令方式二" class="headerlink" title="启动命令方式二"></a>启动命令方式二</h3><p>配置文件方式启动服务</p>
<p>在bin同级目录新建 config 文件夹，该文件夹中新建配置文件 mongod.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">storage:</span><br><span class="line">#The directory where the mongod instance stores its data.Default Value is &quot;\data\db&quot; on Windows.</span><br><span class="line">#dbPath: 你的db位置</span><br><span class="line">  dbPath: D:\mongodb\软件\mongodb-win32-x86_64-2008plus-ssl-4.0.12\data\db</span><br></pre></td></tr></table></figure>

<p>启动bin目录下：mongod -f ../config/mongod.conf</p>
<p>更多参数配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  #The path of the log file to which mongod or mongos should send all diagnostic logging information</span><br><span class="line">  path: &quot;D:/02_Server/DBServer/mongodb-win32-x86_64-2008plus-ssl-4.0.1/log/mongod.log&quot;</span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">  #The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;.</span><br><span class="line">  dbPath: &quot;D:/02_Server/DBServer/mongodb-win32-x86_64-2008plus-ssl-4.0.1/data&quot;</span><br><span class="line">net:</span><br><span class="line">  #bindIp: 127.0.0.1</span><br><span class="line">  port: 27017</span><br><span class="line">setParameter:</span><br><span class="line">  enableLocalhostAuthBypass: false</span><br></pre></td></tr></table></figure>

<h2 id="2-shell连接"><a href="#2-shell连接" class="headerlink" title="2.shell连接"></a>2.shell连接</h2><p>在命令提示符输入以下shell命令即可完成登陆,注意之前的cmd不能关</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mongo</span><br><span class="line">或</span><br><span class="line">mongo --host=127.0.0.1 --port=27017</span><br></pre></td></tr></table></figure>

<p>查看已经有的数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show databases</span><br></pre></td></tr></table></figure>

<p>退出mongodb</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>

<h2 id="3-Compass-图形化界面客户端"><a href="#3-Compass-图形化界面客户端" class="headerlink" title="3.Compass-图形化界面客户端"></a>3.Compass-图形化界面客户端</h2><p><img src="/../img/image-20220223113935181.png" alt="image-20220223113935181"></p>
<p>直接解压，执行里面的 MongoDBCompassCommunity.exe 文件即可</p>
<p><img src="/../img/image-20220223114203069.png" alt="image-20220223114203069"></p>
<p>在打开的界面中，输入主机地址、端口等相关信息，点击连接：</p>
<p><img src="/../img/image-20220223114253926.png" alt="image-20220223114253926"></p>
<h3 id="4-Linux系统中的安装启动和连接"><a href="#4-Linux系统中的安装启动和连接" class="headerlink" title="4.Linux系统中的安装启动和连接"></a>4.Linux系统中的安装启动和连接</h3><p>mkdir /usr/local/mongodb</p>
<p>cd /usr/local/mongodb</p>
<p>tar -xvf mongodb-linux-x86_64-4.0.10.tgz</p>
<p>#数据存储目录 </p>
<p>mkdir -p single/data/db</p>
<p>#日志存储目录</p>
<p>mkdir -p single/log</p>
<p>#新建并修改配置文件</p>
<p>vim single/mongod.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">  # #The path of the log file to which mongod or mongos should send all diagnostic logging information</span><br><span class="line">  destination: file</span><br><span class="line">  #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">  path: &quot;/usr/local/mongodb/single/log/mongod.log&quot;</span><br><span class="line">  #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line">  #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">  ##The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;.</span><br><span class="line">  dbPath: &quot;/usr/local/mongodb/single/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">  #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">  fork: true</span><br><span class="line">net:</span><br><span class="line">  #服务实例绑定的IP，默认是localhost,后面需要在写本机地址</span><br><span class="line">  bindIp: localhost,192.168.214.130</span><br><span class="line">  #bindIp</span><br><span class="line">  #绑定的端口，默认是27017</span><br><span class="line">  port: 27017</span><br></pre></td></tr></table></figure>

<h3 id="启动MongoDB服务"><a href="#启动MongoDB服务" class="headerlink" title="#启动MongoDB服务"></a>#启动MongoDB服务</h3><p>/usr/local/mongodb/mongodb-linux-x86_64-4.0.10/bin/mongod -f /usr/local/mongodb/single/mongod.conf</p>
<p><img src="/../img/image-20220223140145816.png" alt="image-20220223140145816"></p>
<p>通过进程来查看服务是否启动</p>
<p>ps -ef |grep mongod</p>
<h3 id="停止服务"><a href="#停止服务" class="headerlink" title="停止服务"></a>停止服务</h3><p>第一种方法：kill -9 1752</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">不安全，可能数据损坏</span><br><span class="line">如果损坏</span><br><span class="line">删除lock文件</span><br><span class="line">rm -f /usr/local/mongodb/single/data/db/*.lock</span><br><span class="line">修复数据</span><br><span class="line">/usr/local/mongodb/mongodb-linux-x86_64-4.0.10/bin/mongod --repair --dbpath=/usr/local/mongodb/single/data/db</span><br></pre></td></tr></table></figure>

<p>第二种：标准的关闭方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">//#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">//关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>

<h2 id="添加环境变量"><a href="#添加环境变量" class="headerlink" title="添加环境变量"></a>添加环境变量</h2><p>vim /etc/profile</p>
<p>export PATH=/usr/local/mongodb/mongodb-linux-x86_64-4.0.10//bin:$PATH</p>
<p>source /etc/profile</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>使用mongo就可以进入到命令行</p>
<h2 id="清空页面命令"><a href="#清空页面命令" class="headerlink" title="清空页面命令"></a>清空页面命令</h2><p>cls，linux是clear</p>
<h1 id="5-基本命令"><a href="#5-基本命令" class="headerlink" title="5.基本命令"></a>5.基本命令</h1><h2 id="2-数据库相关"><a href="#2-数据库相关" class="headerlink" title="2.数据库相关"></a>2.数据库相关</h2><p><img src="/../img/image-20220223141224512.png" alt="image-20220223141224512"></p>
<p>现在内存中，只有插入数据了，才会真正创建到硬盘中</p>
<p><img src="/../img/image-20220223142202836.png" alt="image-20220223142202836"></p>
<p><img src="/../img/image-20220223142318887.png" alt="image-20220223142318887"></p>
<p><img src="/../img/image-20220223142411880.png" alt="image-20220223142411880"></p>
<h2 id="3-集合操作-数据库中的表"><a href="#3-集合操作-数据库中的表" class="headerlink" title="3.集合操作(数据库中的表)"></a>3.集合操作(数据库中的表)</h2><p>可以显示的创建，也可以隐式的创建。</p>
<h3 id="1-集合的显式创建（了解）"><a href="#1-集合的显式创建（了解）" class="headerlink" title="1 集合的显式创建（了解）"></a>1 集合的显式创建（了解）</h3><p>基本语法格式：</p>
<p>db.createCollection(name)</p>
<p>参数说明：name: 要创建的集合名称<br>例如：创建一个名为 mycollection 的普通集合。</p>
<p>db.createCollection(“mycollection”)</p>
<p>查看当前库中的表：show tables命令or  show collections</p>
<h3 id="2-集合的隐式创建"><a href="#2-集合的隐式创建" class="headerlink" title="2. 集合的隐式创建"></a>2. 集合的隐式创建</h3><p>当向一个集合中插入一个文档的时候，如果集合不存在，则会自动创建集合。<br>提示：通常我们使用隐式创建文档即可。</p>
<h3 id="3-集合的删除"><a href="#3-集合的删除" class="headerlink" title="3.集合的删除"></a>3.集合的删除</h3><p>集合删除语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合.drop()</span><br></pre></td></tr></table></figure>

<p>返回值<br>如果成功删除选定集合，则 drop() 方法返回 true，否则返回 false。<br>例如：要删除mycollection集合<br>db.mycollection.drop()</p>
<h2 id="4-文档（数据库中的一行数据）"><a href="#4-文档（数据库中的一行数据）" class="headerlink" title="4.文档（数据库中的一行数据）"></a>4.文档（数据库中的一行数据）</h2><p>文档（document）的数据结构和 JSON 基本一样。</p>
<p>所有存储在集合中的数据都是 BSON 格式</p>
<h3 id="1-插入"><a href="#1-插入" class="headerlink" title="1.插入"></a>1.插入</h3><p><img src="/../img/image-20220223143447242.png" alt="image-20220223143447242"></p>
<p><img src="/../img/image-20220223143510577.png" alt="image-20220223143510577"></p>
<p>后两个参数先了解，一个是安全级别，最后一个是否排序，第一个插入的json</p>
<h4 id="【示例】要向comment的集合-表-中插入一条测试数据"><a href="#【示例】要向comment的集合-表-中插入一条测试数据" class="headerlink" title="【示例】要向comment的集合(表)中插入一条测试数据"></a>【示例】要向comment的集合(表)中插入一条测试数据</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">db.comment.insert(&#123;</span><br><span class="line">    <span class="attr">&quot;articleid&quot;</span>:<span class="string">&quot;100000&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;content&quot;</span>:<span class="string">&quot;今天天气真好，阳光明媚&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;userid&quot;</span>:<span class="string">&quot;1001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;Rose&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;createdatetime&quot;</span>:new Date(),</span><br><span class="line">    <span class="attr">&quot;likenum&quot;</span>:NumberInt(<span class="number">10</span>),</span><br><span class="line">    <span class="attr">&quot;state&quot;</span>:<span class="literal">null</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220223143902798.png" alt="image-20220223143902798"></p>
<h4 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">db.comment.insertMany([</span><br><span class="line">&#123;<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">&quot;articleid&quot;</span>:<span class="string">&quot;100001&quot;</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>,<span class="attr">&quot;userid&quot;</span>:<span class="string">&quot;1002&quot;</span>,<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;相忘于江湖&quot;</span>,<span class="attr">&quot;createdatetime&quot;</span>:new Date(<span class="string">&quot;2019-08-05T22:08:15.522Z&quot;</span>),<span class="attr">&quot;likenum&quot;</span>:NumberInt(<span class="number">1000</span>),<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">&quot;articleid&quot;</span>:<span class="string">&quot;100001&quot;</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span>,<span class="attr">&quot;userid&quot;</span>:<span class="string">&quot;1005&quot;</span>,<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;伊人憔悴&quot;</span>,<span class="attr">&quot;createdatetime&quot;</span>:new Date(<span class="string">&quot;2019-08-05T23:58:51.485Z&quot;</span>),<span class="attr">&quot;likenum&quot;</span>:NumberInt(<span class="number">888</span>),<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">&quot;articleid&quot;</span>:<span class="string">&quot;100001&quot;</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;我一直喝凉开水，冬天夏天都喝。&quot;</span>,<span class="attr">&quot;userid&quot;</span>:<span class="string">&quot;1004&quot;</span>,<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;杰克船长&quot;</span>,<span class="attr">&quot;createdatetime&quot;</span>:new Date(<span class="string">&quot;2019-08-06T01:05:06.321Z&quot;</span>),<span class="attr">&quot;likenum&quot;</span>:NumberInt(<span class="number">666</span>),<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;4&quot;</span>,<span class="attr">&quot;articleid&quot;</span>:<span class="string">&quot;100001&quot;</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;专家说不能空腹吃饭，影响健康。&quot;</span>,<span class="attr">&quot;userid&quot;</span>:<span class="string">&quot;1003&quot;</span>,<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;凯撒&quot;</span>,<span class="attr">&quot;createdatetime&quot;</span>:new Date(<span class="string">&quot;2019-08-06T08:18:35.288Z&quot;</span>),<span class="attr">&quot;likenum&quot;</span>:NumberInt(<span class="number">2000</span>),<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;5&quot;</span>,<span class="attr">&quot;articleid&quot;</span>:<span class="string">&quot;100001&quot;</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;</span>,<span class="attr">&quot;userid&quot;</span>:<span class="string">&quot;1003&quot;</span>,<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;凯撒&quot;</span>,<span class="attr">&quot;createdatetime&quot;</span>:new Date(<span class="string">&quot;2019-08-06T11:01:02.521Z&quot;</span>),<span class="attr">&quot;likenum&quot;</span>:NumberInt(<span class="number">3000</span>),<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h3 id="2-基本查询db-集合-find-查询条件，展示字段"><a href="#2-基本查询db-集合-find-查询条件，展示字段" class="headerlink" title="2.基本查询db.集合.find(查询条件，展示字段)"></a>2.基本查询db.集合.find(查询条件，展示字段)</h3><h4 id="查所有（所有数据全部字段）"><a href="#查所有（所有数据全部字段）" class="headerlink" title="查所有（所有数据全部字段）"></a>查所有（所有数据全部字段）</h4><p>db.集合.find()</p>
<h4 id="查单个"><a href="#查单个" class="headerlink" title="查单个"></a>查单个</h4><p>db.comment.find({userid:’1003’})</p>
<h5 id="只需要返回符合条件的第一条数据"><a href="#只需要返回符合条件的第一条数据" class="headerlink" title="只需要返回符合条件的第一条数据"></a>只需要返回符合条件的第一条数据</h5><p>db.comment.findOne({userid:’1003’})</p>
<h4 id="投影查询（不显示所有字段，只显示指定的字段）"><a href="#投影查询（不显示所有字段，只显示指定的字段）" class="headerlink" title="投影查询（不显示所有字段，只显示指定的字段）"></a>投影查询（不显示所有字段，只显示指定的字段）</h4><h5 id="查询结果只显示-id、userid、nickname"><a href="#查询结果只显示-id、userid、nickname" class="headerlink" title="查询结果只显示 _id、userid、nickname"></a>查询结果只显示 _id、userid、nickname</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,nickname:1&#125;)</span><br></pre></td></tr></table></figure>

<p>{ “_id” : “4”, “userid” : “1003”, “nickname” : “凯撒” }<br>{ “_id” : “5”, “userid” : “1003”, “nickname” : “凯撒” }</p>
<p>默认 _id 会显示</p>
<h5 id="查询所有数据-只显示-、userid、nickname-，不显示-id"><a href="#查询所有数据-只显示-、userid、nickname-，不显示-id" class="headerlink" title="查询所有数据,只显示 、userid、nickname ，不显示 _id"></a>查询所有数据,只显示 、userid、nickname ，不显示 _id</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,nickname:1,_id:0&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220223150238214.png" alt="image-20220223150238214"></p>
<h3 id="3-更新"><a href="#3-更新" class="headerlink" title="3.更新"></a>3.更新</h3><p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.collection.update(query, update, options)</span><br><span class="line">//或</span><br><span class="line">db.collection.update(</span><br><span class="line">&lt;query&gt;,</span><br><span class="line">&lt;update&gt;,</span><br><span class="line">&#123;</span><br><span class="line">upsert: &lt;boolean&gt;,</span><br><span class="line">multi: &lt;boolean&gt;,</span><br><span class="line">writeConcern: &lt;document&gt;,</span><br><span class="line">collation: &lt;document&gt;,</span><br><span class="line">arrayFilters: [ &lt;filterdocument1&gt;, ... ],</span><br><span class="line">hint: &lt;document|string&gt; // Available starting in MongoDB 4.2</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="覆盖修改"><a href="#覆盖修改" class="headerlink" title="覆盖修改"></a>覆盖修改</h4><p>如果我们想修改_id为1的记录，点赞量为1001，输入以下语句</p>
<p>db.comment.update({_id:”1”},{likenum:NumberInt(1001)})</p>
<p>执行后，我们会发现，这条文档除了likenum字段其它字段都不见了</p>
<h4 id="局部修改"><a href="#局部修改" class="headerlink" title="局部修改"></a>局部修改</h4><p>想修改_id为2的记录，浏览量为889，输入以下语句</p>
<p>db.comment.update({_id:”2”},{$set:{likenum:NumberInt(889)}})</p>
<h4 id="批量的修改"><a href="#批量的修改" class="headerlink" title="批量的修改"></a>批量的修改</h4><p>更新所有用户为 1003 的用户的昵称为 凯撒大帝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//默认只修改第一条数据</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒2&quot;&#125;&#125;)</span><br><span class="line">//修改所有符合条件的数据</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒大帝&quot;&#125;&#125;,&#123;multi:true&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="列值增长的修改-inc-运算符"><a href="#列值增长的修改-inc-运算符" class="headerlink" title="列值增长的修改:$inc 运算符"></a>列值增长的修改:$inc 运算符</h4><p>对3号数据的点赞数，每次递增1</p>
<p>db.comment.update({_id:”3”},{$inc:{likenum:NumberInt(1)}})</p>
<h3 id="4-删除文档"><a href="#4-删除文档" class="headerlink" title="4.删除文档"></a>4.删除文档</h3><p><img src="/../img/image-20220223152232536.png" alt="image-20220223152232536"></p>
<h1 id="6-文档的分页查询"><a href="#6-文档的分页查询" class="headerlink" title="6.文档的分页查询"></a>6.文档的分页查询</h1><h2 id="1-统计查询"><a href="#1-统计查询" class="headerlink" title="1.统计查询"></a>1.统计查询</h2><p>语法：db.collection.count(query, options)</p>
<h3 id="实例：统计所有记录数"><a href="#实例：统计所有记录数" class="headerlink" title="实例：统计所有记录数"></a>实例：统计所有记录数</h3><p>db.comment.count()</p>
<h3 id="统计userid为1003的记录条数"><a href="#统计userid为1003的记录条数" class="headerlink" title="统计userid为1003的记录条数"></a>统计userid为1003的记录条数</h3><p>db.comment.count({userid:”1003”})</p>
<p>默认情况下 count() 方法返回符合条件的全部记录条数</p>
<h2 id="2-分页列表查询"><a href="#2-分页列表查询" class="headerlink" title="2.分页列表查询"></a>2.分页列表查询</h2><p>语法：db.COLLECTION_NAME.find().limit(NUMBER).skip(NUMBER)</p>
<h3 id="返回指定条数的记录"><a href="#返回指定条数的记录" class="headerlink" title="返回指定条数的记录"></a>返回指定条数的记录</h3><p>db.comment.find().limit(2)</p>
<h3 id="skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）"><a href="#skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）" class="headerlink" title="skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）"></a>skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）</h3><p>db.comment.find().skip(2)</p>
<h3 id="需求：每页2个，第二页开始：跳过前两条数据，接着值显示3和4条数据"><a href="#需求：每页2个，第二页开始：跳过前两条数据，接着值显示3和4条数据" class="headerlink" title="需求：每页2个，第二页开始：跳过前两条数据，接着值显示3和4条数据"></a>需求：每页2个，第二页开始：跳过前两条数据，接着值显示3和4条数据</h3><p><img src="/../img/image-20220223153028322.png" alt="image-20220223153028322"></p>
<h2 id="3-排序查询"><a href="#3-排序查询" class="headerlink" title="3.排序查询"></a>3.排序查询</h2><p>sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用 于降序排列。</p>
<p>语法如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().sort(&#123;KEY:1&#125;)</span><br><span class="line">或</span><br><span class="line">db.集合名称.find().sort(排序方式)</span><br></pre></td></tr></table></figure>

<p>对userid降序排列，并对访问量进行升序排列</p>
<p>db.comment.find().sort({userid:-1,likenum:1})</p>
<h2 id="4-注意"><a href="#4-注意" class="headerlink" title="4.注意"></a>4.注意</h2><p>skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()，和命令编写顺序无关。</p>
<h1 id="7-文档的更多查询"><a href="#7-文档的更多查询" class="headerlink" title="7.文档的更多查询"></a>7.文档的更多查询</h1><h2 id="1-模糊查询"><a href="#1-模糊查询" class="headerlink" title="1.模糊查询"></a>1.模糊查询</h2><p>语法：db.collection.find({field:/正则表达式/})</p>
<h3 id="要查询评论内容包含“开水”的所有文档"><a href="#要查询评论内容包含“开水”的所有文档" class="headerlink" title="要查询评论内容包含“开水”的所有文档"></a>要查询评论内容包含“开水”的所有文档</h3><p>db.comment.find({content:/开水/})</p>
<h3 id="要查询评论的内容中以“专家”开头的"><a href="#要查询评论的内容中以“专家”开头的" class="headerlink" title="要查询评论的内容中以“专家”开头的"></a>要查询评论的内容中以“专家”开头的</h3><p>db.comment.find({content:/^专家/})</p>
<h2 id="2-比较查询"><a href="#2-比较查询" class="headerlink" title="2.比较查询"></a>2.比较查询</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gt: value &#125;&#125;) // 大于: field &gt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lt: value &#125;&#125;) // 小于: field &lt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gte: value &#125;&#125;) // 大于等于: field &gt;= value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lte: value &#125;&#125;) // 小于等于: field &lt;= value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $ne: value &#125;&#125;) // 不等于: field != value</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查询评论点赞数量大于700的记录</p>
<p>db.comment.find({likenum:{$gt:NumberInt(700)}})</p>
<h2 id="3-包含查询，mysql中的in"><a href="#3-包含查询，mysql中的in" class="headerlink" title="3.包含查询，mysql中的in"></a>3.包含查询，mysql中的in</h2><h3 id="查询评论的集合中userid字段包含1003或1004的文档"><a href="#查询评论的集合中userid字段包含1003或1004的文档" class="headerlink" title="查询评论的集合中userid字段包含1003或1004的文档"></a>查询评论的集合中userid字段包含1003或1004的文档</h3><p>db.comment.find({userid:{$in:[“1003”,”1004”]}})</p>
<h3 id="不包含使用-nin操作符。-示例：查询评论集合中userid字段不包含1003和1004的文档"><a href="#不包含使用-nin操作符。-示例：查询评论集合中userid字段不包含1003和1004的文档" class="headerlink" title="不包含使用$nin操作符。 示例：查询评论集合中userid字段不包含1003和1004的文档"></a>不包含使用$nin操作符。 示例：查询评论集合中userid字段不包含1003和1004的文档</h3><p>db.comment.find({userid:{$nin:[“1003”,”1004”]}})</p>
<h2 id="4-条件连接查询（相-当于SQL的and）"><a href="#4-条件连接查询（相-当于SQL的and）" class="headerlink" title="4.条件连接查询（相 当于SQL的and）"></a>4.条件连接查询（相 当于SQL的and）</h2><h3 id="查询评论集合中likenum大于等于700-并且小于2000的文档"><a href="#查询评论集合中likenum大于等于700-并且小于2000的文档" class="headerlink" title="查询评论集合中likenum大于等于700 并且小于2000的文档"></a>查询评论集合中likenum大于等于700 并且小于2000的文档</h3><p>db.comment.find({$and:[{likenum:{$gte:NumberInt(700)}},{likenum:{$lt:NumberInt(2000)}}]})</p>
<h3 id="查询评论集合中userid为1003，或者点赞数小于1000的文档记录"><a href="#查询评论集合中userid为1003，或者点赞数小于1000的文档记录" class="headerlink" title="查询评论集合中userid为1003，或者点赞数小于1000的文档记录"></a>查询评论集合中userid为1003，或者点赞数小于1000的文档记录</h3><p>db.comment.find({$or:[ {userid:”1003”} ,{likenum:{$lt:1000} }]})</p>
<h1 id="8-常用命令小结"><a href="#8-常用命令小结" class="headerlink" title="8.常用命令小结"></a>8.常用命令小结</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">选择切换数据库：use articledb</span><br><span class="line">插入数据：db.comment.insert(&#123;bson数据&#125;)</span><br><span class="line">查询所有数据：db.comment.find();</span><br><span class="line">条件查询数据：db.comment.find(&#123;条件&#125;)</span><br><span class="line">查询符合条件的第一条记录：db.comment.findOne(&#123;条件&#125;)</span><br><span class="line">查询符合条件的前几条记录：db.comment.find(&#123;条件&#125;).limit(条数)</span><br><span class="line">查询符合条件的跳过的记录：db.comment.find(&#123;条件&#125;).skip(条数)</span><br><span class="line">修改数据：db.comment.update(&#123;条件&#125;,&#123;修改后的数据&#125;) 或db.comment.update(&#123;条件&#125;,&#123;$set:&#123;要修改部分的字段:数据&#125;)</span><br><span class="line">修改数据并自增某字段值：db.comment.update(&#123;条件&#125;,&#123;$inc:&#123;自增的字段:步进值&#125;&#125;)</span><br><span class="line">删除数据：db.comment.remove(&#123;条件&#125;)</span><br><span class="line">统计查询：db.comment.count(&#123;条件&#125;)</span><br><span class="line">模糊查询：db.comment.find(&#123;字段名:/正则表达式/&#125;)</span><br><span class="line">条件比较运算：db.comment.find(&#123;字段名:&#123;$gt:值&#125;&#125;)</span><br><span class="line">包含查询：db.comment.find(&#123;字段名:&#123;$in:[值1，值2]&#125;&#125;)或db.comment.find(&#123;字段名:&#123;$nin:[值1，值2]&#125;&#125;)</span><br><span class="line">条件连接查询：db.comment.find(&#123;$and:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)或db.comment.find(&#123;$or:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="9-索引index"><a href="#9-索引index" class="headerlink" title="9.索引index"></a>9.索引index</h1><p>MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）</p>
<h2 id="1-单字段索引"><a href="#1-单字段索引" class="headerlink" title="1.单字段索引"></a>1.单字段索引</h2><p>索引键的排序顺序（即升序或降序）并不重要，因为MongoDB可以在任何方向上遍历索引</p>
<p><img src="/../img/image-20220223154422063.png" alt="image-20220223154422063"></p>
<h2 id="2-复合索引"><a href="#2-复合索引" class="headerlink" title="2.复合索引"></a>2.复合索引</h2><p><img src="/../img/image-20220223154531779.png" alt="image-20220223154531779"></p>
<p>通过userid先排序，然后同一个userid可能会有不同的score，在做一个降序</p>
<h2 id="3-索引管理"><a href="#3-索引管理" class="headerlink" title="3.索引管理"></a>3.索引管理</h2><h3 id="1-查看"><a href="#1-查看" class="headerlink" title="1.查看"></a>1.查看</h3><p>db.collection.getIndexes()</p>
<p><img src="/../img/image-20220223154751014.png" alt="image-20220223154751014"></p>
<p>v:索引引擎的版本号</p>
<p>key:字段名：排序方式</p>
<p>name:索引的名称，默认字段名+’_’+升序方式</p>
<p>namespace：数据库的集合，索引存放在那个数据库的集合中</p>
<h3 id="2-创建"><a href="#2-创建" class="headerlink" title="2.创建"></a>2.创建</h3><p>语法：db.collection.createIndex(keys, options)</p>
<p>options：</p>
<p><img src="/../img/image-20220223155038035.png" alt="image-20220223155038035"></p>
<h4 id="单字段索引示例：对-userid-字段建立索引"><a href="#单字段索引示例：对-userid-字段建立索引" class="headerlink" title="单字段索引示例：对 userid 字段建立索引"></a>单字段索引示例：对 userid 字段建立索引</h4><p> db.comment.createIndex({userid:1})</p>
<p>1：升序</p>
<p><img src="/../img/image-20220223155116560.png" alt="image-20220223155116560"></p>
<h4 id="复合索引：对-userid-和-nickname-同时建立复合（Compound）索引"><a href="#复合索引：对-userid-和-nickname-同时建立复合（Compound）索引" class="headerlink" title="复合索引：对 userid 和 nickname 同时建立复合（Compound）索引"></a>复合索引：对 userid 和 nickname 同时建立复合（Compound）索引</h4><p>db.comment.createIndex({userid:1,nickname:-1})</p>
<p><img src="/../img/image-20220223155244594.png" alt="image-20220223155244594"></p>
<h3 id="3-移除"><a href="#3-移除" class="headerlink" title="3.移除"></a>3.移除</h3><p>语法：db.collection.dropIndex(index)</p>
<h4 id="删除-comment-集合中-userid-字段上的升序索引"><a href="#删除-comment-集合中-userid-字段上的升序索引" class="headerlink" title="删除 comment 集合中 userid 字段上的升序索引"></a>删除 comment 集合中 userid 字段上的升序索引</h4><p>db.comment.dropIndex({userid:1})</p>
<h4 id="删除集合中所有索引"><a href="#删除集合中所有索引" class="headerlink" title="删除集合中所有索引"></a>删除集合中所有索引</h4><p>db.collection.dropIndexes()</p>
<h4 id="注意：提示：-id-的字段的索引是无法删除的，只能删除非-id-字段的索引。"><a href="#注意：提示：-id-的字段的索引是无法删除的，只能删除非-id-字段的索引。" class="headerlink" title="注意：提示： _id 的字段的索引是无法删除的，只能删除非 _id 字段的索引。"></a>注意：提示： _id 的字段的索引是无法删除的，只能删除非 _id 字段的索引。</h4><h2 id="4-索引的使用"><a href="#4-索引的使用" class="headerlink" title="4.索引的使用"></a>4.索引的使用</h2><p>那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看。 语法：</p>
<p>db.collection.find(query,options).explain(options)</p>
<h3 id="查看根据userid查询数据的情况"><a href="#查看根据userid查询数据的情况" class="headerlink" title="查看根据userid查询数据的情况"></a>查看根据userid查询数据的情况</h3><p>db.comment.find({userid:”1003”}).explain()</p>
<p><img src="/../img/image-20220223155737402.png" alt="image-20220223155737402"></p>
<p>用compass查看</p>
<p><img src="/../img/image-20220223160350354.png" alt="image-20220223160350354"></p>
<p><img src="/../img/image-20220223160257220.png" alt="image-20220223160257220"></p>
<p><img src="/../img/image-20220223160309330.png" alt="image-20220223160309330"></p>
<p><img src="/../img/image-20220223160314120.png" alt="image-20220223160314120"></p>
<p>用compass查看</p>
<p><img src="/../img/image-20220223160401455.png" alt="image-20220223160401455"></p>
<h1 id="10-文章评论"><a href="#10-文章评论" class="headerlink" title="10.文章评论"></a>10.文章评论</h1><h2 id="1-表结构分析"><a href="#1-表结构分析" class="headerlink" title="1.表结构分析"></a>1.表结构分析</h2><p><img src="/../img/image-20220223160821760.png" alt="image-20220223160821760"></p>
<h2 id="2-技术选型"><a href="#2-技术选型" class="headerlink" title="2.技术选型"></a>2.技术选型</h2><p><img src="/../img/image-20220223160858066.png" alt="image-20220223160858066"></p>
<h2 id="3-搭建"><a href="#3-搭建" class="headerlink" title="3.搭建"></a>3.搭建</h2><h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>article<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="comment"># 主机地址</span></span><br><span class="line">      <span class="comment">#host: 180.76.159.126</span></span><br><span class="line">      <span class="comment"># 数据库</span></span><br><span class="line">      <span class="comment">#database: articledb</span></span><br><span class="line">      <span class="comment"># 默认端口是27017</span></span><br><span class="line">      <span class="comment">#port: 27017</span></span><br><span class="line">      <span class="comment">#也可以使用uri连接</span></span><br><span class="line">      <span class="comment">#uri: mongodb://192.168.214.130:27017/article</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://bobo:123456@180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=myrs</span></span><br></pre></td></tr></table></figure>

<h3 id="创建启动类"><a href="#创建启动类" class="headerlink" title="创建启动类"></a>创建启动类</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package cn.itcast.article;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class ArticleApplication &#123;</span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">SpringApplication.run(ArticleApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-文章评论实体类的编写"><a href="#4-文章评论实体类的编写" class="headerlink" title="4.文章评论实体类的编写"></a>4.文章评论实体类的编写</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.po;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.Indexed;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Field;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 文章评论实体类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span></span><br><span class="line"><span class="comment">//@Document(collection=&quot;mongodb 对应 collection 名&quot;)</span></span><br><span class="line"><span class="comment">// 若未加 @Document ，该 bean save 到 mongo 的 comment collection</span></span><br><span class="line"><span class="comment">// 若添加 @Document ，则 save 到 comment collection</span></span><br><span class="line"><span class="meta">@Document(collection=&quot;comment&quot;)</span><span class="comment">//可以省略，如果省略，则默认使用类名小写映射集合</span></span><br><span class="line"><span class="comment">//复合索引</span></span><br><span class="line"><span class="comment">// @CompoundIndex( def = &quot;&#123;&#x27;userid&#x27;: 1, &#x27;nickname&#x27;: -1&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="comment">//主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span></span><br><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="keyword">private</span> String id;<span class="comment">//主键</span></span><br><span class="line"><span class="comment">//该属性对应mongodb的字段的名字，如果一致，则无需该注解</span></span><br><span class="line"><span class="meta">@Field(&quot;content&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String content;<span class="comment">//吐槽内容</span></span><br><span class="line"><span class="keyword">private</span> Date publishtime;<span class="comment">//发布日期</span></span><br><span class="line"><span class="comment">//添加了一个单字段的索引</span></span><br><span class="line"><span class="meta">@Indexed</span></span><br><span class="line"><span class="keyword">private</span> String userid;<span class="comment">//发布人ID</span></span><br><span class="line"><span class="keyword">private</span> String nickname;<span class="comment">//昵称</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime createdatetime;<span class="comment">//评论的日期时间</span></span><br><span class="line"><span class="keyword">private</span> Integer likenum;<span class="comment">//点赞数</span></span><br><span class="line"><span class="keyword">private</span> Integer replynum;<span class="comment">//回复数</span></span><br><span class="line"><span class="keyword">private</span> String state;<span class="comment">//状态</span></span><br><span class="line"><span class="keyword">private</span> String parentid;<span class="comment">//上级ID</span></span><br><span class="line"><span class="keyword">private</span> String articleid;</span><br><span class="line"><span class="comment">//getter and setter.....</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.id = id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.content = content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">getPublishtime</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> publishtime;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPublishtime</span><span class="params">(Date publishtime)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.publishtime = publishtime;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> userid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserid</span><span class="params">(String userid)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.userid = userid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getNickname</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> nickname;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNickname</span><span class="params">(String nickname)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.nickname = nickname;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getCreatedatetime</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> createdatetime;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreatedatetime</span><span class="params">(LocalDateTime createdatetime)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.createdatetime = createdatetime;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">getLikenum</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> likenum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLikenum</span><span class="params">(Integer likenum)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.likenum = likenum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">getReplynum</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> replynum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReplynum</span><span class="params">(Integer replynum)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.replynum = replynum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.state = state;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getParentid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> parentid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParentid</span><span class="params">(String parentid)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.parentid = parentid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getArticleid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> articleid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setArticleid</span><span class="params">(String articleid)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.articleid = articleid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Comment&#123;&quot;</span> +</span><br><span class="line"><span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line"><span class="string">&quot;, content=&#x27;&quot;</span> + content + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line"><span class="string">&quot;, publishtime=&quot;</span> + publishtime +</span><br><span class="line"><span class="string">&quot;, userid=&#x27;&quot;</span> + userid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line"><span class="string">&quot;, nickname=&#x27;&quot;</span> + nickname + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line"><span class="string">&quot;, createdatetime=&quot;</span> + createdatetime +</span><br><span class="line"><span class="string">&quot;, likenum=&quot;</span> + likenum +</span><br><span class="line"><span class="string">&quot;, replynum=&quot;</span> + replynum +</span><br><span class="line"><span class="string">&quot;, state=&#x27;&quot;</span> + state + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line"><span class="string">&quot;, parentid=&#x27;&quot;</span> + parentid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line"><span class="string">&quot;, articleid=&#x27;&quot;</span> + articleid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line"><span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220223162751289.png" alt="image-20220223162751289"></p>
<h2 id="5-文章评论的基本增删改查"><a href="#5-文章评论的基本增删改查" class="headerlink" title="5.文章评论的基本增删改查"></a>5.文章评论的基本增删改查</h2><h3 id="1-创建数据访问接口-cn-itcast-article包下创建dao包，包下创建接口-cn-itcast-article-dao-CommentRepository"><a href="#1-创建数据访问接口-cn-itcast-article包下创建dao包，包下创建接口-cn-itcast-article-dao-CommentRepository" class="headerlink" title="1.创建数据访问接口 cn.itcast.article包下创建dao包，包下创建接口 cn.itcast.article.dao.CommentRepository"></a>1.创建数据访问接口 cn.itcast.article包下创建dao包，包下创建接口 cn.itcast.article.dao.CommentRepository</h3><p>MongoRepository&lt;实体类,id类型&gt;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.dao;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;</span><br><span class="line"><span class="comment">//评论的持久层接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CommentRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Comment</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-创建业务逻辑类-cn-itcast-article包下创建service包，包下创建类-cn-itcast-article-service-CommentService"><a href="#2-创建业务逻辑类-cn-itcast-article包下创建service包，包下创建类-cn-itcast-article-service-CommentService" class="headerlink" title="2.创建业务逻辑类 cn.itcast.article包下创建service包，包下创建类 cn.itcast.article.service.CommentService"></a>2.创建业务逻辑类 cn.itcast.article包下创建service包，包下创建类 cn.itcast.article.service.CommentService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.service;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.dao.CommentRepository;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">//评论的业务层</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentService</span> </span>&#123;</span><br><span class="line"><span class="comment">//注入dao</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CommentRepository commentRepository;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 保存一个评论</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> comment</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveComment</span><span class="params">(Comment comment)</span></span>&#123;</span><br><span class="line"><span class="comment">//如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB会自动生成主键</span></span><br><span class="line"><span class="comment">//设置一些默认初始值。。。</span></span><br><span class="line"><span class="comment">//调用dao</span></span><br><span class="line">commentRepository.save(comment);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 更新评论</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> comment</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateComment</span><span class="params">(Comment comment)</span></span>&#123;</span><br><span class="line"><span class="comment">//调用dao</span></span><br><span class="line">commentRepository.save(comment);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据id删除评论</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteCommentById</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line"><span class="comment">//调用dao</span></span><br><span class="line">commentRepository.deleteById(id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 查询所有评论</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Comment&gt; <span class="title">findCommentList</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//调用dao</span></span><br><span class="line"><span class="keyword">return</span> commentRepository.findAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据id查询评论</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Comment <span class="title">findCommentById</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line"><span class="comment">//调用dao</span></span><br><span class="line"><span class="keyword">return</span> commentRepository.findById(id).get();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-新建Junit测试类，测试保存和查询所有：-cn-itcast-article-service-CommentServiceTest"><a href="#3-新建Junit测试类，测试保存和查询所有：-cn-itcast-article-service-CommentServiceTest" class="headerlink" title="3.新建Junit测试类，测试保存和查询所有： cn.itcast.article.service.CommentServiceTest"></a>3.新建Junit测试类，测试保存和查询所有： cn.itcast.article.service.CommentServiceTest</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.service;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.ArticleApplication;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">//测试评论的业务层</span></span><br><span class="line"><span class="comment">//SpringBoot的Junit集成测试</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="comment">//SpringBoot的测试环境初始化，参数：启动类</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ArticleApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentServiceTest</span> </span>&#123;</span><br><span class="line"><span class="comment">//注入Service</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CommentService commentService;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 保存一个评论</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSaveComment</span><span class="params">()</span></span>&#123;</span><br><span class="line">Comment comment=<span class="keyword">new</span> Comment();</span><br><span class="line">comment.setArticleid(<span class="string">&quot;100000&quot;</span>);</span><br><span class="line">comment.setContent(<span class="string">&quot;测试添加的数据&quot;</span>);</span><br><span class="line">comment.setCreatedatetime(LocalDateTime.now());</span><br><span class="line">comment.setUserid(<span class="string">&quot;1003&quot;</span>);</span><br><span class="line">comment.setNickname(<span class="string">&quot;凯撒大帝&quot;</span>);</span><br><span class="line">comment.setState(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">comment.setLikenum(<span class="number">0</span>);</span><br><span class="line">comment.setReplynum(<span class="number">0</span>);</span><br><span class="line">commentService.saveComment(comment);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 查询所有数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">List&lt;Comment&gt; list = commentService.findCommentList();</span><br><span class="line">System.out.println(list);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 测试根据id查询</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindCommentById</span><span class="params">()</span></span>&#123;</span><br><span class="line">Comment comment = commentService.findCommentById(<span class="string">&quot;5d6a27b81b8d374798cf0b41&quot;</span>);</span><br><span class="line">System.out.println(comment);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220223163230210.png" alt="image-20220223163230210"></p>
<h2 id="6-根据上级ID查询文章评论的分页列表"><a href="#6-根据上级ID查询文章评论的分页列表" class="headerlink" title="6.根据上级ID查询文章评论的分页列表"></a>6.根据上级ID查询文章评论的分页列表</h2><p>这里有两个只是点，一个条件查询，另一个是分页</p>
<h3 id="1-CommentRepository新增方法定义"><a href="#1-CommentRepository新增方法定义" class="headerlink" title="1.CommentRepository新增方法定义"></a>1.CommentRepository新增方法定义</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//根据父id，查询子评论的分页列表,根据什么查询，起名就By什么</span><br><span class="line">Page&lt;Comment&gt; findByParentid(String parentid, Pageable pageable);</span><br></pre></td></tr></table></figure>

<h3 id="2-CommentService新增方法"><a href="#2-CommentService新增方法" class="headerlink" title="2.CommentService新增方法"></a>2.CommentService新增方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据父id查询分页列表</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> parentid</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Comment&gt; <span class="title">findCommentListPageByParentid</span><span class="params">(String parentid,<span class="keyword">int</span> page ,<span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> commentRepository.findByParentid(parentid, PageRequest.of(page-<span class="number">1</span>,size));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-junit测试用例：-cn-itcast-article-service-CommentServiceTest"><a href="#3-junit测试用例：-cn-itcast-article-service-CommentServiceTest" class="headerlink" title="3.junit测试用例： cn.itcast.article.service.CommentServiceTest"></a>3.junit测试用例： cn.itcast.article.service.CommentServiceTest</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 测试根据父id查询子评论的分页列表</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindCommentListPageByParentid</span><span class="params">()</span></span>&#123;</span><br><span class="line">Page&lt;Comment&gt; pageResponse = commentService.findCommentListPageByParentid(<span class="string">&quot;3&quot;</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;----总记录数：&quot;</span>+pageResponse.getTotalElements());</span><br><span class="line">System.out.println(<span class="string">&quot;----当前页数据：&quot;</span>+pageResponse.getContent());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="7-MongoTemplate实现评论点赞"><a href="#7-MongoTemplate实现评论点赞" class="headerlink" title="7.MongoTemplate实现评论点赞"></a>7.MongoTemplate实现评论点赞</h2><p>我们可以使用MongoTemplate类来实现对某列的操作</p>
<h3 id="1-修改CommentService"><a href="#1-修改CommentService" class="headerlink" title="1.修改CommentService"></a>1.修改CommentService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//注入MongoTemplate</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 点赞数+1</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCommentLikenum</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line"><span class="comment">//查询对象，where(mongodb主键名称)=参数的时候</span></span><br><span class="line">Query query=Query.query(Criteria.where(<span class="string">&quot;_id&quot;</span>).is(id));</span><br><span class="line"><span class="comment">//更新对象</span></span><br><span class="line">Update update=<span class="keyword">new</span> Update();</span><br><span class="line"><span class="comment">//局部更新，相当于$set</span></span><br><span class="line"><span class="comment">// update.set(key,value)</span></span><br><span class="line"><span class="comment">//递增$inc</span></span><br><span class="line"><span class="comment">// update.inc(&quot;likenum&quot;,1);</span></span><br><span class="line">update.inc(<span class="string">&quot;likenum&quot;</span>);</span><br><span class="line"><span class="comment">//参数1：查询对象</span></span><br><span class="line"><span class="comment">//参数2：更新对象</span></span><br><span class="line"><span class="comment">//参数3：集合的名字或实体类的类型Comment.class</span></span><br><span class="line">mongoTemplate.updateFirst(query,update,<span class="string">&quot;comment&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中，query条件可以一直添加</p>
<p><img src="/../img/image-20220223165103157.png" alt="image-20220223165103157"></p>
<h3 id="2-测试用例"><a href="#2-测试用例" class="headerlink" title="2.测试用例"></a>2.测试用例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 点赞数+1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateCommentLikenum</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//对3号文档的点赞数+1</span></span><br><span class="line">commentService.updateCommentLikenum(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220223164740606.png" alt="image-20220223164740606"></p>
<h1 id="11-MongoDB集群和安全"><a href="#11-MongoDB集群和安全" class="headerlink" title="11.MongoDB集群和安全"></a>11.MongoDB集群和安全</h1><p>这部分未看，太多了。。</p>
<p>mongodb day02视频，结合资料里的笔记和hexo</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql</title>
    <url>/2021/11/30/mysql/</url>
    <content><![CDATA[<h1 id="详细链接"><a href="#详细链接" class="headerlink" title="详细链接"></a>详细链接</h1><p><a href="https://blog.csdn.net/qq_34115899/article/details/81190461">https://blog.csdn.net/qq_34115899/article/details/81190461</a></p>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><h2 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h2><p>插入一行<br>insert into student(<code>NAME</code>)VALUES(‘aa’)</p>
<p>插入多行<br>insert into student(<code>NAME</code>)VALUES(‘dd’),(‘bb’),(‘cc’)</p>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p>update 表名 a set a=? where </p>
<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p>①delete from 表名 where id =1</p>
<p>注：不写条件的话删除整个表数据了    自增不归0</p>
<p>②truncate  完全清空一个表数据，列和索引的属性不会变</p>
<p>truncate  表名    自增会归0</p>
<p>③根据时间删除，需要给定前后两段时间</p>
<p>delete from NBD_STA_GANTRY_CABINET where SCAN_START_TIME&gt;=’2017-01-01 00:00:00’ AND SCAN_START_TIME&lt;=’2021-12-30 00:00:03’</p>
<h1 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h1><h2 id="生成一个伪列从1到查出的数据总数"><a href="#生成一个伪列从1到查出的数据总数" class="headerlink" title="生成一个伪列从1到查出的数据总数"></a>生成一个伪列从1到查出的数据总数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">	(@rownum := @rownum + 1) AS rownum,</span><br><span class="line">	b.*</span><br><span class="line">FROM</span><br><span class="line">	(</span><br><span class="line">		SELECT</span><br><span class="line">			a.dic_key dicKey,</span><br><span class="line">			a.dic_value dicValue</span><br><span class="line">		FROM</span><br><span class="line">			NBD_RES_STANDARD_DIC a</span><br><span class="line">		WHERE</span><br><span class="line">			a.field_group = &#x27;eqp_object_class&#x27;</span><br><span class="line">		AND a.VALUE_GROUP IN (2, 3, 4)</span><br><span class="line">	) b,</span><br><span class="line">	(SELECT @rownum := 0) r</span><br></pre></td></tr></table></figure>


<h2 id="时间相关-转数字，转字符"><a href="#时间相关-转数字，转字符" class="headerlink" title="时间相关 转数字，转字符"></a>时间相关 转数字，转字符</h2><p><img src="/../img/image-20211202225020986.png" alt="image-20211202225020986"></p>
<h2 id="转数字，转字符"><a href="#转数字，转字符" class="headerlink" title="转数字，转字符"></a>转数字，转字符</h2><p> TO_CHAR():<br>CAST(123   AS   CHAR(3)) </p>
<p>select CAST(202 AS CHAR)  from dual</p>
<p>TO_NUMBER():<br>cast( ‘123 ‘   as   SIGNED   INTEGER) </p>
<h2 id="获取当前时间"><a href="#获取当前时间" class="headerlink" title="获取当前时间"></a>获取当前时间</h2><p>sysdate()==》 yyyy-MM-dd HH:mm:ss<br>CURRENT_TIME==》HH:mm:ss<br>current_date()==》   yyyy-MM-dd<br>now() ==》 yyyy-MM-dd HH:mm:ss</p>
<h2 id="时间戳换算成日期-yyyy-MM-dd-HH-mm-ss"><a href="#时间戳换算成日期-yyyy-MM-dd-HH-mm-ss" class="headerlink" title="时间戳换算成日期 yyyy-MM-dd HH:mm:ss"></a>时间戳换算成日期 yyyy-MM-dd HH:mm:ss</h2><p>FROM_UNIXTIME()</p>
<h2 id="代码中相关时间"><a href="#代码中相关时间" class="headerlink" title="代码中相关时间"></a>代码中相关时间</h2><p>@JsonFormat(pattern = “yyyy-MM-dd HH:mm:ss”)<br>private Date startTime;</p>
<p>mapper里直接</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;if test=&quot;null != startTime&quot;&gt;</span><br><span class="line">    AND p.START_TIME &amp;gt; #&#123;startTime&#125;</span><br><span class="line">&lt;/if&gt;</span><br></pre></td></tr></table></figure>
<h2 id="获取年月日时分秒"><a href="#获取年月日时分秒" class="headerlink" title="获取年月日时分秒"></a>获取年月日时分秒</h2><p>DATE_FORMAT(a.date,’%Y-%m-%d %H:%i:%s’)<br>可以单独获取年or日等等</p>
<h2 id="获取当前一小时以前"><a href="#获取当前一小时以前" class="headerlink" title="获取当前一小时以前"></a>获取当前一小时以前</h2><p>select DATE_SUB(NOW(),INTERVAL  1 HOUR) from DUAL</p>
<h2 id="获取近7天的数据"><a href="#获取近7天的数据" class="headerlink" title="获取近7天的数据"></a>获取近7天的数据</h2><p>DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= DATE(date_time)</p>
<h2 id="ifnull空值转换"><a href="#ifnull空值转换" class="headerlink" title="ifnull空值转换"></a>ifnull空值转换</h2><h2 id="decode"><a href="#decode" class="headerlink" title="decode"></a>decode</h2><p><strong>decode(expression,value,result1,result2)</strong><br>如果expression=value，则输出result1，否则输出result2</p>
<p><strong>decode(expression,value1,result1,value2,result2,value3,result3……,default)</strong><br>expression=value1，则输出result1，expression=value2，输出reslut2，expression=value3，输出result3，若expression不等于所列出的所有value，则输出为default</p>
<h2 id="左连接"><a href="#左连接" class="headerlink" title="左连接"></a>左连接</h2><p>没有where条件，已a表为基准，查出来的数据条数是a的条数<br>如果有where条件，查出来的结果最终是where条件成立的条数<br>字典值等用此方法比较简单</p>
<h2 id="round-a-b"><a href="#round-a-b" class="headerlink" title="round(a,b)"></a>round(a,b)</h2><p>ROUND(1.323123,2)==》 1.32 四舍五入</p>
<h2 id="Concat-a-b-拼接"><a href="#Concat-a-b-拼接" class="headerlink" title="Concat(a,b)拼接"></a>Concat(a,b)拼接</h2><h2 id="pom与application"><a href="#pom与application" class="headerlink" title="pom与application"></a>pom与application</h2><h3 id="平时自己"><a href="#平时自己" class="headerlink" title="平时自己"></a>平时自己</h3><p>application</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">    url: jdbc:mysql://localhost:3306/school?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span><br><span class="line">	druid:</span><br><span class="line">      driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">      username: root</span><br><span class="line">      password: root</span><br><span class="line">      max-active: 100</span><br><span class="line">      min-idle: 10</span><br><span class="line">      initial-size: 5</span><br><span class="line">      max-wait: 5000</span><br><span class="line">	  </span><br></pre></td></tr></table></figure>
<p>pom</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--druid数据源--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.10&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;8.0.15&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="数学运算"><a href="#数学运算" class="headerlink" title="数学运算"></a>数学运算</h2><h4 id="ABS-8-–绝对值"><a href="#ABS-8-–绝对值" class="headerlink" title="ABS(-8) –绝对值"></a>ABS(-8) –绝对值</h4><h4 id="ceiling-9-4-–向上取整"><a href="#ceiling-9-4-–向上取整" class="headerlink" title="ceiling(9.4) –向上取整"></a>ceiling(9.4) –向上取整</h4><h4 id="floor（9-4）–向下取整"><a href="#floor（9-4）–向下取整" class="headerlink" title="floor（9.4）–向下取整"></a>floor（9.4）–向下取整</h4><h4 id="rand（）–返回【0-1）的随机数"><a href="#rand（）–返回【0-1）的随机数" class="headerlink" title="rand（）–返回【0,1）的随机数"></a>rand（）–返回【0,1）的随机数</h4><h4 id="RAND-m-n-n-返回-n-m-之间的数"><a href="#RAND-m-n-n-返回-n-m-之间的数" class="headerlink" title="RAND()*(m-n)+n:返回[n,m)之间的数"></a>RAND()*(m-n)+n:返回[n,m)之间的数</h4><h4 id="sign（num）num-0，返回0，num-正数，返回1，num-负数，返回-1"><a href="#sign（num）num-0，返回0，num-正数，返回1，num-负数，返回-1" class="headerlink" title="sign（num）num=0，返回0，num=正数，返回1，num=负数，返回-1"></a>sign（num）num=0，返回0，num=正数，返回1，num=负数，返回-1</h4><h4 id="char-length-str-–str长度"><a href="#char-length-str-–str长度" class="headerlink" title="char_length(str)–str长度"></a>char_length(str)–str长度</h4><h4 id="LOWER-Str-–小写"><a href="#LOWER-Str-–小写" class="headerlink" title="LOWER(Str)–小写"></a>LOWER(Str)–小写</h4><h4 id="UPPER-Str-–大写"><a href="#UPPER-Str-–大写" class="headerlink" title="UPPER(Str)–大写"></a>UPPER(Str)–大写</h4><h4 id="REPLACE-‘abcde’-’b’-’ee’-–把b替换成ee"><a href="#REPLACE-‘abcde’-’b’-’ee’-–把b替换成ee" class="headerlink" title="REPLACE(‘abcde’,’b’,’ee’)–把b替换成ee"></a>REPLACE(‘abcde’,’b’,’ee’)–把b替换成ee</h4><h2 id="除法"><a href="#除法" class="headerlink" title="除法"></a>除法</h2><p>select ROUND(10/20,2) from dual </p>
<h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><table>
<thead>
<tr>
<th>函数名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>count（）</td>
<td>计数</td>
</tr>
<tr>
<td>sum（）</td>
<td>求和</td>
</tr>
<tr>
<td>avg（）</td>
<td>平均</td>
</tr>
<tr>
<td>max（）</td>
<td>最大值</td>
</tr>
<tr>
<td>min（）</td>
<td>最小值</td>
</tr>
<tr>
<td>count(字段）忽略null值</td>
<td></td>
</tr>
<tr>
<td>count(*)   不忽略null值  ,</td>
<td></td>
</tr>
<tr>
<td>count(1)   不忽略null值</td>
<td></td>
</tr>
<tr>
<td>group by 查的字段应该有聚合函数</td>
<td></td>
</tr>
</tbody></table>
<h2 id="case选择判断函数"><a href="#case选择判断函数" class="headerlink" title="case选择判断函数"></a>case选择判断函数</h2><p>第一种：CASE WHEN a.？=？THEN 1 ELSE 0 END</p>
<p>第二种 case a when 1 then ‘a’ when 2 then ‘b’ else ‘c’ end</p>
<h2 id="1-foreach用法"><a href="#1-foreach用法" class="headerlink" title="1.foreach用法"></a>1.foreach用法</h2><h3 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;insert id=&quot;insertBatch&quot;&gt;</span><br><span class="line">        INSERT INTO t_user</span><br><span class="line">        (id, name, password)</span><br><span class="line">        VALUES</span><br><span class="line">        &lt;foreach collection =&quot;userList&quot; item=&quot;user&quot; separator =&quot;,&quot;&gt;</span><br><span class="line">            (#&#123;id&#125;, #&#123;name&#125;, #&#123;password&#125;)</span><br><span class="line">        &lt;/foreach &gt;</span><br><span class="line">    &lt;/insert&gt;</span><br></pre></td></tr></table></figure>

<h3 id><a href="#" class="headerlink" title></a></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;foreach collection=&quot;list&quot; item=&quot;item&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot; index=&quot;i&quot;&gt;</span><br><span class="line">	#&#123;item&#125;</span><br><span class="line">&lt;/foreach&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>where (  (a=b) or (a=b)  )</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;if test=&quot;idAndPort!=null&quot;&gt;</span><br><span class="line">and</span><br><span class="line">    &lt;foreach collection=&quot;idAndPort&quot; item=&quot;item&quot; open=&quot;(&quot; separator=&quot;or&quot; close=&quot;)&quot; index=&quot;i&quot;&gt;</span><br><span class="line">        (a.ne_id=#&#123;item.id&#125; and a.unit_id=#&#123;item.port&#125;)</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">&lt;/if&gt;</span><br></pre></td></tr></table></figure>

<h3 id="也可以不用逗号分隔"><a href="#也可以不用逗号分隔" class="headerlink" title="也可以不用逗号分隔"></a>也可以不用逗号分隔</h3><p>separator=”or”</p>
<h2 id="想要控制台打印sql"><a href="#想要控制台打印sql" class="headerlink" title="想要控制台打印sql"></a>想要控制台打印sql</h2><p>pom</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.slf4j/slf4j-api --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.7.25&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>yml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    root: info</span><br><span class="line">    com.jiang.mybatisplus.mapper: debug</span><br></pre></td></tr></table></figure>

<h2 id="数据库对应java类"><a href="#数据库对应java类" class="headerlink" title="数据库对应java类"></a>数据库对应java类</h2><table>
<thead>
<tr>
<th>数据库</th>
<th>代码</th>
</tr>
</thead>
<tbody><tr>
<td>bigint</td>
<td>Long</td>
</tr>
<tr>
<td>int</td>
<td>Integer</td>
</tr>
<tr>
<td>FLOAT</td>
<td>Double</td>
</tr>
</tbody></table>
<h2 id="长度"><a href="#长度" class="headerlink" title="长度"></a>长度</h2><p>数字型</p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>大小</strong></th>
<th><strong>范围（有符号）</strong></th>
<th><strong>范围（无符号）</strong></th>
<th><strong>用途</strong></th>
</tr>
</thead>
<tbody><tr>
<td>TINYINT</td>
<td>1 字节</td>
<td>(-128,127)</td>
<td>(0,255)</td>
<td>小整数值</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>2 字节</td>
<td>(-32768,32767)</td>
<td>(0,65535)</td>
<td>大整数值</td>
</tr>
<tr>
<td>MEDIUMINT</td>
<td>3 字节</td>
<td>(-8388608,8388607)</td>
<td>(0,16777215)</td>
<td>大整数值</td>
</tr>
<tr>
<td>INT或INTEGER</td>
<td>4 字节</td>
<td>(-2147483648,2147483647)</td>
<td>(0,4294967295)</td>
<td>大整数值</td>
</tr>
<tr>
<td>BIGINT</td>
<td>8 字节</td>
<td>(-9223372036854775808，9223372036854775807)</td>
<td>(0,18446744073709551615)</td>
<td>极大整数值</td>
</tr>
<tr>
<td>FLOAT</td>
<td>4 字节</td>
<td></td>
<td></td>
<td>单精度 浮点数值</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>8 字节</td>
<td></td>
<td></td>
<td>双精度 浮点数值</td>
</tr>
</tbody></table>
<p>字符类型</p>
<table>
<thead>
<tr>
<th>CHAR</th>
<th>0-255字节</th>
<th>定长字符串</th>
</tr>
</thead>
<tbody><tr>
<td>VARCHAR</td>
<td>0-255字节</td>
<td>变长字符串</td>
</tr>
<tr>
<td>TINYBLOB</td>
<td>0-255字节</td>
<td>不超过 255 个字符的二进制字符串</td>
</tr>
<tr>
<td>TINYTEXT</td>
<td>0-255字节</td>
<td>短文本字符串</td>
</tr>
<tr>
<td>BLOB</td>
<td>0-65 535字节</td>
<td>二进制形式的长文本数据</td>
</tr>
<tr>
<td>TEXT</td>
<td>0-65 535字节</td>
<td>长文本数据</td>
</tr>
<tr>
<td>MEDIUMBLOB</td>
<td>0-16 777 215字节</td>
<td>二进制形式的中等长度文本数据</td>
</tr>
<tr>
<td>MEDIUMTEXT</td>
<td>0-16 777 215字节</td>
<td>中等长度文本数据</td>
</tr>
<tr>
<td>LOGNGBLOB</td>
<td>0-4 294 967 295字节</td>
<td>二进制形式的极大文本数据</td>
</tr>
<tr>
<td>LONGTEXT</td>
<td>0-4 294 967 295字节</td>
<td>极大文本数据</td>
</tr>
</tbody></table>
<h2 id="2-根据不同条件拼接不同sql-重点"><a href="#2-根据不同条件拼接不同sql-重点" class="headerlink" title="2.根据不同条件拼接不同sql(重点)"></a>2.根据不同条件拼接不同sql(重点)</h2><h3 id="choose-or的关系"><a href="#choose-or的关系" class="headerlink" title="choose or的关系"></a>choose or的关系</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;where&gt;</span><br><span class="line">            &lt;choose&gt;</span><br><span class="line">                &lt;when test=&quot;isUpdate !=null &quot;&gt;</span><br><span class="line">                    AND u.is_update = #&#123;isUpdate, jdbcType=INTEGER&#125;</span><br><span class="line">                &lt;/when&gt;</span><br><span class="line">                &lt;when test=&quot;isDelete != null&quot;&gt;</span><br><span class="line">                    AND u.is_delete = #&#123;isDelete, jdbcType=INTEGER&#125;</span><br><span class="line">                &lt;/when&gt;</span><br><span class="line">                &lt;otherwise&gt;</span><br><span class="line">                &lt;/otherwise&gt;</span><br><span class="line">            &lt;/choose&gt;</span><br><span class="line">            &lt;if test=&quot;tableColumnId != null&quot;&gt;</span><br><span class="line">               AND table_column_id = #&#123;tableColumnId&#125;</span><br><span class="line">            &lt;/if&gt;</span><br><span class="line">        &lt;/where&gt;</span><br></pre></td></tr></table></figure>
<h3 id="like"><a href="#like" class="headerlink" title="like"></a>like</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;if test=&quot;thresholdQO.titel!=null and &#x27;&#x27; !=thresholdQO.titel&quot;&gt;</span><br><span class="line">            &lt;bind name=&quot;titel&quot; value=&quot;&#x27;%&#x27; + thresholdQO.titel + &#x27;%&#x27;&quot; /&gt;</span><br><span class="line">            AND a.title LIKE #&#123;titel&#125;</span><br><span class="line">        &lt;/if&gt;</span><br></pre></td></tr></table></figure>
<h2 id="字符串拆分"><a href="#字符串拆分" class="headerlink" title="字符串拆分"></a>字符串拆分</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">str = &#x27;www.baidu.com&#x27;;</span><br><span class="line"></span><br><span class="line">SELECT substring_index(&#x27;www.baidu.com&#x27;,&#x27;.&#x27;, 1);    #www</span><br><span class="line"></span><br><span class="line">SELECT substring_index(&#x27;www.baidu.com&#x27;,&#x27;.&#x27;, 2);    #www.baidu</span><br><span class="line"></span><br><span class="line">SELECT substring_index(&#x27;www.baidu.com&#x27;,&#x27;.&#x27;, -1);   #com</span><br><span class="line"></span><br><span class="line">SELECT substring_index(&#x27;www.baidu.com&#x27;,&#x27;.&#x27;, -2);   #baidu.com</span><br><span class="line"></span><br><span class="line">SELECT substring_index(substring_index(&#x27;www.baidu.com&#x27;,&#x27;.&#x27;, -2), &#x27;.&#x27;, 1);  #baidu</span><br></pre></td></tr></table></figure>
<h2 id="3-mapper的test里判断"><a href="#3-mapper的test里判断" class="headerlink" title="3.mapper的test里判断"></a>3.mapper的test里判断</h2><h3 id="是否包含"><a href="#是否包含" class="headerlink" title="是否包含"></a>是否包含</h3><if test="tableName.contains("monitor")">

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;if test=&quot;level!=null&quot;&gt;</span><br><span class="line">    and a.level=#&#123;level&#125;</span><br><span class="line">&lt;/if&gt;</span><br><span class="line"></span><br><span class="line">&lt;if test=&quot;performanceQO.eqpName!=null and &#x27;&#x27; !=performanceQO.eqpName&quot;&gt;</span><br><span class="line">                &lt;bind name=&quot;name&quot; value=&quot;&#x27;%&#x27; + performanceQO.eqpName + &#x27;%&#x27;&quot; /&gt;</span><br><span class="line">                AND b.name LIKE #&#123;name&#125;</span><br><span class="line">            &lt;/if&gt;</span><br></pre></td></tr></table></figure>

<p>集合判断</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;if test=&quot;list!=null and list.size &gt; 0&quot;&gt;</span><br><span class="line">    EQP_OBJECT_CLASS IN</span><br><span class="line">    &lt;foreach collection=&quot;list&quot; item=&quot;item&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot; index=&quot;i&quot;&gt;</span><br><span class="line">        #&#123;item&#125;</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">&lt;/if&gt;</span><br></pre></td></tr></table></figure>

<h3 id="是否等于，注意是-不是"><a href="#是否等于，注意是-不是" class="headerlink" title="是否等于，注意是==不是="></a>是否等于，注意是==不是=</h3><when test="name == 'alarm_level' ">

<h2 id="自增重新从1开始"><a href="#自增重新从1开始" class="headerlink" title="自增重新从1开始"></a>自增重新从1开始</h2><p>方法1</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名称 auto_increment<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> #<span class="comment">--这种方法处理的好处就是 可以设置auto_increment 为任意值开始自增 #--提示：如果表列和数据很多，速度会很慢，如90多万条，会在10分钟以上, 所以注意使用场景</span></span><br></pre></td></tr></table></figure>

<p>方法2</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">truncate table 表名称</span><br><span class="line"><span class="comment">#--直接一句话搞定  好处就是简单，auto_increment值重新开始从1计数)</span></span><br></pre></td></tr></table></figure>

<p>重点注意 : 一般情况下我们使用第二个就可以了，记住以上情况都是彻底删除所有记录, 所以我们在设定之前要考虑周密，设计数据库表的时候也要考虑多方面因素!</p>
<h2 id="有时嵌套不好使"><a href="#有时嵌套不好使" class="headerlink" title="有时嵌套不好使"></a>有时嵌套不好使</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">delete from testaaa  where ID IN (</span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">b.id</span><br><span class="line">FROM</span><br><span class="line">	NBD_RES_GANTRY_EQUIPMENT a,</span><br><span class="line">	testaaa b</span><br><span class="line">WHERE</span><br><span class="line">	a.GANTRY_INFO_ID = b.GANTRY_INFO_ID</span><br><span class="line">AND a.EQP_OBJECT_CLASS = b.EQP_OBJECT_CLASS</span><br><span class="line">AND a.IP = b.ip</span><br><span class="line"></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="需要在内层多加一层嵌套"><a href="#需要在内层多加一层嵌套" class="headerlink" title="需要在内层多加一层嵌套"></a>需要在内层多加一层嵌套</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">delete from testaaa  where ID IN (</span><br><span class="line"></span><br><span class="line">SELECT C.ID FROM (SELECT</span><br><span class="line">b.id</span><br><span class="line">FROM</span><br><span class="line">	NBD_RES_GANTRY_EQUIPMENT a,</span><br><span class="line">	testaaa b</span><br><span class="line">WHERE</span><br><span class="line">	a.GANTRY_INFO_ID = b.GANTRY_INFO_ID</span><br><span class="line">AND a.EQP_OBJECT_CLASS = b.EQP_OBJECT_CLASS</span><br><span class="line">AND a.IP = b.ip) C</span><br><span class="line"></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="查询字段长度大于4的"><a href="#查询字段长度大于4的" class="headerlink" title="查询字段长度大于4的"></a>查询字段长度大于4的</h2><p>select * from test where LENGTH(ip)&gt;4</p>
<h2 id="CONVERT"><a href="#CONVERT" class="headerlink" title="CONVERT()"></a><em>CONVERT</em>()</h2><p><em>CONVERT</em>() 函数是把日期转换为新数据类型的通用函数</p>
<h2 id="去重distinct"><a href="#去重distinct" class="headerlink" title="去重distinct"></a>去重distinct</h2><p>1、根据全部字段的去重查询：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span></span><br></pre></td></tr></table></figure>

<p>2、根据某些字段的去重查询（不考虑查询其他字段）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> c_name,c_year,c_month <span class="keyword">from</span> <span class="keyword">table</span></span><br></pre></td></tr></table></figure>

<h2 id="4-sql语句查字段里包含某个字符串"><a href="#4-sql语句查字段里包含某个字符串" class="headerlink" title="4.sql语句查字段里包含某个字符串"></a>4.sql语句查字段里包含某个字符串</h2><p>mysql字符串函数 find_in_set(str1,str2)函数是返回str2中str1所在的位置索引，str2必须以”,”分割开</p>
<p>eg:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">    * </span><br><span class="line">from</span><br><span class="line">    NBD_STA_THRESHOLD </span><br><span class="line">WHERE</span><br><span class="line">   </span><br><span class="line">        FIND_IN_SET(&#x27;-7933595709262488213&#x27;,MANAGE_ID)&gt;0</span><br></pre></td></tr></table></figure>

<p>大于0代表str2中包含str1</p>
<h1 id="代码中application"><a href="#代码中application" class="headerlink" title="代码中application"></a>代码中application</h1><p>公司</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://10.12.1.50:3306/NBD_NT_RAILWAY?useSSL=false&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">    username: root</span><br><span class="line">    password: Boco.123</span><br><span class="line">    #type:</span><br><span class="line">    filters: stat</span><br><span class="line">    maxActive: 20</span><br><span class="line">    initialSize: 1</span><br><span class="line">    maxWait: 30000</span><br><span class="line">    minIdle: 1</span><br><span class="line">    timeBetweenEvictionRunsMillis: 60000</span><br><span class="line">    minEvictableIdleTimeMillis: 90000</span><br><span class="line">    validationQuery: SELECT 1 FROM DUAL</span><br><span class="line">    testWhileIdle: true</span><br><span class="line">    testOnBorrow: false</span><br><span class="line">    testOnReturn: false</span><br><span class="line">    poolPreparedStatements: true</span><br><span class="line">    maxOpenPreparedStatements: 20</span><br><span class="line">    connection-test-query: SELECT 1 FROM DUAL</span><br><span class="line">    #filters: stat,wall,log4j2</span><br><span class="line">    connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000</span><br></pre></td></tr></table></figure>

<p>自己</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    type: com.alibaba.druid.pool.DruidDataSource #使用druid数据源，替换C3P0</span><br><span class="line">    url: jdbc:mysql://localhost:3306/blog?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>



<h1 id="＜-CDATA-＞"><a href="#＜-CDATA-＞" class="headerlink" title="＜![CDATA[ ]]＞"></a>＜![CDATA[ ]]＞</h1><p>直接放入符号即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">EVENT_TIME&lt;![CDATA[&gt;=]]&gt;#&#123;startTime&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;gt;  替换   &gt;  </span><br><span class="line"></span><br><span class="line">&amp;lt;   替换  &lt;</span><br></pre></td></tr></table></figure>

<h1 id="数据库索引"><a href="#数据库索引" class="headerlink" title="数据库索引"></a>数据库索引</h1><p><a href="https://blog.csdn.net/qq_35190492/article/details/109257302?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164186154816781683935440%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164186154816781683935440&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-109257302.first_rank_v2_pc_rank_v29&amp;utm_term=mysql%E7%B4%A2%E5%BC%95&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/qq_35190492/article/details/109257302?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164186154816781683935440%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164186154816781683935440&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-109257302.first_rank_v2_pc_rank_v29&amp;utm_term=mysql%E7%B4%A2%E5%BC%95&amp;spm=1018.2226.3001.4187</a></p>
<h2 id="最左前缀匹配规则"><a href="#最左前缀匹配规则" class="headerlink" title="最左前缀匹配规则"></a>最左前缀匹配规则</h2><p>MySQL 建立联合索引的规则是这样的，它会首先根据联合索引中最左边的、也就是第一个字段进行排序，在第一个字段排序的基础上，再对联合索引中后面的第二个字段进行排序，依此类推。</p>
<p>综上，第一个字段是绝对有序的，从第二个字段开始是无序的，这就解释了为什么直接使用第二字段进行条件判断用不到索引了（从第二个字段开始，无序，无法走 B+ Tree 索引）！这也是 MySQL 在联合索引中强调最左前缀匹配原则的原因。</p>
<h3 id="explain-这个关键字"><a href="#explain-这个关键字" class="headerlink" title="explain 这个关键字"></a>explain 这个关键字</h3><p><img src="/../img/image-20220118165309899.png" alt="image-20220118165309899"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">注意我圈红的这仨字段，这是使用 explain 语句需要重点关注的字段</span><br><span class="line"></span><br><span class="line">type：访问类型，要是显示 ALL ，那你可要小心了，这是全表扫描的意思，性能最差，说明你的查询有很大的优化余地，如果显示的是 index ，说明会使用索引来优化查询。关于 type 的更多解释请参考这个文章 ：mysql中explain的type的解释</span><br><span class="line">key：具体使用的索引名，这里没有。</span><br><span class="line">rows：扫描的行数。</span><br><span class="line">Extra：index正在使用覆盖索引</span><br><span class="line">		where没有使用</span><br><span class="line"></span><br><span class="line">联合索引IDX(字段A,字段B,字段C,字段D)，当仅使用字段A查询时，索引IDX就会使用到；</span><br><span class="line"></span><br><span class="line">如果仅使用字段B或字段C或字段D查询，则索引IDX都不会用到。</span><br><span class="line"></span><br><span class="line">这个规则在oracle和mysql数据库中均成立。</span><br><span class="line"></span><br><span class="line">如果你经常要用到多个字段的多条件查询，可以考虑建立联合索引，一般是除第一个字段外的其它字段不经常用于条件筛选情况，比如说a,b 两个字段，如果你经常用a条件或者a+b条件去查询，而很少单独用b条件查询，那么可以建立a,b的联合索引。如果a和b都要分别经常独立的被用作查询条件，那还是建立多个单列索引。</span><br><span class="line"></span><br><span class="line">也就是说，如果建立了联合索引，那么就不用单独建立第一个字段的单独索引了</span><br></pre></td></tr></table></figure>

<h3 id="开始现在有一个表"><a href="#开始现在有一个表" class="headerlink" title="开始现在有一个表"></a>开始现在有一个表</h3><p><img src="/../img/image-20220118165357109.png" alt="image-20220118165357109"></p>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p><img src="/../img/image-20220118165833401.png" alt="image-20220118165833401"></p>
<h3 id="因为第一个字段是age，所以无需建立age单独索引"><a href="#因为第一个字段是age，所以无需建立age单独索引" class="headerlink" title="因为第一个字段是age，所以无需建立age单独索引"></a>因为第一个字段是age，所以无需建立age单独索引</h3><p><img src="/../img/image-20220118170634138.png" alt="image-20220118170634138"></p>
<p><img src="/../img/image-20220118170610546.png" alt="image-20220118170610546"></p>
<h3 id="只要查询条件里有age，不管age在前还是在后，那么就会走这个索引"><a href="#只要查询条件里有age，不管age在前还是在后，那么就会走这个索引" class="headerlink" title="只要查询条件里有age，不管age在前还是在后，那么就会走这个索引"></a>只要查询条件里有age，不管age在前还是在后，那么就会走这个索引</h3><h2 id="索引覆盖"><a href="#索引覆盖" class="headerlink" title="索引覆盖"></a>索引覆盖</h2><p>如果在一个场景下，select id,name,sex from user where name =’zhangsan’;这个语句在业务上频繁使用到，而user表的其他字段使用频率远低于它，在这种情况下，如果我们在建立 name 字段的索引的时候，不是使用单一索引，而是使用联合索引（name，sex）这样的话再执行这个查询语句是不是根据辅助索引查询到的结果就可以获取当前语句的完整数据。这样就可以有效地避免了回表再获取sex的数据。</p>
<p>这里就是一个典型的使用覆盖索引的优化策略减少回表的情况。</p>
<p>如果要查询的列，有主键id，索引a，普通值b，这时候可以把索引改为联合索引（a,b）,这样就不用回表查询了。</p>
<h2 id="回表查询"><a href="#回表查询" class="headerlink" title="回表查询"></a>回表查询</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">不是主键的索引，保存索引字段对应的值和主键值，在根据主键值查其他值，叫做回表查询</span><br></pre></td></tr></table></figure>

<h1 id="navicat导出数据库表结构为execl"><a href="#navicat导出数据库表结构为execl" class="headerlink" title="navicat导出数据库表结构为execl"></a>navicat导出数据库表结构为execl</h1><p>导出为sql简单，现在导出为execl</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">  COLUMN_NAME 列名,</span><br><span class="line">  COLUMN_TYPE 数据类型,</span><br><span class="line">    DATA_TYPE 字段类型,</span><br><span class="line">  CHARACTER_MAXIMUM_LENGTH 长度,</span><br><span class="line">  IS_NULLABLE 是否为空,</span><br><span class="line">  COLUMN_DEFAULT 默认值,</span><br><span class="line">  COLUMN_COMMENT 备注 </span><br><span class="line">FROM</span><br><span class="line"> INFORMATION_SCHEMA.COLUMNS</span><br><span class="line">where</span><br><span class="line">table_schema =&#x27;库名&#x27;</span><br><span class="line">AND</span><br><span class="line">table_name  = &#x27;表名&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220216143801637.png" alt="image-20220216143801637"></p>
<p>复制粘贴</p>
<p>最终效果，第一列标题自己手动添加</p>
<p><img src="/../img/image-20220216144021932.png" alt="image-20220216144021932"></p>
<h1 id="遍历map"><a href="#遍历map" class="headerlink" title="遍历map"></a>遍历map</h1><p><img src="/../img/image-20220324173633166.png" alt="image-20220324173633166"></p>
<p><img src="/../img/image-20220324173637693.png" alt="image-20220324173637693"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;select id=&quot;test&quot;&gt;</span><br><span class="line">        &lt;foreach collection=&quot;params&quot; index=&quot;key&quot;  item=&quot;value&quot;&gt;</span><br><span class="line">            AND $&#123;key&#125; = #&#123;value&#125;</span><br><span class="line">        &lt;/foreach&gt;</span><br><span class="line">    &lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;select id=&quot;test&quot;&gt;</span><br><span class="line">    &lt;foreach collection=&quot;params.entrySet()&quot; index=&quot;key&quot;  item=&quot;value&quot;&gt;</span><br><span class="line">        AND $&#123;key&#125; = #&#123;value&#125;</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<h1 id="遍历数组"><a href="#遍历数组" class="headerlink" title="遍历数组"></a>遍历数组</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;foreach collection=&quot;interfaceConfig.sortCondition&quot; item=&quot;value&quot; index=&quot;index&quot; separator=&quot;,&quot;&gt;</span><br><span class="line">    tp.$&#123;value&#125;</span><br><span class="line">&lt;/foreach&gt;</span><br></pre></td></tr></table></figure></when></if>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>shardingjdbc分库分表</title>
    <url>/2021/11/30/mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/</url>
    <content><![CDATA[<h1 id="1-主从复制（数据层面）"><a href="#1-主从复制（数据层面）" class="headerlink" title="1.主从复制（数据层面）"></a>1.主从复制（数据层面）</h1><p><img src="/../img/image-20220310083056231.png" alt="image-20220310083056231"></p>
<h2 id="1-原理"><a href="#1-原理" class="headerlink" title="1.原理"></a>1.原理</h2><p>主库的增删改的命令，记录到一个二进制文件Binary log中，通过tcp连接启动一个io线程读取二进制文件的命令，把命令写入到从库的终止日志Relay log中，从库启动一个sql线程，执行sql命令</p>
<p><img src="/../img/image-20220310083549865.png" alt="image-20220310083549865"></p>
<h2 id="2-搭建"><a href="#2-搭建" class="headerlink" title="2.搭建"></a>2.搭建</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Master节点配置/etc/my.cnf (master节点执行)</span><br><span class="line"></span><br><span class="line">&gt; vim /etc/my.cnf  直接复制粘贴</span><br><span class="line">[mysqld]</span><br><span class="line">## 同一局域网内注意要唯一</span><br><span class="line">server-id=100  </span><br><span class="line">## 开启二进制日志功能，可以随便取（关键）</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">## 复制过滤：不需要备份的数据库，不输出（mysql库一般不同步）</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存</span><br><span class="line">binlog_cache_size=1M</span><br><span class="line">## 主从复制的格式（mixed,statement,row，默认格式是statement）</span><br><span class="line">binlog_format=mixed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重启mysql</span><br><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Slave节点配置/etc/my.cnf (slave节点执行)</span><br><span class="line"></span><br><span class="line">&gt; vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">## 设置server_id,注意要唯一</span><br><span class="line">server-id=102</span><br><span class="line">## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用</span><br><span class="line">log-bin=mysql-slave-bin</span><br><span class="line">## relay_log配置中继日志</span><br><span class="line">relay_log=edu-mysql-relay-bin</span><br><span class="line">##复制过滤：不需要备份的数据库，不输出（mysql库一般不同步）</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">## 如果需要同步函数或者存储过程</span><br><span class="line">log_bin_trust_function_creators=true</span><br><span class="line">## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存</span><br><span class="line">binlog_cache_size=1M</span><br><span class="line">## 主从复制的格式（mixed,statement,row，默认格式是statement）</span><br><span class="line">binlog_format=mixed</span><br><span class="line">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。</span><br><span class="line">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span><br><span class="line">slave_skip_errors=1062</span><br><span class="line"></span><br><span class="line">重启mysql</span><br><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在master服务器授权slave服务器可以同步权限(master节点执行)</span><br><span class="line"></span><br><span class="line">注意：在master服务器上执行</span><br><span class="line"></span><br><span class="line">mysql -uroot -p主master的密码</span><br><span class="line"># 授予slave服务器可以同步master服务</span><br><span class="line">mysql &gt; grant replication slave, replication client on *.* to &#x27;root&#x27;@&#x27;slave服务的ip&#x27; identified by &#x27;slave服务器的密码&#x27;;</span><br><span class="line">mysql &gt; flush privileges;</span><br><span class="line"># 查看MySQL现在有哪些用户及对应的IP权限(可以不执行，只是一个查看)</span><br><span class="line">mysql &gt; select user,host from mysql.user;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220310093526229.png" alt="image-20220310093526229"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">查询master服务的binlog文件名和位置(master节点执行)</span><br><span class="line"></span><br><span class="line">mysql &gt; show master status;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/94a6664c9053f2f16702a1e9d83c8da9.png" alt="img"></p>
<ul>
<li><p>日志文件名：mysql-bin.000002</p>
</li>
<li><p>复制的位置：2079</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">slave进行关联master节点(slave节点执行)</span><br><span class="line"></span><br><span class="line">进入到slave节点：</span><br><span class="line"></span><br><span class="line">mysql &gt; mysql -uroot -p你slave的密码</span><br><span class="line"></span><br><span class="line">开始绑定</span><br><span class="line"></span><br><span class="line">mysql&gt; change master to master_host=&#x27;master服务器ip&#x27;, master_user=&#x27;root&#x27;, master_password=&#x27;master密码&#x27;, master_port=3306, master_log_file=&#x27;mysql-bin.000002&#x27;,master_log_pos=2079;</span><br><span class="line"></span><br><span class="line">这里注意一下 master_log_file 和 master_log_pos 都是通过 master服务器通过show master status获得。</span><br><span class="line"></span><br><span class="line">在slave节点上查看主从同步状态(slave节点执行)</span><br><span class="line"></span><br><span class="line">启动主从复制</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">再查看主从同步状态</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/5b2419b1d7977056090b2a4da7aeba4c.png" alt="img"></p>
<p>其他命令 (slave节点执行)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 停止复制</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> stop slave;</span></span><br></pre></td></tr></table></figure>

<p>主从复制测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在master下创建数据库和表，或者修改和新增，删除记录都会进行同步(master节点执行)</span><br><span class="line">点击查看slave节点信息(slave节点执行)</span><br><span class="line">切记</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在主从复制操作的时候，不要基于去创建数据库或者相关操作。然后又去删除。这样会造成主从复制的pos改变，而造成复制失败，如果出现此类问题，查看04-03的常见问题排查。</span><br></pre></td></tr></table></figure>

<h2 id="3-主从复制相关问题排查"><a href="#3-主从复制相关问题排查" class="headerlink" title="3.主从复制相关问题排查"></a>3.主从复制相关问题排查</h2><h3 id="1、主从复制Connecting问题"><a href="#1、主从复制Connecting问题" class="headerlink" title="1、主从复制Connecting问题"></a>1、主从复制Connecting问题</h3><p><img src="https://img-blog.csdnimg.cn/img_convert/1b8d7d93979c9a134f8745f73455e383.png" alt="img"></p>
<p>使用start slave开启主从复制过程后，如果SlaveIORunning一直是Connecting，则说明主从复制一直处于连接状态，这种情况一般是下面几种原因造成的，我们可以根据 Last_IO_Error提示予以排除。</p>
<p>网络不通<br>检查ip,端口<br>密码不对<br>检查是否创建用于同步的用户和用户密码是否正确<br>pos不对<br>检查Master的 Position</p>
<h3 id="2、MYSQL镜像服务器因错误停止的恢复-—Slave-SQL-Running-No"><a href="#2、MYSQL镜像服务器因错误停止的恢复-—Slave-SQL-Running-No" class="headerlink" title="2、MYSQL镜像服务器因错误停止的恢复 —Slave_SQL_Running: No"></a>2、MYSQL镜像服务器因错误停止的恢复 —Slave_SQL_Running: No</h3><p>先stop slave，然后执行了一下提示的语句，再</p>
<blockquote>
<p>stop slave;<br>set global sql_slave_skip_counter=1;<br>start slave;<br>show slave status\G ;</p>
</blockquote>
<h3 id="3、从MYSQL服务器Slave-IO-Running-No的解决"><a href="#3、从MYSQL服务器Slave-IO-Running-No的解决" class="headerlink" title="3、从MYSQL服务器Slave_IO_Running: No的解决"></a>3、从MYSQL服务器Slave_IO_Running: No的解决</h3><p>master节点执行，获取日志文件和post</p>
<p>mysql &gt; show master status;</p>
<p>slave节点进行重新绑定</p>
<p>mysql &gt; stop slave;<br>mysql &gt; CHANGE MASTER TO MASTER_LOG_FILE=’文件名’, MASTER_LOG_POS=文件位置;<br>mysql &gt; start slave;</p>
<p>造成这类问题的原因一般是在主从复制的时候，基于创建表，然后又去删除和操作了数据表或者表。</p>
<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h2><p>主库新建一个test库</p>
<p><img src="/../img/image-20220310094647394.png" alt="image-20220310094647394"></p>
<p>从库也有test库了</p>
<p><img src="/../img/image-20220310094706685.png" alt="image-20220310094706685"></p>
<p>主库新建test表，并写入一条数据</p>
<p><img src="/../img/image-20220310094916926.png" alt="image-20220310094916926"></p>
<p>从库也有</p>
<p><img src="/../img/image-20220310094933859.png" alt="image-20220310094933859"></p>
<h1 id="2-读写分离（业务层面）"><a href="#2-读写分离（业务层面）" class="headerlink" title="2.读写分离（业务层面）"></a>2.读写分离（业务层面）</h1><p>想要读写分离必须要用主从复制。就是两个库必须完全一致</p>
<h2 id="1-项目"><a href="#1-项目" class="headerlink" title="1.项目"></a>1.项目</h2><h3 id="pom"><a href="#pom" class="headerlink" title="pom"></a>pom</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 依赖mybatis和mysql驱动 --&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;2.1.4&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">           &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &lt;!--依赖sharding--&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;sharding-jdbc-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;4.0.0-RC1&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;sharding-core-common&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;4.0.0-RC1&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       &lt;!--依赖数据源druid--&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;1.1.21&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8085</span><br><span class="line">spring:</span><br><span class="line">  main:</span><br><span class="line">    allow-bean-definition-overriding: true</span><br><span class="line">  shardingsphere:</span><br><span class="line">    # 参数配置，显示sql</span><br><span class="line">    props:</span><br><span class="line">      sql:</span><br><span class="line">        show: true</span><br><span class="line">    # 配置数据源</span><br><span class="line">    datasource:</span><br><span class="line">      # 给每个数据源取别名，下面的ds1,ds2任意取名字</span><br><span class="line">      names: ds1,ds2</span><br><span class="line">      # 给master-ds1每个数据源配置数据库连接信息</span><br><span class="line">      ds1:</span><br><span class="line">        # 配置druid数据源</span><br><span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">        driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql://192.168.214.131:3306/test?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><br><span class="line">        username: root</span><br><span class="line">        password: Boco.123</span><br><span class="line">        maxPoolSize: 100</span><br><span class="line">        minPoolSize: 5</span><br><span class="line">      # 配置ds2-slave</span><br><span class="line">      ds2:</span><br><span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">        driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql://192.168.214.132:3306/test?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><br><span class="line">        username: root</span><br><span class="line">        password: Boco.123</span><br><span class="line">        maxPoolSize: 100</span><br><span class="line">        minPoolSize: 5</span><br><span class="line"></span><br><span class="line">    # 配置默认数据源ds1</span><br><span class="line">    sharding:</span><br><span class="line">      # 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把三个节点都当做从slave节点，新增，修改和删除会出错。</span><br><span class="line">      default-data-source-name: ds1</span><br><span class="line">    # 配置数据源的读写分离，但是数据库一定要做主从复制</span><br><span class="line">    masterslave:</span><br><span class="line">      # 配置主从名称，可以任意取名字</span><br><span class="line">      name: ms</span><br><span class="line">      # 配置主库master，负责数据的写入</span><br><span class="line">      master-data-source-name: ds1</span><br><span class="line">      # 配置从库slave节点</span><br><span class="line">      slave-data-source-names: ds2</span><br><span class="line">      # 配置slave节点的负载均衡均衡策略，采用轮询机制</span><br><span class="line">      load-balance-algorithm-type: round_robin</span><br><span class="line"># 整合mybatis的配置XXXXX</span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:mapper/*.xml</span><br><span class="line">  type-aliases-package: com.jiang.websocket.entity</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动类上加MapperScan</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@MapperScan(&#123;&quot;com.jiang.websocket.mapper&quot;&#125;)</span><br><span class="line">public class WebsocketApplication &#123;</span><br><span class="line"></span><br><span class="line">   public static void main(String[] args) &#123;</span><br><span class="line">      SpringApplication.run(WebsocketApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p><img src="/../img/image-20220310134124639.png" alt="image-20220310134124639"></p>
<h1 id="3-分库分表-表提前自己建"><a href="#3-分库分表-表提前自己建" class="headerlink" title="3.分库分表(表提前自己建)"></a>3.分库分表(表提前自己建)</h1><h2 id="1-分库分表的目的"><a href="#1-分库分表的目的" class="headerlink" title="1.分库分表的目的"></a>1.分库分表的目的</h2><p>是将一个表拆成N个表，就是让每个表的数据量控制在一定范围内，保证SQL的性能。</p>
<p><img src="/../img/image-20220310135755968.png" alt="image-20220310135755968"></p>
<h2 id="2-垂直拆分和水平拆分"><a href="#2-垂直拆分和水平拆分" class="headerlink" title="2.垂直拆分和水平拆分"></a>2.垂直拆分和水平拆分</h2><p><img src="/../img/image-20220310135949433.png" alt="image-20220310135949433"></p>
<p><img src="/../img/image-20220310140006091.png" alt="image-20220310140006091"></p>
<p>垂直拆分：业务模块拆分、商品库，用户库，订单库</p>
<p>水平拆分：对表进行水平拆分（也就是我们说的：分表）</p>
<p>表进行垂直拆分：表的字段过多，字段使用的频率不一。（可以拆分两个表建立1:1关系）</p>
<h2 id="3-shardingjdbc分库分表操作"><a href="#3-shardingjdbc分库分表操作" class="headerlink" title="3.shardingjdbc分库分表操作"></a>3.shardingjdbc分库分表操作</h2><h3 id="1-逻辑表"><a href="#1-逻辑表" class="headerlink" title="1.逻辑表"></a>1.逻辑表</h3><p>逻辑表是指：水平拆分的数据库或者数据表的相同路基和数据结构表的总称。比如用户数据根据用户id%2拆分为2个表，分别是：ksd_user0和ksd_user1。他们的逻辑表名是：ksd_user。</p>
<p>在shardingjdbc中的定义方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  shardingsphere:</span><br><span class="line">    sharding:</span><br><span class="line">      tables:</span><br><span class="line">        # ksd_user 逻辑表名</span><br><span class="line">        ksd_user:</span><br></pre></td></tr></table></figure>

<h3 id="2-分库分表数据节点-actual-data-nodes"><a href="#2-分库分表数据节点-actual-data-nodes" class="headerlink" title="2.分库分表数据节点 - actual-data-nodes"></a>2.分库分表数据节点 - actual-data-nodes</h3><p>紧接着上面的，可以有四种方法指定有哪些库哪些表，常用1,2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ksd_user 逻辑表名</span><br><span class="line">   ksd_user:</span><br><span class="line">     #1 数据节点：多数据源$-&gt;&#123;0..N&#125;.逻辑表名$-&gt;&#123;0..N&#125; 相同表</span><br><span class="line">     actual-data-nodes: ds$-&gt;&#123;0..2&#125;.ksd_user$-&gt;&#123;0..1&#125;</span><br><span class="line">      #2 数据节点：多数据源$-&gt;&#123;0..N&#125;.逻辑表名$-&gt;&#123;0..N&#125; 不同表</span><br><span class="line">     actual-data-nodes: ds0.ksd_user$-&gt;&#123;0..1&#125;,ds1.ksd_user$-&gt;&#123;2..4&#125;</span><br><span class="line">     #3 指定单数据源的配置方式</span><br><span class="line">     actual-data-nodes: ds0.ksd_user$-&gt;&#123;0..4&#125;</span><br><span class="line">     #4 全部手动指定</span><br><span class="line">     actual-data-nodes: ds0.ksd_user0,ds1.ksd_user0,ds0.ksd_user1,ds1.ksd_user1</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220310151003219.png" alt="image-20220310151003219"></p>
<h3 id="3-分库分表5种分片策略"><a href="#3-分库分表5种分片策略" class="headerlink" title="3.分库分表5种分片策略"></a>3.分库分表5种分片策略</h3><p><strong>是在上一步指定数据源以后，如果是上一步中写死了数据库，那么久不用数据源分片策略</strong></p>
<p>如果没有指定，就两种分片策略都要写</p>
<p><img src="/../img/image-20220310151903213.png" alt="image-20220310151903213"></p>
<p>举例</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8085</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="comment"># 参数配置，显示sql</span></span><br><span class="line">    <span class="attr">props:</span></span><br><span class="line">      <span class="attr">sql:</span></span><br><span class="line">        <span class="attr">show:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">sharding:</span></span><br><span class="line">      <span class="comment"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把三个节点都当做从slave节点，新增，修改和删除会出错。</span></span><br><span class="line">      <span class="attr">default-data-source-name:</span> <span class="string">ds0</span></span><br><span class="line">      <span class="comment"># 配置分表的规则</span></span><br><span class="line">      <span class="attr">tables:</span></span><br><span class="line">        <span class="comment"># ksd_user 逻辑表名</span></span><br><span class="line">        <span class="attr">ksd_user:</span></span><br><span class="line">          <span class="comment"># 数据节点：数据源$-&gt;&#123;0..N&#125;.逻辑表名$-&gt;&#123;0..N&#125;,一共四个表</span></span><br><span class="line">          <span class="attr">actual-data-nodes:</span> <span class="string">ds$-&gt;&#123;0..1&#125;.ksd_user$-&gt;&#123;0..1&#125;</span></span><br><span class="line">          <span class="comment"># 拆分库策略，也就是什么样子的数据放入放到哪个数据库中。根据性别放两个库</span></span><br><span class="line">          <span class="attr">database-strategy:</span></span><br><span class="line">            <span class="attr">inline:</span></span><br><span class="line">              <span class="attr">sharding-column:</span> <span class="string">sex</span>    <span class="comment"># 分片字段（分片键）</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">ds$-&gt;&#123;sex</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="comment"># 分片算法表达式</span></span><br><span class="line">          <span class="comment"># 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。根据年级放两个表</span></span><br><span class="line">          <span class="attr">table-strategy:</span></span><br><span class="line">            <span class="attr">inline:</span></span><br><span class="line">              <span class="attr">sharding-column:</span> <span class="string">age</span>    <span class="comment"># 分片字段（分片键）</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">ksd_user$-&gt;&#123;age</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="comment"># 分片算法表达式</span></span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220310152440658.png" alt="image-20220310152440658"></p>
<h3 id="4-根据实时间日期-按照标准规则分库分表"><a href="#4-根据实时间日期-按照标准规则分库分表" class="headerlink" title="4.根据实时间日期 - 按照标准规则分库分表"></a>4.根据实时间日期 - 按照标准规则分库分表</h3><p>1.对应StrandardShardingStrategy.提供对SQL语句中的=，in和恶between and 的分片操作支持。<br>2.StrandardShardingStrategy只支持但分片键。提供PreciseShardingAlgorithm和RangeShardingAlgorithm两个分片算法。<br>3.PreciseShardingAlgorithm是必选的呃，用于处理=和IN的分片<br>4.RangeShardingAlgorithm是可选的，是用于处理Betwwen and分片，如果不配置                     RangeShardingAlgorithm,SQL的Between AND 将按照全库路由处理。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">ksd_user:</span></span><br><span class="line">  <span class="comment"># 数据节点：数据源$-&gt;&#123;0..N&#125;.逻辑表名$-&gt;&#123;0..N&#125;</span></span><br><span class="line">  <span class="attr">actual-data-nodes:</span> <span class="string">ds$-&gt;&#123;0..1&#125;.ksd_user$-&gt;&#123;0..1&#125;</span></span><br><span class="line">  <span class="comment"># 拆分库策略，也就是什么样子的数据放入放到哪个数据库中。</span></span><br><span class="line">  <span class="attr">database-strategy:</span></span><br><span class="line">    <span class="attr">standard:</span></span><br><span class="line">      <span class="attr">shardingColumn:</span> <span class="string">birthday</span></span><br><span class="line">      <span class="attr">preciseAlgorithmClassName:</span> <span class="string">com.xuexiangban.shardingjdbc.algorithm.BirthdayAlgorithm</span></span><br><span class="line">  <span class="attr">table-strategy:</span></span><br><span class="line">    <span class="attr">inline:</span></span><br><span class="line">      <span class="attr">sharding-column:</span> <span class="string">age</span>    <span class="comment"># 分片字段（分片键）</span></span><br><span class="line">      <span class="attr">algorithm-expression:</span> <span class="string">ksd_user$-&gt;&#123;age</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="comment"># 分片算法表达式</span></span><br></pre></td></tr></table></figure>


<p>定义分片的日期规则</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuexiangban.shardingjdbc.algorithm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue;</span><br><span class="line"><span class="keyword">import</span> sun.util.resources.cldr.CalendarData;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: 学相伴-飞哥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: BirthdayAlgorithm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2021/3/11</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirthdayAlgorithm</span> <span class="keyword">implements</span> <span class="title">PreciseShardingAlgorithm</span>&lt;<span class="title">Date</span>&gt; </span>&#123;</span><br><span class="line">   List&lt;Date&gt; dateList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   &#123;</span><br><span class="line">       Calendar calendar1 = Calendar.getInstance();</span><br><span class="line">       calendar1.set(<span class="number">2020</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">       Calendar calendar2 = Calendar.getInstance();</span><br><span class="line">       calendar2.set(<span class="number">2021</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">       Calendar calendar3 = Calendar.getInstance();</span><br><span class="line">       calendar3.set(<span class="number">2022</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">       dateList.add(calendar1.getTime());</span><br><span class="line">       dateList.add(calendar2.getTime());</span><br><span class="line">       dateList.add(calendar3.getTime());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">   *collection表示两个数据源ds0和ds1</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; collection, PreciseShardingValue&lt;Date&gt; preciseShardingValue)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 获取属性数据库的值</span></span><br><span class="line">       Date date = preciseShardingValue.getValue();</span><br><span class="line">       <span class="comment">// 获取数据源的名称信息列表</span></span><br><span class="line">       Iterator&lt;String&gt; iterator = collection.iterator();</span><br><span class="line">       String target = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">for</span> (Date s : dateList) &#123;</span><br><span class="line">           target = iterator.next();</span><br><span class="line">           <span class="comment">// 如果数据晚于指定的日期直接返回</span></span><br><span class="line">           <span class="keyword">if</span> (date.before(s)) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> target;</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220310161452405.png" alt="image-20220310161452405"><br>4、测试查看结果</p>
<p><a href="http://localhost:8085/user/save?sex=3&amp;age=3&amp;birthday=2020-03-09">http://localhost:8085/user/save?sex=3&amp;age=3&amp;birthday=2020-03-09</a> —- ds1<br><a href="http://localhost:8085/user/save?sex=3&amp;age=3&amp;birthday=2021-03-09">http://localhost:8085/user/save?sex=3&amp;age=3&amp;birthday=2021-03-09</a> —- ds0</p>
<h1 id="4-注意"><a href="#4-注意" class="headerlink" title="4.注意"></a>4.注意</h1><p>（分库分表）与（主从复制+读写分离）没有关系</p>
<p>因为，（主从复制+读写分离）所有的库，表都是一样的</p>
<p>而（分库分表）是不同库不同表，存放不同数据</p>
<h2 id="（主从复制-读写分离）的yml"><a href="#（主从复制-读写分离）的yml" class="headerlink" title="（主从复制+读写分离）的yml"></a>（主从复制+读写分离）的yml</h2><p><img src="/../img/image-20220310155411875.png" alt="image-20220310155411875"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8085</span><br><span class="line">spring:</span><br><span class="line">  servlet:</span><br><span class="line">    multipart:</span><br><span class="line">      enabled: true</span><br><span class="line">      max-file-size: 200MB</span><br><span class="line">      max-request-size: 200MB</span><br><span class="line">  main:</span><br><span class="line">    allow-bean-definition-overriding: true</span><br><span class="line">  shardingsphere:</span><br><span class="line">    # 参数配置，显示sql</span><br><span class="line">    props:</span><br><span class="line">      sql:</span><br><span class="line">        show: true</span><br><span class="line">    # 配置数据源</span><br><span class="line">    datasource:</span><br><span class="line">      # 给每个数据源取别名，下面的ds1,ds2任意取名字</span><br><span class="line">      names: ds1,ds2</span><br><span class="line">      # 给master-ds1每个数据源配置数据库连接信息</span><br><span class="line">      ds1:</span><br><span class="line">        # 配置druid数据源</span><br><span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">        driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql://192.168.214.131:3306/test?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><br><span class="line">        username: root</span><br><span class="line">        password: Boco.123</span><br><span class="line">        maxPoolSize: 100</span><br><span class="line">        minPoolSize: 5</span><br><span class="line">      # 配置ds2-slave</span><br><span class="line">      ds2:</span><br><span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">        driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql://192.168.214.132:3306/test?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><br><span class="line">        username: root</span><br><span class="line">        password: Boco.123</span><br><span class="line">        maxPoolSize: 100</span><br><span class="line">        minPoolSize: 5</span><br><span class="line">    # 配置默认数据源ds1</span><br><span class="line">    sharding:</span><br><span class="line">      # 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把三个节点都当做从slave节点，新增，修改和删除会出错。</span><br><span class="line">      default-data-source-name: ds1</span><br><span class="line">    # 配置数据源的读写分离，但是数据库一定要做主从复制</span><br><span class="line">    masterslave:</span><br><span class="line">      # 配置主从名称，可以任意取名字</span><br><span class="line">      name: ms</span><br><span class="line">      # 配置主库master，负责数据的写入</span><br><span class="line">      master-data-source-name: ds1</span><br><span class="line">      # 配置从库slave节点</span><br><span class="line">      slave-data-source-names: ds2</span><br><span class="line">      # 配置slave节点的负载均衡均衡策略，采用轮询机制</span><br><span class="line">      load-balance-algorithm-type: round_robin</span><br><span class="line"># 整合mybatis的配置XXXXX</span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:mapper/*.xml</span><br><span class="line">  type-aliases-package: com.jiang.websocket.entity.shardingsphere</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="（分库分表）的yml"><a href="#（分库分表）的yml" class="headerlink" title="（分库分表）的yml"></a>（分库分表）的yml</h2><p><img src="/../img/image-20220310155524018.png" alt="image-20220310155524018"></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8085</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">200MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">200MB</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="comment"># 参数配置，显示sql</span></span><br><span class="line">    <span class="attr">props:</span></span><br><span class="line">      <span class="attr">sql:</span></span><br><span class="line">        <span class="attr">show:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 配置数据源</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="comment"># 给每个数据源取别名，下面的ds1,ds2任意取名字</span></span><br><span class="line">      <span class="attr">names:</span> <span class="string">ds1,ds2</span></span><br><span class="line">      <span class="comment"># 给master-ds1每个数据源配置数据库连接信息</span></span><br><span class="line">      <span class="attr">ds1:</span></span><br><span class="line">        <span class="comment"># 配置druid数据源</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.214.131:3306/test?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">Boco.123</span></span><br><span class="line">        <span class="attr">maxPoolSize:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">minPoolSize:</span> <span class="number">5</span></span><br><span class="line">      <span class="comment"># 配置ds2-slave</span></span><br><span class="line">      <span class="attr">ds2:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.214.132:3306/test?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">Boco.123</span></span><br><span class="line">        <span class="attr">maxPoolSize:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">minPoolSize:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment"># 配置默认数据源ds1</span></span><br><span class="line">    <span class="attr">sharding:</span></span><br><span class="line">      <span class="comment"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把三个节点都当做从slave节点，新增，修改和删除会出错。</span></span><br><span class="line">      <span class="attr">default-data-source-name:</span> <span class="string">ds1</span></span><br><span class="line">      <span class="attr">tables:</span></span><br><span class="line">        <span class="comment"># ksd_user 逻辑表名</span></span><br><span class="line">        <span class="attr">ksd_user:</span></span><br><span class="line">          <span class="comment"># 数据节点：数据源$-&gt;&#123;0..N&#125;.逻辑表名$-&gt;&#123;0..N&#125;,一共四个表</span></span><br><span class="line">          <span class="attr">actual-data-nodes:</span> <span class="string">ds$-&gt;&#123;1..2&#125;.ksd_user$-&gt;&#123;0..1&#125;</span></span><br><span class="line">          <span class="comment"># 拆分库策略，也就是什么样子的数据放入放到哪个数据库中。根据性别放两个库</span></span><br><span class="line">          <span class="attr">database-strategy:</span></span><br><span class="line">            <span class="attr">inline:</span></span><br><span class="line">              <span class="attr">sharding-column:</span> <span class="string">sex</span>    <span class="comment"># 分片字段（分片键）</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">ds$-&gt;&#123;sex</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="comment"># 分片算法表达式</span></span><br><span class="line">          <span class="comment"># 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。根据年级放两个表</span></span><br><span class="line">          <span class="attr">table-strategy:</span></span><br><span class="line">            <span class="attr">inline:</span></span><br><span class="line">              <span class="attr">sharding-column:</span> <span class="string">age</span>    <span class="comment"># 分片字段（分片键）</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">ksd_user$-&gt;&#123;sex</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="comment"># 分片算法表达式</span></span><br><span class="line"><span class="comment"># 整合mybatis的配置XXXXX</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.jiang.websocket.entity.shardingsphere</span></span><br></pre></td></tr></table></figure>

<h1 id="5-分布式主键配置"><a href="#5-分布式主键配置" class="headerlink" title="5.分布式主键配置"></a>5.分布式主键配置</h1><p>ShardingSphere提供灵活的配置分布式主键生成策略方式。在分片规则配置模块克配置每个表的主键生成策略。默认使用雪花算法。（snowflake）生成64bit的长整型数据。支持两种方式配置</p>
<p>SNOWFLAKE  Long<br>UUID    varchar2<br>这里切记：主键列不能自增长。数据类型是：bigint(20)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  shardingsphere:</span><br><span class="line">    sharding:</span><br><span class="line">      tables:</span><br><span class="line">        # ksd_user 逻辑表名</span><br><span class="line">        ksd_user:</span><br><span class="line">          key-generator:</span><br><span class="line">              # 主键的列明，</span><br><span class="line">            column: userid</span><br><span class="line">            type: SNOWFLAKE</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220310163642677.png" alt="image-20220310163642677"></p>
<h1 id="6-以年月分库分表"><a href="#6-以年月分库分表" class="headerlink" title="6.以年月分库分表"></a>6.以年月分库分表</h1><p>仅指定了一个ds0库，但是此库有6个表，collect表示 ：${1..3}不足两位前面补0</p>
<p><img src="/../img/image-20220310164919622.png" alt="image-20220310164919622"></p>
<p><img src="/../img/image-20220310165125478.png" alt="image-20220310165125478"></p>
<p>也可以不用…，直接指定</p>
<p><img src="/../img/image-20220310170041828.png" alt="image-20220310170041828"></p>
<p>如果不插入分片建字段，那么就会去插入所有的表</p>
<p><img src="/../img/image-20220310170342668.png" alt="image-20220310170342668"></p>
<p>也可以</p>
<p><img src="/../img/image-20220310171558935.png" alt="image-20220310171558935"></p>
<p><img src="/../img/image-20220310171608313.png" alt="image-20220310171608313"></p>
<h1 id="7-ShardingJdbc的事务管理"><a href="#7-ShardingJdbc的事务管理" class="headerlink" title="7.ShardingJdbc的事务管理"></a>7.ShardingJdbc的事务管理</h1><h2 id="1-本地事务"><a href="#1-本地事务" class="headerlink" title="1.本地事务"></a>1.本地事务</h2><p>指的单库，分表不分库，直接加@Transactional注解即可</p>
<p><img src="/../img/image-20220311081607591.png" alt="image-20220311081607591"></p>
<h2 id="2-两阶段提交，柔性事务，分布式事务"><a href="#2-两阶段提交，柔性事务，分布式事务" class="headerlink" title="2.两阶段提交，柔性事务，分布式事务"></a>2.两阶段提交，柔性事务，分布式事务</h2><p>导包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--依赖sharding--&gt;</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;sharding-transaction-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;3.1.0&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>再加上@ShardingTransactionType(TransactionType.XA)注解</p>
<p><img src="/../img/image-20220311082321296.png" alt="image-20220311082321296"></p>
<h1 id="8-shardingjdb分库分表）-（主从复制-读写分离）"><a href="#8-shardingjdb分库分表）-（主从复制-读写分离）" class="headerlink" title="8.shardingjdb分库分表）+（主从复制+读写分离）"></a>8.shardingjdb分库分表）+（主从复制+读写分离）</h1><p><img src="/../img/image-20220311091957208.png" alt="image-20220311091957208"></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#  main:</span></span><br><span class="line"><span class="comment">#    allow-bean-definition-overriding: true</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sharding-jdbc-example</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="attr">props:</span></span><br><span class="line">      <span class="attr">sql:</span></span><br><span class="line">        <span class="attr">show:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 数据源配置，可配置多个</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">names:</span> <span class="string">master0,master1,slave0,slave1</span></span><br><span class="line">      <span class="attr">master0:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3310/user?useUnicode=true&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">      <span class="attr">slave0:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3311/user?useUnicode=true&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">      <span class="attr">master1:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3312/user?useUnicode=true&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">      <span class="attr">slave1:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3313/user?useUnicode=true&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">sharding:</span></span><br><span class="line">      <span class="attr">master-slave-rules:</span></span><br><span class="line">        <span class="attr">ms0:</span></span><br><span class="line">          <span class="attr">master-data-source-name:</span> <span class="string">master0</span></span><br><span class="line">          <span class="attr">slave-data-source-names:</span> <span class="string">slave0</span></span><br><span class="line">        <span class="attr">ms1:</span></span><br><span class="line">          <span class="attr">master-data-source-name:</span> <span class="string">master1</span></span><br><span class="line">          <span class="attr">slave-data-source-names:</span> <span class="string">slave1</span></span><br><span class="line">      <span class="attr">tables:</span></span><br><span class="line">        <span class="attr">user:</span></span><br><span class="line">          <span class="attr">key-generator:</span></span><br><span class="line">            <span class="attr">column:</span> <span class="string">id</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">          <span class="attr">actual-data-nodes:</span> <span class="string">ms$-&gt;&#123;0..1&#125;.user_tb_$-&gt;&#123;0..2&#125;</span></span><br><span class="line">          <span class="attr">database-strategy:</span></span><br><span class="line">            <span class="attr">inline:</span></span><br><span class="line">              <span class="attr">sharding-column:</span> <span class="string">id</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">ms$-&gt;&#123;(id</span> <span class="string">/</span> <span class="number">10</span><span class="string">).toBigInteger()</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line"><span class="comment">#              algorithm-expression: ms$-&gt;&#123;id % 2&#125;</span></span><br><span class="line">          <span class="attr">table-strategy:</span></span><br><span class="line">            <span class="attr">inline:</span></span><br><span class="line">              <span class="attr">sharding-column:</span> <span class="string">id</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">user_tb_$-&gt;&#123;id</span> <span class="string">%</span> <span class="number">3</span><span class="string">&#125;</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.cunzaizhe.entity</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*Mapper.xml</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>分库分表原理</strong>：先根据id的十位上的数%2被平均分到master0和master1数据库上，然后再根据id个位上的数%3被平均分到user_tb_0,user_tb_1,user_tb_2上</li>
<li>举例：先定位到哪个ms</li>
</ul>
<p><img src="/../img/image-20220311092149258.png" alt="image-20220311092149258"></p>
<p>增删改操作，修改master，查询操作，查slave</p>
<h2 id="？当没有分库分表时"><a href="#？当没有分库分表时" class="headerlink" title="？当没有分库分表时"></a>？当没有分库分表时</h2><p><img src="/../img/image-20220311092338539.png" alt="image-20220311092338539"></p>
<h1 id="9-sharding-proxy"><a href="#9-sharding-proxy" class="headerlink" title="9.sharding-proxy"></a>9.sharding-proxy</h1><h2 id="1解压"><a href="#1解压" class="headerlink" title="1解压"></a>1解压</h2><p><img src="/../img/image-20220311093543586.png" alt="image-20220311093543586"></p>
<h2 id="2修改配置文件"><a href="#2修改配置文件" class="headerlink" title="2修改配置文件"></a>2修改配置文件</h2><p><img src="/../img/image-20220311093621405.png" alt="image-20220311093621405"></p>
<h3 id="1server-yaml"><a href="#1server-yaml" class="headerlink" title="1server.yaml"></a>1server.yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">authentication:</span></span><br><span class="line"><span class="comment">#配置数据库用户名密码</span></span><br><span class="line">  <span class="attr">users:</span></span><br><span class="line">    <span class="attr">root:</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="comment">#一个sharding_db的数据库</span></span><br><span class="line">    <span class="attr">sharding:</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">sharding</span> </span><br><span class="line">      <span class="attr">authorizedSchemas:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">props:</span></span><br><span class="line">  <span class="attr">max.connections.size.per.query:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">acceptor.size:</span> <span class="number">16</span>  <span class="comment"># The default value is available processors count * 2.</span></span><br><span class="line">  <span class="attr">executor.size:</span> <span class="number">16</span>  <span class="comment"># Infinite by default.</span></span><br><span class="line">  <span class="attr">proxy.frontend.flush.threshold:</span> <span class="number">128</span>  <span class="comment"># The default value is 128.</span></span><br><span class="line">    <span class="comment"># LOCAL: Proxy will run with LOCAL transaction.</span></span><br><span class="line">    <span class="comment"># XA: Proxy will run with XA transaction.</span></span><br><span class="line">    <span class="comment"># BASE: Proxy will run with B.A.S.E transaction.</span></span><br><span class="line">  <span class="attr">proxy.transaction.type:</span> <span class="string">LOCAL</span></span><br><span class="line">  <span class="attr">proxy.opentracing.enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">query.with.cipher.column:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sql.show:</span> <span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3、分库分表-修改-config-sharding-yaml"><a href="#3、分库分表-修改-config-sharding-yaml" class="headerlink" title="3、分库分表 修改 config-sharding.yaml"></a>3、分库分表 修改 config-sharding.yaml</h2><p>复制mysql包到lib中，这个解压包里已经有了，当新下载可以使用这个mysql包</p>
<p><img src="/../img/image-20220311094323025.png" alt="image-20220311094323025"></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#上一步的数据库</span></span><br><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="attr">ds_0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/edu_db_1?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">ds_1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/edu_db_2?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">shardingRule:</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">ds_$&#123;0..1&#125;.t_order_$&#123;1..2&#125;</span></span><br><span class="line">      <span class="attr">tableStrategy:</span></span><br><span class="line">        <span class="attr">inline:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">          <span class="attr">algorithmExpression:</span> <span class="string">t_order_$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span> <span class="string">+</span> <span class="number">1</span><span class="string">&#125;</span></span><br><span class="line">      <span class="attr">keyGenerator:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">        <span class="attr">column:</span> <span class="string">order_id</span></span><br><span class="line">  <span class="comment">#绑定上方tables下的所有表名</span></span><br><span class="line">  <span class="attr">bindingTables:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">t_order</span></span><br><span class="line">  <span class="comment">#全局指定数据库分片设置，可以在每个tables下自定义设置</span></span><br><span class="line">  <span class="attr">defaultDatabaseStrategy:</span></span><br><span class="line">    <span class="attr">inline:</span></span><br><span class="line">      <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">      <span class="attr">algorithmExpression:</span> <span class="string">ds_$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">  <span class="attr">defaultTableStrategy:</span></span><br><span class="line">    <span class="attr">none:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试启动</p>
<p><img src="/../img/image-20220311095138616.png" alt="image-20220311095138616"></p>
<p><img src="/../img/image-20220311095151810.png" alt="image-20220311095151810"></p>
<p><img src="/../img/image-20220311100646559.png" alt="image-20220311100646559"></p>
<p><img src="/../img/image-20220311100859870.png" alt="image-20220311100859870"></p>
<p>在这个3307的库里，创建指定的user表，那么3306的库里就会自动创建user1和user2这两个表，添加一条数据，会根据路由判断插入到哪个表</p>
<p><img src="/../img/image-20220311101323597.png" alt="image-20220311101323597"></p>
<p>其中proxy的表结构的id要是bigint类型，因为使用雪花算法生成的</p>
<p><img src="/../img/image-20220311104639825.png" alt="image-20220311104639825"></p>
<p>3307 proxy表</p>
<p><img src="/../img/image-20220311104700029.png" alt="image-20220311104700029"></p>
<p>3306 user1表</p>
<p><img src="/../img/image-20220311104728342.png" alt="image-20220311104728342"></p>
<p>3306  user2表</p>
<p><img src="/../img/image-20220311104736449.png" alt="image-20220311104736449"></p>
<p>发现一个表各一条</p>
<h2 id="4-读写分离config-master-slave-yaml"><a href="#4-读写分离config-master-slave-yaml" class="headerlink" title="4.读写分离config-master_slave.yaml"></a>4.读写分离config-master_slave.yaml</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemaName:</span> <span class="string">master_slave_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="attr">master_ds:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/master?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">slave_ds_0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/slave_0?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">slave_ds_1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/slave_1?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">masterSlaveRule:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ms_ds</span></span><br><span class="line">  <span class="attr">masterDataSourceName:</span> <span class="string">master_ds</span></span><br><span class="line">  <span class="attr">slaveDataSourceNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">slave_ds_0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">slave_ds_1</span></span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220311110726123.png" alt="image-20220311110726123"></p>
<p>注意，shardingproxy只会进行读写分离，主从复制还是需要从mysql手动配置，再次测试，手动同步数据，创建表等操作</p>
<p><img src="/../img/image-20220311110854729.png" alt="image-20220311110854729"></p>
<p>insert走主库</p>
<p><img src="/../img/image-20220311112239798.png" alt="image-20220311112239798"></p>
<p>select轮训走从库</p>
<p><img src="/../img/image-20220311112301749.png" alt="image-20220311112301749"></p>
<p><img src="/../img/image-20220311112312440.png" alt="image-20220311112312440"></p>
<p>navicat看</p>
<p>主库（1,1）</p>
<p>从库1（2,1）</p>
<p>从库2 （3，1）</p>
<p><img src="/../img/image-20220311113009106.png" alt="image-20220311113009106"></p>
<p>再查一次</p>
<p><img src="/../img/image-20220311113021958.png" alt="image-20220311113021958"></p>
<p>说明查询是从从库查询的</p>
<h2 id="5-项目里数据库"><a href="#5-项目里数据库" class="headerlink" title="5.项目里数据库"></a>5.项目里数据库</h2><p>配置为一个数据源3307</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>shardingjdbc分库分表</tag>
      </tags>
  </entry>
  <entry>
    <title>restTemplate&amp;&amp;fegin</title>
    <url>/2021/11/30/restTemplate&amp;&amp;fegin/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/09/03  16:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">config</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/09/03  16:20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String URL=<span class="string">&quot;http://localhost:8082/&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/demo3/&#123;name&#125;/&#123;password&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">demo3</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name, <span class="meta">@PathVariable(&quot;password&quot;)</span> String password)</span></span>&#123;</span><br><span class="line">        String url=URL+<span class="string">&quot;demo4/&#123;name&#125;/&#123;password&#125;&quot;</span>;</span><br><span class="line">        String success = restTemplate.getForObject(url,String.class,name,password);</span><br><span class="line">        System.out.println(success);</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@RequestMapping(&quot;/accept/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span>String name)</span> <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = restTemplate.getForObject(URL2 + <span class="string">&quot;/&quot;</span> + name, <span class="keyword">byte</span>[].class);</span><br><span class="line">        OutputStream os=<span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;D:\\b.jpg&quot;</span>));</span><br><span class="line">        os.write(bytes);</span><br><span class="line">        os.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>被调用方</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:20</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@RequestMapping(&quot;/download/&#123;name&#125;&quot;)</span><br><span class="line">public byte[] download(@PathVariable(&quot;name&quot;) String name) throws Exception&#123;</span><br><span class="line">    FileInputStream in=null;</span><br><span class="line">    try &#123;</span><br><span class="line">        in=new FileInputStream(new File(&quot;D:&quot;+File.separator+name));</span><br><span class="line"></span><br><span class="line">        BufferedInputStream bufferedInputStream =new BufferedInputStream(in);</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=new ByteArrayOutputStream();</span><br><span class="line">        byte[] buffer=null;</span><br><span class="line">        int len=0;</span><br><span class="line">        byte []buf=new byte[2048];</span><br><span class="line">        while((len=bufferedInputStream.read(buf))!=-1)&#123;</span><br><span class="line">            byteArrayOutputStream.write(buf, 0, len);</span><br><span class="line">        &#125;</span><br><span class="line">        byteArrayOutputStream.flush();</span><br><span class="line">        buffer=byteArrayOutputStream.toByteArray();</span><br><span class="line">        return buffer;</span><br><span class="line">    &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        return null;</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        if(in!=null)&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="调用方-传属性"><a href="#调用方-传属性" class="headerlink" title="调用方-传属性"></a>调用方-传属性</h1><h1 id="返回String"><a href="#返回String" class="headerlink" title="返回String"></a>返回String</h1><h2 id="公共User类"><a href="#公共User类" class="headerlink" title="公共User类"></a>公共User类</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.User;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/26  8:27</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class User implements Serializable &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private Integer age;</span><br><span class="line">    public User(String name,Integer age)&#123;</span><br><span class="line">        this.name=name;</span><br><span class="line">        this.age=age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用方"><a href="#调用方" class="headerlink" title="调用方"></a>调用方</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:28</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class config &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public RestTemplate getRestTemplate()&#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line">import com.jiang.demo.pojo.User;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.http.HttpEntity;</span><br><span class="line">import org.springframework.http.HttpHeaders;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.util.LinkedMultiValueMap;</span><br><span class="line">import org.springframework.util.MultiValueMap;</span><br><span class="line">import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import static org.springframework.http.HttpMethod.POST;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:20</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    private final String URL=&quot;http://localhost:8082/&quot;;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/form/get1&quot;)</span><br><span class="line">    public String demo1(String method)&#123;</span><br><span class="line">        String url = URL+&quot;form/&quot;+method+&quot;?name=&#123;name&#125;&amp;age=&#123;age&#125;&quot;;</span><br><span class="line">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;name&quot;,&quot;小明&quot;);</span><br><span class="line">        map.put(&quot;age&quot;,18);</span><br><span class="line">        //如果前端返回的map和实体类属性相同，可以转换为实体类对象</span><br><span class="line">        String responseEntity = restTemplate.getForObject(url,String.class,map);</span><br><span class="line">        System.out.println(responseEntity);</span><br><span class="line">        return  responseEntity;</span><br><span class="line">    &#125;</span><br><span class="line">    @RequestMapping(&quot;/form/post1&quot;)</span><br><span class="line">    public String demo2(String method)&#123;</span><br><span class="line">        HttpHeaders httpHeaders = new HttpHeaders();</span><br><span class="line">        String url = URL+&quot;form/&quot;+method;</span><br><span class="line">        httpHeaders.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">        MultiValueMap&lt;String,Object&gt; params = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        params.add(&quot;name&quot;, &quot;小明&quot;);</span><br><span class="line">        params.add(&quot;age&quot;, 18);</span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = new HttpEntity(params, httpHeaders);</span><br><span class="line">        ResponseEntity&lt;String&gt; responseEntity = restTemplate.exchange(url, POST, requestEntity, String.class);</span><br><span class="line">        System.out.println(responseEntity.getBody());</span><br><span class="line">        return responseEntity.getBody();</span><br><span class="line">    &#125;</span><br><span class="line">    @RequestMapping(&quot;/form/post2&quot;)</span><br><span class="line">    public String demo3(String method)&#123;</span><br><span class="line">        String url = URL+&quot;form/&quot;+method;</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; params = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        params.add(&quot;name&quot;, &quot;小明&quot;);</span><br><span class="line">        params.add(&quot;age&quot;, 18);</span><br><span class="line">        String result = restTemplate.postForObject(url, params, String.class);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="被调用方"><a href="#被调用方" class="headerlink" title="被调用方"></a>被调用方</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line">import com.jiang.demo.User.User;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:20</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line">    //Get请求</span><br><span class="line">    @GetMapping(value = &quot;/form/get1&quot;)</span><br><span class="line">    public User testFormGet1(User user)&#123;</span><br><span class="line">        user.setAge(19);</span><br><span class="line">        return user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/form/get2&quot;,produces = &quot;application/json;charset=UTF-8&quot;)</span><br><span class="line">    public String testFormGet2(@RequestParam String name, @RequestParam Integer age)&#123;</span><br><span class="line">        //return new User(name,age);</span><br><span class="line">        return name+age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/form/get3&quot;)</span><br><span class="line">    public String testFormGet3(String name, Integer age)&#123;</span><br><span class="line">        return name+age;</span><br><span class="line">        //return new User(name,age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/form/get4&quot;)</span><br><span class="line">    //不管发送过来的字段是什么类型,user都是Map&lt;String, String&gt;</span><br><span class="line">    public String  testFormGet4(@RequestParam Map user)&#123;</span><br><span class="line"></span><br><span class="line">        return (String)user.get(&quot;name&quot;)+user.get(&quot;age&quot;);</span><br><span class="line">        //return new User(name,age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Post请求</span><br><span class="line">        @PostMapping(&quot;/form/post1&quot;)</span><br><span class="line">        public User testFormPost1(User user)&#123;</span><br><span class="line">            user.setAge(19);</span><br><span class="line">            return user;</span><br><span class="line">        &#125;</span><br><span class="line">        @PostMapping(&quot;/form/post2&quot;)</span><br><span class="line">        public String testFormPost2(@RequestParam String name, @RequestParam Integer age)&#123;</span><br><span class="line"></span><br><span class="line">            return name+age;</span><br><span class="line">        &#125;</span><br><span class="line">        @PostMapping(&quot;/form/post3&quot;)</span><br><span class="line">        public String testFormPost3(String name, String phone, Integer age)&#123;</span><br><span class="line">            return name+age;</span><br><span class="line">        &#125;</span><br><span class="line">        @PostMapping(&quot;/form/post4&quot;)</span><br><span class="line">        public String testFormPost4(@RequestParam Map user)&#123;</span><br><span class="line">            return (String)user.get(&quot;name&quot;)+user.get(&quot;age&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="返回User对象"><a href="#返回User对象" class="headerlink" title="返回User对象"></a>返回User对象</h1><h2 id="被调用方（接受参数不是map）"><a href="#被调用方（接受参数不是map）" class="headerlink" title="被调用方（接受参数不是map）"></a>被调用方（接受参数不是map）</h2><h3 id="调用方-1"><a href="#调用方-1" class="headerlink" title="调用方"></a>调用方</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line">import com.jiang.demo.pojo.User;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.http.HttpEntity;</span><br><span class="line">import org.springframework.http.HttpHeaders;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.util.LinkedMultiValueMap;</span><br><span class="line">import org.springframework.util.MultiValueMap;</span><br><span class="line">import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import static org.springframework.http.HttpMethod.POST;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:20</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    private final String URL=&quot;http://localhost:8082/&quot;;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/form/get1&quot;)</span><br><span class="line">    public String demo1(String method)&#123;</span><br><span class="line">        String url = URL+&quot;form/&quot;+method+&quot;?name=&#123;name&#125;&amp;age=&#123;age&#125;&quot;;</span><br><span class="line">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;name&quot;,&quot;小明&quot;);</span><br><span class="line">        map.put(&quot;age&quot;,18);</span><br><span class="line">        //如果前端返回的map和实体类属性相同，可以转换为实体类对象</span><br><span class="line">        User responseEntity = restTemplate.getForObject(url,User.class,map);</span><br><span class="line">        System.out.println(responseEntity);</span><br><span class="line">        return  responseEntity.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    @RequestMapping(&quot;/form/post1&quot;)</span><br><span class="line">    public String demo2(String method)&#123;</span><br><span class="line">        HttpHeaders httpHeaders = new HttpHeaders();</span><br><span class="line">        String url = URL+&quot;form/&quot;+method;</span><br><span class="line">        httpHeaders.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">        MultiValueMap&lt;String,Object&gt; params = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        params.add(&quot;name&quot;, &quot;小明&quot;);</span><br><span class="line">        params.add(&quot;age&quot;, 18);</span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = new HttpEntity(params, httpHeaders);</span><br><span class="line">        ResponseEntity&lt;User&gt; responseEntity = restTemplate.exchange(url, POST, requestEntity,User.class);</span><br><span class="line">        System.out.println(responseEntity.getBody());</span><br><span class="line">        return responseEntity.getBody().toString();</span><br><span class="line">    &#125;</span><br><span class="line">    @RequestMapping(&quot;/form/post2&quot;)</span><br><span class="line">    public String demo3(String method)&#123;</span><br><span class="line">        String url = URL+&quot;form/&quot;+method;</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; params = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        params.add(&quot;name&quot;, &quot;小明&quot;);</span><br><span class="line">        params.add(&quot;age&quot;, 18);</span><br><span class="line">        User result = restTemplate.postForObject(url, params, User.class);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        return result.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="被调用方-1"><a href="#被调用方-1" class="headerlink" title="被调用方"></a>被调用方</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line">import com.jiang.demo.User.User;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:20</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line">    //Get请求</span><br><span class="line">    @GetMapping(value = &quot;/form/get1&quot;)</span><br><span class="line">    public User testFormGet1(User user)&#123;</span><br><span class="line">        user.setAge(19);</span><br><span class="line">        return user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/form/get2&quot;)</span><br><span class="line">    public User testFormGet2(@RequestParam String name, @RequestParam Integer age)&#123;</span><br><span class="line">        return new User(name,age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/form/get3&quot;)</span><br><span class="line">    public User testFormGet3(String name, Integer age)&#123;</span><br><span class="line">        return new User(name,age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/form/get4&quot;)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Post请求</span><br><span class="line">        @PostMapping(&quot;/form/post1&quot;)</span><br><span class="line">        public User testFormPost1(User user)&#123;</span><br><span class="line">            user.setAge(19);</span><br><span class="line">            return user;</span><br><span class="line">        &#125;</span><br><span class="line">        @PostMapping(&quot;/form/post2&quot;)</span><br><span class="line">        public User testFormPost2(@RequestParam String name, @RequestParam Integer age)&#123;</span><br><span class="line"></span><br><span class="line">            return new User(name,age);</span><br><span class="line">        &#125;</span><br><span class="line">        @PostMapping(&quot;/form/post3&quot;)</span><br><span class="line">        public User testFormPost3(String name, String phone, Integer age)&#123;</span><br><span class="line">            return new User(name,age);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="被调用方接受参数是map"><a href="#被调用方接受参数是map" class="headerlink" title="被调用方接受参数是map"></a>被调用方接受参数是map</h2><h3 id="调用方-2"><a href="#调用方-2" class="headerlink" title="调用方"></a>调用方</h3><p>注意参数必须是string,string类型，不是String类型的，如下方的age，不能在被调用方使用</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210926104149792.png" alt="image-20210926104149792"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line">import com.jiang.demo.pojo.User;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.http.HttpEntity;</span><br><span class="line">import org.springframework.http.HttpHeaders;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.util.LinkedMultiValueMap;</span><br><span class="line">import org.springframework.util.MultiValueMap;</span><br><span class="line">import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import static org.springframework.http.HttpMethod.POST;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:20</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    private final String URL=&quot;http://localhost:8082/&quot;;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/form/get1&quot;)</span><br><span class="line">    public String demo1(String method)&#123;</span><br><span class="line">        String url = URL+&quot;form/&quot;+method+&quot;?name=&#123;name&#125;&amp;age=&#123;age&#125;&quot;;</span><br><span class="line">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;name&quot;,&quot;小明&quot;);</span><br><span class="line">        map.put(&quot;age&quot;, &quot;18&quot;);</span><br><span class="line">        //如果前端返回的map和实体类属性相同，可以转换为实体类对象</span><br><span class="line">        User responseEntity = restTemplate.getForObject(url,User.class,map);</span><br><span class="line">        System.out.println(responseEntity);</span><br><span class="line">        return  responseEntity.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    @RequestMapping(&quot;/form/post1&quot;)</span><br><span class="line">    public String demo2(String method)&#123;</span><br><span class="line">        HttpHeaders httpHeaders = new HttpHeaders();</span><br><span class="line">        String url = URL+&quot;form/&quot;+method;</span><br><span class="line">        httpHeaders.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">        MultiValueMap&lt;String,Object&gt; params = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        params.add(&quot;name&quot;, &quot;小明&quot;);</span><br><span class="line">        params.add(&quot;age&quot;, &quot;18&quot;);</span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = new HttpEntity(params, httpHeaders);</span><br><span class="line">        ResponseEntity&lt;User&gt; responseEntity = restTemplate.exchange(url, POST, requestEntity,User.class);</span><br><span class="line">        System.out.println(responseEntity.getBody());</span><br><span class="line">        return responseEntity.getBody().toString();</span><br><span class="line">    &#125;</span><br><span class="line">    @RequestMapping(&quot;/form/post2&quot;)</span><br><span class="line">    public String demo3(String method)&#123;</span><br><span class="line">        String url = URL+&quot;form/&quot;+method;</span><br><span class="line">        MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        params.add(&quot;name&quot;, &quot;小明&quot;);</span><br><span class="line">        params.add(&quot;age&quot;, &quot;18&quot;);</span><br><span class="line">        User result = restTemplate.postForObject(url, params, User.class);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        return result.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="被调用方-2"><a href="#被调用方-2" class="headerlink" title="被调用方"></a>被调用方</h3><p>不是String类型的，只能自己单独处理，不能接受</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210926104419914.png" alt="image-20210926104419914"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo.controller;</span><br><span class="line"></span><br><span class="line">import com.jiang.demo.User.User;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:20</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value = &quot;/form/get4&quot;)</span><br><span class="line">    //不管发送过来的字段是什么类型,user都是Map&lt;String, String&gt;</span><br><span class="line">    public User  testFormGet4(@RequestParam Map user)&#123;</span><br><span class="line">        String name=(String)user.get(&quot;name&quot;);</span><br><span class="line">        //Integer age=(Integer)user.get(&quot;age&quot;);</span><br><span class="line">        Integer age=11;</span><br><span class="line">        return new User(name,age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        @PostMapping(&quot;/form/post4&quot;)</span><br><span class="line">        public User testFormPost4(@RequestParam Map user)&#123;</span><br><span class="line">            String name=(String)user.get(&quot;name&quot;);</span><br><span class="line">            //Integer age=(Integer)user.get(&quot;age&quot;);</span><br><span class="line">            Integer age=11;</span><br><span class="line">            return new User(name,age);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="想直接传对象"><a href="#想直接传对象" class="headerlink" title="想直接传对象"></a>想直接传对象</h1><p>被调用方需要有@requestbody注解，不加注解传不了对象，只能是基本类型</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210926151622258.png" alt="image-20210926151622258"></p>
<p>并且调用方直接传user对象，而不是把user放进param的map里</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210926151710369.png" alt="image-20210926151710369"></p>
<h1 id="添加请求头信息"><a href="#添加请求头信息" class="headerlink" title="添加请求头信息"></a>添加请求头信息</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210926141244313.png" alt="image-20210926141244313"></p>
<h1 id="公司使用fegin"><a href="#公司使用fegin" class="headerlink" title="公司使用fegin"></a>公司使用fegin</h1><h2 id="1-新建一个interface"><a href="#1-新建一个interface" class="headerlink" title="1.新建一个interface"></a>1.新建一个interface</h2><p>@FeignClient(value = “FRAMEWORK-COMPONENT-MICROSERVICE”)是微服务的名字，在eureka上找</p>
<p>@PostMapping(value = “/file/upload”)是微服务的路径</p>
<p>@requestParam参数必须是基本类型，不能是封装好的对象，否则为空</p>
<p>此处被调用方是对象，而调用方参数是对象里的各个属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boco.rnop.osmp.project.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.boco.rnop.framework.common.ResponseMessage2;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span> jiangjiaxu</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@email</span>  jiangjiaxu@boco.com.cn</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@time</span>2021年9月26日</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@modify</span> &lt;BR/&gt;</span></span><br><span class="line"><span class="comment"> * 		修改内容：&lt;BR/&gt;</span></span><br><span class="line"><span class="comment"> *		修改人员：&lt;BR/&gt;</span></span><br><span class="line"><span class="comment"> *   	修改时间：&lt;BR/&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;FRAMEWORK-COMPONENT-MICROSERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ComponentClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping(value = &quot;/file/upload&quot;)</span></span><br><span class="line">	<span class="function">ResponseMessage2&lt;String&gt; <span class="title">upload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@RequestParam(&quot;businessId2&quot;)</span> String businessId2,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@RequestParam(&quot;category&quot;)</span> String category,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@RequestParam(&quot;businessId&quot;)</span> Long businessId,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@RequestParam(&quot;businessId3&quot;)</span> String businessId3,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@RequestParam(&quot;variable&quot;)</span> String variable</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;upload&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;低端上传附件&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseMessage2&lt;String&gt; <span class="title">upload</span><span class="params">(<span class="meta">@RequestBody</span> UploadRequest uploadRequest)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	val result = flowService.upload(uploadRequest);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ResponseMessage2.Success2(result);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UploadRequest是封装好的类</p>
<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210926165707460.png" alt="image-20210926165707460"></p>
<h2 id="Serverimpl"><a href="#Serverimpl" class="headerlink" title="Serverimpl"></a>Serverimpl</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210926165721325.png" alt="image-20210926165721325"></p>
<h1 id="普通fegin不能发送MutipartFile参数"><a href="#普通fegin不能发送MutipartFile参数" class="headerlink" title="普通fegin不能发送MutipartFile参数"></a>普通fegin不能发送MutipartFile参数</h1><h2 id="1-加入依赖"><a href="#1-加入依赖" class="headerlink" title="1.加入依赖"></a>1.加入依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-配置文件"><a href="#2-配置文件" class="headerlink" title="2.配置文件"></a>2.配置文件</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> class <span class="title">config</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Encoder <span class="title">multipartFormEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringFormEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-fegin接口"><a href="#3-fegin接口" class="headerlink" title="3.fegin接口"></a>3.fegin接口</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;FRAMEWORK-COMPONENT-MICROSERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ComponentClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@PostMapping(value = &quot;/file/upload&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">   <span class="function">ResponseMessage2&lt;String&gt; <span class="title">upload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(&quot;businessId2&quot;)</span> String businessId2,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(&quot;category&quot;)</span> String category,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestPart(&quot;files&quot;)</span>  MultipartFile file,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(&quot;businessId&quot;)</span> Long businessId,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(&quot;businessId3&quot;)</span> String businessId3,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(&quot;variable&quot;)</span> String variable</span></span></span><br><span class="line"><span class="params"><span class="function">   )</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.想要传MutipartFile【】数组？？</p>
<p><a href="https://blog.csdn.net/ytzzh0726/article/details/79467843">https://blog.csdn.net/ytzzh0726/article/details/79467843</a></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>restTemplate&amp;&amp;fegin</tag>
      </tags>
  </entry>
  <entry>
    <title>shell</title>
    <url>/2021/11/30/shell/</url>
    <content><![CDATA[<p><img src="/../img/image-20220210175852468.png" alt="image-20220210175852468"></p>
<p>sed -i ‘s/\r$//‘ a.sh   #把window换行符等转成linux</p>
<h1 id="1-Shell中的特殊符号"><a href="#1-Shell中的特殊符号" class="headerlink" title="1.Shell中的特殊符号"></a>1.<strong>Shell中的特殊符号</strong></h1><p>1.$ 美元符号。用来表示变量的值。如变量NAME的值为Mike，则使用$NAME就可以得到“Mike”这个值。</p>
<p><img src="/../img/image-20220221091104986.png" alt="image-20220221091104986"></p>
<p><img src="/../img/image-20220221091058114.png" alt="image-20220221091058114"></p>
<p>2.# 井号。除了做为超级用户的提示符之外，还可以在脚本中做为注释的开头字母，每一行语句中，从#号开始的部分就不执行了。</p>
<p>3.””双引号。shell不会将一对双引号之间的文本中的大多数特殊字符进行解释，如#不再是注释的开头，它只表示一个井号“#”。但$仍然保持特殊含义。（在双引号中的$加变量名，即：$PARAM_NAME，依然会转换成变量的值。）</p>
<p><img src="/../img/image-20220221091126114.png" alt="image-20220221091126114"></p>
<p><img src="/../img/image-20220221091139509.png" alt="image-20220221091139509"></p>
<p>4.’’ 单引号。shell不会将一对单引号之间的任何字符做特殊解释。（在双引号中的$加变量名，即：$PARAM_NAME，不会转换成变量的值。）</p>
<p><img src="/../img/image-20220221091126114.png" alt="image-20220221091126114"></p>
<p><img src="/../img/image-20220221091139509.png" alt="image-20220221091139509"></p>
<p>5.{}大括号，主要是和$符号配合，作为字符串连接来使用</p>
<p><img src="/../img/image-20220221091320645.png" alt="image-20220221091320645"></p>
<p><img src="/../img/image-20220221091329068.png" alt="image-20220221091329068"></p>
<p>6.\ 斜杠。用来去掉在shell解释中字符的特殊含义。在文本中，跟在\后面的一个字符不会被shell特殊解释，但其余的不受影响。</p>
<p>7.``:命令结构</p>
<p>‘’直接打印而``里是命令结果，$()也是一样，命令结果</p>
<p><img src="/../img/image-20220221104417269.png" alt="image-20220221104417269"></p>
<p><img src="/../img/image-20220221104411559.png" alt="image-20220221104411559"></p>
<h1 id="2-预定义的变量"><a href="#2-预定义的变量" class="headerlink" title="2.预定义的变量"></a>2.<strong>预定义的变量</strong></h1><p>$   shell变量名的开始，如$var</p>
<p>|    管道，将标准输出转到下一个命令的标准输入</p>
<p>$#   记录传递给Shell的自变量个数</p>
<p>#    注释开始</p>
<p>&amp;   在后台执行一个进程</p>
<p>？   匹配一个字符</p>
<p>*   匹配0到多个字符(与DOS不同，可在文件名中间使用，并且含.)</p>
<p>$-   使用set及执行时传递给shell的标志位</p>
<p>$!   最后一个子进程的进程号 </p>
<p>$?   取最近一次命令执行后的退出状态(返回码)</p>
<p>$*   传递给shell script的参数</p>
<p>$@   所有参数，个别的用双引号括起来</p>
<p>$0   当前shell的名字</p>
<p>$n   (n:1-) 位置参数</p>
<p>$$   进程标识号(Process Identifier Number, PID)</p>
<p>&gt;   输出重定向</p>
<p> &lt;   输入重定向</p>
<p> &gt;&gt;   输出重定向（追加方式）</p>
<p> []   列出字符变化范围，如[a-z]</p>
<h1 id="3-设置变量"><a href="#3-设置变量" class="headerlink" title="3.设置变量"></a><strong>3.设置变量</strong></h1><p>3.1     格式：VARNAME=value （i.e. PARAM=’hello’）</p>
<p><img src="/../img/image-20220221091808883.png" alt="image-20220221091808883"></p>
<p>3.2     注意：</p>
<p>3.2.1   等号的前后不能有空格</p>
<p>3.2.2   如果变量的值是一个命令的执行结果，请加上反引号（`）。</p>
<h1 id="4-引用变量"><a href="#4-引用变量" class="headerlink" title="4.引用变量"></a>4.引用变量</h1><p>在引用一个变量的时候可以设定默认值。如果在此之前，该变量已经设定了值，则此默认值无效。如果此时变量没有被设定值，则使用此默认值（但是没有改变此变量的值）。</p>
<p>echo Hello ${UNAME:-there}   #其中there是UNAME的默认值</p>
<p>使用${VALIABLE:?MESSAGE},如果发现此变量此时没有值，则脚本停止运行并显示行号和变量名称。 主要用于调试。</p>
<h1 id="5-相关"><a href="#5-相关" class="headerlink" title="5.$相关"></a>5.$相关</h1><p>sed -i ‘s/\r$//‘ test.sh   #把window换行符等转成linux</p>
<p>test.sh</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line"></span><br><span class="line">VAR=&quot;Hello World!&quot;</span><br><span class="line">echo &quot;\$VAR : $VAR&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;\$# argc: $#&quot;</span><br><span class="line">echo &quot;\$@ argv[]: $@&quot;</span><br><span class="line">echo &quot;\$0 argv[0]: $0&quot;</span><br><span class="line">echo &quot;\$1 argv[1]: $1&quot;</span><br><span class="line">echo &quot;\$2 argv[2]: $2&quot;</span><br><span class="line">echo &quot;\$* argv_str: $*&quot;</span><br><span class="line">echo &quot;\$$ pid: $$&quot;</span><br><span class="line">echo &quot;\$? retcode: $?&quot;</span><br></pre></td></tr></table></figure>

<p>执行 ./test a b c d #其中a b c d就是参数，以空格分隔</p>
<p><img src="/../img/image-20220221093421522.png" alt="image-20220221093421522"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$# 代表传入参数的个数</span><br><span class="line">$@ 代表传入参数的列表</span><br><span class="line">$0 代表脚本本身</span><br><span class="line">$1 代表传入的第一个参数，$2，$3...以此类推</span><br><span class="line">$* 以字符串方式显示所有传入的参数</span><br><span class="line">$$ 脚本运行的进程ID</span><br><span class="line">$? 显示最后命令的退出状况，0表示没有错误</span><br></pre></td></tr></table></figure>

<h1 id="6-source-export-let-unset"><a href="#6-source-export-let-unset" class="headerlink" title="6.source / export / let / unset"></a>6.<strong>source / export / let / unset</strong></h1><h2 id="source"><a href="#source" class="headerlink" title="source"></a>source</h2><p>正常情况下，脚本中执行的参数设置只能影响到shell脚本本身的执行环境，不能影响到调用此shell的脚本。</p>
<p>使用source命令执行脚本，可以让脚本影响到父shell的环境（即调用此shell的当前shell）。</p>
<p>脚本a.sh里设置变量a=2</p>
<p><img src="/../img/image-20220221095321023.png" alt="image-20220221095321023"></p>
<p><img src="/../img/image-20220221100008257.png" alt="image-20220221100008257"></p>
<p>打印为空</p>
<p>当source a.sh后</p>
<p><img src="/../img/image-20220221100034667.png" alt="image-20220221100034667"></p>
<p>但是另一个b.sh是获取不到a的值的</p>
<p><img src="/../img/image-20220221100507263.png" alt="image-20220221100507263"></p>
<p><img src="/../img/image-20220221100519083.png" alt="image-20220221100519083"></p>
<p>修改a.sh,加上export</p>
<p><img src="/../img/image-20220221100536384.png" alt="image-20220221100536384"></p>
<p>source a.sh</p>
<p>发现此时b.sh里可以获取到a的值了</p>
<p><img src="/../img/image-20220221100611803.png" alt="image-20220221100611803"></p>
<h2 id="export"><a href="#export" class="headerlink" title="export"></a>export</h2><p>在bash下，使用export建立环境变量后，会影响到子shell脚本和当前shell的环境变量</p>
<p>比如在/etc/profile中的export中的变量，自己新建的sh文件可以获取到</p>
<h2 id="unset"><a href="#unset" class="headerlink" title="unset"></a>unset</h2><p>删除环境变量</p>
<p>unset a</p>
<p>echo $a</p>
<p> (此处为空行,a已经被删除)</p>
<p><img src="/../img/image-20220221100736917.png" alt="image-20220221100736917"></p>
<h2 id="let"><a href="#let" class="headerlink" title="let"></a>let</h2><p>在bash中只用此命令可以建立一个临时的变量，此变量不会影响到子shell</p>
<h1 id="7-shell脚本中执行时提示“没有那个文件或目录”的解决办法"><a href="#7-shell脚本中执行时提示“没有那个文件或目录”的解决办法" class="headerlink" title="7.shell脚本中执行时提示“没有那个文件或目录”的解决办法"></a>7.shell脚本中执行时提示“没有那个文件或目录”的解决办法</h1><p>vim filename<br>然后用命令 :set ff<br>可看到dos或unix的字样，如果的确是dos格式的, 那么用set ff=unix把它强制为unix格式的,，然后存盘退出后就可运行。</p>
<h1 id="8-逻辑判断"><a href="#8-逻辑判断" class="headerlink" title="8.逻辑判断"></a>8.<strong>逻辑判断</strong></h1><p><img src="/../img/image-20220221144510050.png" alt="image-20220221144510050"></p>
<p><img src="/../img/image-20220221113241712.png" alt="image-20220221113241712"></p>
<p><img src="/../img/image-20220221113251126.png" alt="image-20220221113251126"></p>
<p>注意，if后的[] ，要有空格，而[]里也要有空格。分号后也要有空格，要有fi结尾</p>
<h2 id="test命令"><a href="#test命令" class="headerlink" title="test命令"></a>test命令</h2><p><a href="https://blog.csdn.net/magiclyj/article/details/77923274?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164541445916781683931124%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164541445916781683931124&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-77923274.first_rank_v2_pc_rank_v29&amp;utm_term=shell%E4%B8%ADtest%E5%8A%A0%E4%B8%8E%E4%B8%8D%E5%8A%A0&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/magiclyj/article/details/77923274?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164541445916781683931124%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164541445916781683931124&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-77923274.first_rank_v2_pc_rank_v29&amp;utm_term=shell%E4%B8%ADtest%E5%8A%A0%E4%B8%8E%E4%B8%8D%E5%8A%A0&amp;spm=1018.2226.3001.4187</a></p>
<p>不使用[],可以用test</p>
<p><img src="/../img/image-20220221113608498.png" alt="image-20220221113608498"></p>
<p><img src="/../img/image-20220221113640101.png" alt="image-20220221113640101"></p>
<h1 id="9-时间"><a href="#9-时间" class="headerlink" title="9.时间"></a>9.时间</h1><p>date</p>
<p>date ‘+%Y%m%d%H%M%S’</p>
<p><img src="/../img/image-20220221104819464.png" alt="image-20220221104819464"></p>
<p><img src="/../img/image-20220221110203826.png" alt="image-20220221110203826"></p>
<h1 id="10-shell-脚本中-d-e-f的区别"><a href="#10-shell-脚本中-d-e-f的区别" class="headerlink" title="10.shell 脚本中-d,-e,-f的区别"></a>10.shell 脚本中-d,-e,-f的区别</h1><p>-e filename 如果 filename存在，则为真<br>-d filename 如果 filename为目录，则为真<br>-f filename 如果 filename为<a href="http://www.so.com/s?q=%E5%B8%B8%E8%A7%84&ie=utf-8&src=internal_wenda_recommend_textn">常规</a>文件，则为真</p>
<h1 id="11-shell中-和-、-、-、-和-使用"><a href="#11-shell中-和-、-、-、-和-使用" class="headerlink" title="11.shell中``和$()、$(())、${}、[]和[[]]使用"></a>11.shell中``和$()、$(())、${}、[]和[[]]使用</h1><h2 id="和"><a href="#和" class="headerlink" title="``和$()"></a>``和$()</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$()与``都是用来做命令替换的。</span><br><span class="line">两个的区别在于``须要额外的跳脱( \` )处理</span><br><span class="line">举个列子：</span><br><span class="line">cmd1 `cmd2 `cmd3` `看这个初学者可能不知道这是什么意思,这句话其实是错误的,本意是想先执行cmd3,执行完之后交给cmd2再执行,最后再执行cmd1</span><br><span class="line">正确的写法应该是 cmd1 `cmd2 \`cmd3\` `还得转义。</span><br><span class="line">如果是换成$()的话，就可以写成cmd1 $(cmd2 $(cmd3)),只要你喜欢，做多少层的替换都没问题。</span><br><span class="line">$( ) 的不足:</span><br><span class="line">``基本上可用在全部的 unix shell 中使用，若写成 shell script ，其移植性比较高。</span><br><span class="line">而 $( ) 并不见的每一种 shell 都能使用。</span><br></pre></td></tr></table></figure>

<h2 id><a href="#" class="headerlink" title="${}"></a>${}</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123; &#125; 用来作变量替换。</span><br><span class="line">一般情况下，$var 与 $&#123;var&#125; 并没有啥不一样。</span><br><span class="line">但是用 $&#123; &#125; 会比较精确的界定变量名称的范围，比方说：</span><br><span class="line">$ A=B</span><br><span class="line">$ echo $AB</span><br><span class="line">原本是打算先将 $A 的结果替换出来，然后再补一个 B 字母于其后，</span><br><span class="line">但在命令行上，真正的结果却是只会提换变量名称为 AB 的值出来…</span><br><span class="line">若使用 $&#123; &#125; 就没问题了：</span><br><span class="line">$ echo $&#123;A&#125;B</span><br><span class="line">BB</span><br><span class="line"></span><br><span class="line">#字符串截取</span><br><span class="line">file=/dir1/dir2/dir3/my.file.txt</span><br><span class="line">我们可以用 $&#123; &#125; 分别替换获得不同的值：</span><br><span class="line">$&#123;file#*/&#125;：拿掉第一条 / 及其左边的字符串：dir1/dir2/dir3/my.file.txt</span><br><span class="line">$&#123;file##*/&#125;：拿掉最后一条 / 及其左边的字符串：my.file.txt</span><br><span class="line">$&#123;file#*.&#125;：拿掉第一个 .  及其左边的字符串：file.txt</span><br><span class="line">$&#123;file##*.&#125;：拿掉最后一个 .  及其左边的字符串：txt</span><br><span class="line">$&#123;file%/*&#125;：拿掉最后条 / 及其右边的字符串：/dir1/dir2/dir3</span><br><span class="line">$&#123;file%%/*&#125;：拿掉第一条 / 及其右边的字符串：(空值)</span><br><span class="line">$&#123;file%.*&#125;：拿掉最后一个 .  及其右边的字符串：/dir1/dir2/dir3/my.file</span><br><span class="line">$&#123;file%%.*&#125;：拿掉第一个 .  及其右边的字符串：/dir1/dir2/dir3/my</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#字符串替换</span><br><span class="line">我们也可以对变量值里的字符串作替换：其中file是变量</span><br><span class="line">$&#123;file/dir/path&#125;：将第一个 dir 提换为 path：/path1/dir2/dir3/my.file.txt</span><br><span class="line">$&#123;file//dir/path&#125;：将全部 dir 提换为 path：/path1/path2/path3/my.file.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">利用 $&#123; &#125; 还可针对不同的变量状态赋值(没设定、空值、非空值)： </span><br><span class="line">$&#123;file-my.file.txt&#125; ：假如 $file 没有设定，则使用 my.file.txt 作传回值。(空值及非空值时不作处理) </span><br><span class="line">$&#123;file:-my.file.txt&#125; ：假如 $file 没有设定或为空值，则使用 my.file.txt 作传回值。 (非空值时不作处理)</span><br><span class="line">$&#123;file+my.file.txt&#125; ：假如 $file 设为空值或非空值，均使用 my.file.txt 作传回值。(没设定时不作处理)</span><br><span class="line">$&#123;file:+my.file.txt&#125; ：若 $file 为非空值，则使用 my.file.txt 作传回值。 (没设定及空值时不作处理)</span><br><span class="line">$&#123;file=my.file.txt&#125; ：若 $file 没设定，则使用 my.file.txt 作传回值，同时将 $file 赋值为 my.file.txt 。 (空值及非空值时不作处理)</span><br><span class="line">$&#123;file:=my.file.txt&#125; ：若 $file 没设定或为空值，则使用 my.file.txt 作传回值，同时将 $file 赋值为 my.file.txt 。 (非空值时不作处理)</span><br><span class="line">$&#123;file?my.file.txt&#125; ：若 $file 没设定，则将 my.file.txt 输出至 STDERR。 (空值及非空值时不作处理)</span><br><span class="line">$&#123;file:?my.file.txt&#125; ：若 $file 没设定或为空值，则将 my.file.txt 输出至 STDERR。 (非空值时不作处理)</span><br><span class="line"></span><br><span class="line">#计算出变量值的长度</span><br><span class="line">$&#123;#var&#125; ，其中var为变量</span><br></pre></td></tr></table></figure>

<h2 id="和expr"><a href="#和expr" class="headerlink" title="$(())和expr"></a>$(())和expr</h2><p>expr 3 + 2</p>
<p><img src="/../img/image-20220221144645994.png" alt="image-20220221144645994"></p>
<p>它是用来作整数运算</p>
<p>$((a++))</p>
<p>a=5; b=7; c=2<br>echo $(( a+b</p>
<p>也可以<br>$(( $a + $b * $c)) 也可得到 19 的结果<br><img src="/../img/image-20220221111810327.png" alt="image-20220221111810327"></p>
<p><img src="/../img/image-20220221111818271.png" alt="image-20220221111818271"></p>
<p><img src="/../img/image-20220221143704302.png" alt="image-20220221143704302"></p>
<h2 id="和-1"><a href="#和-1" class="headerlink" title="[]和[[]]"></a>[]和[[]]</h2><p>1.相同点：<br>二者都支持算术比较和字符串比较表达式（具体使用可能有点不同）<br>条件表达式要放在方括号之间，并且要有空格，例如: [$a==$b] 是错误的，必须写成 [ $a == $b ]。</p>
<p>[ 1 == 1 ]&amp;&amp;echo true||echo false</p>
<p>true</p>
<p><img src="/../img/image-20220221112450776.png" alt="image-20220221112450776"></p>
<p>2.不同点：</p>
<p>[[ … ]]进行算术扩展，而[ … ]不做</p>
<p><img src="/../img/image-20220221112602080.png" alt="image-20220221112602080"></p>
<h1 id="12-字符串截取"><a href="#12-字符串截取" class="headerlink" title="12.字符串截取"></a>12.字符串截取</h1><p><a href="https://blog.csdn.net/qq_33951180/article/details/68059098?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164541283916780265450858%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164541283916780265450858&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-68059098.first_rank_v2_pc_rank_v29&amp;utm_term=shell%E6%88%AA%E5%8F%96%E5%AD%97%E7%AC%A6%E4%B8%B2&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/qq_33951180/article/details/68059098?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164541283916780265450858%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=164541283916780265450858&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-68059098.first_rank_v2_pc_rank_v29&amp;utm_term=shell%E6%88%AA%E5%8F%96%E5%AD%97%E7%AC%A6%E4%B8%B2&amp;spm=1018.2226.3001.4187</a></p>
<p>替换</p>
<p>我们也可以对变量值里的字符串作替换：其中file是变量<br>${file/dir/path}：将第一个 dir 提换为 path：/path1/dir2/dir3/my.file.txt<br>${file//dir/path}：将全部 dir 提换为 path：/path1/path2/path3/my.file.txt</p>
<h1 id="13-grep"><a href="#13-grep" class="headerlink" title="13.grep"></a>13.<strong>grep</strong></h1><p>查找某个文件夹下的文件</p>
<p>ls -l 路径|grep ^- |wc -l</p>
<h1 id="14-例子"><a href="#14-例子" class="headerlink" title="14.例子"></a>14.例子</h1><p>50服务器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#启动jar包脚本</span><br><span class="line">#!/bin/bash</span><br><span class="line">#找到与jar包名称一致的进程</span><br><span class="line">jar_pid=`ps -ef|grep -v grep | grep &#x27;nbd-traffic-nantong-2.0.0.jar&#x27;|awk &#x27;&#123; print $2 &#125;&#x27;`</span><br><span class="line">echo $jar_pid</span><br><span class="line">#如果不存在该进程</span><br><span class="line">if [ ! -n &quot;$jar_pid&quot; ]; then</span><br><span class="line">echo &#x27;will redploy.&#x27;</span><br><span class="line">#删除nohup.out，启动jar</span><br><span class="line">rm -rf nohup.out</span><br><span class="line">nohup java -Xms512m -Xmx2048m -Dspring.profiles.active=dev -jar nbd-traffic-nantong-2.0.0.jar &amp;</span><br><span class="line">echo &#x27;redploy success0.&#x27;</span><br><span class="line">else</span><br><span class="line">#存在，关闭进程</span><br><span class="line">kill -9 $jar_pid</span><br><span class="line">echo &#x27;kill&#x27; $jar_pid</span><br><span class="line">#删除nohup.out，启动jar</span><br><span class="line">rm -rf nohup.out</span><br><span class="line">nohup java -Xms512m -Xmx2048m -Dspring.profiles.active=dev -jar nbd-traffic-nantong-2.0.0.jar &amp;</span><br><span class="line">echo &#x27;redploy success1.&#x27;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#备份脚本</span><br><span class="line">#!/bin/bash</span><br><span class="line">#jarName是第一个参数，运行脚本命令 sh backup.sh a.jar</span><br><span class="line">jarName=$&#123;1&#125;</span><br><span class="line">#查看本路径</span><br><span class="line">path=`pwd`</span><br><span class="line">#打印时间</span><br><span class="line">time=`date &#x27;+%Y%m%d%H%M%S&#x27;`</span><br><span class="line">#时间</span><br><span class="line">date=$(date &quot;+%Y-%m-%d %H:%M:%S&quot;)</span><br><span class="line">reservedNum=5</span><br><span class="line">#如果目录不存在，创建</span><br><span class="line">if [ ! -d &quot;$path/backup&quot; ]; then</span><br><span class="line">	mkdir $path/backup</span><br><span class="line">	echo &quot;Folder created successfully!&quot;</span><br><span class="line">else</span><br><span class="line">	echo &quot;The folder already exists!&quot;</span><br><span class="line">fi</span><br><span class="line">sleep 0.5</span><br><span class="line">#如果本jar存在了，复制本jar包，强制不提示复制到backup下+上时间戳</span><br><span class="line">if [ -f &quot;$path/$jarName&quot; ];then</span><br><span class="line">	echo &quot;$jarName File exists!&quot;</span><br><span class="line">	cp -f $jarName $path/backup/$jarName$time.bak</span><br><span class="line">	if [ -f &quot;$path/backup/$jarName$time.bak&quot; ];then</span><br><span class="line">	#然后删除jar包</span><br><span class="line">		rm -rf $jarName</span><br><span class="line">		#统计backup下有几个文件，如果大于5个</span><br><span class="line">		fileNum=$(ls -l $path/backup|grep ^- |wc -l)</span><br><span class="line">		while(( $fileNum &gt; $reservedNum))</span><br><span class="line">		do</span><br><span class="line">		#-r倒叙，-t时间排序，根据时间找到最老的文件删除</span><br><span class="line">			oldFile=$(ls -rt $path/backup| head -1)</span><br><span class="line">			echo  $date &quot;Delete File:&quot;$oldFile</span><br><span class="line">			rm -rf $path/backup/$oldFile</span><br><span class="line">			#然后文件数-1=5</span><br><span class="line">			let &quot;fileNum--&quot;</span><br><span class="line">		done</span><br><span class="line">		echo &quot;File backup succeeded!&quot;</span><br><span class="line">	else</span><br><span class="line">		echo &quot;File backup failed!&quot;</span><br><span class="line">	fi</span><br><span class="line">else</span><br><span class="line">	echo &quot;The file does not exist!&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h1 id="15-case"><a href="#15-case" class="headerlink" title="15.case"></a>15.case</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">a=5;</span><br><span class="line">case $a in</span><br><span class="line">	1)</span><br><span class="line">	echo &#x27;a&#x27;;;</span><br><span class="line">	5)</span><br><span class="line">	echo &#x27;b&#x27;;;</span><br><span class="line">	*)</span><br><span class="line">	echo &#x27;unkown&#x27;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220221142620311.png" alt="image-20220221142620311"></p>
<h1 id="16-while"><a href="#16-while" class="headerlink" title="16.while"></a>16.while</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">a=5;</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">	echo &#x27;a&#x27;</span><br><span class="line">	((a++))</span><br><span class="line">	echo $a</span><br><span class="line">	if [ $a -ge 10 ]; then</span><br><span class="line">		break;</span><br><span class="line">	fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220221144543902.png" alt="image-20220221144543902"></p>
<h1 id="17-for"><a href="#17-for" class="headerlink" title="17.for"></a>17.for</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#格式</span><br><span class="line">for 变量 in 名字列表 </span><br><span class="line">do </span><br><span class="line">命令列表 </span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for n in &#123;1..10&#125;</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $n</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for letter in a b c d e;</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $letter</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>for循环</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for (( i=1;$i&lt;10;i++))</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $i</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="18-逻辑判断的表达"><a href="#18-逻辑判断的表达" class="headerlink" title="18.逻辑判断的表达"></a>18.逻辑判断的表达</h1><h2 id="一、判断文件的属性"><a href="#一、判断文件的属性" class="headerlink" title="*一、判断文件的属性"></a>*一、判断文件的属性</h2><p>格式：-操作符 filename<br>-e 文件存在返回1， 否则返回0<br>-r 文件可读返回1,否则返回0<br>-w 文件可写返回1,否则返回0<br>-x 文件可执行返回1,否则返回0<br>-o 文件属于用户本人返回1, 否则返回0<br>-z 文件长度为0返回1, 否则返回0.<br>-f 文件为普通文件返回1, 否则返回0<br>-d 文件为目录文件时返回1, 否则返回0 </p>
<h2 id="二、测试字符串"><a href="#二、测试字符串" class="headerlink" title="二、测试字符串"></a>二、测试字符串</h2><p>字符串1 = 字符串2　当两个字串相等时为真<br>字符串1 != 字符串2 当两个字串不等时为真<br>-n 字符串　 　　 当字符串的长度大于0时为真<br>-z 字符串　　　　　 当字符串的长度为0时为真<br>字符串　　　　　　 当串字符串为非空时为真 </p>
<h2 id="三、测试两个整数关系"><a href="#三、测试两个整数关系" class="headerlink" title="三、测试两个整数关系"></a>三、测试两个整数关系</h2><p>数字1 -eq 数字2　　　　 两数相等为真<br>数字1 -ne 数字2　　　　 两数不等为真<br>数字1 -gt 数字2　　　　 数字1大于数字2为真<br>数字1 -ge 数字2 　　 数字1大于等于数字2为真<br>数字1 -lt 数字2　　　　 数字1小于数字2为真<br>数字1 -le 数字2　　　　 数字1小于等于数字2为真 </p>
<h2 id="四、逻辑测试"><a href="#四、逻辑测试" class="headerlink" title="四、逻辑测试"></a>四、逻辑测试</h2><p>-a  　　　　 与<br>-o　　　　　　　 或<br>!　　　　　　　　非* </p>
<h1 id="19-shell中的表达式"><a href="#19-shell中的表达式" class="headerlink" title="19.shell中的表达式"></a>1<strong>9.shell中的表达式</strong></h1><h2 id="1-管道"><a href="#1-管道" class="headerlink" title="1.管道 |"></a>1.管道 |</h2><p>就管道符前的命令的输出作为管道符后的命令的输入。</p>
<p>ls | grep ‘.txt’</p>
<p>将ls的输出作为grep 的输入。 grep从输入中找出所有包含.txt的行。</p>
<h2 id="2-输出-gt"><a href="#2-输出-gt" class="headerlink" title="2.输出 &gt;"></a>2.输出 &gt;</h2><p>将右尖括号前的命令的输入重定向到尖括号后的文件中。</p>
<p>例如：</p>
<p>ls *.sh &gt; list.txt</p>
<p>将当前目录下所有末尾名为sh的文件的列表写入到list.txt</p>
<h3 id="3-输入-lt"><a href="#3-输入-lt" class="headerlink" title="3.输入 &lt;"></a>3.输入 &lt;</h3><p>将左箭头后面的文件作为左箭头前的命令的输入。</p>
<p>例如：</p>
<p>grep “a” &lt; test.sh</p>
<p>将test.sh中找到所有包含a的行</p>
<h2 id="4-错误输出重定向"><a href="#4-错误输出重定向" class="headerlink" title="4.错误输出重定向"></a>4.错误输出重定向</h2><p>默认bash有3个标准输入输出设备。</p>
<p>0 标准输入</p>
<p>1 标准输出</p>
<p>2错误输出</p>
<p>如果执行脚本的时候发生错误，会输出到2上。</p>
<p>要想就将错误的输出也输出在标准输出上，需要重定向。</p>
<p>例如：</p>
<p>./test.sh &gt; a.log 2&gt;&amp;1</p>
<p>后面2&gt;&amp;1就是将标准错误的输出重定向到标准输出上。</p>
<h2 id="5-tee"><a href="#5-tee" class="headerlink" title="5.tee"></a>5.tee</h2><p>将此命令的输入分叉，一支输出到屏幕一支可以重定向到其他位置。</p>
<p>例如： ./test.sh | tee &gt;a.txt 2&gt;&amp;1</p>
<p>运行test.sh，通过tee输出到a.txt，同时屏幕上可以看到输出。并且将错误输出重定向到标准输出( 2&gt;&amp;1 )</p>
<h2 id="6-exec"><a href="#6-exec" class="headerlink" title="6.exec"></a>6.exec</h2><p>将此命令后的参数作为命令在当前的shell中执行，当前的shell或者脚本不在执行。</p>
<p>例如： exec ls</p>
<p>当前进程替换为ls,执行结束后就退出了。</p>
<p>例如：在a.sh 中包含</p>
<p>exec b.sh 则当a.sh 执行到此句后，被b.sh替换，a.sh中此句后的语句不会再被执行。</p>
<h2 id="7-read"><a href="#7-read" class="headerlink" title="7.read"></a>7.read</h2><p>从标准输入读取数据</p>
<p><img src="/../img/image-20220221151049998.png" alt="image-20220221151049998"></p>
<h2 id="8-shift"><a href="#8-shift" class="headerlink" title="8.shift"></a>8.shift</h2><p>每次调用的时候，将参数列表中的第一个参数去掉。这样可以循环得到第一个参数。</p>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sum=0</span><br><span class="line">#一直到参数个数=0之前都do</span><br><span class="line">until [ $# -eq 0 ]</span><br><span class="line">do</span><br><span class="line">echo $*</span><br><span class="line">sum=`expr $sum + $1`</span><br><span class="line">shift</span><br><span class="line">done</span><br><span class="line">echo result is: $sum</span><br></pre></td></tr></table></figure>

<p>#./t.sh 1 2 3</p>
<p>1 2 3</p>
<p>2 3</p>
<p>3</p>
<h2 id="9-awk"><a href="#9-awk" class="headerlink" title="9.awk"></a>9.awk</h2><p>提取输入中的某个参数</p>
<p>提取输入中每一行的第一个参数</p>
<p>du:显示文件的大小</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">\#echo `du *.txt | awk ‘&#123;print $1&#125;’`</span><br><span class="line"></span><br><span class="line">1230 456</span><br></pre></td></tr></table></figure>

<h2 id="10-前后台运行"><a href="#10-前后台运行" class="headerlink" title="10.前后台运行"></a>10.前后台运行</h2><p>将某个程序在后台启动起来，只需要在命令的最后加上 &amp; 符号。</p>
<p>例如： ./test.sh &amp;</p>
<h1 id="20-nohup"><a href="#20-nohup" class="headerlink" title="20.nohup"></a>20.nohup</h1><p>不挂断地运行命令</p>
<p>无论是否将 nohup 命令的输出<a href="https://so.csdn.net/so/search?q=%E9%87%8D%E5%AE%9A%E5%90%91&spm=1001.2101.3001.7020">重定向</a>到终端，输出都将附加到当前目录的 nohup.out 文件中</p>
<h1 id="21-ps-ef"><a href="#21-ps-ef" class="headerlink" title="21.ps -ef"></a>21.ps -ef</h1><p>用于查看当前所有的进程。</p>
<h1 id="22-ll相关"><a href="#22-ll相关" class="headerlink" title="22.ll相关"></a>22.ll相关</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、按照时间倒叙排列——  ll -nt ( LNT,大写备注区分一下)</span><br><span class="line">2、安照时间正序排列—— ll -rt (LRT)</span><br><span class="line">3、按照文件名正序排序（默认的排序方式）—— -l</span><br><span class="line">4、按照文件名倒叙排列 —— -lr</span><br><span class="line">5、按照大小升序——   -IS</span><br><span class="line">6、按照大小降序 —— -S</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Socket</title>
    <url>/2021/11/30/socket/</url>
    <content><![CDATA[<p>使用的流为DataInput(Out)Stream</p>
<h1 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port=<span class="number">4001</span>;</span><br><span class="line">        <span class="comment">//首先直接创建serversocket</span></span><br><span class="line">        ServerSocket server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用服务器的accept（）进行阻塞（程序会在这等待），当有申请连接时会打开阻塞并返回一个socket</span></span><br><span class="line">        System.out.println(<span class="string">&quot;服务器端已启动&quot;</span>);</span><br><span class="line">        Socket socket = server.accept();</span><br><span class="line">        <span class="comment">//获取输入流和输出流</span></span><br><span class="line">        DataInputStream dis= <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">        DataOutputStream dos= <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(socket.isClosed())&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;关闭程序&quot;</span>);</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            String str=dis.readUTF();</span><br><span class="line">            System.out.println(<span class="string">&quot;客户端发送的数据为：&quot;</span>+str);</span><br><span class="line">            dos.writeUTF(<span class="string">&quot;服务器端收到了：&quot;</span>+str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//CloseUtil.closeAll(dos,dis,server,socket);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.thread.ExecutorBuilder;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.thread.ThreadUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> port=<span class="number">4001</span>;</span><br><span class="line">        <span class="comment">//首先直接创建socket对象</span></span><br><span class="line">        Socket client = <span class="keyword">new</span> Socket(<span class="string">&quot;localhost&quot;</span>, port);</span><br><span class="line">        <span class="comment">//设置连接超时时间</span></span><br><span class="line">        client.setSoTimeout(<span class="number">3000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;客户端已启动&quot;</span>);</span><br><span class="line">        ExecutorService executor = ExecutorBuilder.create()<span class="comment">//</span></span><br><span class="line">                .setCorePoolSize(<span class="number">2</span>)<span class="comment">//</span></span><br><span class="line">                .setMaxPoolSize(<span class="number">2</span>)<span class="comment">//</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//创建发送的线程</span></span><br><span class="line">        Send send =<span class="keyword">new</span> Send(client);</span><br><span class="line">        <span class="comment">//创建接受的线程</span></span><br><span class="line">        Receive receive=<span class="keyword">new</span> Receive(client);</span><br><span class="line">        executor.submit(send);</span><br><span class="line">        executor.submit(receive);</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="客户端又分为两类"><a href="#客户端又分为两类" class="headerlink" title="客户端又分为两类"></a>客户端又分为两类</h2><h3 id="1-发送"><a href="#1-发送" class="headerlink" title="1.发送"></a>1.发送</h3><p>发送从键盘获取数据，使用BufferedReader流</p>
<p>发送给服务端，DataOutputStream</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/01/20  8:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">   <span class="comment">//从键盘获取数据</span></span><br><span class="line">   BufferedReader br;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//发送数据的数据流</span></span><br><span class="line">   <span class="comment">//PrintWriter socketOut = new PrintWriter(socket.getOutputStream());</span></span><br><span class="line">   DataOutputStream dos;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> flag=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Send</span><span class="params">()</span></span>&#123;</span><br><span class="line">      br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Send</span><span class="params">(Socket client)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>();<span class="comment">//调用本类无参构造方法</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         dos = <span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         flag=<span class="keyword">false</span>;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         CloseUtil.closeAll(br,client,dos);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//获取消息</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> String <span class="title">getMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">      String str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         str = br.readLine();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         flag=<span class="keyword">false</span>;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         CloseUtil.closeAll(br);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> str;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//发送消息</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         dos.writeUTF(str);</span><br><span class="line">         <span class="comment">//清空缓存，输出</span></span><br><span class="line">         dos.flush();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         CloseUtil.closeAll(dos);</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span>(flag)&#123;</span><br><span class="line">         String message = getMessage();</span><br><span class="line">         <span class="keyword">if</span>(message.equals(<span class="string">&quot;bye&quot;</span>))&#123;</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">this</span>.sendMessage(message);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-接受"><a href="#2-接受" class="headerlink" title="2.接受"></a>2.接受</h3><p>DataInputStream，输入流</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/01/20  9:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receive</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">   <span class="comment">//接收数据的数据流</span></span><br><span class="line">   <span class="comment">//BufferedReader socketIn = new BufferedReader(new InputStreamReader(client.getInputStream()));</span></span><br><span class="line">   DataInputStream dis;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> flag=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Receive</span><span class="params">(Socket client)</span></span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         dis = <span class="keyword">new</span> DataInputStream(client.getInputStream());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         flag=<span class="keyword">false</span>;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         CloseUtil.closeAll(dis,client);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//获取消息</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> String <span class="title">getMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">      String str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         str = dis.readUTF();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         flag=<span class="keyword">false</span>;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         CloseUtil.closeAll(dis);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> str;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span>(flag)&#123;</span><br><span class="line">         System.out.println(getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="基于socket的网络聊天室"><a href="#基于socket的网络聊天室" class="headerlink" title="基于socket的网络聊天室"></a>基于socket的网络聊天室</h1><h2 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h2><p>客户端代码不变，多开几个main方法就是多个客户</p>
<p><img src="/../img/image-20220120150119854.png" alt="image-20220120150119854"></p>
<h2 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h2><p>也变成多线程的模式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.socket.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jiang.demo.socket.CloseUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/01/20  14:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyChannel</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 每一个客户端都是一条道路</span></span><br><span class="line"><span class="comment">    * 1.输入流</span></span><br><span class="line"><span class="comment">    * 2.输出流</span></span><br><span class="line"><span class="comment">    * 3.接收数据</span></span><br><span class="line"><span class="comment">    * 4.发送数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">   <span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> flag=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MyChannel</span><span class="params">(Socket client)</span></span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         dis=<span class="keyword">new</span> DataInputStream(client.getInputStream());</span><br><span class="line">         dos=<span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         flag=<span class="keyword">false</span>;</span><br><span class="line">         CloseUtil.closeAll(dis,dos);</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         Server.list.remove(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//接受数据的方法</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> String <span class="title">receive</span><span class="params">()</span></span>&#123;</span><br><span class="line">      String str=<span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         str=dis.readUTF();</span><br><span class="line">      &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">         flag=<span class="keyword">false</span>;</span><br><span class="line">         CloseUtil.closeAll(dis,dos);</span><br><span class="line">         Server.list.remove(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> str;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//发送数据方法</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(str!=<span class="keyword">null</span> &amp;&amp; str.length()!=<span class="number">0</span>)&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            dos.writeUTF(str);</span><br><span class="line">            <span class="comment">//清空缓存，输出</span></span><br><span class="line">            dos.flush();</span><br><span class="line">         &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            flag=<span class="keyword">false</span>;</span><br><span class="line">            CloseUtil.closeAll(dos);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            Server.list.remove(<span class="keyword">this</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//转发方法</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendOther</span><span class="params">()</span></span>&#123;</span><br><span class="line">      String str=<span class="keyword">this</span>.receive();</span><br><span class="line">      List&lt;MyChannel&gt; list=Server.list;</span><br><span class="line">      <span class="keyword">for</span> (MyChannel other : list) &#123;</span><br><span class="line">         <span class="keyword">if</span>(other==<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;<span class="comment">//不发送给自己</span></span><br><span class="line">         &#125;</span><br><span class="line">         other.sendMessage(str);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span>(flag)&#123;</span><br><span class="line"><span class="comment">//       String message = receive();</span></span><br><span class="line"><span class="comment">//       if(message.equals(&quot;bye&quot;))&#123;</span></span><br><span class="line"><span class="comment">//          System.exit(1);</span></span><br><span class="line"><span class="comment">//       &#125;</span></span><br><span class="line"><span class="comment">//       this.sendMessage(message);</span></span><br><span class="line">         <span class="keyword">this</span>.sendOther();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.demo.socket.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.thread.ExecutorBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.security.auth.Subject;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建集合对象，存储每一个连接进来的客户端</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;MyChannel&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port=<span class="number">4001</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//首先直接创建serversocket</span></span><br><span class="line">        ServerSocket server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用服务器的accept（）进行阻塞（程序会在这等待），当有申请连接时会打开阻塞并返回一个socket</span></span><br><span class="line">        System.out.println(<span class="string">&quot;服务器端已启动&quot;</span>);</span><br><span class="line">        <span class="comment">//线程数量要大于用户数，如果为1个线程，那么只能1个客户向其他客户发送消息，</span></span><br><span class="line">        <span class="comment">// 只有当这个客户进程关闭了，其他客户进程才能占用线程</span></span><br><span class="line">        ExecutorService executor = ExecutorBuilder.create()<span class="comment">//</span></span><br><span class="line">                .setCorePoolSize(<span class="number">1</span>)<span class="comment">//</span></span><br><span class="line">                .setMaxPoolSize(<span class="number">1</span>)<span class="comment">//</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Socket socket = server.accept();</span><br><span class="line">            <span class="comment">//每当有一个socket进来，就会创建一个新的channel，就是一个新的客户端</span></span><br><span class="line">            MyChannel channel=<span class="keyword">new</span> MyChannel(socket);</span><br><span class="line">            <span class="comment">//添加到集合中</span></span><br><span class="line">            list.add(channel);</span><br><span class="line">            executor.submit(channel);</span><br><span class="line">            <span class="comment">//这块需要注释掉，因为不能关闭线程池，随时都可能有新的用户加入</span></span><br><span class="line">            <span class="comment">//executor.shutdown();</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//CloseUtil.closeAll(dos,dis,server,socket);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="1-WebSocket介绍"><a href="#1-WebSocket介绍" class="headerlink" title="1.WebSocket介绍"></a>1.WebSocket介绍</h1><p><img src="/../img/image-20211228194155741.png" alt="image-20211228194155741"></p>
<h2 id="http协议："><a href="#http协议：" class="headerlink" title="http协议："></a>http协议：</h2><p><img src="/../img/image-20211228194221640.png" alt="image-20211228194221640"></p>
<h2 id="websocket："><a href="#websocket：" class="headerlink" title="websocket："></a>websocket：</h2><p><img src="/../img/image-20211228194447047.png" alt="image-20211228194447047"></p>
<h3 id="握手：两次连接即可"><a href="#握手：两次连接即可" class="headerlink" title="握手：两次连接即可"></a>握手：两次连接即可</h3><p>基于http协议，注意是基于，而不是http</p>
<p>客户端请求头</p>
<p><img src="/../img/image-20211228195548524.png" alt="image-20211228195548524"></p>
<p>ws是websocket的</p>
<p>而http的话就是http协议</p>
<p><img src="/../img/image-20211228195823658.png" alt="image-20211228195823658"></p>
<p>服务器响应头</p>
<p><img src="/../img/image-20211228195608891.png" alt="image-20211228195608891"></p>
<h3 id="数据交互：可以客户端主动发，可以服务器主动发"><a href="#数据交互：可以客户端主动发，可以服务器主动发" class="headerlink" title="数据交互：可以客户端主动发，可以服务器主动发"></a>数据交互：可以客户端主动发，可以服务器主动发</h3><h2 id="websocket对象创建以及事件"><a href="#websocket对象创建以及事件" class="headerlink" title="websocket对象创建以及事件"></a>websocket对象创建以及事件</h2><p><img src="/../img/image-20211228200352396.png" alt="image-20211228200352396"></p>
<h2 id="给服务端发送数据"><a href="#给服务端发送数据" class="headerlink" title="给服务端发送数据"></a>给服务端发送数据</h2><p><img src="/../img/image-20211228203502511.png" alt="image-20211228203502511"></p>
<h2 id="服务实现"><a href="#服务实现" class="headerlink" title="服务实现"></a>服务实现</h2><p><img src="/../img/image-20211228211852580.png" alt="image-20211228211852580"></p>
<p><img src="/../img/image-20211228212102159.png" alt="image-20211228212102159"></p>
<p><img src="/../img/image-20211228212704049.png" alt="image-20211228212704049"></p>
<p><img src="/../img/image-20211228212731840.png" alt="image-20211228212731840"></p>
<h1 id="2-需求"><a href="#2-需求" class="headerlink" title="2.需求"></a>2.需求</h1><p>一个浏览器看做一个客户端，服务器只有一个，浏览器1想给2发送消息，先发送给服务端，服务端解析，然后由服务端发送给2</p>
<p><img src="/../img/image-20211228213257906.png" alt="image-20211228213257906"></p>
<p><img src="/../img/image-20211228214415754.png" alt="image-20211228214415754"></p>
<h1 id="3-功能实现"><a href="#3-功能实现" class="headerlink" title="3.功能实现"></a>3.功能实现</h1><p>config</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.websocket.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/01/25  14:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注入一个ServerEndpointExporter,该Bean会自动注册使用</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@ServerEndpoint</span>注解声明的websocket endpoint</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ServerEndpointExporter <span class="title">serverEndpointExporter</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ServerEndpointExporter();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>写websocket的核心代码</p>
<p><img src="/../img/image-20220125152430261.png" alt="image-20220125152430261"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/01/25  14:52</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:webSocket服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ServerEndpoint(value = &quot;/imserver/&#123;username&#125;&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 记录当前在线用户数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Session&gt; SESSION_MAP=<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 连接成功调用的方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@OnOpen</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;username&quot;)</span> String username)</span></span>&#123;</span><br><span class="line">		SESSION_MAP.put(username,session);</span><br><span class="line">		log.info(<span class="string">&quot;有新用户加入，username=&#123;&#125;，当前在线人数:&#123;&#125;&quot;</span>,username,SESSION_MAP.size());</span><br><span class="line">		JSONObject result = <span class="keyword">new</span> JSONObject();</span><br><span class="line">		JSONArray array = <span class="keyword">new</span> JSONArray();</span><br><span class="line">		result.set(<span class="string">&quot;users&quot;</span>,array);</span><br><span class="line">		<span class="keyword">for</span>(Object key : SESSION_MAP.keySet())&#123;</span><br><span class="line">			JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">			<span class="comment">//把所有的用户名放入users这个数据json中</span></span><br><span class="line">			<span class="comment">//&#123;&quot;username&quot;:&quot;a&quot;,&quot;username&quot;:&quot;b&quot;&#125;</span></span><br><span class="line">			jsonObject.set(<span class="string">&quot;username&quot;</span>,key);</span><br><span class="line">			array.add(jsonObject);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//最终结果,注意多了中间的&#123;&#125;，是一个个的对象了</span></span><br><span class="line">		<span class="comment">//&#123;&quot;users&quot;:[&#123;&quot;username&quot;:&quot;a&quot;&#125;,&#123;&quot;username&quot;:&quot;b&quot;&#125;]&#125;</span></span><br><span class="line">		sendAllMessage(JSONUtil.toJsonStr(result));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 连接关闭调用的方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@OnClose</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;username&quot;)</span> String username)</span></span>&#123;</span><br><span class="line">		SESSION_MAP.remove(username);</span><br><span class="line">		log.info(<span class="string">&quot;有一连接关闭，移除username=&#123;&#125;，当前在线人数：&#123;&#125;&quot;</span>,username,SESSION_MAP.size());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 收到客户端消息调用的方法</span></span><br><span class="line"><span class="comment">	 * 后台收到消息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@OnMessage</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String message,Session session, <span class="meta">@PathParam(&quot;username&quot;)</span> String username)</span></span>&#123;</span><br><span class="line">		log.info(<span class="string">&quot;服务端收到用户username=&#123;&#125;的消息&#123;&#125;&quot;</span>,username,message);</span><br><span class="line">		JSONObject obj = JSONUtil.parseObj(message);</span><br><span class="line">		String toUsername= obj.getStr(<span class="string">&quot;to&quot;</span>);</span><br><span class="line">		String text=obj.getStr(<span class="string">&quot;text&quot;</span>);</span><br><span class="line">		Session toSession=SESSION_MAP.get(toUsername);</span><br><span class="line">		<span class="keyword">if</span>(toSession!=<span class="keyword">null</span>)&#123;</span><br><span class="line">			JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">			jsonObject.set(<span class="string">&quot;from&quot;</span>,username);</span><br><span class="line">			jsonObject.set(<span class="string">&quot;text&quot;</span>,text);</span><br><span class="line">			<span class="keyword">this</span>.sendAllMessage(jsonObject.toString(),toSession);</span><br><span class="line">			log.info(<span class="string">&quot;发送给用户username=&#123;&#125;，消息:&#123;&#125;&quot;</span>,toUsername,jsonObject.toString());</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			log.info(<span class="string">&quot;发送失败，未找到用户&#123;&#125;的session&quot;</span>,toUsername);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@OnError</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Session session,Throwable error)</span></span>&#123;</span><br><span class="line">		log.error(<span class="string">&quot;发送失败&quot;</span>);</span><br><span class="line">		error.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 服务端发送给客户端</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> toSession</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendAllMessage</span><span class="params">(String message,Session toSession)</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			log.info(<span class="string">&quot;服务端发送给用户&#123;&#125;,消息为&#123;&#125;&quot;</span>,toSession.getId(),message);</span><br><span class="line">			<span class="comment">//发送到session</span></span><br><span class="line">			toSession.getBasicRemote().sendText(message);</span><br><span class="line">		&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">			log.error(<span class="string">&quot;服务端发送客户端失败&quot;</span>,e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 服务端群发给客户端</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendAllMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span>(Session session:SESSION_MAP.values())&#123;</span><br><span class="line">				log.info(<span class="string">&quot;服务端发送给客户端[&#123;&#125;]，消息&#123;&#125;&quot;</span>,session.getId(),message);</span><br><span class="line">				session.getBasicRemote().sendText(message);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">			log.error(<span class="string">&quot;服务端发送客户端失败&quot;</span>,e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-前端"><a href="#4-前端" class="headerlink" title="4.前端"></a>4.前端</h1><p>vue里关键页面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div style=&quot;padding: 10px; margin-bottom: 50px&quot;&gt;</span><br><span class="line">    &lt;el-row&gt;</span><br><span class="line">      &lt;el-col :span=&quot;4&quot;&gt;</span><br><span class="line">        &lt;el-card style=&quot;width: 300px; height: 300px; color: #333&quot;&gt;</span><br><span class="line">         &lt;div style=&quot;padding-bottom: 10px; border-bottom: 1px solid #ccc&quot;&gt;在线用户&lt;span style=&quot;font-size: 12px&quot;&gt;（点击聊天气泡开始聊天）&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">          &lt;div style=&quot;padding: 10px 0&quot; v-for=&quot;user in users&quot; :key=&quot;user.username&quot;&gt;</span><br><span class="line">            &lt;span&gt;&#123;&#123; user.username &#125;&#125;&lt;/span&gt;</span><br><span class="line">            &lt;i class=&quot;el-icon-chat-dot-round&quot; style=&quot;margin-left: 10px; font-size: 16px; cursor: pointer&quot;</span><br><span class="line">               @click=&quot;chatUser = user.username&quot;&gt;&lt;/i&gt;</span><br><span class="line">            &lt;span style=&quot;font-size: 12px;color: limegreen; margin-left: 5px&quot; v-if=&quot;user.username === chatUser&quot;&gt;chatting...&lt;/span&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/el-card&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line"></span><br><span class="line">      &lt;el-col :span=&quot;20&quot;&gt;</span><br><span class="line">        &lt;div style=&quot;width: 800px; margin: 0 auto; background-color: white;</span><br><span class="line">                    border-radius: 5px; box-shadow: 0 0 10px #ccc&quot;&gt;</span><br><span class="line">          &lt;div style=&quot;text-align: center; line-height: 50px;&quot;&gt;</span><br><span class="line">            Web聊天室（&#123;&#123; chatUser &#125;&#125;）</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div style=&quot;height: 350px; overflow:auto; border-top: 1px solid #ccc&quot; v-html=&quot;content&quot;&gt;&lt;/div&gt;</span><br><span class="line">          &lt;div style=&quot;height: 200px&quot;&gt;</span><br><span class="line">            &lt;textarea v-model=&quot;text&quot; style=&quot;height: 160px; width: 760px; padding: 20px; border: none; border-top: 1px solid #ccc;</span><br><span class="line">             border-bottom: 1px solid #ccc; outline: none&quot;</span><br><span class="line">             @keyup.enter=&quot;send&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">            &lt;div style=&quot;text-align: right; padding-right: 10px; position:relative; top:-40px; &quot;&gt;</span><br><span class="line">              &lt;el-button type=&quot;primary&quot; size=&quot;mini&quot; @click=&quot;send&quot;&gt;发送&lt;/el-button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let socket;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Im&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      circleUrl: &#x27;https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png&#x27;,</span><br><span class="line">      user: &#123;&#125;,</span><br><span class="line">      isCollapse: false,</span><br><span class="line">      users: [],</span><br><span class="line">      chatUser: &#x27;&#x27;,</span><br><span class="line">      text: &quot;&quot;,</span><br><span class="line">      messages: [],</span><br><span class="line">      content: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    this.init()</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    send() &#123;</span><br><span class="line">      if (!this.chatUser) &#123;</span><br><span class="line">        this.$message(&#123;type: &#x27;warning&#x27;, message: &quot;请选择聊天对象&quot;&#125;)</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!this.text) &#123;</span><br><span class="line">        this.$message(&#123;type: &#x27;warning&#x27;, message: &quot;请输入内容&quot;&#125;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        if (typeof (WebSocket) == &quot;undefined&quot;) &#123;</span><br><span class="line">          console.log(&quot;您的浏览器不支持WebSocket&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          console.log(&quot;您的浏览器支持WebSocket&quot;);</span><br><span class="line">          // 组装待发送的消息 json</span><br><span class="line">          // &#123;&quot;from&quot;: &quot;zhang&quot;, &quot;to&quot;: &quot;admin&quot;, &quot;text&quot;: &quot;聊天文本&quot;&#125;</span><br><span class="line">          </span><br><span class="line">          let message = &#123;from: this.user.username, to: this.chatUser, text: this.text&#125;</span><br><span class="line">          socket.send(JSON.stringify(message));  // 将组装好的json发送给服务端，由服务端进行转发</span><br><span class="line">          this.messages.push(&#123;user: this.user.username, text: this.text&#125;)</span><br><span class="line">          // 构建消息内容，本人消息</span><br><span class="line">          let msg=this.text</span><br><span class="line">          this.createContent(null, window.sessionStorage.getItem(&quot;user&quot;), msg)</span><br><span class="line">          this.text = &#x27;&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    createContent(remoteUser, nowUser, text) &#123;  // 这个方法是用来将 json的聊天消息数据转换成 html的。</span><br><span class="line">      let html;</span><br><span class="line">      // 当前用户消息</span><br><span class="line">      if (nowUser) &#123; // nowUser 表示是否显示当前用户发送的聊天消息，绿色气泡</span><br><span class="line">        html = &quot;&lt;div class=\&quot;el-row\&quot; style=\&quot;padding: 5px 0\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;div class=\&quot;el-col el-col-22\&quot; style=\&quot;text-align: right; padding-right: 10px\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;    &lt;div class=\&quot;tip left\&quot;&gt;&quot; + text + &quot;&lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;div class=\&quot;el-col el-col-2\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;span class=\&quot;el-avatar el-avatar--circle\&quot; style=\&quot;height: 40px; width: 40px; line-height: 40px;\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;    &lt;img src=\&quot;https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png\&quot; style=\&quot;object-fit: cover;width:40px; height:40px\&quot; &gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;/span&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;&lt;/div&gt;&quot;;</span><br><span class="line">      &#125; else if (remoteUser) &#123;   // remoteUser表示远程用户聊天消息，蓝色的气泡</span><br><span class="line">        html = &quot;&lt;div class=\&quot;el-row\&quot; style=\&quot;padding: 5px 0\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;div class=\&quot;el-col el-col-2\&quot; style=\&quot;text-align: right\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;span class=\&quot;el-avatar el-avatar--circle\&quot; style=\&quot;height: 40px; width: 40px; line-height: 40px;\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;    &lt;img src=\&quot;https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png\&quot; style=\&quot;object-fit: cover;width:40px; height:40px\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;/span&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;div class=\&quot;el-col el-col-22\&quot; style=\&quot;text-align: left; padding-left: 10px\&quot;&gt;\n&quot; +</span><br><span class="line">            &quot;    &lt;div class=\&quot;tip right\&quot;&gt;&quot; + text + &quot;&lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;  &lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;&lt;/div&gt;&quot;;</span><br><span class="line">      &#125;</span><br><span class="line">      this.content += html;</span><br><span class="line">    &#125;,</span><br><span class="line">    init() &#123;</span><br><span class="line">      let username = sessionStorage.getItem(&quot;user&quot;);</span><br><span class="line">      console.info(username);</span><br><span class="line">      let _this = this;</span><br><span class="line">      if (typeof (WebSocket) == &quot;undefined&quot;) &#123;</span><br><span class="line">        console.log(&quot;您的浏览器不支持WebSocket&quot;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        console.log(&quot;您的浏览器支持WebSocket&quot;);</span><br><span class="line">        let socketUrl = &quot;ws://10.50.12.8:8082/imserver/&quot; + username;</span><br><span class="line">        if (socket != null) &#123;</span><br><span class="line">          socket.close();</span><br><span class="line">          socket = null;</span><br><span class="line">        &#125;</span><br><span class="line">        // 开启一个websocket服务</span><br><span class="line">        socket = new WebSocket(socketUrl);</span><br><span class="line">        </span><br><span class="line">        //打开事件</span><br><span class="line">        socket.onopen = function () &#123;</span><br><span class="line">          console.log(&quot;websocket已打开&quot;);</span><br><span class="line">        &#125;;</span><br><span class="line">        //  浏览器端收消息，获得从服务端发送过来的文本消息</span><br><span class="line">        socket.onmessage = function (msg) &#123;</span><br><span class="line">          console.log(&quot;收到数据====&quot; + msg.data)</span><br><span class="line">          let data = JSON.parse(msg.data)  // 对收到的json数据进行解析， 类似这样的： &#123;&quot;users&quot;: [&#123;&quot;username&quot;: &quot;zhang&quot;&#125;,&#123; &quot;username&quot;: &quot;admin&quot;&#125;]&#125;</span><br><span class="line">          if (data.users) &#123;  // 获取在线人员信息</span><br><span class="line">            _this.users = data.users.filter(user =&gt; user.username !== username)  // 获取当前连接的所有用户信息，并且排除自身，自己不会出现在自己的聊天列表里</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            // 如果服务器端发送过来的json数据 不包含 users 这个key，那么发送过来的就是聊天文本json数据</span><br><span class="line">            //  // &#123;&quot;from&quot;: &quot;zhang&quot;, &quot;text&quot;: &quot;hello&quot;&#125;</span><br><span class="line">            if (data.from === _this.chatUser) &#123;</span><br><span class="line">              _this.messages.push(data)</span><br><span class="line">              // 构建消息内容</span><br><span class="line">              _this.createContent(data.from, null, data.text)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //关闭事件</span><br><span class="line">        socket.onclose = function () &#123;</span><br><span class="line">          console.log(&quot;websocket已关闭&quot;);</span><br><span class="line">        &#125;;</span><br><span class="line">        //发生了错误事件</span><br><span class="line">        socket.onerror = function () &#123;</span><br><span class="line">          console.log(&quot;websocket发生了错误&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.tip &#123;</span><br><span class="line">  color: white;</span><br><span class="line">  text-align: center;</span><br><span class="line">  border-radius: 10px;</span><br><span class="line">  font-family: sans-serif;</span><br><span class="line">  padding: 10px;</span><br><span class="line">  width:auto;</span><br><span class="line">  display:inline-block !important;</span><br><span class="line">  display:inline;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.right &#123;</span><br><span class="line">  background-color: deepskyblue;</span><br><span class="line">&#125;</span><br><span class="line">.left &#123;</span><br><span class="line">  background-color: forestgreen;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Socket</category>
      </categories>
      <tags>
        <tag>Socket</tag>
      </tags>
  </entry>
  <entry>
    <title>springcloud-alibaba</title>
    <url>/2021/11/30/spring-cloud-alibaba/</url>
    <content><![CDATA[<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211022105939305.png" alt="image-20211022105939305"></p>
<p><a href="https://blog.csdn.net/zhongzk69/article/details/105095834/">https://blog.csdn.net/zhongzk69/article/details/105095834/</a></p>
<h1 id="springcloud-alibaba"><a href="#springcloud-alibaba" class="headerlink" title="springcloud-alibaba"></a>springcloud-alibaba</h1><p>在公共依赖common里引入依赖</p>
<p>注意版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">            &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>



<p>中文文档</p>
<p><a href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p><a href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025191043897.png" alt="image-20211025191043897"></p>
<h1 id="1-nacos注册中心"><a href="#1-nacos注册中心" class="headerlink" title="1.nacos注册中心"></a>1.nacos注册中心</h1><h2 id="1-pom"><a href="#1-pom" class="headerlink" title="1.pom"></a>1.pom</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h2><p>在应用的 /src/main/resources/application.properties 配置文件中配置 Nacos Server 地址，以及spring名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025195219412.png" alt="image-20211025195219412"></p>
<h2 id="3-下载nacos-server"><a href="#3-下载nacos-server" class="headerlink" title="3.下载nacos server"></a>3.下载nacos server</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025193113285.png" alt="image-20211025193113285"></p>
<h3 id="windos下zip"><a href="#windos下zip" class="headerlink" title="windos下zip"></a>windos下zip</h3><p>下载解压，bin双击startup.cmd</p>
<p>如果报错</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025195934257.png" alt="image-20211025195934257"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025195550728.png" alt="image-20211025195550728"></p>
<h3 id="Linux下tar-gz"><a href="#Linux下tar-gz" class="headerlink" title="Linux下tar.gz"></a>Linux下tar.gz</h3><h2 id="4-使用-EnableDiscoveryClient"><a href="#4-使用-EnableDiscoveryClient" class="headerlink" title="4.使用 @EnableDiscoveryClient"></a>4.使用 @EnableDiscoveryClient</h2><p>注解开启服务注册与发现功能</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class ProviderApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ProviderApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-访问http-localhost-8848-nacos"><a href="#5-访问http-localhost-8848-nacos" class="headerlink" title="5.访问http://localhost:8848/nacos"></a>5.访问<a href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></h2><p>账号密码</p>
<p>nacos/nacos</p>
<h1 id="2-openFegin远程调用"><a href="#2-openFegin远程调用" class="headerlink" title="2.openFegin远程调用"></a>2.openFegin远程调用</h1><h2 id="1-pom-1"><a href="#1-pom-1" class="headerlink" title="1.pom"></a>1.pom</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-远程调用步骤"><a href="#2-远程调用步骤" class="headerlink" title="2.远程调用步骤"></a>2.远程调用步骤</h2><p>编写一个接口，告诉springcloud这个接口需要调用远程服务，把这种接口都放在fegin包下</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201021518.png" alt="image-20211025201021518"></p>
<p>member想要远程调用coupon服务</p>
<p>coupon在controller里有这样一个方法</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201053269.png" alt="image-20211025201053269"></p>
<p>而member想要调用，首先在fegin包下创建service</p>
<p>加上@FeignClient()注解</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201515603.png" alt="image-20211025201515603"></p>
<p>方法mapping要是coupon在controller里全路径，返回值和方法名不变，</p>
<p>注释是interface</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201411302.png" alt="image-20211025201411302"></p>
<h2 id="3-开启远程调用功能"><a href="#3-开启远程调用功能" class="headerlink" title="3.开启远程调用功能"></a>3.开启远程调用功能</h2><p>在member</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025201816108.png" alt="image-20211025201621844"></p>
<h2 id="4-错误"><a href="#4-错误" class="headerlink" title="4.错误"></a>4.错误</h2><h3 id="No-Feign-Client-for-loadBalancing-defined-错误"><a href="#No-Feign-Client-for-loadBalancing-defined-错误" class="headerlink" title="No Feign Client for loadBalancing defined.错误"></a>No Feign Client for loadBalancing defined.错误</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">解决方法：</span><br><span class="line">加入spring-cloud-loadbalancer依赖 并且在nacos中排除ribbon依赖，不然loadbalancer无效</span><br><span class="line"></span><br><span class="line">排除ribbon依赖</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;com.netflix.ribbon&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;ribbon&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">添加依赖</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-loadbalancer&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为版本，可以</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">项目springboot 2.1.8.RELEASE</span><br><span class="line"></span><br><span class="line">springcloud  2.1.0.RELEASE</span><br></pre></td></tr></table></figure>

<h1 id="3-nacos配置中心"><a href="#3-nacos配置中心" class="headerlink" title="3.nacos配置中心"></a>3.nacos配置中心</h1><h2 id="1-pom-2"><a href="#1-pom-2" class="headerlink" title="1.pom"></a>1.pom</h2><p>首先，修改 pom.xml 文件，引入 Nacos Config Starter。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-bootstrap-yml"><a href="#2-bootstrap-yml" class="headerlink" title="2.bootstrap.yml"></a>2.bootstrap.yml</h2><p>优先于application.yml加载</p>
<p>在应用的 /src/main/resources/bootstrap.properties 配置文件中配置 Nacos Config 元数据</p>
<p><strong>需要配置spring.application.name=服务名，所以当有cloud的config配置时， spring.application.name配置在bootstrap中</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring.application.name=服务名</span><br><span class="line">spring.cloud.nacos.config.server-addr=127.0.0.1:8848</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211025205034397.png" alt="image-20211025205034397"></p>
<p>现在自定义了两个属性</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084030493.png" alt="image-20211026084030493"></p>
<p>controller里获取</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084153941.png" alt="image-20211026084153941"></p>
<p>如果想更改值，只能修改yml，然后重新打包部署</p>
<h3 id="but有了nacos！"><a href="#but有了nacos！" class="headerlink" title="but有了nacos！"></a>but有了nacos！</h3><p>可以修改配置中心动态修改，添加dataid，默认为应用名.properties</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084437847.png" alt="image-20211026084437847"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026084535844.png" alt="image-20211026084535844"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026085753939.png" alt="image-20211026085753939"></p>
<p>在属性的类上添加注解@RefreshScope</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090142252.png" alt="image-20211026090142252"></p>
<p>原来是zhangsan18</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026085900976.png" alt="image-20211026085900976"></p>
<p>现在修改一下</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026085933419.png" alt="image-20211026085933419"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090001730.png" alt="image-20211026090001730"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090322799.png" alt="image-20211026090322799"></p>
<h3 id="修改properties为yml"><a href="#修改properties为yml" class="headerlink" title="修改properties为yml"></a>修改properties为yml</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config:</span><br><span class="line">        file-extension: yml  #指定配置文件为服务名.yml格式</span><br></pre></td></tr></table></figure>

<h2 id="3-细节都在bootstrap-yml里配置"><a href="#3-细节都在bootstrap-yml里配置" class="headerlink" title="3.细节都在bootstrap.yml里配置"></a>3.细节都在bootstrap.yml里配置</h2><h3 id="1-命名空间"><a href="#1-命名空间" class="headerlink" title="1.命名空间"></a>1.命名空间</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认空间public，默认新增的所有配置都在public空间</span><br><span class="line">开发，测试，生产，不同环境需要不同配置，就可以创建多个空间</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026090946436.png" alt="image-20211026090946436"></p>
<p>现在在public和prop里都创建dataid为gulimall.properties</p>
<p>name：zhangsan</p>
<p>public   age：22    prop  age：24</p>
<p>发现最终获取为22，说明默认使用public空间</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091233561.png" alt="image-20211026091233561"></p>
<p>想要使用其他命名空间</p>
<p>spring.cloud.nacos.config.namespace</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091518002.png" alt="image-20211026091518002"></p>
<p>值为prop下的类似uuid的字符串</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091559011.png" alt="image-20211026091559011"></p>
<p>每一个微服务之前互相隔离，都创建自己的命名空间，只加载自己的命名空间</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026091943440.png" alt="image-20211026091943440"></p>
<p>可以克隆配置到别的命名空间</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026092052521.png" alt="image-20211026092052521"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026092113919.png" alt="image-20211026092113919"></p>
<h3 id="2-配置集"><a href="#2-配置集" class="headerlink" title="2.配置集"></a>2.配置集</h3><p>所有的配置集合</p>
<h3 id="3-配置集id"><a href="#3-配置集id" class="headerlink" title="3.配置集id"></a>3.配置集id</h3><p>Data ID：默认服务名.properties</p>
<h3 id="4-配置分组"><a href="#4-配置分组" class="headerlink" title="4.配置分组"></a>4.配置分组</h3><p>默认所有配置集都属于DEFULT_GROUP：</p>
<p>使用别的组</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026092640401.png" alt="image-20211026092640401"></p>
<p>每个微服务创建自己的命名空间，使用配置分组区别环境，dev，test，prod</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026093234345.png" alt="image-20211026093234345"></p>
<p>想切换环境，更改bootstrap.yml里的group属性即可</p>
<h2 id="4-同时加载多个配置集"><a href="#4-同时加载多个配置集" class="headerlink" title="4.同时加载多个配置集"></a>4.同时加载多个配置集</h2><p>现在application.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">ROOT</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.10:3306/gulimall_sms?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gulimall-coupon</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br></pre></td></tr></table></figure>

<p>拆分成三个</p>
<p>datasource.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">ROOT</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.10:3306/gulimall_sms?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br></pre></td></tr></table></figure>

<p>mybatis.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>

<p>other.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gulimall-coupon</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br></pre></td></tr></table></figure>

<p>bootstrap不变</p>
<p>再次注意</p>
<p>application里的是服务注册与发现</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 127.0.0.1:8848</span><br></pre></td></tr></table></figure>

<p>bootstrap里的是配置中心</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config:</span><br><span class="line">        server-addr: 127.0.0.1:8848</span><br><span class="line">        namespace: 5c2579c3-b6ad-406c-81b7-dbef6ee5142c</span><br><span class="line">        group:</span><br><span class="line">  application:</span><br><span class="line">    name: gulimall-coupon</span><br></pre></td></tr></table></figure>

<p>回归</p>
<p>现在拆分了三个到配置中心</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026094345791.png" alt="image-20211026094345791"></p>
<p>修改bootstrap.yml</p>
<p>添加数据集，refresh自动刷新true</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026094619239.png" alt="image-20211026094619239"></p>
<h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><p>以前springboot从配置文件获取使用</p>
<p>@value @configurationproperties</p>
<p>现在都可以配置到配置中心，在bootstrap中指定id，group即可</p>
<h1 id="4-gateway网关"><a href="#4-gateway网关" class="headerlink" title="4.gateway网关"></a>4.gateway网关</h1><p><a href="https://spring.io/projects/spring-cloud-gateway">https://spring.io/projects/spring-cloud-gateway</a></p>
<p>请求到网关，网关先断言，是否符合某个路由规则，经过一系列的filter进行过滤，最终到达目标服务器，并且<strong>最终到达的地址一定是要可以访问的</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-开启服务注册发现并排除数据源自动配置"><a href="#1-开启服务注册发现并排除数据源自动配置" class="headerlink" title="1.开启服务注册发现并排除数据源自动配置"></a>1.开启服务注册发现并排除数据源自动配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.gulimall.gateway;</span><br><span class="line"></span><br><span class="line">        import org.springframework.boot.SpringApplication;</span><br><span class="line">        import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">        import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line">        import org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span><br><span class="line">public class GulimallGatewayApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GulimallGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-添加配置"><a href="#2-添加配置" class="headerlink" title="2.添加配置"></a>2.添加配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: 127.0.0.1:8848</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true  # 让gateway可以发现nacos中的微服务</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: baidu_rout</span><br><span class="line">          uri: https://www.baidu.com</span><br><span class="line">          predicates:</span><br><span class="line">            - Query=url,baidu</span><br><span class="line">        - id: qq_route</span><br><span class="line">          uri: https://www.qq.com</span><br><span class="line">          predicates:</span><br><span class="line">            - Query=url,qq</span><br><span class="line">            #也可以写成path，只要以/brand开头都会跳转到这里</span><br><span class="line">            - Path=/brand**</span><br><span class="line">          filters:</span><br><span class="line">  			 - StripPrefix=2 </span><br><span class="line">server:</span><br><span class="line">  port: 88</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>断言</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Query=url  表示请求中待url参数即可，才会转到url</span><br><span class="line">Query=url,qq   请求中待url参数并必须等于qq才会转到url</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">配置转发路径：Path= /anji-open/user/**，但是controller中并没有以/anji-open/user/**开头，这样能找到具体接口吗，是可以的，原理是通过这个配置实现：</span><br><span class="line">filters:</span><br><span class="line">   - StripPrefix=2，</span><br><span class="line">转发到具体服务，自动去掉/anji-open/user，如下</span><br><span class="line">原始访问路径:</span><br><span class="line">http://www.aa.com/anji-open/user/jobuser/pageList?sort=id&amp;order=DESC&amp;pageNumber=1&amp;pageSize=10</span><br><span class="line"> </span><br><span class="line">处理后路径：</span><br><span class="line">http://www.aa.com/jobuser/pageList?sort=id&amp;order=DESC&amp;pageNumber=1&amp;pageSize=10</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>#webconfig<br>        - id: FRAMEWORK-WEBCONFIG-SERVER<br>          uri: lb://FRAMEWORK-WEBCONFIG-SERVER<br>          predicates:<br>            - Path=/api/webconfig/**<br>          filters:<br>            - StripPrefix=2</p>
<pre><code>    #flow
    - id: FRAMEWORK-FLOW-MICROSERVICE
      uri: lb://FRAMEWORK-FLOW-MICROSERVICE
      predicates:
        - Path=/api/flow/**
      filters: 
        - StripPrefix=2

    #component
    - id: FRAMEWORK-COMPONENT-MICROSERVICE
      uri: lb://FRAMEWORK-COMPONENT-MICROSERVICE
      predicates:
        - Path=/api/component/**
      filters: 
        - StripPrefix=2

    #test
    - id: SERVER-CONSUMER
      uri: lb://SERVER-CONSUMER
      predicates:
        - Path=/cusumer/**
      filters: 
        - StripPrefix=1

如果请求路径是/cusumer开头，就会找uri里SERVER-CONSUMER服务路径，并且- StripPrefix=1，去掉一层，也就是去掉/cusumer这一层
比如，SERVER-CONSUMER的路径是1.1.1.1:3001,当请求/cusumer/a/b,路径不是1.1.1.1:3001/cusumer/a/b
而是1.1.1.1:3001/a/b
</code></pre>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>访问<a href="http://localhost:88/hello?url=qq">http://localhost:88/hello?url=qq</a></p>
<p>参数中待url并且等于qq，就会转到<a href="https://www.qq.com/hello%EF%BC%8C%E6%B3%A8%E6%84%8F%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%8B%BC%E6%8E%A5%E4%B8%8Alocalhost:88/%E5%90%8E%E9%9D%A2%E7%9A%84%E8%B7%AF%E5%BE%84">https://www.qq.com/hello，注意会自动拼接上localhost:88/后面的路径</a></p>
<p>访问<a href="http://localhost:88/?url=baidu">http://localhost:88/?url=baidu</a></p>
<p>就不会待hello路径</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026111146862.png" alt="image-20211026111146862"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026203254610.png" alt="image-20211026203254610"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- Path=/foo/&#123;segment&#125;,/bar/&#123;segment&#125;</span><br><span class="line">路径是/foo/1 or /foo/bar/ or /bar/22都会转到uri中</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026203427498.png" alt="image-20211026203427498"></p>
<p>lb负载均衡策略</p>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: qq1_route</span><br><span class="line">  uri: https://www.baidu.com</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/more</span><br></pre></td></tr></table></figure>

<p>访问localhost:88/more会转到<a href="http://www.baidu.com/more">www.baidu.com/more</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: qq2_route</span><br><span class="line">  uri: https://blog.csdn.net</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/jiang458572759/&#123;segment&#125;</span><br></pre></td></tr></table></figure>

<p>访问localhost:88/jiang458572759/article</p>
<p>转到<a href="https://blog.csdn.net/jiang458572759/article">https://blog.csdn.net/jiang458572759/article</a></p>
<p>注意只能在jiang458572759/后添加一个/，不能有多级目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: qq2_route</span><br><span class="line">  uri: https://blog.csdn.net</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/jiang458572759/**</span><br></pre></td></tr></table></figure>

<p>这样就可以有多级目录了</p>
<p>例子：访问<a href="http://localhost:88/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502">http://localhost:88/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502</a></p>
<p>转到<a href="https://blog.csdn.net/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502">https://blog.csdn.net/jiang458572759/article/details/115283615?spm=1001.2014.3001.5502</a></p>
<h2 id="3-前端项目发送axios"><a href="#3-前端项目发送axios" class="headerlink" title="3.前端项目发送axios"></a>3.前端项目发送axios</h2><p>向网关发送的都带上api</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026204659897.png" alt="image-20211026204659897"></p>
<p>后端，lb负载均衡到renren-fast</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211026204730089.png" alt="image-20211026204730089"></p>
<h2 id="4-路径重写"><a href="#4-路径重写" class="headerlink" title="4.路径重写"></a>4.路径重写</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id: qq2_route</span><br><span class="line"> uri: https://blog.csdn.net</span><br><span class="line"> predicates:</span><br><span class="line">   - Path=/jiang458572759/**</span><br><span class="line"> filters:</span><br><span class="line">   - RewritePath=/jiang458572759/(?&lt;segment&gt;.*),/$\&#123;segment&#125;</span><br></pre></td></tr></table></figure>

<p>当访问<a href="http://localhost:88/jiang458572759/hh%E6%97%B6">http://localhost:88/jiang458572759/hh时</a></p>
<p>会转到<a href="https://blog.csdn.net/hh,%E8%87%AA%E5%8A%A8%E5%8E%BB%E6%8E%89/jiang458572759">https://blog.csdn.net/hh,自动去掉/jiang458572759</a></p>
<h2 id="5-在网关里统一配置跨域问题"><a href="#5-在网关里统一配置跨域问题" class="headerlink" title="5.在网关里统一配置跨域问题"></a>5.在网关里统一配置跨域问题</h2><p>创建config文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class GulimallCorsConfiguration &#123;</span><br><span class="line">	@Bean</span><br><span class="line">    public CorsWebFilter corsWebFilter()&#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        CorsConfiguration config=new CorsConfiguration();</span><br><span class="line">        //配置跨域</span><br><span class="line">        //允许所有域名进行跨域调用</span><br><span class="line">        config.addAllowedOrigin(&quot;*&quot;);</span><br><span class="line">        //允许跨越发送cookie</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        //放行全部原始头信息</span><br><span class="line">        config.addAllowedHeader(&quot;*&quot;);</span><br><span class="line">        //允许所有请求方法跨域调用</span><br><span class="line">        config.addAllowedMethod(&quot;*&quot;);</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;,config);</span><br><span class="line">        return new CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-精确的网关应该放在模糊的网关上面"><a href="#6-精确的网关应该放在模糊的网关上面" class="headerlink" title="6.精确的网关应该放在模糊的网关上面"></a>6.精确的网关应该放在模糊的网关上面</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- id: admin_route</span><br><span class="line">  uri: lb://gulimall-product</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/api/product/**</span><br><span class="line">  filters:</span><br><span class="line">    - RewritePath=/api/(?&lt;segment&gt;.*),/$\&#123;segment&#125;</span><br><span class="line"></span><br><span class="line">- id: admin_route</span><br><span class="line">  uri: lb://renren-fast</span><br><span class="line">  predicates:</span><br><span class="line">    - Path=/api/**</span><br><span class="line">  filters:</span><br><span class="line">    - RewritePath=/api/(?&lt;segment&gt;.*),/renren-fast/$\&#123;segment&#125;</span><br></pre></td></tr></table></figure>





<h1 id="5-springcloud-alibaba-oss"><a href="#5-springcloud-alibaba-oss" class="headerlink" title="5.springcloud-alibaba-oss"></a>5.springcloud-alibaba-oss</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alicloud-oss&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">    alicloud:</span><br><span class="line">      access-key: LTAI5t6Tc8civonnHH6QpHQh</span><br><span class="line">      secret-key: 3iIUKRaiwYyx51p0BfmvBCBMpJDb1y</span><br><span class="line">      oss:</span><br><span class="line">        endpoint: oss-cn-beijing.aliyuncs.com</span><br></pre></td></tr></table></figure>

<h2 id="测试简单上传"><a href="#测试简单上传" class="headerlink" title="测试简单上传"></a>测试简单上传</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class GulimallThirdPartyApplicationTests &#123;</span><br><span class="line">    public GulimallThirdPartyApplicationTests()&#123;&#125;</span><br><span class="line">    @Autowired</span><br><span class="line">    OSSClient ossClient;</span><br><span class="line">    @Test</span><br><span class="line">    public void contextLoads() throws FileNotFoundException &#123;</span><br><span class="line">        InputStream inputStream = new FileInputStream(&quot;D:/a.jpg&quot;);</span><br><span class="line">        SimpleDateFormat sdf=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">        String date = sdf.format(new Date());</span><br><span class="line">        // 依次填写Bucket名称（例如examplebucket）和Object完整路径（例如exampledir/exampleobject.txt）。Object完整路径中不能包含Bucket名称。</span><br><span class="line">        ossClient.putObject(&quot;jiang-oss&quot;, date+&quot;/a.jpg&quot;, inputStream);</span><br><span class="line"></span><br><span class="line">        // 关闭OSSClient。</span><br><span class="line">        ossClient.shutdown();</span><br><span class="line">        System.out.println(&quot;上传成功&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="整合controller"><a href="#整合controller" class="headerlink" title="整合controller"></a>整合controller</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    alicloud:</span><br><span class="line">      access-key: LTAI5t6Tc8civonnHH6QpHQh</span><br><span class="line">      secret-key: 3iIUKRaiwYyx51p0BfmvBCBMpJDb1y</span><br><span class="line">      oss:</span><br><span class="line">        endpoint: oss-cn-beijing.aliyuncs.com</span><br><span class="line">        bucket: jiang-oss</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.gulimall.thirdparty.controller;</span><br><span class="line"></span><br><span class="line">import com.aliyun.oss.OSS;</span><br><span class="line">import com.aliyun.oss.OSSClient;</span><br><span class="line">import com.aliyun.oss.OSSClientBuilder;</span><br><span class="line">import com.aliyun.oss.common.utils.BinaryUtil;</span><br><span class="line">import com.aliyun.oss.model.MatchMode;</span><br><span class="line">import com.aliyun.oss.model.PolicyConditions;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.LinkedHashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/10/28  20:09</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class OssController &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.cloud.alicloud.oss.endpoint&#125;&quot;)</span><br><span class="line">    private String endpoint;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.cloud.alicloud.oss.bucket&#125;&quot;)</span><br><span class="line">    private String bucket;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.cloud.alicloud.access-key&#125;&quot;)</span><br><span class="line">    private String accessId;</span><br><span class="line"></span><br><span class="line">    //@Autowired</span><br><span class="line">    //OSSClient ossClient;</span><br><span class="line">    @Autowired</span><br><span class="line">    OSS ossClient;</span><br><span class="line">    @RequestMapping(&quot;/oss/policy&quot;)</span><br><span class="line">    public Map&lt;String, String&gt; policy()&#123;</span><br><span class="line">        String host = &quot;https://&quot; + bucket + &quot;.&quot; + endpoint; // host的格式为 bucketname.endpoint</span><br><span class="line">        SimpleDateFormat sdf=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">        String date = sdf.format(new Date());</span><br><span class="line">        //上传服务器回调的URL</span><br><span class="line">        //String callbackUrl=&quot;http://&quot;;</span><br><span class="line">        String dir = date+&quot;/&quot;; // 用户上传文件时指定的前缀。</span><br><span class="line">        Map&lt;String, String&gt; respMap =null;</span><br><span class="line">        // 创建OSSClient实例。</span><br><span class="line">        try &#123;</span><br><span class="line">            long expireTime = 30;</span><br><span class="line">            long expireEndTime = System.currentTimeMillis() + expireTime * 1000;</span><br><span class="line">            Date expiration = new Date(expireEndTime);</span><br><span class="line">            // PostObject请求最大可支持的文件大小为5 GB，即CONTENT_LENGTH_RANGE为5*1024*1024*1024。</span><br><span class="line">            PolicyConditions policyConds = new PolicyConditions();</span><br><span class="line">            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 1048576000);</span><br><span class="line">            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);</span><br><span class="line"></span><br><span class="line">            String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);</span><br><span class="line">            byte[] binaryData = postPolicy.getBytes(&quot;utf-8&quot;);</span><br><span class="line">            String encodedPolicy = BinaryUtil.toBase64String(binaryData);</span><br><span class="line">            String postSignature = ossClient.calculatePostSignature(postPolicy);</span><br><span class="line"></span><br><span class="line">             respMap = new LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">            respMap.put(&quot;accessid&quot;, accessId);</span><br><span class="line">            respMap.put(&quot;policy&quot;, encodedPolicy);</span><br><span class="line">            respMap.put(&quot;signature&quot;, postSignature);</span><br><span class="line">            respMap.put(&quot;dir&quot;, dir);</span><br><span class="line">            respMap.put(&quot;host&quot;, host);</span><br><span class="line">            respMap.put(&quot;expire&quot;, String.valueOf(expireEndTime / 1000));</span><br><span class="line">            // respMap.put(&quot;expire&quot;, formatISO8601Date(expiration));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // Assert.fail(e.getMessage());</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            ossClient.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        return respMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211028202853057.png" alt="image-20211028202853057"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211028203706082.png" alt="image-20211028203706082"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>springcloud-alibaba</tag>
      </tags>
  </entry>
  <entry>
    <title>xml</title>
    <url>/2021/11/30/xml/</url>
    <content><![CDATA[<h1 id="xml格式"><a href="#xml格式" class="headerlink" title="xml格式"></a>xml格式</h1><p>必须是三层，第三层是对象的属性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;items&gt;</span><br><span class="line">    &lt;item&gt;</span><br><span class="line">        &lt;id&gt;1&lt;/id&gt;</span><br><span class="line">        &lt;username&gt;a&lt;/username&gt;</span><br><span class="line">        &lt;password&gt;b&lt;/password&gt;</span><br><span class="line">    &lt;/item&gt;</span><br><span class="line">    &lt;item&gt;</span><br><span class="line">        &lt;id&gt;2&lt;/id&gt;</span><br><span class="line">        &lt;username&gt;a2&lt;/username&gt;</span><br><span class="line">        &lt;password&gt;b2&lt;/password&gt;</span><br><span class="line">    &lt;/item&gt;</span><br><span class="line">&lt;/items&gt;</span><br></pre></td></tr></table></figure>

<p>也可以对象里包含对象，相当于一个对象里的list<T></T></p>
<p><img src="/../img/image-20220324154729334.png" alt="image-20220324154729334"></p>
<p><img src="/../img/image-20220324154748172.png" alt="image-20220324154748172"></p>
<h1 id="xml简单获取每个节点属性（不推荐）"><a href="#xml简单获取每个节点属性（不推荐）" class="headerlink" title="xml简单获取每个节点属性（不推荐）"></a>xml简单获取每个节点属性（不推荐）</h1><p>因为有直接转换成Bean的方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;dictList&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;dictName&gt;network_type&lt;/dictName&gt;</span><br><span class="line">        &lt;fieldGroup&gt;network_type&lt;/fieldGroup&gt;</span><br><span class="line">        &lt;valueGroup&gt;&lt;/valueGroup&gt;</span><br><span class="line">        &lt;describe&gt;所属网络&lt;/describe&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;dictName&gt;professional_type&lt;/dictName&gt;</span><br><span class="line">        &lt;fieldGroup&gt;professional_type&lt;/fieldGroup&gt;</span><br><span class="line">        &lt;valueGroup&gt;&lt;/valueGroup&gt;</span><br><span class="line">        &lt;describe&gt;专业&lt;/describe&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;dictName&gt;eqp_object_class1&lt;/dictName&gt;</span><br><span class="line">        &lt;fieldGroup&gt;eqp_object_class&lt;/fieldGroup&gt;</span><br><span class="line">        &lt;valueGroup&gt;1&lt;/valueGroup&gt;</span><br><span class="line">        &lt;describe&gt;公共资源&lt;/describe&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">&lt;dictList&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220304095016880.png" alt="image-20220304095016880"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据xml文件缓存字典值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">XmlToBeanOrJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取resource下的文件</span></span><br><span class="line">    String xml = ResourceUtil.readUtf8Str(FILE_NAME);</span><br><span class="line">    JSONObject jsonObject = JSON.parseObject(JSON.toJSONString(XML.toJSONObject(xml)));</span><br><span class="line">    <span class="comment">//最顶层的dictList</span></span><br><span class="line">    JSONObject dictList = jsonObject.getJSONObject(<span class="string">&quot;dictList&quot;</span>);</span><br><span class="line">    <span class="comment">//里面的dict数组</span></span><br><span class="line">    JSONArray dict = dictList.getJSONArray(<span class="string">&quot;dict&quot;</span>);</span><br><span class="line">    <span class="comment">//遍历</span></span><br><span class="line">    <span class="keyword">for</span> (Object o : dict) &#123;</span><br><span class="line">        <span class="comment">//获取每一个节点内容</span></span><br><span class="line">        JSONObject dictObj = JSONObject.parseObject(o.toString());</span><br><span class="line">        String dictName = dictObj.getString(<span class="string">&quot;dictName&quot;</span>);</span><br><span class="line">        String fieldGroup = dictObj.getString(<span class="string">&quot;fieldGroup&quot;</span>);</span><br><span class="line">        String valueGroup = dictObj.getString(<span class="string">&quot;valueGroup&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="pom"><a href="#pom" class="headerlink" title="pom"></a>pom</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.dom4j/dom4j --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.dom4j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;dom4j&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="User类"><a href="#User类" class="headerlink" title="User类"></a>User类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class User &#123;</span><br><span class="line">   private String id;</span><br><span class="line">   private String username;</span><br><span class="line">   private String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="a-xml对应的user类"><a href="#a-xml对应的user类" class="headerlink" title="a.xml对应的user类"></a>a.xml对应的user类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;items&gt;</span><br><span class="line">    &lt;item&gt;</span><br><span class="line">        &lt;id&gt;1&lt;/id&gt;</span><br><span class="line">        &lt;username&gt;a&lt;/username&gt;</span><br><span class="line">        &lt;password&gt;b&lt;/password&gt;</span><br><span class="line">    &lt;/item&gt;</span><br><span class="line">    &lt;item&gt;</span><br><span class="line">        &lt;id&gt;2&lt;/id&gt;</span><br><span class="line">        &lt;username&gt;a2&lt;/username&gt;</span><br><span class="line">        &lt;password&gt;b2&lt;/password&gt;</span><br><span class="line">    &lt;/item&gt;</span><br><span class="line">&lt;/items&gt;</span><br></pre></td></tr></table></figure>

<h1 id="CacheFile缓存文件类"><a href="#CacheFile缓存文件类" class="headerlink" title="CacheFile缓存文件类"></a>CacheFile缓存文件类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">import io.swagger.annotations.ApiModelProperty;</span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">public class CacheFile &#123;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;文件名称&quot;)</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;是否需要重新读取&quot;)</span><br><span class="line">    private Boolean areReload = true;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;文件绝对路径名称&quot;)</span><br><span class="line">    private String absolutePath;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;修改时间&quot;)</span><br><span class="line">    private Long modifyTime;</span><br><span class="line"></span><br><span class="line">    @ApiModelProperty(&quot;文件类型&quot;)</span><br><span class="line">    private String content;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 创建</span><br><span class="line">     *</span><br><span class="line">     * @param file</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static CacheFile create(File file) &#123;</span><br><span class="line">        CacheFile cacheFile = new CacheFile();</span><br><span class="line">        cacheFile.setName(file.getName());</span><br><span class="line">        cacheFile.setAbsolutePath(file.getAbsolutePath());</span><br><span class="line">        cacheFile.setModifyTime(file.lastModified());</span><br><span class="line"></span><br><span class="line">        return cacheFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="BaseException自定义异常类"><a href="#BaseException自定义异常类" class="headerlink" title="BaseException自定义异常类"></a>BaseException自定义异常类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class BaseException extends RuntimeException &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 自定义异常</span><br><span class="line">     * @param message</span><br><span class="line">     */</span><br><span class="line">    public BaseException(String message) &#123;</span><br><span class="line">        super(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="ProjectConstant常量类"><a href="#ProjectConstant常量类" class="headerlink" title="ProjectConstant常量类"></a>ProjectConstant常量类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.websocket.constant;</span><br><span class="line"></span><br><span class="line">import java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:caohai</span><br><span class="line"> * @date:2021/6/98:40</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:常量</span><br><span class="line"> * @modify</span><br><span class="line"> */</span><br><span class="line">public class ProjectConstant &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * .jar-后缀</span><br><span class="line">     */</span><br><span class="line">    public static String JAR_SUFFIX = &quot;.jar&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * target-后缀</span><br><span class="line">     */</span><br><span class="line">    public static String TARGET_SUFFIX = &quot;/target&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 分割</span><br><span class="line">     */</span><br><span class="line">    public static String SPLIT_CHAR = &quot;/&quot;;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置文件路径</span><br><span class="line">     */</span><br><span class="line">    public static String CONFIG_FILE_PATH = &quot;config/&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 冒号</span><br><span class="line">     */</span><br><span class="line">    public static String COLON_CHAR = &quot;:&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 基本数据类型标识</span><br><span class="line">     */</span><br><span class="line">    public static String BASE_PREFIX_CHAR = &quot;java.lang.&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 下划线</span><br><span class="line">     */</span><br><span class="line">    public static Pattern LINE_PATTERN = Pattern.compile(&quot;_(\\w)&quot;);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 自定义配置文件名</span><br><span class="line">     */</span><br><span class="line">    public static String MY_FILE = &quot;a.xml&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要是自己定义一个，配置文件名</p>
<p><img src="/../img/image-20220324154016309.png" alt="image-20220324154016309"></p>
<h1 id="1-ConfigManager配置管理"><a href="#1-ConfigManager配置管理" class="headerlink" title="1.ConfigManager配置管理"></a>1.ConfigManager配置管理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.websocket.util;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import cn.hutool.core.util.StrUtil;</span><br><span class="line">import com.google.common.collect.Maps;</span><br><span class="line">import com.jiang.websocket.constant.ProjectConstant;</span><br><span class="line">import com.jiang.websocket.entity.bo.User;</span><br><span class="line">import com.jiang.websocket.entity.qo.UserRequest;</span><br><span class="line">import com.jiang.websocket.exception.BaseException;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class ConfigManager &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static ConfigManager configManger = null;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 缓存(value文件内容），一个key就是一个a.xml</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;String, String&gt; configCache = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * usersMap信息，key每个xml里具体的某一个属性比如id信息，value是整个user信息</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;String, User&gt; usersMap = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line"></span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        loadCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 实例化</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static synchronized ConfigManager getInstance() &#123;</span><br><span class="line">        if (null == configManger) &#123;</span><br><span class="line">            configManger = new ConfigManager();</span><br><span class="line">        &#125;</span><br><span class="line">        return configManger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 缓存加载信息</span><br><span class="line">     */</span><br><span class="line">    private void loadCache() &#123;</span><br><span class="line">    	//为true读取本地resources下文件，false读取数据库文件</span><br><span class="line">    	boolean flag=true;</span><br><span class="line">        List&lt;User&gt; users = null;</span><br><span class="line">        if (flag) &#123;</span><br><span class="line">            users = simpleToClass(ProjectConstant.MY_FILE, User.class);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //users = UserMapper.selectUser(null);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!users.isEmpty()) &#123;</span><br><span class="line">            for (User user : users) &#123;</span><br><span class="line">                usersMap.put(user.getId(), user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 清空缓存</span><br><span class="line">     */</span><br><span class="line">    public void clearCache()&#123;</span><br><span class="line">        usersMap.clear();</span><br><span class="line">        configCache.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 简单类型(w3c dom格式):解析节点内容</span><br><span class="line">     *</span><br><span class="line">     * @param fileName</span><br><span class="line">     */</span><br><span class="line">    public &lt;T&gt; List&lt;T&gt; simpleToClass(String fileName, Class&lt;T&gt; clazz) &#123;</span><br><span class="line">        String content = readFile(fileName);</span><br><span class="line">        return XmlManager.simpleToClass(content, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 读取文件</span><br><span class="line">     *</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String readFile(String fileName) &#123;</span><br><span class="line">        if (configCache.containsKey(fileName)) &#123;</span><br><span class="line">            String context = ReadFileManager.getInstance().getFileContext(fileName);</span><br><span class="line">            if (!configCache.get(fileName).equals(context)) &#123;</span><br><span class="line">                configCache.put(fileName, context);</span><br><span class="line">            &#125;</span><br><span class="line">            return context;</span><br><span class="line">        &#125;</span><br><span class="line">        String context = ReadFileManager.getInstance().getFileContext(fileName);</span><br><span class="line">        configCache.put(fileName, context);</span><br><span class="line">        return context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 核查请求参数(根据业务扩展)，自己定义</span><br><span class="line">     *</span><br><span class="line">     * @param request</span><br><span class="line">     */</span><br><span class="line">    public User checkRequest(UserRequest request) &#123;</span><br><span class="line">        if (null == request) &#123;</span><br><span class="line">            throw new BaseException(&quot;request null &quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StrUtil.isEmpty(request.getId())) &#123;</span><br><span class="line">            throw new BaseException(&quot;request view Item null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!usersMap.containsKey(request.getId())) &#123;</span><br><span class="line">            throw new BaseException(&quot;view Item no Found:&quot; + request.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        User User = usersMap.get(request.getId());</span><br><span class="line">        return User;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="2-ReadFileManager文件读取类"><a href="#2-ReadFileManager文件读取类" class="headerlink" title="2.ReadFileManager文件读取类"></a>2.ReadFileManager文件读取类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.websocket.util;</span><br><span class="line"></span><br><span class="line">import com.jiang.websocket.constant.ProjectConstant;</span><br><span class="line">import com.jiang.websocket.entity.bo.CacheFile;</span><br><span class="line">import com.jiang.websocket.exception.BaseException;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class ReadFileManager &#123;</span><br><span class="line"></span><br><span class="line">    private static ReadFileManager readFileManager = null;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * key:文件名称</span><br><span class="line">     */</span><br><span class="line">    private Map&lt;String, CacheFile&gt; cacheFiles = new ConcurrentHashMap&lt;&gt;(10);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 实例化</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public synchronized static ReadFileManager getInstance() &#123;</span><br><span class="line">        if (null == readFileManager) &#123;</span><br><span class="line">            readFileManager = new ReadFileManager();</span><br><span class="line">        &#125;</span><br><span class="line">        return readFileManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 读取文件内容</span><br><span class="line">     * 1、读取jar包中文件，缓存存在直接返回</span><br><span class="line">     * 2、读取jar包外静态文件，判断文件是否改变,未改变直接返回，改变返回修改后内容</span><br><span class="line">     *</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String getFileContext(String fileName) &#123;</span><br><span class="line">        if (cacheFiles.containsKey(fileName)) &#123;</span><br><span class="line">            CacheFile cacheFile = cacheFiles.get(fileName);</span><br><span class="line">            if (!cacheFile.getAreReload()) &#123;</span><br><span class="line">                return cacheFile.getContent();</span><br><span class="line">            &#125;</span><br><span class="line">            File file = new File(cacheFile.getAbsolutePath());</span><br><span class="line">            if (cacheFile.getModifyTime().equals(file.lastModified())) &#123;</span><br><span class="line">                return cacheFile.getContent();</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(fileName + &quot; is changed,need to read again.&quot;);</span><br><span class="line">            cacheFile.setModifyTime(file.lastModified());</span><br><span class="line">            cacheFile.setContent(readFile(file.getAbsolutePath()));</span><br><span class="line">            return cacheFile.getContent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return readFileContext(fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private String readFileContext(String fileName) &#123;</span><br><span class="line">        String path = this.getClass().getResource(&quot;/&quot;).getPath();</span><br><span class="line">        log.info(&quot;fileName:&quot; + fileName + &quot;,path:&quot; + path);</span><br><span class="line">        boolean areJar = path.contains(ProjectConstant.JAR_SUFFIX);</span><br><span class="line">        String resourcePath = areJar ? getDefaultPathToJar(path) : getDefaultPath(path);</span><br><span class="line">        resourcePath = resourcePath.concat(fileName);</span><br><span class="line">        CacheFile cacheFile;</span><br><span class="line">        File file = new File(resourcePath);</span><br><span class="line">        if (file.exists()) &#123;</span><br><span class="line">            cacheFile = CacheFile.create(file);</span><br><span class="line">            cacheFile.setContent(readFile(file.getAbsolutePath()));</span><br><span class="line">            cacheFiles.put(fileName, cacheFile);</span><br><span class="line">            return cacheFile.getContent();</span><br><span class="line">        &#125;</span><br><span class="line">        cacheFile = new CacheFile();</span><br><span class="line">        cacheFile.setName(fileName);</span><br><span class="line">        cacheFile.setAreReload(false);</span><br><span class="line">        if (areJar) &#123;</span><br><span class="line">            cacheFile.setContent(readFile(fileName, true));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //非jar重定义路径</span><br><span class="line">            String localPath = this.getClass().getClassLoader().getResource(fileName).getPath();</span><br><span class="line">            localPath = localPath.substring(localPath.indexOf(ProjectConstant.SPLIT_CHAR) + 1);</span><br><span class="line">            cacheFile.setContent(readFile(localPath));</span><br><span class="line">        &#125;</span><br><span class="line">        cacheFiles.put(fileName, cacheFile);</span><br><span class="line">        return cacheFile.getContent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 读取文件内容</span><br><span class="line">     *</span><br><span class="line">     * @param filePath</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private String readFile(String filePath) &#123;</span><br><span class="line">        return readFile(filePath, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 读取文件内容</span><br><span class="line">     *</span><br><span class="line">     * @param filePath</span><br><span class="line">     * @param areJar:是否jar内文件</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private String readFile(String filePath, boolean areJar) &#123;</span><br><span class="line">        log.info(&quot;filePath:&quot; + filePath);</span><br><span class="line">        try &#123;</span><br><span class="line">            InputStream input = areJar ? this.getClass().getResourceAsStream(ProjectConstant.SPLIT_CHAR.concat(filePath))</span><br><span class="line">                    : new FileInputStream(filePath);</span><br><span class="line">            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">            int bufferSize = 1024;</span><br><span class="line">            byte[] data = new byte[bufferSize];</span><br><span class="line">            int count = -1;</span><br><span class="line">            while((count = input.read(data,0,bufferSize)) != -1)&#123;</span><br><span class="line">                outputStream.write(data,0,count);</span><br><span class="line">                data = new byte[bufferSize];</span><br><span class="line">            &#125;</span><br><span class="line">            return new String(outputStream.toByteArray(),&quot;UTF-8&quot;);</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            throw new BaseException(&quot;read file &quot; + filePath + &quot;error:&quot; + ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取默认路径-非jar方式本地测试</span><br><span class="line">     *</span><br><span class="line">     * @param path</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private String getDefaultPath(String path) &#123;</span><br><span class="line">        path = path.substring(path.indexOf(ProjectConstant.SPLIT_CHAR) + 1, path.indexOf(ProjectConstant.TARGET_SUFFIX) + 1);</span><br><span class="line">        path = path.concat(ProjectConstant.CONFIG_FILE_PATH);</span><br><span class="line">        log.info(&quot;load default path:&quot; + path);</span><br><span class="line">        return path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取jar方式的默认路径</span><br><span class="line">     *</span><br><span class="line">     * @param path</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private String getDefaultPathToJar(String path) &#123;</span><br><span class="line">        path = path.substring(0, path.toLowerCase().indexOf(ProjectConstant.JAR_SUFFIX));</span><br><span class="line">        path = path.substring(path.indexOf(ProjectConstant.SPLIT_CHAR) + 1, path.lastIndexOf(ProjectConstant.SPLIT_CHAR) + 1);</span><br><span class="line">        if (!path.contains(ProjectConstant.COLON_CHAR)) &#123;</span><br><span class="line">            path = ProjectConstant.SPLIT_CHAR + path;</span><br><span class="line">        &#125;</span><br><span class="line">        path = path.concat(ProjectConstant.CONFIG_FILE_PATH);</span><br><span class="line">        log.info(&quot;jar load default path:&quot; + path);</span><br><span class="line">        return path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="3-XmlManager"><a href="#3-XmlManager" class="headerlink" title="3.XmlManager"></a>3.XmlManager</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.resource.manage.utils;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.bean.BeanUtil;</span><br><span class="line">import cn.hutool.core.util.XmlUtil;</span><br><span class="line">import com.boco.nbd.resource.manage.exception.BaseException;</span><br><span class="line">import org.dom4j.Attribute;</span><br><span class="line">import org.dom4j.Document;</span><br><span class="line">import org.dom4j.DocumentException;</span><br><span class="line">import org.dom4j.Element;</span><br><span class="line">import org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line">import java.io.StringReader;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:caohai</span><br><span class="line"> * @date:2021/7/1 17:26</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:TODO XmlManager</span><br><span class="line"> * @modify</span><br><span class="line"> */</span><br><span class="line">public class XmlManager &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 复杂xml报文:解析节点属性</span><br><span class="line">     *</span><br><span class="line">     * @param content</span><br><span class="line">     * @param clazz</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; complexToClass(String content, Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        List&lt;T&gt; result = new ArrayList&lt;&gt;(10);</span><br><span class="line">        SAXReader reader = new SAXReader();</span><br><span class="line">        try &#123;</span><br><span class="line">            Document document = reader.read(new StringReader(content));</span><br><span class="line">            Element element = document.getRootElement();</span><br><span class="line">            List&lt;Element&gt; elements = element.elements();</span><br><span class="line">            for (Element e : elements) &#123;</span><br><span class="line">                Map&lt;String, Object&gt; maps = e.attributes().stream().collect(Collectors.toMap(Attribute::getName, Attribute::getValue));</span><br><span class="line">                T model = (T) BeanUtil.toBean(maps, clazz);</span><br><span class="line">                result.add(model);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (DocumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            throw new BaseException(&quot;DocumentException:&quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /************************w3c dom格式 start*****************************/</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 简单类型(w3c dom格式):解析节点内容</span><br><span class="line">     *</span><br><span class="line">     * @param content</span><br><span class="line">     * @param clazz</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static  &lt;T&gt; List&lt;T&gt; simpleToClass(String content, Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; maps = XmlUtil.xmlToMap(content);</span><br><span class="line">        return mapToClass(maps, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * map转Class(w3c dom格式)</span><br><span class="line">     *</span><br><span class="line">     * @param maps</span><br><span class="line">     * @param clazz</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static  &lt;T&gt; List&lt;T&gt; mapToClass(Map&lt;String, Object&gt; maps, Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        List&lt;T&gt; result = new ArrayList&lt;&gt;(10);</span><br><span class="line">        if (null == maps) &#123;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        for (Map.Entry&lt;String, Object&gt; entry : maps.entrySet()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //T model = (T) clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">                List&lt;Object&gt; list = handleMapEntry(entry);</span><br><span class="line">                if (null == list) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                for (Object obj : list) &#123;</span><br><span class="line">                    HashMap&lt;String, Object&gt; items = (HashMap&lt;String, Object&gt;) obj;</span><br><span class="line">                    T model = (T) BeanUtil.toBean(items, clazz);</span><br><span class="line">                    result.add(model);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">                throw new BaseException(&quot;xml文件隐射实体异常:&quot; + ex.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 处理map实体</span><br><span class="line">     * 暂时处理：ArrayList,HashMap 后期扩展</span><br><span class="line">     *</span><br><span class="line">     * @param entry</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static List&lt;Object&gt; handleMapEntry(Map.Entry&lt;String, Object&gt; entry) &#123;</span><br><span class="line">        if (entry.getValue().getClass().equals(ArrayList.class)) &#123;</span><br><span class="line">            return (ArrayList) entry.getValue();</span><br><span class="line">        &#125;</span><br><span class="line">        if (entry.getValue().getClass().equals(HashMap.class)) &#123;</span><br><span class="line">            return Arrays.asList(entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /************************w3c dom格式 end*****************************/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-test，xml转对象"><a href="#4-test，xml转对象" class="headerlink" title="4.test，xml转对象"></a>4.test，xml转对象</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">   //jar包内在resources下，jar包外，同级目录新建config文件夹</span><br><span class="line">   String s = ReadFileManager.getInstance().getFileContext(&quot;License.xml&quot;);</span><br><span class="line">   System.out.println(s);</span><br><span class="line"></span><br><span class="line">   List&lt;User&gt; users = ConfigManager.getInstance().simpleToClass(&quot;a.xml&quot;, User.class);</span><br><span class="line">   System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="上海项目"><a href="#上海项目" class="headerlink" title="上海项目"></a>上海项目</h1><h2 id="复杂节点解析实例"><a href="#复杂节点解析实例" class="headerlink" title="复杂节点解析实例"></a>复杂节点解析实例</h2><p><img src="/../img/image-20220401151018610.png" alt="image-20220401151018610"></p>
<p>原来是外层<items></items></p>
<p>第二层<item>用简单解析即可</item></p>
<p>现在的格式<item>层中有属性，<item>层内也有属性才能用这个方法</item></item></p>
<p>XmlManager里添加这个方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 复杂xml报文:解析节点属性+元素属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz &lt;item&gt;层的实体</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrClazz:&lt;item&gt;内层的实体</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">complexToClass</span><span class="params">(String content, Class&lt;?&gt; clazz, Class&lt;?&gt; attrClazz)</span> </span>&#123;</span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">    SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Document document = reader.read(<span class="keyword">new</span> StringReader(content));</span><br><span class="line">        Element element = document.getRootElement();</span><br><span class="line">        List&lt;Element&gt; elements = element.elements();</span><br><span class="line">        <span class="keyword">for</span> (Element e : elements) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; maps = e.attributes().stream().collect(Collectors.toMap(Attribute::getName, Attribute::getValue));</span><br><span class="line">            <span class="keyword">if</span> (attrClazz != <span class="keyword">null</span> &amp;&amp; !e.elements().isEmpty()) &#123;</span><br><span class="line">                e.elements().forEach(s -&gt; &#123;</span><br><span class="line">                    String qName = s.getQName().getName();</span><br><span class="line">                    List attrResult = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">                    s.elements().forEach(t -&gt; &#123;</span><br><span class="line">                        Map&lt;String, Object&gt; attrMap = t.attributes().stream().collect(Collectors.toMap(Attribute::getName, Attribute::getValue));</span><br><span class="line">                        attrResult.add(BeanUtil.toBean(attrMap, attrClazz));</span><br><span class="line">                    &#125;);</span><br><span class="line">                    maps.put(qName, attrResult);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            T model = (T) BeanUtil.toBean(maps, clazz);</span><br><span class="line">            result.add(model);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;DocumentException:&#123;&#125;&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应实体</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterfaceConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//第二层的item对应</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//最内层对应</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ParamConfig&gt; params;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamConfig</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String paramName;</span><br><span class="line">        <span class="keyword">private</span> String paramType;</span><br><span class="line">        <span class="keyword">private</span> String paramField;</span><br><span class="line">        <span class="keyword">private</span> String defaultValue;</span><br><span class="line">        <span class="keyword">private</span> String paramData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;InterfaceConfig&gt; items = XmlManager.complexToClass(configInfo, InterfaceConfig.class, InterfaceConfig.ParamConfig.class);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>xml</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络</title>
    <url>/2021/11/30/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/</url>
    <content><![CDATA[<p>我小姜一定要弄懂计算机网络！！！！！我认为是重点，工作能用的前面加个<em>，大标题全部都要看的加个</em>*</p>
<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">网络由结点和链路组成</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211202094000046.png" alt="image-20211202094000046"></p>
<h1 id="私有网络（内网）"><a href="#私有网络（内网）" class="headerlink" title="私有网络（内网）"></a>私有网络（内网）</h1><p><img src="/../img/image-20211225214601067.png" alt="image-20211225214601067"></p>
<h1 id="因特网"><a href="#因特网" class="headerlink" title="因特网"></a>因特网</h1><p><img src="/../img/image-20211202094035178.png" alt="image-20211202094035178"></p>
<p>直接连接因特网的成为主机</p>
<h1 id="以太网"><a href="#以太网" class="headerlink" title="以太网"></a>以太网</h1><p>以太网是应用最广泛的局域网技术。电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分，以太网可以用在局域网、广域网、也可以用在互联网上，现在网络有以太网化的趋势，因为简单易用，所以很普及。</p>
<h1 id="路由器"><a href="#路由器" class="headerlink" title="*路由器"></a>*路由器</h1><p>1.连接两个网络</p>
<p>2.找出最快通信路径</p>
<p>通过分配给自己的IP地址和子网掩码，相与可以得出该路由器其中一个接口的网络地址</p>
<p>注意路由器的路由表目的网络都是网络地址，不是IP地址</p>
<p>聚合路由</p>
<p><img src="/../img/image-20211225153234290.png" alt="image-20211225153234290"></p>
<h1 id="路由器与交换机的区别"><a href="#路由器与交换机的区别" class="headerlink" title="*路由器与交换机的区别"></a>*路由器与交换机的区别</h1><p><img src="/../img/image-20211224230517419.png" alt="image-20211224230517419"></p>
<p>路由器在网络层使用，而交换机是链路层</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTcxMDIxMTY1ODQ3NTk5?x-oss-process=image/format,png" alt="这里写图片描述"></p>
<p>通过拓扑图我们应该知道：<br><strong>每一个路由器与其之下连接的设备，其实构成一个局域网</strong><br>交换机工作在路由器之下，就是也就是<strong>交换机工作在局域网内</strong><br>交换机用于<strong>局域网内网的数据转发</strong><br>路由器用于<strong>连接局域网和外网</strong></p>
<h2 id="路由器网络层用于转发IP，在数据链路层通过交换机转发，一个路由器有多个MAC地址，交换机最终找到转发的MAC地址给路由器，路由器通过MAC地址找到IP（高速缓存表），通过IP地址找到对应的主机"><a href="#路由器网络层用于转发IP，在数据链路层通过交换机转发，一个路由器有多个MAC地址，交换机最终找到转发的MAC地址给路由器，路由器通过MAC地址找到IP（高速缓存表），通过IP地址找到对应的主机" class="headerlink" title="路由器网络层用于转发IP，在数据链路层通过交换机转发，一个路由器有多个MAC地址，交换机最终找到转发的MAC地址给路由器，路由器通过MAC地址找到IP（高速缓存表），通过IP地址找到对应的主机"></a>路由器网络层用于转发IP，在数据链路层通过交换机转发，一个路由器有多个MAC地址，交换机最终找到转发的MAC地址给路由器，路由器通过MAC地址找到IP（高速缓存表），通过IP地址找到对应的主机</h2><h1 id="用户是如何接入到因特网的？"><a href="#用户是如何接入到因特网的？" class="headerlink" title="*用户是如何接入到因特网的？"></a>*用户是如何接入到因特网的？</h1><p>用户通过ISP（下图解释），ISP可以申请到成块的IP地址，用户得到ip地址</p>
<p>我国的ISP，电信，联通，移动</p>
<p><img src="/../img/image-20211202094631636.png" alt="image-20211202094631636"></p>
<h1 id="三种交换方式"><a href="#三种交换方式" class="headerlink" title="*三种交换方式"></a>*三种交换方式</h1><h2 id="电路交换"><a href="#电路交换" class="headerlink" title="电路交换"></a>电路交换</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">两个电话需要一根链路，多个电话需要更多的链路</span><br><span class="line">使用交换机如第3个图所示</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211202095517204.png" alt="image-20211202095517204"></p>
<h3 id="电路交换的三个步骤"><a href="#电路交换的三个步骤" class="headerlink" title="电路交换的三个步骤"></a>电路交换的三个步骤</h3><p><img src="/../img/image-20211202095849231.png" alt="image-20211202095849231"></p>
<h2 id="分组交换（重点）"><a href="#分组交换（重点）" class="headerlink" title="*分组交换（重点）"></a>*分组交换（重点）</h2><p><strong>分组交换机就是路由器</strong>，负责连接各个网络，接收到分组转发</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1现在H6用户想发送信息到H2，把该消息成为报文</span><br><span class="line">2发送报文之前，把报文划分成一个个更小的等长数据段</span><br><span class="line">3在每一个数据段前，加上必要的控制信息组成的首部，就构成了一个分组（注意是一个分组），也叫“包”</span><br><span class="line">4那么添加首部的作用是什么？</span><br><span class="line">	包含了分组的目的地址，否则分组交换机（路由器）不知道怎么转发分组了</span><br><span class="line">5分组交换机接收到一个分组后，暂时储存起来，检查首部，按照首部的目的地址进行查表转发，找到合适的转发接口，通过该接口转发给下一个分组交换机</span><br><span class="line">6注意，每个等长数据段走的分组交换机的链路可能是不同的，但是最终都会走到目的地址H2，并去掉每段的首部，组合还原成原始报文</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211202101949086.png" alt="image-20211202101949086"></p>
<p><img src="/../img/image-20211202102011364.png" alt="image-20211202102011364"></p>
<h2 id="报文交换"><a href="#报文交换" class="headerlink" title="报文交换"></a>报文交换</h2><p>基本不用了</p>
<h1 id="计算机网络定义"><a href="#计算机网络定义" class="headerlink" title="计算机网络定义"></a>计算机网络定义</h1><p><img src="/../img/image-20211202102504119.png" alt="image-20211202102504119"></p>
<p>下图是不是一个计算机网络？</p>
<p>不是，因为只有显示和输入设备，只是一个大型机系统</p>
<p><img src="/../img/image-20211202102348560.png" alt="image-20211202102348560"></p>
<h1 id="网络分类"><a href="#网络分类" class="headerlink" title="*网络分类"></a>*网络分类</h1><p><img src="/../img/image-20211202102759243.png" alt="image-20211202102759243"></p>
<p>公用网：所有愿意按电信公司（电信，联通，移动）规定交纳费用的人都可以使用这个网络</p>
<p>专用网：某个部门为本单位建造的网络（内网）</p>
<p>广域网：覆盖国家，地区</p>
<p>城域网：覆盖城市，互联企业，机构，校园局域网</p>
<p>局域网：一个校园或者企业，拥有多数互联的局域网（内网）</p>
<p>个域网：无线鼠标，耳机，热点</p>
<h1 id="性能指标"><a href="#性能指标" class="headerlink" title="*性能指标"></a>*性能指标</h1><h2 id="比特"><a href="#比特" class="headerlink" title="*比特"></a>*比特</h2><p><img src="/../img/image-20211202104209140.png" alt="image-20211202104209140"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1字节=8比特</span><br><span class="line">1KB=2的10次方字节</span><br><span class="line">MB=2的20次方字节</span><br><span class="line">GB=2的30次方字节</span><br><span class="line">TB=2的40次方字节</span><br></pre></td></tr></table></figure>

<h4 id="为什么买的盘显示容量和实际容量不一致？"><a href="#为什么买的盘显示容量和实际容量不一致？" class="headerlink" title="为什么买的盘显示容量和实际容量不一致？"></a>为什么买的盘显示容量和实际容量不一致？</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">固态硬盘：厂家保留了一部分空间不让用户使用</span><br><span class="line"></span><br><span class="line">机械硬盘：单位不一致，厂家单位G为10的9次方，操作系统G为2的30次方</span><br></pre></td></tr></table></figure>

<h2 id="度量性能"><a href="#度量性能" class="headerlink" title="度量性能"></a>度量性能</h2><h3 id="速率"><a href="#速率" class="headerlink" title="*速率"></a>*速率</h3><p><img src="/../img/image-20211202104826032.png" alt="image-20211202104826032"></p>
<h5 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h5><p><img src="/../img/image-20211202105452758.png" alt="image-20211202105452758"></p>
<p>100MB=100*2的23次方bit</p>
<p>100Mbps=100*10的6次方bit</p>
<p>2的23次方/10的6次方</p>
<h3 id="带宽"><a href="#带宽" class="headerlink" title="带宽"></a>带宽</h3><p><img src="/../img/image-20211202110442124.png" alt="image-20211202110442124"></p>
<p><strong>带宽和速率有关联，带宽是速率的最大值，而速率就是速率</strong></p>
<h3 id="吞吐量"><a href="#吞吐量" class="headerlink" title="吞吐量"></a>吞吐量</h3><p><img src="/../img/image-20211202110839266.png" alt="image-20211202110839266"></p>
<h3 id="时延"><a href="#时延" class="headerlink" title="时延"></a>时延</h3><p><img src="/../img/image-20211202111314116.png" alt="image-20211202111314116"></p>
<p>其中发送时延计算中的分母，发送速率，为短板效应中最小的速率</p>
<h3 id="时延带宽积"><a href="#时延带宽积" class="headerlink" title="时延带宽积"></a>时延带宽积</h3><p>可以理解为面积，长*宽</p>
<p><img src="/../img/image-20211202121726035.png" alt="image-20211202121726035"></p>
<h3 id="往返时间"><a href="#往返时间" class="headerlink" title="往返时间"></a>往返时间</h3><p><img src="/../img/image-20211202121957534.png" alt="image-20211202121957534"></p>
<h3 id="利用率"><a href="#利用率" class="headerlink" title="利用率"></a>利用率</h3><p>信道利用率 信道有百分之几是被利用的（有数据通过）</p>
<p>​                    并非越高越好，一般要控制不超过50%</p>
<p>​                    也不能过低，造成资源浪费</p>
<h3 id="丢包率"><a href="#丢包率" class="headerlink" title="丢包率"></a>丢包率</h3><p><img src="/../img/image-20211202122412998.png" alt="image-20211202122412998"></p>
<h1 id="体系结构"><a href="#体系结构" class="headerlink" title="*体系结构"></a>*体系结构</h1><p><img src="/../img/image-20211202123126010.png" alt="image-20211202123126010"></p>
<p>我们用第三个图，五层协议</p>
<p><img src="/../img/image-20211202123922913.png" alt="image-20211202123922913"></p>
<h2 id="目前的协议举例"><a href="#目前的协议举例" class="headerlink" title="目前的协议举例"></a>目前的协议举例</h2><p><img src="/../img/image-20211225223838323.png" alt="image-20211225223838323"></p>
<h1 id="物理层"><a href="#物理层" class="headerlink" title="*物理层"></a>*物理层</h1><h3 id="1-概念"><a href="#1-概念" class="headerlink" title="1.概念"></a>1.概念</h3><p><img src="/../img/image-20211220102247543.png" alt="image-20211220102247543"></p>
<h3 id="2-传输媒体"><a href="#2-传输媒体" class="headerlink" title="2.传输媒体"></a>2.传输媒体</h3><p><img src="/../img/image-20211220102922354.png" alt="image-20211220102922354"></p>
<h3 id="3-传输方式"><a href="#3-传输方式" class="headerlink" title="3.传输方式"></a>3.传输方式</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p><img src="/../img/image-20211220103124324.png" alt="image-20211220103124324"></p>
<p>计算机网路之间是串行的</p>
<p>计算机内部传输信号是并行的</p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p><img src="/../img/image-20211220111041303.png" alt="image-20211220111041303"></p>
<p><img src="/../img/image-20211220111057594.png" alt="image-20211220111057594"></p>
<p>同步传输会产生时钟误差，</p>
<h4 id="3"><a href="#3" class="headerlink" title="3"></a>3</h4><p><img src="/../img/image-20211220111939875.png" alt="image-20211220111939875"></p>
<p>1.天线2对讲机3手机</p>
<h3 id="4-编码与调制"><a href="#4-编码与调制" class="headerlink" title="*4.编码与调制"></a>*4.编码与调制</h3><p>计算机只能处理2进制数据，比特0和比特1</p>
<p><img src="/../img/image-20211224190959029.png" alt="image-20211224190959029"></p>
<p><img src="/../img/image-20211224191007739.png" alt="image-20211224191007739"></p>
<p>10Mb/s，10兆比特/秒就是曼彻斯特编码</p>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="*数据链路层"></a>*数据链路层</h2><p><img src="/../img/image-20211224194744060.png" alt="image-20211224194744060"></p>
<p>主机有五层网络协议，而中间的只有三层即可</p>
<p>主机H1加待发送的数据逐层封装，通过物理层将各比特转化为电信号发送到传输媒体，数据包进入路由器，由下往上逐层解析到网络层，路由器根据数据包的目的网络地址和自身转发表，确定数据包的转发端口，然后从网络层向下逐层封装成数据包，通过物理层发送到传输媒体，数据包最终到达主机H2时，还要由下往上逐层解封，最终解封出H1发出的数据</p>
<p><img src="/../img/image-20211224201711785.png" alt="image-20211224201711785"></p>
<p><img src="/../img/image-20211224202312063.png" alt="image-20211224202312063"></p>
<p>以太网V2的MAC帧</p>
<p>发送给物理层加上前导码，不需要帧定界，有帧间间隔</p>
<p><img src="/../img/image-20211224203532696.png" alt="image-20211224203532696"></p>
<p>PPP帧，前后各有一个字节表示帧定界</p>
<p><img src="/../img/image-20211224203436243.png" alt="image-20211224203436243"></p>
<p>我们知道，接收方通过帧开始flag，到帧结束flag判定为一个帧，如果消息内带有flag怎么办，在每一个帧发送前，会扫描消息，如果消息体有flag，就会添加一个转义字符在前面，这样先读到转义符以后，就知道后一个flag就不是帧结束</p>
<h3 id="点对点协议PPP"><a href="#点对点协议PPP" class="headerlink" title="点对点协议PPP"></a>点对点协议PPP</h3><p>是目前使用最广泛的点对点数据链路层协议</p>
<h1 id="MAC地址"><a href="#MAC地址" class="headerlink" title="MAC地址"></a>MAC地址</h1><p>以太网的mac子层所使用的的地址（数据链路层）</p>
<p>每个主机发送的帧中必须携带发送主机和接受主机的地址，用于媒体接入控制MAC（MediaAccessControl）这类地址叫MAC地址</p>
<p>MAC地址是硬件地址</p>
<p>平板，手机，笔记本，都会有最少一个（无线局域网适配器）MAC地址，路由器有更多的MAC地址</p>
<p><img src="/../img/image-20211224215319865.png" alt="image-20211224215319865"></p>
<h1 id="IP地址"><a href="#IP地址" class="headerlink" title="*IP地址"></a>*IP地址</h1><p>tcp/ip体系结构网际层所使用的的地址（网际层）</p>
<p><img src="/../img/image-20211224220506443.png" alt="image-20211224220506443"></p>
<p>在网络N8上，同一个网路上的主机，网络号相同，主机编号不同</p>
<p>各个网络的网络号必须不同</p>
<p><img src="/../img/image-20211224220701504.png" alt="image-20211224220701504"></p>
<p>自上而下</p>
<p><img src="/../img/image-20211224220750490.png" alt="image-20211224220750490"></p>
<p>应用层报文，发送给运输层，运输层无需看懂，添加一个运输层首部继续传输即可</p>
<p>ip地址在网络层首部</p>
<p>MAC地址在数据链路层首部<img src="/../img/image-20211224221103235.png" alt="image-20211224221103235"></p>
<p><img src="/../img/image-20211224221123913.png" alt="image-20211224221123913"></p>
<h1 id="ARP协议"><a href="#ARP协议" class="headerlink" title="ARP协议"></a>ARP协议</h1><p>通过ip地址找到对应的MAC地址（网际层）</p>
<p><img src="/../img/image-20211224214237506.png" alt="image-20211224214237506"></p>
<p><img src="/../img/image-20211224224250955.png" alt="image-20211224224250955"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">知道C的ip地址，但是不知道c的MAC地址</span><br><span class="line">每个主机都有ARP高速缓存表</span><br><span class="line">B先查表，发现没有对应的C的ip地址</span><br><span class="line">那么会在同一个网络，或者同一个链路上发送广播请求，内容为</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211224224434337.png" alt="image-20211224224434337"></p>
<p>其他主机收到该广播，交给上层ARP进程处理解析，A发现要请求的不是自己的ip丢弃，C发现是请求自己的，首先将B的ip地址和B的MAC地址记录到C的高速缓存表总，并发送响应数据（单播，目的地址为B的地址），A收到单播帧发现目的地址不是自己的，丢弃，主机B发现是自己的ip地址，交给上层处理，解析，将C的ip地址和MAC地址记录到自己的ARP告诉缓存表中</p>
<p><img src="/../img/image-20211224224808855.png" alt="image-20211224224808855"></p>
<p><img src="/../img/image-20211224224817585.png" alt="image-20211224224817585"></p>
<p>是否定的，ARP协议想在不同的网络上使用，需要有交换机，图中是没有交换机的</p>
<h1 id="以太网交换机"><a href="#以太网交换机" class="headerlink" title="**以太网交换机"></a>**以太网交换机</h1><p><img src="/../img/image-20211224233825497.png" alt="image-20211224233825497"></p>
<h2 id="自学习"><a href="#自学习" class="headerlink" title="自学习"></a>自学习</h2><p><img src="/../img/image-20211224230247111.png" alt="image-20211224230247111"></p>
<p><img src="/../img/image-20211224230415924.png" alt="image-20211224230415924"></p>
<p>前提是无需ARP协议去缓存各个主机的MAC地址</p>
<p>A发送帧到B，在交换机1的帧交换表中先登记A的MAC地址和对应A的接口。然后在帧交换表中找B，现在是没有的，就会盲目转发，除了接口1向其他接口都发送此帧。主机B接受帧解析发现目的地址是B的MAC地址，就接受该帧。该帧通过交换机1的接口4，通过交换机2的接口2进入到交换机2，交换机2首先记录主机A的MAC地址和进入交换机2的接口2，然后进行转发查找B，发现没有B的MAC地址，于是再一次盲目转发到DEF主机，解析发现都不止发送个自己的帧，都会丢弃。</p>
<p>B发送帧到A，先登记，然后查找A的MAC地址，发现有，通过接口1转发出去。</p>
<p>E到A，登记自己，查找并发现有A，通过A的接口2，转发到交换机1的4的接口进入交换机1，登记E，查找A的MAC地址，发现有，于是通过接口1发送到主机A。</p>
<h2 id="生成树协议STP"><a href="#生成树协议STP" class="headerlink" title="生成树协议STP"></a>生成树协议STP</h2><p><img src="/../img/image-20211224233710422.png" alt="image-20211224233710422"></p>
<h1 id="虚拟局域网VLAN概念"><a href="#虚拟局域网VLAN概念" class="headerlink" title="虚拟局域网VLAN概念"></a>虚拟局域网VLAN概念</h1><h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><p>广播风暴概念：</p>
<p><img src="/../img/image-20211224234341814.png" alt="image-20211224234341814"></p>
<p>为了防止广播风暴，需要隔离广播域，可以使用路由器，一个广播只能在同一个路由器中转发，因为路由器默认不对广播进行转发</p>
<p><img src="/../img/image-20211224234259269.png" alt="image-20211224234259269"></p>
<p>但是又因为路由器成本过高，此时，虚拟局域网VLAN出现了</p>
<p>一个交换机可以划分一个局域网</p>
<p><img src="/../img/image-20211224234636887.png" alt="image-20211224234636887"></p>
<p>通过一个交换机互联原来的3个交换机，那么原来的3个局域网变为现在大的局域网的3个网段，网络中的各主机属于同一个广播域，一个主机发送广播，其他都可以收到</p>
<p><img src="/../img/image-20211224234825658.png" alt="image-20211224234825658"></p>
<p>使用VLAN技术，可以自定义划分区域，这样广播只会在特定的区域广播</p>
<p><img src="/../img/image-20211224235207730.png" alt="image-20211224235207730"></p>
<h2 id="VLAN的实现机制"><a href="#VLAN的实现机制" class="headerlink" title="VLAN的实现机制"></a>VLAN的实现机制</h2><p>是在交换机上实现的</p>
<p><img src="/../img/image-20211224235444105.png" alt="image-20211224235444105"></p>
<h3 id="交换机端口"><a href="#交换机端口" class="headerlink" title="交换机端口"></a>交换机端口</h3><h4 id="1-Access端口"><a href="#1-Access端口" class="headerlink" title="1.Access端口"></a>1.Access端口</h4><p>需要修改交换机的配置</p>
<p><img src="/../img/image-20211225001110858.png"></p>
<h4 id="2-Trunk端口"><a href="#2-Trunk端口" class="headerlink" title="2.Trunk端口"></a>2.Trunk端口</h4><p><img src="/../img/image-20211225002513933.png" alt="image-20211225002513933"></p>
<p>因此，连接主机的端口应设置为Access类型，交换机之间互联的端口设置为Trunk类型</p>
<h4 id="3-Hybrid端口"><a href="#3-Hybrid端口" class="headerlink" title="3.Hybrid端口"></a>3.Hybrid端口</h4><p>可以看出VID有了组的概念</p>
<p><img src="/../img/image-20211225003444416.png" alt="image-20211225003444416"></p>
<h1 id="网络层"><a href="#网络层" class="headerlink" title="**网络层"></a>**网络层</h1><p><img src="/../img/image-20211225115724966.png" alt="image-20211225115724966"></p>
<h1 id="IPV4地址"><a href="#IPV4地址" class="headerlink" title="*IPV4地址"></a>*IPV4地址</h1><p><img src="/../img/image-20211225120327232.png" alt="image-20211225120327232"></p>
<h3 id="分类编址的IPv4地址"><a href="#分类编址的IPv4地址" class="headerlink" title="分类编址的IPv4地址"></a>分类编址的IPv4地址</h3><p>最高固定为0,10,110,1110,1111</p>
<p><img src="/../img/image-20211225120642582.png" alt="image-20211225120642582"></p>
<p>主机号全为0为某类的网络地址，不是可分配的IP地址</p>
<p>主机号全为1的为某类的广播地址，不是可分配的IP地址</p>
<p>一个网络有一个网络地址，主机号全0,</p>
<h4 id="A类"><a href="#A类" class="headerlink" title="A类"></a>A类</h4><p><img src="/../img/image-20211225121016450.png" alt="image-20211225121016450"></p>
<h4 id="B类"><a href="#B类" class="headerlink" title="B类"></a>B类</h4><p><img src="/../img/image-20211225121304106.png" alt="image-20211225121304106"></p>
<h4 id="C类"><a href="#C类" class="headerlink" title="C类"></a>C类</h4><p><img src="/../img/image-20211225121426919.png" alt="image-20211225121426919"></p>
<p><img src="/../img/image-20211225122004636.png" alt="image-20211225122004636"></p>
<p><img src="/../img/image-20211225122500350.png" alt="image-20211225122500350"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">上图的题的解析：</span><br><span class="line">1.先找出需要几个网络，注意路由器之间也需要一个网络，一共4个网络</span><br><span class="line">2.查看每个网络主机需要分配的IP个数</span><br><span class="line">黄色网络，65534个IP+路由器端口需要1个IP=65535个，因为B类一个网络最多只能分配65534个IP，所以只能是A类网络。</span><br><span class="line">网络号：1-126</span><br><span class="line">主机号：不能全1广播地址，不能全0网络地址</span><br><span class="line"></span><br><span class="line">蓝色网络，254+1=255，因为C类只能分配254个IP，所以可以A可以B，根据题目节约，B类网络</span><br><span class="line">网络号：128.0-191.255</span><br><span class="line">主机号：不能全1广播地址，不能全0网络地址</span><br><span class="line"></span><br><span class="line">绿色网络，16+24=40个主机加上一个路由器接口IP=41个，注意交换机不需要分配IP，41个IP，C类即可</span><br><span class="line">网络号：192.0.0-223.255.255</span><br><span class="line">主机号：不能全1广播地址，不能全0网络地址</span><br><span class="line"></span><br><span class="line">粉色网络，2个路由器接口IP，C类</span><br><span class="line">网络号：192.0.0-223.255.255，注意不能跟绿色网络的网络号一致</span><br><span class="line">主机号：不能全1广播地址，不能全0网络地址</span><br></pre></td></tr></table></figure>

<h4 id="划分子网的IPv4地址"><a href="#划分子网的IPv4地址" class="headerlink" title="划分子网的IPv4地址"></a>划分子网的IPv4地址</h4><p>从主机号中借用几位，就可以划分2的几次方个子网（网络）</p>
<p><img src="/../img/image-20211225141023183.png" alt="image-20211225141023183"></p>
<p><img src="/../img/image-20211225130830763.png" alt="image-20211225130830763"></p>
<h5 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h5><p><img src="/../img/image-20211225132408269.png" alt="image-20211225132408269"></p>
<p><img src="/../img/image-20211225132559094.png" alt="image-20211225132559094"></p>
<p>划分子网0和子网1了</p>
<p><img src="/../img/image-20211225132836923.png" alt="image-20211225132836923"></p>
<p><img src="/../img/image-20211225133717999.png" alt="image-20211225133717999"></p>
<p><img src="/../img/image-20211225133822210.png" alt="image-20211225133822210"></p>
<h3 id="无分类编制的IPv4地址"><a href="#无分类编制的IPv4地址" class="headerlink" title="无分类编制的IPv4地址"></a>无分类编制的IPv4地址</h3><p><img src="/../img/image-20211225140233860.png" alt="image-20211225140233860"></p>
<h2 id="IPv4地址的应用规划"><a href="#IPv4地址的应用规划" class="headerlink" title="IPv4地址的应用规划"></a>IPv4地址的应用规划</h2><p><img src="/../img/image-20211225141115420.png" alt="image-20211225141115420"></p>
<p><img src="/../img/image-20211225141133766.png" alt="image-20211225141133766"></p>
<p>字长子网掩码划分了8个网络，但是只需要5个网络，并且举例N5只需要4个IP即可，但是每个子网30多个IP，造成了严重的浪费</p>
<p><img src="/../img/image-20211225141346604.png" alt="image-20211225141346604"></p>
<p><img src="/../img/image-20211225143240691.png" alt="image-20211225143240691"></p>
<h2 id="IP数据报的发送和转发过程"><a href="#IP数据报的发送和转发过程" class="headerlink" title="IP数据报的发送和转发过程"></a>IP数据报的发送和转发过程</h2><p><img src="/../img/image-20211225144457222.png" alt="image-20211225144457222"></p>
<h2 id="静态路由配置"><a href="#静态路由配置" class="headerlink" title="静态路由配置"></a>静态路由配置</h2><p>静态的就是手工配置的</p>
<p><img src="/../img/image-20211225150007813.png" alt="image-20211225150007813"></p>
<h3 id="特定主机路由，直接32位主机号的地址"><a href="#特定主机路由，直接32位主机号的地址" class="headerlink" title="特定主机路由，直接32位主机号的地址"></a>特定主机路由，直接32位主机号的地址</h3><h3 id="默认路由：未找到指定的路由，走这个路由"><a href="#默认路由：未找到指定的路由，走这个路由" class="headerlink" title="默认路由：未找到指定的路由，走这个路由"></a>默认路由：未找到指定的路由，走这个路由</h3><p><img src="/../img/image-20211225151245334.png" alt="image-20211225151245334"></p>
<h3 id="最长前缀路由匹配原则"><a href="#最长前缀路由匹配原则" class="headerlink" title="最长前缀路由匹配原则"></a>最长前缀路由匹配原则</h3><p>匹配度最长的优先，可以理解为网络前缀长的</p>
<h3 id="黑洞路由"><a href="#黑洞路由" class="headerlink" title="黑洞路由"></a>黑洞路由</h3><p>下一跳为空null0，可以自动生效，失效</p>
<h1 id="IPv4数据包的首部格式"><a href="#IPv4数据包的首部格式" class="headerlink" title="IPv4数据包的首部格式"></a>IPv4数据包的首部格式</h1><p><img src="/../img/image-20211225174237460.png" alt="image-20211225174237460"></p>
<p><img src="/../img/image-20211225174253012.png" alt="image-20211225174253012"></p>
<p>数据长度=总长度-首部长度</p>
<p><img src="/../img/image-20211225174327498.png" alt="image-20211225174327498"></p>
<h1 id="网际控制报文协议ICMP"><a href="#网际控制报文协议ICMP" class="headerlink" title="网际控制报文协议ICMP"></a>网际控制报文协议ICMP</h1><h2 id="差错报告报文"><a href="#差错报告报文" class="headerlink" title="差错报告报文"></a>差错报告报文</h2><p><img src="/../img/image-20211225213330268.png" alt="image-20211225213330268"></p>
<h2 id="ICMP询问报文-回送请求和回答"><a href="#ICMP询问报文-回送请求和回答" class="headerlink" title="ICMP询问报文-回送请求和回答"></a>ICMP询问报文-回送请求和回答</h2><p><img src="/../img/image-20211225213051929.png" alt="image-20211225213051929"></p>
<p><img src="/../img/image-20211225213315378.png" alt="image-20211225213315378"></p>
<p>跟踪路由原理，逐步添加TTL的数值从1开始，经过R1TTL-1变0，返回给H1差错报告报文，TTL=2，R2发送差错，TTL=3，H2发送ICMP回送请求和回答报文，就知道中途经过了哪些路由器</p>
<p><img src="/../img/image-20211225213515179.png" alt="image-20211225213515179"></p>
<h1 id="虚拟专用网VPN和网络地址转换NAT"><a href="#虚拟专用网VPN和网络地址转换NAT" class="headerlink" title="*虚拟专用网VPN和网络地址转换NAT"></a>*虚拟专用网VPN和网络地址转换NAT</h1><p><img src="/../img/image-20211225214120272.png" alt="image-20211225214120272"></p>
<p><img src="/../img/image-20211225214403066.png" alt="image-20211225214403066"></p>
<h2 id="NAT路由器"><a href="#NAT路由器" class="headerlink" title="NAT路由器"></a>NAT路由器</h2><p><img src="/../img/image-20211225214959005.png" alt="image-20211225214959005"></p>
<h2 id="现在家用的路由器基本都是NAPT路由器"><a href="#现在家用的路由器基本都是NAPT路由器" class="headerlink" title="现在家用的路由器基本都是NAPT路由器"></a>现在家用的路由器基本都是NAPT路由器</h2><p><img src="/../img/image-20211225215104372.png" alt="image-20211225215104372"></p>
<p><img src="/../img/image-20211225215348202.png" alt="image-20211225215348202"></p>
<h2 id="使用私有地址的主机不能直接充当因特网服务器"><a href="#使用私有地址的主机不能直接充当因特网服务器" class="headerlink" title="使用私有地址的主机不能直接充当因特网服务器"></a>使用私有地址的主机不能直接充当因特网服务器</h2><p><img src="/../img/image-20211225215720146.png" alt="image-20211225215720146"></p>
<p>比如内网穿透技术，把内网转为外网ip</p>
<h1 id="运输层"><a href="#运输层" class="headerlink" title="运输层"></a>运输层</h1><p><img src="/../img/image-20211225221851718.png" alt="image-20211225221851718"></p>
<p><img src="/../img/image-20211225222503633.png" alt="image-20211225222503633"></p>
<p><img src="/../img/image-20211225223230198.png" alt="image-20211225223230198"></p>
<p><img src="/../img/image-20211225223316035.png" alt="image-20211225223316035"></p>
<h2 id="TCP和UDP"><a href="#TCP和UDP" class="headerlink" title="TCP和UDP"></a>TCP和UDP</h2><p>TCP面向字节流</p>
<p>UDP面向应用层报文</p>
<p><img src="/../img/image-20211225224642911.png" alt="image-20211225224642911"></p>
<h2 id="TCP流量控制"><a href="#TCP流量控制" class="headerlink" title="TCP流量控制"></a>TCP流量控制</h2><p><img src="/../img/image-20211225231321297.png" alt="image-20211225231321297"></p>
<h2 id="TCP拥塞控制"><a href="#TCP拥塞控制" class="headerlink" title="TCP拥塞控制"></a>TCP拥塞控制</h2><p>输入多少，就应该输出多少，可以理解为车道的车，正常是车来车过，但是车越来越多，过得越来越慢，最终造成堵车</p>
<p><img src="/../img/image-20211225232212847.png" alt="image-20211225232212847"></p>
<h2 id="TCP的连接建立"><a href="#TCP的连接建立" class="headerlink" title="TCP的连接建立"></a>TCP的连接建立</h2><p><img src="/../img/image-20211226002124119.png" alt="image-20211226002124119"></p>
<h2 id="连接流程"><a href="#连接流程" class="headerlink" title="连接流程"></a>连接流程</h2><p>3次握手</p>
<p>SYN：TCP连接请求报文段首部中的同步位，不懈怠数据也要消耗一个序号</p>
<p>seq：序号字段</p>
<p>ack:对序号字段的确认，需要+1操作</p>
<p>ACK：确认位</p>
<p><img src="/../img/image-20211226003845925.png" alt="image-20211226003845925"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.一开始，两个TCP服务都是关闭状态</span><br><span class="line">TCP服务器先创建传输控制块，创建一些信息如TCP链接表，当前发送和接收序号等，进入监听状态，等待客户端的连接请求，此时是被动等待，不是主动发起</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211226004128283.png" alt="image-20211226004128283"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TCP客户端创建传输控制块，创建一些信息如TCP链接表，当前发送和接收序号等</span><br><span class="line">向TCP服务器进程发送连接请求报文段仅，进入同步已发送状态</span><br><span class="line">TCP连接请求报文段首部中的同步位SYN被设置为1，表名这是一个TCP连接请求报文段</span><br><span class="line">序号字段seq设置初始值x，SYN为1的报文段，不能携带数据，但要消耗一个序号</span><br><span class="line">2.TCP服务器接收到连接请求，如果同意连接，向客户端进程发送TCP连接请求确认报文段，进入同步已接受状态，同步位SYN=1,确认位ACK=1，序号字段seq初始值y，确认号字段设置为x+1，是对tcp客户进程所选择的初始序号的确认，也不能携带数据，要消耗一个序号</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211226004930633.png" alt="image-20211226004930633"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3.tcp客户端向服务器发送普通的连接请求确认的确认报文段，进入连接已建立状态</span><br><span class="line">ACK=1,seq=x+1，ack=y+1，注意seq+1是因为第一次发送的seq=x，消耗一个序号+1，并且普通的报文段如果不携带数据，就不消耗序号，下次还是seq=x+1,</span><br><span class="line">ack=y+1是对服务器序号y的确认</span><br><span class="line">tcp服务器接收到此报文段后，进入连接已建立状态</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211226005353601.png" alt="image-20211226005353601"></p>
<h3 id="问题？为什么是3次，而不是2次，最后一次普通的请求报文有什么用？"><a href="#问题？为什么是3次，而不是2次，最后一次普通的请求报文有什么用？" class="headerlink" title="问题？为什么是3次，而不是2次，最后一次普通的请求报文有什么用？"></a>问题？为什么是3次，而不是2次，最后一次普通的请求报文有什么用？</h3><p><img src="/../img/image-20211226005745725.png" alt="image-20211226005745725"></p>
<p><img src="/../img/image-20211226005926506.png" alt="image-20211226005926506"></p>
<h2 id="TCP连接释放"><a href="#TCP连接释放" class="headerlink" title="TCP连接释放"></a>TCP连接释放</h2><p>四次挥手</p>
<p>FIN：首部中的终止位，不懈怠数据也要消耗一个序号</p>
<p>ACK：首部中的确认位，等于1表示普通的确认报文</p>
<p>seq：序号</p>
<p>客户端发送请求时：等于客户进程之前已经传送过的数据的最后一个字节的序号+1</p>
<p>服务端发送确认时：等于服务进程之前已经传送过的数据的最后一个字节的序号+1</p>
<p>ack：确认号</p>
<p>客户端发送请求时：等于客户进程之前已经收到过的数据的最后一个字节的序号+1</p>
<p>服务端发送确认时：等于服务进程之前已经收到过的数据的最后一个字节的序号+1</p>
<p><img src="/../img/image-20211226115809885.png" alt="image-20211226115809885"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.TCP客户端主动发送释放报文，进入终止等待1状态，FIN=1,ACK=1，seq=u，ack=v</span><br><span class="line">2.服务进程收到tcp连接释放报文段后，发送一个普通的tcp确认报文，进入关闭等待状态，ACK=1，seq=v，ack=u+1，此时客户端到服务端的连接关闭，但是服务端到客户端的连接没有关闭，会持续一段时间，tcp客户进程收到服务进程的确认报文后，进入终止等待2状态，等待服务器发送tcp连接释放报文段</span><br><span class="line">3.tcp服务如果没有要发送的数据了，会通知应用进程发送TCP普通确认的连接释放报文段，FIN=1,ACK=1,seq=w，上一次是V，这一次是W是因为服务器可能会继续发送一部分，ack=u+1是对第一次tcp客户发起的报文请求的重复确认，服务进程进入最后确认状态</span><br><span class="line">4.tcp客户收到请求报文后，发送确认报文，进入时间等待状态，ACK=1，seq=u+1，ack=w+1</span><br><span class="line">5.tcp服务进程收到确认报文后进入关闭状态</span><br><span class="line">6.tcp客户进程进过2MSL才进入关闭状态</span><br><span class="line">MSL：最长报文段寿明</span><br></pre></td></tr></table></figure>

<h3 id="问题：为什么有第4步，不是直接关闭而是进入时间等待状态，2MSL后才关闭？"><a href="#问题：为什么有第4步，不是直接关闭而是进入时间等待状态，2MSL后才关闭？" class="headerlink" title="问题：为什么有第4步，不是直接关闭而是进入时间等待状态，2MSL后才关闭？"></a>问题：为什么有第4步，不是直接关闭而是进入时间等待状态，2MSL后才关闭？</h3><p>如果tcp客户发送的最后一个确认报文丢失了，但是也进入关闭状态了，服务器没有接收到确认报文，就会超时重发，而客户已经关闭了，不理睬此报文，就会一直重发</p>
<p>并且，2MSL会使本次连接所产生的所有报文都从网络中消失</p>
<h2 id="tcp服务端保活计时器"><a href="#tcp服务端保活计时器" class="headerlink" title="tcp服务端保活计时器"></a>tcp服务端保活计时器</h2><p><img src="/../img/image-20211226121743374.png" alt="image-20211226121743374"></p>
<h2 id="TCP报文的首部格式"><a href="#TCP报文的首部格式" class="headerlink" title="TCP报文的首部格式"></a>TCP报文的首部格式</h2><p><img src="/../img/image-20211226122837569.png" alt="image-20211226122837569"></p>
<p><img src="/../img/image-20211226122928408.png" alt="image-20211226122928408"></p>
<p><img src="/../img/image-20211226122956985.png" alt="image-20211226122956985"></p>
<p><img src="/../img/image-20211226123016556.png" alt="image-20211226123016556"></p>
<p><img src="/../img/image-20211226123246207.png" alt="image-20211226123246207"></p>
<p><img src="/../img/image-20211226123341152.png" alt="image-20211226123341152"></p>
<h1 id="应用层"><a href="#应用层" class="headerlink" title="**应用层"></a>**应用层</h1><p><img src="/../img/image-20211226123846402.png" alt="image-20211226123846402"></p>
<p><img src="/../img/image-20211226124026454.png" alt="image-20211226124026454"></p>
<h2 id="C-S方式"><a href="#C-S方式" class="headerlink" title="C/S方式"></a>C/S方式</h2><p><img src="/../img/image-20211226124537410.png" alt="image-20211226124537410"></p>
<h2 id="P2P方式"><a href="#P2P方式" class="headerlink" title="P2P方式"></a>P2P方式</h2><p><img src="/../img/image-20211226124746190.png" alt="image-20211226124746190"></p>
<h2 id="动态主机配置协议DHCP"><a href="#动态主机配置协议DHCP" class="headerlink" title="动态主机配置协议DHCP"></a>动态主机配置协议DHCP</h2><h2 id="DHCP客户机端口68"><a href="#DHCP客户机端口68" class="headerlink" title="DHCP客户机端口68"></a>DHCP客户机端口68</h2><h2 id="DHCP服务器短裤67"><a href="#DHCP服务器短裤67" class="headerlink" title="DHCP服务器短裤67"></a>DHCP服务器短裤67</h2><p><img src="/../img/image-20211226130008487.png" alt="image-20211226130008487"></p>
<h3 id="自己网络上没有DHCP服务器，如何通过其他网络上的DHCP服务器自动获取到ip"><a href="#自己网络上没有DHCP服务器，如何通过其他网络上的DHCP服务器自动获取到ip" class="headerlink" title="自己网络上没有DHCP服务器，如何通过其他网络上的DHCP服务器自动获取到ip"></a>自己网络上没有DHCP服务器，如何通过其他网络上的DHCP服务器自动获取到ip</h3><p><img src="/../img/image-20211226134607354.png" alt="image-20211226134607354"></p>
<p>首先路由器不会转发广播报文，但是给路由器配置DHCP服务器的IP地址，使路由器成为DHCP中继代理，当路由器发现DHCP发现报文，就会去找DHCP服务器了</p>
<h2 id="DNS服务器用于解析域名对应的IP"><a href="#DNS服务器用于解析域名对应的IP" class="headerlink" title="DNS服务器用于解析域名对应的IP"></a>DNS服务器用于解析域名对应的IP</h2><h2 id="端口默认53"><a href="#端口默认53" class="headerlink" title="端口默认53"></a>端口默认53</h2><p>当使用域名访问网站时，先在本地DNS主机的DNS高速缓存中查找IP地址</p>
<p>如果没有找到，向网络中的某台DNS服务器查询，该服务器存在对应域名与ip地址的数据库。</p>
<p>当DNS服务器收到DNS查询报文后，会从库中查询，结果返回给主机</p>
<p><img src="/../img/image-20211226141455559.png" alt="image-20211226141455559"></p>
<h2 id="域名结构"><a href="#域名结构" class="headerlink" title="域名结构"></a>域名结构</h2><p><img src="/../img/image-20211226141645062.png" alt="image-20211226141645062"></p>
<p><img src="/../img/image-20211226142118259.png" alt="image-20211226142118259"></p>
<p><img src="/../img/image-20211226142432763.png" alt="image-20211226142432763"></p>
<p><img src="/../img/image-20211226142555522.png" alt="image-20211226142555522"></p>
<p><img src="/../img/image-20211226142625373.png"></p>
<p><img src="/../img/image-20211226142913374.png" alt="image-20211226142913374"></p>
<h2 id="文件传输协议FTP"><a href="#文件传输协议FTP" class="headerlink" title="文件传输协议FTP"></a>文件传输协议FTP</h2><p><img src="/../img/image-20211226143234122.png" alt="image-20211226143234122"></p>
<h3 id="搭建FTP"><a href="#搭建FTP" class="headerlink" title="搭建FTP"></a>搭建FTP</h3><p><img src="/../img/image-20211226143315605.png" alt="image-20211226143315605"></p>
<h3 id="工作原理-主动模式"><a href="#工作原理-主动模式" class="headerlink" title="工作原理-主动模式"></a>工作原理-主动模式</h3><p><img src="/../img/image-20211226143558506.png" alt="image-20211226143558506"></p>
<h3 id="被动模式"><a href="#被动模式" class="headerlink" title="被动模式"></a>被动模式</h3><p><img src="/../img/image-20211226143645902.png" alt="image-20211226143645902"></p>
<p><img src="/../img/image-20211226143708476.png" alt="image-20211226143708476"></p>
<p><img src="/../img/image-20211226143808601.png" alt="image-20211226143808601"></p>
<h1 id="电子邮件"><a href="#电子邮件" class="headerlink" title="电子邮件"></a>电子邮件</h1><p>邮件发送协议SMTP协议</p>
<p>邮件读取协议POP3，IMAP</p>
<p><img src="/../img/image-20211226144146374.png" alt="image-20211226144146374"></p>
<p><img src="/../img/image-20211226144252739.png" alt="image-20211226144252739"></p>
<h2 id="SMTP协议"><a href="#SMTP协议" class="headerlink" title="SMTP协议"></a>SMTP协议</h2><p>默认端口25</p>
<p>传输内容必须是ASCII文本</p>
<h2 id="POP3"><a href="#POP3" class="headerlink" title="POP3"></a>POP3</h2><p>端口110</p>
<h2 id="IMAP4"><a href="#IMAP4" class="headerlink" title="IMAP4"></a>IMAP4</h2><p>端口143</p>
<p><img src="/../img/image-20211226144913128.png" alt="image-20211226144913128"></p>
<h1 id="万维网WWW"><a href="#万维网WWW" class="headerlink" title="万维网WWW"></a>万维网WWW</h1><p><img src="/../img/image-20211226145302390.png" alt="image-20211226145302390"></p>
<h2 id="超文本传输协议HTTP"><a href="#超文本传输协议HTTP" class="headerlink" title="超文本传输协议HTTP"></a>超文本传输协议HTTP</h2><p><img src="/../img/image-20211226145620217.png" alt="image-20211226145620217"></p>
<p><img src="/../img/image-20211226145815152.png" alt="image-20211226145815152"></p>
<h2 id="报文格式"><a href="#报文格式" class="headerlink" title="报文格式"></a>报文格式</h2><h4 id="请求报文"><a href="#请求报文" class="headerlink" title="请求报文"></a>请求报文</h4><p><img src="/../img/image-20211226150019348.png" alt="image-20211226150019348"></p>
<h3 id="响应报文"><a href="#响应报文" class="headerlink" title="响应报文"></a>响应报文</h3><p><img src="/../img/image-20211226151227172.png" alt="image-20211226151227172"></p>
<h2 id="HTTP是无状态的"><a href="#HTTP是无状态的" class="headerlink" title="HTTP是无状态的"></a>HTTP是无状态的</h2><h2 id="Cookie是一种对无状态的HTTP进行状态化的技术"><a href="#Cookie是一种对无状态的HTTP进行状态化的技术" class="headerlink" title="Cookie是一种对无状态的HTTP进行状态化的技术"></a>Cookie是一种对无状态的HTTP进行状态化的技术</h2><p><img src="/../img/image-20211226151434062.png" alt="image-20211226151434062"></p>
<h2 id="万维网缓存与代理服务器"><a href="#万维网缓存与代理服务器" class="headerlink" title="万维网缓存与代理服务器"></a>万维网缓存与代理服务器</h2><p>代理服务器有缓存</p>
<p><img src="/../img/image-20211226151556374.png" alt="image-20211226151556374"></p>
<p>代理服务器没有缓存</p>
<p><img src="/../img/image-20211226151615674.png" alt="image-20211226151615674"></p>
<h2 id="问题：如果原始服务器改变了，而代理服务器还是原来的缓存，怎么办呢？"><a href="#问题：如果原始服务器改变了，而代理服务器还是原来的缓存，怎么办呢？" class="headerlink" title="问题：如果原始服务器改变了，而代理服务器还是原来的缓存，怎么办呢？"></a>问题：如果原始服务器改变了，而代理服务器还是原来的缓存，怎么办呢？</h2><p>代理服务器首先获取原始服务器的文本都会有一个last-modified字段（上次修改时间）的缓存时间</p>
<p>本地主机访问代理服务器时，发现有last-modified字段缓存并且时间未过期，就不去原始服务器查</p>
<p>如果过期，代理服务器向原始服务器发送一个请求报文，包含一个首部字段为if-modified-since的首部行，值为last-modified的值，原始服务器根据此字段与自己服务器的对比，如果没有修改，返回304响应码，修改代理服务器的有效日期，如果有修改，原始服务器发送封装有该文档的响应报文，代理服务器更新了文档，发回给主机</p>
<p><img src="/../img/image-20211226152454790.png" alt="image-20211226152454790"></p>
<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><p><a href="https://blog.csdn.net/ailunlee/article/details/90600174?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164137983516780261954159%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164137983516780261954159&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-90600174.pc_search_result_cache&amp;utm_term=http%E8%AF%B7%E6%B1%82&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/ailunlee/article/details/90600174?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164137983516780261954159%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=164137983516780261954159&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-90600174.pc_search_result_cache&amp;utm_term=http%E8%AF%B7%E6%B1%82&amp;spm=1018.2226.3001.4187</a></p>
<h2 id="几种常见的Content-Type类型"><a href="#几种常见的Content-Type类型" class="headerlink" title="几种常见的Content-Type类型"></a>几种常见的Content-Type类型</h2><p>服务端根据请求头中的Content-Type字段来获取消息主体的编码方式，进而进行解析数据。</p>
<h3 id="1、application-x-www-form-urlencoded"><a href="#1、application-x-www-form-urlencoded" class="headerlink" title="1、application/x-www-form-urlencoded"></a>1、application/x-www-form-urlencoded</h3><p>最常见的 POST 提交数据的方式，原生Form表单，如果不设置 enctype 属性，默认为application/x-www-form-urlencoded 方式提交数据。</p>
<h3 id="2、multipart-form-data"><a href="#2、multipart-form-data" class="headerlink" title="2、multipart/form-data"></a>2、multipart/form-data</h3><p>用于文件上传</p>
<h3 id="3、application-json"><a href="#3、application-json" class="headerlink" title="3、application/json"></a>3、application/json</h3><h3 id="4、text-xml"><a href="#4、text-xml" class="headerlink" title="4、text/xml"></a>4、text/xml</h3>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>计算机网络</tag>
      </tags>
  </entry>
  <entry>
    <title>io</title>
    <url>/2021/11/30/io%E6%B5%81/</url>
    <content><![CDATA[<h1 id="1-MultipartFile-转-File"><a href="#1-MultipartFile-转-File" class="headerlink" title="1.MultipartFile 转 File"></a>1.MultipartFile 转 File</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * MultipartFile 转 File</span><br><span class="line"> *</span><br><span class="line"> * @param file</span><br><span class="line"> * @throws Exception</span><br><span class="line"> */</span><br><span class="line">public static File multipartFileToFile(MultipartFile file) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    File toFile = null;</span><br><span class="line">    if (&quot;&quot;.equals(file) || file.getSize() &lt;= 0) &#123;</span><br><span class="line">        file = null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        InputStream ins = null;</span><br><span class="line">        ins = file.getInputStream();</span><br><span class="line">        toFile = new File(file.getOriginalFilename());</span><br><span class="line">        inputStreamToFile(ins, toFile);</span><br><span class="line">        ins.close();</span><br><span class="line">    &#125;</span><br><span class="line">    return toFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-获取json文件的内容"><a href="#2-获取json文件的内容" class="headerlink" title="2.获取json文件的内容"></a>2.获取json文件的内容</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取json文件的内容</span><br><span class="line"> *</span><br><span class="line"> * @param fileName</span><br><span class="line"> * @return</span><br><span class="line"> * @throws Exception</span><br><span class="line"> */</span><br><span class="line">public String readJsonFile(MultipartFile fileName) &#123;</span><br><span class="line">    String jsonStr = &quot;&quot;;</span><br><span class="line">    try &#123;</span><br><span class="line">        File file = multipartFileToFile(fileName);</span><br><span class="line">        FileReader fileReader = new FileReader(file);</span><br><span class="line">        Reader reader = new InputStreamReader(new FileInputStream(file), &quot;utf-8&quot;);</span><br><span class="line">        int ch = 0;</span><br><span class="line">        StringBuffer sb = new StringBuffer();</span><br><span class="line">        while ((ch = reader.read()) != -1) &#123;</span><br><span class="line">            sb.append((char) ch);</span><br><span class="line">        &#125;</span><br><span class="line">        fileReader.close();</span><br><span class="line">        reader.close();</span><br><span class="line">        jsonStr = sb.toString();</span><br><span class="line">        return jsonStr;</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        log.error(e.getMessage());</span><br><span class="line">        return null;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(e.getMessage());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-in流和out流"><a href="#3-in流和out流" class="headerlink" title="3.in流和out流"></a>3.in流和out流</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">   InputStream inputStream = null;</span><br><span class="line">   OutputStream outputStream = null;</span><br><span class="line">   try &#123;</span><br><span class="line">      String path=&quot;D:&quot;+File.separator;</span><br><span class="line">      //获取file对象,不存在创建</span><br><span class="line">      File file = FileUtil.newFile(path+&quot;a.txt&quot;);</span><br><span class="line">      if(!FileUtil.exist(file))&#123;</span><br><span class="line">         file.createNewFile();</span><br><span class="line">      &#125;</span><br><span class="line">      inputStream = FileUtil.getInputStream(file);</span><br><span class="line">      byte[] buffer = new byte[inputStream.available()];</span><br><span class="line">      inputStream.read(buffer);</span><br><span class="line">      //无需显示的创建，自动会创建</span><br><span class="line">      File toFile = FileUtil.newFile(path+&quot;b.txt&quot;);</span><br><span class="line">      outputStream = FileUtil.getOutputStream(toFile);</span><br><span class="line">      outputStream.write(buffer);</span><br><span class="line">      outputStream.flush();</span><br><span class="line">   &#125; catch (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125; finally &#123;</span><br><span class="line">      if (outputStream != null) &#123;</span><br><span class="line">         try &#123;</span><br><span class="line">            outputStream.close();</span><br><span class="line">         &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (inputStream != null) &#123;</span><br><span class="line">         try &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">         &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-json工具类"><a href="#4-json工具类" class="headerlink" title="4.json工具类"></a>4.json工具类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.upload.station.utils;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/11/11  14:00</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:生成json文件工具类</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class JsonUtil &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;res.path&#125;&quot;)</span><br><span class="line">    private String resPath;</span><br><span class="line"></span><br><span class="line">    private static final String SUFFIX = &quot;.json&quot;;</span><br><span class="line"></span><br><span class="line">    private static final int BYTE = 8192;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 创建.json格式文件</span><br><span class="line">     *</span><br><span class="line">     * @param jsonStr  json文件内容</span><br><span class="line">     * @param filePath json文件路径</span><br><span class="line">     */</span><br><span class="line">    public int createJsonFile(String jsonStr, String filePath) &#123;</span><br><span class="line">        Writer write = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            //格式化json字符串</span><br><span class="line">            String json = formatJson(jsonStr);</span><br><span class="line">            String code = &quot;702&quot;;</span><br><span class="line">            if (!code.equals(json)) &#123;</span><br><span class="line">                String fullPath = resPath + filePath + SUFFIX;</span><br><span class="line">                File file = new File(fullPath);</span><br><span class="line">                // 如果父目录不存在，创建父目录</span><br><span class="line">                if (!file.getParentFile().exists()) &#123;</span><br><span class="line">                    file.getParentFile().mkdirs();</span><br><span class="line">                &#125;</span><br><span class="line">                if (file.exists()) &#123;</span><br><span class="line">                    return 707;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line"></span><br><span class="line">                    file.createNewFile();</span><br><span class="line">                    write = new OutputStreamWriter(new FileOutputStream(file), &quot;UTF-8&quot;);</span><br><span class="line">                    write.write(json);</span><br><span class="line">                    log.info(&quot;File created successfully！:&quot; + fullPath);</span><br><span class="line">                    write.flush();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return 702;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (write != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    write.close();</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    log.error(e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 返回格式化的json字符串</span><br><span class="line">     *</span><br><span class="line">     * @param json</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static String formatJson(String json) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            JSONObject object = JSONObject.parseObject(json);</span><br><span class="line">            json = JSON.toJSONString(object, SerializerFeature.PrettyFormat, SerializerFeature.WriteMapNullValue, SerializerFeature.WriteDateUseDateFormat);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            return &quot;702&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取json文件的内容</span><br><span class="line">     *</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    public String readJsonFile(MultipartFile fileName) &#123;</span><br><span class="line">        String jsonStr = &quot;&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            File file = multipartFileToFile(fileName);</span><br><span class="line">            FileReader fileReader = new FileReader(file);</span><br><span class="line">            Reader reader = new InputStreamReader(new FileInputStream(file), &quot;utf-8&quot;);</span><br><span class="line">            int ch = 0;</span><br><span class="line">            StringBuffer sb = new StringBuffer();</span><br><span class="line">            while ((ch = reader.read()) != -1) &#123;</span><br><span class="line">                sb.append((char) ch);</span><br><span class="line">            &#125;</span><br><span class="line">            fileReader.close();</span><br><span class="line">            reader.close();</span><br><span class="line">            jsonStr = sb.toString();</span><br><span class="line">            return jsonStr;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            return null;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * MultipartFile 转 File</span><br><span class="line">     *</span><br><span class="line">     * @param file</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    public static File multipartFileToFile(MultipartFile file) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        File toFile = null;</span><br><span class="line">        if (&quot;&quot;.equals(file) || file.getSize() &lt;= 0) &#123;</span><br><span class="line">            file = null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            InputStream ins = null;</span><br><span class="line">            ins = file.getInputStream();</span><br><span class="line">            toFile = new File(file.getOriginalFilename());</span><br><span class="line">            inputStreamToFile(ins, toFile);</span><br><span class="line">            ins.close();</span><br><span class="line">        &#125;</span><br><span class="line">        return toFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取文件io流</span><br><span class="line">     *</span><br><span class="line">     * @param ins</span><br><span class="line">     * @param file</span><br><span class="line">     */</span><br><span class="line">    private static void inputStreamToFile(InputStream ins, File file) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            OutputStream os = new FileOutputStream(file);</span><br><span class="line">            int bytesRead = 0;</span><br><span class="line">            byte[] buffer = new byte[BYTE];</span><br><span class="line">            while ((bytesRead = ins.read(buffer, 0, BYTE)) != -1) &#123;</span><br><span class="line">                os.write(buffer, 0, bytesRead);</span><br><span class="line">            &#125;</span><br><span class="line">            os.close();</span><br><span class="line">            ins.close();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Response 写入二进制流</span><br><span class="line">     *</span><br><span class="line">     * @param multipartFile 二进制文件</span><br><span class="line">     * @param response      响应内容</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static void setOutPutStream(MultipartFile multipartFile, HttpServletResponse response, String md5, String fileName) &#123;</span><br><span class="line">        InputStream inputStream = null;</span><br><span class="line">        OutputStream outputStream = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            File file = multipartFileToFile(multipartFile);</span><br><span class="line">            inputStream = new BufferedInputStream(new FileInputStream(file));</span><br><span class="line">            byte[] buffer = new byte[inputStream.available()];</span><br><span class="line">            inputStream.read(buffer);</span><br><span class="line">            response.reset();</span><br><span class="line">            response.addHeader(&quot;Content-Length&quot;, &quot;&quot; + file.length());</span><br><span class="line">            response.setHeader(&quot;binfile-md5&quot;, md5);</span><br><span class="line">            response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot; + fileName);</span><br><span class="line">            outputStream = new BufferedOutputStream(response.getOutputStream());</span><br><span class="line">            outputStream.write(buffer);</span><br><span class="line">            outputStream.flush();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (outputStream != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    outputStream.close();</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    log.error(e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (inputStream != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    log.error(e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int len=0;</span><br><span class="line">byte []buf=new byte[1024];</span><br><span class="line">while((len=in.read(buf))!=-1)&#123;</span><br><span class="line">    os.write(buf, 0, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="服务之间传递流（文件，图片等）"><a href="#服务之间传递流（文件，图片等）" class="headerlink" title="服务之间传递流（文件，图片等）"></a>服务之间传递流（文件，图片等）</h1><p>服务B：被调用方</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;/download/&#123;name&#125;&quot;)</span><br><span class="line">public byte[] download(@PathVariable(&quot;name&quot;) String name) throws Exception&#123;</span><br><span class="line">    FileInputStream in=null;</span><br><span class="line">    try &#123;</span><br><span class="line">        in=new FileInputStream(new File(&quot;D:&quot;+File.separator+name));</span><br><span class="line"></span><br><span class="line">        BufferedInputStream bufferedInputStream =new BufferedInputStream(in);</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=new ByteArrayOutputStream();</span><br><span class="line">        byte[] buffer=null;</span><br><span class="line">        int len=0;</span><br><span class="line">        byte []buf=new byte[2048];</span><br><span class="line">        while((len=bufferedInputStream.read(buf))!=-1)&#123;</span><br><span class="line">            byteArrayOutputStream.write(buf, 0, len);</span><br><span class="line">        &#125;</span><br><span class="line">        byteArrayOutputStream.flush();</span><br><span class="line">        buffer=byteArrayOutputStream.toByteArray();</span><br><span class="line">        return buffer;</span><br><span class="line">    &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        return null;</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        if(in!=null)&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务A：调用方</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.controller;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:23</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class A &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">//    private final String URL=&quot;http://localhost:8082/test1&quot;;</span><br><span class="line">    private final String URL2=&quot;http://localhost:8082/download&quot;;</span><br><span class="line">//    @RequestMapping(&quot;/test&quot;)</span><br><span class="line">//    public void test()&#123;</span><br><span class="line">//        String success = restTemplate.getForObject(URL, String.class);</span><br><span class="line">//        System.out.println(success);</span><br><span class="line">//    &#125;</span><br><span class="line">//    @RequestMapping(&quot;/test1&quot;)</span><br><span class="line">//    public String test1()&#123;</span><br><span class="line">//        return &quot;haha&quot;;</span><br><span class="line">//    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/accept/&#123;name&#125;&quot;)</span><br><span class="line">    public void accept(@PathVariable(&quot;name&quot;)String name) throws  Exception&#123;</span><br><span class="line">        byte[] bytes = restTemplate.getForObject(URL2 + &quot;/&quot; + name, byte[].class);</span><br><span class="line">        OutputStream os=new FileOutputStream(new File(&quot;D:\\b.jpg&quot;));</span><br><span class="line">        os.write(bytes);</span><br><span class="line">        os.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.conf;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/09/03  16:28</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class config &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public RestTemplate getRestTemplate()&#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文档很全</p>
<p><a href="https://blog.csdn.net/qq_44543508/article/details/102831084?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163117905816780269838127%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163117905816780269838127&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-102831084.first_rank_v2_pc_rank_v29&amp;utm_term=io%E6%B5%81&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/qq_44543508/article/details/102831084?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163117905816780269838127%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163117905816780269838127&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-102831084.first_rank_v2_pc_rank_v29&amp;utm_term=io%E6%B5%81&amp;spm=1018.2226.3001.4187</a></p>
<p><img src="/../img/image-20210910083736002.png" alt="image-20210910083736002"></p>
<p><img src="/../img/image-20210910085822905.png" alt="image-20210910085822905"></p>
<p>GBK是默认的，一般字母、数字都占一个，汉字两个。UTF-8数字、字母一个，汉字三<em>个字节</em>。</p>
<h1 id="字节流"><a href="#字节流" class="headerlink" title="字节流"></a>字节流</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public void stream() throws Exception&#123;</span><br><span class="line">    File file = ResourceUtils.getFile(ResourceUtils.CLASSPATH_URL_PREFIX+&quot;static/a.txt&quot;);</span><br><span class="line">    InputStream in=new FileInputStream(file);</span><br><span class="line">    File file1 = new File(&quot;D:\\Idea\\workspace\\demo\\src\\main\\resources\\static\\b.txt&quot;);</span><br><span class="line">    OutputStream os=new FileOutputStream(file1);</span><br><span class="line">    //复制</span><br><span class="line">    int len=0;</span><br><span class="line">    byte []buf=new byte[1024];</span><br><span class="line">    //将输入流中读取一定数量 并将其存储在缓冲区数组 buf 中。</span><br><span class="line">    while((len=in.read(buf))!=-1)&#123;</span><br><span class="line">        os.write(buf, 0, len);</span><br><span class="line">    &#125;</span><br><span class="line">    in.close();</span><br><span class="line">    os.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void stream1() throws Exception&#123;</span><br><span class="line">        File file = ResourceUtils.getFile(ResourceUtils.CLASSPATH_URL_PREFIX+&quot;static/a.txt&quot;);</span><br><span class="line">        InputStream in=new FileInputStream(file);</span><br><span class="line">        File file1 = new File(&quot;D:\\Idea\\workspace\\demo\\src\\main\\resources\\static\\b.txt&quot;);</span><br><span class="line">        OutputStream os=new FileOutputStream(file1);</span><br><span class="line">        //复制</span><br><span class="line">        int len=0;</span><br><span class="line">        while((len=in.read())!=-1)&#123;//从输入流读取数据的下一个字节</span><br><span class="line">            os.write(len);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">        os.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="while-len-in-read-buf-1-os-write-buf-0-len-解读"><a href="#while-len-in-read-buf-1-os-write-buf-0-len-解读" class="headerlink" title="while((len=in.read(buf))!=-1){ os.write(buf, 0, len); }解读"></a>while((len=in.read(buf))!=-1){ os.write(buf, 0, len); }解读</h2><p>将输入流读取数组指定的字节，存储在数组buf中</p>
<p>说明a.txt只有13个字节，buf数组有1024个字节，只读一次就可以了</p>
<p><img src="/../img/image-20220309102739192.png" alt="image-20220309102739192"></p>
<p>修改buf数组为2，发现13个字节，一共读了8次，走了7次true，最后一个读不到东西了，返回-1</p>
<p><img src="/../img/image-20220309102821695.png" alt="image-20220309102821695"></p>
<p>数组可以指定输入流的大小，之后就会只读取一次</p>
<p><img src="/../img/image-20220309103958453.png" alt="image-20220309103958453"></p>
<h1 id="字符流"><a href="#字符流" class="headerlink" title="字符流"></a>字符流</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public void text() throws Exception&#123;</span><br><span class="line">    File file = ResourceUtils.getFile(ResourceUtils.CLASSPATH_URL_PREFIX+&quot;static/a.txt&quot;);</span><br><span class="line">    FileReader reader=new FileReader(file);</span><br><span class="line">    File file1 = new File(&quot;D:\\Idea\\workspace\\demo\\src\\main\\resources\\static\\b.txt&quot;);</span><br><span class="line">    FileWriter writer=new FileWriter(file1);</span><br><span class="line">    char chs[]=new char[1024];</span><br><span class="line">    int len=0;</span><br><span class="line">    while((len=reader.read(chs))!=-1) &#123;//读数据</span><br><span class="line">        writer.write(chs,0,len);//写数据</span><br><span class="line">    &#125;</span><br><span class="line">    //如果想输出文字但是继续使用流，就要用writer.flush();</span><br><span class="line">    writer.flush();</span><br><span class="line">    reader.close();</span><br><span class="line">    writer.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>最后再次强调：<br>字符流，只能操作文本文件，不能操作图片，视频等非文本文件。当我们单纯读或者写文本文件时 使用字符流 其他情况使用字节流</strong></p>
<h1 id="缓冲流"><a href="#缓冲流" class="headerlink" title="缓冲流"></a>缓冲流</h1><h2 id="字节缓冲流"><a href="#字节缓冲流" class="headerlink" title="字节缓冲流"></a>字节缓冲流</h2><p>创建流对象时，会创建一个内置的默认大小的缓冲区数组，通过缓冲区读写，减少系统IO次数，从而提高读写的效率。</p>
<p><img src="/../img/image-20210910094428981.png" alt="image-20210910094428981"></p>
<p>缓冲流读写方法与基本的流是一致的，我们通过复制370多MB的大文件，测试它的效率。</p>
<p>基本流，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 记录开始时间</span></span><br><span class="line">      	<span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">		<span class="comment">// 创建流对象</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">        	FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;py.exe&quot;</span>);<span class="comment">//exe文件够大</span></span><br><span class="line">        	FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;copyPy.exe&quot;</span>)</span><br><span class="line">        )&#123;</span><br><span class="line">        	<span class="comment">// 读写数据</span></span><br><span class="line">            <span class="keyword">int</span> b;</span><br><span class="line">            <span class="keyword">while</span> ((b = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fos.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 记录结束时间</span></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;普通流复制时间:&quot;</span>+(end - start)+<span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">不好意思十分钟过去了还在玩命复制中...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">缓冲流，代码如下：</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 记录开始时间</span></span><br><span class="line">      	<span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">		<span class="comment">// 创建流对象</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">         BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;py.exe&quot;</span>));</span><br><span class="line">	     BufferedOutputStream bos = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;copyPy.exe&quot;</span>));</span><br><span class="line">        )&#123;</span><br><span class="line">        <span class="comment">// 读写数据</span></span><br><span class="line">            <span class="keyword">int</span> b;</span><br><span class="line">            <span class="keyword">while</span> ((b = bis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 记录结束时间</span></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;缓冲流复制时间:&quot;</span>+(end - start)+<span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">缓冲流复制时间:<span class="number">8016</span> 毫秒</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">想要更快可以使用数组的方式，代码如下：</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">      	<span class="comment">// 记录开始时间</span></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">		<span class="comment">// 创建流对象</span></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">		 BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;py.exe&quot;</span>));</span><br><span class="line">		 BufferedOutputStream bos = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;copyPy.exe&quot;</span>));</span><br><span class="line">        )&#123;</span><br><span class="line">          	<span class="comment">// 读写数据</span></span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8</span>*<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> ((len = bis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(bytes, <span class="number">0</span> , len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 记录结束时间</span></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;缓冲流使用数组复制时间:&quot;</span>+(end - start)+<span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">缓冲流使用数组复制时间:<span class="number">521</span> 毫秒 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="字符缓冲流"><a href="#字符缓冲流" class="headerlink" title="字符缓冲流"></a>字符缓冲流</h2><p>字符缓冲流特有方法</p>
<p>BufferedReader：public String readLine(): 读一行数据。 读取到最后返回null<br>BufferedWriter：public void newLine(): 换行,由系统属性定义符号。<br>readLine方法演示代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">text1</span><span class="params">()</span> <span class="keyword">throws</span> IOException  </span>&#123;</span><br><span class="line">    <span class="comment">// 创建流对象</span></span><br><span class="line">    BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">&quot;D:\\Idea\\workspace\\demo\\src\\main\\resources\\static\\a.txt&quot;</span>));</span><br><span class="line">    BufferedWriter bw = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(<span class="string">&quot;D:\\Idea\\workspace\\demo\\src\\main\\resources\\static\\b.txt&quot;</span>));</span><br><span class="line">    <span class="comment">// 定义字符串,保存读取的一行文字</span></span><br><span class="line">    String line  = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 循环读取,读取到最后返回null</span></span><br><span class="line">    <span class="keyword">while</span> ((line = br.readLine())!=<span class="keyword">null</span>) &#123;</span><br><span class="line">        bw.write(line);</span><br><span class="line">        <span class="comment">// 写出换行</span></span><br><span class="line">        bw.newLine();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放资源</span></span><br><span class="line">    br.close();</span><br><span class="line">    bw.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="对象流"><a href="#对象流" class="headerlink" title="对象流"></a>对象流</h1><p>就是专门用来读各种各样的数据的，比如（int，char，long等）</p>
<p>包装类DataOutputStream、DataInputStream为我们提供了多种对文件的写入和读取方法，如writeBoolean(),writeUTF()，writeCharwriteByte()，writeDouble()等和对应的read方法，这些方法极大的方便了我们的写入和读取操作</p>
<h1 id="转换流"><a href="#转换流" class="headerlink" title="转换流"></a>转换流</h1><h2 id="InputStreamReader类—–-字节流到字符流的桥梁"><a href="#InputStreamReader类—–-字节流到字符流的桥梁" class="headerlink" title="InputStreamReader类—–(字节流到字符流的桥梁)"></a>InputStreamReader类—–(字节流到字符流的桥梁)</h2><p><img src="/../img/image-20210910100620970.png" alt="image-20210910100620970"></p>
<p><img src="/../img/image-20210910100631635.png" alt="image-20210910100631635"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">使用转换流解决编码问题</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderDemo2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      	<span class="comment">// 定义文件路径,文件为gbk编码</span></span><br><span class="line">        String FileName = <span class="string">&quot;C:\\A.txt&quot;</span>;</span><br><span class="line">      	<span class="comment">// 创建流对象,默认UTF8编码</span></span><br><span class="line">        InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(FileName));</span><br><span class="line">      	<span class="comment">// 创建流对象,指定GBK编码</span></span><br><span class="line">        InputStreamReader isr2 = <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(FileName) , <span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">		<span class="comment">// 定义变量,保存字符</span></span><br><span class="line">        <span class="keyword">int</span> read;</span><br><span class="line">      	<span class="comment">// 使用默认编码字符流读取,乱码</span></span><br><span class="line">        <span class="keyword">while</span> ((read = isr.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="keyword">char</span>)read); <span class="comment">// �����ʺ      </span></span><br><span class="line">        &#125;</span><br><span class="line">        isr.close();</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">      	<span class="comment">// 使用指定编码字符流读取,正常解析</span></span><br><span class="line">        <span class="keyword">while</span> ((read = isr2.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print((<span class="keyword">char</span>)read);<span class="comment">// 哥敢摸屎</span></span><br><span class="line">        &#125;</span><br><span class="line">        isr2.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OutputStreamWriter类—–-字符流到字节流的桥梁"><a href="#OutputStreamWriter类—–-字符流到字节流的桥梁" class="headerlink" title="OutputStreamWriter类—–(字符流到字节流的桥梁)"></a>OutputStreamWriter类—–(字符流到字节流的桥梁)</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OutputDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      	<span class="comment">// 定义文件路径</span></span><br><span class="line">        String FileName = <span class="string">&quot;C:\\s.txt&quot;</span>;</span><br><span class="line">      	<span class="comment">// 创建流对象,默认UTF8编码</span></span><br><span class="line">        OutputStreamWriter osw = <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(FileName));</span><br><span class="line">        <span class="comment">// 写出数据</span></span><br><span class="line">      	osw.write(<span class="string">&quot;哥敢&quot;</span>); <span class="comment">// 保存为6个字节</span></span><br><span class="line">        osw.close();</span><br><span class="line">      	</span><br><span class="line">		<span class="comment">// 定义文件路径</span></span><br><span class="line">		String FileName2 = <span class="string">&quot;D:\\A.txt&quot;</span>;</span><br><span class="line">     	<span class="comment">// 创建流对象,指定GBK编码</span></span><br><span class="line">        OutputStreamWriter osw2 = <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(FileName2),<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">        <span class="comment">// 写出数据</span></span><br><span class="line">      	osw2.write(<span class="string">&quot;摸屎&quot;</span>);<span class="comment">// 保存为4个字节</span></span><br><span class="line">        osw2.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="序列化流"><a href="#序列化流" class="headerlink" title="序列化流"></a>序列化流</h1><p><img src="/../img/image-20210910101151089.png" alt="image-20210910101151089"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public void xuliehua() throws IOException  &#123;</span><br><span class="line">    user user=new user();</span><br><span class="line">    user.setAge(15);</span><br><span class="line">    user.setName(&quot;aaa&quot;);</span><br><span class="line">    ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(&quot;D:\\Idea\\workspace\\demo\\src\\main\\resources\\static\\b.txt&quot;));</span><br><span class="line">    // 写出对象</span><br><span class="line">    out.writeObject(user);</span><br><span class="line">    // 释放资源</span><br><span class="line">    out.close();</span><br><span class="line">&#125;</span><br><span class="line">public void fanxuliehua() throws IOException, ClassNotFoundException &#123;</span><br><span class="line">    user user=null;</span><br><span class="line"></span><br><span class="line">    FileInputStream fileIn = new FileInputStream(&quot;D:\\Idea\\workspace\\demo\\src\\main\\resources\\static\\b.txt&quot;);</span><br><span class="line">    ObjectInputStream in = new ObjectInputStream(fileIn);// 写出对象</span><br><span class="line">    user = (user) in.readObject();</span><br><span class="line">    // 释放资源</span><br><span class="line">    in.close();</span><br><span class="line">    fileIn.close();</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>user类需要实现Serializable接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class user implements Serializable &#123;</span><br><span class="line">    String name;</span><br><span class="line">    int age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="打印流"><a href="#打印流" class="headerlink" title="打印流"></a>打印流</h1><h2 id="字节输出打印流PrintStream复制文本文件"><a href="#字节输出打印流PrintStream复制文本文件" class="headerlink" title="字节输出打印流PrintStream复制文本文件"></a>字节输出打印流PrintStream复制文本文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.FileReader;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.PrintStream;</span><br><span class="line"></span><br><span class="line">public class PrintStreamDemo &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        BufferedReader br=new BufferedReader(new FileReader(&quot;copy.txt&quot;));</span><br><span class="line">        PrintStream ps=new PrintStream(&quot;printcopy.txt&quot;);</span><br><span class="line">        String line;</span><br><span class="line">        while((line=br.readLine())!=null) &#123;</span><br><span class="line">            ps.println(line);</span><br><span class="line">        &#125;</span><br><span class="line">        br.close();</span><br><span class="line">        ps.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="字符输出打印流PrintWriter复制文本文件"><a href="#字符输出打印流PrintWriter复制文本文件" class="headerlink" title="字符输出打印流PrintWriter复制文本文件"></a>字符输出打印流PrintWriter复制文本文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.FileReader;</span><br><span class="line">import java.io.FileWriter;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.PrintWriter;</span><br><span class="line">/**</span><br><span class="line"> * 使用打印流复制文本文件</span><br><span class="line"> */</span><br><span class="line">public class PrintWriterDemo &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        BufferedReader br=new BufferedReader(new FileReader(&quot;aa.txt&quot;));</span><br><span class="line">        PrintWriter pw=new PrintWriter(&quot;printcopyaa.txt&quot;);</span><br><span class="line">        String line;</span><br><span class="line">        while((line=br.readLine())!=null) &#123;</span><br><span class="line">            pw.println(line);</span><br><span class="line">        &#125;</span><br><span class="line">        br.close();</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class ProDemo &#123;</span><br><span class="line">    public static void main(String[] args) throws FileNotFoundException &#123;</span><br><span class="line">        // 创建属性集对象</span><br><span class="line">        Properties properties = new Properties();</span><br><span class="line">        // 添加键值对元素</span><br><span class="line">        properties.setProperty(&quot;filename&quot;, &quot;a.txt&quot;);</span><br><span class="line">        properties.setProperty(&quot;length&quot;, &quot;209385038&quot;);</span><br><span class="line">        properties.setProperty(&quot;location&quot;, &quot;D:\\a.txt&quot;);</span><br><span class="line">        // 打印属性集对象</span><br><span class="line">        System.out.println(properties);</span><br><span class="line">        // 通过键,获取属性值</span><br><span class="line">        System.out.println(properties.getProperty(&quot;filename&quot;));</span><br><span class="line">        System.out.println(properties.getProperty(&quot;length&quot;));</span><br><span class="line">        System.out.println(properties.getProperty(&quot;location&quot;));</span><br><span class="line"></span><br><span class="line">        // 遍历属性集,获取所有键的集合</span><br><span class="line">        Set&lt;String&gt; strings = properties.stringPropertyNames();</span><br><span class="line">        // 打印键值对</span><br><span class="line">        for (String key : strings ) &#123;</span><br><span class="line">          	System.out.println(key+&quot; -- &quot;+properties.getProperty(key));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">&#123;filename=a.txt, length=209385038, location=D:\a.txt&#125;</span><br><span class="line">a.txt</span><br><span class="line">209385038</span><br><span class="line">D:\a.txt</span><br><span class="line">filename -- a.txt</span><br><span class="line">length -- 209385038</span><br><span class="line">location -- D:\a.txt</span><br></pre></td></tr></table></figure>

<p>与流相关的方法<br>public void load(InputStream inStream)： 从字节输入流中读取键值对。</p>
<p>参数中使用了字节输入流，通过流对象，可以关联到某文件上，这样就能够加载文本中的数据了。现在文本数据格式如下:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filename=Properties.txt</span><br><span class="line">length=123</span><br><span class="line">location=C:\Properties.txt</span><br></pre></td></tr></table></figure>

<p>加载代码演示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class ProDemo &#123;</span><br><span class="line">    public static void main(String[] args) throws FileNotFoundException &#123;</span><br><span class="line">        // 创建属性集对象</span><br><span class="line">        Properties pro = new Properties();</span><br><span class="line">        // 加载文本中信息到属性集</span><br><span class="line">        pro.load(new FileInputStream(&quot;Properties.txt&quot;));</span><br><span class="line">        // 遍历集合并打印</span><br><span class="line">        Set&lt;String&gt; strings = pro.stringPropertyNames();</span><br><span class="line">        for (String key : strings ) &#123;</span><br><span class="line">          	System.out.println(key+&quot; -- &quot;+pro.getProperty(key));</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">filename -- Properties.txt</span><br><span class="line">length -- 123</span><br><span class="line">location -- C:\Properties.txt</span><br></pre></td></tr></table></figure>

<h1 id="常用转换"><a href="#常用转换" class="headerlink" title="常用转换"></a>常用转换</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//输入流</span><br><span class="line">		BufferedReader bufferedReader=new BufferedReader(new InputStreamReader(inputstream));</span><br><span class="line">		//打印流，注意并不是打印到控制台哦</span><br><span class="line">		PrintStream printStream=new PrintStream(outputStream);</span><br></pre></td></tr></table></figure>

<h1 id="java后端返回音频流，前端页面直接试听试看"><a href="#java后端返回音频流，前端页面直接试听试看" class="headerlink" title="java后端返回音频流，前端页面直接试听试看"></a>java后端返回音频流，前端页面直接试听试看</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sound&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sound</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">                     HttpServletResponse response)</span></span>&#123;</span><br><span class="line">        soundPlayer(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">soundPlayer</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//音频文件</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">&quot;D:\\a.mp3&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;音频文件不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            <span class="comment">//开始下载位置</span></span><br><span class="line">            <span class="keyword">long</span> startByte = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//结束下载位置</span></span><br><span class="line">            <span class="keyword">long</span> endByte = file.length() - <span class="number">1</span>;</span><br><span class="line">            String range = request.getHeader(<span class="string">&quot;Range&quot;</span>);</span><br><span class="line">            <span class="comment">//有range的话</span></span><br><span class="line">            String ranName = <span class="string">&quot;bytes=&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (range != <span class="keyword">null</span> &amp;&amp; range.contains(ranName) &amp;&amp; range.contains(StrUtil.DASHED)) &#123;</span><br><span class="line">                range = range.substring(range.lastIndexOf(<span class="string">&quot;=&quot;</span>) + <span class="number">1</span>).trim();</span><br><span class="line">                String[] ranges = range.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//判断range的类型</span></span><br><span class="line">                    <span class="keyword">int</span> l = <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">if</span> (ranges.length == <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="comment">//类型一：bytes=-2343</span></span><br><span class="line">                        <span class="keyword">if</span> (range.startsWith(StrUtil.DASHED)) &#123;</span><br><span class="line">                            endByte = Long.parseLong(ranges[<span class="number">0</span>]);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//类型二：bytes=2343-</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (range.endsWith(StrUtil.DASHED)) &#123;</span><br><span class="line">                            startByte = Long.parseLong(ranges[<span class="number">0</span>]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//类型三：bytes=22-2343</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (ranges.length == l) &#123;</span><br><span class="line">                        startByte = Long.parseLong(ranges[<span class="number">0</span>]);</span><br><span class="line">                        endByte = Long.parseLong(ranges[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                    startByte = <span class="number">0</span>;</span><br><span class="line">                    endByte = file.length() - <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> contentLength = endByte - startByte + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            response.addHeader(<span class="string">&quot;Accept-Ranges&quot;</span>, <span class="string">&quot;bytes&quot;</span>);</span><br><span class="line">            response.addHeader(<span class="string">&quot;Cache-control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">            response.addHeader(<span class="string">&quot;Content-Length&quot;</span>, String.valueOf(contentLength));</span><br><span class="line">            response.setHeader(<span class="string">&quot;Content-Range&quot;</span>, <span class="string">&quot;bytes &quot;</span> + startByte + <span class="string">&quot;-&quot;</span> + endByte + <span class="string">&quot;/&quot;</span> + file.length());</span><br><span class="line">            response.addHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;audio/x-wav;charset=UTF-8&quot;</span>);</span><br><span class="line">            response.setStatus(HttpServletResponse.SC_PARTIAL_CONTENT);</span><br><span class="line"></span><br><span class="line">            copyWithLength(file, response, startByte, endByte, contentLength);</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进行字节流拷贝</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file          文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response      响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentLength 内容长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endByte       结束位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startByte     开始位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyWithLength</span><span class="params">(File file, HttpServletResponse response, <span class="keyword">long</span> startByte, <span class="keyword">long</span> endByte, <span class="keyword">long</span> contentLength)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        BufferedOutputStream outputStream;</span><br><span class="line">        RandomAccessFile randomAccessFile = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//已传送数据大小</span></span><br><span class="line">        <span class="keyword">long</span> transmitted = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            randomAccessFile = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">            outputStream = <span class="keyword">new</span> BufferedOutputStream(response.getOutputStream());</span><br><span class="line">            <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">            randomAccessFile.seek(startByte);</span><br><span class="line">            <span class="keyword">while</span> ((transmitted + len) &lt;= contentLength &amp;&amp; (len = randomAccessFile.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                outputStream.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                transmitted += len;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (transmitted &lt; contentLength) &#123;</span><br><span class="line">                len = randomAccessFile.read(buff, <span class="number">0</span>, (<span class="keyword">int</span>) (contentLength - transmitted));</span><br><span class="line">                outputStream.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                transmitted += len;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            outputStream.flush();</span><br><span class="line">            response.flushBuffer();</span><br><span class="line">            randomAccessFile.close();</span><br><span class="line">            log.info(<span class="string">&quot;文件下载完毕：&#123;&#125;-&#123;&#125;：&#123;&#125;&quot;</span>, startByte, endByte, transmitted);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientAbortException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;停止下载：&#123;&#125;-&#123;&#125;：&#123;&#125;&quot;</span>, startByte, endByte, transmitted);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (randomAccessFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    randomAccessFile.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="下载代码"><a href="#下载代码" class="headerlink" title="下载代码"></a>下载代码</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line">    * 获取视频流</span><br><span class="line">    * @param response</span><br><span class="line">    * @param fileName 视频存放信息索引</span><br><span class="line">    * @return</span><br><span class="line">    * @author jiangjiaxu</span><br><span class="line">    * @Date 2020-05-20</span><br><span class="line">    * 返回视频，前端进行下载</span><br><span class="line">    */</span><br><span class="line">   @GetMapping(&quot;/getVideo&quot;)</span><br><span class="line">   public void getVideo(HttpServletRequest request, HttpServletResponse response,String fileName) &#123;</span><br><span class="line">       fileName=&quot;D:\\b.mp3&quot;;</span><br><span class="line">       //视频资源存储信息</span><br><span class="line">       response.reset();</span><br><span class="line">       //获取从那个字节开始读取文件</span><br><span class="line">       String rangeString = request.getHeader(&quot;Range&quot;);</span><br><span class="line">       log.info(&quot;getVideo获取视频资源:&#123;&#125;,读取文件字节:&#123;&#125;&quot;,fileName,rangeString);</span><br><span class="line">       try &#123;</span><br><span class="line">           //获取响应的输出流</span><br><span class="line">           OutputStream outputStream = response.getOutputStream();</span><br><span class="line"></span><br><span class="line">           File file = new File(fileName);</span><br><span class="line">           if(file.exists())&#123;</span><br><span class="line">               RandomAccessFile targetFile = new RandomAccessFile(file, &quot;r&quot;);</span><br><span class="line">               long fileLength = targetFile.length();</span><br><span class="line">               //播放</span><br><span class="line">               if(rangeString != null)&#123;</span><br><span class="line"></span><br><span class="line">                   long range = Long.parseLong(rangeString.substring(rangeString.indexOf(&quot;=&quot;) + 1, rangeString.indexOf(&quot;-&quot;)));</span><br><span class="line">                   //设置内容类型</span><br><span class="line">                   response.setHeader(&quot;Content-Type&quot;, &quot;video/mov&quot;);</span><br><span class="line">                   //设置此次相应返回的数据长度</span><br><span class="line">                   response.setHeader(&quot;Content-Length&quot;, String.valueOf(fileLength - range));</span><br><span class="line">                   //设置此次相应返回的数据范围</span><br><span class="line">                   response.setHeader(&quot;Content-Range&quot;, &quot;bytes &quot;+range+&quot;-&quot;+(fileLength-1)+&quot;/&quot;+fileLength);</span><br><span class="line">                   //返回码需要为206，而不是200</span><br><span class="line">                   response.setStatus(HttpServletResponse.SC_PARTIAL_CONTENT);</span><br><span class="line">                   //200是下载</span><br><span class="line">                   //response.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">                   //设定文件读取开始位置（以字节为单位）</span><br><span class="line">                   targetFile.seek(range);</span><br><span class="line">               &#125;else &#123;//下载</span><br><span class="line"></span><br><span class="line">                   //设置响应头，把文件名字设置好</span><br><span class="line">                   response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=&quot;+fileName );</span><br><span class="line">                   //设置文件长度</span><br><span class="line">                   response.setHeader(&quot;Content-Length&quot;, String.valueOf(fileLength));</span><br><span class="line">                   //解决编码问题</span><br><span class="line">                   response.setHeader(&quot;Content-Type&quot;,&quot;application/octet-stream&quot;);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               byte[] cache = new byte[1024 * 300];</span><br><span class="line">               int flag;</span><br><span class="line">               while ((flag = targetFile.read(cache))!=-1)&#123;</span><br><span class="line">                   outputStream.write(cache, 0, flag);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;else &#123;</span><br><span class="line">               String message = &quot;file:&quot;+fileName+&quot; not exists&quot;;</span><br><span class="line">               //解决编码问题</span><br><span class="line">               response.setHeader(&quot;Content-Type&quot;,&quot;application/json&quot;);</span><br><span class="line">               outputStream.write(message.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           outputStream.flush();</span><br><span class="line">           outputStream.close();</span><br><span class="line"></span><br><span class="line">       &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line"></span><br><span class="line">       &#125; catch (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>io</tag>
      </tags>
  </entry>
  <entry>
    <title>redis</title>
    <url>/2021/11/30/redis/</url>
    <content><![CDATA[<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>Remote Dictionary Server 远程字典服务</p>
<h1 id="Linux安装redis"><a href="#Linux安装redis" class="headerlink" title="Linux安装redis"></a>Linux安装redis</h1><p>1.下载安装包  <a href="https://redis.io/">https://redis.io</a></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210716141554668.png" alt="image-20210716141554668"></p>
<p>2.上传到linux服务器，home目录下新建redis的文件夹里</p>
<p>tar -zxvf redis-6.2.4.tar.gz 解压</p>
<p>3.在解压后的文件夹中，安装基本环境命令</p>
<p>yum install gcc-c++</p>
<p>gcc -v检查是否安装成功</p>
<p>make</p>
<p>make install</p>
<p>4.进入redis默认安装路径 /usr/local/bin</p>
<p>mkdir myconfig</p>
<p>5.cp /home/jiang/redis-6.2.4/redis.conf myconfig</p>
<p>6.redis默认不是后台启动的，修改配置文件</p>
<p>vim myconfig/redis.conf  </p>
<p>136行 daemonize no 改为yes</p>
<p>7.启动redis服务</p>
<p>/usr/local/bin目录下</p>
<p>redis-server myconfig/redis.conf</p>
<p>8.redis-cli -p 6379 以端口号6379启动客户端</p>
<p>改变ip以后，linux连接命令为    redis-cli -h 172.21.90.183 -p 6379 -a jiang</p>
<p>-h(ip地址，不是外网地址) -a(密码)</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210716144044771.png" alt="image-20210716144044771"></p>
<p>9.查看redis进程是否开启</p>
<p>新开一个窗口，ps -ef|grep redis</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210716144813246.png" alt="image-20210716144813246"></p>
<p>10.关闭redis服务</p>
<p>shutdown  </p>
<p>exit</p>
<p>客户端和服务端进程就没有了</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210716144959332.png" alt="image-20210716144959332"></p>
<h1 id="宝塔安装redis"><a href="#宝塔安装redis" class="headerlink" title="宝塔安装redis"></a>宝塔安装redis</h1><p>/www/server/redis</p>
<p>服务端宝塔面板启动</p>
<p>redis-cli -p 6379 以端口号6379启动客户端</p>
<h1 id="密码"><a href="#密码" class="headerlink" title="密码"></a>密码</h1><p># 启动redis </p>
<p># 连接客户端 </p>
<p># 获得和设置密码 </p>
<p>config get requirepass </p>
<p>config set requirepass “123456” </p>
<p>#测试ping，发现需要验证 </p>
<p>127.0.0.1:6379&gt; ping </p>
<p>NOAUTH Authentication required. </p>
<p># 验证 </p>
<p>127.0.0.1:6379&gt; auth 123456 </p>
<p>OK</p>
<p>127.0.0.1:6379&gt; ping </p>
<p>PONG </p>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><p><strong>1.默认16个数据库，使用第0个数据库，可以使用select切换数据库</strong> </p>
<p>select 2  –&gt;切换到第三个数据库</p>
<h5 id="2-查看所有的key"><a href="#2-查看所有的key" class="headerlink" title="2.查看所有的key"></a>2.查看所有的key</h5><p>keys *</p>
<p>3.<strong>清空当前数据库</strong>/<strong>所有数据库</strong></p>
<p>flushdb/flushall</p>
<p>4.redis是单线程，基于内存，cpu不是性能瓶颈，瓶颈是根据机器的内存，和网络带宽。</p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><p>exists key 判断key是否存在，存在1，不存在0</p>
<p>del key 移除当前key</p>
<p>move key  index    移动除当前key到index库</p>
<p>expire key 10 设置10s中key过期</p>
<p>ttl key 查看剩余过期时间</p>
<p>set key value 设置key-value</p>
<p>get key 获取key对应的value</p>
<p>type key 查看key的类型</p>
<h1 id="五大数据类型"><a href="#五大数据类型" class="headerlink" title="五大数据类型"></a>五大数据类型</h1><h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>set key value         设置key-value</p>
<p>get key         获取key对应的value</p>
<p>append key “hello”         给key追加hello字符串并返回value长度</p>
<p>strlen key         查看key对应的value的长度</p>
<p>incr key    –key对应的value加1</p>
<p>decr key    –key对应的value减1</p>
<p>incrby key [index]    –key对应的value加[index]</p>
<p>decrby key [index]            key对应的value减[index]</p>
<p>getrange key 0 2   –输出key对应value的前三个字符</p>
<p>setrange key 1 xx     –替换key对应value，从下标为1开始替换</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210720105505722.png" alt="image-20210720105505722"></p>
<p>setex key 30 hello –创建key-value时就设置30s过期</p>
<p>setnx key value     –不存在的时候才设置值，key存在则设置不成功</p>
<p>mset k1 v1 k2 v2     –一次性设置多个key-value</p>
<p>mget k1 k2         –一次性获取多个值</p>
<p>msetnx k1 v1 k3 v3     –原子操作，要么都成功，要么都失败，因为已经有k1了，所以k3也没有设置成功</p>
<h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>set user {name:zhangsan,age:3}设置一个user对象，为json字符串保存对象</p>
<p>巧妙设计user:{id}:{filed} –&gt; filed–》属性 值(中间是空格)</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210720110740898.png" alt="image-20210720110740898"></p>
<p>getset key value     –先获取key，在set value（可以用来更新）</p>
<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>在redis中，可以用list实现队列，栈，阻塞队列</p>
<p>所有的list命令都是以l开头的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush list one 向list中插入1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush list two	向list中插入2</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush list three	 向list中插入3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1	获取list</span><br><span class="line">1) &quot;three&quot;</span><br><span class="line">2) &quot;two&quot;</span><br><span class="line">3) &quot;one&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; rpush list four 从右面插入值</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;three&quot;</span><br><span class="line">2) &quot;two&quot;</span><br><span class="line">3) &quot;one&quot;</span><br><span class="line">4) &quot;four&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one123&quot;</span><br><span class="line">2) &quot;one12&quot;</span><br><span class="line">3) &quot;one1&quot;</span><br><span class="line">4) &quot;one&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lpop list 移除列表的第一个元素</span><br><span class="line">&quot;one123&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one12&quot;</span><br><span class="line">2) &quot;one1&quot;</span><br><span class="line">3) &quot;one&quot;</span><br><span class="line">127.0.0.1:6379&gt; rpop list  移除列表的最后一个元素</span><br><span class="line">&quot;one&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one12&quot;</span><br><span class="line">2) &quot;one1&quot;</span><br><span class="line">127.0.0.1:6379&gt; lindex list 0 通过下标获取值</span><br><span class="line">&quot;one12&quot;</span><br><span class="line">127.0.0.1:6379&gt; llen list获取list长度</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one123&quot;list集合元素可重复</span><br><span class="line">2) &quot;one123&quot;</span><br><span class="line">3) &quot;one12&quot;</span><br><span class="line">4) &quot;one1&quot;</span><br><span class="line">5) &quot;one&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrem list 2 one123</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one12&quot;</span><br><span class="line">2) &quot;one1&quot;</span><br><span class="line">3)127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one12&quot;</span><br><span class="line">2) &quot;one1&quot;</span><br><span class="line">3) &quot;one&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one12&quot;</span><br><span class="line">2) &quot;one1&quot;</span><br><span class="line">3) &quot;one&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrem list 2 one12 从左删除2个</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;one1&quot;</span><br><span class="line">2) &quot;one&quot;&quot;one&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><h2 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h2><h1 id="三种特殊数据类型"><a href="#三种特殊数据类型" class="headerlink" title="三种特殊数据类型"></a>三种特殊数据类型</h1><h2 id="geospatial地理位置"><a href="#geospatial地理位置" class="headerlink" title="geospatial地理位置"></a>geospatial地理位置</h2><p>朋友的定位，附近的人，打车距离计算</p>
<p>可以查询测试数据：<a href="http://www.jsons.cn/lngcode/">http://www.jsons.cn/lngcode/</a></p>
<p>geoadd key value（经度，维度，名称）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd china:key 116.40 39.90 beijing</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:key 121.46 23.34 shanghai</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:key 115.43 17.23 chongqin</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:key 115.31 25.31 xian</span><br><span class="line">(integer) 1</span><br><span class="line">一般是通过java程序导入</span><br></pre></td></tr></table></figure>

<p>geopos key  value里的名称   —        获取指定城市的经度和维度</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:key beijing</span><br><span class="line">1) 1) &quot;116.39999896287918091&quot;</span><br><span class="line">   2) &quot;39.90000009167092543&quot;</span><br></pre></td></tr></table></figure>

<p>geodist：两个人之间的距离</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist china:key beijing shanghai km</span><br><span class="line">&quot;1902.3232&quot;</span><br></pre></td></tr></table></figure>

<p>georadius获取附近的人，通过半径查询</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">从china：key这个集合中获取经纬度为110 30 半径1000km附件的城市</span><br><span class="line">[withdist]：显示经纬度  [withcord count 2]：限制两个</span><br><span class="line">127.0.0.1:6379&gt; georadius china:key 110 30 1000 km [withdist] [withcord count 2]</span><br><span class="line">1) &quot;xian&quot;</span><br></pre></td></tr></table></figure>

<p>geohash </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash china:key beijing</span><br><span class="line">1) &quot;wx4fbxxfke0&quot;</span><br><span class="line">将二维的经纬度转换为一维的字符串</span><br></pre></td></tr></table></figure>

<p>georadiusbymember</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadiusbymember china:key beijing 10000 km</span><br><span class="line">1) &quot;chongqin&quot;</span><br><span class="line">2) &quot;xian&quot;</span><br><span class="line">3) &quot;shanghai&quot;</span><br><span class="line">4) &quot;beijing&quot;</span><br><span class="line">找出位于指定位置周围的内容--在北京10000km附近的城市</span><br></pre></td></tr></table></figure>

<h2 id="Bitmap位图场景详解"><a href="#Bitmap位图场景详解" class="headerlink" title="Bitmap位图场景详解"></a>Bitmap位图场景详解</h2><p>Hyperloglog基数统计</p>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>一次性，顺序性，排他性，没有隔离级别的概念</p>
<p>单条命令有原子性，事务不保证原子性</p>
<p>所有在命令中的事务，并没有直接被执行，只有发起执行命令才会执行Exec</p>
<p>·开启事务multi</p>
<p>·命令入队</p>
<p>·执行事务exec</p>
<p>·取消事务discard，事务中的命令都不会被执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379(TX)&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; get k2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) &quot;v2&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译型异常（代码有问题，命令有错误），所有命令都不会执行</p>
<p>运行时异常（语法问题，eg：1/0），正确的命令会被执行</p>
<h1 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h1><p>悲观锁：什么时候都会出问题，无论做什么都会加锁，影响性能，比如syncgicsed，用完释放锁</p>
<p>乐观锁：认为什么时候都不会出现问题，更新数据的时候判断下在此期间，是否有人修改过这个数据</p>
<p>获取version</p>
<p>更新的时候比较version</p>
<p>redis监事测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set out 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money  监视money对象</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) (integer) 80</span><br><span class="line">2) (integer) 20</span><br><span class="line">事务正常执行成功后，监控会自动取消</span><br><span class="line"></span><br><span class="line">线程1：</span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 10</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 10</span><br><span class="line">QUEUED</span><br><span class="line">等线程2执行后，执行此步</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">(nil)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">线程2：</span><br><span class="line">127.0.0.1:6379&gt; get money</span><br><span class="line">&quot;80&quot;</span><br><span class="line">127.0.0.1:6379&gt; set money 100</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">当一个线程事务还没执行，另一个线程修改了数据，事务就会失败，会比较两个线程money的watch的version，一样成功，不一样说明修改了数据，就会失败，需要再次watch key重新监控</span><br></pre></td></tr></table></figure>

<h1 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h1><p>使用java操作，是redis官方推荐的java开发工具</p>
<h2 id="1-导包"><a href="#1-导包" class="headerlink" title="1.导包"></a>1.导包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--导入jedis包--&gt;</span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;redis.clients&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jedis&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-连接数据库"><a href="#2-连接数据库" class="headerlink" title="2.连接数据库"></a>2.连接数据库</h2><p>修改宝塔redis的ip为服务器的内网ip，然后设置密码，代码里写的是服务器的公网ip</p>
<p>内网查看：ifconfig -a–&gt;172.21.90.183</p>
<p>公网查看：curl icanhazip.com–&gt;123.56.107.125</p>
<p>改变ip以后，linux连接命令为    redis-cli -h 172.21.90.183 -p 6379 -a jiang</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.新建jedis对象</span></span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;123.56.107.125&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;jiang&quot;</span>);</span><br><span class="line">        System.out.println(jedis.ping());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-操作命令"><a href="#3-操作命令" class="headerlink" title="3.操作命令"></a>3.操作命令</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.新建jedis对象</span></span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;123.56.107.125&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;jiang&quot;</span>);</span><br><span class="line">        System.out.println(jedis.ping());</span><br><span class="line">        System.out.println(<span class="string">&quot;清空数据库：&quot;</span>+jedis.flushDB());</span><br><span class="line">        System.out.println(<span class="string">&quot;判断某个键是否存在：&quot;</span>+jedis.exists(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;新增&lt;&#x27;k1&#x27;,&#x27;v1&#x27;&gt;键值对：&quot;</span>+jedis.set(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;v1&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;新增&lt;&#x27;k2&#x27;,&#x27;v2&#x27;&gt;键值对：&quot;</span>+jedis.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;系统中所有的键如下：&quot;</span>);</span><br><span class="line">        Set&lt;String&gt; keys = jedis.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        System.out.println(keys);</span><br><span class="line">        System.out.println(<span class="string">&quot;删除键k2：&quot;</span>+jedis.del(<span class="string">&quot;k2&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;判断键k2是否存在：&quot;</span>+jedis.exists(<span class="string">&quot;k2&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;查看键 k1 所存储的数据类型：&quot;</span>+jedis.type(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;随机返回 key 空间的一个：&quot;</span>+jedis.randomKey());</span><br><span class="line">        System.out.println(<span class="string">&quot;重命名 key ：&quot;</span>+jedis.rename(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;newk1&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;取出改后的 newk1 ：&quot;</span>+jedis.get(<span class="string">&quot;newk1&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;按索引查询：&quot;</span>+jedis.select(<span class="number">0</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;删除当前选择数据库中的所有键：&quot;</span>+jedis.flushDB());</span><br><span class="line">        System.out.println(<span class="string">&quot;返回当前数据库中 key 的数量：&quot;</span>+jedis.dbSize());</span><br><span class="line">        System.out.println(<span class="string">&quot;删除所有数据库中的所有 key ：&quot;</span>+jedis.flushAll());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-事务"><a href="#4-事务" class="headerlink" title="4.事务"></a>4.事务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    //1.新建jedis对象</span><br><span class="line">    Jedis jedis = new Jedis(&quot;123.56.107.125&quot;, 6379);</span><br><span class="line">    jedis.auth(&quot;jiang&quot;);</span><br><span class="line">    //开启事务</span><br><span class="line">    Transaction multi = jedis.multi();</span><br><span class="line">    JSONObject jsonObject = new JSONObject();</span><br><span class="line">    jsonObject.put(&quot;hello&quot;,&quot;world&quot;);</span><br><span class="line">    jsonObject.put(&quot;name&quot;,&quot;kuangshen&quot;);</span><br><span class="line">    String str = jsonObject.toJSONString();</span><br><span class="line">    //jedis.watch();监控</span><br><span class="line">    //ctrl+alt+t  快速try catch</span><br><span class="line">    try &#123;</span><br><span class="line">        multi.set(&quot;user&quot;,str);</span><br><span class="line">        multi.exec();</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        multi.discard();//放弃事务</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        System.out.println(jedis.get(&quot;user&quot;));</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-断开连接"><a href="#5-断开连接" class="headerlink" title="5.断开连接"></a>5.断开连接</h2><p>jedis.close();</p>
<h1 id="springboot整合"><a href="#springboot整合" class="headerlink" title="springboot整合"></a>springboot整合</h1><h2 id="1-导包-1"><a href="#1-导包-1" class="headerlink" title="1.导包"></a>1.导包</h2><p>在springboot2.x以后，原来使用的jedis被替换成了lettuce</p>
<p>jedis：采用直连，多个线程操作不安全，避免需要使用连接池</p>
<p>lettuce：netty高性能的网络框架，实例可以在多个线程中共享，不存在线程不安全的情况</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-redis --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.5</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-底层"><a href="#2-底层" class="headerlink" title="2.底层"></a>2.底层</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210720174535417.png" alt="image-20210720174535417"></p>
<p>找到autoconfigure–》spring.factories–》搜索redis–》找到</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210720174619458.png" alt="image-20210720174619458"></p>
<p>RedisAutoConfiguration并ctrl进入</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210720174659899.png" alt="image-20210720174659899"></p>
<p>找到RedisProperties.class进入，下方代码不用管</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(//没有bean的话使用，有的话替换，可以自己定义一个替换默认的</span></span><br><span class="line"><span class="meta">        name = &#123;&quot;redisTemplate&quot;&#125;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//默认没有过多的设置，redis对象都需要序列化！！</span></span><br><span class="line">        <span class="comment">//两个泛型都是object，后面使用需要强制转换&lt;string,object&gt;</span></span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//因为string是redis常常使用的类型，所以说单独提出来一个bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-配置"><a href="#3-配置" class="headerlink" title="3.配置"></a>3.配置</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    host: <span class="number">123.56</span><span class="number">.107</span><span class="number">.125</span></span><br><span class="line">    port: <span class="number">6379</span></span><br><span class="line">    password: jiang</span><br></pre></td></tr></table></figure>

<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//opsForValue操作字符串，类似String</span></span><br><span class="line">        <span class="comment">//opsForList操作list，类似list</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//除了基本的操作，常用的方法可以直接用redisTemplate使用</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-序列化-自定义RedisTemplate"><a href="#5-序列化-自定义RedisTemplate" class="headerlink" title="5.序列化-自定义RedisTemplate"></a>5.序列化-自定义RedisTemplate</h2><p>当implements Serializable时 默认使用jdk序列化，我们应该使用json序列化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.test.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/04/11  16:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">	<span class="comment">//编写自己的redisTemplate</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//开发中一般都是直接定义&lt;String, Object&gt;</span></span><br><span class="line">		RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate();</span><br><span class="line">		template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">		<span class="comment">//序列化配置</span></span><br><span class="line">		Jackson2JsonRedisSerializer objectJackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">		ObjectMapper om=<span class="keyword">new</span> ObjectMapper();</span><br><span class="line">		om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">		om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">		objectJackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">		<span class="comment">//string的序列化</span></span><br><span class="line">		StringRedisSerializer stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">		<span class="comment">//key采用string的序列化方式</span></span><br><span class="line">		template.setKeySerializer(stringRedisSerializer);</span><br><span class="line">		<span class="comment">//hash的key采用string的序列化方式</span></span><br><span class="line">		template.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">		<span class="comment">//value采用jackson</span></span><br><span class="line">		template.setValueSerializer(objectJackson2JsonRedisSerializer);</span><br><span class="line">		<span class="comment">///hash的value采用jackson</span></span><br><span class="line">		template.setHashValueSerializer(objectJackson2JsonRedisSerializer);</span><br><span class="line">		template.afterPropertiesSet();</span><br><span class="line">		<span class="keyword">return</span> template;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="6-自定义RedisUtil"><a href="#6-自定义RedisUtil" class="headerlink" title="6.自定义RedisUtil"></a>6.自定义RedisUtil</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.test.util;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/07/21  9:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:注意一定要加<span class="doctag">@Component</span>注解，因为需要扫描里面的redisTemplate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisUtil</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="comment">// =============================common============================</span></span><br><span class="line">    <span class="comment">/** 指定缓存失效时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">expire</span><span class="params">(String key, <span class="keyword">long</span> time)</span> </span>&#123; <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            redisTemplate.expire(key, time, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*** 根据key 获取过期时间</span></span><br><span class="line"><span class="comment">     *  * <span class="doctag">@param</span> key 键 不能为null</span></span><br><span class="line"><span class="comment">     *  * <span class="doctag">@return</span> 时间(秒) 返回0代表为永久有效</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getExpire</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.getExpire(key, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*** 判断key是否存在</span></span><br><span class="line"><span class="comment">     * * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.hasKey(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*** 删除缓存</span></span><br><span class="line"><span class="comment">     *  * <span class="doctag">@param</span> key 可以传一个值 或多个</span></span><br><span class="line"><span class="comment">     *  */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(String... key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key != <span class="keyword">null</span> &amp;&amp; key.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key.length == <span class="number">1</span>) &#123;</span><br><span class="line">                redisTemplate.delete(key[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                redisTemplate.delete(CollectionUtils.arrayToList(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ============================String=============================</span></span><br><span class="line">     <span class="comment">/*** 普通缓存获取</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 值 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> key == <span class="keyword">null</span> ? <span class="keyword">null</span> : redisTemplate.opsForValue().get(key);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 普通缓存放入</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@return</span> true成功 false失败</span></span><br><span class="line"><span class="comment">      * */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForValue().set(key, value);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 普通缓存放入并设置时间</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@param</span> time 时间(秒) time要大于0 如果time小于等于0 将设置无限期</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@return</span> true成功 false 失败 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                 redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 set(key, value);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 递增</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> delta 要增加几(大于0)</span></span><br><span class="line"><span class="comment">      * */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">incr</span><span class="params">(String key, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;递增因子必须大于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, delta);</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">/*** 递减</span></span><br><span class="line"><span class="comment">     * * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * * <span class="doctag">@param</span> delta 要减少几(小于0) */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">decr</span><span class="params">(String key, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;递减因子必须大于0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, -delta);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ================================Map=================================</span></span><br><span class="line">     <span class="comment">/*** HashGet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> Object <span class="title">hget</span><span class="params">(String key, String item)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> redisTemplate.opsForHash().get(key, item);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 获取hashKey对应的所有键值</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@return</span> 对应的多个键值 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">hmget</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** HashSet</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> map 对应多个键值 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** HashSet 并设置时间</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@param</span> map 对应多个键值</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">      *  * <span class="doctag">@return</span> true成功 false失败 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">             <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                 expire(key, time);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@return</span> true 成功 false失败 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hset</span><span class="params">(String key, String item, Object value)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> time 时间(秒) 注意:如果已存在的hash表有时间,这里将会替换原有的时间</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@return</span> true 成功 false失败 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hset</span><span class="params">(String key, String item, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">             <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                 expire(key, time);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 删除hash表中的值</span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键 不能为null*</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> item 项 可以使多个 不能为null */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hdel</span><span class="params">(String key, Object... item)</span> </span>&#123;</span><br><span class="line">         redisTemplate.opsForHash().delete(key, item);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 判断hash表中是否有该项的值</span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键 不能为null</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@return</span> true 存在 false不存在 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hHasKey</span><span class="params">(String key, String item)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> redisTemplate.opsForHash().hasKey(key, item);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** hash递增 如果不存在,就会创建一个 并把新增后的值返回</span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> by 要增加几(大于0) */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">hincr</span><span class="params">(String key, String item, <span class="keyword">double</span> by)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, by);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** hash递减</span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> by 要减少记(小于0) */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">hdecr</span><span class="params">(String key, String item, <span class="keyword">double</span> by)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, -by);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// ============================set=============================</span></span><br><span class="line">     <span class="comment">/*** 根据key获取Set中的所有值</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> key 键 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">sGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> redisTemplate.opsForSet().members(key);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;<span class="comment">/*** 根据value从一个set中查询,是否存在</span></span><br><span class="line"><span class="comment">     ** <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值 *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sHasKey</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> redisTemplate.opsForSet().isMember(key, value);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 将数据放入set缓存</span></span><br><span class="line"><span class="comment">     ** <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> values 值 可以是多个 *</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span> 成功个数 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sSet</span><span class="params">(String key, Object... values)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 将set数据放入缓存</span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@return</span> 成功个数 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sSetAndTime</span><span class="params">(String key, <span class="keyword">long</span> time, Object... values)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             Long count = redisTemplate.opsForSet().add(key, values);</span><br><span class="line">             <span class="keyword">if</span> (time &gt; <span class="number">0</span>) expire(key, time); <span class="keyword">return</span> count;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 获取set缓存的长度**</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> key 键 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sGetSetSize</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> redisTemplate.opsForSet().size(key);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 移除值为value的 **</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> values 值 可以是多个 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@return</span> 移除的个数 */</span> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">setRemove</span><span class="params">(String key, Object... values)</span> </span>&#123; </span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             Long count = redisTemplate.opsForSet().remove(key, values);</span><br><span class="line">             <span class="keyword">return</span> count; </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">         &#125; </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// ===============================list================================= </span></span><br><span class="line">     <span class="comment">/*** 获取list缓存的内容 </span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> key 键 </span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> start 开始 </span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> end 结束 0 到 -1代表所有值 */</span> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">lGet</span><span class="params">(String key, <span class="keyword">long</span> start, <span class="keyword">long</span> end)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> redisTemplate.opsForList().range(key, start, end); </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125; </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 获取list缓存的长度 **</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> key 键 */</span> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lGetListSize</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> redisTemplate.opsForList().size(key);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">         &#125; </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 通过索引 获取list中的值 **</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> index 索引 index&gt;=0时， 0 表头，1 第二个元素，依次类推；index&lt;0 时，-1，表尾，-2倒数第二个元素，依次类推 */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> Object <span class="title">lGetIndex</span><span class="params">(String key, <span class="keyword">long</span> index)</span> </span>&#123; </span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> redisTemplate.opsForList().index(key, index); </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 将list放入缓存 **</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> value 值 */</span> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForList().rightPush(key, value); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125; </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 将list放入缓存 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> value 值 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> time 时间(秒) */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">             <span class="keyword">if</span> (time &gt; <span class="number">0</span>) expire(key, time); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>; </span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 将list放入缓存 **</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> value 值 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@return</span> */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, List&lt;Object&gt; value)</span> </span>&#123; </span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>; </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125; </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 将list放入缓存 *</span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> value 值 *</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> time 时间(秒) *</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span> */</span> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, List&lt;Object&gt; value, <span class="keyword">long</span> time)</span> </span>&#123; </span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">             <span class="keyword">if</span> (time &gt; <span class="number">0</span>) expire(key, time); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>; </span><br><span class="line">         &#125; </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 根据索引修改list中的某条数据 **</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> key 键 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> index 索引 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@param</span> value 值 *</span></span><br><span class="line"><span class="comment">      *  <span class="doctag">@return</span> */</span> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lUpdateIndex</span><span class="params">(String key, <span class="keyword">long</span> index, Object value)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             redisTemplate.opsForList().set(key, index, value);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>; </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">             e.printStackTrace(); </span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125; </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/*** 移除N个值为value </span></span><br><span class="line"><span class="comment">      * ** <span class="doctag">@param</span> key 键 </span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> count 移除多少个 </span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@param</span> value 值 </span></span><br><span class="line"><span class="comment">      * * <span class="doctag">@return</span> 移除的个数 */</span> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lRemove</span><span class="params">(String key, <span class="keyword">long</span> count, Object value)</span> </span>&#123; </span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             Long remove = redisTemplate.opsForList().remove(key, count, value); </span><br><span class="line">             <span class="keyword">return</span> remove; </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">         &#125;</span><br><span class="line">     &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-测试"><a href="#7-测试" class="headerlink" title="7.测试"></a>7.测试</h2><p><img src="/../img/image-20220411170815350.png" alt="image-20220411170815350"></p>
<h1 id="redisconfig的配置详解"><a href="#redisconfig的配置详解" class="headerlink" title="redisconfig的配置详解"></a>redisconfig的配置详解</h1><p>看pdf</p>
<h1 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h1><p>看pdf</p>
<h1 id="Redis发布订阅"><a href="#Redis发布订阅" class="headerlink" title="Redis发布订阅"></a>Redis发布订阅</h1><p>看pdf</p>
<h1 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>只配置从库，不用配置主库，redis默认自己本身就是主库</p>
<p>1.启动redis服务</p>
<p>/usr/local/bin目录下</p>
<p>redis-server myconfig/redis.conf</p>
<p>2.redis-cli -p 6379 以端口号6379启动客户端</p>
<p>改变ip以后，linux连接命令为    redis-cli -h 172.21.90.183 -p 6379 -a jiang</p>
<p>-h(ip地址，不是外网地址) -a(密码)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">172.21.90.183:6379&gt; info replication <span class="comment">#查看库信息</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master		<span class="comment">#角色</span></span><br><span class="line">connected_slaves:0		<span class="comment">#没有从机</span></span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:8e8a164a81ae7a312f3db3e39343c05d08737639</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="缓存穿透和雪崩"><a href="#缓存穿透和雪崩" class="headerlink" title="缓存穿透和雪崩"></a>缓存穿透和雪崩</h1><p>看pdf</p>
<h1 id="公司使用"><a href="#公司使用" class="headerlink" title="公司使用"></a>公司使用</h1><p>可以写一个工具类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private static RedisComplexClient redisClient = null;</span><br><span class="line"></span><br><span class="line">private RedisComplexClient getRedisClient() &#123;</span><br><span class="line">    if (redisClient == null) &#123;</span><br><span class="line">        redisClient = new RedisComplexClient(Object.class);</span><br><span class="line">    &#125;</span><br><span class="line">    return redisClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>多线程</title>
    <url>/2021/11/30/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BB%A5%E5%8F%8A%E7%BA%BF%E7%A8%8B%E7%9B%91%E5%90%AC/</url>
    <content><![CDATA[<h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><h2 id="1-继承Thread类（它也实现了Runnable接口）"><a href="#1-继承Thread类（它也实现了Runnable接口）" class="headerlink" title="1.继承Thread类（它也实现了Runnable接口）"></a>1.继承Thread类（它也实现了Runnable接口）</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;我在看代码--&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主线程main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建线程对象</span></span><br><span class="line">        B b=<span class="keyword">new</span> B();</span><br><span class="line">        b.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;主线程--&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="同步下载图片例子"><a href="#同步下载图片例子" class="headerlink" title="同步下载图片例子"></a>同步下载图片例子</h3><p>org.apache.commons.io.FileUtils  阿帕奇的图片下载工具包</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    String url;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(String url, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            DownLoad downLoad=<span class="keyword">new</span> DownLoad();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            downLoad.Down(url,name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主线程main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建线程对象</span></span><br><span class="line">        B b1=<span class="keyword">new</span> B(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;a.png&quot;</span>);</span><br><span class="line">        B b2=<span class="keyword">new</span> B(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;b.png&quot;</span>);</span><br><span class="line">        B b3=<span class="keyword">new</span> B(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;c.png&quot;</span>);</span><br><span class="line">        b1.start();</span><br><span class="line">        b2.start();</span><br><span class="line">        b3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//下载器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Down</span><span class="params">(String url,String name)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        FileUtils.copyURLToFile(<span class="keyword">new</span> URL(url),<span class="keyword">new</span> File(name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-实现Runnable接口-建议使用"><a href="#2-实现Runnable接口-建议使用" class="headerlink" title="2.实现Runnable接口(建议使用)"></a>2.实现Runnable接口(建议使用)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">模板：new Thread().start();</span><br></pre></td></tr></table></figure>

<h3 id="同步下载图片例子-1"><a href="#同步下载图片例子-1" class="headerlink" title="同步下载图片例子"></a>同步下载图片例子</h3><p>org.apache.commons.io.FileUtils  阿帕奇的图片下载工具包</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;我在看代码--&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主线程main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建实现类对象</span></span><br><span class="line">        B b=<span class="keyword">new</span> B();</span><br><span class="line">        <span class="comment">//创建线程对象，代理</span></span><br><span class="line">        <span class="keyword">new</span> Thread(b).start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;主线程--&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    String url;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(String url, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DownLoad downLoad=<span class="keyword">new</span> DownLoad();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            downLoad.Down(url,name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主线程main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建线程对象</span></span><br><span class="line">        B b1=<span class="keyword">new</span> B(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;a.png&quot;</span>);</span><br><span class="line">        B b2=<span class="keyword">new</span> B(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;b.png&quot;</span>);</span><br><span class="line">        B b3=<span class="keyword">new</span> B(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;c.png&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(b1).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(b2).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(b3).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//下载器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Down</span><span class="params">(String url,String name)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        FileUtils.copyURLToFile(<span class="keyword">new</span> URL(url),<span class="keyword">new</span> File(name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-初识并发问题"><a href="#3-初识并发问题" class="headerlink" title="3.初识并发问题"></a>3.初识并发问题</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//多个线程操作同一个对象，买火车票例子</span></span><br><span class="line">    <span class="comment">//发现，线程不安全，数据乱</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticket=<span class="number">10</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(ticket&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Thread.currentThread().getName()可以获得当前线程的信息</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;--第&quot;</span>+ticket+<span class="string">&quot;张票&quot;</span>);</span><br><span class="line">            ticket--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个线程对象</span></span><br><span class="line">        B b=<span class="keyword">new</span> B();</span><br><span class="line">        <span class="comment">//开启三个线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(b,<span class="string">&quot;a1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(b,<span class="string">&quot;a2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(b,<span class="string">&quot;a3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="龟兔赛跑"><a href="#龟兔赛跑" class="headerlink" title="龟兔赛跑"></a>龟兔赛跑</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//龟兔赛跑</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String winner;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=<span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> flag=gameOver(i);</span><br><span class="line">            <span class="keyword">if</span> (flag==<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;跑了&quot;</span>+i+<span class="string">&quot;步&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断是否完成比赛</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">gameOver</span><span class="params">(<span class="keyword">int</span> step)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(winner!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(step==<span class="number">10</span>)&#123;</span><br><span class="line">            <span class="comment">//查看胜利者是乌龟还是兔子</span></span><br><span class="line">            winner=Thread.currentThread().getName();</span><br><span class="line">            System.out.println(<span class="string">&quot;winner is&quot;</span>+winner);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        C c=<span class="keyword">new</span> C();</span><br><span class="line">       <span class="keyword">new</span> Thread(c,<span class="string">&quot;兔子&quot;</span>).start();</span><br><span class="line">       <span class="keyword">new</span> Thread(c,<span class="string">&quot;乌龟&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Callable接口"><a href="#4-Callable接口" class="headerlink" title="4.Callable接口"></a>4.Callable接口</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//有返回值</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Callable</span> </span>&#123;</span><br><span class="line">    String url;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(String url, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主线程main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//创建线程对象</span></span><br><span class="line">        A b1=<span class="keyword">new</span> A(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;a.png&quot;</span>);</span><br><span class="line">        A b2=<span class="keyword">new</span> A(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;b.png&quot;</span>);</span><br><span class="line">        A b3=<span class="keyword">new</span> A(<span class="string">&quot;https://123p4.sogoucdn.com/imgu/2021/06/20210623151042_241.png&quot;</span>,<span class="string">&quot;c.png&quot;</span>);</span><br><span class="line">        <span class="comment">//创建执行服务:</span></span><br><span class="line">        ExecutorService ser= Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//提交执行</span></span><br><span class="line">        Future&lt;Boolean&gt; r1=ser.submit(b1);</span><br><span class="line">        Future&lt;Boolean&gt; r2=ser.submit(b2);</span><br><span class="line">        Future&lt;Boolean&gt; r3=ser.submit(b3);</span><br><span class="line">        <span class="comment">//获取结果</span></span><br><span class="line">        <span class="keyword">boolean</span> rs1=r1.get();</span><br><span class="line">        <span class="keyword">boolean</span> rs2=r2.get();</span><br><span class="line">        <span class="keyword">boolean</span> rs3=r3.get();</span><br><span class="line">        <span class="comment">//关闭服务</span></span><br><span class="line">        ser.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        DownLoad downLoad=<span class="keyword">new</span> DownLoad();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            downLoad.Down(url,name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//下载器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Down</span><span class="params">(String url,String name)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        FileUtils.copyURLToFile(<span class="keyword">new</span> URL(url),<span class="keyword">new</span> File(name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="尚硅谷，多线程"><a href="#尚硅谷，多线程" class="headerlink" title="尚硅谷，多线程"></a>尚硅谷，多线程</h2><h3 id="Volatile关键字"><a href="#Volatile关键字" class="headerlink" title="Volatile关键字"></a>Volatile关键字</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/09/10  14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestVolatile</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadDemo td=<span class="keyword">new</span> ThreadDemo();</span><br><span class="line">        <span class="keyword">new</span> Thread(td).start();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(td.isFlag())&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;=========&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//此线程在200毫秒后把flag变量变为true，然后主线程td.isFlag判断，按道理来说应该是打印====，</span></span><br><span class="line"><span class="comment">//但是结果发现一直运行，疑问？不是应该共享变量吗，为什么主线程的flag没有变呢？</span></span><br><span class="line"><span class="comment">//因为，jvm会为每一个线程，分配一个独立的缓存，共享变量不可见</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag=<span class="keyword">false</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">200</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        flag=<span class="keyword">true</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;flag为true了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/../img/image-20210910144837052.png" alt="image-20210910144837052"></p>
<p>1.共享数据flag在主存（可以理解为堆内存中）</p>
<p>2.线程1先从主存读取flag=false到自己的内存，然后在改值，把值写回到主存中</p>
<p>3.main线程也是从主存读取flag=false到自己的内存，然后一直while(true),在自己的内存中flag一直等于false</p>
<p><img src="/../img/image-20210910145815330.png" alt="image-20210910145815330"></p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><h4 id="1-加锁"><a href="#1-加锁" class="headerlink" title="1.加锁"></a>1.加锁</h4><p>以一个任意对象为锁</p>
<p><img src="/../img/image-20210910150152487.png" alt="image-20210910150152487"></p>
<p>推荐下图的加锁</p>
<p><img src="/../img/image-20210910150221542.png" alt="image-20210910150221542"></p>
<p>但是这样的话效率极低，每个线程都需要判断是否可以获取锁</p>
<h4 id="2-用volatile关键字"><a href="#2-用volatile关键字" class="headerlink" title="2.用volatile关键字"></a>2.用volatile关键字</h4><p>当多个线程进行操作共享数据时，可以保证内存中的数据可见</p>
<p>可以理解时时刻刻刷新每个线程的缓存，使与主存中的数据一致，每个变量都是在主存进行交互的，不是在各自的线程里</p>
<p><img src="/../img/image-20210910150746812.png" alt="image-20210910150746812"></p>
<p><img src="/../img/image-20210910150916536.png" alt="image-20210910150916536"></p>
<h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><p><img src="/../img/image-20210910151347593.png" alt="image-20210910151347593"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/09/10  14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestAtomic</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AtomicDemo ad=<span class="keyword">new</span> AtomicDemo();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(ad).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//正常应该打印0-9，但是发现不止一个0，发现不能保证原子性，</span></span><br><span class="line"><span class="comment">// 比如i++的操作，为先int temp=i，i=i+1,这应该是原子的不能分割的，</span></span><br><span class="line"><span class="comment">//但是在此程序中被分割了。</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AtomicDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> serialNumber=<span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">200</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(getSerialNumber());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSerialNumber</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialNumber++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/../img/image-20210910152502461.png" alt="image-20210910152502461"></p>
<h4 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h4><h5 id="1-原子变量"><a href="#1-原子变量" class="headerlink" title="1.原子变量"></a>1.原子变量</h5><p>既保证了内存可见性，又保证了数据的原子性</p>
<p><img src="/../img/image-20210910153150677.png" alt="image-20210910153150677"></p>
<p><img src="/../img/image-20210910153713862.png" alt="image-20210910153713862"></p>
<p><img src="/../img/image-20210910153945269.png" alt="image-20210910153945269"></p>
<h3 id="CAS算法模拟"><a href="#CAS算法模拟" class="headerlink" title="CAS算法模拟"></a>CAS算法模拟</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/09/10  14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCompareAndSwap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> CompareAndSwap cas=<span class="keyword">new</span> CompareAndSwap();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">int</span> expectedValue = cas.get();</span><br><span class="line">                    <span class="keyword">boolean</span> a=cas.compareAndSet(expectedValue,(<span class="keyword">int</span>)(Math.random()*<span class="number">101</span>));</span><br><span class="line">                    System.out.println(a);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompareAndSwap</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="comment">//获取</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//比较</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">compareAndSwap</span><span class="params">(<span class="keyword">int</span> expectedValue,<span class="keyword">int</span> newValue)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> oldValue=value;</span><br><span class="line">        <span class="keyword">if</span>(oldValue==expectedValue)&#123;</span><br><span class="line">            value=newValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> expectedValue,<span class="keyword">int</span> newValue)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expectedValue==compareAndSwap(expectedValue,newValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConcurrentHashMap锁分段机制"><a href="#ConcurrentHashMap锁分段机制" class="headerlink" title="ConcurrentHashMap锁分段机制"></a>ConcurrentHashMap锁分段机制</h3><p>hashmap线程不安全</p>
<p>hashtable线程安全，锁住整个hash表，效率极低</p>
<h2 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h2><p><a href="https://blog.csdn.net/weixin_40304387/article/details/80508236?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163149502516780274112604%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163149502516780274112604&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-80508236.first_rank_v2_pc_rank_v29&amp;utm_term=Executors&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/weixin_40304387/article/details/80508236?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163149502516780274112604%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163149502516780274112604&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-80508236.first_rank_v2_pc_rank_v29&amp;utm_term=Executors&amp;spm=1018.2226.3001.4187</a></p>
<h2 id="ExecutorService"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h2><p>Executor：一般来说，Runnable任务开辟在新线程中的使用方法为：new Thread(new RunnableTask())).start()，但在Executor中，可以使用Executor而不用显示地创建线程：Executor.execute(new RunnableTask()); // 异步执行</p>
<p>ExecutorService：是一个比Executor使用更广泛的子类接口，返回 Future 对象，可以调用ExecutorService的shutdown（）方法来关闭 ExecutorService，调用该方法后，将导致ExecutorService停止接受任何新的任务且等待已经提交的任务执行完成(已经提交的任务会分两类：一类是已经在执行的，另一类是还没有开始执行的)，当所有已经提交的任务执行完毕后将会关ExecutorService。因此我们一般用该接口来实现和管理多线程。</p>
<p>通过 ExecutorService.submit() 方法返回的 Future 对象，可以调用isDone（）方法查询Future是否已经完成。当任务完成时，它具有一个结果，你可以调用get()方法来获取该结果。你也可以不用isDone（）进行检查就直接调用get()获取结果，在这种情况下，get()将阻塞，直至结果准备就绪，还可以取消任务的执行。Future 提供了 cancel() 方法用来取消执行 pending 中的任务。</p>
<h2 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h2><p>Executors类： 主要用于提供线程池相关的操作<br>Executors类，提供了一系列工厂方法用于创建线程池，返回的线程池都实现了ExecutorService接口。</p>
<h4 id="1、public-static-ExecutorService-newFiexedThreadPool-int-Threads"><a href="#1、public-static-ExecutorService-newFiexedThreadPool-int-Threads" class="headerlink" title="1、public static ExecutorService newFiexedThreadPool(int Threads)"></a>1、public static ExecutorService newFiexedThreadPool(int Threads)</h4><p> 创建固定数目线程的线程池。</p>
<p>①-newFixedThreadPool与cacheThreadPool差不多，也是能就用，但不能随时建新的线程<br>其独特之处:任意时间点，最多只能有固定数目的活动线程存在，此时如果有新的线程要建立，只能放在另外的队列中等待，直到当前的线程中某个线程终止直接被移出池子<br>②-和cacheThreadPool不同，FixedThreadPool多数针对一些很稳定很固定的正规并发线程，多用于服务器<br>③-从方法的源代码看，cache池和fixed 池调用的是同一个底层 池，只不过参数不同:<br>fixed池线程数固定，并且是0秒超时<br>cache池线程数支持0-Integer.MAX_VALUE(显然完全没考虑主机的资源承受能力），60秒超时</p>
<h4 id="2、public-static-ExecutorService-newCachedThreadPool"><a href="#2、public-static-ExecutorService-newCachedThreadPool" class="headerlink" title="2、public static ExecutorService newCachedThreadPool()"></a>2、public static ExecutorService newCachedThreadPool()</h4><p>①创建一个可缓存的线程池，调用execute 将重用以前构造的线程（如果线程可用）。如果没有可用的线程，则创建一个新线程并添加到池中。终止并从缓存中移除那些已有 60 秒钟未被使用的线程。-缓存型池子，先查看池中有没有以前建立的线程，如果有，就 使用.如果没有，就建一个新的线程加入池中<br>②缓存型池子通常用于执行一些生存期很短的异步型任务<br> 因此在一些面向连接的服务中用得不多。但对于生存期短的异步任务，它是Executor的首选。<br>③能用的线程，必须是timeout 规定内的池中线程，缺省     timeout是60s,超过这个时长，线程实例将被终止及移出池。<br>④注意，放入CachedThreadPool的线程不必担心其结束，超过TIMEOUT不活动，其会自动被终止。</p>
<h4 id="3、public-static-ExecutorService-newSingleThreadExecutor"><a href="#3、public-static-ExecutorService-newSingleThreadExecutor" class="headerlink" title="3、public static ExecutorService newSingleThreadExecutor()"></a>3、public static ExecutorService newSingleThreadExecutor()</h4><p>创建一个单线程化的Executor。</p>
<p> -单例线程，任意时间池中只能有一个线程<br>-用的是和cache池和fixed池相同的底层池，但线程数目是1，0秒超时时长</p>
<h4 id="4、public-static-ScheduledExecutorService-newScheduledThreadPool-int-corePoolSize"><a href="#4、public-static-ScheduledExecutorService-newScheduledThreadPool-int-corePoolSize" class="headerlink" title="4、public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize)"></a>4、public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize)</h4><p>创建一个支持定时及周期性的任务执行的线程池，多数情况下可用来替代Timer类。</p>
<p>-调度型线程池<br>-这个池子里的线程可以按schedule依次delay执行，或周期执行</p>
<h2 id="Executor-和-ExecutorService-这两个接口主要的区别是"><a href="#Executor-和-ExecutorService-这两个接口主要的区别是" class="headerlink" title="Executor 和 ExecutorService 这两个接口主要的区别是"></a>Executor 和 ExecutorService 这两个接口主要的区别是</h2><p>①ExecutorService 接口继承了 Executor 接口，是 Executor 的子接口<br>②Executor 接口定义了 execute()方法用来接收一个Runnable接口的对象，而 ExecutorService 接口中的 submit()方法可以接受Runnable和Callable接口的对象。<br>③Executor 中的 execute() 方法不返回任何结果，而 ExecutorService 中的 submit()方法可以通过一个 Future 对象返回运算结果。<br>④除了允许客户端提交一个任务，ExecutorService 还提供用来控制线程池的方法。比如：调用 shutDown() 方法终止线程池。<br>⑤Executors 类提供工厂方法用来创建不同类型的线程池。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallableDemo</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//1.通过Executors类创建缓存型线程池，用ExecutorService接受，因为返回结果都实现了ExecutorService</span></span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//2.ExecutorService返回future对象</span></span><br><span class="line">        List&lt;Future&lt;String&gt;&gt; resultList = <span class="keyword">new</span> ArrayList&lt;Future&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建10个任务并执行</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">            <span class="comment">//3.使用ExecutorService执行Callable类型的任务，并将结果保存在future变量中</span></span><br><span class="line">            Future&lt;String&gt; future = executorService.submit(<span class="keyword">new</span> TaskWithResult(i));</span><br><span class="line">            <span class="comment">//将任务执行结果存储到List中</span></span><br><span class="line">            resultList.add(future);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历任务的结果</span></span><br><span class="line">        <span class="keyword">for</span> (Future&lt;String&gt; fs : resultList)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span>(!fs.isDone())&#123;&#125;;<span class="comment">//Future返回如果没有完成，则一直循环等待，直到Future返回完成</span></span><br><span class="line">                    System.out.println(fs.get());     <span class="comment">//打印各个线程（任务）执行的结果</span></span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(ExecutionException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                    <span class="comment">//启动一次顺序关闭，执行以前提交的任务，但不接受新任务</span></span><br><span class="line">                    executorService.shutdown();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskWithResult</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskWithResult</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务的具体过程，一旦任务传给ExecutorService的submit方法，</span></span><br><span class="line"><span class="comment">     * 则该方法自动在一个线程上执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//设置线程名字</span></span><br><span class="line">        Thread.currentThread().setName(<span class="string">&quot;线程&quot;</span>+id);</span><br><span class="line">        <span class="comment">//该返回结果将被Future的get方法得到</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;call()方法被自动调用，任务返回的结果是：&quot;</span> + id + <span class="string">&quot;    &quot;</span> + Thread.currentThread().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20210913153725913.png" alt="image-20210913153725913"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.multithread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/27  11:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">		ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//3.使用ExecutorService执行Callable类型的任务，并将结果保存在future变量中</span></span><br><span class="line">		Future&lt;String&gt; future = executorService.submit(<span class="keyword">new</span> MyTask(<span class="number">1</span>));</span><br><span class="line">		<span class="comment">//future.cancel(true);</span></span><br><span class="line">		String result = future.get();</span><br><span class="line">		System.out.println(result);</span><br><span class="line">		executorService.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyTask</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 任务的具体过程，一旦任务传给ExecutorService的submit方法，</span></span><br><span class="line"><span class="comment">	 * 则该方法自动在一个线程上执行</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//设置线程名字</span></span><br><span class="line">		Thread.currentThread().setName(<span class="string">&quot;线程&quot;</span>+id);</span><br><span class="line"><span class="comment">//        System.out.println(&quot;call()方法被自动调用！！！    &quot; + Thread.currentThread().getName());</span></span><br><span class="line">		<span class="comment">//该返回结果将被Future的get方法得到</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;call()方法被自动调用，任务返回的结果是：&quot;</span> + id + <span class="string">&quot;    &quot;</span> + Thread.currentThread().getName();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="自定义线程池"><a href="#自定义线程池" class="headerlink" title="自定义线程池"></a>自定义线程池</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolTest</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//创建等待队列</span></span><br><span class="line">        BlockingQueue&lt;Runnable&gt; bqueue = <span class="keyword">new</span> ArrayBlockingQueue&lt;Runnable&gt;(<span class="number">20</span>);</span><br><span class="line">        <span class="comment">//创建线程池，池中保存的线程数为3，允许的最大线程数为5</span></span><br><span class="line">        ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">3</span>,<span class="number">5</span>,<span class="number">50</span>, TimeUnit.MILLISECONDS,bqueue);</span><br><span class="line">        <span class="comment">//创建七个任务</span></span><br><span class="line">        Runnable t1 = <span class="keyword">new</span> MyThread();</span><br><span class="line">        Runnable t2 = <span class="keyword">new</span> MyThread();</span><br><span class="line">        Runnable t3 = <span class="keyword">new</span> MyThread();</span><br><span class="line">        Runnable t4 = <span class="keyword">new</span> MyThread();</span><br><span class="line">        Runnable t5 = <span class="keyword">new</span> MyThread();</span><br><span class="line">        Runnable t6 = <span class="keyword">new</span> MyThread();</span><br><span class="line">        Runnable t7 = <span class="keyword">new</span> MyThread();</span><br><span class="line">        <span class="comment">//每个任务会在一个线程上执行</span></span><br><span class="line">        pool.execute(t1);</span><br><span class="line">        pool.execute(t2);</span><br><span class="line">        pool.execute(t3);</span><br><span class="line">        pool.execute(t4);</span><br><span class="line">        pool.execute(t5);</span><br><span class="line">        pool.execute(t6);</span><br><span class="line">        pool.execute(t7);</span><br><span class="line">        <span class="comment">//关闭线程池</span></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;正在执行。。。&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20210913153700073.png" alt="image-20210913153700073"></p>
<p>发现只有三个线程在使用！</p>
<p>ThreadPoolExecuror类的构造方法中各个参数的含义</p>
<p>public ThreadPoolExecutor (int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit,BlockingQueue<Runnable> workQueue)</Runnable></p>
<p>corePoolSize：线程池中所保存的核心线程数，包括空闲线程。</p>
<p>maximumPoolSize：池中允许的最大线程数。</p>
<p>keepAliveTime：线程池中的空闲线程所能持续的最长时间。</p>
<p>unit：持续时间的单位。</p>
<p>workQueue：任务执行前保存任务的队列，仅保存由execute方法提交的Runnable任务。</p>
<p>1、如果线程池中的线程数量少于corePoolSize，即使线程池中有空闲线程，也会创建一个新的线程来执行新添加的任务；<br>    2、如果线程池中的线程数量大于等于corePoolSize，但缓冲队列workQueue未满，则将新添加的任务放到workQueue中，按照FIFO的原则依次等待执行（线程池中有线程空闲出来后依次将缓冲队列中的任务交付给空闲的线程执行）；</p>
<p>   3、如果线程池中的线程数量大于等于corePoolSize，且缓冲队列workQueue已满，但线程池中的线程数量小于maximumPoolSize，则会创建新的线程来处理被添加的任务；</p>
<pre><code>总结起来，也即是说，当有新的任务要处理时，先看线程池中的线程数量是否大于corePoolSize，再看缓冲队列workQueue是否满，最后看线程池中的线程数量是否大于maximumPoolSize。
</code></pre>
<h1 id="多线程监听"><a href="#多线程监听" class="headerlink" title="多线程监听"></a>多线程监听</h1><p>一个继承Callable的多线程类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line">public class TestThread implements Callable&lt;String&gt; &#123;</span><br><span class="line">@Override</span><br><span class="line">public String call() &#123;</span><br><span class="line">   System.out.println(System.currentTimeMillis() + &quot;进来了&quot; + this.hashCode());</span><br><span class="line"></span><br><span class="line">   try &#123;</span><br><span class="line">      Thread.sleep(5000);</span><br><span class="line">   &#125; catch (InterruptedException e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">   return System.currentTimeMillis() + &quot;出来了&quot; + this.hashCode();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20211227124033425.png" alt="image-20211227124033425"></p>
<h2 id="监听单线程超时"><a href="#监听单线程超时" class="headerlink" title="监听单线程超时"></a>监听单线程超时</h2><p>调用get方式是一个阻塞方法，不能在多线程中使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	FutureTask&lt;String&gt; task = <span class="keyword">new</span> FutureTask&lt;String&gt;(<span class="keyword">new</span> TestThread());</span><br><span class="line">	<span class="keyword">new</span> Thread(task).start();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//3000就是超时时间</span></span><br><span class="line">		String result = task.get(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">		System.out.println(result);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;线程已经停止了&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">		System.out.println(System.currentTimeMillis() + <span class="string">&quot;线程超时了，打死他&quot;</span>);</span><br><span class="line">		task.cancel(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来看看控制台的输出</p>
<p>1524559858691进来了1893883033<br>1524559861691线程超时了，打死他</p>
<h2 id="监听多线程超时"><a href="#监听多线程超时" class="headerlink" title="监听多线程超时"></a>监听多线程超时</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.multithread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.FutureTask;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//线程池</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService pool = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      FutureTask&lt;String&gt; task = <span class="keyword">new</span> FutureTask&lt;String&gt;(<span class="keyword">new</span> TestThread());</span><br><span class="line">      <span class="keyword">new</span> Thread(task).start();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">      <span class="keyword">while</span> (!task.isDone()) &#123;<span class="comment">//关键在这</span></span><br><span class="line">         <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">         <span class="keyword">if</span> ((now - start) &gt;= <span class="number">3000</span>) &#123;<span class="comment">//超时时间3000毫秒</span></span><br><span class="line">            task.cancel(<span class="keyword">true</span>);</span><br><span class="line">            System.out.println(System.currentTimeMillis() + <span class="string">&quot;线程超时了，打死他&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5</span>);<span class="comment">//记得加个sleep，不然搞坏你cpu</span></span><br><span class="line">         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">         pool.execute(<span class="keyword">new</span> Main());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ListeningExecutorService的使用"><a href="#ListeningExecutorService的使用" class="headerlink" title="ListeningExecutorService的使用"></a>ListeningExecutorService的使用</h2><p>监听缓存池，时间到了自动执行一个方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.multithread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.cache.CacheUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.cache.impl.TimedCache;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.thread.ThreadUtil;</span><br><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.MessageFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/22  13:33</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:hutool时间缓存时间到了以后，监听可以自动做事</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimedCacheUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间缓存，默认5s过期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TimedCache&lt;String, String&gt; TIMED_CACHE = CacheUtil.newTimedCache(<span class="number">5000</span>);</span><br><span class="line">  <span class="comment">/** 线程池 */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听类，监听线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ListeningExecutorService listeningExecutorService =</span><br><span class="line">      MoreExecutors.listeningDecorator(executorService);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存入键值对，添加过期时间，和消费回调</span></span><br><span class="line"><span class="comment">     * consumer是java8的一个类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> consumer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, String value, Long timeout, Consumer&lt;String&gt; consumer)</span> </span>&#123;</span><br><span class="line">        TIMED_CACHE.put(key, value, timeout);</span><br><span class="line">        addListen(key, consumer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取缓存值</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> TIMED_CACHE.get(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 删除缓存</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    TIMED_CACHE.remove(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 添加监听器</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> consumer</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addListen</span><span class="params">(String key, Consumer&lt;String&gt; consumer)</span> </span>&#123;</span><br><span class="line">    ListenableFuture&lt;String&gt; listenableFuture =</span><br><span class="line">        listeningExecutorService.submit(</span><br><span class="line">            () -&gt; &#123;</span><br><span class="line">              <span class="keyword">while</span> (TIMED_CACHE.containsKey(key)) &#123;</span><br><span class="line">                ThreadUtil.sleep(<span class="number">500</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> key;</span><br><span class="line">            &#125;);</span><br><span class="line">    Futures.addCallback(</span><br><span class="line">        listenableFuture,</span><br><span class="line">        <span class="keyword">new</span> FutureCallback&lt;String&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(<span class="meta">@Nullable</span> String s)</span> </span>&#123;</span><br><span class="line">            consumer.accept(s);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        listeningExecutorService);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    put(<span class="string">&quot;haha&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">3000L</span>, x -&gt; System.out.println(MessageFormat.format(<span class="string">&quot;[&#123;0&#125;] - 缓存消逝&quot;</span>, x)));</span><br><span class="line">    ThreadUtil.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(get(<span class="string">&quot;haha&quot;</span>));</span><br><span class="line">    ThreadUtil.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(get(<span class="string">&quot;haha&quot;</span>));</span><br><span class="line">    ThreadUtil.sleep(<span class="number">5000</span>);</span><br><span class="line">    System.out.println(get(<span class="string">&quot;haha&quot;</span>));</span><br><span class="line">    <span class="comment">// 关闭监听线程池</span></span><br><span class="line">    listeningExecutorService.shutdown();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="CountDownLatch使用"><a href="#CountDownLatch使用" class="headerlink" title="CountDownLatch使用"></a>CountDownLatch使用</h1><h2 id="1、类介绍"><a href="#1、类介绍" class="headerlink" title="1、类介绍"></a>1、类介绍</h2><p>一个同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许一个或多个线程一直等待。用给定的计数 初始化 CountDownLatch。由于调用了 countDown() 方法，所以在当前计数到达零之前，await 方法会一直受阻塞。之后，会释放所有等待的线程，await 的所有后续调用都将立即返回。这种现象只出现一次——计数无法被重置。 一个线程(或者多个)， 等待另外N个线程完成某个事情之后才能执行</p>
<h2 id="2、使用场景"><a href="#2、使用场景" class="headerlink" title="2、使用场景"></a>2、使用场景</h2><p>在一些应用场合中，需要等待某个条件达到要求后才能做后面的事情；同时当线程都完成后也会触发事件，以便进行后面的操作。 这个时候就可以使用CountDownLatch。CountDownLatch最重要的方法是countDown()和await()，前者主要是倒数一次，后者是等待倒数到0，如果没有到达0，就只有阻塞等待了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public void countDown()</span><br><span class="line"></span><br><span class="line">public boolean await(long timeout, TimeUnit unit) throws InterruptedException</span><br></pre></td></tr></table></figure>

<h2 id="3-实例"><a href="#3-实例" class="headerlink" title="3.实例"></a>3.实例</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟了100米赛跑，10名选手已经准备就绪，只等裁判一声令下。当所有人都到达终点时，比赛结束。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始的倒数锁 </span></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch begin = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);  </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 结束的倒数锁 </span></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch end = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);  </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 十名选手 </span></span><br><span class="line">        <span class="keyword">final</span> ExecutorService exec = Executors.newFixedThreadPool(<span class="number">10</span>);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="number">10</span>; index++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> NO = index + <span class="number">1</span>;  </span><br><span class="line">            Runnable run = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">                    <span class="keyword">try</span> &#123;  </span><br><span class="line">                        <span class="comment">// 如果当前计数为零，则此方法立即返回。</span></span><br><span class="line">                        <span class="comment">// 等待</span></span><br><span class="line">                        begin.await();  </span><br><span class="line">                        Thread.sleep((<span class="keyword">long</span>) (Math.random() * <span class="number">10000</span>));  </span><br><span class="line">                        System.out.println(<span class="string">&quot;No.&quot;</span> + NO + <span class="string">&quot; arrived&quot;</span>);  </span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                        <span class="comment">// 每个选手到达终点时，end就减一</span></span><br><span class="line">                        end.countDown();</span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;;  </span><br><span class="line">            exec.submit(run);</span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Game Start&quot;</span>);  </span><br><span class="line">        <span class="comment">// begin减一，开始游戏</span></span><br><span class="line">        begin.countDown();  </span><br><span class="line">        <span class="comment">// 等待end变为0，即所有选手到达终点</span></span><br><span class="line">        end.await();  </span><br><span class="line">        System.out.println(<span class="string">&quot;Game Over&quot;</span>);  </span><br><span class="line">        exec.shutdown();  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、输出结果"><a href="#4、输出结果" class="headerlink" title="4、输出结果"></a><strong>4、输出结果</strong></h2><p>Game Start<br>No.9 arrived<br>No.6 arrived<br>No.8 arrived<br>No.7 arrived<br>No.10 arrived<br>No.1 arrived<br>No.5 arrived<br>No.4 arrived<br>No.2 arrived<br>No.3 arrived<br>Game Over</p>
<h1 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h1><p>Semaphore也是一个线程同步的辅助类，可以维护当前访问自身的线程个数，并提供了同步机制。使用Semaphore可以控制同时访问资源的线程个数，例如，实现一个文件允许的并发访问数。</p>
<p>Semaphore的主要方法摘要：</p>
<p>　　void acquire():从此信号量获取一个许可，在提供一个许可前一直将线程阻塞，否则线程被中断。</p>
<p>　　void release():释放一个许可，将其返回给信号量。</p>
<p>　　int availablePermits():返回此信号量中当前可用的许可数。</p>
<p>　　boolean hasQueuedThreads():查询是否有线程正在等待获取</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.upload.station;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line">public class SemaphoreTest &#123;</span><br><span class="line">      public static void main(String[] args) &#123;</span><br><span class="line">          ExecutorService service = Executors.newCachedThreadPool();</span><br><span class="line">          //同一时刻只能有5个线程并发</span><br><span class="line">          public static final m=5;</span><br><span class="line">         final Semaphore sp = new Semaphore(m);//创建Semaphore信号量，初始化许可大小为m</span><br><span class="line">         for(int i=0;i&lt;5;i++)&#123;</span><br><span class="line">             try &#123;</span><br><span class="line">                 Thread.sleep(100);</span><br><span class="line">             &#125; catch (InterruptedException e2) &#123;</span><br><span class="line">                 e2.printStackTrace();</span><br><span class="line">             &#125;</span><br><span class="line">             Runnable runnable = new Runnable()&#123;</span><br><span class="line">                     public void run()&#123;</span><br><span class="line">                     try &#123;</span><br><span class="line">                         sp.acquire();//请求获得许可，如果有可获得的许可则继续往下执行，许可数减1。否则进入阻塞状态</span><br><span class="line">                     &#125; catch (InterruptedException e1) &#123;</span><br><span class="line">                         e1.printStackTrace();</span><br><span class="line">                     &#125;</span><br><span class="line">                     System.out.println(&quot;线程&quot; + Thread.currentThread().getName() +</span><br><span class="line">                             &quot;进入，当前已有&quot; + (m-sp.availablePermits()) + &quot;个并发&quot;);</span><br><span class="line">                     try &#123;</span><br><span class="line">                         Thread.sleep((long)(Math.random()*10000));</span><br><span class="line">                     &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                         e.printStackTrace();</span><br><span class="line">                     &#125;</span><br><span class="line">                     System.out.println(&quot;线程&quot; + Thread.currentThread().getName() +</span><br><span class="line">                             &quot;即将离开&quot;);</span><br><span class="line">                     sp.release();//释放许可，许可数加1</span><br><span class="line">                     //下面代码有时候执行不准确，因为其没有和上面的代码合成原子单元</span><br><span class="line">                     System.out.println(&quot;线程&quot; + Thread.currentThread().getName() +</span><br><span class="line">                             &quot;已离开，当前已有&quot; + (m-sp.availablePermits()) + &quot;个并发&quot;);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;;</span><br><span class="line">             service.execute(runnable);</span><br><span class="line">         &#125;</span><br><span class="line">         service.shutdown();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="ConcurrencyTester并发测试类"><a href="#ConcurrencyTester并发测试类" class="headerlink" title="ConcurrencyTester并发测试类"></a>ConcurrencyTester并发测试类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) throws InterruptedException, ExecutionException, IOException &#123;</span><br><span class="line">   ConcurrencyTester tester = ThreadUtil.concurrencyTest(10, () -&gt; &#123;</span><br><span class="line">//10个线程，执行逻辑</span><br><span class="line">      System.out.println(Thread.currentThread().getName());</span><br><span class="line">   &#125;);</span><br><span class="line">   tester.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220107145912509.png" alt="image-20220107145912509"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>方法工具类</title>
    <url>/2021/11/30/%E6%96%B9%E6%B3%95%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
    <content><![CDATA[<h1 id="1-work转pdf"><a href="#1-work转pdf" class="headerlink" title="1.work转pdf"></a>1.work转pdf</h1><p><img src="/../img/image-20220210174953840.png" alt="image-20220210174953840"></p>
<h2 id="新建lib包，与src同级，放入jar包"><a href="#新建lib包，与src同级，放入jar包" class="headerlink" title="新建lib包，与src同级，放入jar包"></a>新建lib包，与src同级，放入jar包</h2><p><img src="/../img/image-20220210175011186.png" alt="image-20220210175011186"></p>
<h2 id="在resources下"><a href="#在resources下" class="headerlink" title="在resources下"></a>在resources下</h2><p>pom</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.aspose&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;aspose-words&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;15.8.0&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;system&lt;/scope&gt;</span><br><span class="line">            &lt;systemPath&gt;$&#123;project.basedir&#125;/lib/aspose-words-15.8.0-jdk16.jar&lt;/systemPath&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<p><img src="/../img/image-20220210175042542.png" alt="image-20220210175042542"></p>
<p>新建License.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;License&gt;</span><br><span class="line">    &lt;Data&gt;</span><br><span class="line">        &lt;Products&gt;</span><br><span class="line">            &lt;Product&gt;Aspose.Total for Java&lt;/Product&gt;</span><br><span class="line">            &lt;Product&gt;Aspose.Words for Java&lt;/Product&gt;</span><br><span class="line">        &lt;/Products&gt;</span><br><span class="line">        &lt;EditionType&gt;Enterprise&lt;/EditionType&gt;</span><br><span class="line">        &lt;SubscriptionExpiry&gt;20991231&lt;/SubscriptionExpiry&gt;</span><br><span class="line">        &lt;LicenseExpiry&gt;20991231&lt;/LicenseExpiry&gt;</span><br><span class="line">        &lt;SerialNumber&gt;8bfe198c-7f0c-4ef8-8ff0-acc3237bf0d7&lt;/SerialNumber&gt;</span><br><span class="line">    &lt;/Data&gt;</span><br><span class="line">    &lt;Signature&gt;</span><br><span class="line">        sNLLKGMUdF0r8O1kKilWAGdgfs2BvJb/2Xp8p5iuDVfZXmhppo+d0Ran1P9TKdjV4ABwAgKXxJ3jcQTqE/2IRfqwnPf8itN8aFZlV3TJPYeD3yWE7IT55Gz6EijUpC7aKeoohTb4w2fpox58wWoF3SNp6sK6jDfiAUGEHYJ9pjU=</span><br><span class="line">    &lt;/Signature&gt;</span><br><span class="line">&lt;/License&gt;</span><br></pre></td></tr></table></figure>

<h2 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.websocket.util;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line"></span><br><span class="line">import com.aspose.words.Document;</span><br><span class="line">import com.aspose.words.License;</span><br><span class="line">import com.aspose.words.SaveFormat;</span><br><span class="line"></span><br><span class="line">public class Word2PdfUtil &#123;</span><br><span class="line"></span><br><span class="line">    private static boolean getLicense() &#123;</span><br><span class="line">        boolean result = false;</span><br><span class="line">        try &#123;</span><br><span class="line">            InputStream is = Word2PdfUtil.class.getClassLoader().getResourceAsStream(&quot;license.xml&quot;); // license.xml应放在..\WebRoot\WEB-INF\classes路径下</span><br><span class="line">            License aposeLic = new License();</span><br><span class="line">            aposeLic.setLicense(is);</span><br><span class="line">            result = true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param wordPath</span><br><span class="line">     *            需要被转换的word全路径带文件名</span><br><span class="line">     * @param pdfPath</span><br><span class="line">     *            转换之后pdf的全路径带文件名</span><br><span class="line">     */</span><br><span class="line">    public static void doc2pdf(String wordPath, String pdfPath) &#123;</span><br><span class="line">        if (!getLicense()) &#123; // 验证License 若不验证则转化出的pdf文档会有水印产生</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            long old = System.currentTimeMillis();</span><br><span class="line">            File file = new File(pdfPath); // 新建一个pdf文档</span><br><span class="line">            FileOutputStream os = new FileOutputStream(file);</span><br><span class="line">            Document doc = new Document(wordPath); // Address是将要被转化的word文档</span><br><span class="line">            doc.save(os, SaveFormat.PDF);// 全面支持DOC, DOCX, OOXML, RTF HTML, OpenDocument, PDF, EPUB,</span><br><span class="line">                                         // XPS, SWF 相互转换</span><br><span class="line">            long now = System.currentTimeMillis();</span><br><span class="line">            os.close();</span><br><span class="line">            System.out.println(&quot;共耗时：&quot; + ((now - old) / 1000.0) + &quot;秒&quot;); // 转化用时</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        doc2pdf(&quot;D:\\shell\\1.笔记\\尚硅谷大数据技术之Shell.docx&quot;, &quot;D:\\shell\\1.笔记\\尚硅谷大数据技术之Shell..pdf&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>当使用<code>&lt;scope&gt;system&lt;/scope&gt;</code>引入依赖时，打包的时候要多注意，要加上如下配置，不然springboot是不会这种方式引入的jar进行打包的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;!-- 打包时会将本地jar一起打包 --&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;includeSystemScope&gt;true&lt;/includeSystemScope&gt;</span><br><span class="line">            &lt;/configuration&gt;     </span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>

<h1 id="2-Excel工具类"><a href="#2-Excel工具类" class="headerlink" title="2.Excel工具类"></a>2.Excel工具类</h1><h2 id="首行批注"><a href="#首行批注" class="headerlink" title="首行批注"></a>首行批注</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.view.server.annotation;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: jiangjiaxu</span><br><span class="line"> * @email: jiangjiaxu@boco.com.cn</span><br><span class="line"> * @date: 2021/11/10 09:20</span><br><span class="line"> * @version: V1.0</span><br><span class="line"> * @description: 实体类上comment注释，是否必须填写</span><br><span class="line"> * @modify</span><br><span class="line"> */</span><br><span class="line">@Target(ElementType.FIELD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface ExcelComment &#123;</span><br><span class="line"></span><br><span class="line">    String comment() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    boolean required() default false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- excle --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.afterturn&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;easypoi-base&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.afterturn&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;easypoi-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.afterturn&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;easypoi-annotation&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.afterturn&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;easypoi-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="ExcelUtil"><a href="#ExcelUtil" class="headerlink" title="ExcelUtil"></a>ExcelUtil</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package ExcelUtil;</span><br><span class="line"></span><br><span class="line">import cn.afterturn.easypoi.excel.ExcelExportUtil;</span><br><span class="line">import cn.afterturn.easypoi.excel.ExcelImportUtil;</span><br><span class="line">import cn.afterturn.easypoi.excel.annotation.Excel;</span><br><span class="line">import cn.afterturn.easypoi.excel.entity.ExportParams;</span><br><span class="line">import cn.afterturn.easypoi.excel.entity.ImportParams;</span><br><span class="line">import cn.afterturn.easypoi.excel.entity.enmus.ExcelType;</span><br><span class="line">import cn.afterturn.easypoi.handler.inter.IExcelDictHandler;</span><br><span class="line">import com.boco.nbd.beijing.subway.annotation.ExcelComment;</span><br><span class="line">import com.google.common.collect.Maps;</span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.apache.poi.ss.usermodel.*;</span><br><span class="line">import org.apache.poi.xssf.usermodel.XSSFClientAnchor;</span><br><span class="line">import org.apache.poi.xssf.usermodel.XSSFRichTextString;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import javax.persistence.Id;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.OutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.net.URLEncoder;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.NoSuchElementException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * TODO excle工具类</span><br><span class="line"> *</span><br><span class="line"> * @author jiangjiaxu</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @date 2021-9-9 9:28</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class ExcelUtil &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导出</span><br><span class="line">     *</span><br><span class="line">     * @param list     数据列表</span><br><span class="line">     * @param fileName 导出时的excel名称</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    public static void exportExcel(List&lt;Map&lt;String, Object&gt;&gt; list, String fileName, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">        defaultExport(list, fileName, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 默认的 excel 导出</span><br><span class="line">     *</span><br><span class="line">     * @param list     数据列表</span><br><span class="line">     * @param fileName 导出时的excel名称</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    private static void defaultExport(List&lt;Map&lt;String, Object&gt;&gt; list, String fileName, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">        //把数据添加到excel表格中</span><br><span class="line">        Workbook workbook = ExcelExportUtil.exportExcel(list, ExcelType.HSSF);</span><br><span class="line">        downLoadExcel(fileName, response, workbook);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导出</span><br><span class="line">     *</span><br><span class="line">     * @param list         数据列表</span><br><span class="line">     * @param pojoClass    pojo类型</span><br><span class="line">     * @param fileName     导出时的excel名称</span><br><span class="line">     * @param response</span><br><span class="line">     * @param exportParams 导出参数（标题、sheet名称、是否创建表头，表格类型）</span><br><span class="line">     */</span><br><span class="line">    private static void defaultExport(List&lt;?&gt; list, Class&lt;?&gt; pojoClass, String fileName, HttpServletResponse response, ExportParams exportParams) throws IOException &#123;</span><br><span class="line">        //把数据添加到excel表格中</span><br><span class="line">        exportParams.setStyle(ExcelStyleUtil.class);</span><br><span class="line">        Workbook workbook = ExcelExportUtil.exportExcel(exportParams, pojoClass, list);</span><br><span class="line">        setComment(workbook, pojoClass, exportParams);</span><br><span class="line">        downLoadExcel(fileName, response, workbook);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 为首行设置批注</span><br><span class="line">     * @param workbook workbook</span><br><span class="line">     * @param pojoClass 实体类</span><br><span class="line">     * @param exportParams 导出参数</span><br><span class="line">     */</span><br><span class="line">    private static void setComment(Workbook workbook, Class&lt;?&gt; pojoClass, ExportParams exportParams) &#123;</span><br><span class="line">        String sheetName = exportParams.getSheetName();</span><br><span class="line">        Sheet sheet = StringUtils.isBlank(sheetName) ? workbook.getSheetAt(0) : workbook.getSheet(sheetName);</span><br><span class="line">        // 存储字段和批注对应关系</span><br><span class="line">        HashMap&lt;String, String&gt; map = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line">        Field[] declaredFields = pojoClass.getDeclaredFields();</span><br><span class="line">        for (Field declaredField : declaredFields) &#123;</span><br><span class="line">            ExcelComment excelComment = declaredField.getAnnotation(ExcelComment.class);</span><br><span class="line">            Excel excel = declaredField.getAnnotation(Excel.class);</span><br><span class="line">            Id id = declaredField.getAnnotation(Id.class);</span><br><span class="line">            if (id != null &amp;&amp; excel != null) &#123;</span><br><span class="line">                map.put(excel.name(), &quot;请勿修改！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (excelComment != null &amp;&amp; excel != null) &#123;</span><br><span class="line">                String comment = excelComment.comment();</span><br><span class="line">                StringBuilder builder = excelComment.required() ?  new StringBuilder(&quot;必填\n&quot;) : new StringBuilder(&quot;非必填\n&quot;);</span><br><span class="line">                map.put(excel.name(), builder.append(comment).toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 取消所有冻结窗格</span><br><span class="line">        sheet.createFreezePane(0,0);</span><br><span class="line">        Drawing&lt;?&gt; drawing = sheet.createDrawingPatriarch();</span><br><span class="line">        // 首行加批注</span><br><span class="line">        Row row = sheet.getRow(0);</span><br><span class="line">        for (Cell cell : row) &#123;</span><br><span class="line">            Comment comment = drawing.createCellComment(new XSSFClientAnchor(0, 0, 0, 0, cell.getColumnIndex(), cell.getRowIndex(), cell.getColumnIndex()+3, cell.getRowIndex()+4));</span><br><span class="line">            // 批注内容</span><br><span class="line">            String cellComment = map.get(cell.getStringCellValue());</span><br><span class="line">            if (cellComment == null) &#123;</span><br><span class="line">                cellComment = &quot;非必填\n&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            XSSFRichTextString textString = new XSSFRichTextString(cellComment);</span><br><span class="line">            // 设置字体样式</span><br><span class="line">            Font font = getCommentFont(workbook);</span><br><span class="line">            textString.applyFont(font);</span><br><span class="line">            comment.setString(textString);</span><br><span class="line">            cell.setCellComment(comment);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取批注字体设置</span><br><span class="line">     * @param workbook workbook</span><br><span class="line">     * @return Font</span><br><span class="line">     */</span><br><span class="line">    private static Font getCommentFont(Workbook workbook) &#123;</span><br><span class="line">        // 批注字体</span><br><span class="line">        Font font = workbook.createFont();</span><br><span class="line">        font.setFontHeightInPoints((short) 9);</span><br><span class="line">        return font;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导出</span><br><span class="line">     *</span><br><span class="line">     * @param list         数据列表</span><br><span class="line">     * @param pojoClass    pojo类型</span><br><span class="line">     * @param fileName     导出时的excel名称</span><br><span class="line">     * @param exportParams 导出参数（标题、sheet名称、是否创建表头，表格类型）</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    public static void exportExcel(List&lt;?&gt; list, Class&lt;?&gt; pojoClass, String fileName, ExportParams exportParams, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">        defaultExport(list, pojoClass, fileName, response, exportParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导出</span><br><span class="line">     *</span><br><span class="line">     * @param list      数据列表</span><br><span class="line">     * @param title     表格内数据标题</span><br><span class="line">     * @param sheetName sheet名称</span><br><span class="line">     * @param pojoClass pojo类型</span><br><span class="line">     * @param fileName  导出时的excel名称</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    public static void exportExcel(List&lt;?&gt; list, String title, String sheetName, Class&lt;?&gt; pojoClass, String fileName, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">        defaultExport(list, pojoClass, fileName, response, new ExportParams(title, sheetName, ExcelType.XSSF));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导出 带字典处理转换</span><br><span class="line">     * @param list  数据列表</span><br><span class="line">     * @param title 表格内数据标题</span><br><span class="line">     * @param sheetName sheet名称</span><br><span class="line">     * @param pojoClass pojo类型</span><br><span class="line">     * @param fileName  导出时的excel名称</span><br><span class="line">     * @param response  response</span><br><span class="line">     * @param dictHandler   字典处理器</span><br><span class="line">     * @throws IOException IOException</span><br><span class="line">     */</span><br><span class="line">    public static void exportExcel(List&lt;?&gt; list, String title, String sheetName, Class&lt;?&gt; pojoClass, String fileName, HttpServletResponse response, IExcelDictHandler dictHandler) throws IOException &#123;</span><br><span class="line">        ExportParams exportParams = new ExportParams(title, sheetName, ExcelType.XSSF);</span><br><span class="line">        exportParams.setDictHandler(dictHandler);</span><br><span class="line">        defaultExport(list, pojoClass, fileName, response, exportParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导出</span><br><span class="line">     *</span><br><span class="line">     * @param list           数据列表</span><br><span class="line">     * @param title          表格内数据标题</span><br><span class="line">     * @param sheetName      sheet名称</span><br><span class="line">     * @param pojoClass      pojo类型</span><br><span class="line">     * @param fileName       导出时的excel名称</span><br><span class="line">     * @param isCreateHeader 是否创建表头</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    public static void exportExcel(List&lt;?&gt; list, String title, String sheetName, Class&lt;?&gt; pojoClass, String fileName, boolean isCreateHeader, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">        ExportParams exportParams = new ExportParams(title, sheetName, ExcelType.XSSF);</span><br><span class="line">        exportParams.setCreateHeadRows(isCreateHeader);</span><br><span class="line">        defaultExport(list, pojoClass, fileName, response, exportParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 导出到输出流</span><br><span class="line">     * @param list 数据</span><br><span class="line">     * @param pojoClass 实体类</span><br><span class="line">     * @param outputStream 输出流</span><br><span class="line">     * @param exportParams 导出参数</span><br><span class="line">     * @throws IOException IOException</span><br><span class="line">     */</span><br><span class="line">    public static void exportToOutputStream(List&lt;?&gt; list, Class&lt;?&gt; pojoClass, OutputStream outputStream, ExportParams exportParams) throws IOException &#123;</span><br><span class="line">        //把数据添加到excel表格中</span><br><span class="line">        exportParams.setStyle(ExcelStyleUtil.class);</span><br><span class="line">        Workbook workbook = ExcelExportUtil.exportExcel(exportParams, pojoClass, list);</span><br><span class="line">        setComment(workbook, pojoClass, exportParams);</span><br><span class="line">        workbook.write(outputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel下载</span><br><span class="line">     *</span><br><span class="line">     * @param fileName 下载时的文件名称</span><br><span class="line">     * @param response</span><br><span class="line">     * @param workbook excel数据</span><br><span class="line">     */</span><br><span class="line">    private static void downLoadExcel(String fileName, HttpServletResponse response, Workbook workbook) throws IOException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            response.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">            response.setHeader(&quot;content-Type&quot;, &quot;application/vnd.ms-excel&quot;);</span><br><span class="line">            response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot; + URLEncoder.encode(fileName + &quot;.xlsx&quot;, &quot;UTF-8&quot;));</span><br><span class="line">            workbook.write(response.getOutputStream());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new IOException(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导入</span><br><span class="line">     *</span><br><span class="line">     * @param file      excel文件</span><br><span class="line">     * @param pojoClass pojo类型</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; importExcel(MultipartFile file, Class&lt;T&gt; pojoClass) throws IOException &#123;</span><br><span class="line">        return importExcel(file, 1, 1, pojoClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导入</span><br><span class="line">     *</span><br><span class="line">     * @param filePath   excel文件路径</span><br><span class="line">     * @param titleRows  表格内数据标题行</span><br><span class="line">     * @param headerRows 表头行</span><br><span class="line">     * @param pojoClass  pojo类型</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; importExcel(String filePath, Integer titleRows, Integer headerRows, Class&lt;T&gt; pojoClass) throws IOException &#123;</span><br><span class="line">        if (StringUtils.isBlank(filePath)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        ImportParams params = new ImportParams();</span><br><span class="line">        params.setTitleRows(titleRows);</span><br><span class="line">        params.setHeadRows(headerRows);</span><br><span class="line">        params.setNeedSave(true);</span><br><span class="line">        params.setSaveUrl(&quot;/excel/&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            return ExcelImportUtil.importExcel(new File(filePath), pojoClass, params);</span><br><span class="line">        &#125; catch (NoSuchElementException e) &#123;</span><br><span class="line">            throw new IOException(&quot;模板不能为空&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new IOException(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导入</span><br><span class="line">     *</span><br><span class="line">     * @param file       上传的文件</span><br><span class="line">     * @param titleRows  表格内数据标题行</span><br><span class="line">     * @param headerRows 表头行</span><br><span class="line">     * @param pojoClass  pojo类型</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; importExcel(MultipartFile file, Integer titleRows, Integer headerRows, Class&lt;T&gt; pojoClass) throws IOException &#123;</span><br><span class="line">        return importExcel(file, titleRows, headerRows, pojoClass, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导入 带字典转换</span><br><span class="line">     * @param file 上传的文件</span><br><span class="line">     * @param titleRows  表格内数据标题行</span><br><span class="line">     * @param headerRows  表头行</span><br><span class="line">     * @param pojoClass pojo类型</span><br><span class="line">     * @param dictHandler 字典转换处理器</span><br><span class="line">     * @return  List&lt;T&gt;</span><br><span class="line">     * @throws IOException IOException</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; importExcel(MultipartFile file, Integer titleRows, Integer headerRows, Class&lt;T&gt; pojoClass, IExcelDictHandler dictHandler) throws IOException &#123;</span><br><span class="line">        if (file == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (dictHandler == null) &#123;</span><br><span class="line">                return importExcel(file.getInputStream(), titleRows, headerRows, pojoClass);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return importExcel(file.getInputStream(), titleRows, headerRows, pojoClass, dictHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new IOException(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导入</span><br><span class="line">     *</span><br><span class="line">     * @param inputStream 文件输入流</span><br><span class="line">     * @param titleRows   表格内数据标题行</span><br><span class="line">     * @param headerRows  表头行</span><br><span class="line">     * @param pojoClass   pojo类型</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; importExcel(InputStream inputStream, Integer titleRows, Integer headerRows, Class&lt;T&gt; pojoClass) throws IOException &#123;</span><br><span class="line">        return importExcel(inputStream,titleRows,headerRows,pojoClass, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * excel 导入 带字典转换</span><br><span class="line">     * @param inputStream 文件输入流</span><br><span class="line">     * @param titleRows 表格内数据标题行</span><br><span class="line">     * @param headerRows 表头行</span><br><span class="line">     * @param pojoClass pojo类型</span><br><span class="line">     * @param dictHandler 字典处理器</span><br><span class="line">     * @param &lt;T&gt;</span><br><span class="line">     * @return  List&lt;T&gt;</span><br><span class="line">     * @throws IOException IOException</span><br><span class="line">     */</span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; importExcel(InputStream inputStream, Integer titleRows, Integer headerRows, Class&lt;T&gt; pojoClass, IExcelDictHandler dictHandler) throws IOException &#123;</span><br><span class="line">        if (inputStream == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        ImportParams params = new ImportParams();</span><br><span class="line">        params.setTitleRows(titleRows);</span><br><span class="line">        params.setHeadRows(headerRows);</span><br><span class="line">        params.setSaveUrl(&quot;/excel/&quot;);</span><br><span class="line">        params.setNeedSave(true);</span><br><span class="line">        if (dictHandler != null) &#123;</span><br><span class="line">            params.setDictHandler(dictHandler);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            return ExcelImportUtil.importExcel(inputStream, pojoClass, params);</span><br><span class="line">        &#125; catch (NoSuchElementException e) &#123;</span><br><span class="line">            throw new IOException(&quot;excel文件不能为空&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new IOException(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ExcelStyleUtil"><a href="#ExcelStyleUtil" class="headerlink" title="ExcelStyleUtil"></a>ExcelStyleUtil</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.threshold.util;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import cn.afterturn.easypoi.excel.entity.params.ExcelExportEntity;</span><br><span class="line">import cn.afterturn.easypoi.excel.entity.params.ExcelForEachParams;</span><br><span class="line">import cn.afterturn.easypoi.excel.export.styler.IExcelExportStyler;</span><br><span class="line">import org.apache.poi.ss.usermodel.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * TODO Excel导出表格样式</span><br><span class="line"> *</span><br><span class="line"> * @author jiangjiaxu</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @date 2021-9-10 8:40</span><br><span class="line"> */</span><br><span class="line">public class ExcelStyleUtil implements IExcelExportStyler &#123;</span><br><span class="line">    private static final short STRING_FORMAT = (short) BuiltinFormats.getBuiltinFormat(&quot;TEXT&quot;);</span><br><span class="line">    private static final short FONT_SIZE_TEN = 9;</span><br><span class="line">    private static final short FONT_SIZE_ELEVEN = 10;</span><br><span class="line">    private static final short FONT_SIZE_TWELVE = 10;</span><br><span class="line">    /**</span><br><span class="line">     * 大标题样式</span><br><span class="line">     */</span><br><span class="line">    private CellStyle headerStyle;</span><br><span class="line">    /**</span><br><span class="line">     * 每列标题样式</span><br><span class="line">     */</span><br><span class="line">    private CellStyle titleStyle;</span><br><span class="line">    /**</span><br><span class="line">     * 数据行样式</span><br><span class="line">     */</span><br><span class="line">    private CellStyle styles;</span><br><span class="line"></span><br><span class="line">    public ExcelStyleUtil(Workbook workbook) &#123;</span><br><span class="line">        this.init(workbook);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始化样式</span><br><span class="line">     *</span><br><span class="line">     * @param workbook</span><br><span class="line">     */</span><br><span class="line">    private void init(Workbook workbook) &#123;</span><br><span class="line">        this.headerStyle = initHeaderStyle(workbook);</span><br><span class="line">        this.titleStyle = initTitleStyle(workbook);</span><br><span class="line">        this.styles = initStyles(workbook);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 大标题样式</span><br><span class="line">     *</span><br><span class="line">     * @param color</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public CellStyle getHeaderStyle(short color) &#123;</span><br><span class="line">        return headerStyle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 每列标题样式</span><br><span class="line">     *</span><br><span class="line">     * @param color</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public CellStyle getTitleStyle(short color) &#123;</span><br><span class="line">        return titleStyle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 数据行样式</span><br><span class="line">     *</span><br><span class="line">     * @param parity 可以用来表示奇偶行</span><br><span class="line">     * @param entity 数据内容</span><br><span class="line">     * @return 样式</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public CellStyle getStyles(boolean parity, ExcelExportEntity entity) &#123;</span><br><span class="line">        return styles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取样式方法</span><br><span class="line">     *</span><br><span class="line">     * @param dataRow 数据行</span><br><span class="line">     * @param obj     对象</span><br><span class="line">     * @param data    数据</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public CellStyle getStyles(Cell cell, int dataRow, ExcelExportEntity entity, Object obj, Object data) &#123;</span><br><span class="line">        return getStyles(true, entity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 模板使用的样式设置</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public CellStyle getTemplateStyles(boolean isSingle, ExcelForEachParams excelForEachParams) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始化--大标题样式</span><br><span class="line">     *</span><br><span class="line">     * @param workbook</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private CellStyle initHeaderStyle(Workbook workbook) &#123;</span><br><span class="line">        CellStyle style = getBaseCellStyle(workbook);</span><br><span class="line">        style.setFont(getFont(workbook, FONT_SIZE_TWELVE, true));</span><br><span class="line">        return style;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始化--每列标题样式</span><br><span class="line">     *</span><br><span class="line">     * @param workbook</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private CellStyle initTitleStyle(Workbook workbook) &#123;</span><br><span class="line">        CellStyle style = getBaseCellStyle(workbook);</span><br><span class="line">        style.setFont(getFont(workbook, FONT_SIZE_ELEVEN, false));</span><br><span class="line">        //背景色</span><br><span class="line">        style.setFillForegroundColor(IndexedColors.YELLOW.getIndex());</span><br><span class="line">        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">        return style;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始化--数据行样式</span><br><span class="line">     *</span><br><span class="line">     * @param workbook</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private CellStyle initStyles(Workbook workbook) &#123;</span><br><span class="line">        CellStyle style = getBaseCellStyle(workbook);</span><br><span class="line">        style.setFont(getFont(workbook, FONT_SIZE_TEN, false));</span><br><span class="line">        style.setDataFormat(STRING_FORMAT);</span><br><span class="line">        return style;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 基础样式</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private CellStyle getBaseCellStyle(Workbook workbook) &#123;</span><br><span class="line">        CellStyle style = workbook.createCellStyle();</span><br><span class="line">        //下边框</span><br><span class="line">        style.setBorderBottom(BorderStyle.THIN);</span><br><span class="line">        //左边框</span><br><span class="line">        style.setBorderLeft(BorderStyle.THIN);</span><br><span class="line">        //上边框</span><br><span class="line">        style.setBorderTop(BorderStyle.THIN);</span><br><span class="line">        //右边框</span><br><span class="line">        style.setBorderRight(BorderStyle.THIN);</span><br><span class="line">        //水平居中</span><br><span class="line">        style.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        //上下居中</span><br><span class="line">        style.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        //设置自动换行</span><br><span class="line">        style.setWrapText(true);</span><br><span class="line">        return style;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 字体样式</span><br><span class="line">     *</span><br><span class="line">     * @param size   字体大小</span><br><span class="line">     * @param isBold 是否加粗</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private Font getFont(Workbook workbook, short size, boolean isBold) &#123;</span><br><span class="line">        Font font = workbook.createFont();</span><br><span class="line">        //字体样式</span><br><span class="line">        font.setFontName(&quot;宋体&quot;);</span><br><span class="line">        //是否加粗</span><br><span class="line">        font.setBold(isBold);</span><br><span class="line">        //字体大小</span><br><span class="line">        font.setFontHeightInPoints(size);</span><br><span class="line">        return font;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ExcelDictHandlerImpl下拉枚举"><a href="#ExcelDictHandlerImpl下拉枚举" class="headerlink" title="ExcelDictHandlerImpl下拉枚举"></a>ExcelDictHandlerImpl下拉枚举</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">IExcelDictHandler excelDictHandler;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Excel(name = &quot;所属联网中心&quot;, dict = &quot;network_center&quot;, addressList = true)</span><br><span class="line">@Column(name = &quot;network_center_id&quot;)</span><br><span class="line">@ApiModelProperty(&quot;所属联网中心id&quot;)</span><br><span class="line">private Long networkCenterId;</span><br></pre></td></tr></table></figure>

<h3 id="复杂用xml以及查库版"><a href="#复杂用xml以及查库版" class="headerlink" title="复杂用xml以及查库版"></a>复杂用xml以及查库版</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.resource.service.service.impl;</span><br><span class="line"></span><br><span class="line">import cn.afterturn.easypoi.handler.inter.IExcelDictHandler;</span><br><span class="line">import cn.hutool.core.io.resource.ResourceUtil;</span><br><span class="line">import cn.hutool.json.XML;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.JSONArray;</span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.boco.nbd.resource.service.entity.bo.ResStandardDicBo;</span><br><span class="line">import com.boco.nbd.resource.service.mapper.extdb.ResStandardDicMapper;</span><br><span class="line">import com.google.common.collect.BiMap;</span><br><span class="line">import com.google.common.collect.HashBiMap;</span><br><span class="line">import com.google.common.collect.ImmutableMap;</span><br><span class="line">import com.google.common.collect.Maps;</span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ClassName ExcelDictHandlerImpl</span><br><span class="line"> * @Description Excel导出下拉列表生成，导入导出枚举值转换字典类</span><br><span class="line"> * @Author songyanfei</span><br><span class="line"> * @Email songyanfei@boco.com.cn</span><br><span class="line"> * @Date 2022-01-20</span><br><span class="line"> * @Version V1.0</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class ExcelDictHandlerImpl implements IExcelDictHandler &#123;</span><br><span class="line"></span><br><span class="line">    private ResStandardDicMapper resStandardDicMapper;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private ResStandardDicMapper mapper;</span><br><span class="line"></span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        resStandardDicMapper = this.mapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 字典配置文件名称</span><br><span class="line">     */</span><br><span class="line">    private final static String FILE_NAME = &quot;dict-config.xml&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * 字段下拉列表缓存</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;String, List&lt;Map&gt;&gt; addressListCache = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line">    /**</span><br><span class="line">     * 字段枚举值缓存</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;String, BiMap&lt;String, String&gt;&gt; enumMapCache = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line">    /**</span><br><span class="line">     * 字典列表缓存</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;String, List&lt;ResStandardDicBo&gt;&gt; dictListCache = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 用于生成excel下拉列表值</span><br><span class="line">     *</span><br><span class="line">     * @param dictName 字典Key</span><br><span class="line">     * @return List&lt;Map&gt;</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;Map&gt; getList(String dictName) &#123;</span><br><span class="line">        cache();</span><br><span class="line">        return addressListCache.get(dictName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 导出</span><br><span class="line">     * 从值 -&gt; name</span><br><span class="line">     * value是数据库实际存储值</span><br><span class="line">     * name是枚举转换后的值</span><br><span class="line">     *</span><br><span class="line">     * @param dict  Excel注解上dict对应名称</span><br><span class="line">     * @param obj   实体类对象</span><br><span class="line">     * @param name  枚举转换后的值</span><br><span class="line">     * @param value 数据库实际存储值</span><br><span class="line">     * @return 枚举转换后的值</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public String toName(String dict, Object obj, String name, Object value) &#123;</span><br><span class="line">        BiMap&lt;String, String&gt; biMap = enumMapCache.get(dict);</span><br><span class="line">        return biMap == null ? null : biMap.get(String.valueOf(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 导入</span><br><span class="line">     * 从Name -&gt; value</span><br><span class="line">     *</span><br><span class="line">     * @param dict  Excel注解上dict对应名称</span><br><span class="line">     * @param obj   实体类对象</span><br><span class="line">     * @param name  枚举转换后的值</span><br><span class="line">     * @param value 数据库实际存储值</span><br><span class="line">     * @return 数据库实际存储值</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public String toValue(String dict, Object obj, String name, Object value) &#123;</span><br><span class="line">        BiMap&lt;String, String&gt; biMap = enumMapCache.get(dict);</span><br><span class="line">        return biMap == null ? null : biMap.inverse().get(String.valueOf(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据xml文件缓存字典值</span><br><span class="line">     */</span><br><span class="line">    private void cacheDict() &#123;</span><br><span class="line">        String xml = ResourceUtil.readUtf8Str(FILE_NAME);</span><br><span class="line">        JSONObject jsonObject = JSON.parseObject(JSON.toJSONString(XML.toJSONObject(xml)));</span><br><span class="line">        JSONObject dictList = jsonObject.getJSONObject(&quot;dictList&quot;);</span><br><span class="line">        JSONArray dict = dictList.getJSONArray(&quot;dict&quot;);</span><br><span class="line">        for (Object o : dict) &#123;</span><br><span class="line">            JSONObject dictObj = JSONObject.parseObject(o.toString());</span><br><span class="line">            String dictName = dictObj.getString(&quot;dictName&quot;);</span><br><span class="line">            String fieldGroup = dictObj.getString(&quot;fieldGroup&quot;);</span><br><span class="line">            String valueGroup = dictObj.getString(&quot;valueGroup&quot;);</span><br><span class="line">            List&lt;Map&gt; dicList = getList(fieldGroup, valueGroup);</span><br><span class="line">            if (!dicList.isEmpty()) &#123;</span><br><span class="line">                //put的key是属性名，dicList是一个Map，map的key都是dictValue，value就是下拉</span><br><span class="line">                addressListCache.put(dictName, dicList);</span><br><span class="line">                //put的key是属性名，getEnum()是一个Map，map的key，value</span><br><span class="line">                enumMapCache.put(dictName, getEnum(fieldGroup, valueGroup));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 查询全部字典数据</span><br><span class="line">     *</span><br><span class="line">     * @return List&lt;ResStandardDicBo&gt;</span><br><span class="line">     */</span><br><span class="line">    private List&lt;ResStandardDicBo&gt; getResStandardDic() &#123;</span><br><span class="line">        List&lt;ResStandardDicBo&gt; standardDicBoList = resStandardDicMapper.selectResStandardDic(null);</span><br><span class="line">        standardDicBoList.addAll(resStandardDicMapper.selectCorrelatedDic());</span><br><span class="line">        return standardDicBoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 下拉列表</span><br><span class="line">     *</span><br><span class="line">     * @param fieldGroup</span><br><span class="line">     * @param valueGroup</span><br><span class="line">     * @return List&lt;Map&gt;</span><br><span class="line">     */</span><br><span class="line">    private List&lt;Map&gt;getList(String fieldGroup, String valueGroup) &#123;</span><br><span class="line">        List&lt;Map&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;ResStandardDicBo&gt; dictList = dictListCache.get(&quot;dictList&quot;);</span><br><span class="line">        if (!dictList.isEmpty()) &#123;</span><br><span class="line">            List&lt;ResStandardDicBo&gt; values = dictList.stream().filter(s -&gt; fieldGroup.equals(s.getFieldGroup())).collect(Collectors.toList());</span><br><span class="line">            if (StringUtils.isNotBlank(valueGroup)) &#123;</span><br><span class="line">                values = values.stream().filter(s -&gt; valueGroup.equals(s.getValueGroup())).collect(Collectors.toList());</span><br><span class="line">            &#125;</span><br><span class="line">            if (!values.isEmpty()) &#123;</span><br><span class="line">                values = values.stream().filter(s -&gt; s.getDicValue() != null &amp;&amp; s.getDicKey() != null).collect(Collectors.toList());</span><br><span class="line">                values.forEach(s -&gt; list.add(ImmutableMap.of(&quot;dictValue&quot;, s.getDicValue())));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 枚举</span><br><span class="line">     *</span><br><span class="line">     * @param valueGroup</span><br><span class="line">     * @param fieldGroup</span><br><span class="line">     * @return BiMap&lt;String, String&gt;</span><br><span class="line">     */</span><br><span class="line">    private BiMap&lt;String, String&gt; getEnum(String fieldGroup, String valueGroup) &#123;</span><br><span class="line">        BiMap&lt;String, String&gt; map = HashBiMap.create();</span><br><span class="line">        List&lt;ResStandardDicBo&gt; dictList = dictListCache.get(&quot;dictList&quot;);</span><br><span class="line">        if (!dictList.isEmpty()) &#123;</span><br><span class="line">            List&lt;ResStandardDicBo&gt; values = dictList.stream().filter(s -&gt; fieldGroup.equals(s.getFieldGroup())).collect(Collectors.toList());</span><br><span class="line">            if (StringUtils.isNotBlank(valueGroup)) &#123;</span><br><span class="line">                values = values.stream().filter(s -&gt; valueGroup.equals(s.getValueGroup())).collect(Collectors.toList());</span><br><span class="line">            &#125;</span><br><span class="line">            if (!values.isEmpty()) &#123;</span><br><span class="line">                values = values.stream().filter(s -&gt; s.getDicValue() != null &amp;&amp; s.getDicKey() != null).collect(Collectors.toList());</span><br><span class="line">                values.forEach(s -&gt; map.put(s.getDicKey(), s.getDicValue()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 当文件导出成功后清除缓存</span><br><span class="line">     */</span><br><span class="line">    public void clearCache()&#123;</span><br><span class="line">        dictListCache.clear();</span><br><span class="line">        enumMapCache.clear();</span><br><span class="line">        addressListCache.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 字典和枚举缓存赋值</span><br><span class="line">     */</span><br><span class="line">    public void cache()&#123;</span><br><span class="line">        String key = &quot;dictList&quot;;</span><br><span class="line">        if(!dictListCache.containsKey(key))&#123;</span><br><span class="line">            dictListCache.put(&quot;dictList&quot;, getResStandardDic());</span><br><span class="line"></span><br><span class="line">            cacheDict();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="精简版"><a href="#精简版" class="headerlink" title="精简版"></a>精简版</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.jiang.demo3;</span><br><span class="line"></span><br><span class="line">import cn.afterturn.easypoi.handler.inter.IExcelDictHandler;</span><br><span class="line"></span><br><span class="line">import com.google.common.collect.BiMap;</span><br><span class="line">import com.google.common.collect.HashBiMap;</span><br><span class="line">import com.google.common.collect.ImmutableMap;</span><br><span class="line">import com.google.common.collect.Maps;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: jiangjiaxu</span><br><span class="line"> * @email: jiangjiaxu@boco.com.cn</span><br><span class="line"> * @date: 2021/9/23 14:55</span><br><span class="line"> * @version: V1.0</span><br><span class="line"> * @description: Excel导出下拉列表生成，导入导出枚举值转换字典类,exportExcel里有这个参数</span><br><span class="line"> * @modify</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class ExcelDictHandlerImpl implements IExcelDictHandler &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init()&#123;</span><br><span class="line">        loadCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 字段下拉列表缓存</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;String, List&lt;Map&gt;&gt; addressListCache = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line">    /**</span><br><span class="line">     * 字段枚举值缓存</span><br><span class="line">     */</span><br><span class="line">    private final Map&lt;String, BiMap&lt;String, String&gt;&gt; enumMapCache = Maps.newHashMapWithExpectedSize(10);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 用于生成excel下拉列表值</span><br><span class="line">     * @param dict 字典Key</span><br><span class="line">     * @return List&lt;Map&gt;</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;Map&gt; getList(String dict) &#123;</span><br><span class="line">        return addressListCache.get(dict);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 导出</span><br><span class="line">     * 从值 -&gt; name</span><br><span class="line">     * value是数据库实际存储值</span><br><span class="line">     * name是枚举转换后的值</span><br><span class="line">     * @param dict Excel注解上dict对应名称</span><br><span class="line">     * @param obj  实体类对象</span><br><span class="line">     * @param name 枚举转换后的值</span><br><span class="line">     * @param value 数据库实际存储值</span><br><span class="line">     * @return 枚举转换后的值</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public String toName(String dict, Object obj, String name, Object value) &#123;</span><br><span class="line">        BiMap&lt;String, String&gt; biMap = enumMapCache.get(dict);</span><br><span class="line">        return biMap == null ? null : biMap.get(String.valueOf(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 导入</span><br><span class="line">     * 从Name -&gt; value</span><br><span class="line">     * @param dict Excel注解上dict对应名称</span><br><span class="line">     * @param obj 实体类对象</span><br><span class="line">     * @param name 枚举转换后的值</span><br><span class="line">     * @param value 数据库实际存储值</span><br><span class="line">     * @return 数据库实际存储值</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public String toValue(String dict, Object obj, String name, Object value) &#123;</span><br><span class="line">        BiMap&lt;String, String&gt; biMap = enumMapCache.get(dict);</span><br><span class="line">        return biMap == null ? null : biMap.inverse().get(String.valueOf(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始值加载</span><br><span class="line">     */</span><br><span class="line">    private void loadCache() &#123;</span><br><span class="line">        // direction字段,每个字段都有两个方法</span><br><span class="line">        addressListCache.put(&quot;sex&quot;, getPortDirectionList());</span><br><span class="line">        enumMapCache.put(&quot;sex&quot;, getPortDirectionEnum());</span><br><span class="line">        //在这里添加以两个一组的下拉属性字段</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * port direction下拉列表</span><br><span class="line">     * @return List&lt;Map&gt;</span><br><span class="line">     */</span><br><span class="line">    private List&lt;Map&gt; getPortDirectionList() &#123;</span><br><span class="line">        List&lt;Map&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        //固定格式key，value是下拉展示</span><br><span class="line">        list.add(ImmutableMap.of(&quot;dictValue&quot;, &quot;男&quot;));</span><br><span class="line">        list.add(ImmutableMap.of(&quot;dictValue&quot;, &quot;女&quot;));</span><br><span class="line">        return list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * port direction 枚举</span><br><span class="line">     * @return BiMap&lt;String, String&gt;</span><br><span class="line">     */</span><br><span class="line">    private BiMap&lt;String, String&gt; getPortDirectionEnum() &#123;</span><br><span class="line">        BiMap&lt;String,String&gt; map = HashBiMap.create();</span><br><span class="line">        //k是数据库存的值，value是枚举值</span><br><span class="line">        map.put(&quot;1&quot;, &quot;男&quot;);</span><br><span class="line">        map.put(&quot;2&quot;, &quot;女&quot;);</span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="在运行时修改制定注解的内容excel"><a href="#在运行时修改制定注解的内容excel" class="headerlink" title="在运行时修改制定注解的内容excel"></a>在运行时修改制定注解的内容excel</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">		Field f = AlarmActBo.class.getDeclaredField(<span class="string">&quot;cityName&quot;</span>);</span><br><span class="line">		f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">		Excel excelAn = f.getAnnotation(Excel.class);<span class="comment">//Excel是注解类型</span></span><br><span class="line">		System.out.println(excelAn.name());</span><br><span class="line">		ExcelUtil.modifyExcel(<span class="string">&quot;cityName&quot;</span>,<span class="string">&quot;所属区域&quot;</span>,AlarmActBo.class);</span><br><span class="line">		System.out.println(excelAn.name());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在运行时修改制定注解的内容excel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchFieldException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">modifyExcel</span><span class="params">(String name,String value,Class c)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field f = c.getDeclaredField(name);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Excel excelAn = f.getAnnotation(Excel.class);<span class="comment">//Excel是注解类型</span></span><br><span class="line">        InvocationHandler h = Proxy.getInvocationHandler(excelAn);</span><br><span class="line">        Field hField = h.getClass().getDeclaredField(<span class="string">&quot;memberValues&quot;</span>);</span><br><span class="line">        hField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Map map = (Map) hField.get(h);</span><br><span class="line">        <span class="comment">// 修改 value 属性值 这里修改的是@Excel(name = &quot;姓名&quot;)</span></span><br><span class="line">        <span class="comment">//name是key</span></span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h1 id="3-csv工具类"><a href="#3-csv工具类" class="headerlink" title="3.csv工具类"></a>3.csv工具类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.view.server.util;</span><br><span class="line"></span><br><span class="line">import cn.afterturn.easypoi.csv.CsvExportUtil;</span><br><span class="line">import cn.afterturn.easypoi.csv.entity.CsvExportParams;</span><br><span class="line"></span><br><span class="line">import cn.afterturn.easypoi.excel.entity.params.ExcelExportEntity;</span><br><span class="line">import com.boco.nbd.view.server.entity.bo.NbdAlarmActBo;</span><br><span class="line">import com.boco.nbd.view.server.entity.bo.NbdAlarmExperienceBaseBo;</span><br><span class="line">import com.boco.nbd.view.server.entity.bo.TableHanderBo;</span><br><span class="line">import com.boco.nbd.view.server.entity.qo.NbdAlarmExperienceBaseQo;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.OutputStream;</span><br><span class="line">import java.net.URLEncoder;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.LinkedHashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: lifengjuan</span><br><span class="line"> * @email: lifengjuan@boco.com.cn</span><br><span class="line"> * @date: 2021/11/22 15:20</span><br><span class="line"> * @version: V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> * @modify</span><br><span class="line"> */</span><br><span class="line">public class CsvUtil &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 选择列导出（单sheet）</span><br><span class="line">     *</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    public static void defaultExport(List&lt;LinkedHashMap&lt;String, Object&gt;&gt; dataList, List&lt;TableHanderBo&gt; excelRows,String fileName, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">        List&lt;ExcelExportEntity&gt; entityList = new ArrayList&lt;&gt;();</span><br><span class="line">        excelRows.forEach(item -&gt; &#123;</span><br><span class="line">            ExcelExportEntity exportEntity = new ExcelExportEntity(item.getTitle(), item.getDataIndex());</span><br><span class="line">            entityList.add(exportEntity);</span><br><span class="line">        &#125;);</span><br><span class="line">        CsvExportParams exportParams = new CsvExportParams();</span><br><span class="line">        OutputStream outputStream = response.getOutputStream();</span><br><span class="line">        downLoadExcel(fileName, response, outputStream);</span><br><span class="line">        CsvExportUtil.exportCsv(exportParams, entityList,dataList, outputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 导出</span><br><span class="line">     *</span><br><span class="line">     * @param list</span><br><span class="line">     * @param pojoClass</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    public static void defaultExport(List&lt;NbdAlarmActBo&gt; list, Class&lt;?&gt; pojoClass, String fileName, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">        CsvExportParams csvExportParams = new CsvExportParams();</span><br><span class="line">        OutputStream outputStream = response.getOutputStream();</span><br><span class="line">        downLoadExcel(fileName, response, outputStream);</span><br><span class="line">        CsvExportUtil.exportCsv(csvExportParams, pojoClass, list, outputStream);</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 导出</span><br><span class="line">     * @param list</span><br><span class="line">     * @param pojoClass</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    public static void defaultExportExperienceBase(List&lt;NbdAlarmExperienceBaseBo&gt; list, Class&lt;?&gt; pojoClass, String fileName, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">        CsvExportParams csvExportParams = new CsvExportParams();</span><br><span class="line">        OutputStream outputStream = response.getOutputStream();</span><br><span class="line">        downLoadExcel(fileName, response, outputStream);</span><br><span class="line">        CsvExportUtil.exportCsv(csvExportParams, pojoClass, list, outputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Csv下载</span><br><span class="line">     *</span><br><span class="line">     * @param fileName 下载时的文件名称</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    private static void downLoadExcel(String fileName, HttpServletResponse response, OutputStream outputStream) throws IOException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            fileName = fileName + &quot;.csv&quot;;</span><br><span class="line">            response.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">            response.setHeader(&quot;content-Type&quot;, &quot;application/vnd.ms-excel&quot;);</span><br><span class="line">            response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot; + URLEncoder.encode(fileName, &quot;UTF-8&quot;));</span><br><span class="line">            outputStream.write(new byte[]&#123;(byte) 0xEF, (byte) 0xBB, (byte) 0xBF&#125;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new IOException(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-获取bean工具类"><a href="#4-获取bean工具类" class="headerlink" title="4.获取bean工具类"></a>4.获取bean工具类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.threshold.util;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.BeansException;</span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.context.ApplicationContextAware;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: jiangjiaxu</span><br><span class="line"> * @description: 获取bean工具类</span><br><span class="line"> * @version: V1.0</span><br><span class="line"> * @date: 2021-11-06</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class SpringBeanUtil implements ApplicationContextAware &#123;</span><br><span class="line">   private static ApplicationContext applicationContext = null;</span><br><span class="line">   @Override</span><br><span class="line">   public void setApplicationContext(ApplicationContext applicationContext) throws</span><br><span class="line">                BeansException &#123;</span><br><span class="line">      // TODO Auto-generated method stub</span><br><span class="line">      SpringBeanUtil.applicationContext = applicationContext;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 从静态变量applicationContext中得到Bean, 自动转型为所赋值对象的类型.</span><br><span class="line">    */</span><br><span class="line">   @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">   public static &lt;T&gt; T getBean(String name) &#123;</span><br><span class="line">      if(name == null || applicationContext == null)&#123;</span><br><span class="line">         return null;</span><br><span class="line">      &#125;</span><br><span class="line">      return (T) applicationContext.getBean(name);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 从静态变量applicationContext中得到Bean, 自动转型为所赋值对象的类型.</span><br><span class="line">    */</span><br><span class="line">   public static &lt;T&gt; T getBean(Class&lt;T&gt; clazz) &#123;</span><br><span class="line">      return applicationContext.getBean(clazz);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-驼峰转换类"><a href="#5-驼峰转换类" class="headerlink" title="5.驼峰转换类"></a>5.驼峰转换类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.threshold.util;</span><br><span class="line"></span><br><span class="line">import java.util.regex.Matcher;</span><br><span class="line">import java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:jiangjiaxu</span><br><span class="line"> * @date 2021/11/25  16:12</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:</span><br><span class="line"> */</span><br><span class="line">public class StringUtil &#123;</span><br><span class="line">   private static Pattern linePattern = Pattern.compile(&quot;_(\\w)&quot;);</span><br><span class="line">   private static Pattern humpPattern = Pattern.compile(&quot;[A-Z]&quot;);</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 驼峰转下划线,最后转为大写</span><br><span class="line">    * @param str</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">   public static String humpToLine(String str) &#123;</span><br><span class="line">      Matcher matcher = humpPattern.matcher(str);</span><br><span class="line">      StringBuffer sb = new StringBuffer();</span><br><span class="line">      while (matcher.find()) &#123;</span><br><span class="line">         matcher.appendReplacement(sb, &quot;_&quot; + matcher.group(0).toUpperCase());</span><br><span class="line">      &#125;</span><br><span class="line">      matcher.appendTail(sb);</span><br><span class="line">      return sb.toString().toUpperCase();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 下划线转驼峰,正常输出</span><br><span class="line">    * @param str</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">   public static String lineToHump(String str) &#123;</span><br><span class="line">      Matcher matcher = linePattern.matcher(str);</span><br><span class="line">      StringBuffer sb = new StringBuffer();</span><br><span class="line">      while (matcher.find()) &#123;</span><br><span class="line">         matcher.appendReplacement(sb, matcher.group(1).toUpperCase());</span><br><span class="line">      &#125;</span><br><span class="line">      matcher.appendTail(sb);</span><br><span class="line">      return sb.toString();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="公司转驼峰，大写和下划线转小写驼峰"><a href="#公司转驼峰，大写和下划线转小写驼峰" class="headerlink" title="公司转驼峰，大写和下划线转小写驼峰"></a>公司转驼峰，大写和下划线转小写驼峰</h2><p>ToCamelCaseMap类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.boco.nbd.threshold.util;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.util.StrUtil;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Locale;</span><br><span class="line">import java.util.regex.Matcher;</span><br><span class="line">import java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author:caohai</span><br><span class="line"> * @date:2022/4/2 8:45</span><br><span class="line"> * @version:V1.0</span><br><span class="line"> * @description:TODO ToCamelCaseMap</span><br><span class="line"> * @modify:</span><br><span class="line"> */</span><br><span class="line">public class ToCamelCaseMap&lt;K, V&gt; extends HashMap&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public V put(K key, V value) &#123;</span><br><span class="line">        if (key instanceof String) &#123;</span><br><span class="line">            String mapKey = (String) key;</span><br><span class="line">            return super.put((K)lineToHump(mapKey),value);</span><br><span class="line">        &#125;</span><br><span class="line">        return super.put(key,value);</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 下划线转驼峰</span><br><span class="line">     *</span><br><span class="line">     * @param str</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static String lineToHump(String str) &#123;</span><br><span class="line">        if (StrUtil.isEmpty(str)) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        str = str.toLowerCase(Locale.ROOT);</span><br><span class="line">        StringBuffer buffer = new StringBuffer();</span><br><span class="line">        Matcher matcher = Pattern.compile(&quot;_(\\w)&quot;).matcher(str);</span><br><span class="line">        while (matcher.find()) &#123;</span><br><span class="line">            matcher.appendReplacement(buffer, matcher.group(1).toUpperCase(Locale.ROOT));</span><br><span class="line">        &#125;</span><br><span class="line">        matcher.appendTail(buffer);</span><br><span class="line">        return buffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mapper返回这个实体</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;select id=&quot;test&quot; resultType = &quot;com.boco.nbd.threshold.util.ToCamelCaseMap&quot;&gt;</span><br><span class="line">    select &#x27;1&#x27; AA_BB,&#x27;2&#x27; CC_DD from dual</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<h1 id="6-检验前端发送的实体BO"><a href="#6-检验前端发送的实体BO" class="headerlink" title="6.检验前端发送的实体BO"></a>6.检验前端发送的实体BO</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.iocoder.yudao.framework.common.util.validation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolation;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolationException;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Validator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 芋道源码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_URL = Pattern.compile(<span class="string">&quot;^(https?|ftp|file)://[-a-zA-Z0-9+&amp;@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&amp;@#/%=~_|]&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_XML_NCNAME = Pattern.compile(<span class="string">&quot;[a-zA-Z_][\\-_.0-9_a-zA-Z$]*&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMobile</span><span class="params">(String mobile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.length(mobile) != <span class="number">11</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// TODO 芋艿，后面完善手机校验</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isURL</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.hasText(url)</span><br><span class="line">                &amp;&amp; PATTERN_URL.matcher(url).matches();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isXmlNCName</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.hasText(str)</span><br><span class="line">                &amp;&amp; PATTERN_XML_NCNAME.matcher(str).matches();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主要看这个检验实体的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> validator</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groups</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Validator validator, Object object, Class&lt;?&gt;... groups)</span> </span>&#123;</span><br><span class="line">        Set&lt;ConstraintViolation&lt;Object&gt;&gt; constraintViolations = validator.validate(object, groups);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(constraintViolations)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(constraintViolations);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220411181239451.png" alt="image-20220411181239451"></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p><img src="/../img/image-20220411181352940.png" alt="image-20220411181352940"></p>
<p><img src="/../img/image-20220411181340224.png" alt="image-20220411181340224"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>方法工具类</tag>
      </tags>
  </entry>
  <entry>
    <title>rabbitmq</title>
    <url>/2021/11/30/RabbitMQ/</url>
    <content><![CDATA[<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816135809193.png" alt="image-20210816135809193"></p>
<p>遵循AMQP协议，给予Erlang语言开发的</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h3 id="1-新建-home-rabbitmq-把两个工具包上传"><a href="#1-新建-home-rabbitmq-把两个工具包上传" class="headerlink" title="1.新建/home/rabbitmq,把两个工具包上传"></a>1.新建/home/rabbitmq,把两个工具包上传</h3><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210810143010518.png" alt="image-20210810143010518"></p>
<h3 id="2-进入目录后，安装erlang"><a href="#2-进入目录后，安装erlang" class="headerlink" title="2.进入目录后，安装erlang"></a>2.进入目录后，安装erlang</h3><p>rpm -Uvh erlang-solutions-2.0-1.noarch.rpm</p>
<p>yum install -y erlang</p>
<p>erl -v 查看是否安装成功</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210810143302385.png" alt="image-20210810143302385"></p>
<p>yum install -y socat</p>
<h3 id="3-解压rabbitmq"><a href="#3-解压rabbitmq" class="headerlink" title="3.解压rabbitmq"></a>3.解压rabbitmq</h3><p>rpm -Uvh rabbitmq-server-3.8.13-1.el8.noarch.rpm </p>
<p>yum install rabbitmq-server -y</p>
<p>启动</p>
<p>systemctl start rabbitmq-server</p>
<p>查看状态</p>
<p>systemctl status rabbitmq-server</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210810143625388.png" alt="image-20210810143625388"></p>
<p>设置成开机自启动</p>
<p>systemctl enable rabbitmq-server</p>
<p>停止</p>
<p>systemctl stop rabbitmq-server</p>
<h1 id="rabbitmq管理页面"><a href="#rabbitmq管理页面" class="headerlink" title="rabbitmq管理页面"></a>rabbitmq管理页面</h1><p>1.默认是没有安装web端的客户端插件的，需要安装插件</p>
<p>rabbitmq-plugins enable rabbitmq_management</p>
<p>2.进入123.56.107.125:15672进入界面</p>
<p>ip：port（15672）</p>
<p>3.本机的话用guest guest</p>
<p>远程无法用guest访问</p>
<p>4.授权</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210810155959448.png" alt="image-20210810155959448"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210810160146769.png" alt="image-20210810160146769"></p>
<h1 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h1><h2 id="获取rabbit镜像"><a href="#获取rabbit镜像" class="headerlink" title="获取rabbit镜像"></a>获取rabbit镜像</h2><p>docker pull rabbit mq:management</p>
<h2 id="创建并运行-使用第2个"><a href="#创建并运行-使用第2个" class="headerlink" title="创建并运行,使用第2个"></a>创建并运行,使用第2个</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.docker run -di --name myrabbit -p 15672:15672 rabbitmq:management</span><br><span class="line"></span><br><span class="line">2.docker run -di --name myrabbit -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin -p 15672:15672 -p 5672:5672 -p 25672:25672 -p 61613:61613 -p 1883:1883 rabbitmq:3.8-management</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="启动镜像"><a href="#启动镜像" class="headerlink" title="启动镜像"></a>启动镜像</h2><p>docker run 镜像id</p>
<p>访问123.56.107.125:15672进入界面</p>
<p>输入admin admin</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813101323489.png" alt="image-20210813101323489"></p>
<h1 id="RabbitMQ分类"><a href="#RabbitMQ分类" class="headerlink" title="RabbitMQ分类"></a>RabbitMQ分类</h1><h2 id="1-none"><a href="#1-none" class="headerlink" title="1.none"></a>1.none</h2><p>不能访问</p>
<h2 id="2-management"><a href="#2-management" class="headerlink" title="2.management"></a>2.management</h2><p>只能查看自己的账号，仅仅查看</p>
<h2 id="3-policymaker"><a href="#3-policymaker" class="headerlink" title="3.policymaker"></a>3.policymaker</h2><p>可以创建一些</p>
<h2 id="4-Monitoring"><a href="#4-Monitoring" class="headerlink" title="4.Monitoring"></a>4.Monitoring</h2><p>可以查看所有人的信息</p>
<h2 id="5-administrator"><a href="#5-administrator" class="headerlink" title="5.administrator"></a>5.administrator</h2><p>可以查看，创建所有</p>
<h1 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a>简单模式</h1><p>不指定，默认交换机类型direct，这里的路由key就是队列的名字</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813150303417.png" alt="image-20210813150303417"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813103205937.png" alt="image-20210813103205937"></p>
<h2 id="原生"><a href="#原生" class="headerlink" title="原生"></a>原生</h2><h3 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1.导入依赖"></a>1.导入依赖</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;amqp-client&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.10.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">        <span class="comment">//ip port</span></span><br><span class="line">        <span class="comment">//1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接Connection，rabbitmq是基于channel而不是connection</span></span><br><span class="line">        Connection connection=<span class="keyword">null</span>;</span><br><span class="line">        Channel channel =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">            String queueName=<span class="string">&quot;queue1&quot;</span>;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            @param1路由key，简单模式下是队列的名称</span></span><br><span class="line"><span class="comment">            @param2是否持久化（存盘）,随着服务器的重启，队列持久化的还存在，不持久化的不存在</span></span><br><span class="line"><span class="comment">            非持久化会存盘吗，但是会随着服务器的重启数据丢失,</span></span><br><span class="line"><span class="comment">            @param3排他性，是否独占</span></span><br><span class="line"><span class="comment">            @param4是否自动删除，最后一个消费者消费完消费后是否把队列自动删除</span></span><br><span class="line"><span class="comment">            @param5额外的参数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.queueDeclare(queueName,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//5.创准备消息内容</span></span><br><span class="line">            String message=<span class="string">&quot;hello xiaojiang&quot;</span>;</span><br><span class="line">            <span class="comment">//6.发送消息给队列queue</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,queueName,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//7.关闭通道</span></span><br><span class="line">            <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//8.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后，发现在queues里有一个queue1队列并且ready可以消费1，总数1</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813112729797.png" alt="image-20210813112729797"></p>
<h3 id="consumer"><a href="#consumer" class="headerlink" title="consumer"></a>consumer</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">    <span class="comment">//ip port</span></span><br><span class="line">    <span class="comment">//1.创建连接工程</span></span><br><span class="line">    ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">    connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">    connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">    connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="comment">//2.创建连接Connection</span></span><br><span class="line">    Connection connection=<span class="keyword">null</span>;</span><br><span class="line">    Channel channel =<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">        <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">        channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//4.监听队列，应答：为true及消费以后消息消失</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="keyword">true</span>, <span class="keyword">new</span> DeliverCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;收到消息是&quot;</span>+<span class="keyword">new</span> String(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">new</span> CancelCallback()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;收到消息失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(<span class="string">&quot;开始接受消息&quot;</span>);</span><br><span class="line">        <span class="comment">//阻断，不往下运行</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//7.关闭通道</span></span><br><span class="line">        <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//8.关闭连接</span></span><br><span class="line">        <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者消费后，队列删除</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813114342375.png" alt="image-20210813114342375"></p>
<h1 id="fanout发布分发模式"><a href="#fanout发布分发模式" class="headerlink" title="fanout发布分发模式"></a>fanout发布分发模式</h1><p>没有路由key，绑定的队列里都会受到</p>
<p>交换机类型fanout</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813150219175.png" alt="image-20210813150219175"></p>
<h2 id="producer"><a href="#producer" class="headerlink" title="producer"></a>producer</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">    <span class="comment">//ip port</span></span><br><span class="line">    <span class="comment">//1.创建连接工程</span></span><br><span class="line">    ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">    connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">    connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">    connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="comment">//2.创建连接Connection</span></span><br><span class="line">    Connection connection=<span class="keyword">null</span>;</span><br><span class="line">    Channel channel =<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">        <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">        channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">        String queueName=<span class="string">&quot;queue1&quot;</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        @param1队列的名称</span></span><br><span class="line"><span class="comment">        @param2是否持久化（存盘）,随着服务器的重启，队列持久化的还存在，不持久化的不存在</span></span><br><span class="line"><span class="comment">        非持久化会存盘吗，但是会随着服务器的重启数据丢失,</span></span><br><span class="line"><span class="comment">        @param3排他性，是否独占</span></span><br><span class="line"><span class="comment">        @param4是否自动删除，最后一个消费者消费完消费后是否把队列自动删除</span></span><br><span class="line"><span class="comment">        @param5额外的参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueDeclare(queueName,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//5.创准备消息内容</span></span><br><span class="line">        String message=<span class="string">&quot;hello xiaojiang&quot;</span>;</span><br><span class="line">        <span class="comment">//准备交换机</span></span><br><span class="line">        String exchangeName=<span class="string">&quot;fanout-exchange&quot;</span>;</span><br><span class="line">        <span class="comment">//路由key</span></span><br><span class="line">        String routeKey=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//交换机类型</span></span><br><span class="line">        String type=<span class="string">&quot;fanout&quot;</span>;</span><br><span class="line">        <span class="comment">//6.发送消息给队列queue</span></span><br><span class="line">        channel.basicPublish(exchangeName,routeKey,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//7.关闭通道</span></span><br><span class="line">        <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//8.关闭连接</span></span><br><span class="line">        <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="consumer，用了多线程"><a href="#consumer，用了多线程" class="headerlink" title="consumer，用了多线程"></a>consumer，用了多线程</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Runnable runnable=<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">            <span class="comment">//ip port</span></span><br><span class="line">            <span class="comment">//1.创建连接工程</span></span><br><span class="line">            ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">            connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">            connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">            connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="comment">//获取队列的名称</span></span><br><span class="line">            <span class="keyword">final</span> String queueName=Thread.currentThread().getName();</span><br><span class="line">            <span class="comment">//2.创建连接Connection</span></span><br><span class="line">            Connection connection=<span class="keyword">null</span>;</span><br><span class="line">            Channel channel =<span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">                <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">                channel = connection.createChannel();</span><br><span class="line">                <span class="comment">//4.监听队列</span></span><br><span class="line">                channel.basicConsume(queueName, <span class="keyword">true</span>, <span class="keyword">new</span> DeliverCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;收到消息是&quot;</span>+<span class="keyword">new</span> String(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,<span class="keyword">new</span> CancelCallback()&#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;收到消息失败&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                System.out.println(<span class="string">&quot;开始接受消息&quot;</span>);</span><br><span class="line">                <span class="comment">//阻断，不往下运行</span></span><br><span class="line">                System.in.read();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//7.关闭通道</span></span><br><span class="line">                <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//8.关闭连接</span></span><br><span class="line">                <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        connection.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable,<span class="string">&quot;queue1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable,<span class="string">&quot;queue2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable,<span class="string">&quot;queue3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="direct路由模式"><a href="#direct路由模式" class="headerlink" title="direct路由模式"></a>direct路由模式</h1><p>交换机类型direct，并且绑定路由key</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813145824267.png" alt="image-20210813145824267"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813150023476.png" alt="image-20210813150023476"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813150101792.png" alt="image-20210813150101792"></p>
<p>此时直发送到queue1和queue3里了</p>
<h2 id="producer-1"><a href="#producer-1" class="headerlink" title="producer"></a>producer</h2><p>仅部分与fanout不一致</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//准备交换机</span></span><br><span class="line">String exchangeName=<span class="string">&quot;direct-exchange&quot;</span>;</span><br><span class="line"><span class="comment">//路由key</span></span><br><span class="line">String routeKey=<span class="string">&quot;email&quot;</span>;</span><br><span class="line"><span class="comment">//交换机类型</span></span><br><span class="line">String type=<span class="string">&quot;direct&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h2><p>与fanout完全一致</p>
<h1 id="topics主题模式"><a href="#topics主题模式" class="headerlink" title="topics主题模式"></a>topics主题模式</h1><p>支持模糊匹配的路由key，交换机类型topic</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813150431407.png" alt="image-20210813150431407"></p>
<p>#：0个或多个</p>
<p>*：只匹配一个词</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813150539645.png" alt="image-20210813150539645"></p>
<h2 id="producer-2"><a href="#producer-2" class="headerlink" title="producer"></a>producer</h2><p>仅部分与fanout不一致</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//5.创准备消息内容</span></span><br><span class="line">String message=<span class="string">&quot;hello xiaojiang&quot;</span>;</span><br><span class="line"><span class="comment">//准备交换机</span></span><br><span class="line">String exchangeName=<span class="string">&quot;topic-exchange&quot;</span>;</span><br><span class="line"><span class="comment">//路由key,模糊匹配</span></span><br><span class="line">String routeKey=<span class="string">&quot;com.order&quot;</span>;</span><br><span class="line"><span class="comment">//交换机类型</span></span><br><span class="line">String type=<span class="string">&quot;topic&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Consumer-1"><a href="#Consumer-1" class="headerlink" title="Consumer"></a>Consumer</h2><p>与fanout完全一致</p>
<h1 id="headers模式"><a href="#headers模式" class="headerlink" title="headers模式"></a>headers模式</h1><p>交换机类型headers</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813151433859.png" alt="image-20210813151433859"></p>
<p>参数</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813151458072.png" alt="image-20210813151458072"></p>
<p>发送消息时，带参数，如果参数匹配就会发送到相应的队列,不用指定路由key</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813151545053.png" alt="image-20210813151545053"></p>
<h1 id="完整的开发过程"><a href="#完整的开发过程" class="headerlink" title="完整的开发过程"></a>完整的开发过程</h1><p>不用图形化界面，用代码创建交换机，队列，绑定关系</p>
<h2 id="producer-3"><a href="#producer-3" class="headerlink" title="producer"></a>producer</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.direct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/13  10:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:简单模式simple</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">        <span class="comment">//ip port</span></span><br><span class="line">        <span class="comment">//1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接Connection</span></span><br><span class="line">        Connection connection=<span class="keyword">null</span>;</span><br><span class="line">        Channel channel =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">            String queueName=<span class="string">&quot;queue1&quot;</span>;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            @param1队列的名称</span></span><br><span class="line"><span class="comment">            @param2是否持久化（存盘）,随着服务器的重启，队列持久化的还存在，不持久化的不存在</span></span><br><span class="line"><span class="comment">            非持久化会存盘吗，但是会随着服务器的重启数据丢失,</span></span><br><span class="line"><span class="comment">            @param3排他性，是否独占</span></span><br><span class="line"><span class="comment">            @param4是否自动删除，最后一个消费者消费完消费后是否把队列自动删除</span></span><br><span class="line"><span class="comment">            @param5额外的参数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.queueDeclare(queueName,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//5.创准备消息内容</span></span><br><span class="line">            String message=<span class="string">&quot;hello xiaojiang&quot;</span>;</span><br><span class="line">            <span class="comment">//准备交换机</span></span><br><span class="line">            String exchangeName=<span class="string">&quot;direct-exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//交换机类型</span></span><br><span class="line">            String type=<span class="string">&quot;direct&quot;</span>;</span><br><span class="line">            <span class="comment">//创建交换机，名称，类型，是否持久化，服务器重启后，交换机是否删除</span></span><br><span class="line">            channel.exchangeDeclare(exchangeName,type,<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//声明队列,名称，是否持久化，是否排他性，是否自动删除，参数</span></span><br><span class="line">            channel.queueDeclare(<span class="string">&quot;queue1&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">            channel.queueDeclare(<span class="string">&quot;queue2&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//绑定交换机与队列,队列名称，交换机名称，路由key</span></span><br><span class="line">            channel.queueBind(<span class="string">&quot;queue1&quot;</span>,exchangeName,<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            channel.queueBind(<span class="string">&quot;queue2&quot;</span>,exchangeName,<span class="string">&quot;course&quot;</span>);</span><br><span class="line">            <span class="comment">//6.发送消息给队列queue</span></span><br><span class="line">            channel.basicPublish(exchangeName,<span class="string">&quot;order&quot;</span>,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//7.关闭通道</span></span><br><span class="line">            <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//8.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Consumer-2"><a href="#Consumer-2" class="headerlink" title="Consumer"></a>Consumer</h2><p>与fanout完全一致</p>
<h1 id="work工作队列-公平分发"><a href="#work工作队列-公平分发" class="headerlink" title="work工作队列-公平分发"></a>work工作队列-公平分发</h1><p>根据消费者的消费能力，处理的快的分到的多，能者多劳</p>
<h2 id="Producer-1"><a href="#Producer-1" class="headerlink" title="Producer"></a>Producer</h2><p>与轮训完全一致</p>
<h2 id="Consumer1"><a href="#Consumer1" class="headerlink" title="Consumer1"></a>Consumer1</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.work.fenfa;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/13  10:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">        <span class="comment">//ip port</span></span><br><span class="line">        <span class="comment">//1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接Connection</span></span><br><span class="line">        Connection connection=<span class="keyword">null</span>;</span><br><span class="line">        Channel channel =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">//指标，qos=1，每次从队列里取多少条数据</span></span><br><span class="line">            channel.basicQos(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">            Channel finalChannel = channel;</span><br><span class="line">            channel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="keyword">false</span>, <span class="keyword">new</span> DeliverCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer1收到消息是&quot;</span>+<span class="keyword">new</span> String(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                        finalChannel.basicAck(delivery.getEnvelope().getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="keyword">new</span> CancelCallback()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer1收到消息失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;consumer1开始接受消息&quot;</span>);</span><br><span class="line">            <span class="comment">//阻断，不往下运行</span></span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//7.关闭通道</span></span><br><span class="line">            <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//8.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Consumer2"><a href="#Consumer2" class="headerlink" title="Consumer2"></a>Consumer2</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.work.fenfa;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/13  10:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">        <span class="comment">//ip port</span></span><br><span class="line">        <span class="comment">//1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接Connection</span></span><br><span class="line">        Connection connection=<span class="keyword">null</span>;</span><br><span class="line">        Channel channel =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            channel.basicQos(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">            Channel finalChannel = channel;</span><br><span class="line">            channel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="keyword">false</span>, <span class="keyword">new</span> DeliverCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer1收到消息是&quot;</span>+<span class="keyword">new</span> String(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                        finalChannel.basicAck(delivery.getEnvelope().getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="keyword">new</span> CancelCallback()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer2收到消息失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;consumer2开始接受消息&quot;</span>);</span><br><span class="line">            <span class="comment">//阻断，不往下运行</span></span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//7.关闭通道</span></span><br><span class="line">            <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//8.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建队列queue1以后，运行consumer1和consumer2，在运行producer。结果为下图</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813162255264.png" alt="image-20210813162255264"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813162302814.png" alt="image-20210813162302814"></p>
<p>因为cousumer1休眠时间为200ms，而consumer2为2s，所以消费的多</p>
<h1 id="work工作队列-轮训"><a href="#work工作队列-轮训" class="headerlink" title="work工作队列-轮训"></a>work工作队列-轮训</h1><p>一个消费者一条，按均分配</p>
<h2 id="Producer-2"><a href="#Producer-2" class="headerlink" title="Producer"></a>Producer</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.work.lunxun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/13  10:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:简单模式simple</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">        <span class="comment">//ip port</span></span><br><span class="line">        <span class="comment">//1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接Connection</span></span><br><span class="line">        Connection connection=<span class="keyword">null</span>;</span><br><span class="line">        Channel channel =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">            String queueName=<span class="string">&quot;queue1&quot;</span>;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            @param1队列的名称</span></span><br><span class="line"><span class="comment">            @param2是否持久化（存盘）,随着服务器的重启，队列持久化的还存在，不持久化的不存在</span></span><br><span class="line"><span class="comment">            非持久化会存盘吗，但是会随着服务器的重启数据丢失,</span></span><br><span class="line"><span class="comment">            @param3排他性，是否独占</span></span><br><span class="line"><span class="comment">            @param4是否自动删除，最后一个消费者消费完消费后是否把队列自动删除</span></span><br><span class="line"><span class="comment">            @param5额外的参数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.queueDeclare(queueName,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//5.创准备消息内容</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                String message=<span class="string">&quot;hello xiaojiang&quot;</span>+i;</span><br><span class="line">                <span class="comment">//6.发送消息给队列queue</span></span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>,queueName,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//7.关闭通道</span></span><br><span class="line">            <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//8.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Consumer1-1"><a href="#Consumer1-1" class="headerlink" title="Consumer1"></a>Consumer1</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.work.lunxun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/13  10:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">        <span class="comment">//ip port</span></span><br><span class="line">        <span class="comment">//1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接Connection</span></span><br><span class="line">        Connection connection=<span class="keyword">null</span>;</span><br><span class="line">        Channel channel =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">          </span><br><span class="line">            <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">            channel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="keyword">true</span>, <span class="keyword">new</span> DeliverCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer1收到消息是&quot;</span>+<span class="keyword">new</span> String(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="keyword">new</span> CancelCallback()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer1收到消息失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;consumer1开始接受消息&quot;</span>);</span><br><span class="line">            <span class="comment">//阻断，不往下运行</span></span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//7.关闭通道</span></span><br><span class="line">            <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//8.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Consumer2-1"><a href="#Consumer2-1" class="headerlink" title="Consumer2"></a>Consumer2</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.work.lunxun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/13  10:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//所有的中间件技术都是基于tcp、ip协议基础之上的，rabbitmq是amqp协议</span></span><br><span class="line">        <span class="comment">//ip port</span></span><br><span class="line">        <span class="comment">//1.创建连接工程</span></span><br><span class="line">        ConnectionFactory connectionFactory=<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;123.56.107.125&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接Connection</span></span><br><span class="line">        Connection connection=<span class="keyword">null</span>;</span><br><span class="line">        Channel channel =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection=connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">//3.通过连接获取通道Channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">           </span><br><span class="line">            <span class="comment">//4.创通过创建交换机，声明队列，绑定关系，路由key，发送消息，接收消息</span></span><br><span class="line">            channel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="keyword">true</span>, <span class="keyword">new</span> DeliverCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer2收到消息是&quot;</span>+<span class="keyword">new</span> String(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="keyword">new</span> CancelCallback()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumer2收到消息失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;consumer2开始接受消息&quot;</span>);</span><br><span class="line">            <span class="comment">//阻断，不往下运行</span></span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//7.关闭通道</span></span><br><span class="line">            <span class="keyword">if</span>(channel!=<span class="keyword">null</span>&amp;&amp;channel.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//8.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span>(connection!=<span class="keyword">null</span>&amp;&amp;connection.isOpen())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建队列queue1以后，运行consumer1和consumer2，在运行producer。结果为下图</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813161154457.png" alt="image-20210813161154457"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210813161206199.png" alt="image-20210813161206199"></p>
<p>发现是轮训，注意每个消费者代码里</p>
<p>channel.basicConsume(“queue1”, true</p>
<p>应答方式应为true自动应答</p>
<h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><p>解耦，削峰，异步</p>
<h1 id="springboot整合"><a href="#springboot整合" class="headerlink" title="springboot整合"></a>springboot整合</h1><h2 id="1-导入依赖-1"><a href="#1-导入依赖-1" class="headerlink" title="1.导入依赖"></a>1.导入依赖</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.5</span><span class="number">.3</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-application-yml"><a href="#2-application-yml" class="headerlink" title="2.application.yml"></a>2.application.yml</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">123.56</span><span class="number">.107</span><span class="number">.125</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br></pre></td></tr></table></figure>

<h2 id="3-以下背景"><a href="#3-以下背景" class="headerlink" title="3.以下背景"></a>3.以下背景</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816091632880.png" alt="image-20210816091632880"></p>
<h1 id="springb-fanout模式"><a href="#springb-fanout模式" class="headerlink" title="springb-fanout模式"></a>springb-fanout模式</h1><h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><p>service层</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/16  8:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeOrder</span><span class="params">(String userId,String productId,<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        String orderId= UUID.randomUUID().toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;订单生产成功：+&quot;</span>+orderId);</span><br><span class="line">        <span class="comment">//3.通过消息队列完成消息的分发</span></span><br><span class="line">        <span class="comment">//param1:交换机，param2：路由key，param3：消息内容</span></span><br><span class="line">        String exchangeName=<span class="string">&quot;fanout-order-exchange&quot;</span>;</span><br><span class="line">        String routingKey=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>springboot完成绑定关系是在配置类中，不是自己写之前的绑定代码了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.FanoutExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/16  8:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.声明注册fanout模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">fanoutExchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(<span class="string">&quot;fanout-order-exchange&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.声明队列sms.fanout.queue,email.fanout.queue,duanxin.fanout.queue</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">smsQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;sms.fanout.queue&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">emailQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;email.fanout.queue&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">duanxinQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;duanxin.fanout.queue&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.完成交换机与队列之间的绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">smsBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(smsQueue()).to(fanoutExchange());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">emailBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(emailQueue()).to(fanoutExchange());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">duanxinBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(duanxinQueue()).to(fanoutExchange());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类点击运行</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816091453078.png" alt="image-20210816091453078"></p>
<p>发现在rabbitmq图形化界面上生成队列和交换机</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816091514504.png" alt="image-20210816091514504"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816091525841.png" alt="image-20210816091525841"></p>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><p>service层三个</p>
<p>message参数可以理解为队列中的消息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;duanxin.fanout.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">duanxinConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reviceMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;duanxin-fanout接受到了消息&quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;email.fanout.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reviceMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;email-fanout接受到了消息&quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;sms.fanout.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reviceMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;sms-fanout接受到了消息&quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行RabbitmqConsumerApplication，接受到消息</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816094006858.png" alt="image-20210816094006858"></p>
<h1 id="springb-direct模式"><a href="#springb-direct模式" class="headerlink" title="springb-direct模式"></a>springb-direct模式</h1><h2 id="生产者-1"><a href="#生产者-1" class="headerlink" title="生产者"></a>生产者</h2><p>orderService里修改交换机名字，并设置路由key</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String exchangeName=<span class="string">&quot;direct-order-exchange&quot;</span>;</span><br><span class="line"><span class="comment">//只发送到邮件和短信的队列</span></span><br><span class="line">rabbitTemplate.convertAndSend(exchangeName,<span class="string">&quot;email&quot;</span>,orderId);</span><br><span class="line">rabbitTemplate.convertAndSend(exchangeName,<span class="string">&quot;duanxin&quot;</span>,orderId);</span><br></pre></td></tr></table></figure>

<p>config里修改交换机和队列的名字，把fanout变为direct，并设置路由key</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816095016857.png" alt="image-20210816095016857"></p>
<p>测试后发现，生成了三个direct队列，并且仅仅email和短信接收到消息</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816095117338.png" alt="image-20210816095117338"></p>
<h2 id="消费者-1"><a href="#消费者-1" class="headerlink" title="消费者"></a>消费者</h2><p>仅需要改三个service里的@RabbitListener注解，把fanout改为direct即可</p>
<p>运行application后，email和短信接收到消息</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816095249772.png" alt="image-20210816095249772"></p>
<h1 id="springb-topic模式"><a href="#springb-topic模式" class="headerlink" title="springb-topic模式"></a>springb-topic模式</h1><h2 id="消费者-2"><a href="#消费者-2" class="headerlink" title="消费者"></a>消费者</h2><p>通过注解方式修改三个service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value =@Queue(value = &quot;duanxin.topic.queue&quot;,durable = &quot;true&quot;,autoDelete = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;topic-order-exchange&quot;,type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key =&quot;#.duanxin.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">duanxinConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reviceMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;duanxin-topic&quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动消费者项目，发现创建了队列</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816101450933.png" alt="image-20210816101450933"></p>
<h2 id="生产者-2"><a href="#生产者-2" class="headerlink" title="生产者"></a>生产者</h2><p>因为在消费者注解里配置了队列绑定关系，所以生产者不需要config了</p>
<p>，只需要在service层配置路由key</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816101929261.png" alt="image-20210816101929261"></p>
<p>测试发送后，发现消费者线程接受到了消息</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816101840062.png" alt="image-20210816101840062"></p>
<h1 id="思考？"><a href="#思考？" class="headerlink" title="思考？"></a>思考？</h1><h2 id="绑定关系写在生产者还是消费者？"><a href="#绑定关系写在生产者还是消费者？" class="headerlink" title="绑定关系写在生产者还是消费者？"></a>绑定关系写在生产者还是消费者？</h2><p>绑定并创建的配置文件，最好写在消费者里，因为队列是直接与消费者打交道的</p>
<h2 id="通过注解还是配置文件声明？"><a href="#通过注解还是配置文件声明？" class="headerlink" title="通过注解还是配置文件声明？"></a>通过注解还是配置文件声明？</h2><p>最好是配置文件，因为配置文件更完善，更高级的比如死信队列等都是基于配置文件配置的</p>
<h1 id="ttl队列过期时间"><a href="#ttl队列过期时间" class="headerlink" title="ttl队列过期时间"></a>ttl队列过期时间</h1><h2 id="生产者-3"><a href="#生产者-3" class="headerlink" title="生产者"></a>生产者</h2><p>config，给队列里的消息设置过期时间</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TTLRabbitMqConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.声明注册Direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">ttldirectExchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(<span class="string">&quot;ttl-direct-order-exchange&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.声明队列sms.Direct.queue,email.Direct.queue,duanxin.Direct.queue</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">ttlQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//设置过期时间</span></span><br><span class="line">        Map&lt;String,Object&gt; args=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>,<span class="number">5000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;sms.ttldirect.queue&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.完成交换机与队列之间的绑定关系</span></span><br><span class="line">    <span class="comment">//如果key都一样的话，那么就是fanout广播模式</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">ttlSmsBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(ttlQueue()).to(ttldirectExchange()).with(<span class="string">&quot;ttl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816104834904.png" alt="image-20210816104834904"></p>
<h1 id="ttl消息过期时间"><a href="#ttl消息过期时间" class="headerlink" title="ttl消息过期时间"></a>ttl消息过期时间</h1><h2 id="消费者-3"><a href="#消费者-3" class="headerlink" title="消费者"></a>消费者</h2><p>config</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TTLRabbitMqConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.声明注册Direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">ttldirectExchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(<span class="string">&quot;ttl-direct-order-exchange&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.声明队列sms.Direct.queue,email.Direct.queue,duanxin.Direct.queue</span></span><br><span class="line">    <span class="comment">//设置消息过期</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">ttlMessageQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;sms.ttl.message.direct.queue&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.完成交换机与队列之间的绑定关系</span></span><br><span class="line">    <span class="comment">//如果key都一样的话，那么就是fanout广播模式</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">ttlSmsBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(ttlMessageQueue()).to(ttldirectExchange()).with(<span class="string">&quot;ttlMessage&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeOrder</span><span class="params">(String userId,String productId,<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        String orderId= UUID.randomUUID().toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;订单生产成功：+&quot;</span>+orderId);</span><br><span class="line">        <span class="comment">//3.通过消息队列完成消息的分发</span></span><br><span class="line">        <span class="comment">//param1:交换机，param2：路由key，param3：消息内容</span></span><br><span class="line">        String exchangeName=<span class="string">&quot;ttl-direct-order-exchange&quot;</span>;</span><br><span class="line">        String routingKey=<span class="string">&quot;ttlMessage&quot;</span>;</span><br><span class="line">        <span class="comment">//给消息设置过去时间</span></span><br><span class="line">        MessagePostProcessor messagePostProcessor=<span class="keyword">new</span> MessagePostProcessor() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Message <span class="title">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException </span>&#123;</span><br><span class="line">                message.getMessageProperties().setExpiration(<span class="string">&quot;3000&quot;</span>);</span><br><span class="line">                message.getMessageProperties().setContentEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId,messagePostProcessor);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><p>队列过期和消息过期在一个队列时，以时间小的为准</p>
<p>并且队列过期的消息会到死信队列，消息过期的不会</p>
<h1 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h1><h2 id="1-生产者声明一个死信队列"><a href="#1-生产者声明一个死信队列" class="headerlink" title="1.生产者声明一个死信队列"></a>1.生产者声明一个死信队列</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadRabbitMqConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.声明注册Direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">deadExchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(<span class="string">&quot;dead-exchange&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.声明队列sms.Direct.queue,email.Direct.queue,duanxin.Direct.queue</span></span><br><span class="line">    <span class="comment">//设置消息过期</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">deadQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;dead.queue&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.完成交换机与队列之间的绑定关系</span></span><br><span class="line">    <span class="comment">//如果key都一样的话，那么就是fanout广播模式</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">deadBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(deadQueue()).to(deadExchange()).with(<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-声明一个普通交换机并绑定死信队列交换机"><a href="#2-声明一个普通交换机并绑定死信队列交换机" class="headerlink" title="2.声明一个普通交换机并绑定死信队列交换机"></a>2.声明一个普通交换机并绑定死信队列交换机</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TTLRabbitMqConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.声明注册Direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">ttldirectExchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(<span class="string">&quot;ttl-direct-order-exchange&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.声明队列sms.Direct.queue,email.Direct.queue,duanxin.Direct.queue</span></span><br><span class="line">    <span class="comment">//设置消息过期</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">ttlMessageQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; args=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>,<span class="number">3000</span>);</span><br><span class="line">        <span class="comment">//绑定死信队列的交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,<span class="string">&quot;dead-exchange&quot;</span>);</span><br><span class="line">        <span class="comment">//绑定死信队列的路由key,如果是fanout模式就，就不用配置</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;sms.ttl.message.direct.queue&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.完成交换机与队列之间的绑定关系</span></span><br><span class="line">    <span class="comment">//如果key都一样的话，那么就是fanout广播模式</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">ttlSmsBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(ttlMessageQueue()).to(ttldirectExchange()).with(<span class="string">&quot;ttlMessage&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时3秒之后，信息就会到死信队列里，也可以设置数量，如果设置普通队列是5个，但发送了10个信息，从第6个开始就会去死信队列里</p>
<h1 id="内存大小"><a href="#内存大小" class="headerlink" title="内存大小"></a>内存大小</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816141006073.png" alt="image-20210816141006073"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816141021209.png" alt="image-20210816141021209"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816141258748.png" alt="image-20210816141258748"></p>
<p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816141615719.png" alt="image-20210816141615719"></p>
<h1 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h1><h1 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h1><h1 id="消息确认机制"><a href="#消息确认机制" class="headerlink" title="消息确认机制"></a>消息确认机制</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816151039170.png" alt="image-20210816151039170"></p>
<h2 id="生产的回调接口"><a href="#生产的回调接口" class="headerlink" title="生产的回调接口"></a>生产的回调接口</h2><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816151405179.png" alt="image-20210816151405179"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jiang.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:jiangjiaxu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/08/16  15:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>:V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCallBack</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//注入</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String s)</span> </span>&#123;</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span>(ack)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;交换机收到了消息&quot;</span>);   </span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;交换机没有收到消息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="生产者发送"><a href="#生产者发送" class="headerlink" title="生产者发送"></a>生产者发送</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeOrder</span><span class="params">(String userId,String productId,<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="comment">//通过回调函数判断id是否为一个</span></span><br><span class="line">        CorrelationData correlationData=<span class="keyword">new</span> CorrelationData(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        String orderId= UUID.randomUUID().toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;订单生产成功：+&quot;</span>+orderId);</span><br><span class="line">        <span class="comment">//3.通过消息队列完成消息的分发</span></span><br><span class="line">        <span class="comment">//param1:交换机，param2：路由key，param3：消息内容</span></span><br><span class="line">        String exchangeName=<span class="string">&quot;ttl-direct-order-exchange&quot;</span>;</span><br><span class="line">        String routingKey=<span class="string">&quot;ttlMessage&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId,correlationData);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="回退（当发送不到队列时，返回消息给生产者）"><a href="#回退（当发送不到队列时，返回消息给生产者）" class="headerlink" title="回退（当发送不到队列时，返回消息给生产者）"></a>回退（当发送不到队列时，返回消息给生产者）</h2><h3 id="1-配置文件添加"><a href="#1-配置文件添加" class="headerlink" title="1.配置文件添加"></a>1.配置文件添加</h3><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816153035383.png" alt="image-20210816153035383"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCallBack</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span>,<span class="title">RabbitTemplate</span>.<span class="title">ReturnsCallback</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//注入</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在消息传递中不可达目的地的时候返回给生产者</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(ReturnedMessage returnedMessage)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消息&#123;&#125;，被交换机&#123;&#125;退回，退回原因：&#123;&#125;，路由key：&#123;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;new String(returnedMessage.getMessage().getBody())&quot;</span>+</span><br><span class="line">                returnedMessage.getExchange()+</span><br><span class="line">                returnedMessage.getReplyText()+</span><br><span class="line">                returnedMessage.getRoutingKey());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, java.lang.String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ack)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;交换机收到了消息&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;交换机没有收到消息&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="重发机制"><a href="#重发机制" class="headerlink" title="重发机制"></a>重发机制</h1><p><img src="/C:/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210816154027620.png" alt="image-20210816154027620"></p>
<p>acknowledge-mode默认是none自动ack</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;order.queue&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageconsumer</span><span class="params">(String ordermsg, Channel channel,</span></span></span><br><span class="line"><span class="params"><span class="function">                            CorrelationData correlationData,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="keyword">long</span> tag)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1:获取消息队列的消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;收到MQ的消息是: &quot;</span> + ordermsg + <span class="string">&quot;,count = &quot;</span> + count++);</span><br><span class="line">        <span class="comment">//  2: 获取订单服务的信息</span></span><br><span class="line">        Order order = JsonUtil.string2Obj(ordermsg, Order.class);</span><br><span class="line">        <span class="comment">// 3: 获取订单id</span></span><br><span class="line">        String orderId = order.getOrderId();</span><br><span class="line">        <span class="comment">// 4：保存运单</span></span><br><span class="line">        dispatchService.dispatch(orderId);</span><br><span class="line">        <span class="comment">// 3：手动ack告诉mq消息已经正常消费</span></span><br><span class="line">        System.out.println(<span class="number">1</span> / <span class="number">0</span>); <span class="comment">//出现异常</span></span><br><span class="line"></span><br><span class="line">        channel.basicAck(tag, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="comment">//如果出现异常的情况下,根据实际的情况去进行重发</span></span><br><span class="line">        <span class="comment">//重发一次后，丢失，还是日记，存库根据自己的业务场景去决定</span></span><br><span class="line">        <span class="comment">//参数1：消息的tag  参数2：false 多条处理 参数3：requeue 重发</span></span><br><span class="line">        </span><br><span class="line">        channel.basicNack(tag, <span class="keyword">false</span>, <span class="keyword">false</span>);<span class="comment">// 死信队列</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>rabbitmq</tag>
      </tags>
  </entry>
  <entry>
    <title>ELK</title>
    <url>/2021/11/30/ELK/</url>
    <content><![CDATA[<h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ELK是包含但不限于Elasticsearch（简称es）、Logstash、Kibana 三个开源软件的组成的一个整体。这三个软件合成ELK。</span><br><span class="line">是用于数据抽取（Logstash）</span><br><span class="line">搜索分析（Elasticsearch）</span><br><span class="line">数据展现（Kibana）的一整套解决方案</span><br><span class="line">所以也称作ELK stack。</span><br></pre></td></tr></table></figure>

<p>ELK是旧的称呼，Elastic Stack是新的名字</p>
<h1 id="2-elasticsearch核心概念-vs-数据库核心概念"><a href="#2-elasticsearch核心概念-vs-数据库核心概念" class="headerlink" title="2.elasticsearch核心概念 vs. 数据库核心概念"></a>2.elasticsearch核心概念 vs. 数据库核心概念</h1><table>
<thead>
<tr>
<th><strong>关系型数据库（比如Mysql）</strong></th>
<th><strong>非关系型数据库（Elasticsearch）</strong></th>
</tr>
</thead>
<tbody><tr>
<td>数据库Database</td>
<td>索引Index</td>
</tr>
<tr>
<td>表Table</td>
<td>索引Index（原为Type）</td>
</tr>
<tr>
<td>数据行Row</td>
<td>文档Document</td>
</tr>
<tr>
<td>数据列Column</td>
<td>字段Field</td>
</tr>
<tr>
<td>约束 Schema</td>
<td>映射Mapping</td>
</tr>
</tbody></table>
<h1 id="3-Elasticsearch相关软件安装"><a href="#3-Elasticsearch相关软件安装" class="headerlink" title="3.Elasticsearch相关软件安装"></a>3.Elasticsearch相关软件安装</h1><h2 id="1-Windows安装elasticsearch"><a href="#1-Windows安装elasticsearch" class="headerlink" title="1.Windows安装elasticsearch"></a>1.Windows安装elasticsearch</h2><h3 id="1、安装JDK，至少1-8-0-73以上版本，验证：java-version。"><a href="#1、安装JDK，至少1-8-0-73以上版本，验证：java-version。" class="headerlink" title="1、安装JDK，至少1.8.0_73以上版本，验证：java -version。"></a>1、安装JDK，至少1.8.0_73以上版本，验证：java -version。</h3><h3 id="2、下载和解压缩Elasticsearch安装包，查看目录结构。"><a href="#2、下载和解压缩Elasticsearch安装包，查看目录结构。" class="headerlink" title="2、下载和解压缩Elasticsearch安装包，查看目录结构。"></a>2、下载和解压缩Elasticsearch安装包，查看目录结构。</h3><p><a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<p>bin：脚本目录，包括：启动、停止等可执行脚本</p>
<p>config：配置文件目录</p>
<p>data：索引目录，存放索引文件的地方</p>
<p>logs：日志目录</p>
<p>modules：模块目录，包括了es的功能模块</p>
<p>plugins :插件目录，es支持插件机制</p>
<h3 id="3-config下的"><a href="#3-config下的" class="headerlink" title="3.config下的"></a>3.config下的</h3><h4 id="elasticsearch-yml"><a href="#elasticsearch-yml" class="headerlink" title="elasticsearch.yml"></a>elasticsearch.yml</h4><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> </span><br><span class="line">	<span class="string">配置elasticsearch的集群名称，默认是elasticsearch。建议修改成一个有意义的名称。</span></span><br><span class="line"><span class="attr">node.name:</span></span><br><span class="line">	<span class="string">节点名，通常一台物理服务器就是一个节点，es会默认随机指定一个名字，建议指定一个有意义的名称，方便管理</span></span><br><span class="line">	<span class="string">一个或多个节点组成一个cluster集群，集群是一个逻辑的概念，节点是物理概念，后边章节会详细介绍。</span></span><br><span class="line"><span class="attr">path.conf:</span> </span><br><span class="line">	<span class="string">设置配置文件的存储路径，tar或zip包安装默认在es根目录下的config文件夹，rpm安装默认在/etc/</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">path.data:</span></span><br><span class="line">	<span class="string">设置索引数据的存储路径，默认是es根目录下的data文件夹，可以设置多个存储路径，用逗号隔开。</span></span><br><span class="line"><span class="attr">path.logs:</span></span><br><span class="line">	<span class="string">设置日志文件的存储路径，默认是es根目录下的logs文件夹</span></span><br><span class="line"><span class="attr">path.plugins:</span> </span><br><span class="line">	<span class="string">设置插件的存放路径，默认是es根目录下的plugins文件夹</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line">	<span class="string">设置为true可以锁住ES使用的内存，避免内存与swap分区交换数据。</span></span><br><span class="line"><span class="attr">network.host:</span> </span><br><span class="line">	<span class="string">设置绑定主机的ip地址，设置为0.0.0.0表示绑定任何ip，允许外网访问，生产环境建议设置为具体的ip。</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line">	<span class="string">设置对外服务的http端口，默认为9200。</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9300</span>  <span class="string">集群结点之间通信端口</span></span><br><span class="line"><span class="attr">node.master:</span> </span><br><span class="line">	<span class="string">指定该节点是否有资格被选举成为master结点，默认是true，如果原来的master宕机会重新选举新的master。</span></span><br><span class="line"><span class="attr">node.data:</span> </span><br><span class="line">	<span class="string">指定该节点是否存储索引数据，默认为true。</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;host1:port&quot;</span>, <span class="string">&quot;host2:port&quot;</span>, <span class="string">&quot;...&quot;</span>]</span><br><span class="line">	<span class="string">设置集群中master节点的初始列表。</span></span><br><span class="line"><span class="attr">discovery.zen.ping.timeout:</span> <span class="string">3s</span></span><br><span class="line">	<span class="string">设置ES自动发现节点连接超时的时间，默认为3秒，如果网络延迟高可设置大些。</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span></span><br><span class="line">	<span class="string">主结点数量的最少值</span> <span class="string">,此值的公式为：(master_eligible_nodes</span> <span class="string">/</span> <span class="number">2</span><span class="string">)</span> <span class="string">+</span> <span class="number">1</span> <span class="string">，比如：有3个符合要求的主结点，那么这里要设置为2。</span></span><br><span class="line"><span class="attr">node.max_local_storage_nodes:</span> </span><br><span class="line">	<span class="string">单机允许的最大存储结点数，通常单机启动一个结点建议设置为1，开发环境如果单机启动多个节点可设置大于1。</span></span><br></pre></td></tr></table></figure>

<h4 id="jvm-options"><a href="#jvm-options" class="headerlink" title="jvm.options"></a><strong>jvm.options</strong></h4><p>设置最小及最大的JVM堆内存大小：</p>
<p>在jvm.options中设置 -Xms和-Xmx：</p>
<p>1） 两个值设置为相等</p>
<p>2） 将Xmx 设置为不超过物理内存的一半。</p>
<p><img src="/../img/image-20220224083915504.png" alt="image-20220224083915504"></p>
<h4 id="log4j2-properties"><a href="#log4j2-properties" class="headerlink" title="log4j2.properties"></a><strong>log4j2.properties</strong></h4><p>日志文件设置，ES使用log4j，注意日志级别的配置</p>
<h3 id="4、启动Elasticsearch：bin-elasticsearch-bat，es的特点就是开箱即，无需配置，启动即可。"><a href="#4、启动Elasticsearch：bin-elasticsearch-bat，es的特点就是开箱即，无需配置，启动即可。" class="headerlink" title="4、启动Elasticsearch：bin\elasticsearch.bat，es的特点就是开箱即，无需配置，启动即可。"></a>4、启动Elasticsearch：bin\elasticsearch.bat，es的特点就是开箱即，无需配置，启动即可。</h3><p>注意：es7 windows版本不支持机器学习，所以elasticsearch.yml中添加如下几个参数：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span>  </span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>]  </span><br><span class="line"><span class="attr">xpack.ml.enabled:</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">/.*/</span></span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220224084124648.png" alt="image-20220224084124648"></p>
<h3 id="5、检查ES是否启动成功：浏览器访问http-localhost-9200-Pretty"><a href="#5、检查ES是否启动成功：浏览器访问http-localhost-9200-Pretty" class="headerlink" title="5、检查ES是否启动成功：浏览器访问http://localhost:9200/?Pretty"></a>5、检查ES是否启动成功：浏览器访问<a href="http://localhost:9200/?Pretty">http://localhost:9200/?Pretty</a></h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;node-1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cluster_uuid&quot;</span>: <span class="string">&quot;HqAKQ_0tQOOm8b6qU-2Qug&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;number&quot;</span>: <span class="string">&quot;7.3.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_flavor&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span>: <span class="string">&quot;zip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_hash&quot;</span>: <span class="string">&quot;de777fa&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span>: <span class="string">&quot;2019-07-24T18:30:11.767338Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_snapshot&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;lucene_version&quot;</span>: <span class="string">&quot;8.1.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span>: <span class="string">&quot;6.8.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;minimum_index_compatibility_version&quot;</span>: <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;tagline&quot;</span>: <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>name: node名称，取自机器的hostname</p>
<p>cluster_name: 集群名称（默认的集群名称就是elasticsearch）</p>
<p>version.number: 7.3.0，es版本号</p>
<p>version.lucene_version:封装的lucene版本号</p>
<h3 id="6、浏览器访问-http-localhost-9200-cluster-health-查询集群状态"><a href="#6、浏览器访问-http-localhost-9200-cluster-health-查询集群状态" class="headerlink" title="6、浏览器访问 http://localhost:9200/_cluster/health 查询集群状态"></a>6、浏览器访问 <a href="http://localhost:9200/_cluster/health">http://localhost:9200/_cluster/health</a> 查询集群状态</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;green&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_nodes&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_data_nodes&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;active_primary_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;active_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;relocating_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;initializing_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;unassigned_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;delayed_unassigned_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_pending_tasks&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_in_flight_fetch&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;task_max_waiting_in_queue_millis&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;active_shards_percent_as_number&quot;</span>: <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>Status：集群状态。Green 所有分片可用。Yellow所有主分片可用。Red主分片不可用，集群不可用。</p>
<h2 id="2-Windows安装Kibana"><a href="#2-Windows安装Kibana" class="headerlink" title="2.  Windows安装Kibana"></a>2.  Windows安装Kibana</h2><p>1、kibana是es数据的前端展现，数据分析时，可以方便地看到数据。作为开发人员，可以方便访问es。</p>
<p>2、下载，解压kibana。</p>
<p>3.修改配置文件kibana.yml</p>
<p><img src="/../img/image-20220224084821333.png" alt="image-20220224084821333"></p>
<p>默认监听localhost:9200es</p>
<p><img src="/../img/image-20220224090624018.png" alt="image-20220224090624018"></p>
<p>4、启动Kibana：bin\kibana.bat</p>
<p>浏览器访问 <a href="http://localhost:5601/">http://localhost:5601</a> 进入Dev Tools界面。像plsql一样支持代码提示。</p>
<p>5、点击开发工具 发送get请求，查看集群状态GET /_cluster/health。</p>
<p>查看es状态 GET /</p>
<h2 id="3-Windows安装head插件"><a href="#3-Windows安装head插件" class="headerlink" title="3.Windows安装head插件"></a>3.Windows安装head插件</h2><p>head插件是ES的一个可视化管理插件，用来监视ES的状态，并通过head客户端和ES服务进行交互，比如创建映射、创建索引</p>
<p>项目地址在<a href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a> 。</p>
<p>head插件支持使得node.js运行</p>
<h3 id="1-需要安装node-js"><a href="#1-需要安装node-js" class="headerlink" title="1.需要安装node.js"></a>1.需要安装node.js</h3><h3 id="2-安装head"><a href="#2-安装head" class="headerlink" title="2.安装head"></a>2.安装head</h3><p>解压elasticsearch-head.zip</p>
<p>在根目录cmd<br>npm run start </p>
<p>浏览器打开 <a href="http://localhost:9100/">http://localhost:9100/</a></p>
<p>打开浏览器调试工具发现报错：</p>
<p>Origin null is not allowed by Access-Control-Allow-Origin.</p>
<p>原因是：head插件作为客户端要连接ES服务（localhost:9200），此时存在跨域问题，elasticsearch默认不允许跨域访问。</p>
<p>解决方案：</p>
<p>设置elasticsearch允许跨域访问。</p>
<p>在config/elasticsearch.yml 后面增加以下参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#开启cors跨域访问支持，默认为false   </span><br><span class="line">http.cors.enabled: true   </span><br><span class="line">#跨域访问允许的域名地址，(允许所有域名)以上使用正则   </span><br><span class="line">http.cors.allow-origin: /.*/</span><br></pre></td></tr></table></figure>

<p>注意：将config/elasticsearch.yml另存为utf-8编码格式。</p>
<p>成功连接ES</p>
<p><img src="/../img/1568627617789.png" alt="1568627617789"></p>
<p>注意：kibana\postman\head插件选择自己喜欢的一种使用即可。</p>
<p>本教程使用kibana的dev tool，因为地址栏省略了<a href="http://localhost:9200。">http://localhost:9200。</a></p>
<h1 id="4-es快速入门"><a href="#4-es快速入门" class="headerlink" title="4.es快速入门"></a>4.es快速入门</h1><p>es的document用json数据格式来表达</p>
<h2 id="1-检查集群的健康状况"><a href="#1-检查集群的健康状况" class="headerlink" title="1.检查集群的健康状况"></a>1.检查集群的健康状况</h2><p>GET /_cat/health?v</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1568635460 12:04:20  elasticsearch green           1         1      4   4    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure>

<p>green：每个索引的primary shard和replica shard都是active状态的</p>
<p>yellow：每个索引的primary shard都是active状态的，但是部分replica shard不是active状态，处于不可用的状态</p>
<p>red：不是所有索引的primary shard都是active状态的，部分索引有数据丢失了</p>
<h2 id="2-查看集群中有哪些索引（数据库or表）"><a href="#2-查看集群中有哪些索引（数据库or表）" class="headerlink" title="2.查看集群中有哪些索引（数据库or表）"></a>2.查看集群中有哪些索引（数据库or表）</h2><p>GET /_cat/indices?v</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">health status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   .kibana_task_manager            JBMgpucOSzenstLcjA_G4A   1   0          2            0     45.5kb         45.5kb</span><br><span class="line">green  open   .monitoring-kibana-7-2009.16 LIskf15DTcS70n4Q6t2bTA   1   0        433            0    218.2kb        218.2kb</span><br><span class="line">green  open   .monitoring-es-7-2009.16     RMeUN3tQRjqM8xBgw7Zong   1   0       3470         1724      1.9mb          1.9mb</span><br><span class="line">green  open   .kibana_1                       1cRiyIdATya5xS6qK5pGJw   1   0          4            0     18.2kb         18.2kb</span><br></pre></td></tr></table></figure>

<h2 id="3-简单的索引操作（数据库or表）"><a href="#3-简单的索引操作（数据库or表）" class="headerlink" title="3.简单的索引操作（数据库or表）"></a>3.简单的索引操作（数据库or表）</h2><p>创建索引：PUT /demo_index?pretty</p>
<p>pretty：好看的json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;demo_index&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除索引：DELETE /demo_index?pretty</p>
<h1 id="5-商品的CRUD操作（document-CRUD操作）"><a href="#5-商品的CRUD操作（document-CRUD操作）" class="headerlink" title="5.商品的CRUD操作（document CRUD操作）"></a>5.商品的CRUD操作（document CRUD操作）</h1><h2 id="1-图书网站商品管理案例：背景介绍"><a href="#1-图书网站商品管理案例：背景介绍" class="headerlink" title="1.图书网站商品管理案例：背景介绍"></a>1.图书网站商品管理案例：背景介绍</h2><p>有一个售卖图书的网站，需要为其基于ES构建一个后台系统，提供以下功能：</p>
<p>（1）对商品信息进行CRUD（增删改查）操作</p>
<p>（2）执行简单的结构化查询</p>
<p>（3）可以执行简单的全文检索，以及复杂的phrase（短语）检索</p>
<p>（4）对于全文检索的结果，可以进行高亮显示</p>
<p>（5）对数据进行简单的聚合分析</p>
<h2 id="2-新建图书索引（表）"><a href="#2-新建图书索引（表）" class="headerlink" title="2.新建图书索引（表）"></a>2.新建图书索引（表）</h2><p>首先建立图书索引 book</p>
<p>语法：put /index</p>
<p>PUT /book</p>
<p><img src="/../img/1568632608676.png" alt="1568632608676"></p>
<h2 id="3-新增图书-新增文档"><a href="#3-新增图书-新增文档" class="headerlink" title="3.新增图书 :新增文档"></a>3.新增图书 :新增文档</h2><p>语法：PUT /index/type/id</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Bootstrap开发&quot;</span>,</span><br><span class="line"><span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span>,</span><br><span class="line"><span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;201002&quot;</span>,</span><br><span class="line"><span class="attr">&quot;price&quot;</span>:<span class="number">38.6</span>,</span><br><span class="line"><span class="attr">&quot;timestamp&quot;</span>:<span class="string">&quot;2019-08-25 19:11:35&quot;</span>,</span><br><span class="line"><span class="attr">&quot;pic&quot;</span>:<span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span>,</span><br><span class="line"><span class="attr">&quot;tags&quot;</span>: [ <span class="string">&quot;bootstrap&quot;</span>, <span class="string">&quot;dev&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">2</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;name&quot;</span>: <span class="string">&quot;java编程思想&quot;</span>,</span><br><span class="line"><span class="attr">&quot;description&quot;</span>: <span class="string">&quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;</span>,</span><br><span class="line"><span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line"><span class="attr">&quot;price&quot;</span>:<span class="number">68.6</span>,</span><br><span class="line"><span class="attr">&quot;timestamp&quot;</span>:<span class="string">&quot;2019-08-25 19:11:35&quot;</span>,</span><br><span class="line"><span class="attr">&quot;pic&quot;</span>:<span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span>,</span><br><span class="line"><span class="attr">&quot;tags&quot;</span>: [ <span class="string">&quot;java&quot;</span>, <span class="string">&quot;dev&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">3</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;name&quot;</span>: <span class="string">&quot;spring开发基础&quot;</span>,</span><br><span class="line"><span class="string">&quot;description&quot;</span>: <span class="string">&quot;spring 在java领域非常流行，java程序员都在用。&quot;</span>,</span><br><span class="line"><span class="string">&quot;studymodel&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line"><span class="string">&quot;price&quot;</span>:<span class="number">88.6</span>,</span><br><span class="line"><span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2019-08-24 19:11:35&quot;</span>,</span><br><span class="line"><span class="string">&quot;pic&quot;</span>:<span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span>,</span><br><span class="line"><span class="string">&quot;tags&quot;</span>: [ <span class="string">&quot;spring&quot;</span>, <span class="string">&quot;java&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入第一条后的结果</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-查询图书：检索文档"><a href="#4-查询图书：检索文档" class="headerlink" title="4.查询图书：检索文档"></a>4.查询图书：检索文档</h2><h3 id="查全部"><a href="#查全部" class="headerlink" title="查全部"></a>查全部</h3><p>GET /book/_search</p>
<h3 id="查单个"><a href="#查单个" class="headerlink" title="查单个"></a>查单个</h3><p>语法：GET /index/type/id</p>
<p>查看图书:GET /book/_doc/1  就可看到json形式的文档。方便程序解析。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;_seq_no&quot; : 0,</span><br><span class="line">  &quot;_primary_term&quot; : 1,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;name&quot; : &quot;Bootstrap开发&quot;,</span><br><span class="line">    &quot;description&quot; : &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line">    &quot;studymodel&quot; : &quot;201002&quot;,</span><br><span class="line">    &quot;price&quot; : 38.6,</span><br><span class="line">    &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">    &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">    &quot;tags&quot; : [</span><br><span class="line">      &quot;bootstrap&quot;,</span><br><span class="line">      &quot;dev&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为方便查看索引中的数据，kibana可以如下操作</p>
<p>Kibana-discover- Create index pattern- Index pattern填book（匹配book索引）</p>
<p><img src="/../img/1568632860925.png" alt="1568632860925"></p>
<p>下一步，再点击discover就可看到数据。</p>
<p><img src="/../img/1568632872817.png" alt="1568632872820"></p>
<p>点击json还可以看到原始数据</p>
<p><img src="/../img/1568632881931.png" alt="1568632881931"></p>
<p>为方便查看索引中的数据，head可以如下操作</p>
<p>点击数据浏览，点击book索引。</p>
<p><img src="/../img/1568632895254.png" alt="1568632895254"></p>
<h2 id="5-修改图书：替换操作-需要全部字段"><a href="#5-修改图书：替换操作-需要全部字段" class="headerlink" title="5.修改图书：替换操作(需要全部字段)"></a>5.修改图书：替换操作(需要全部字段)</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Bootstrap开发教程1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;201002&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;price&quot;</span>:<span class="number">38.6</span>,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>:<span class="string">&quot;2019-08-25 19:11:35&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;pic&quot;</span>:<span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tags&quot;</span>: [ <span class="string">&quot;bootstrap&quot;</span>, <span class="string">&quot;开发&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>替换操作是整体覆盖，要带上所有信息。</p>
<h3 id="修改图书：更新文档（真正的更新）"><a href="#修改图书：更新文档（真正的更新）" class="headerlink" title="修改图书：更新文档（真正的更新）"></a>修改图书：更新文档（真正的更新）</h3><p>语法：POST  /{index}/type /{id}/_update</p>
<p>或者POST  /{index}/_update/{id}</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /book/_update/<span class="number">1</span>/ </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot; Bootstrap开发教程高级&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;updated&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">11</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-删除图书：删除文档"><a href="#6-删除图书：删除文档" class="headerlink" title="6.删除图书：删除文档"></a>6.删除图书：删除文档</h2><p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /book/_doc/1</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">11</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;deleted&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">12</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-文档document入门"><a href="#6-文档document入门" class="headerlink" title="6.文档document入门"></a>6.文档document入门</h1><h2 id="6-1默认自带字段解析"><a href="#6-1默认自带字段解析" class="headerlink" title="6.1默认自带字段解析"></a>6.1默认自带字段解析</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;Bootstrap开发教程1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;studymodel&quot;</span> : <span class="string">&quot;201002&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;price&quot;</span> : <span class="number">38.6</span>,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2019-08-25 19:11:35&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;pic&quot;</span> : <span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> : [</span><br><span class="line">      <span class="string">&quot;bootstrap&quot;</span>,</span><br><span class="line">      <span class="string">&quot;开发&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-1-1-index"><a href="#6-1-1-index" class="headerlink" title="6.1.1 _index"></a>6.1.1 _index</h3><ul>
<li> 含义：此文档属于哪个索引</li>
<li> 原则：类似数据放在一个索引中。数据库中表的定义规则。如图书信息放在book索引中，员工信息放在employee索引中。各个索引存储和搜索时互不影响。</li>
<li> 定义规则：英文小写。尽量不要使用特殊字符。order user </li>
</ul>
<h3 id="6-1-2-type"><a href="#6-1-2-type" class="headerlink" title="6.1.2 _type"></a>6.1.2 _type</h3><ul>
<li> 含义：类别。book java node</li>
<li> 注意：以后的es9将彻底删除此字段，所以当前版本在不断弱化type。不需要关注。见到_type都为doc。</li>
</ul>
<h3 id="6-1-3-id"><a href="#6-1-3-id" class="headerlink" title="6.1.3 _id"></a>6.1.3 _id</h3><p>含义：文档的唯一标识。就像表的id主键。结合索引可以标识和定义一个文档。</p>
<p>生成：手动（put /index/_doc/id）、自动</p>
<h3 id="6-1-4-创建索引时，不同数据放到不同索引中"><a href="#6-1-4-创建索引时，不同数据放到不同索引中" class="headerlink" title="6.1.4 创建索引时，不同数据放到不同索引中"></a>6.1.4 创建索引时，不同数据放到不同索引中</h3><h2 id="6-2．-生成文档id"><a href="#6-2．-生成文档id" class="headerlink" title="6.2． 生成文档id"></a>6.2． 生成文档id</h2><h3 id="6-2-1-手动生成id"><a href="#6-2-1-手动生成id" class="headerlink" title="6.2.1 手动生成id"></a>6.2.1 手动生成id</h3><p>场景：数据从其他系统导入时，本身有唯一主键。如数据库中的图书、员工信息等。</p>
<p>用法：put /index/_doc/id</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-2-自动生成id"><a href="#6-2-2-自动生成id" class="headerlink" title="6.2.2 自动生成id"></a>6.2.2 自动生成id</h3><p>用法：POST /index/_doc</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /test_index/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span>: <span class="string">&quot;test1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;x29LOm0BPsY0gSJFYZAl&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自动id特点：</p>
<p>长度为20个字符，URL安全，base64编码，GUID，分布式生成不冲突 </p>
<h2 id="6-3．-source-字段"><a href="#6-3．-source-字段" class="headerlink" title="6.3． _source 字段"></a>6.3． _source 字段</h2><h3 id="6-3-1-source，就是添加的原始数据"><a href="#6-3-1-source，就是添加的原始数据" class="headerlink" title="6.3.1 _source，就是添加的原始数据"></a>6.3.1 _source，就是添加的原始数据</h3><p>含义：插入数据时的所有字段和值。在get获取数据时，在_source字段中原样返回。</p>
<p>GET  /book/_doc/1</p>
<h3 id="6-3-2-定制返回字段"><a href="#6-3-2-定制返回字段" class="headerlink" title="6.3.2 定制返回字段"></a>6.3.2 定制返回字段</h3><p>就像sql不要select *,而要select name,price from book …一样。</p>
<p>GET  /book/_doc/1?_source_includes=name,price    </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;price&quot;</span> : <span class="number">38.6</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;Bootstrap开发教程1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-4．-文档（数据一行）的替换与删除"><a href="#6-4．-文档（数据一行）的替换与删除" class="headerlink" title="6.4． 文档（数据一行）的替换与删除"></a>6.4． 文档（数据一行）的替换与删除</h2><h3 id="6-4-1全量替换"><a href="#6-4-1全量替换" class="headerlink" title="6.4.1全量替换"></a>6.4.1全量替换</h3><p>执行两次，返回结果中版本号（_version）在不断上升。此过程为全量替换。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实质：旧文档的内容不会立即删除，只是标记为deleted。适当的时机，集群会将这些文档删除。</p>
<h3 id="6-4-2-强制创建"><a href="#6-4-2-强制创建" class="headerlink" title="6.4.2 强制创建"></a>6.4.2 强制创建</h3><p>为防止覆盖原有数据，我们在新增时，设置为强制创建，不会覆盖原有文档。</p>
<p>语法：PUT /index/ _doc/id/_create</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">1</span>/_create</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回，就是说不会替换原来的，原来存在id为1的就不会在创建了</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;error&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;version_conflict_engine_exception&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span>: <span class="string">&quot;[2]: version conflict, document already exists (current version [1])&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span>: <span class="string">&quot;lqzVqxZLQuCnd6LYtZsMkg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;shard&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;test_index&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;version_conflict_engine_exception&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;reason&quot;</span>: <span class="string">&quot;[2]: version conflict, document already exists (current version [1])&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;index_uuid&quot;</span>: <span class="string">&quot;lqzVqxZLQuCnd6LYtZsMkg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;shard&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;test_index&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="number">409</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-3-删除"><a href="#6-4-3-删除" class="headerlink" title="6.4.3 删除"></a>6.4.3 删除</h3><p>DELETE /index/_doc/id</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE  /test_index/_doc/1/</span><br></pre></td></tr></table></figure>

<p>实质：旧文档的内容不会立即删除，只是标记为deleted。适当的时机，集群会将这些文档删除。</p>
<p>lazy delete</p>
<h2 id="6-5．-局部替换-partial-update"><a href="#6-5．-局部替换-partial-update" class="headerlink" title="6.5． 局部替换 partial update"></a>6.5． 局部替换 partial update</h2><h4 id="建议使用POST-index-update-id"><a href="#建议使用POST-index-update-id" class="headerlink" title="建议使用POST  /{index}/_update/{id}"></a>建议使用POST  /{index}/_update/{id}</h4><p>使用 PUT /index/type/id 为文档全量替换，需要将文档所有数据提交。</p>
<p>partial update局部替换则只修改变动字段。</p>
<p>用法：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">post /index/type/id/_update </span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;field&quot;</span>：<span class="attr">&quot;value&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="图解内部原理"><a href="#图解内部原理" class="headerlink" title="图解内部原理"></a>图解内部原理</h4><p>内部与全量替换是一样的，旧文档标记为删除，新建一个文档。</p>
<p>优点：</p>
<ul>
<li>大大减少网络传输次数和流量，提升性能</li>
<li>减少并发冲突发生的概率。</li>
</ul>
<h4 id="局部更新步骤"><a href="#局部更新步骤" class="headerlink" title="局部更新步骤"></a>局部更新步骤</h4><p><img src="/../img/image-20220224100420779.png" alt="image-20220224100420779"></p>
<h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4><p>插入文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field1&quot;: &quot;itcst&quot;,</span><br><span class="line">  &quot;test_field2&quot;: &quot;itheima&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改字段1</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /test_index/_doc/<span class="number">5</span>/_update</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;test_field2&quot;</span>: <span class="string">&quot; itheima 2&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-6．-使用脚本更新"><a href="#6-6．-使用脚本更新" class="headerlink" title="6.6． 使用脚本更新"></a>6.6． 使用脚本更新</h2><p>es可以内置脚本执行复杂操作。例如painless脚本。</p>
<p>注意：groovy脚本在es6以后就不支持了。原因是耗内存，不安全远程注入漏洞。</p>
<h3 id="6-6-1内置脚本"><a href="#6-6-1内置脚本" class="headerlink" title="6.6.1内置脚本"></a>6.6.1内置脚本</h3><p>需求1：修改文档6的num字段，+1。</p>
<p>插入数据</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">6</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;num&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行脚本操作</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /test_index/_doc/<span class="number">6</span>/_update</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;script&quot;</span> : <span class="string">&quot;ctx._source.num+=1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">or</span><br><span class="line">POST /book/_update/<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;script&quot;</span> : <span class="string">&quot;ctx._source.price+=1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /test_index/_doc/6</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;6&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">23</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;num&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> : [ ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需求2：搜索所有文档，将num字段乘以2输出</p>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/7</span><br><span class="line">&#123;</span><br><span class="line">  &quot;num&quot;: 5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询</p>
<p>script_fields：脚本属性</p>
<p>my_doubled_field：自定义的属性</p>
<p>script：自定义脚本内容</p>
<p>lang：语言</p>
<p>source：自定义脚本内容的语法格式，取出num属性乘以参数multiplier，最终给my_doubled_field这个自定义属性</p>
<p>params：自定义参数</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;script_fields&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;my_doubled_field&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;script&quot;</span>: &#123;</span><br><span class="line">       <span class="attr">&quot;lang&quot;</span>: <span class="string">&quot;expression&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;source&quot;</span>: <span class="string">&quot;doc[&#x27;num&#x27;] * multiplier&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;params&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;multiplier&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;7&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;fields&quot; : &#123;</span><br><span class="line">          &quot;my_doubled_field&quot; : [</span><br><span class="line">            10.0</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-6-2-外部脚本"><a href="#6-6-2-外部脚本" class="headerlink" title="6.6.2 外部脚本"></a>6.6.2 外部脚本</h3><p>Painless是内置支持的。脚本内容可以通过多种途径传给 es，包括 rest 接口，或者放到 config/scripts目录等，默认开启。</p>
<p>注意：脚本性能低下，且容易发生注入，本教程忽略。</p>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html</a></p>
<h2 id="6-7．-图解es的并发问题"><a href="#6-7．-图解es的并发问题" class="headerlink" title="6.7． 图解es的并发问题"></a>6.7． 图解es的并发问题</h2><p>如同秒杀，多线程情况下，es同样会出现并发冲突问题。</p>
<p><img src="/../img/image-20220224102311260.png" alt="image-20220224102311260"></p>
<h2 id="6-8．-图解悲观锁与乐观锁机制"><a href="#6-8．-图解悲观锁与乐观锁机制" class="headerlink" title="6.8． 图解悲观锁与乐观锁机制"></a>6.8． 图解悲观锁与乐观锁机制</h2><p><img src="/../img/image-20220224102757262.png" alt="image-20220224102757262"></p>
<p>为控制并发问题，我们通常采用锁机制。分为悲观锁和乐观锁两种机制。</p>
<p>悲观锁：很悲观，所有情况都上锁。此时只有一个线程可以操作数据。具体例子为数据库中的行级锁、表级锁、读锁、写锁等。</p>
<p>特点：优点是方便，直接加锁，对程序透明。缺点是效率低。</p>
<p>乐观锁：很乐观，对数据本身不加锁。提交数据时，通过一种机制验证是否存在冲突，如es中通过版本号验证。</p>
<p>特点：优点是并发能力高。缺点是操作繁琐，在提交数据时，可能反复重试多次。</p>
<h2 id="6-9．-图解es内部基于-version乐观锁控制"><a href="#6-9．-图解es内部基于-version乐观锁控制" class="headerlink" title="6.9． 图解es内部基于_version乐观锁控制"></a>6.9． 图解es内部基于_version乐观锁控制</h2><h4 id="实验基于-version的版本控制"><a href="#实验基于-version的版本控制" class="headerlink" title="实验基于_version的版本控制"></a>实验基于_version的版本控制</h4><p>es对于文档的增删改都是基于版本号。</p>
<p>1新增多次文档：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回版本号递增</p>
<p>2删除此文档，版本号递增</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /test_index/_doc/3</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /test_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot; : 6,</span><br><span class="line">  &quot;result&quot; : &quot;deleted&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot; : 7,</span><br><span class="line">  &quot;_primary_term&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3再新增，版本号递增</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到版本号依然递增，验证延迟删除策略。</p>
<p>如果删除一条数据立马删除的话，所有分片和副本都要立马删除，对es集群压力太大。</p>
<h4 id="图解es内部并发控制"><a href="#图解es内部并发控制" class="headerlink" title="图解es内部并发控制"></a>图解es内部并发控制</h4><p>es内部主从同步时，是多线程异步。乐观锁机制。判断version是否是最新的，不是最新的直接丢弃</p>
<p><img src="/../img/image-20220224103648853.png" alt="image-20220224103648853"></p>
<h2 id="6-10．-演示客户端程序基于-version并发操作流程"><a href="#6-10．-演示客户端程序基于-version并发操作流程" class="headerlink" title="6.10． 演示客户端程序基于_version并发操作流程"></a>6.10． 演示客户端程序基于_version并发操作流程</h2><p>java python客户端更新的机制。</p>
<h4 id="新建文档"><a href="#新建文档" class="headerlink" title="新建文档"></a>新建文档</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">5</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span>: <span class="string">&quot;itcast&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回： </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">8</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="客户端1修改。带版本号1（-seq-no-？和-primary-term-？）。"><a href="#客户端1修改。带版本号1（-seq-no-？和-primary-term-？）。" class="headerlink" title="客户端1修改。带版本号1（_seq_no=？和_primary_term=？）。"></a>客户端1修改。带版本号1（_seq_no=？和_primary_term=？）。</h4><p>首先获取数据的当前版本号</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /test_index/_doc/5</span><br></pre></td></tr></table></figure>

<p>更新文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/5?version=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br><span class="line">现在不用version了，替换为_seq_no=？和_primary_term=？</span><br><span class="line">PUT /test_index/_doc/5?if_seq_no=21&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="客户端2并发修改。带版本号1（-seq-no-？和-primary-term-？）。"><a href="#客户端2并发修改。带版本号1（-seq-no-？和-primary-term-？）。" class="headerlink" title="客户端2并发修改。带版本号1（_seq_no=？和_primary_term=？）。"></a>客户端2并发修改。带版本号1（_seq_no=？和_primary_term=？）。</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/5?if_seq_no=21&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错。</p>
<h4 id="客户端2重新查询。得到最新版本为2（-seq-no-？和-primary-term-？）"><a href="#客户端2重新查询。得到最新版本为2（-seq-no-？和-primary-term-？）" class="headerlink" title="客户端2重新查询。得到最新版本为2（_seq_no=？和_primary_term=？）"></a>客户端2重新查询。得到最新版本为2（_seq_no=？和_primary_term=？）</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /test_index/_doc/5</span><br></pre></td></tr></table></figure>

<h4 id="客户端2并发修改。带版本号2。"><a href="#客户端2并发修改。带版本号2。" class="headerlink" title="客户端2并发修改。带版本号2。"></a>客户端2并发修改。带版本号2。</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/5?if_seq_no=22&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改成功。</p>
<h2 id="6-11．-演示自己手动控制版本号-external-version"><a href="#6-11．-演示自己手动控制版本号-external-version" class="headerlink" title="6.11． 演示自己手动控制版本号 external version"></a>6.11． 演示自己手动控制版本号 external version</h2><p>背景：已有数据是在数据库中，有自己手动维护的版本号的情况下，可以使用external version控制。hbase。</p>
<p>要求：修改时external version要大于当前文档的_version</p>
<p>对比：基于_version时，修改的文档version等于当前文档的版本号。</p>
<p>使用?version=1&amp;version_type=external</p>
<h4 id="新建文档-1"><a href="#新建文档-1" class="headerlink" title="新建文档"></a>新建文档</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新文档：</p>
<h4 id="客户端1修改文档"><a href="#客户端1修改文档" class="headerlink" title="客户端1修改文档"></a>客户端1修改文档</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/4?version=2&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功，version改为2</p>
<h4 id="客户端2同时修改"><a href="#客户端2同时修改" class="headerlink" title="客户端2同时修改"></a>客户端2同时修改</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/4?version=2&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;version_conflict_engine_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;[4]: version conflict, current version [2] is higher or equal to the one provided [2]&quot;,</span><br><span class="line">        &quot;index_uuid&quot;: &quot;-rqYZ2EcSPqL6pu8Gi35jw&quot;,</span><br><span class="line">        &quot;shard&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;index&quot;: &quot;test_index&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;version_conflict_engine_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;[4]: version conflict, current version [2] is higher or equal to the one provided [2]&quot;,</span><br><span class="line">    &quot;index_uuid&quot;: &quot;-rqYZ2EcSPqL6pu8Gi35jw&quot;,</span><br><span class="line">    &quot;shard&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;index&quot;: &quot;test_index&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 409</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="客户端2重新查询数据"><a href="#客户端2重新查询数据" class="headerlink" title="客户端2重新查询数据"></a>客户端2重新查询数据</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /test_index/_doc/4</span><br></pre></td></tr></table></figure>

<h4 id="客户端2重新修改数据，手动更改version"><a href="#客户端2重新修改数据，手动更改version" class="headerlink" title="客户端2重新修改数据，手动更改version"></a>客户端2重新修改数据，手动更改version</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /test_index/_doc/4?version=8&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功</p>
<h2 id="6-12．更新时-retry-on-conflict-参数"><a href="#6-12．更新时-retry-on-conflict-参数" class="headerlink" title="6.12．更新时 retry_on_conflict 参数"></a>6.12．更新时 retry_on_conflict 参数</h2><h4 id="retry-on-conflict"><a href="#retry-on-conflict" class="headerlink" title="retry_on_conflict"></a>retry_on_conflict</h4><p>指定重试次数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /test_index/_doc/5/_update?retry_on_conflict=3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="与-version结合使用"><a href="#与-version结合使用" class="headerlink" title="与 _version结合使用"></a>与 _version结合使用</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /test_index/_doc/<span class="number">5</span>/_update?retry_on_conflict=<span class="number">3</span>&amp;version=<span class="number">22</span>&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;test_field&quot;</span>: <span class="string">&quot;itcast1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-13．-批量查询-mget"><a href="#6-13．-批量查询-mget" class="headerlink" title="6.13． 批量查询 mget"></a>6.13． 批量查询 mget</h2><p>单条查询 GET  /test_index/_doc/1，如果查询多个id的文档一条一条查询，网络开销太大。</p>
<h4 id="mget-批量查询："><a href="#mget-批量查询：" class="headerlink" title="mget 批量查询："></a>mget 批量查询：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_type&quot; :  &quot;_doc&quot;,</span><br><span class="line">         &quot;_id&quot; :    1</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_type&quot; :  &quot;_doc&quot;,</span><br><span class="line">         &quot;_id&quot; :    7</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">      &quot;_version&quot; : 6,</span><br><span class="line">      &quot;_seq_no&quot; : 12,</span><br><span class="line">      &quot;_primary_term&quot; : 1,</span><br><span class="line">      &quot;found&quot; : true,</span><br><span class="line">      &quot;_source&quot; : &#123;</span><br><span class="line">        &quot;test_field&quot; : &quot;test12333123321321&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">      &quot;_version&quot; : 6,</span><br><span class="line">      &quot;_seq_no&quot; : 18,</span><br><span class="line">      &quot;_primary_term&quot; : 1,</span><br><span class="line">      &quot;found&quot; : true,</span><br><span class="line">      &quot;_source&quot; : &#123;</span><br><span class="line">        &quot;test_field&quot; : &quot;test3213&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提示去掉type</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_id&quot; :    2</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_id&quot; :    3</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="同一索引下批量查询："><a href="#同一索引下批量查询：" class="headerlink" title="同一索引下批量查询："></a>同一索引下批量查询：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /test_index/_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_id&quot; :    2</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_id&quot; :    3</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第三种写法：搜索写法"><a href="#第三种写法：搜索写法" class="headerlink" title="第三种写法：搜索写法"></a>第三种写法：搜索写法</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">post /test_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;ids&quot; : &#123;</span><br><span class="line">            &quot;values&quot; : [&quot;1&quot;, &quot;7&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-14．-批量增删改-bulk"><a href="#6-14．-批量增删改-bulk" class="headerlink" title="6.14． 批量增删改 bulk"></a>6.14． 批量增删改 bulk</h2><p>Bulk 操作解释将文档的增删改查一些列操作，通过一次请求全都做完。减少网络传输次数。</p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;action&quot;: &#123;&quot;metadata&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;data&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>如下操作，删除5，新增14，修改2。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; &quot;delete&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;5&quot; &#125;&#125; </span><br><span class="line">&#123; &quot;create&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;14&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;test_field&quot;: &quot;test14&quot; &#125;</span><br><span class="line">&#123; &quot;update&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;2&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;test_field&quot; : &quot;bulk test&quot;&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<p>1功能：</p>
<ul>
<li> delete：删除一个文档，只要1个json串就可以了</li>
<li> create：相当于强制创建  PUT /index/type/id/_create </li>
<li> index：普通的put操作，可以是创建文档，也可以是全量替换文档</li>
<li> update：执行的是局部更新partial update操作</li>
</ul>
<p>2格式：每个json不能换行。相邻json必须换行。</p>
<p>3隔离：每个操作互不影响。操作失败的行会返回其失败信息。</p>
<p>4实际用法：bulk请求一次不要太大，否则一下积压到内存中，性能会下降。所以，一次请求几千个操作、大小在几M正好。</p>
<h2 id="6-15．-文档概念学习总结"><a href="#6-15．-文档概念学习总结" class="headerlink" title="6.15． 文档概念学习总结"></a>6.15． 文档概念学习总结</h2><p><strong>应用场景</strong></p>
<ul>
<li>大数据。es的分布式特点，水平扩容承载大数据。</li>
<li>数据结构灵活。列随时变化。使用关系型数据库将会建立大量的关联表，增加系统复杂度。</li>
<li>数据操作简单。就是查询，不涉及事务。</li>
</ul>
<p><strong>举例</strong></p>
<p>电商页面、传统论坛页面等。面向的对象比较复杂，但是作为终端，没有太复杂的功能（事务），只涉及简单的增删改查crud。</p>
<p>这个时候选用ES这种NoSQL型的数据存储，比传统的复杂的事务强大的关系型数据库，更加合适一些。无论是性能，还是吞吐量，可能都会更好。</p>
<h1 id="7-Java-api-实现文档管理"><a href="#7-Java-api-实现文档管理" class="headerlink" title="7.Java api 实现文档管理"></a>7.Java api 实现文档管理</h1><h2 id="1java-客户端简单获取数据"><a href="#1java-客户端简单获取数据" class="headerlink" title="1java 客户端简单获取数据"></a>1java 客户端简单获取数据</h2><h3 id="1导包"><a href="#1导包" class="headerlink" title="1导包"></a>1导包</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2代码"><a href="#2代码" class="headerlink" title="2代码"></a>2代码</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//获取连接客户端</span></span><br><span class="line">RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">        RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line"><span class="comment">//构建请求</span></span><br><span class="line">GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">&quot;book&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="comment">// 执行</span></span><br><span class="line">GetResponse getResponse = client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line"><span class="comment">// 获取结果</span></span><br><span class="line"><span class="keyword">if</span> (getResponse.isExists()) &#123;</span><br><span class="line">    <span class="keyword">long</span> version = getResponse.getVersion();</span><br><span class="line">    String sourceAsString = getResponse.getSourceAsString();<span class="comment">//检索文档(String形式)</span></span><br><span class="line">    System.out.println(sourceAsString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-结合spring-boot"><a href="#2-结合spring-boot" class="headerlink" title="2.结合spring-boot"></a>2.结合spring-boot</h2><p>配置 application.yml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-search</span><br><span class="line">heima:</span><br><span class="line">  elasticsearch:</span><br><span class="line">    hostlist: 127.0.0.1:9200 #多个结点中间用逗号分隔</span><br></pre></td></tr></table></figure>

<p>日志文件logback-spring.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!--定义日志文件的存储地址,使用绝对路径--&gt;</span><br><span class="line">    &lt;property name=&quot;LOG_HOME&quot; value=&quot;d:/logs&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Console 输出设置 --&gt;</span><br><span class="line">    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">        &lt;encoder&gt;</span><br><span class="line">            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span><br><span class="line">            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;</span><br><span class="line">            &lt;charset&gt;utf8&lt;/charset&gt;</span><br><span class="line">        &lt;/encoder&gt;</span><br><span class="line">    &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 按照每天生成日志文件 --&gt;</span><br><span class="line">    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">            &lt;!--日志文件输出的文件名--&gt;</span><br><span class="line">            &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/xc.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;</span><br><span class="line">        &lt;/rollingPolicy&gt;</span><br><span class="line">        &lt;encoder&gt;</span><br><span class="line">            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;</span><br><span class="line">        &lt;/encoder&gt;</span><br><span class="line">    &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 异步输出 --&gt;</span><br><span class="line">    &lt;appender name=&quot;ASYNC&quot; class=&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">        &lt;!-- 不丢失日志.默认的,如果队列的80%已满,则会丢弃TRACT、DEBUG、INFO级别的日志 --&gt;</span><br><span class="line">        &lt;discardingThreshold&gt;0&lt;/discardingThreshold&gt;</span><br><span class="line">        &lt;!-- 更改默认的队列的深度,该值会影响性能.默认值为256 --&gt;</span><br><span class="line">        &lt;queueSize&gt;512&lt;/queueSize&gt;</span><br><span class="line">        &lt;!-- 添加附加的appender,最多只能添加一个 --&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;FILE&quot;/&gt;</span><br><span class="line">    &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;logger name=&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">    &lt;/logger&gt;</span><br><span class="line">    &lt;logger name=&quot;org.springframework.boot&quot; level=&quot;DEBUG&quot;/&gt;</span><br><span class="line">    &lt;root level=&quot;info&quot;&gt;</span><br><span class="line">        &lt;!--&lt;appender-ref ref=&quot;ASYNC&quot;/&gt;--&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;FILE&quot;/&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">    &lt;/root&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>config配置类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.itheima.es.config;</span><br><span class="line"></span><br><span class="line">import org.apache.http.HttpHost;</span><br><span class="line">import org.elasticsearch.client.RestClient;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * creste by itheima.itcast</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class ElasticsearchConfig &#123;</span><br><span class="line">    @Value(&quot;$&#123;heima.elasticsearch.hostlist&#125;&quot;)</span><br><span class="line">   private String hostlist;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Bean(destroyMethod = &quot;close&quot;)</span><br><span class="line">    public RestHighLevelClient restHighLevelClient()&#123;</span><br><span class="line">        String[] split = hostlist.split(&quot;,&quot;);</span><br><span class="line">        HttpHost[] httpHostsArray = new HttpHost[split.length];</span><br><span class="line">        for (int i = 0; i &lt; split.length; i++) &#123;</span><br><span class="line">            String item=split[i];</span><br><span class="line">            httpHostsArray[i]=new HttpHost(item.split(&quot;:&quot;)[0],Integer.parseInt(item.split(&quot;:&quot;)[1]),&quot;http&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return new RestHighLevelClient(RestClient.builder(httpHostsArray));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试之前创建文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT test_post/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;user&quot;:&quot;tomas&quot;,</span><br><span class="line">  &quot;postDate&quot;:&quot;2019-07-18&quot;,</span><br><span class="line">  &quot;message&quot;:&quot;trying out es1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test类</p>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@SpringBootTest</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">//查询文档</span><br><span class="line">       @Test</span><br><span class="line">    public void testGet() throws IOException &#123;</span><br><span class="line">        //构建请求</span><br><span class="line">        GetRequest getRequest = new GetRequest(&quot;test_post&quot;, &quot;1&quot;);</span><br><span class="line"></span><br><span class="line">        //========================可选参数 start======================</span><br><span class="line">        //为特定字段配置_source_include</span><br><span class="line">//        String[] includes = new String[]&#123;&quot;user&quot;, &quot;message&quot;&#125;;</span><br><span class="line">//        String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">//1.是否对源数据请求 2想要请求的字段 3不想请求的字段</span><br><span class="line">//        FetchSourceContext fetchSourceContext = new FetchSourceContext(true, includes, excludes);</span><br><span class="line">//        getRequest.fetchSourceContext(fetchSourceContext);</span><br><span class="line"></span><br><span class="line">        //为特定字段配置_source_excludes,当想要的字段较多的时候</span><br><span class="line">//        String[] excludes1 = new String[]&#123;&quot;user&quot;, &quot;message&quot;&#125;;</span><br><span class="line">//        String[] includes1 = Strings.EMPTY_ARRAY;</span><br><span class="line">//        FetchSourceContext fetchSourceContext1 = new FetchSourceContext(true, includes1, excludes1);</span><br><span class="line">//        getRequest.fetchSourceContext(fetchSourceContext1);</span><br><span class="line"></span><br><span class="line">        //设置路由，后面会讲到</span><br><span class="line">//        getRequest.routing(&quot;routing&quot;);</span><br><span class="line"></span><br><span class="line">        // ========================可选参数 end=====================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //查询 同步查询</span><br><span class="line">      GetResponse getResponse = client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        //异步查询</span><br><span class="line">//        ActionListener&lt;GetResponse&gt; listener = new ActionListener&lt;GetResponse&gt;() &#123;</span><br><span class="line">//            //查询成功时的立马执行的方法</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onResponse(GetResponse getResponse) &#123;</span><br><span class="line">//                long version = getResponse.getVersion();</span><br><span class="line">//                String sourceAsString = getResponse.getSourceAsString();//检索文档(String形式)</span><br><span class="line">//                System.out.println(sourceAsString);</span><br><span class="line">//            &#125;</span><br><span class="line">//</span><br><span class="line">//            //查询失败时的立马执行的方法</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onFailure(Exception e) &#123;</span><br><span class="line">//                e.printStackTrace();</span><br><span class="line">//            &#125;</span><br><span class="line">//        &#125;;</span><br><span class="line">//        //执行异步请求</span><br><span class="line">//        client.getAsync(getRequest, RequestOptions.DEFAULT, listener);</span><br><span class="line">//        try &#123;</span><br><span class="line">//            Thread.sleep(5000);</span><br><span class="line">//        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">//        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取结果</span><br><span class="line">        if (getResponse.isExists()) &#123;</span><br><span class="line">            long version = getResponse.getVersion();</span><br><span class="line"></span><br><span class="line">            String sourceAsString = getResponse.getSourceAsString();//检索文档(String形式)</span><br><span class="line">            System.out.println(sourceAsString);</span><br><span class="line">            byte[] sourceAsBytes = getResponse.getSourceAsBytes();//以字节接受</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap();</span><br><span class="line">            System.out.println(sourceAsMap);</span><br><span class="line"></span><br><span class="line">        &#125;else &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">    public void testAdd() throws IOException &#123;</span><br><span class="line">//        1构建请求</span><br><span class="line">        IndexRequest request=new IndexRequest(&quot;test_posts&quot;);</span><br><span class="line">        request.id(&quot;3&quot;);</span><br><span class="line">//        =======================构建文档============================</span><br><span class="line">//        构建方法1</span><br><span class="line">        String jsonString=&quot;&#123;\n&quot; +</span><br><span class="line">                &quot;  \&quot;user\&quot;:\&quot;tomas J\&quot;,\n&quot; +</span><br><span class="line">                &quot;  \&quot;postDate\&quot;:\&quot;2019-07-18\&quot;,\n&quot; +</span><br><span class="line">                &quot;  \&quot;message\&quot;:\&quot;trying out es3\&quot;\n&quot; +</span><br><span class="line">                &quot;&#125;&quot;;</span><br><span class="line">        request.source(jsonString, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">//        构建方法2</span><br><span class="line">//        Map&lt;String,Object&gt; jsonMap=new HashMap&lt;&gt;();</span><br><span class="line">//        jsonMap.put(&quot;user&quot;, &quot;tomas&quot;);</span><br><span class="line">//        jsonMap.put(&quot;postDate&quot;, &quot;2019-07-18&quot;);</span><br><span class="line">//        jsonMap.put(&quot;message&quot;, &quot;trying out es2&quot;);</span><br><span class="line">//        request.source(jsonMap);</span><br><span class="line"></span><br><span class="line">//        构建方法3</span><br><span class="line">//        XContentBuilder builder= XContentFactory.jsonBuilder();</span><br><span class="line">//        builder.startObject();</span><br><span class="line">//        &#123;</span><br><span class="line">//            builder.field(&quot;user&quot;, &quot;tomas&quot;);</span><br><span class="line">//            builder.timeField(&quot;postDate&quot;, new Date());</span><br><span class="line">//            builder.field(&quot;message&quot;, &quot;trying out es2&quot;);</span><br><span class="line">//        &#125;</span><br><span class="line">//        builder.endObject();</span><br><span class="line">//        request.source(builder);</span><br><span class="line">//        构建方法4</span><br><span class="line">//        request.source(&quot;user&quot;,&quot;tomas&quot;,</span><br><span class="line">//                    &quot;postDate&quot;,new Date(),</span><br><span class="line">//                &quot;message&quot;,&quot;trying out es2&quot;);</span><br><span class="line">//</span><br><span class="line">//        ========================可选参数===================================</span><br><span class="line">        //设置超时时间</span><br><span class="line">        request.timeout(TimeValue.timeValueSeconds(1));</span><br><span class="line">        request.timeout(&quot;1s&quot;);</span><br><span class="line"></span><br><span class="line">        //自己维护版本号</span><br><span class="line">//        request.version(2);</span><br><span class="line">//        request.versionType(VersionType.EXTERNAL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">        //同步</span><br><span class="line">        IndexResponse indexResponse = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        //异步</span><br><span class="line">//        ActionListener&lt;IndexResponse&gt; listener=new ActionListener&lt;IndexResponse&gt;() &#123;</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onResponse(IndexResponse indexResponse) &#123;</span><br><span class="line">//</span><br><span class="line">//            &#125;</span><br><span class="line">//</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onFailure(Exception e) &#123;</span><br><span class="line">//</span><br><span class="line">//            &#125;</span><br><span class="line">//        &#125;;</span><br><span class="line">//        client.indexAsync(request,RequestOptions.DEFAULT, listener );</span><br><span class="line">//        try &#123;</span><br><span class="line">//            Thread.sleep(5000);</span><br><span class="line">//        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">//        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        3获取结果</span><br><span class="line">        String index = indexResponse.getIndex();</span><br><span class="line">        String id = indexResponse.getId();</span><br><span class="line">        //获取插入的类型</span><br><span class="line">        if(indexResponse.getResult()== DocWriteResponse.Result.CREATED)&#123;</span><br><span class="line">            DocWriteResponse.Result result=indexResponse.getResult();</span><br><span class="line">            System.out.println(&quot;CREATED:&quot;+result);</span><br><span class="line">        &#125;</span><br><span class="line">        #有可能是全局替换put</span><br><span class="line">        else if(indexResponse.getResult()== DocWriteResponse.Result.UPDATED)&#123;</span><br><span class="line">            DocWriteResponse.Result result=indexResponse.getResult();</span><br><span class="line">            System.out.println(&quot;UPDATED:&quot;+result);</span><br><span class="line">        &#125;</span><br><span class="line">//        &quot;_shards&quot; : &#123;</span><br><span class="line">        //2个分片1主1备</span><br><span class="line">//            &quot;total&quot; : 2,</span><br><span class="line">        //成功的是主分片</span><br><span class="line">//             &quot;successful&quot; : 1,</span><br><span class="line">//             &quot;failed&quot; : 0</span><br><span class="line">//        &#125;</span><br><span class="line">        ReplicationResponse.ShardInfo shardInfo = indexResponse.getShardInfo();</span><br><span class="line">        if(shardInfo.getTotal()!=shardInfo.getSuccessful())&#123;</span><br><span class="line">            System.out.println(&quot;处理成功的分片数少于总分片！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if(shardInfo.getFailed()&gt;0)&#123;</span><br><span class="line">           for (ReplicationResponse.ShardInfo.Failure failure:shardInfo.getFailures()) &#123;</span><br><span class="line">               String reason = failure.reason();//处理潜在的失败原因</span><br><span class="line">               System.out.println(reason);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><p>rest api</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">post /test_posts/_doc/3/_update </span><br><span class="line">&#123;</span><br><span class="line">   &quot;doc&quot;: &#123;</span><br><span class="line">      &quot;user&quot;：&quot;tomas J&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  @Test</span><br><span class="line">    public void testUpdate() throws IOException &#123;</span><br><span class="line">//        1构建请求</span><br><span class="line">        UpdateRequest request = new UpdateRequest(&quot;test_posts&quot;, &quot;3&quot;);</span><br><span class="line">        Map&lt;String, Object&gt; jsonMap = new HashMap&lt;&gt;();</span><br><span class="line">        jsonMap.put(&quot;user&quot;, &quot;tomas JJ&quot;);</span><br><span class="line">        request.doc(jsonMap);</span><br><span class="line">//===============================可选参数==========================================</span><br><span class="line">        request.timeout(&quot;1s&quot;);//超时时间</span><br><span class="line"></span><br><span class="line">        //重试次数</span><br><span class="line">        request.retryOnConflict(3);</span><br><span class="line"></span><br><span class="line">        //设置在继续更新之前，必须激活的分片数</span><br><span class="line">//        request.waitForActiveShards(2);</span><br><span class="line">        //所有分片都是active状态，才更新</span><br><span class="line">//        request.waitForActiveShards(ActiveShardCount.ALL);</span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">//        同步</span><br><span class="line">        UpdateResponse updateResponse = client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">//        异步</span><br><span class="line"></span><br><span class="line">//        3获取数据</span><br><span class="line">        updateResponse.getId();</span><br><span class="line">        updateResponse.getIndex();</span><br><span class="line"></span><br><span class="line">        //判断结果</span><br><span class="line">        if (updateResponse.getResult() == DocWriteResponse.Result.CREATED) &#123;</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;CREATED:&quot; + result);</span><br><span class="line">        &#125; else if (updateResponse.getResult() == DocWriteResponse.Result.UPDATED) &#123;</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;UPDATED:&quot; + result);</span><br><span class="line">        &#125;else if(updateResponse.getResult() == DocWriteResponse.Result.DELETED)&#123;</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;DELETED:&quot; + result);</span><br><span class="line">        &#125;else if (updateResponse.getResult() == DocWriteResponse.Result.NOOP)&#123;</span><br><span class="line">            //没有操作</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;NOOP:&quot; + result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>rest api</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /test_posts/_doc/3</span><br></pre></td></tr></table></figure>

<p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> @Test</span><br><span class="line">    public void testDelete() throws IOException &#123;</span><br><span class="line">//        1构建请求</span><br><span class="line">        DeleteRequest request =new DeleteRequest(&quot;test_posts&quot;,&quot;3&quot;);</span><br><span class="line">        //可选参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">        DeleteResponse deleteResponse = client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        3获取数据</span><br><span class="line">        deleteResponse.getId();</span><br><span class="line">        deleteResponse.getIndex();</span><br><span class="line"></span><br><span class="line">        DocWriteResponse.Result result = deleteResponse.getResult();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="批量增删改"><a href="#批量增删改" class="headerlink" title="批量增删改"></a>批量增删改</h3><p>rest api</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;action&quot;: &#123;&quot;metadata&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;data&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">    public void testBulk() throws IOException &#123;</span><br><span class="line">//        1创建请求</span><br><span class="line">        BulkRequest request = new BulkRequest();</span><br><span class="line">//        request.add(new IndexRequest(&quot;tast-bulk&quot;).id(&quot;1&quot;).source(XContentType.JSON, &quot;field&quot;, &quot;1&quot;));</span><br><span class="line">//        request.add(new IndexRequest(&quot;tast-bulk&quot;).id(&quot;2&quot;).source(XContentType.JSON, &quot;field&quot;, &quot;2&quot;));</span><br><span class="line"></span><br><span class="line">        request.add(new UpdateRequest(&quot;tast-bulk&quot;,&quot;2&quot;).doc(XContentType.JSON, &quot;field&quot;, &quot;3&quot;));</span><br><span class="line">        request.add(new DeleteRequest(&quot;tast-bulk&quot;).id(&quot;1&quot;));</span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">        BulkResponse bulkResponse = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        for (BulkItemResponse itemResponse : bulkResponse) &#123;</span><br><span class="line">            DocWriteResponse itemResponseResponse = itemResponse.getResponse();</span><br><span class="line"></span><br><span class="line">            switch (itemResponse.getOpType()) &#123;</span><br><span class="line">               case INDEX:</span><br><span class="line">                    IndexResponse indexResponse = (IndexResponse) response;</span><br><span class="line">                    System.out.println(&quot;INDEX:&quot;+indexResponse.getResult());</span><br><span class="line">                    break;</span><br><span class="line">                case CREATE:</span><br><span class="line">                    IndexResponse createResponse = (IndexResponse) response;</span><br><span class="line">                    System.out.println(&quot;CREATE:&quot;+createResponse.getResult());</span><br><span class="line">                    break;</span><br><span class="line">                case UPDATE:</span><br><span class="line">                    UpdateResponse updateResponse = (UpdateResponse) response;</span><br><span class="line">                    System.out.println(&quot;UPDATE:&quot;+updateResponse.getResult());</span><br><span class="line">                    break;</span><br><span class="line">                case DELETE:</span><br><span class="line">                    DeleteResponse deleteResponse = (DeleteResponse) response;</span><br><span class="line">                    System.out.println(&quot;DELETE:&quot;+deleteResponse.getResult());</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="8-Mapping映射入门"><a href="#8-Mapping映射入门" class="headerlink" title="8.Mapping映射入门"></a>8.Mapping映射入门</h1><h2 id="1-什么是mapping映射"><a href="#1-什么是mapping映射" class="headerlink" title="1.什么是mapping映射"></a>1.什么是mapping映射</h2><p>概念：自动或手动为index中的_doc建立的一种数据结构和相关配置，简称为mapping映射。</p>
<p>插入几条数据，让es自动为我们建立一个索引</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /website/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;my first article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my first article in this website&quot;,</span><br><span class="line">  &quot;author_id&quot;: 11400</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-02&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;my second article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my second article in this website&quot;,</span><br><span class="line">  &quot;author_id&quot;: 11400</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">PUT /website/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-03&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;my third article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my third article in this website&quot;,</span><br><span class="line">  &quot;author_id&quot;: 11400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比数据库建表语句</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create table website(</span><br><span class="line">     post_date date,</span><br><span class="line">     title varchar(50),     </span><br><span class="line">     content varchar(100),</span><br><span class="line">     author_id int(11) </span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<p>动态映射：dynamic mapping，自动为我们建立index，以及对应的mapping，mapping中包含了每个field对应的数据类型，以及如何分词等设置。</p>
<p>重点：我们当然，后面会讲解，也可以手动在创建数据之前，先创建index，以及对应的mapping</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET  /website/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;website&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;author_id&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;content&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;post_date&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;title&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尝试各种搜索</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /website/_search?q=2019        0条结果             </span><br><span class="line">GET /website/_search?q=2019-01-01           1条结果</span><br><span class="line">GET /website/_search?q=post_date:2019-01-01     1条结果</span><br><span class="line">GET /website/_search?q=post_date:2019          0 条结果</span><br></pre></td></tr></table></figure>

<p>搜索结果为什么不一致，因为es自动建立mapping的时候，设置了不同的field不同的data type。不同的data type的分词、搜索等行为是不一样的。所以出现了_all field和post_date field的搜索表现完全不一样。</p>
<h3 id="条件字段查询语法"><a href="#条件字段查询语法" class="headerlink" title="条件字段查询语法"></a>条件字段查询语法</h3><p>GET /inidx/_search?q=值 </p>
<p>or</p>
<p>GET /inidx/_search?q=字段名：值</p>
<h2 id="2-精确匹配与全文搜索的对比分析"><a href="#2-精确匹配与全文搜索的对比分析" class="headerlink" title="2.精确匹配与全文搜索的对比分析"></a>2.精确匹配与全文搜索的对比分析</h2><h3 id="1-exact-value-精确匹配"><a href="#1-exact-value-精确匹配" class="headerlink" title="1 exact value 精确匹配"></a>1 exact value 精确匹配</h3><p>2019-01-01，exact value，搜索的时候，必须输入2019-01-01，才能搜索出来</p>
<p>如果你输入一个01，是搜索不出来的</p>
<p>select * from book where name= ‘java’</p>
<h3 id="2-full-text-全文检索"><a href="#2-full-text-全文检索" class="headerlink" title="2 full text 全文检索"></a>2 full text 全文检索</h3><p> 搜“笔记电脑”，笔记本电脑词条会不会出现。</p>
<p>select * from book where name like ‘%java%’</p>
<p>（1）缩写 vs. 全称：cn vs. china</p>
<p>（2）格式转化：like liked likes</p>
<p>（3）大小写：Tom vs tom</p>
<p>（4）同义词：like vs love</p>
<p>2019-01-01，2019 01 01，搜索2019，或者01，都可以搜索出来</p>
<p>china，搜索cn，也可以将china搜索出来</p>
<p>likes，搜索like，也可以将likes搜索出来</p>
<p>Tom，搜索tom，也可以将Tom搜索出来</p>
<p>like，搜索love，同义词，也可以将like搜索出来</p>
<p>就不是说单纯的只是匹配完整的一个值，而是可以对值进行拆分词语后（分词）进行匹配，也可以通过缩写、时态、大小写、同义词等进行匹配。深入 NPL,自然语义处理。</p>
<h2 id="3-全文检索下倒排索引核心原理快速揭秘"><a href="#3-全文检索下倒排索引核心原理快速揭秘" class="headerlink" title="3. 全文检索下倒排索引核心原理快速揭秘"></a>3. 全文检索下倒排索引核心原理快速揭秘</h2><p>doc1：I really liked my small dogs, and I think my mom also liked them.</p>
<p>doc2：He never liked any dogs, so I hope that my mom will not expect me to liked him.</p>
<h4 id="分词，初步的倒排索引的建立"><a href="#分词，初步的倒排索引的建立" class="headerlink" title="分词，初步的倒排索引的建立"></a>分词，初步的倒排索引的建立</h4><table>
<thead>
<tr>
<th>term</th>
<th><strong>doc1</strong></th>
<th><strong>doc2</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>I</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>really</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>liked</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>my</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>small</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>dogs</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>and</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>think</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>mom</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>also</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>them</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>He</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>never</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>any</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>so</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>hope</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>that</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>will</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>not</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>expect</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>me</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>to</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>him</strong></td>
<td></td>
<td>*</td>
</tr>
</tbody></table>
<p>演示了一下倒排索引最简单的建立的一个过程</p>
<h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><p>mother like little dog，不可能有任何结果</p>
<p>mother</p>
<p>like</p>
<p>little</p>
<p>dog</p>
<p>这不是我们想要的结果。同义词mom\mother在我们人类看来是一样。想进行标准化操作。</p>
<h4 id="重建倒排索引"><a href="#重建倒排索引" class="headerlink" title="重建倒排索引"></a>重建倒排索引</h4><p>normalization正规化，建立倒排索引的时候，会执行一个操作，也就是说对拆分出的各个单词进行相应的处理，以提升后面搜索的时候能够搜索到相关联的文档的概率</p>
<p>时态的转换，单复数的转换，同义词的转换，大小写的转换</p>
<p>mom ―&gt; mother</p>
<p>liked ―&gt; like</p>
<p>small ―&gt; little</p>
<p>dogs ―&gt; dog</p>
<p>重新建立倒排索引，加入normalization，再次用mother liked little dog搜索，就可以搜索到了</p>
<table>
<thead>
<tr>
<th><strong>word</strong></th>
<th><strong>doc1</strong></th>
<th><strong>doc2</strong></th>
<th><strong>normalization</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>I</strong></td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>really</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>like</strong></td>
<td>*</td>
<td>*</td>
<td>liked ―&gt; like</td>
</tr>
<tr>
<td><strong>my</strong></td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>little</strong></td>
<td>*</td>
<td></td>
<td>small ―&gt; little</td>
</tr>
<tr>
<td><strong>dog</strong></td>
<td>*</td>
<td></td>
<td>dogs ―&gt; dog</td>
</tr>
<tr>
<td><strong>and</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>think</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>mother</strong></td>
<td>*</td>
<td>*</td>
<td>mom ―&gt; mother</td>
</tr>
<tr>
<td><strong>also</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>them</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>He</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>never</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>any</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>so</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>hope</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>that</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>will</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>not</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>expect</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>me</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>to</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>him</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
</tbody></table>
<h4 id="重新搜索"><a href="#重新搜索" class="headerlink" title="重新搜索"></a>重新搜索</h4><p>搜索：mother liked  little dog，</p>
<p> 对搜索条件经行分词 normalization</p>
<p>mother </p>
<p>liked  -》like</p>
<p> little </p>
<p>dog</p>
<p>doc1和doc2都会搜索出来</p>
<h2 id="4-分词器-analyzer"><a href="#4-分词器-analyzer" class="headerlink" title="4. 分词器 analyzer"></a>4. 分词器 analyzer</h2><p>作用：切分词语，normalization（提升recall召回率）</p>
<p>给你一段句子，然后将这段句子拆分成一个一个的单个的单词，同时对每个单词进行normalization（时态转换，单复数转换）</p>
<p>recall，召回率：搜索的时候，增加能够搜索到的结果的数量</p>
<p>analyzer 组成部分：</p>
<p>1、character filter：在一段文本进行分词之前，先进行预处理，比如说最常见的就是，过滤html标签（<span>hello<span> –&gt; hello），&amp; –&gt; and（I&amp;you –&gt; I and you）</span></span></p>
<p>2、tokenizer：分词，hello you and me –&gt; hello, you, and, me</p>
<p>3、token filter(转换，过滤)：lowercase，stop word（停用词： 了 的 呢），synonymom，dogs –&gt; dog，liked –&gt; like，Tom –&gt; tom，a/the/an –&gt; 干掉，mother –&gt; mom，small –&gt; little</p>
<p>一个分词器，很重要，将一段文本进行各种处理，最后处理好的结果才会拿去建立倒排索引。</p>
<h2 id="5-query-string根据字段分词策略"><a href="#5-query-string根据字段分词策略" class="headerlink" title="5.query string根据字段分词策略"></a>5.query string根据字段分词策略</h2><p>query string对exact value和full text的区别对待</p>
<p>如： date：exact value 精确匹配</p>
<p>​         text: full text 全文检索</p>
<h3 id="测试分词器"><a href="#测试分词器" class="headerlink" title="测试分词器"></a>测试分词器</h3><p>standard:标准分词器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Text to analyze 80&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;text&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;to&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 5,</span><br><span class="line">      &quot;end_offset&quot; : 7,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;analyze&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 8,</span><br><span class="line">      &quot;end_offset&quot; : 15,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;80&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 16,</span><br><span class="line">      &quot;end_offset&quot; : 18,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;NUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>token 实际存储的term 关键字</p>
<p>position 在此词条在原文本中的位置</p>
<p>start_offset/end_offset字符在原始字符串中的位置</p>
<h2 id="6-dynamic-mapping-推测规则"><a href="#6-dynamic-mapping-推测规则" class="headerlink" title="6.dynamic mapping 推测规则"></a>6.dynamic mapping 推测规则</h2><p>true or false   –&gt; boolean</p>
<p>123     –&gt; long</p>
<p>120.45      –&gt; double</p>
<p>2019-01-01  –&gt; date</p>
<p>“hello world”   –&gt; text/keywod</p>
<h2 id="7-手动管理mapping"><a href="#7-手动管理mapping" class="headerlink" title="7.手动管理mapping"></a>7.手动管理mapping</h2><h3 id="1-查询所有索引的映射"><a href="#1-查询所有索引的映射" class="headerlink" title="1.查询所有索引的映射"></a>1.查询所有索引的映射</h3><p>GET /_mapping</p>
<h3 id="2-创建映射-！！"><a href="#2-创建映射-！！" class="headerlink" title="2 创建映射 ！！"></a>2 创建映射 ！！</h3><p>创建索引后，应该立即手动创建映射</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT book/_mapping</span><br><span class="line">&#123;</span><br><span class="line">	&quot;properties&quot;: &#123;</span><br><span class="line">           &quot;name&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">           &quot;description&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">              &quot;analyzer&quot;:&quot;english&quot;,</span><br><span class="line">              &quot;search_analyzer&quot;:&quot;english&quot;</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;pic&quot;:&#123;</span><br><span class="line">             &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">             &quot;index&quot;:false</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;studymodel&quot;:&#123;</span><br><span class="line">             &quot;type&quot;:&quot;text&quot;</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Text-文本类型"><a href="#Text-文本类型" class="headerlink" title="Text 文本类型"></a>Text 文本类型</h4><h4 id="1）analyzer"><a href="#1）analyzer" class="headerlink" title="1）analyzer"></a>1）analyzer</h4><p>通过analyzer属性指定分词器。</p>
<p>上边指定了analyzer是指在索引和搜索都使用english，如果单独想定义搜索时使用的分词器则可以通过search_analyzer属性。</p>
<h4 id="2）index-是否可以作为搜索条件"><a href="#2）index-是否可以作为搜索条件" class="headerlink" title="2）index (是否可以作为搜索条件)"></a>2）index (是否可以作为搜索条件)</h4><p>index属性指定是否索引。</p>
<p>默认为index=true，即要进行索引，只有进行索引才可以从索引库搜索到。</p>
<p>但是也有一些内容不需要索引，比如：商品图片地址只被用来展示图片，不进行搜索图片，此时可以将index设置为false。</p>
<p>删除索引，重新创建映射，将pic的index设置为false，尝试根据pic去搜索，结果搜索不到数据。</p>
<h4 id="3）store（一般不设置）"><a href="#3）store（一般不设置）" class="headerlink" title="3）store（一般不设置）"></a>3）store（一般不设置）</h4><p>是否在source之外存储，每个文档索引后会在 ES中保存一份原始文档，存放在”_source”中，一般情况下不需要设置store为true，因为在_source中已经有一份原始文档了。</p>
<h3 id="3-keyword关键字字段"><a href="#3-keyword关键字字段" class="headerlink" title="3.keyword关键字字段"></a>3.keyword关键字字段</h3><p> 目前已经取代了”index”: false。上边介绍的text文本字段在映射时要设置分词器，keyword字段为关键字字段，通常搜索keyword是按照整体搜索，所以创建keyword字段的索引时是不进行分词的，比如：邮政编码、手机号码、身份证等。keyword字段通常用于过虑、排序、聚合等。</p>
<p><img src="/../img/image-20220224152656851.png" alt="image-20220224152656851"></p>
<h3 id="4-date日期类型"><a href="#4-date日期类型" class="headerlink" title="4.date日期类型"></a>4.date日期类型</h3><p>日期类型不用设置分词器。</p>
<p>通常日期类型的字段用于排序。</p>
<p>format</p>
<p>通过format设置日期格式</p>
<p>例子：</p>
<p>下边的设置允许date字段存储年月日时分秒、年月日及毫秒三种格式。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">​    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">​        <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">​          <span class="attr">&quot;type&quot;</span>:   <span class="string">&quot;date&quot;</span>,</span><br><span class="line">​          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd&quot;</span></span><br><span class="line">​        &#125;</span><br><span class="line">​      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入文档：</p>
<p>Post book/doc/3 </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;name&quot;</span>: <span class="string">&quot;spring开发基础&quot;</span>,</span><br><span class="line"><span class="attr">&quot;description&quot;</span>: <span class="string">&quot;spring 在java领域非常流行，java程序员都在用。&quot;</span>,</span><br><span class="line"><span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line"><span class="attr">&quot;pic&quot;</span>:<span class="string">&quot;group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-07-04 18:28:58&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-数值类型"><a href="#5-数值类型" class="headerlink" title="5.数值类型"></a>5.数值类型</h3><p>1、尽量选择范围小的类型，提高搜索效率</p>
<p>2、对于浮点数尽量用比例因子，比如一个价格字段，单位为元，我们将比例因子设置为100这在ES中会按 分 存储，映射如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;price&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;scaled_float&quot;,</span><br><span class="line">        &quot;scaling_factor&quot;: 100</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>由于比例因子为100，如果我们输入的价格是20.45则ES中会将20.45乘以100存储在ES中。</p>
<p>如果输入的价格是20.456，ES会将20.456乘以100再取一个接近原始值的数，得出2346。</p>
<p>使用比例因子的好处是整型比浮点型更易压缩，节省磁盘空间。</p>
<h3 id="6-修改映射-只能新增"><a href="#6-修改映射-只能新增" class="headerlink" title="6.修改映射(只能新增)"></a>6.修改映射(只能新增)</h3><p>只能创建index时手动建立mapping，或者新增field mapping，但是不能update field mapping。</p>
<p>因为已有数据按照映射早已分词存储好。如果修改，那这些存量数据怎么办。</p>
<p>新增一个字段mapping</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /book/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot; : &#123;</span><br><span class="line">    &quot;myfield&quot; : &#123;</span><br><span class="line">      &quot;type&quot; :    &quot;text&quot;,</span><br><span class="line">     &quot;index&quot;:    &quot;false&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-删除映射"><a href="#7-删除映射" class="headerlink" title="7.删除映射"></a>7.删除映射</h3><p>通过删除索引来删除映射</p>
<h2 id="8-复杂数据类型"><a href="#8-复杂数据类型" class="headerlink" title="8.复杂数据类型"></a>8.复杂数据类型</h2><p>如何存储？</p>
<h3 id="1-multivalue-field多值字段。eg：数组"><a href="#1-multivalue-field多值字段。eg：数组" class="headerlink" title="1 multivalue field多值字段。eg：数组"></a>1 multivalue field多值字段。eg：数组</h3><p>{ “tags”: [ “tag1”, “tag2” ]}</p>
<p>建立索引时与string是一样的，数据类型不能混</p>
<h3 id="2-empty-field空值"><a href="#2-empty-field空值" class="headerlink" title="2. empty field空值"></a>2. empty field空值</h3><p>text:null，</p>
<p>数组:[]，[null]</p>
<h3 id="3-object-field对象"><a href="#3-object-field对象" class="headerlink" title="3. object field对象"></a>3. object field对象</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /company/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;country&quot;: &quot;china&quot;,</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;name&quot;: &quot;jack&quot;,</span><br><span class="line">  &quot;age&quot;: 27,</span><br><span class="line">  &quot;join_date&quot;: &quot;2019-01-01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>address：object类型</p>
<p>查询映射</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /company/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;company&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;address&quot; : &#123;</span><br><span class="line">          &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;city&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;keyword&quot; : &#123;</span><br><span class="line">                  &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                  &quot;ignore_above&quot; : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;country&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;keyword&quot; : &#123;</span><br><span class="line">                  &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                  &quot;ignore_above&quot; : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;province&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;keyword&quot; : &#123;</span><br><span class="line">                  &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                  &quot;ignore_above&quot; : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;join_date&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>object</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;country&quot;: &quot;china&quot;,</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;name&quot;: &quot;jack&quot;,</span><br><span class="line">  &quot;age&quot;: 27,</span><br><span class="line">  &quot;join_date&quot;: &quot;2017-01-01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>底层存储格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:            [jack],</span><br><span class="line">    &quot;age&quot;:          [27],</span><br><span class="line">    &quot;join_date&quot;:      [2017-01-01],</span><br><span class="line">    &quot;address.country&quot;:         [china],</span><br><span class="line">    &quot;address.province&quot;:   [guangdong],</span><br><span class="line">    &quot;address.city&quot;:  [guangzhou]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对象数组：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;authors&quot;: [</span><br><span class="line">        &#123; &quot;age&quot;: 26, &quot;name&quot;: &quot;Jack White&quot;&#125;,</span><br><span class="line">        &#123; &quot;age&quot;: 55, &quot;name&quot;: &quot;Tom Jones&quot;&#125;,</span><br><span class="line">        &#123; &quot;age&quot;: 39, &quot;name&quot;: &quot;Kitty Smith&quot;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存储格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;authors.age&quot;:    [26, 55, 39],</span><br><span class="line">    &quot;authors.name&quot;:   [jack, white, tom, jones, kitty, smith]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：如何把底层存储封装成原始数据？</p>
<h1 id="9-索引Index入门"><a href="#9-索引Index入门" class="headerlink" title="9.索引Index入门"></a>9.索引Index入门</h1><h2 id="1-索引管理"><a href="#1-索引管理" class="headerlink" title="1.索引管理"></a>1.索引管理</h2><h3 id="1-为什么我们要手动创建索引"><a href="#1-为什么我们要手动创建索引" class="headerlink" title="1.为什么我们要手动创建索引"></a>1.为什么我们要手动创建索引</h3><p>直接put数据 PUT index/_doc/1,es会自动生成索引，并建立动态映射dynamic mapping。</p>
<p>在生产上，我们需要自己手动建立索引和映射，为了更好地管理索引。就像数据库的建表语句一样。</p>
<h2 id="2-索引管理"><a href="#2-索引管理" class="headerlink" title="2. 索引管理"></a>2. 索引管理</h2><h4 id="1创建索引，同时创建映射，8-7是创建以后再创建映射"><a href="#1创建索引，同时创建映射，8-7是创建以后再创建映射" class="headerlink" title="1创建索引，同时创建映射，8.7是创建以后再创建映射"></a>1创建索引，同时创建映射，8.7是创建以后再创建映射</h4><p>创建索引的语法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123; ... any settings ... &#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">       &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aliases&quot;: &#123;</span><br><span class="line">    	&quot;default_index&quot;: &#123;&#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setttings：分片数，副本数等</p>
<p>aliases：别名</p>
<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;field1&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;field2&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;default_index&quot;: &#123;&#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>索引别名</strong></p>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">	&quot;field1&quot;:&quot;java&quot;,</span><br><span class="line">	&quot;field2&quot;:&quot;js&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询数据 都可以查到</p>
<p>GET /my_index/_doc/1</p>
<p>GET /default_index/_doc/1</p>
<h4 id="2查询索引"><a href="#2查询索引" class="headerlink" title="2查询索引"></a>2查询索引</h4><p>GET /my_index/_mapping 映射</p>
<p>GET /my_index/_setting 一些信息</p>
<h4 id="3修改索引"><a href="#3修改索引" class="headerlink" title="3修改索引"></a>3修改索引</h4><p>修改副本数</p>
<p><img src="/../img/image-20220224161808604.png" alt="image-20220224161808604"></p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_replicas&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4删除索引"><a href="#4删除索引" class="headerlink" title="4删除索引"></a>4删除索引</h4><p>DELETE /my_index</p>
<p>DELETE /index_one,index_two</p>
<p>DELETE /index_*</p>
<p>DELETE /_all</p>
<p>为了安全起见，防止恶意删除索引，删除时必须指定索引名：</p>
<p>elasticsearch.yml</p>
<p>action.destructive_requires_name: true</p>
<h2 id="3-定制分词器"><a href="#3-定制分词器" class="headerlink" title="3.定制分词器"></a>3.定制分词器</h2><h3 id="1-默认的分词器"><a href="#1-默认的分词器" class="headerlink" title="1 默认的分词器"></a>1 默认的分词器</h3><p>standard</p>
<p>分词三个组件，character filter，tokenizer，token filter</p>
<p>standard tokenizer：以单词边界进行切分</p>
<p>standard token filter：什么都不做</p>
<p>lowercase token filter：将所有字母转换为小写</p>
<p>stop token filer（默认被禁用）：移除停用词，比如a the it等等</p>
<h3 id="2-修改分词器的设置"><a href="#2-修改分词器的设置" class="headerlink" title="2 修改分词器的设置"></a>2 修改分词器的设置</h3><p>启用english停用词token filter</p>
<p>“stopwords”: “<em>english</em>“ 根据英文移除停用词</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_std&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;stopwords&quot;: &quot;_english_&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试standard标准分词，发现拆分成了6个，因为默认禁用停用词过滤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;, </span><br><span class="line">  &quot;text&quot;: &quot;a dog is in the house&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220224162625340.png" alt="image-20220224162625340"></p>
<p><img src="/../img/image-20220224162633126.png" alt="image-20220224162633126"></p>
<p>测试自定义的分词器策略，发现只有两个，英文里的a,is等都过滤了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_std&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;a dog is in the house&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../img/image-20220224162745694.png" alt="image-20220224162745694"></p>
<h3 id="3-定制化自己的分词器"><a href="#3-定制化自己的分词器" class="headerlink" title="3 定制化自己的分词器"></a>3 定制化自己的分词器</h3><p><img src="/../img/image-20220224163107072.png" alt="image-20220224163107072"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">    #第一个自定义分词器</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;&amp;_to_and&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;mapping&quot;,</span><br><span class="line">          &quot;mappings&quot;: [&quot;&amp;=&gt; and&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    #第二个自定义分词器</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;my_stopwords&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;stop&quot;,</span><br><span class="line">          &quot;stopwords&quot;: [&quot;the&quot;, &quot;a&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      #自己的分词器有三个阶段，填写前两个自定义的分词器</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [&quot;html_strip&quot;, &quot;&amp;_to_and&quot;],</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;filter&quot;: [&quot;lowercase&quot;, &quot;my_stopwords&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;tom&amp;jerry are a friend in the house, &lt;a&gt;, HAHA!!&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置字段使用自定义分词器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-定制dynamic-mapping"><a href="#4-定制dynamic-mapping" class="headerlink" title="4.定制dynamic mapping"></a>4.定制dynamic mapping</h3><p>true：遇到陌生字段，就进行dynamic mapping</p>
<p>false：新检测到的字段将被忽略。这些字段将不会被索引，因此将无法搜索，但仍将出现在返回点击的源字段中。这些字段不会添加到映射中，必须显式添加新字段。</p>
<p>strict：遇到陌生字段，就报错</p>
<p>创建mapping</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;dynamic&quot;: &quot;strict&quot;,</span><br><span class="line">       &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;address&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">          &quot;dynamic&quot;: &quot;true&quot;</span><br><span class="line">        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;my article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my article&quot;,</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;strict_dynamic_mapping_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;mapping set to strict, dynamic introduction of [content] within [_doc] is not allowed&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;strict_dynamic_mapping_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;mapping set to strict, dynamic introduction of [content] within [_doc] is not allowed&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-自定义-dynamic-mapping策略"><a href="#5-自定义-dynamic-mapping策略" class="headerlink" title="5.自定义 dynamic mapping策略"></a>5.自定义 dynamic mapping策略</h3><p>es会根据传入的值，推断类型。</p>
<p><img src="/../img/1569123478530.png" alt="1569123478530"></p>
<h4 id="date-detection-日期探测"><a href="#date-detection-日期探测" class="headerlink" title="date_detection 日期探测"></a>date_detection 日期探测</h4><p>默认会按照一定格式识别date，比如yyyy-MM-dd。但是如果某个field先过来一个2017-01-01的值，就会被自动dynamic mapping成date，后面如果再来一个”hello world”之类的值，就会报错。可以手动关闭某个type的date_detection，如果有需要，自己手动指定某个field为date类型。</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;date_detection&quot;: false,</span><br><span class="line">       &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;address&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">          &quot;dynamic&quot;: &quot;true&quot;</span><br><span class="line">        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;my article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my article&quot;,</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;post_date&quot;:&quot;2019-09-10&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看映射，发现post_date是text</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /my_index/_mapping</span><br></pre></td></tr></table></figure>

<h4 id="自定义日期格式"><a href="#自定义日期格式" class="headerlink" title="自定义日期格式"></a>自定义日期格式</h4><figure class="highlight console"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_date_formats&quot;: [&quot;MM/dd/yyyy&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入数据</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;create_date&quot;: &quot;09/25/2019&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="numeric-detection-数字探测"><a href="#numeric-detection-数字探测" class="headerlink" title="numeric_detection 数字探测"></a>numeric_detection 数字探测</h4><p>虽然json支持本机浮点和整数数据类型，但某些应用程序或语言有时可能将数字呈现为字符串。通常正确的解决方案是显式地映射这些字段，但是可以启用数字检测（默认情况下禁用）来自动完成这些操作。</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;numeric_detection&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;my_float&quot;:   &quot;1.0&quot;, </span><br><span class="line">  &quot;my_integer&quot;: &quot;1&quot; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-定制自己的dynamic-mapping-template"><a href="#6-定制自己的dynamic-mapping-template" class="headerlink" title="6.定制自己的dynamic mapping template"></a>6.定制自己的dynamic mapping template</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">            &quot;dynamic_templates&quot;: [</span><br><span class="line">                &#123; </span><br><span class="line">                #第一个自定义的名称为en的策略</span><br><span class="line">                #当属性名是以_en结尾的，并且是string类型的话，映射为text，分词器为english，去掉停用词</span><br><span class="line">                  &quot;en&quot;: &#123;</span><br><span class="line">                      &quot;match&quot;:              &quot;*_en&quot;, </span><br><span class="line">                      &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">                      &quot;mapping&quot;: &#123;</span><br><span class="line">                          &quot;type&quot;:           &quot;text&quot;,</span><br><span class="line">                          &quot;analyzer&quot;:       &quot;english&quot;</span><br><span class="line">                      &#125;</span><br><span class="line">                &#125;                  </span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;this is my first article&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title_en&quot;: &quot;this is my first article&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET my_index/_search?q=first</span><br><span class="line">GET my_index/_search?q=is</span><br></pre></td></tr></table></figure>

<p>title没有匹配到任何的dynamic模板，默认就是standard分词器，不会过滤停用词，is会进入倒排索引，用is来搜索是可以搜索到的</p>
<p>title_en匹配到了dynamic模板，就是english分词器，会过滤停用词，is这种停用词就会被过滤掉，用is来搜索就搜索不到了</p>
<h4 id="模板写法"><a href="#模板写法" class="headerlink" title="模板写法"></a>模板写法</h4><figure class="highlight console"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;integers&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;long&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;strings&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;raw&quot;: &#123;</span><br><span class="line">                &quot;type&quot;:  &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模板参数</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">&quot;match&quot;:   &quot;long_*&quot;,</span><br><span class="line">&quot;unmatch&quot;: &quot;*_text&quot;,</span><br><span class="line">&quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">&quot;path_match&quot;:   &quot;name.*&quot;,  以name.***的属性名</span><br><span class="line">&quot;path_unmatch&quot;: &quot;*.middle&quot;,</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;match_pattern&quot;</span>: <span class="string">&quot;regex&quot;</span>,</span><br><span class="line"><span class="string">&quot;match&quot;</span>: <span class="string">&quot;^profit_\d+$&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>1结构化搜索，仅能搜索到关键字，like name=’a’</p>
<p>默认情况下，elasticsearch将字符串字段映射为带有子关键字字段的文本字段。但是，如果只对结构化内容进行索引，而对全文搜索不感兴趣，则可以仅将“字段”映射为“关键字”。请注意，这意味着为了搜索这些字段，必须搜索索引所用的完全相同的值。</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">         &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">         &quot;mapping&quot;: &#123;</span><br><span class="line">           &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>2仅搜索,都进行分词，去全文搜索</p>
<p>与前面的示例相反，如果您只关心字符串字段的全文搜索，并且不打算对字符串字段运行聚合、排序或精确搜索，您可以告诉弹性搜索将其仅映射为文本字段（这是5之前的默认行为）</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       &quot;strings_as_text&quot;: &#123;</span><br><span class="line">         &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">         &quot;mapping&quot;: &#123;</span><br><span class="line">           &quot;type&quot;: &quot;text&quot;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>3norms 不关心评分，不进行排序，直接返回匹配结果</p>
<p>norms是指标时间的评分因素。如果您不关心评分，例如，如果您从不按评分对文档进行排序，则可以在索引中禁用这些评分因子的存储并节省一些空间。</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;norms&quot;: false,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-零停机重建索引"><a href="#7-零停机重建索引" class="headerlink" title="7.零停机重建索引"></a>7.零停机重建索引</h3><p>场景：</p>
<p>一个field的设置是不能被修改的，如果要修改一个Field，那么应该重新按照新的mapping，建立一个index，然后将数据批量查询出来，重新用bulk api写入index中。</p>
<p>批量查询的时候，建议采用scroll api，并且采用多线程并发的方式来reindex数据，每次scoll就查询指定日期的一段数据，交给一个线程即可。</p>
<p>(1)一开始，依靠dynamic mapping，插入数据，但是不小心有些数据是2019-09-10这种日期格式的，所以title这种field被自动映射为了date类型，实际上它应该是string类型的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;2019-09-10&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;2019-09-11&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）当后期向索引中加入string类型的title值的时候，就会报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;my first article&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;mapper_parsing_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;failed to parse [title]&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;mapper_parsing_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;failed to parse [title]&quot;,</span><br><span class="line">    &quot;caused_by&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">      &quot;reason&quot;: &quot;Invalid format: \&quot;my first article\&quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）如果此时想修改title的类型，是不可能的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;title&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;</span><br><span class="line">   	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（4）此时，唯一的办法，就是进行reindex，也就是说，重新建立一个索引，将旧索引的数据查询出来，再导入新索引。</p>
<p>（5）如果说旧索引的名字，是old_index，新索引的名字是new_index，终端java应用，已经在使用old_index在操作了，难道还要去停止java应用，修改使用的index为new_index，才重新启动java应用吗？这个过程中，就会导致java应用停机，可用性降低。</p>
<p>（6）所以说，给java应用一个别名，这个别名是指向旧索引的，java应用先用着，java应用先用prod_index alias来操作，此时实际指向的是旧的my_index</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_alias/prod_index</span><br></pre></td></tr></table></figure>

<p>（7）新建一个index，调整其title的类型为string</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index_new</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">		&quot;title&quot;: &#123;</span><br><span class="line">         &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（8）使用scroll api将数据批量查询出来</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /my_index/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,    </span><br><span class="line">    &quot;size&quot;:  1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_scroll_id&quot;: &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAADpAFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6QRY0b25zVFlWWlRqR3ZJajlfc3BXejJ3AAAAAAAAOkIWNG9uc1RZVlpUakd2SWo5X3NwV3oydwAAAAAAADpDFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6RBY0b25zVFlWWlRqR3ZJajlfc3BXejJ3&quot;,</span><br><span class="line">  &quot;took&quot;: 1,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: null,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;my_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;my_type&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: null,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;2019-01-02&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sort&quot;: [</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（9）采用bulk api将scoll查出来的一批数据，批量写入新索引</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; &quot;index&quot;:  &#123; &quot;_index&quot;: &quot;my_index_new&quot;, &quot;_id&quot;: &quot;1&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;:    &quot;2019-09-10&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>（10）反复循环8~9，查询一批又一批的数据出来，采取bulk api将每一批数据批量写入新索引</p>
<p>（11）将prod_index alias切换到my_index_new上去，java应用会直接通过index别名使用新的索引中的数据，java应用程序不需要停机，零提交，高可用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot;: [</span><br><span class="line">        &#123; &quot;remove&quot;: &#123; &quot;index&quot;: &quot;my_index&quot;, &quot;alias&quot;: &quot;prod_index&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;add&quot;:    &#123; &quot;index&quot;: &quot;my_index_new&quot;, &quot;alias&quot;: &quot;prod_index&quot; &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（12）直接通过prod_index别名来查询，是否ok</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /prod_index/_search</span><br></pre></td></tr></table></figure>

<h4 id="生产实践：基于alias对client透明切换index"><a href="#生产实践：基于alias对client透明切换index" class="headerlink" title="生产实践：基于alias对client透明切换index"></a>生产实践：基于alias对client透明切换index</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index_v1/_alias/my_index</span><br></pre></td></tr></table></figure>

<p>client对my_index进行操作</p>
<p>reindex操作，完成之后，切换v1到v2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot;: [</span><br><span class="line">        &#123; &quot;remove&quot;: &#123; &quot;index&quot;: &quot;my_index_v1&quot;, &quot;alias&quot;: &quot;my_index&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;add&quot;:    &#123; &quot;index&quot;: &quot;my_index_v2&quot;, &quot;alias&quot;: &quot;my_index&quot; &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="10-中文分词器-IK分词器"><a href="#10-中文分词器-IK分词器" class="headerlink" title="10.中文分词器 IK分词器"></a>10.中文分词器 IK分词器</h1><h2 id="1-Ik分词器安装使用"><a href="#1-Ik分词器安装使用" class="headerlink" title="1.Ik分词器安装使用"></a>1.Ik分词器安装使用</h2><h3 id="1-中文分词器"><a href="#1-中文分词器" class="headerlink" title="1 中文分词器"></a>1 中文分词器</h3><p>standard 分词器，仅适用于英文。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;中华人民共和国人民大会堂&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们想要的效果是什么：中华人民共和国，人民大会堂</p>
<p>IK分词器就是目前最流行的es中文分词器</p>
<h3 id="2-安装"><a href="#2-安装" class="headerlink" title="2 安装"></a>2 安装</h3><p>官网：<a href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>下载地址：<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
<p>根据es版本下载相应版本包。</p>
<p><img src="/../img/image-20220224174947935.png" alt="image-20220224174947935"></p>
<p>解压到 es/plugins/ik中。</p>
<p><img src="/../img/image-20220224175211958.png" alt="image-20220224175211958"></p>
<p>重启es</p>
<h3 id="3-ik分词器基础知识"><a href="#3-ik分词器基础知识" class="headerlink" title="3 ik分词器基础知识"></a>3 ik分词器基础知识</h3><p>ik_max_word: 会将文本做最细粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国，中华人民，中华，华人，人民共和国，人民大会堂，人民大会，大会堂”，会穷尽各种可能的组合；</p>
<p>ik_smart: 会做最粗粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国，人民大会堂”。</p>
<h3 id="4-ik分词器的使用"><a href="#4-ik分词器的使用" class="headerlink" title="4 ik分词器的使用"></a>4 ik分词器的使用</h3><p>存储时，使用ik_max_word，搜索会堂的时候，就可以搜到中华人民共和国人民大会堂这一个数据，因为倒排索引里最细划分里有会堂</p>
<p>搜索时，使用ik_smart，搜索中华人民共和国人民大会堂的时候，就不会搜索到会堂，国人一些的消息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /my_index </span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;text&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /my_index/_search?q=中华人民共和国人民大会堂</span><br></pre></td></tr></table></figure>

<h2 id="2-ik配置文件"><a href="#2-ik配置文件" class="headerlink" title="2. ik配置文件"></a>2. ik配置文件</h2><h3 id="1-ik配置文件"><a href="#1-ik配置文件" class="headerlink" title="1 ik配置文件"></a>1 ik配置文件</h3><p>ik配置文件地址：es/plugins/ik/config目录</p>
<p>IKAnalyzer.cfg.xml：用来配置自定义词库</p>
<p>main.dic：ik原生内置的中文词库，总共有27万多条，只要是这些单词，都会被分在一起</p>
<p>preposition.dic: 介词</p>
<p>quantifier.dic：放了一些单位相关的词，量词</p>
<p>suffix.dic：放了一些后缀</p>
<p>surname.dic：中国的姓氏</p>
<p>stopword.dic：英文停用词</p>
<p>ik原生最重要的两个配置文件</p>
<p>main.dic：包含了原生的中文词语，会按照这个里面的词语去分词</p>
<p>stopword.dic：包含了英文的停用词</p>
<p>停用词，stopword</p>
<p>a the and at but</p>
<p>一般，像停用词，会在分词的时候，直接被干掉，不会建立在倒排索引中</p>
<h3 id="2-自定义词库"><a href="#2-自定义词库" class="headerlink" title="2 自定义词库"></a>2 自定义词库</h3><p>（1）自己建立词库：每年都会涌现一些特殊的流行词，网红，蓝瘦香菇，喊麦，鬼畜，一般不会在ik的原生词典里</p>
<p>自己补充自己的最新的词语，到ik的词库里面</p>
<p>IKAnalyzer.cfg.xml：ext_dict，创建my.dic。</p>
<p>补充自己的词语，然后需要重启es，才能生效</p>
<p><img src="/../img/image-20220225083203969.png" alt="image-20220225083203969"></p>
<p><img src="/../img/image-20220225083218265.png" alt="image-20220225083218265"></p>
<p>（2）自己建立停用词库：比如了，的，啥，么，我们可能并不想去建立索引，让人家搜索</p>
<p>custom/ext_stopword.dic，已经有了常用的中文停用词，可以补充自己的停用词，然后重启es</p>
<p><img src="/../img/image-20220225083253377.png" alt="image-20220225083253377"></p>
<p><img src="/../img/image-20220225083317939.png" alt="image-20220225083317939"></p>
<h2 id="3-使用mysql热更新-词库"><a href="#3-使用mysql热更新-词库" class="headerlink" title="3.使用mysql热更新 词库"></a>3.使用mysql热更新 词库</h2><h3 id="1热更新"><a href="#1热更新" class="headerlink" title="1热更新"></a>1热更新</h3><p>每次都是在es的扩展词典中，手动添加新词语，很坑</p>
<p>（1）每次添加完，都要重启es才能生效，非常麻烦</p>
<p>（2）es是分布式的，可能有数百个节点，你不能每次都一个一个节点上面去修改</p>
<p>es不停机，直接我们在外部某个地方添加新的词语，es中立即热加载到这些新词语</p>
<p>热更新的方案</p>
<p>（1）基于ik分词器原生支持的热更新方案，部署一个web服务器，提供一个http接口，通过modified和tag两个http响应头，来提供词语的热更新</p>
<p>（2）修改ik分词器源码，然后手动支持从mysql中每隔一定时间，自动加载新的词库</p>
<p>用第二种方案，第一种，ik git社区官方都不建议采用，觉得不太稳定</p>
<h3 id="2步骤"><a href="#2步骤" class="headerlink" title="2步骤"></a>2步骤</h3><p>1、下载源码</p>
<p><a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
<p>ik分词器，是个标准的java maven工程，直接导入eclipse就可以看到源码</p>
<p>2、修改源</p>
<p>org.wltea.analyzer.dic.Dictionary类，160行Dictionary单例类的初始化方法，在这里需要创建一个我们自定义的线程，并且启动它</p>
<p>org.wltea.analyzer.dic.HotDictReloadThread类：就是死循环，不断调用Dictionary.getSingleton().reLoadMainDict()，去重新加载词典</p>
<p>Dictionary类，399行：this.loadMySQLExtDict(); 加载mymsql字典。</p>
<p>Dictionary类，609行：this.loadMySQLStopwordDict();加载mysql停用词</p>
<h4 id="主要修改"><a href="#主要修改" class="headerlink" title="主要修改"></a>主要修改</h4><p>config下jdbc-reload.properties。mysql配置文件</p>
<p>3、mvn package打包代码</p>
<p>target\releases\elasticsearch-analysis-ik-7.3.0.zip</p>
<p>4、解压缩ik压缩包</p>
<p>将mysql驱动jar，替换ik的目录下</p>
<p>5、把jdbc-reload.properties放入改目录下以供jar包读取</p>
<p><img src="/../img/image-20220225085513874.png" alt="image-20220225085513874"></p>
<p>把mysql的驱动包放入es的lib包</p>
<p><img src="/../img/image-20220225085741554.png" alt="image-20220225085741554"></p>
<p>6、重启es</p>
<p>观察日志，日志中就会显示我们打印的那些东西，比如加载了什么配置，加载了什么词语，什么停用词</p>
<p>7、在mysql中添加词库与停用词</p>
<p>8、分词实验，验证热更新生效</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;传智播客&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="11-java-api-实现索引管理"><a href="#11-java-api-实现索引管理" class="headerlink" title="11.java api 实现索引管理"></a>11.java api 实现索引管理</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.ActionListener;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.alias.Alias;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.close.CloseIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.open.OpenIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.open.OpenIndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.support.ActiveShardCount;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.support.master.AcknowledgedResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.IndicesClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.GetIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.unit.TimeValue;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> - <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> - <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestIndex</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    RestClient restClient;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建索引</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//创建索引对象</span></span><br><span class="line">        CreateIndexRequest createIndexRequest = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;itheima_book&quot;</span>);</span><br><span class="line">        <span class="comment">//设置参数</span></span><br><span class="line">        createIndexRequest.settings(Settings.builder().put(<span class="string">&quot;number_of_shards&quot;</span>, <span class="string">&quot;1&quot;</span>).put(<span class="string">&quot;number_of_replicas&quot;</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">        <span class="comment">//指定映射1</span></span><br><span class="line">        createIndexRequest.mapping(<span class="string">&quot; &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \t\&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;name\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;type\&quot;:\&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           \&quot;description\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              \&quot;type\&quot;: \&quot;text\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;price\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;type\&quot;:\&quot;long\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           \&quot;pic\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;type\&quot;:\&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;index\&quot;:false\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \t&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定映射2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        Map&lt;String, Object&gt; message = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        message.put(&quot;type&quot;, &quot;text&quot;);</span></span><br><span class="line"><span class="comment">//        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        properties.put(&quot;message&quot;, message);</span></span><br><span class="line"><span class="comment">//        Map&lt;String, Object&gt; mapping = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        mapping.put(&quot;properties&quot;, properties);</span></span><br><span class="line"><span class="comment">//        createIndexRequest.mapping(mapping);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定映射3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        XContentBuilder builder = XContentFactory.jsonBuilder();</span></span><br><span class="line"><span class="comment">//        builder.startObject();</span></span><br><span class="line"><span class="comment">//        &#123;</span></span><br><span class="line"><span class="comment">//            builder.startObject(&quot;properties&quot;);</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                builder.startObject(&quot;message&quot;);</span></span><br><span class="line"><span class="comment">//                &#123;</span></span><br><span class="line"><span class="comment">//                    builder.field(&quot;type&quot;, &quot;text&quot;);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//                builder.endObject();</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            builder.endObject();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        builder.endObject();</span></span><br><span class="line"><span class="comment">//        createIndexRequest.mapping(builder);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置别名</span></span><br><span class="line">        createIndexRequest.alias(<span class="keyword">new</span> Alias(<span class="string">&quot;itheima_index_new&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 额外参数</span></span><br><span class="line">        <span class="comment">//设置超时时间</span></span><br><span class="line">        createIndexRequest.setTimeout(TimeValue.timeValueMinutes(<span class="number">2</span>));</span><br><span class="line">        <span class="comment">//设置主节点超时时间</span></span><br><span class="line">        createIndexRequest.setMasterTimeout(TimeValue.timeValueMinutes(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//在创建索引API返回响应之前等待的活动分片副本的数量，以int形式表示</span></span><br><span class="line">        createIndexRequest.waitForActiveShards(ActiveShardCount.from(<span class="number">2</span>));</span><br><span class="line">        createIndexRequest.waitForActiveShards(ActiveShardCount.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作索引的客户端</span></span><br><span class="line">        IndicesClient indices = client.indices();</span><br><span class="line">        <span class="comment">//执行创建索引库</span></span><br><span class="line">        CreateIndexResponse createIndexResponse = indices.create(createIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到响应（全部）</span></span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = createIndexResponse.isAcknowledged();</span><br><span class="line">        <span class="comment">//得到响应 指示是否在超时前为索引中的每个分片启动了所需数量的碎片副本</span></span><br><span class="line">        <span class="keyword">boolean</span> shardsAcknowledged = createIndexResponse.isShardsAcknowledged();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span> + acknowledged);</span><br><span class="line">        System.out.println(shardsAcknowledged);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异步新增索引</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndexAsync</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//创建索引对象</span></span><br><span class="line">        CreateIndexRequest createIndexRequest = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;itheima_book2&quot;</span>);</span><br><span class="line">        <span class="comment">//设置参数</span></span><br><span class="line">        createIndexRequest.settings(Settings.builder().put(<span class="string">&quot;number_of_shards&quot;</span>, <span class="string">&quot;1&quot;</span>).put(<span class="string">&quot;number_of_replicas&quot;</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">        <span class="comment">//指定映射1</span></span><br><span class="line">        createIndexRequest.mapping(<span class="string">&quot; &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \t\&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;name\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;type\&quot;:\&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           \&quot;description\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;              \&quot;type\&quot;: \&quot;text\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;price\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;type\&quot;:\&quot;long\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           \&quot;pic\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;type\&quot;:\&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;             \&quot;index\&quot;:false\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;           &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \t&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//监听方法</span></span><br><span class="line">        ActionListener&lt;CreateIndexResponse&gt; listener =</span><br><span class="line">                <span class="keyword">new</span> ActionListener&lt;CreateIndexResponse&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(CreateIndexResponse createIndexResponse)</span> </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;!!!!!!!!创建索引成功&quot;</span>);</span><br><span class="line">                        System.out.println(createIndexResponse.toString());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;!!!!!!!!创建索引失败&quot;</span>);</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作索引的客户端</span></span><br><span class="line">        IndicesClient indices = client.indices();</span><br><span class="line">        <span class="comment">//执行创建索引库</span></span><br><span class="line">        indices.createAsync(createIndexRequest, RequestOptions.DEFAULT, listener);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除索引库</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//删除索引对象</span></span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;itheima_book2&quot;</span>);</span><br><span class="line">        <span class="comment">//操作索引的客户端</span></span><br><span class="line">        IndicesClient indices = client.indices();</span><br><span class="line">        <span class="comment">//执行删除索引</span></span><br><span class="line">        AcknowledgedResponse delete = indices.delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//得到响应</span></span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = delete.isAcknowledged();</span><br><span class="line">        System.out.println(acknowledged);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异步删除索引库</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteIndexAsync</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//删除索引对象</span></span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;itheima_book2&quot;</span>);</span><br><span class="line">        <span class="comment">//操作索引的客户端</span></span><br><span class="line">        IndicesClient indices = client.indices();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//监听方法</span></span><br><span class="line">        ActionListener&lt;AcknowledgedResponse&gt; listener =</span><br><span class="line">                <span class="keyword">new</span> ActionListener&lt;AcknowledgedResponse&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(AcknowledgedResponse deleteIndexResponse)</span> </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;!!!!!!!!删除索引成功&quot;</span>);</span><br><span class="line">                        System.out.println(deleteIndexResponse.toString());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;!!!!!!!!删除索引失败&quot;</span>);</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">        <span class="comment">//执行删除索引</span></span><br><span class="line">        indices.deleteAsync(deleteIndexRequest, RequestOptions.DEFAULT, listener);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indices Exists API</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExistIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        GetIndexRequest request = <span class="keyword">new</span> GetIndexRequest(<span class="string">&quot;itheima_book&quot;</span>);</span><br><span class="line">        request.local(<span class="keyword">false</span>);<span class="comment">//从主节点返回本地信息或检索状态</span></span><br><span class="line">        request.humanReadable(<span class="keyword">true</span>);<span class="comment">//以适合人类的格式返回结果</span></span><br><span class="line">        request.includeDefaults(<span class="keyword">false</span>);<span class="comment">//是否返回每个索引的所有默认设置</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> exists = client.indices().exists(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(exists);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indices Open API</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOpenIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        OpenIndexRequest request = <span class="keyword">new</span> OpenIndexRequest(<span class="string">&quot;itheima_book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        OpenIndexResponse openIndexResponse = client.indices().open(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = openIndexResponse.isAcknowledged();</span><br><span class="line">        System.out.println(<span class="string">&quot;!!!!!!!!!&quot;</span>+acknowledged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indices Close API</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCloseIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        CloseIndexRequest request = <span class="keyword">new</span> CloseIndexRequest(<span class="string">&quot;index&quot;</span>);</span><br><span class="line">        AcknowledgedResponse closeIndexResponse = client.indices().close(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = closeIndexResponse.isAcknowledged();</span><br><span class="line">        System.out.println(<span class="string">&quot;!!!!!!!!!&quot;</span>+acknowledged);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="12-search搜索入门"><a href="#12-search搜索入门" class="headerlink" title="12.search搜索入门"></a>12.search搜索入门</h1><h2 id="1-搜索语法入门"><a href="#1-搜索语法入门" class="headerlink" title="1. 搜索语法入门"></a>1. 搜索语法入门</h2><h3 id="1-1query-string-search"><a href="#1-1query-string-search" class="headerlink" title="1.1query string search"></a>1.1query string search</h3><p>无条件搜索所有 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 969,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 3,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;Bootstrap开发&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201002&quot;,</span><br><span class="line">          &quot;price&quot; : 38.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;bootstrap&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;java编程思想&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 68.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;java&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;spring开发基础&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 88.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-24 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;spring&quot;,</span><br><span class="line">            &quot;java&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释</p>
<p>took：耗费了几毫秒</p>
<p>timed_out：是否超时，这里是没有</p>
<p>_shards：到几个分片搜索，成功几个，跳过几个，失败几个。 </p>
<p>hits.total：查询结果的数量，3个document</p>
<p>hits.max_score：score的含义，就是document对于一个search的相关度的匹配分数，越相关，就越匹配，分数也高</p>
<p>hits.hits：包含了匹配搜索的document的所有详细数据</p>
<h3 id="1-2传参"><a href="#1-2传参" class="headerlink" title="1.2传参"></a>1.2传参</h3><p>与http请求传参类似</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search?q=name:java&amp;sort=price:desc</span><br></pre></td></tr></table></figure>

<p>类比sql:  select * from book where name like ’ %java%’ order by price desc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 2,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : null,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;java编程思想&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 68.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;java&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sort&quot; : [</span><br><span class="line">          68.6</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3timeout"><a href="#1-3timeout" class="headerlink" title="1.3timeout"></a>1.3timeout</h3><p>GET /book/_search?timeout=10ms</p>
<p>在timeout时间内能查到有几条就返回几条</p>
<p>全局设置：配置文件中添加一个设置 search.default_search_timeout：100ms。默认不超时。</p>
<h2 id="2．multi-index-多索引搜索"><a href="#2．multi-index-多索引搜索" class="headerlink" title="2．multi-index 多索引搜索"></a>2．multi-index 多索引搜索</h2><h3 id="2-1multi-index搜索模式"><a href="#2-1multi-index搜索模式" class="headerlink" title="2.1multi-index搜索模式"></a>2.1multi-index搜索模式</h3><p>告诉你如何一次性搜索多个index和多个type下的数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/_search：所有索引下的所有数据都搜索出来</span><br><span class="line">/index1/_search：指定一个index，搜索其下所有的数据</span><br><span class="line">/index1,index2/_search：同时搜索两个index下的数据</span><br><span class="line">/index*/_search：按照通配符去匹配多个索引</span><br></pre></td></tr></table></figure>

<p>应用场景：生产环境log索引可以按照日期分开。</p>
<p>log_to_es_20190910</p>
<p>log_to_es_20190911</p>
<p>log_to_es_20180910</p>
<h2 id="3．-分页搜索"><a href="#3．-分页搜索" class="headerlink" title="3． 分页搜索"></a>3． 分页搜索</h2><h3 id="3-1分页搜索的语法"><a href="#3-1分页搜索的语法" class="headerlink" title="3.1分页搜索的语法"></a>3.1分页搜索的语法</h3><p>sql: select * from book limit 1,5</p>
<p>size，from</p>
<p>GET /book/_search?size=10</p>
<p>GET /book/_search?size=10&amp;from=0</p>
<p>GET /book/_search?size=10&amp;from=20</p>
<p>GET /book_search?from=0&amp;size=3</p>
<h3 id="3-2deep-paging"><a href="#3-2deep-paging" class="headerlink" title="3.2deep paging"></a>3.2deep paging</h3><h4 id="什么是deep-paging"><a href="#什么是deep-paging" class="headerlink" title="什么是deep paging"></a>什么是deep paging</h4><p>eg：从9990条数据拿，拿10条到1w条</p>
<p>根据相关度评分倒排序，所以分页过深，协调节点会将大量数据聚合分析。</p>
<h4 id="deep-paging-性能问题"><a href="#deep-paging-性能问题" class="headerlink" title="deep paging 性能问题"></a>deep paging 性能问题</h4><p>1消耗网络带宽，因为所搜过深的话，各 shard 要把数据传递给 coordinate node，这个过程是有大量数据传递的，消耗网络。</p>
<p>2消耗内存，各 shard 要把数据传送给 coordinate node，这个传递回来的数据，是被 coordinate node 保存在内存中的，这样会大量消耗内存。</p>
<p>3消耗cup，coordinate node 要把传回来的数据进行排序，这个排序过程很消耗cpu。<br>所以：鉴于deep paging的性能问题，所有应尽量减少使用。</p>
<h2 id="4．-query-string基础语法"><a href="#4．-query-string基础语法" class="headerlink" title="4． query string基础语法"></a>4． query string基础语法</h2><h3 id="4-1query-string基础语法"><a href="#4-1query-string基础语法" class="headerlink" title="4.1query string基础语法"></a>4.1query string基础语法</h3><p>GET /book/_search?q=name:java 包含java</p>
<p>GET /book/_search?q=+name:java 包含java</p>
<p>GET /book/_search?q=-name:java  不包含java</p>
<p>一个是掌握q=field:search content的语法，还有一个是掌握+和-的含义</p>
<h3 id="4-2、-all-metadata的原理和作用"><a href="#4-2、-all-metadata的原理和作用" class="headerlink" title="4.2、_all metadata的原理和作用"></a>4.2、_all metadata的原理和作用</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search?q=java</span><br></pre></td></tr></table></figure>

<p>直接可以搜索所有的field，任意一个field包含指定的关键字就可以搜索出来。我们在进行中搜索的时候，难道是对document中的每一个field都进行一次搜索吗？不是的。</p>
<p>es中_all元数据。建立索引的时候，插入一条docunment，es会将所有的field值经行全量分词，把这些分词，放到_all field中。在搜索的时候，没有指定field，就在_all搜索。</p>
<p>举例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name:jack</span><br><span class="line">    email:123@qq.com</span><br><span class="line">    address:beijing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>_all : jack,<a href="mailto:&#49;&#50;&#51;&#x40;&#x71;&#113;&#x2e;&#x63;&#111;&#109;">&#49;&#50;&#51;&#x40;&#x71;&#113;&#x2e;&#x63;&#111;&#109;</a>,beijing </p>
<h2 id="5．-query-DSL入门"><a href="#5．-query-DSL入门" class="headerlink" title="5． query DSL入门"></a>5． query DSL入门</h2><h3 id="5-1-DSL"><a href="#5-1-DSL" class="headerlink" title="5.1 DSL"></a>5.1 DSL</h3><p>query string 后边的参数原来越多，搜索条件越来越复杂，不能满足需求。</p>
<p>GET /book/_search?q=name:java&amp;size=10&amp;from=0&amp;sort=price:desc</p>
<p>DSL:Domain Specified Language，特定领域的语言</p>
<p>es特有的搜索语言，可在请求体中携带搜索条件，功能强大。</p>
<p>查询全部 GET /book/_search</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>排序 GET /book/_search?q=name:java&amp;sort=price:desc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search </span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;name&quot; : &quot; java&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: [</span><br><span class="line">        &#123; &quot;price&quot;: &quot;desc&quot; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分页查询 GET /book/_search?size=10&amp;from=0</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET  /book/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指定返回字段 GET /book/ _search? _source=name,studymodel</p>
<h4 id="只返回name-studymodel这两个字段"><a href="#只返回name-studymodel这两个字段" class="headerlink" title="只返回name,studymodel这两个字段"></a>只返回name,studymodel这两个字段</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">  &quot;_source&quot;: [&quot;name&quot;, &quot;studymodel&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过组合以上各种类型查询，实现复杂查询。</p>
<h3 id="5-2．-Query-DSL语法"><a href="#5-2．-Query-DSL语法" class="headerlink" title="5.2． Query DSL语法"></a>5.2． Query DSL语法</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        ARGUMENT: VALUE,</span><br><span class="line">        ARGUMENT: VALUE,...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        FIELD_NAME: &#123;</span><br><span class="line">            ARGUMENT: VALUE,</span><br><span class="line">            ARGUMENT: VALUE,...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /test_index/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;test_field&quot;: &quot;test&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-组合多个搜索条件"><a href="#5-3-组合多个搜索条件" class="headerlink" title="5.3 组合多个搜索条件"></a>5.3 组合多个搜索条件</h3><p>搜索需求：title必须包含elasticsearch，content可以包含elasticsearch也可以不包含，author_id必须不为111</p>
<p>sql where  and or != </p>
<p>初始数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /website/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">          &quot;title&quot;: &quot;my hadoop article&quot;,</span><br><span class="line">          &quot;content&quot;: &quot;hadoop is very bad&quot;,</span><br><span class="line">          &quot;author_id&quot;: 111</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /website/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">          &quot;title&quot;: &quot;my elasticsearch  article&quot;,</span><br><span class="line">          &quot;content&quot;: &quot;es is very bad&quot;,</span><br><span class="line">          &quot;author_id&quot;: 112</span><br><span class="line">&#125;</span><br><span class="line">POST /website/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">          &quot;title&quot;: &quot;my elasticsearch article&quot;,</span><br><span class="line">          &quot;content&quot;: &quot;es is very goods&quot;,</span><br><span class="line">          &quot;author_id&quot;: 111</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /website/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;elasticsearch&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: &quot;elasticsearch&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;author_id&quot;: 111</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 488,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 0.47000363,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;website&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.47000363,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;title&quot; : &quot;my elasticsearch  article&quot;,</span><br><span class="line">          &quot;content&quot; : &quot;es is very bad&quot;,</span><br><span class="line">          &quot;author_id&quot; : 112</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更复杂的搜索需求：</p>
<p>select * from test_index where name=’tom’ or (hired =true and (personality =’good’ and rude != true ))</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">            &quot;bool&quot;: &#123;</span><br><span class="line">                &quot;must&quot;: &#123; &quot;match&quot;:&#123; &quot;name&quot;: &quot;tom&quot; &#125;&#125;,</span><br><span class="line">                &quot;should&quot;: [</span><br><span class="line">                    &#123; &quot;match&quot;:&#123; &quot;hired&quot;: true &#125;&#125;,</span><br><span class="line">                    &#123; &quot;bool&quot;: &#123;</span><br><span class="line">                        &quot;must&quot;:&#123; &quot;match&quot;: &#123; &quot;personality&quot;: &quot;good&quot; &#125;&#125;,</span><br><span class="line">                        &quot;must_not&quot;: &#123; &quot;match&quot;: &#123; &quot;rude&quot;: true &#125;&#125;</span><br><span class="line">                    &#125;&#125;</span><br><span class="line">                ],</span><br><span class="line">                &quot;minimum_should_match&quot;: 1</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-must-must-not-should"><a href="#5-4-must-must-not-should" class="headerlink" title="5.4 must  must_not should"></a>5.4 must  must_not should</h3><p>must:必须</p>
<p>must_not：必须不</p>
<p>should：可以包含也可以不包含 or</p>
<p>minimum_should_match：必须跟在should后面，表示</p>
<p>这两个至少有一个匹配</p>
<p><img src="/../img/image-20220225114124576.png" alt="image-20220225114124576"></p>
<h2 id="6．-full-text-search-全文检索"><a href="#6．-full-text-search-全文检索" class="headerlink" title="6． full-text search 全文检索"></a>6． full-text search 全文检索</h2><h3 id="6-1-全文检索"><a href="#6-1-全文检索" class="headerlink" title="6.1 全文检索"></a>6.1 全文检索</h3><p>重新创建book索引</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /book/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;name&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;description&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;studymodel&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;price&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;double&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;timestamp&quot;: &#123;</span><br><span class="line">         &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">         &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;pic&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">        &quot;index&quot;:false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /book/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;Bootstrap开发&quot;,</span><br><span class="line">&quot;description&quot;: &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201002&quot;,</span><br><span class="line">&quot;price&quot;:38.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;bootstrap&quot;, &quot;dev&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;java编程思想&quot;,</span><br><span class="line">&quot;description&quot;: &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">&quot;price&quot;:68.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;java&quot;, &quot;dev&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;spring开发基础&quot;,</span><br><span class="line">&quot;description&quot;: &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">&quot;price&quot;:88.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-24 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;spring&quot;, &quot;java&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET  /book/_search </span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;description&quot; : &quot;java程序员&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-score初探"><a href="#6-2-score初探" class="headerlink" title="6.2 _score初探"></a>6.2 _score初探</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 1,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 2,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 2.137549,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot; : 2.137549,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;spring开发基础&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 88.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-24 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;spring&quot;,</span><br><span class="line">            &quot;java&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.57961315,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;java编程思想&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 68.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;java&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果分析</p>
<p>1、建立索引时, description字段 term倒排索引</p>
<p>java 2,3</p>
<p>程序员 3</p>
<p>2、搜索时，直接找description中含有java的文档 2,3，并且3号文档含有两个java字段，一个程序员，所以得分高，排在前面。2号文档含有一个java，排在后面。</p>
<h2 id="7．-DSL-语法练习"><a href="#7．-DSL-语法练习" class="headerlink" title="7． DSL 语法练习"></a>7． DSL 语法练习</h2><h3 id="7-1-match-all"><a href="#7-1-match-all" class="headerlink" title="7.1 match_all"></a>7.1 match_all</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-match"><a href="#7-2-match" class="headerlink" title="7.2 match"></a>7.2 match</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;: &#123; </span><br><span class="line">		&quot;match&quot;: &#123; </span><br><span class="line">			&quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-multi-match"><a href="#7-3-multi-match" class="headerlink" title="7.3  multi_match"></a>7.3  multi_match</h3><p>多条件查询，在多个字段中查找java程序员</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;name&quot;, &quot;description&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-4、range-query-范围查询"><a href="#7-4、range-query-范围查询" class="headerlink" title="7.4、range query 范围查询"></a>7.4、range query 范围查询</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 80,</span><br><span class="line">		&quot;lte&quot;: 90</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-5、term-query"><a href="#7-5、term-query" class="headerlink" title="7.5、term query"></a>7.5、term query</h3><p>term查询的时候不分词，就查询java程序员</p>
<p>字段为keyword时，存储和搜索都不分词</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-6、terms-query"><a href="#7-6、terms-query" class="headerlink" title="7.6、terms query"></a>7.6、terms query</h3><p>查有其中的分词的文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123; &quot;terms&quot;: &#123; &quot;tag&quot;: [ &quot;search&quot;, &quot;full_text&quot;, &quot;nosql&quot; ] &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-7、exist-query-查询有某些字段值的文档"><a href="#7-7、exist-query-查询有某些字段值的文档" class="headerlink" title="7.7、exist query 查询有某些字段值的文档"></a>7.7、exist query 查询有某些字段值的文档</h3><p>注意不是值，而是字段名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;exists&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;join_date&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-8、Fuzzy-query"><a href="#7-8、Fuzzy-query" class="headerlink" title="7. 8、Fuzzy query"></a>7. 8、Fuzzy query</h3><p>返回包含与搜索词类似的词的文档，该词由Levenshtein编辑距离度量。</p>
<p>包括以下几种情况：</p>
<ul>
<li><p>更改角色（box→fox）</p>
</li>
<li><p>删除字符（aple→apple）</p>
</li>
<li><p>插入字符（sick→sic）</p>
</li>
<li><p>调换两个相邻字符（ACT→CAT） </p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;fuzzy&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;jave&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-9、IDs"><a href="#7-9、IDs" class="headerlink" title="7.9、IDs"></a>7.9、IDs</h3><p>查id在内的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;ids&quot; : &#123;</span><br><span class="line">            &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-10、prefix-前缀查询"><a href="#7-10、prefix-前缀查询" class="headerlink" title="7.10、prefix 前缀查询"></a>7.10、prefix 前缀查询</h3><p>最前面试以spring开头的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;prefix&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;spring&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-11、regexp-query-正则查询"><a href="#7-11、regexp-query-正则查询" class="headerlink" title="7.11、regexp query  正则查询"></a>7.11、regexp query  正则查询</h3><p>.*:最少一个</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;regexp&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;j.*a&quot;,</span><br><span class="line">                &quot;flags&quot; : &quot;ALL&quot;,</span><br><span class="line">                &quot;max_determinized_states&quot;: 10000,</span><br><span class="line">                &quot;rewrite&quot;: &quot;constant_score&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8．-Filter"><a href="#8．-Filter" class="headerlink" title="8． Filter"></a>8． Filter</h2><h3 id="8-1-filter与query示例"><a href="#8-1-filter与query示例" class="headerlink" title="8.1 filter与query示例"></a>8.1 filter与query示例</h3><p>需求：用户查询description中有”java程序员”，并且价格大于80小于90的数据。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;price&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 80,</span><br><span class="line">		      &quot;lte&quot;: 90</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用filter:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 80,</span><br><span class="line">		     &quot;lte&quot;: 90</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-filter与query对比"><a href="#8-2-filter与query对比" class="headerlink" title="8.2 filter与query对比"></a>8.2 filter与query对比</h3><p>filter，仅仅只是按照搜索条件过滤出需要的数据而已，不计算任何相关度分数，对相关度没有任何影响。</p>
<p>query，会去计算每个document相对于搜索条件的相关度，并按照相关度进行排序。</p>
<p>应用场景：</p>
<p>一般来说，如果你是在进行搜索，需要将最匹配搜索条件的数据先返回，那么用query        如果你只是要根据一些条件筛选出一部分数据，不关注其排序，那么用filter</p>
<h3 id="8-3-filter与query性能"><a href="#8-3-filter与query性能" class="headerlink" title="8.3 filter与query性能"></a>8.3 filter与query性能</h3><p>filter，不需要计算相关度分数，不需要按照相关度分数进行排序，同时还有内置的自动cache最常使用filter的数据</p>
<p>query，相反，要计算相关度分数，按照分数进行排序，而且无法cache结果</p>
<h2 id="9．-定位错误语法"><a href="#9．-定位错误语法" class="headerlink" title="9． 定位错误语法"></a>9． 定位错误语法</h2><p>验证错误语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;mach&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<p>query里没有mach这个属性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;valid&quot; : false,</span><br><span class="line">  &quot;error&quot; : &quot;org.elasticsearch.common.ParsingException: no [query] registered for [mach]&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;valid&quot; : true,</span><br><span class="line">  &quot;explanations&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot; : &quot;book&quot;,</span><br><span class="line">      &quot;valid&quot; : true,</span><br><span class="line">      &quot;explanation&quot; : &quot;description:java description:程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般用在那种特别复杂庞大的搜索下，比如你一下子写了上百行的搜索，这个时候可以先用validate api去验证一下，搜索是否合法。</p>
<p>合法以后，explain就像mysql的执行计划，可以看到搜索的目标等信息。</p>
<h2 id="10．-定制排序规则"><a href="#10．-定制排序规则" class="headerlink" title="10． 定制排序规则"></a>10． 定制排序规则</h2><h3 id="10-1-默认排序规则"><a href="#10-1-默认排序规则" class="headerlink" title="10.1 默认排序规则"></a>10.1 默认排序规则</h3><p>默认情况下，是按照_score降序排序的</p>
<p>然而，某些情况下，可能没有有用的_score，比如说filter</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，也可以是constant_score,只进行过滤，不进行排分</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">  	&quot;constant_score&quot;:&#123;</span><br><span class="line">        &quot;filter&quot;: &#123;</span><br><span class="line">          &quot;must&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;match&quot;: &#123;</span><br><span class="line">                &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-2-定制排序规则"><a href="#10-2-定制排序规则" class="headerlink" title="10.2 定制排序规则"></a>10.2 定制排序规则</h3><p>相当于sql中order by  ?sort=sprice:desc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot; : &#123;</span><br><span class="line">            &quot;term&quot; : &#123;</span><br><span class="line">                &quot;studymodel&quot; : &quot;201001&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11．-Text字段排序问题"><a href="#11．-Text字段排序问题" class="headerlink" title="11． Text字段排序问题"></a>11． Text字段排序问题</h2><p>如果对一个text field进行排序，结果往往不准确，因为分词后是多个单词，再排序就不是我们想要的结果了。</p>
<h3 id="第一种：fielddata-true"><a href="#第一种：fielddata-true" class="headerlink" title="第一种：fielddata:true"></a>第一种：fielddata:true</h3><pre><code>PUT /website 
&#123;
  &quot;mappings&quot;: &#123;
  &quot;properties&quot;: &#123;
    &quot;title&quot;: &#123;
      &quot;type&quot;: &quot;text&quot;,
      &quot;fielddata&quot;:true
    &#125;,
    &quot;content&quot;: &#123;
      &quot;type&quot;: &quot;text&quot;
    &#125;,
    &quot;post_date&quot;: &#123;
      &quot;type&quot;: &quot;date&quot;
    &#125;,
    &quot;author_id&quot;: &#123;
      &quot;type&quot;: &quot;long&quot;
    &#125;
  &#125;
 &#125;
&#125;
</code></pre>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /website/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;first article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my second article&quot;,</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">  &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;second article&quot;,</span><br><span class="line">    &quot;content&quot;: &quot;this is my second article&quot;,</span><br><span class="line">     &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">    &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">     &quot;title&quot;: &quot;third article&quot;,</span><br><span class="line">     &quot;content&quot;: &quot;this is my third article&quot;,</span><br><span class="line">     &quot;post_date&quot;: &quot;2019-01-02&quot;,</span><br><span class="line">     &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /website/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第二种：将一个text-field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序。"><a href="#第二种：将一个text-field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序。" class="headerlink" title="第二种：将一个text field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序。"></a>第二种：将一个text field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序。</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /website </span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;title&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;fields&quot;: &#123;</span><br><span class="line">        &quot;keyword&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;        </span><br><span class="line">      &#125;      </span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;post_date&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;date&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;author_id&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;long&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /website/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;first article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my second article&quot;,</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">  &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;second article&quot;,</span><br><span class="line">    &quot;content&quot;: &quot;this is my second article&quot;,</span><br><span class="line">     &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">    &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">     &quot;title&quot;: &quot;third article&quot;,</span><br><span class="line">     &quot;content&quot;: &quot;this is my third article&quot;,</span><br><span class="line">     &quot;post_date&quot;: &quot;2019-01-02&quot;,</span><br><span class="line">     &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /website/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;title.keyword&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="12．-Scroll分批查询"><a href="#12．-Scroll分批查询" class="headerlink" title="12． Scroll分批查询"></a>12． Scroll分批查询</h2><p>场景：下载某一个索引中1亿条数据，到文件或是数据库。</p>
<p>不能一下全查出来，系统内存溢出。所以使用scoll滚动搜索技术，一批一批查询。</p>
<p>scoll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于该旧的视图快照提供数据搜索，如果这个期间数据变更，是不会让用户看到的</p>
<p>每次发送scroll请求，我们还需要指定一个scoll参数，指定一个时间窗口，每次搜索请求只要在这个时间窗口内能完成就可以了。</p>
<p>搜索scroll=1m 1分钟，1分钟查3条</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAMOkWTURBNDUtcjZTVUdKMFp5cXloVElOQQ==&quot;,</span><br><span class="line">  &quot;took&quot; : 3,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 3,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">     </span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获得的结果会有一个scoll_id，下一次再发送scoll请求的时候，必须带上这个scoll_id</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scroll&quot;: &quot;1m&quot;, </span><br><span class="line">    &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAMOkWTURBNDUtcjZTVUdKMFp5cXloVElOQQ==&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在下一次</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scroll&quot;: &quot;1m&quot;, </span><br><span class="line">    &quot;scroll_id&quot; : &quot;SDSFDSGSDFSDFSDFDSFDSMFMSDLMFLSFKDSMFMSDLFMDSMFFSDKMFFS==&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与分页区别：</p>
<p>分页给用户看的  deep paging</p>
<p>scroll是用户系统内部操作，如下载批量数据，数据转移。零停机改变索引映射。</p>
<h1 id="13-java-api实现搜索"><a href="#13-java-api实现搜索" class="headerlink" title="13.java api实现搜索"></a>13.java api实现搜索</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * creste by itheima.itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSearch</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//搜索全部记录</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//        GET book/_search</span></span><br><span class="line"><span class="comment">//        &#123;</span></span><br><span class="line"><span class="comment">//            &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;match_all&quot;: &#123;&#125;</span></span><br><span class="line"><span class="comment">//             &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取某些字段</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>&#125;, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//搜索分页</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchPage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//    GET book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//          &quot;match_all&quot;: &#123;&#125;</span></span><br><span class="line"><span class="comment">//       &#125;,</span></span><br><span class="line"><span class="comment">//        &quot;from&quot;: 0,</span></span><br><span class="line"><span class="comment">//        &quot;size&quot;: 2</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第几页</span></span><br><span class="line">        <span class="keyword">int</span> page=<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//每页几个</span></span><br><span class="line">        <span class="keyword">int</span> size=<span class="number">2</span>;</span><br><span class="line">        <span class="comment">//下标计算</span></span><br><span class="line">        <span class="keyword">int</span> from=(page-<span class="number">1</span>)*size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.from(from);</span><br><span class="line">        searchSourceBuilder.size(size);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ids搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchIds</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//           &quot;ids&quot; : &#123;</span></span><br><span class="line"><span class="comment">//             &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span></span><br><span class="line"><span class="comment">//          &#125;</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.idsQuery().addIds(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;4&quot;</span>,<span class="string">&quot;100&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//match搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//           &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;description&quot;: &quot;java程序员&quot;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;java程序员&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//term 搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchTerm</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//           &quot;term&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;description&quot;: &quot;java程序员&quot;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.termQuery(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;java程序员&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//multi_match搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchMultiMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//          &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;query&quot;: &quot;java程序员&quot;,</span></span><br><span class="line"><span class="comment">//            &quot;fields&quot;: [&quot;name&quot;, &quot;description&quot;]</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.multiMatchQuery(<span class="string">&quot;java程序员&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;description&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//        &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;must&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span></span><br><span class="line"><span class="comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ],</span></span><br><span class="line"><span class="comment">//            &quot;should&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ]</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//bool搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchBool</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//          &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;must&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                  &quot;query&quot;: &quot;java程序员&quot;,</span></span><br><span class="line"><span class="comment">//                  &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ],</span></span><br><span class="line"><span class="comment">//            &quot;should&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ]</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建multiMatch请求</span></span><br><span class="line">        MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">&quot;java程序员&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="comment">//构建match请求</span></span><br><span class="line">        MatchQueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(<span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;201001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder=QueryBuilders.boolQuery();</span><br><span class="line">        boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">        boolQueryBuilder.should(matchQueryBuilder);</span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//          &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;must&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span></span><br><span class="line"><span class="comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ],</span></span><br><span class="line"><span class="comment">//            &quot;should&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ],</span></span><br><span class="line"><span class="comment">//            &quot;filter&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;range&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                    &quot;price&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                        &quot;gte&quot;: 50,</span></span><br><span class="line"><span class="comment">//                                &quot;lte&quot;: 90</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//filter搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchFilter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//          &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;must&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span></span><br><span class="line"><span class="comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ],</span></span><br><span class="line"><span class="comment">//            &quot;should&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//          ],</span></span><br><span class="line"><span class="comment">//            &quot;filter&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;range&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                    &quot;price&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                        &quot;gte&quot;: 50,</span></span><br><span class="line"><span class="comment">//                         &quot;lte&quot;: 90</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建multiMatch请求</span></span><br><span class="line">        MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">&quot;java程序员&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="comment">//构建match请求</span></span><br><span class="line">        MatchQueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(<span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;201001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder=QueryBuilders.boolQuery();</span><br><span class="line">        boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">        boolQueryBuilder.should(matchQueryBuilder);</span><br><span class="line"></span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">50</span>).lte(<span class="number">90</span>));</span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//sort搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchSort</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//    GET /book/_search</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="comment">//        &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;must&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span></span><br><span class="line"><span class="comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ],</span></span><br><span class="line"><span class="comment">//            &quot;should&quot;: [</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//                &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//      ],</span></span><br><span class="line"><span class="comment">//            &quot;filter&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                &quot;range&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                    &quot;price&quot;: &#123;</span></span><br><span class="line"><span class="comment">//                        &quot;gte&quot;: 50,</span></span><br><span class="line"><span class="comment">//                                &quot;lte&quot;: 90</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;,</span></span><br><span class="line"><span class="comment">//        &quot;sort&quot;: [</span></span><br><span class="line"><span class="comment">//        &#123;</span></span><br><span class="line"><span class="comment">//            &quot;price&quot;: &#123;</span></span><br><span class="line"><span class="comment">//            &quot;order&quot;: &quot;asc&quot;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//  ]</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//1构建搜索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;book&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建multiMatch请求</span></span><br><span class="line">        MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">&quot;java程序员&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="comment">//构建match请求</span></span><br><span class="line">        MatchQueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(<span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;201001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder=QueryBuilders.boolQuery();</span><br><span class="line">        boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">        boolQueryBuilder.should(matchQueryBuilder);</span><br><span class="line"></span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">50</span>).lte(<span class="number">90</span>));</span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//按照价格升序</span></span><br><span class="line">        searchSourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2执行搜索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3获取结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据数据</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + id);</span><br><span class="line">            System.out.println(<span class="string">&quot;name:&quot;</span> + name);</span><br><span class="line">            System.out.println(<span class="string">&quot;description:&quot;</span> + description);</span><br><span class="line">            System.out.println(<span class="string">&quot;price:&quot;</span> + price);</span><br><span class="line">            System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="14-聚合入门"><a href="#14-聚合入门" class="headerlink" title="14. 聚合入门"></a>14. 聚合入门</h1><h2 id="1聚合示例"><a href="#1聚合示例" class="headerlink" title="1聚合示例"></a>1聚合示例</h2><h3 id="1-1需求：计算每种studymodel下的人数"><a href="#1-1需求：计算每种studymodel下的人数" class="headerlink" title="1.1需求：计算每种studymodel下的人数"></a>1.1需求：计算每种studymodel下的人数</h3><p>sql语句： select studymodel，count(*)  group_by_model from book group by studymodel</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">#第一页，要0个原始数据</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">  #group_by_model自定义名称</span><br><span class="line">    &quot;group_by_model&quot;: &#123;</span><br><span class="line">    #因为是keyword字段所以是terms</span><br><span class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;studymodel&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-需求：计算每个tags下的商品数量"><a href="#1-2-需求：计算每个tags下的商品数量" class="headerlink" title="1.2 需求：计算每个tags下的商品数量"></a>1.2 需求：计算每个tags下的商品数量</h3><p>设置字段”fielddata”: true</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /book/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;tags&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;fielddata&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_tags&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;tags&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-需求：加上搜索条件，计算每个tags下的商品数量"><a href="#1-3-需求：加上搜索条件，计算每个tags下的商品数量" class="headerlink" title="1.3 需求：加上搜索条件，计算每个tags下的商品数量"></a>1.3 需求：加上搜索条件，计算每个tags下的商品数量</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_tags&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;tags&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格"><a href="#1-4-需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格" class="headerlink" title="1.4 需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格"></a>1.4 需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;group_by_tags&quot; : &#123;</span><br><span class="line">            &quot;terms&quot; : &#123; </span><br><span class="line">              &quot;field&quot; : &quot;tags&quot; </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot; : &#123;</span><br><span class="line">                &quot;avg_price&quot; : &#123;</span><br><span class="line">                    &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-5-需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序"><a href="#1-5-需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序" class="headerlink" title="1.5 需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序"></a>1.5 需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;group_by_tags&quot; : &#123;</span><br><span class="line">            &quot;terms&quot; : &#123; </span><br><span class="line">              &quot;field&quot; : &quot;tags&quot;,</span><br><span class="line">              &quot;order&quot;: &#123;</span><br><span class="line">                &quot;avg_price&quot;: &quot;desc&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot; : &#123;</span><br><span class="line">                &quot;avg_price&quot; : &#123;</span><br><span class="line">                    &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-6-需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格"><a href="#1-6-需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格" class="headerlink" title="1.6 需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格"></a>1.6 需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_price&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 0,</span><br><span class="line">            &quot;to&quot;: 40</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 40,</span><br><span class="line">            &quot;to&quot;: 60</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 60,</span><br><span class="line">            &quot;to&quot;: 80</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_tags&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;tags&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;average_price&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2两个核心概念：bucket和metric"><a href="#2两个核心概念：bucket和metric" class="headerlink" title="2两个核心概念：bucket和metric"></a>2两个核心概念：bucket和metric</h2><h3 id="2-1-bucket：一个数据分组"><a href="#2-1-bucket：一个数据分组" class="headerlink" title="2.1 bucket：一个数据分组"></a>2.1 bucket：一个数据分组</h3><p>​        city  name<br>​        北京 张三<br>​        北京 李四<br>​        天津 王五<br>​        天津 赵六</p>
<p>​        天津 王麻子</p>
<p>划分出来两个bucket，一个是北京bucket，一个是天津bucket<br>北京bucket：包含了2个人，张三，李四<br>上海bucket：包含了3个人，王五，赵六，王麻子</p>
<h3 id="2-2metric：对一个数据分组执行的统计"><a href="#2-2metric：对一个数据分组执行的统计" class="headerlink" title="2.2metric：对一个数据分组执行的统计"></a>2.2metric：对一个数据分组执行的统计</h3><p>metric，就是对一个bucket执行的某种聚合分析的操作，比如说求平均值，求最大值，求最小值</p>
<p>select count(*)<br>        from book<br>        group studymodel</p>
<p>bucket：group by studymodel –&gt; 那些studymodel相同的数据，就会被划分到一个bucket中<br>        metric：count(*)，对每个user_id bucket中所有的数据，计算一个数量。还有avg()，sum()，max()，min()</p>
<h2 id="3-电视案例"><a href="#3-电视案例" class="headerlink" title="3 电视案例"></a>3 电视案例</h2><p>创建索引及映射</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /tvs</span><br><span class="line">PUT /tvs/_search</span><br><span class="line">&#123;			</span><br><span class="line">			&quot;properties&quot;: &#123;</span><br><span class="line">				&quot;price&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;long&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;color&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;brand&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;sold_date&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;date&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /tvs/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 1000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-10-28&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 2000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-11-05&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 3000, &quot;color&quot; : &quot;绿色&quot;, &quot;brand&quot; : &quot;小米&quot;, &quot;sold_date&quot; : &quot;2019-05-18&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 1500, &quot;color&quot; : &quot;蓝色&quot;, &quot;brand&quot; : &quot;TCL&quot;, &quot;sold_date&quot; : &quot;2019-07-02&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 1200, &quot;color&quot; : &quot;绿色&quot;, &quot;brand&quot; : &quot;TCL&quot;, &quot;sold_date&quot; : &quot;2019-08-19&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 2000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-11-05&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 8000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;三星&quot;, &quot;sold_date&quot; : &quot;2020-01-01&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 2500, &quot;color&quot; : &quot;蓝色&quot;, &quot;brand&quot; : &quot;小米&quot;, &quot;sold_date&quot; : &quot;2020-02-12&quot; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求1-统计哪种颜色的电视销量最高"><a href="#需求1-统计哪种颜色的电视销量最高" class="headerlink" title="需求1 统计哪种颜色的电视销量最高"></a>需求1 统计哪种颜色的电视销量最高</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot; : 0,</span><br><span class="line">    &quot;aggs&quot; : &#123; </span><br><span class="line">        &quot;popular_colors&quot; : &#123; </span><br><span class="line">            &quot;terms&quot; : &#123; </span><br><span class="line">              &quot;field&quot; : &quot;color&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询条件解析</p>
<p>size：只获取聚合结果，而不要执行聚合的原始数据<br>        aggs：固定语法，要对一份数据执行分组聚合操作<br>        popular_colors：就是对每个aggs，都要起一个名字，<br>        terms：根据字段的值进行分组<br>        field：根据指定的字段的值进行分组</p>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 18,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 8,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;popular_colors&quot; : &#123;</span><br><span class="line">      &quot;doc_count_error_upper_bound&quot; : 0,</span><br><span class="line">      &quot;sum_other_doc_count&quot; : 0,</span><br><span class="line">      &quot;buckets&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;红色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 4</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;绿色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;蓝色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果解析</p>
<p>hits.hits：我们指定了size是0，所以hits.hits就是空的<br>        aggregations：聚合结果<br>        popular_color：我们指定的某个聚合的名称<br>        buckets：根据我们指定的field划分出的buckets<br>        key：每个bucket对应的那个值<br>        doc_count：这个bucket分组内，有多少个数据<br>数量，其实就是这种颜色的销量</p>
<p>每种颜色对应的bucket中的数据的默认的排序规则：按照doc_count降序排序</p>
<h3 id="需求2-统计每种颜色电视平均价格"><a href="#需求2-统计每种颜色电视平均价格" class="headerlink" title="需求2 统计每种颜色电视平均价格"></a>需求2 统计每种颜色电视平均价格</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;colors&quot;: &#123;</span><br><span class="line">         &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;color&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;aggs&quot;: &#123; </span><br><span class="line">            &quot;avg_price&quot;: &#123; </span><br><span class="line">               &quot;avg&quot;: &#123;</span><br><span class="line">                  &quot;field&quot;: &quot;price&quot; </span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在一个aggs执行的bucket操作（terms），平级的json结构下，再加一个aggs，这个第二个aggs内部，同样取个名字，执行一个metric操作，avg，对之前的每个bucket中的数据的指定的field，price field，求一个平均值</p>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 4,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 8,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;colors&quot; : &#123;</span><br><span class="line">      &quot;doc_count_error_upper_bound&quot; : 0,</span><br><span class="line">      &quot;sum_other_doc_count&quot; : 0,</span><br><span class="line">      &quot;buckets&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;红色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 4,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 3250.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;绿色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 2100.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;蓝色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 2000.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>buckets，除了key和doc_count<br>avg_price：我们自己取的metric aggs的名字<br>value：我们的metric计算的结果，每个bucket中的数据的price字段求平均值后的结果</p>
<p>相当于sql: select avg(price) from tvs group by color</p>
<h3 id="需求3-继续下钻分析"><a href="#需求3-继续下钻分析" class="headerlink" title="需求3 继续下钻分析"></a>需求3 继续下钻分析</h3><p>每个颜色下，平均价格及每个颜色下，每个品牌的平均价格</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;color_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;group_by_brand&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brand&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;brand_avg_price&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="需求4：更多的metric"><a href="#需求4：更多的metric" class="headerlink" title="需求4：更多的metric"></a>需求4：更多的metric</h3><p>count：bucket，terms，自动就会有一个doc_count，就相当于是count<br>avg：avg aggs，求平均值<br>max：求一个bucket内，指定field值最大的那个数据<br>min：求一个bucket内，指定field值最小的那个数据<br>sum：求一个bucket内，指定field值的总和</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;colors&quot;: &#123;</span><br><span class="line">         &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;color&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;,</span><br><span class="line">            &quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;, </span><br><span class="line">            &quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span><br><span class="line">            &quot;sum_price&quot; : &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; </span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求5：划分范围-histogram"><a href="#需求5：划分范围-histogram" class="headerlink" title="需求5：划分范围 histogram"></a>需求5：划分范围 histogram</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;:&#123;</span><br><span class="line">      &quot;price&quot;:&#123;</span><br><span class="line">         &quot;histogram&quot;:&#123; </span><br><span class="line">            &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">            &quot;interval&quot;: 2000</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;aggs&quot;:&#123;</span><br><span class="line">            &quot;income&quot;: &#123;</span><br><span class="line">               &quot;sum&quot;: &#123; </span><br><span class="line">                 &quot;field&quot; : &quot;price&quot;</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>histogram：类似于terms，也是进行bucket分组操作，接收一个field，按照这个field的值的各个范围区间，进行bucket分组操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;histogram&quot;:&#123; </span><br><span class="line">  &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">  &quot;interval&quot;: 2000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>interval：2000，划分范围，0<del>2000，2000</del>4000，4000<del>6000，6000</del>8000，8000~10000，buckets</p>
<p>bucket有了之后，一样的，去对每个bucket执行avg，count，sum，max，min，等各种metric操作，聚合分析</p>
<h3 id="需求6：按照日期分组聚合"><a href="#需求6：按照日期分组聚合" class="headerlink" title="需求6：按照日期分组聚合"></a>需求6：按照日期分组聚合</h3><p>date_histogram，按照我们指定的某个date类型的日期field，以及日期interval，按照一定的日期间隔，去划分bucket</p>
<p>min_doc_count：即使某个日期interval，2017-01-01~2017-01-31中，一条数据都没有，那么这个区间也是要返回的，不然默认是会过滤掉这个区间的<br>        extended_bounds，min，max：划分bucket的时候，会限定在这个起始日期，和截止日期内</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;sales&quot;: &#123;</span><br><span class="line">         &quot;date_histogram&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;sold_date&quot;,</span><br><span class="line">            &quot;interval&quot;: &quot;month&quot;, </span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span><br><span class="line">            &quot;min_doc_count&quot; : 0, </span><br><span class="line">            &quot;extended_bounds&quot; : &#123; </span><br><span class="line">                &quot;min&quot; : &quot;2019-01-01&quot;,</span><br><span class="line">                &quot;max&quot; : &quot;2020-12-31&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求7-统计每季度每个品牌的销售额"><a href="#需求7-统计每季度每个品牌的销售额" class="headerlink" title="需求7 统计每季度每个品牌的销售额"></a>需求7 统计每季度每个品牌的销售额</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_sold_date&quot;: &#123;</span><br><span class="line">      &quot;date_histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;sold_date&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;quarter&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span><br><span class="line">        &quot;min_doc_count&quot;: 0,</span><br><span class="line">        &quot;extended_bounds&quot;: &#123;</span><br><span class="line">          &quot;min&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">          &quot;max&quot;: &quot;2020-12-31&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_brand&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brand&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;sum_price&quot;: &#123;</span><br><span class="line">              &quot;sum&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;total_sum_price&quot;: &#123;</span><br><span class="line">          &quot;sum&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求8-：搜索与聚合结合，查询某个品牌按颜色销量"><a href="#需求8-：搜索与聚合结合，查询某个品牌按颜色销量" class="headerlink" title="需求8 ：搜索与聚合结合，查询某个品牌按颜色销量"></a>需求8 ：搜索与聚合结合，查询某个品牌按颜色销量</h3><p>搜索与聚合可以结合起来。</p>
<p>sql select count(*)</p>
<p>from tvs</p>
<p>where brand like “%小米%”</p>
<p>group by color</p>
<p>es aggregation，scope，任何的聚合，都必须在搜索出来的结果数据中之行，搜索结果，就是聚合分析操作的scope</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;brand&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;小米&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求9-global-bucket：单个品牌与所有品牌销量对比"><a href="#需求9-global-bucket：单个品牌与所有品牌销量对比" class="headerlink" title="需求9 global bucket：单个品牌与所有品牌销量对比"></a>需求9 global bucket：单个品牌与所有品牌销量对比</h3><p>aggregation，scope，一个聚合操作，必须在query的搜索结果范围内执行</p>
<p>出来两个结果，一个结果，是基于query搜索结果来聚合的; 一个结果，是对所有数据执行聚合的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;brand&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;小米&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;single_brand_avg_price&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;all&quot;: &#123;</span><br><span class="line">      &quot;global&quot;: &#123;&#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;all_brand_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求10：过滤-聚合：统计价格大于1200的电视平均价格"><a href="#需求10：过滤-聚合：统计价格大于1200的电视平均价格" class="headerlink" title="需求10：过滤+聚合：统计价格大于1200的电视平均价格"></a>需求10：过滤+聚合：统计价格大于1200的电视平均价格</h3><p>搜索+聚合</p>
<p>过滤+聚合</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 1200</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;avg_price&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求11-bucket-filter：统计品牌最近一个月的平均价格"><a href="#需求11-bucket-filter：统计品牌最近一个月的平均价格" class="headerlink" title="需求11 bucket filter：统计品牌最近一个月的平均价格"></a>需求11 bucket filter：统计品牌最近一个月的平均价格</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;brand&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;小米&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;recent_150d&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;sold_date&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: &quot;now-150d&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;recent_150d_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;recent_140d&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;sold_date&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: &quot;now-140d&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;recent_140d_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;recent_130d&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;sold_date&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: &quot;now-130d&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;recent_130d_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>aggs.filter，针对的是聚合去做的</p>
<p>如果放query里面的filter，是全局的，会对所有的数据都有影响</p>
<p>但是，如果，比如说，你要统计，长虹电视，最近1个月的平均值; 最近3个月的平均值; 最近6个月的平均值</p>
<p>bucket filter：对不同的bucket下的aggs，进行filter</p>
<h3 id="需求12-排序：按每种颜色的平均销售额降序排序"><a href="#需求12-排序：按每种颜色的平均销售额降序排序" class="headerlink" title="需求12 排序：按每种颜色的平均销售额降序排序"></a>需求12 排序：按每种颜色的平均销售额降序排序</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;avg_price&quot;: &quot;asc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相当于sql子表数据字段可以立刻使用。</p>
<h3 id="需求13-排序：按每种颜色的每种品牌平均销售额降序排序"><a href="#需求13-排序：按每种颜色的每种品牌平均销售额降序排序" class="headerlink" title="需求13 排序：按每种颜色的每种品牌平均销售额降序排序"></a>需求13 排序：按每种颜色的每种品牌平均销售额降序排序</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /tvs/_search  </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_brand&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brand&quot;,</span><br><span class="line">            &quot;order&quot;: &#123;</span><br><span class="line">              &quot;avg_price&quot;: &quot;desc&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;avg_price&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="15-java-api实现聚合"><a href="#15-java-api实现聚合" class="headerlink" title="15.java api实现聚合"></a>15.java api实现聚合</h1><p>简单聚合，多种聚合，详见代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregation;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.histogram.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * creste by itheima.itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestAggs</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需求一：按照颜色分组，计算每个颜色卖出的个数</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAggs</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot;: 0,</span></span><br><span class="line">        <span class="comment">//     &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//       &quot;group_by_color&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;terms&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;color&quot;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> SearchRequest(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        TermsAggregationBuilder termsAggregationBuilder = AggregationBuilders.terms(<span class="string">&quot;group_by_color&quot;</span>).field(<span class="string">&quot;color&quot;</span>);</span><br><span class="line">        searchSourceBuilder.aggregation(termsAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">      <span class="comment">//   &quot;aggregations&quot; : &#123;</span></span><br><span class="line">      <span class="comment">//       &quot;group_by_color&quot; : &#123;</span></span><br><span class="line">      <span class="comment">//           &quot;doc_count_error_upper_bound&quot; : 0,</span></span><br><span class="line">      <span class="comment">//           &quot;sum_other_doc_count&quot; : 0,</span></span><br><span class="line">      <span class="comment">//            &quot;buckets&quot; : [</span></span><br><span class="line">      <span class="comment">//           &#123;</span></span><br><span class="line">      <span class="comment">//               &quot;key&quot; : &quot;红色&quot;,</span></span><br><span class="line">      <span class="comment">//               &quot;doc_count&quot; : 4</span></span><br><span class="line">      <span class="comment">//           &#125;,</span></span><br><span class="line">      <span class="comment">//           &#123;</span></span><br><span class="line">      <span class="comment">//               &quot;key&quot; : &quot;绿色&quot;,</span></span><br><span class="line">      <span class="comment">//                   &quot;doc_count&quot; : 2</span></span><br><span class="line">      <span class="comment">//           &#125;,</span></span><br><span class="line">      <span class="comment">//           &#123;</span></span><br><span class="line">      <span class="comment">//               &quot;key&quot; : &quot;蓝色&quot;,</span></span><br><span class="line">      <span class="comment">//                   &quot;doc_count&quot; : 2</span></span><br><span class="line">      <span class="comment">//           &#125;</span></span><br><span class="line">      <span class="comment">// ]</span></span><br><span class="line">      <span class="comment">//       &#125;</span></span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        Terms group_by_color = aggregations.get(<span class="string">&quot;group_by_color&quot;</span>);</span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            String key = bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span>+key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> docCount = bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求二：按照颜色分组，计算每个颜色卖出的个数，每个颜色卖出的平均价格</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAggsAndAvg</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot;: 0,</span></span><br><span class="line">        <span class="comment">//      &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;group_by_color&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;terms&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;color&quot;</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;avg_price&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                 &quot;avg&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                     &quot;field&quot;: &quot;price&quot;</span></span><br><span class="line">        <span class="comment">//                 &#125;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> SearchRequest(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        TermsAggregationBuilder termsAggregationBuilder = AggregationBuilders.terms(<span class="string">&quot;group_by_color&quot;</span>).field(<span class="string">&quot;color&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//terms聚合下填充一个子聚合</span></span><br><span class="line">        AvgAggregationBuilder avgAggregationBuilder = AggregationBuilders.avg(<span class="string">&quot;avg_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        termsAggregationBuilder.subAggregation(avgAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.aggregation(termsAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key&quot; : &quot;红色&quot;,</span></span><br><span class="line">        <span class="comment">//      &quot;doc_count&quot; : 4,</span></span><br><span class="line">        <span class="comment">//      &quot;avg_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//        &quot;value&quot; : 3250.0</span></span><br><span class="line">        <span class="comment">//       &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        Terms group_by_color = aggregations.get(<span class="string">&quot;group_by_color&quot;</span>);</span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            String key = bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span>+key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> docCount = bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            Aggregations aggregations1 = bucket.getAggregations();</span><br><span class="line">            Avg avg_price = aggregations1.get(<span class="string">&quot;avg_price&quot;</span>);</span><br><span class="line">            <span class="keyword">double</span> value = avg_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+value);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求三：按照颜色分组，计算每个颜色卖出的个数，以及每个颜色卖出的平均值、最大值、最小值、总和。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAggsAndMore</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot; : 0,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//      &quot;group_by_color&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;terms&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;color&quot;</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;,</span></span><br><span class="line">        <span class="comment">//             &quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span></span><br><span class="line">        <span class="comment">//             &quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span></span><br><span class="line">        <span class="comment">//             &quot;sum_price&quot; : &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> SearchRequest(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        TermsAggregationBuilder termsAggregationBuilder = AggregationBuilders.terms(<span class="string">&quot;group_by_color&quot;</span>).field(<span class="string">&quot;color&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//termsAggregationBuilder里放入多个子聚合</span></span><br><span class="line">        AvgAggregationBuilder avgAggregationBuilder = AggregationBuilders.avg(<span class="string">&quot;avg_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        MinAggregationBuilder minAggregationBuilder = AggregationBuilders.min(<span class="string">&quot;min_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        MaxAggregationBuilder maxAggregationBuilder = AggregationBuilders.max(<span class="string">&quot;max_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(<span class="string">&quot;sum_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line"></span><br><span class="line">        termsAggregationBuilder.subAggregation(avgAggregationBuilder);</span><br><span class="line">        termsAggregationBuilder.subAggregation(minAggregationBuilder);</span><br><span class="line">        termsAggregationBuilder.subAggregation(maxAggregationBuilder);</span><br><span class="line">        termsAggregationBuilder.subAggregation(sumAggregationBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.aggregation(termsAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key&quot; : &quot;红色&quot;,</span></span><br><span class="line">        <span class="comment">//     &quot;doc_count&quot; : 4,</span></span><br><span class="line">        <span class="comment">//     &quot;max_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//          &quot;value&quot; : 8000.0</span></span><br><span class="line">        <span class="comment">//     &#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;min_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//          &quot;value&quot; : 1000.0</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;avg_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;value&quot; : 3250.0</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;sum_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;value&quot; : 13000.0</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        Terms group_by_color = aggregations.get(<span class="string">&quot;group_by_color&quot;</span>);</span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            String key = bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span>+key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> docCount = bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            Aggregations aggregations1 = bucket.getAggregations();</span><br><span class="line"></span><br><span class="line">            Max max_price = aggregations1.get(<span class="string">&quot;max_price&quot;</span>);</span><br><span class="line">            <span class="keyword">double</span> maxPriceValue = max_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;maxPriceValue:&quot;</span>+maxPriceValue);</span><br><span class="line"></span><br><span class="line">            Min min_price = aggregations1.get(<span class="string">&quot;min_price&quot;</span>);</span><br><span class="line">            <span class="keyword">double</span> minPriceValue = min_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;minPriceValue:&quot;</span>+minPriceValue);</span><br><span class="line"></span><br><span class="line">            Avg avg_price = aggregations1.get(<span class="string">&quot;avg_price&quot;</span>);</span><br><span class="line">            <span class="keyword">double</span> avgPriceValue = avg_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;avgPriceValue:&quot;</span>+avgPriceValue);</span><br><span class="line"></span><br><span class="line">            Sum sum_price = aggregations1.get(<span class="string">&quot;sum_price&quot;</span>);</span><br><span class="line">            <span class="keyword">double</span> sumPriceValue = sum_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;sumPriceValue:&quot;</span>+sumPriceValue);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求四：按照售价每2000价格划分范围，算出每个区间的销售总额 histogram</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAggsAndHistogram</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot; : 0,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//      &quot;by_histogram&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//         &quot;histogram&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;price&quot;,</span></span><br><span class="line">        <span class="comment">//             &quot;interval&quot;: 2000</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//             &quot;income&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                 &quot;sum&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                     &quot;field&quot; : &quot;price&quot;</span></span><br><span class="line">        <span class="comment">//                 &#125;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> SearchRequest(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        HistogramAggregationBuilder histogramAggregationBuilder = AggregationBuilders.histogram(<span class="string">&quot;by_histogram&quot;</span>).field(<span class="string">&quot;price&quot;</span>).interval(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(<span class="string">&quot;income&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        histogramAggregationBuilder.subAggregation(sumAggregationBuilder);</span><br><span class="line">        searchSourceBuilder.aggregation(histogramAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key&quot; : 0.0,</span></span><br><span class="line">        <span class="comment">//     &quot;doc_count&quot; : 3,</span></span><br><span class="line">        <span class="comment">//      income&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//          &quot;value&quot; : 3700.0</span></span><br><span class="line">        <span class="comment">//       &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        Histogram group_by_color = aggregations.get(<span class="string">&quot;by_histogram&quot;</span>);</span><br><span class="line">        List&lt;? extends Histogram.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;</span><br><span class="line">            String keyAsString = bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;keyAsString:&quot;</span>+keyAsString);</span><br><span class="line">            <span class="keyword">long</span> docCount = bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            Aggregations aggregations1 = bucket.getAggregations();</span><br><span class="line">            Sum income = aggregations1.get(<span class="string">&quot;income&quot;</span>);</span><br><span class="line">            <span class="keyword">double</span> value = income.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+value);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求五：计算每个季度的销售总额</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAggsAndDateHistogram</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot; : 0,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;sales&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;date_histogram&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                      &quot;field&quot;: &quot;sold_date&quot;,</span></span><br><span class="line">        <span class="comment">//                     &quot;interval&quot;: &quot;quarter&quot;,</span></span><br><span class="line">        <span class="comment">//                     &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span></span><br><span class="line">        <span class="comment">//                     &quot;min_doc_count&quot; : 0,</span></span><br><span class="line">        <span class="comment">//                     &quot;extended_bounds&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//                         &quot;min&quot; : &quot;2019-01-01&quot;,</span></span><br><span class="line">        <span class="comment">//                         &quot;max&quot; : &quot;2020-12-31&quot;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;income&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                 &quot;sum&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                     &quot;field&quot;: &quot;price&quot;</span></span><br><span class="line">        <span class="comment">//                 &#125;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> SearchRequest(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        DateHistogramAggregationBuilder dateHistogramAggregationBuilder = AggregationBuilders.dateHistogram(<span class="string">&quot;date_histogram&quot;</span>).field(<span class="string">&quot;sold_date&quot;</span>).calendarInterval(DateHistogramInterval.QUARTER)</span><br><span class="line">                .format(<span class="string">&quot;yyyy-MM-dd&quot;</span>).minDocCount(<span class="number">0</span>).extendedBounds(<span class="keyword">new</span> ExtendedBounds(<span class="string">&quot;2019-01-01&quot;</span>, <span class="string">&quot;2020-12-31&quot;</span>));</span><br><span class="line">        SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(<span class="string">&quot;income&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        dateHistogramAggregationBuilder.subAggregation(sumAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.aggregation(dateHistogramAggregationBuilder);</span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key_as_string&quot; : &quot;2019-01-01&quot;,</span></span><br><span class="line">        <span class="comment">//      &quot;key&quot; : 1546300800000,</span></span><br><span class="line">        <span class="comment">//      &quot;doc_count&quot; : 0,</span></span><br><span class="line">        <span class="comment">//      &quot;income&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;value&quot; : 0.0</span></span><br><span class="line">        <span class="comment">//      &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        ParsedDateHistogram date_histogram = aggregations.get(<span class="string">&quot;date_histogram&quot;</span>);</span><br><span class="line">        List&lt;? extends Histogram.Bucket&gt; buckets = date_histogram.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;</span><br><span class="line">            String keyAsString = bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;keyAsString:&quot;</span>+keyAsString);</span><br><span class="line">            <span class="keyword">long</span> docCount = bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            Aggregations aggregations1 = bucket.getAggregations();</span><br><span class="line">            Sum income = aggregations1.get(<span class="string">&quot;income&quot;</span>);</span><br><span class="line">            <span class="keyword">double</span> value = income.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+value);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="16-es7-sql新特性"><a href="#16-es7-sql新特性" class="headerlink" title="16.es7 sql新特性"></a>16.es7 sql新特性</h1><h2 id="1-快速入门"><a href="#1-快速入门" class="headerlink" title="1 快速入门"></a>1 快速入门</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM tvs &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2启动方式"><a href="#2启动方式" class="headerlink" title="2启动方式"></a>2启动方式</h2><p>1http 请求</p>
<p>2客户端：elasticsearch-sql-cli.bat</p>
<p><img src="/../img/image-20220225150121246.png" alt="image-20220225150121246"></p>
<p><img src="/../img/image-20220225150138874.png" alt="image-20220225150138874"></p>
<p>3代码</p>
<h2 id="3显示方式"><a href="#3显示方式" class="headerlink" title="3显示方式"></a>3显示方式</h2><p><img src="/../img/image-20220225150301446.png" alt="image-20220225150301446"></p>
<p><img src="/../img/1573212830146.png" alt="1573212830146"></p>
<h2 id="4-sql-翻译"><a href="#4-sql-翻译" class="headerlink" title="4 sql 翻译"></a>4 sql 翻译</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_sql/translate</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM tvs &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;size&quot; : 1000,</span><br><span class="line">  &quot;_source&quot; : false,</span><br><span class="line">  &quot;stored_fields&quot; : &quot;_none_&quot;,</span><br><span class="line">  &quot;docvalue_fields&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;brand&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;color&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;price&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;sold_date&quot;,</span><br><span class="line">      &quot;format&quot; : &quot;epoch_millis&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sort&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_doc&quot; : &#123;</span><br><span class="line">        &quot;order&quot; : &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-与其他DSL结合"><a href="#5-与其他DSL结合" class="headerlink" title="5 与其他DSL结合"></a>5 与其他DSL结合</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM tvs&quot;,</span><br><span class="line">    &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">            &quot;price&quot;: &#123;</span><br><span class="line">                &quot;gte&quot; : 1200,</span><br><span class="line">                &quot;lte&quot; : 2000</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM tvs where price&gt;1200 and price &lt;2000&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-java-代码实现sql功能"><a href="#6-java-代码实现sql功能" class="headerlink" title="6 java 代码实现sql功能"></a>6 java 代码实现sql功能</h2><p>1前提 es拥有白金版功能</p>
<p> kibana中管理-》许可管理 开启白金版试用</p>
<p><img src="/../img/image-20220225150719115.png" alt="image-20220225150719115"></p>
<p>2导入依赖</p>
<pre><code>    &lt;dependency&gt;
        &lt;groupId&gt;org.elasticsearch.plugin&lt;/groupId&gt;
        &lt;artifactId&gt;x-pack-sql-jdbc&lt;/artifactId&gt;
        &lt;version&gt;7.3.0&lt;/version&gt;
    &lt;/dependency&gt;
    
    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;elastic.co&lt;/id&gt;
            &lt;url&gt;https://artifacts.elastic.co/maven&lt;/url&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;
</code></pre>
<p>3代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        try  &#123;</span><br><span class="line">            Connection connection = DriverManager.getConnection(&quot;jdbc:es://http://localhost:9200&quot;);</span><br><span class="line">            Statement statement = connection.createStatement();</span><br><span class="line">            ResultSet results = statement.executeQuery(</span><br><span class="line">                    &quot;select * from tvs&quot;);</span><br><span class="line">            while(results.next())&#123;</span><br><span class="line">                System.out.println(results.getString(1));</span><br><span class="line">                System.out.println(results.getString(2));</span><br><span class="line">                System.out.println(results.getString(3));</span><br><span class="line">                System.out.println(results.getString(4));</span><br><span class="line">                System.out.println(&quot;============================&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>大型企业可以购买白金版，增加Machine Learning、高级安全性x-pack。</p>
<p><img src="/../img/image-20220225150845100.png" alt="image-20220225150845100"></p>
<h1 id="17-Logstash学习"><a href="#17-Logstash学习" class="headerlink" title="17.Logstash学习"></a>17.Logstash学习</h1><h2 id="17-1Logstash基本语法组成"><a href="#17-1Logstash基本语法组成" class="headerlink" title="17.1Logstash基本语法组成"></a>17.1Logstash基本语法组成</h2><p>从数据源的数据通过转换推送到els中</p>
<p><img src="/../img/image-20220309144034060.png" alt="image-20220309144034060"></p>
<h3 id="1什么是Logstash"><a href="#1什么是Logstash" class="headerlink" title="1什么是Logstash"></a>1什么是Logstash</h3><p>logstash是一个数据抽取工具，将数据从一个地方转移到另一个地方。如hadoop生态圈的sqoop等。下载地址：<a href="https://www.elastic.co/cn/downloads/logstash">https://www.elastic.co/cn/downloads/logstash</a></p>
<p>logstash之所以功能强大和流行，还与其丰富的过滤器插件是分不开的，过滤器提供的并不单单是过滤的功能，还可以对进入过滤器的原始数据进行复杂的逻辑处理，甚至添加独特的事件到后续流程中。<br>    Logstash配置文件有如下三部分组成，其中input、output部分是必须配置，filter部分是可选配置，而filter就是过滤器插件，可以在这部分实现各种日志过滤功能。</p>
<h3 id="2配置文件："><a href="#2配置文件：" class="headerlink" title="2配置文件："></a>2配置文件：</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    #输入插件</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    #过滤匹配插件</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    #输出插件</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3启动操作："><a href="#3启动操作：" class="headerlink" title="3启动操作："></a>3启动操作：</h3><p>stdin{}：控制台</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">logstash.bat -e &#x27;input&#123;stdin&#123;&#125;&#125; output&#123;stdout&#123;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>为了好维护，将配置写入文件，以配置文件启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">logstash.bat -f ../config/test1.conf</span><br></pre></td></tr></table></figure>

<h2 id="17-2-Logstash输入插件（input）"><a href="#17-2-Logstash输入插件（input）" class="headerlink" title="17.2 Logstash输入插件（input）"></a>17.2 Logstash输入插件（input）</h2><p><a href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html">https://www.elastic.co/guide/en/logstash/current/input-plugins.html</a></p>
<h3 id="1、标准输入-Stdin-到控制台"><a href="#1、标准输入-Stdin-到控制台" class="headerlink" title="1、标准输入(Stdin)到控制台"></a>1、标准输入(Stdin)到控制台</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">    stdin&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec=&gt;rubydebug    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、读取文件-File"><a href="#2、读取文件-File" class="headerlink" title="2、读取文件(File)"></a>2、读取文件(File)</h3><p>logstash使用一个名为filewatch的ruby gem库来监听文件变化,并通过一个叫.sincedb的数据库文件来记录被监听的日志文件的读取进度（时间戳），这个sincedb数据文件的默认路径在 &lt;path.data&gt;/plugins/inputs/file下面，文件名类似于.sincedb_123456，而&lt;path.data&gt;表示logstash插件存储目录，默认是LOGSTASH_HOME/data。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [&quot;D:/nginx.log&quot;]</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec=&gt;rubydebug    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下，logstash会从文件的结束位置开始读取数据，也就是说logstash进程会以类似tail -f命令的形式逐行获取数据。</p>
<p>我们手动往nginx.log新增一条，程序就会自动读取一条</p>
<p>当有10台机器都部署了logstash，然后都往一个els里推送，那么就可以集中管理</p>
<h3 id="3、读取TCP网络数据"><a href="#3、读取TCP网络数据" class="headerlink" title="3、读取TCP网络数据"></a>3、读取TCP网络数据</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; &quot;1234&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGLINE&#125;&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec=&gt;rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="17-3-Logstash过滤器插件-Filter"><a href="#17-3-Logstash过滤器插件-Filter" class="headerlink" title="17.3 Logstash过滤器插件(Filter)"></a>17.3 Logstash过滤器插件(Filter)</h2><p><a href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html">https://www.elastic.co/guide/en/logstash/current/filter-plugins.html</a></p>
<h3 id="17-13-1Grok-正则捕获"><a href="#17-13-1Grok-正则捕获" class="headerlink" title="17.13.1Grok 正则捕获"></a>17.13.1Grok 正则捕获</h3><p>grok是一个十分强大的logstash filter插件，他可以通过正则解析任意文本，将非结构化日志数据弄成结构化和方便查询的结构。他是目前logstash 中解析非结构化日志数据最好的方式。</p>
<p>Grok 的语法规则是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#123;语法: 语义&#125;</span><br></pre></td></tr></table></figure>

<p>例如输入的内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">172.16.213.132 [07/Feb/2019:16:24:19 +0800] &quot;GET / HTTP/1.1&quot; 403 5039</span><br></pre></td></tr></table></figure>

<p>%{IP:clientip}匹配模式将获得的结果为：clientip: 172.16.213.132<br>%{HTTPDATE:timestamp}匹配模式将获得的结果为：timestamp: 07/Feb/2018:16:24:19 +0800<br>而%{QS:referrer}匹配模式将获得的结果为：referrer: “GET / HTTP/1.1”</p>
<p>下面是一个组合匹配模式，它可以获取上面输入的所有内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面这个组合匹配模式，我们将输入的内容分成了五个部分，即五个字段，将输入内容分割为不同的数据字段，这对于日后解析和查询日志数据非常有用，这正是使用grok的目的。</p>
<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">    stdin&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">    grok&#123;</span><br><span class="line">        match =&gt; [&quot;message&quot;,&quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output&#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入内容：</p>
<p>按照顺序，解析message字段，把第一个字段，以IP解析为clientip属性</p>
<p>把第二个字段，以httpdate解析为timestamp字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">172.16.213.132 [07/Feb/2019:16:24:19 +0800] &quot;GET / HTTP/1.1&quot; 403 5039</span><br></pre></td></tr></table></figure>

<h3 id="17-13-2时间处理-Date"><a href="#17-13-2时间处理-Date" class="headerlink" title="17.13.2时间处理(Date)"></a>17.13.2时间处理(Date)</h3><p>date插件是对于排序事件和回填旧数据尤其重要，它可以用来转换日志记录中的时间字段，变成LogStash::Timestamp对象，然后转存到@timestamp字段里，这在之前已经做过简单的介绍。<br>下面是date插件的一个配置示例（这里仅仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; [&quot;message&quot;, &quot;%&#123;HTTPDATE:timestamp&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="17-13-3、数据修改-Mutate"><a href="#17-13-3、数据修改-Mutate" class="headerlink" title="17.13.3、数据修改(Mutate)"></a>17.13.3、数据修改(Mutate)</h3><h4 id="（1）正则表达式替换匹配字段"><a href="#（1）正则表达式替换匹配字段" class="headerlink" title="（1）正则表达式替换匹配字段"></a>（1）正则表达式替换匹配字段</h4><p>gsub可以通过正则表达式替换字段中匹配到的值，只对字符串字段有效，下面是一个关于mutate插件中gsub的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        gsub =&gt; [&quot;filed_name_1&quot;, &quot;/&quot; , &quot;_&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个示例表示将filed_name_1字段中所有”/“字符替换为”_”。</p>
<h4 id="（2）分隔符分割字符串为数组"><a href="#（2）分隔符分割字符串为数组" class="headerlink" title="（2）分隔符分割字符串为数组"></a>（2）分隔符分割字符串为数组</h4><p>split可以通过指定的分隔符分割字段中的字符串为数组，下面是一个关于mutate插件中split的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        split =&gt; [&quot;filed_name_2&quot;, &quot;|&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个示例表示将filed_name_2字段以”|”为区间分隔为数组。</p>
<h4 id="（3）重命名字段"><a href="#（3）重命名字段" class="headerlink" title="（3）重命名字段"></a>（3）重命名字段</h4><p>rename可以实现重命名某个字段的功能，下面是一个关于mutate插件中rename的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; &#123; &quot;old_field&quot; =&gt; &quot;new_field&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个示例表示将字段old_field重命名为new_field。</p>
<h4 id="（4）删除字段"><a href="#（4）删除字段" class="headerlink" title="（4）删除字段"></a>（4）删除字段</h4><p>remove_field可以实现删除某个字段的功能，下面是一个关于mutate插件中remove_field的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field  =&gt;  [&quot;timestamp&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个示例表示将字段timestamp删除。</p>
<h4 id="（5）GeoIP-地址查询归类"><a href="#（5）GeoIP-地址查询归类" class="headerlink" title="（5）GeoIP 地址查询归类"></a>（5）GeoIP 地址查询归类</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">        source =&gt; &quot;ip_field&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="综合例子："><a href="#综合例子：" class="headerlink" title="综合例子："></a>综合例子：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot; &#125;</span><br><span class="line">        remove_field =&gt; [ &quot;message&quot; ]</span><br><span class="line">   &#125;</span><br><span class="line">date &#123;</span><br><span class="line">        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">mutate &#123;</span><br><span class="line">          convert =&gt; [ &quot;response&quot;,&quot;float&quot; ]</span><br><span class="line">           rename =&gt; &#123; &quot;response&quot; =&gt; &quot;response_new&quot; &#125;   </span><br><span class="line">           gsub =&gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]          </span><br><span class="line">           split =&gt; [&quot;clientip&quot;, &quot;.&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="17-4-Logstash输出插件（output）"><a href="#17-4-Logstash输出插件（output）" class="headerlink" title="17.4 Logstash输出插件（output）"></a>17.4 Logstash输出插件（output）</h2><p><a href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html">https://www.elastic.co/guide/en/logstash/current/output-plugins.html</a></p>
<p>output是Logstash的最后阶段，一个事件可以经过多个输出，而一旦所有输出处理完成，整个事件就执行完成。 一些常用的输出包括：</p>
<ul>
<li>file：  表示将日志数据写入磁盘上的文件。</li>
<li>elasticsearch：表示将日志数据发送给Elasticsearch。Elasticsearch可以高效方便和易于查询的保存数据。</li>
</ul>
<p>1、输出到标准输出(stdout)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、保存为文件（file）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; &quot;/data/log/%&#123;+yyyy-MM-dd&#125;/%&#123;host&#125;_%&#123;+HH&#125;.log&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、输出到elasticsearch</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        host =&gt; [&quot;192.168.1.1:9200&quot;,&quot;172.16.213.77:9200&quot;]</span><br><span class="line">        index =&gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>host：是一个数组类型的值，后面跟的值是elasticsearch节点的地址与端口，默认端口是9200。可添加多个地址。</li>
<li>index：写入elasticsearch的索引的名称，这里可以使用变量。Logstash提供了%{+YYYY.MM.dd}这种写法。在语法解析的时候，看到以+ 号开头的，就会自动认为后面是时间格式，尝试用时间格式来解析后续字符串。这种以天为单位分割的写法，可以很容易的删除老的数据或者搜索指定时间范围内的数据。此外，注意索引名中不能有大写字母。</li>
<li>manage_template:用来设置是否开启logstash自动管理模板功能，如果设置为false将关闭自动管理模板功能。如果我们自定义了模板，那么应该设置为false。</li>
<li>template_name:这个配置项用来设置在Elasticsearch中模板的名称。</li>
</ul>
<h2 id="17-5-综合案例"><a href="#17-5-综合案例" class="headerlink" title="17.5 综合案例"></a>17.5 综合案例</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [&quot;D:/ES/logstash-7.3.0/nginx.log&quot;]        </span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot; &#125;</span><br><span class="line">        remove_field =&gt; [ &quot;message&quot; ]</span><br><span class="line">   &#125;</span><br><span class="line">	date &#123;</span><br><span class="line">        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">	mutate &#123;</span><br><span class="line">           rename =&gt; &#123; &quot;response&quot; =&gt; &quot;response_new&quot; &#125;</span><br><span class="line">           convert =&gt; [ &quot;response&quot;,&quot;float&quot; ]</span><br><span class="line">           gsub =&gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]</span><br><span class="line">           remove_field =&gt; [&quot;timestamp&quot;]</span><br><span class="line">           split =&gt; [&quot;clientip&quot;, &quot;.&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">elasticsearch &#123;</span><br><span class="line">    host =&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">    index =&gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="18-kibana学习"><a href="#18-kibana学习" class="headerlink" title="18.kibana学习"></a>18.kibana学习</h1><h2 id="18-1基本查询"><a href="#18-1基本查询" class="headerlink" title="18.1基本查询"></a>18.1基本查询</h2><p>1是什么：elk中数据展现工具。</p>
<p>2下载：<a href="https://www.elastic.co/cn/downloads/kibana">https://www.elastic.co/cn/downloads/kibana</a></p>
<p>3使用：建立索引模式，index partten</p>
<p>discover 中使用DSL搜索。</p>
<h2 id="18-2-可视化"><a href="#18-2-可视化" class="headerlink" title="18.2 可视化"></a>18.2 可视化</h2><p>绘制图形</p>
<h2 id="18-3-仪表盘"><a href="#18-3-仪表盘" class="headerlink" title="18.3 仪表盘"></a>18.3 仪表盘</h2><p>将各种可视化图形放入，形成大屏幕。</p>
<h2 id="18-4-使用模板数据指导绘图"><a href="#18-4-使用模板数据指导绘图" class="headerlink" title="18.4 使用模板数据指导绘图"></a>18.4 使用模板数据指导绘图</h2><p>点击主页的添加模板数据，可以看到很多模板数据以及绘图。</p>
<h2 id="18-5-其他功能"><a href="#18-5-其他功能" class="headerlink" title="18.5 其他功能"></a>18.5 其他功能</h2><p>监控，日志，APM等功能非常丰富。</p>
<h1 id="19-集群部署"><a href="#19-集群部署" class="headerlink" title="19.集群部署"></a>19.集群部署</h1><p>见部署图</p>
<h3 id="结点的三个角色"><a href="#结点的三个角色" class="headerlink" title="结点的三个角色"></a>结点的三个角色</h3><p>主结点：master节点主要用于集群的管理及索引 比如新增结点、分片分配、索引的新增和删除等。 数据结点：data 节点上保存了数据分片，它负责索引和搜索操作。 客户端结点：client 节点仅作为请求客户端存在，client的作用也作为负载均衡器，client 节点不存数据，只是将请求均衡转发到其它结点。</p>
<p>通过下边两项参数来配置结点的功能：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node.master: #是否允许为主结点</span><br><span class="line">node.data: #允许存储数据作为数据结点</span><br><span class="line">node.ingest: #是否允许成为协调节点</span><br></pre></td></tr></table></figure>

<p>四种组合方式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">master=true，data=true：即是主结点又是数据结点</span><br><span class="line">master=false，data=true：仅是数据结点</span><br><span class="line">master=true，data=false：仅是主结点，不存储数据</span><br><span class="line">master=false，data=false：即不是主结点也不是数据结点，此时可设置ingest为true表示它是一个客户端。</span><br></pre></td></tr></table></figure>

<h1 id="20-项目实战"><a href="#20-项目实战" class="headerlink" title="20. 项目实战"></a>20. 项目实战</h1><h2 id="20-1项目一：ELK用于日志分析"><a href="#20-1项目一：ELK用于日志分析" class="headerlink" title="20.1项目一：ELK用于日志分析"></a>20.1项目一：ELK用于日志分析</h2><p>需求：集中收集分布式服务的日志</p>
<p>1逻辑模块程序随时输出日志</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * creste by itheima.itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER= LoggerFactory.getLogger(TestLog.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Random random =<span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> userid=random.nextInt(<span class="number">10</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;userId:&#123;&#125;,send:&#123;&#125;&quot;</span>,userid,<span class="string">&quot;hello world.I am &quot;</span>+userid);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2logstash收集日志到es</p>
<p><strong>grok 内置类型</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">USERNAME [a-zA-Z0-9._-]+</span><br><span class="line">USER %&#123;USERNAME&#125;</span><br><span class="line">INT (?:[+-]?(?:[0-9]+))</span><br><span class="line">BASE10NUM (?&lt;![0-9.+-])(?&gt;[+-]?(?:(?:[0-9]+(?:\.[0-9]+)?)|(?:\.[0-9]+)))</span><br><span class="line">NUMBER (?:%&#123;BASE10NUM&#125;)</span><br><span class="line">BASE16NUM (?&lt;![0-9A-Fa-f])(?:[+-]?(?:0x)?(?:[0-9A-Fa-f]+))</span><br><span class="line">BASE16FLOAT \b(?&lt;![0-9A-Fa-f.])(?:[+-]?(?:0x)?(?:(?:[0-9A-Fa-f]+(?:\.[0-9A-Fa-f]*)?)|(?:\.[0-9A-Fa-f]+)))\b</span><br><span class="line"></span><br><span class="line">POSINT \b(?:[1-9][0-9]*)\b</span><br><span class="line">NONNEGINT \b(?:[0-9]+)\b</span><br><span class="line">WORD \b\w+\b</span><br><span class="line">NOTSPACE \S+</span><br><span class="line">SPACE \s*</span><br><span class="line">DATA .*?</span><br><span class="line">GREEDYDATA .*</span><br><span class="line">QUOTEDSTRING (?&gt;(?&lt;!\\)(?&gt;&quot;(?&gt;\\.|[^\\&quot;]+)+&quot;|&quot;&quot;|(?&gt;&#x27;(?&gt;\\.|[^\\&#x27;]+)+&#x27;)|&#x27;&#x27;|(?&gt;`(?&gt;\\.|[^\\`]+)+`)|``))</span><br><span class="line">UUID [A-Fa-f0-9]&#123;8&#125;-(?:[A-Fa-f0-9]&#123;4&#125;-)&#123;3&#125;[A-Fa-f0-9]&#123;12&#125;</span><br><span class="line"></span><br><span class="line"># Networking</span><br><span class="line">MAC (?:%&#123;CISCOMAC&#125;|%&#123;WINDOWSMAC&#125;|%&#123;COMMONMAC&#125;)</span><br><span class="line">CISCOMAC (?:(?:[A-Fa-f0-9]&#123;4&#125;\.)&#123;2&#125;[A-Fa-f0-9]&#123;4&#125;)</span><br><span class="line">WINDOWSMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;-)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</span><br><span class="line">COMMONMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;:)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</span><br><span class="line">IPV6 ((([0-9A-Fa-f]&#123;1,4&#125;:)&#123;7&#125;([0-9A-Fa-f]&#123;1,4&#125;|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;(:[0-9A-Fa-f]&#123;1,4&#125;|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;5&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,2&#125;)|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;4&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,3&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;3&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,4&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,2&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;2&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,5&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,3&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;1&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,6&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,4&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(:(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,7&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,5&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:)))(%.+)?</span><br><span class="line">IPV4 (?&lt;![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;))(?![0-9])</span><br><span class="line">IP (?:%&#123;IPV6&#125;|%&#123;IPV4&#125;)</span><br><span class="line">HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;)(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;))*(\.?|\b)</span><br><span class="line">HOST %&#123;HOSTNAME&#125;</span><br><span class="line">IPORHOST (?:%&#123;HOSTNAME&#125;|%&#123;IP&#125;)</span><br><span class="line">HOSTPORT %&#123;IPORHOST&#125;:%&#123;POSINT&#125;</span><br><span class="line"></span><br><span class="line"># paths</span><br><span class="line">PATH (?:%&#123;UNIXPATH&#125;|%&#123;WINPATH&#125;)</span><br><span class="line">UNIXPATH (?&gt;/(?&gt;[\w_%!$@:.,-]+|\\.)*)+</span><br><span class="line">TTY (?:/dev/(pts|tty([pq])?)(\w+)?/?(?:[0-9]+))</span><br><span class="line">WINPATH (?&gt;[A-Za-z]+:|\\)(?:\\[^\\?*]*)+</span><br><span class="line">URIPROTO [A-Za-z]+(\+[A-Za-z+]+)?</span><br><span class="line">URIHOST %&#123;IPORHOST&#125;(?::%&#123;POSINT:port&#125;)?</span><br><span class="line"># uripath comes loosely from RFC1738, but mostly from what Firefox</span><br><span class="line"># doesn&#x27;t turn into %XX</span><br><span class="line">URIPATH (?:/[A-Za-z0-9$.+!*&#x27;()&#123;&#125;,~:;=@#%_\-]*)+</span><br><span class="line">#URIPARAM \?(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?(?:&amp;(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?)?)*)?</span><br><span class="line">URIPARAM \?[A-Za-z0-9$.+!*&#x27;|()&#123;&#125;,~@#%&amp;/=:;_?\-\[\]]*</span><br><span class="line">URIPATHPARAM %&#123;URIPATH&#125;(?:%&#123;URIPARAM&#125;)?</span><br><span class="line">URI %&#123;URIPROTO&#125;://(?:%&#123;USER&#125;(?::[^@]*)?@)?(?:%&#123;URIHOST&#125;)?(?:%&#123;URIPATHPARAM&#125;)?</span><br><span class="line"></span><br><span class="line"># Months: January, Feb, 3, 03, 12, December</span><br><span class="line">MONTH \b(?:Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\b</span><br><span class="line">MONTHNUM (?:0?[1-9]|1[0-2])</span><br><span class="line">MONTHNUM2 (?:0[1-9]|1[0-2])</span><br><span class="line">MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])</span><br><span class="line"></span><br><span class="line"># Days: Monday, Tue, Thu, etc...</span><br><span class="line">DAY (?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)</span><br><span class="line"></span><br><span class="line"># Years?</span><br><span class="line">YEAR (?&gt;\d\d)&#123;1,2&#125;</span><br><span class="line">HOUR (?:2[0123]|[01]?[0-9])</span><br><span class="line">MINUTE (?:[0-5][0-9])</span><br><span class="line"># &#x27;60&#x27; is a leap second in most time standards and thus is valid.</span><br><span class="line">SECOND (?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)</span><br><span class="line">TIME (?!&lt;[0-9])%&#123;HOUR&#125;:%&#123;MINUTE&#125;(?::%&#123;SECOND&#125;)(?![0-9])</span><br><span class="line"># datestamp is YYYY/MM/DD-HH:MM:SS.UUUU (or something like it)</span><br><span class="line">DATE_US %&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/-]%&#123;YEAR&#125;</span><br><span class="line">DATE_EU %&#123;MONTHDAY&#125;[./-]%&#123;MONTHNUM&#125;[./-]%&#123;YEAR&#125;</span><br><span class="line">ISO8601_TIMEZONE (?:Z|[+-]%&#123;HOUR&#125;(?::?%&#123;MINUTE&#125;))</span><br><span class="line">ISO8601_SECOND (?:%&#123;SECOND&#125;|60)</span><br><span class="line">TIMESTAMP_ISO8601 %&#123;YEAR&#125;-%&#123;MONTHNUM&#125;-%&#123;MONTHDAY&#125;[T ]%&#123;HOUR&#125;:?%&#123;MINUTE&#125;(?::?%&#123;SECOND&#125;)?%&#123;ISO8601_TIMEZONE&#125;?</span><br><span class="line">DATE %&#123;DATE_US&#125;|%&#123;DATE_EU&#125;</span><br><span class="line">DATESTAMP %&#123;DATE&#125;[- ]%&#123;TIME&#125;</span><br><span class="line">TZ (?:[PMCE][SD]T|UTC)</span><br><span class="line">DATESTAMP_RFC822 %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;TZ&#125;</span><br><span class="line">DATESTAMP_RFC2822 %&#123;DAY&#125;, %&#123;MONTHDAY&#125; %&#123;MONTH&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;ISO8601_TIMEZONE&#125;</span><br><span class="line">DATESTAMP_OTHER %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;TIME&#125; %&#123;TZ&#125; %&#123;YEAR&#125;</span><br><span class="line">DATESTAMP_EVENTLOG %&#123;YEAR&#125;%&#123;MONTHNUM2&#125;%&#123;MONTHDAY&#125;%&#123;HOUR&#125;%&#123;MINUTE&#125;%&#123;SECOND&#125;</span><br><span class="line"></span><br><span class="line"># Syslog Dates: Month Day HH:MM:SS</span><br><span class="line">SYSLOGTIMESTAMP %&#123;MONTH&#125; +%&#123;MONTHDAY&#125; %&#123;TIME&#125;</span><br><span class="line">PROG (?:[\w._/%-]+)</span><br><span class="line">SYSLOGPROG %&#123;PROG:program&#125;(?:\[%&#123;POSINT:pid&#125;\])?</span><br><span class="line">SYSLOGHOST %&#123;IPORHOST&#125;</span><br><span class="line">SYSLOGFACILITY &lt;%&#123;NONNEGINT:facility&#125;.%&#123;NONNEGINT:priority&#125;&gt;</span><br><span class="line">HTTPDATE %&#123;MONTHDAY&#125;/%&#123;MONTH&#125;/%&#123;YEAR&#125;:%&#123;TIME&#125; %&#123;INT&#125;</span><br><span class="line"></span><br><span class="line"># Shortcuts</span><br><span class="line">QS %&#123;QUOTEDSTRING&#125;</span><br><span class="line"></span><br><span class="line"># Log formats</span><br><span class="line">SYSLOGBASE %&#123;SYSLOGTIMESTAMP:timestamp&#125; (?:%&#123;SYSLOGFACILITY&#125; )?%&#123;SYSLOGHOST:logsource&#125; %&#123;SYSLOGPROG&#125;:</span><br><span class="line">COMMONAPACHELOG %&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;(?:%&#123;WORD:verb&#125; %&#123;NOTSPACE:request&#125;(?: HTTP/%&#123;NUMBER:httpversion&#125;)?|%&#123;DATA:rawrequest&#125;)&quot; %&#123;NUMBER:response&#125; (?:%&#123;NUMBER:bytes&#125;|-)</span><br><span class="line">COMBINEDAPACHELOG %&#123;COMMONAPACHELOG&#125; %&#123;QS:referrer&#125; %&#123;QS:agent&#125;</span><br><span class="line"></span><br><span class="line"># Log Levels</span><br><span class="line">LOGLEVEL ([Aa]lert|ALERT|[Tt]race|TRACE|[Dd]ebug|DEBUG|[Nn]otice|NOTICE|[Ii]nfo|INFO|[Ww]arn?(?:ing)?|WARN?(?:ING)?|[Ee]rr?(?:or)?|ERR?(?:OR)?|[Cc]rit?(?:ical)?|CRIT?(?:ICAL)?|[Ff]atal|FATAL|[Ss]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?)</span><br></pre></td></tr></table></figure>

<p>写logstash配置文件。</p>
<p>3kibana展现数据</p>
<h2 id="20-2项目二：学成在线站内搜索模块"><a href="#20-2项目二：学成在线站内搜索模块" class="headerlink" title="20.2项目二：学成在线站内搜索模块"></a>20.2项目二：学成在线站内搜索模块</h2><h3 id="1mysql导入course-pub表"><a href="#1mysql导入course-pub表" class="headerlink" title="1mysql导入course_pub表"></a>1mysql导入course_pub表</h3><h3 id="2创建索引xc-course"><a href="#2创建索引xc-course" class="headerlink" title="2创建索引xc_course"></a>2创建索引xc_course</h3><h3 id="3创建映射"><a href="#3创建映射" class="headerlink" title="3创建映射"></a>3创建映射</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /xc_course</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;description&quot; : &#123;</span><br><span class="line">                &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">                &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;grade&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;id&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;mt&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;name&quot; : &#123;</span><br><span class="line">                &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">           &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;users&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;charge&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;valid&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pic&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;qq&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price_old&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;st&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;status&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;studymodel&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachmode&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachplan&quot; : &#123;</span><br><span class="line">                &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">           &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">           &quot;expires&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pub_time&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">             &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;start_time&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">           &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">          &quot;end_time&quot; : &#123;</span><br><span class="line">                 &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">           &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4logstash创建模板文件"><a href="#4logstash创建模板文件" class="headerlink" title="4logstash创建模板文件"></a>4logstash创建模板文件</h3><p>Logstash的工作是从MySQL中读取数据，向ES中创建索引，这里需要提前创建mapping的模板文件以便logstash使用。</p>
<p>在logstach的config目录创建xc_course_template.json，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;doc&quot; : &#123;</span><br><span class="line">         &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;charge&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;description&quot; : &#123;</span><br><span class="line">               &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;end_time&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;expires&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;grade&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;id&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;mt&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;name&quot; : &#123;</span><br><span class="line">               &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pic&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price_old&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pub_time&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;qq&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;st&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;start_time&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;status&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;studymodel&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachmode&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachplan&quot; : &#123;</span><br><span class="line">               &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;users&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;valid&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;template&quot; : &quot;xc_course&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5logstash配置mysql-conf"><a href="#5logstash配置mysql-conf" class="headerlink" title="5logstash配置mysql.conf"></a>5logstash配置mysql.conf</h3><p>1、ES采用UTC时区问题</p>
<p>ES采用UTC 时区，比北京时间早8小时，所以ES读取数据时让最后更新时间加8小时</p>
<p>where timestamp &gt; date_add(:sql_last_value,INTERVAL 8 HOUR)</p>
<p>2、logstash每个执行完成会在/config/logstash_metadata记录执行时间下次以此时间为基准进行增量同步数据到索引库。</p>
<h3 id="6启动"><a href="#6启动" class="headerlink" title="6启动"></a>6启动</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.\logstash.bat -f ..\config\mysql.conf</span><br></pre></td></tr></table></figure>

<p>7后端代码</p>
<p>7.1Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/search/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsCourseController</span>  </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EsCourseService esCourseService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value=&quot;/list/&#123;page&#125;/&#123;size&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> QueryResponseResult&lt;CoursePub&gt; <span class="title">list</span><span class="params">(<span class="meta">@PathVariable(&quot;page&quot;)</span> <span class="keyword">int</span> page, <span class="meta">@PathVariable(&quot;size&quot;)</span> <span class="keyword">int</span> size, CourseSearchParam courseSearchParam)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> esCourseService.list(page,size,courseSearchParam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7.2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class EsCourseService &#123;</span><br><span class="line">    @Value(&quot;$&#123;heima.course.source_field&#125;&quot;)</span><br><span class="line">    private String source_field;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    //课程搜索</span><br><span class="line">    public QueryResponseResult&lt;CoursePub&gt; list(int page, int size, CourseSearchParam courseSearchParam) &#123;</span><br><span class="line">        if (courseSearchParam == null) &#123;</span><br><span class="line">            courseSearchParam = new CourseSearchParam();</span><br><span class="line">        &#125;</span><br><span class="line">        //1创建搜索请求对象</span><br><span class="line">        SearchRequest searchRequest = new SearchRequest(&quot;xc_course&quot;);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        //过虑源字段</span><br><span class="line">        String[] source_field_array = source_field.split(&quot;,&quot;);</span><br><span class="line">        searchSourceBuilder.fetchSource(source_field_array, new String[]&#123;&#125;);</span><br><span class="line">        //创建布尔查询对象</span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        //搜索条件</span><br><span class="line">        //根据关键字搜索</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getKeyword())) &#123;</span><br><span class="line">            MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(courseSearchParam.getKeyword(), &quot;name&quot;, &quot;description&quot;, &quot;teachplan&quot;)</span><br><span class="line">                    .minimumShouldMatch(&quot;70%&quot;)</span><br><span class="line">                    .field(&quot;name&quot;, 10);</span><br><span class="line">            boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getMt())) &#123;</span><br><span class="line">            //根据一级分类</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;mt&quot;, courseSearchParam.getMt()));</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getSt())) &#123;</span><br><span class="line">            //根据二级分类</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;st&quot;, courseSearchParam.getSt()));</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getGrade())) &#123;</span><br><span class="line">            //根据难度等级</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;grade&quot;, courseSearchParam.getGrade()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //设置boolQueryBuilder到searchSourceBuilder</span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        //设置分页参数</span><br><span class="line">        if (page &lt;= 0) &#123;</span><br><span class="line">            page = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        if (size &lt;= 0) &#123;</span><br><span class="line">            size = 12;</span><br><span class="line">        &#125;</span><br><span class="line">        //起始记录下标</span><br><span class="line">        int from = (page - 1) * size;</span><br><span class="line">        searchSourceBuilder.from(from);</span><br><span class="line">        searchSourceBuilder.size(size);</span><br><span class="line"></span><br><span class="line">        //设置高亮</span><br><span class="line">        HighlightBuilder highlightBuilder = new HighlightBuilder();</span><br><span class="line">        highlightBuilder.preTags(&quot;&lt;font class=&#x27;eslight&#x27;&gt;&quot;);</span><br><span class="line">        highlightBuilder.postTags(&quot;&lt;/font&gt;&quot;);</span><br><span class="line">        //设置高亮字段</span><br><span class="line">//        &lt;font class=&#x27;eslight&#x27;&gt;node&lt;/font&gt;学习</span><br><span class="line">        highlightBuilder.fields().add(new HighlightBuilder.Field(&quot;name&quot;));</span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        QueryResult&lt;CoursePub&gt; queryResult = new QueryResult();</span><br><span class="line">        List&lt;CoursePub&gt; list = new ArrayList&lt;CoursePub&gt;();</span><br><span class="line">        try &#123;</span><br><span class="line">            //2执行搜索</span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            //3获取响应结果</span><br><span class="line">            SearchHits hits = searchResponse.getHits();</span><br><span class="line">            long totalHits=hits.getTotalHits().value;</span><br><span class="line">            //匹配的总记录数</span><br><span class="line">//            long totalHits = hits.totalHits;</span><br><span class="line">            queryResult.setTotal(totalHits);</span><br><span class="line">            SearchHit[] searchHits = hits.getHits();</span><br><span class="line">            for (SearchHit hit : searchHits) &#123;</span><br><span class="line">                CoursePub coursePub = new CoursePub();</span><br><span class="line">                //源文档</span><br><span class="line">                Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">                //取出id</span><br><span class="line">                String id = (String) sourceAsMap.get(&quot;id&quot;);</span><br><span class="line">                coursePub.setId(id);</span><br><span class="line">                //取出name</span><br><span class="line">                String name = (String) sourceAsMap.get(&quot;name&quot;);</span><br><span class="line">                //取出高亮字段name</span><br><span class="line">                Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">                if (highlightFields != null) &#123;</span><br><span class="line">                    HighlightField highlightFieldName = highlightFields.get(&quot;name&quot;);</span><br><span class="line">                    if (highlightFieldName != null) &#123;</span><br><span class="line">                        Text[] fragments = highlightFieldName.fragments();</span><br><span class="line">                        StringBuffer stringBuffer = new StringBuffer();</span><br><span class="line">                        for (Text text : fragments) &#123;</span><br><span class="line">                            stringBuffer.append(text);</span><br><span class="line">                        &#125;</span><br><span class="line">                        name = stringBuffer.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setName(name);</span><br><span class="line">                //图片</span><br><span class="line">                String pic = (String) sourceAsMap.get(&quot;pic&quot;);</span><br><span class="line">                coursePub.setPic(pic);</span><br><span class="line">                //价格</span><br><span class="line">                Double price = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (sourceAsMap.get(&quot;price&quot;) != null) &#123;</span><br><span class="line">                        price = (Double) sourceAsMap.get(&quot;price&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice(price);</span><br><span class="line">                //旧价格</span><br><span class="line">                Double price_old = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (sourceAsMap.get(&quot;price_old&quot;) != null) &#123;</span><br><span class="line">                        price_old = (Double) sourceAsMap.get(&quot;price_old&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice_old(price_old);</span><br><span class="line">                //将coursePub对象放入list</span><br><span class="line">                list.add(coursePub);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        queryResult.setList(list);</span><br><span class="line">        QueryResponseResult&lt;CoursePub&gt; queryResponseResult = new QueryResponseResult&lt;CoursePub&gt;(CommonCode.SUCCESS, queryResult);</span><br><span class="line"></span><br><span class="line">        return queryResponseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>ELK</tag>
      </tags>
  </entry>
</search>
